/*!
 * Mini Tokyo 3D v3.4.0
 * https://minitokyo3d.com
 * (c) 2019-2024 Akihiko Kusanagi
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).mt3d=e()}(this,(function(){"use strict";function t(t,e){return e.forEach((function(e){e&&"string"!=typeof e&&!Array.isArray(e)&&Object.keys(e).forEach((function(i){if("default"!==i&&!(i in t)){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}}))})),Object.freeze(t)}var e=Uint8Array,i=Uint16Array,n=Int32Array,r=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),s=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(t,e){for(var r=new i(31),s=0;s<31;++s)r[s]=e+=1<<t[s-1];var o=new n(r[30]);for(s=1;s<30;++s)for(var a=r[s];a<r[s+1];++a)o[a]=a-r[s]<<5|s;return{b:r,r:o}},l=a(r,2),c=l.b,h=l.r;c[28]=258,h[258]=28;for(var u=a(s,0).b,d=new i(32768),p=0;p<32768;++p){var f=(43690&p)>>1|(21845&p)<<1;d[p]=((65280&(f=(61680&(f=(52428&f)>>2|(13107&f)<<2))>>4|(3855&f)<<4))>>8|(255&f)<<8)>>1}var m=function(t,e,n){for(var r=t.length,s=0,o=new i(e);s<r;++s)t[s]&&++o[t[s]-1];var a,l=new i(e);for(s=1;s<e;++s)l[s]=l[s-1]+o[s-1]<<1;if(n){a=new i(1<<e);var c=15-e;for(s=0;s<r;++s)if(t[s])for(var h=s<<4|t[s],u=e-t[s],p=l[t[s]-1]++<<u,f=p|(1<<u)-1;p<=f;++p)a[d[p]>>c]=h}else for(a=new i(r),s=0;s<r;++s)t[s]&&(a[s]=d[l[t[s]-1]++]>>15-t[s]);return a},g=new e(288);for(p=0;p<144;++p)g[p]=8;for(p=144;p<256;++p)g[p]=9;for(p=256;p<280;++p)g[p]=7;for(p=280;p<288;++p)g[p]=8;var _=new e(32);for(p=0;p<32;++p)_[p]=5;var y=m(g,9,1),v=m(_,5,1),x=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},b=function(t,e,i){var n=e/8|0;return(t[n]|t[n+1]<<8)>>(7&e)&i},w=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(7&e)},A=function(t){return(t+7)/8|0},T=function(t,i,n){return(null==i||i<0)&&(i=0),(null==n||n>t.length)&&(n=t.length),new e(t.subarray(i,n))},M=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],S=function(t,e,i){var n=new Error(e||M[t]);if(n.code=t,Error.captureStackTrace&&Error.captureStackTrace(n,S),!i)throw n;return n},E=new e(0),C=function(){function t(t,i){"function"==typeof t&&(i=t,t={}),this.ondata=i;var n=t&&t.dictionary&&t.dictionary.subarray(-32768);this.s={i:0,b:n?n.length:0},this.o=new e(32768),this.p=new e(0),n&&this.o.set(n)}return t.prototype.e=function(t){if(this.ondata||S(5),this.d&&S(4),this.p.length){if(t.length){var i=new e(this.p.length+t.length);i.set(this.p),i.set(t,this.p.length),this.p=i}}else this.p=t},t.prototype.c=function(t){this.s.i=+(this.d=t||!1);var i=this.s.b,n=function(t,i,n,a){var l=t.length,h=a?a.length:0;if(!l||i.f&&!i.l)return n||new e(0);var d=!n,p=d||2!=i.i,f=i.i;d&&(n=new e(3*l));var g=function(t){var i=n.length;if(t>i){var r=new e(Math.max(2*i,t));r.set(n),n=r}},_=i.f||0,M=i.p||0,E=i.b||0,C=i.l,I=i.d,P=i.m,L=i.n,R=8*l;do{if(!C){_=b(t,M,1);var B=b(t,M+1,3);if(M+=3,!B){var D=t[(W=A(M)+4)-4]|t[W-3]<<8,O=W+D;if(O>l){f&&S(0);break}p&&g(E+D),n.set(t.subarray(W,O),E),i.b=E+=D,i.p=M=8*O,i.f=_;continue}if(1==B)C=y,I=v,P=9,L=5;else if(2==B){var k=b(t,M,31)+257,F=b(t,M+10,15)+4,z=k+b(t,M+5,31)+1;M+=14;for(var N=new e(z),U=new e(19),G=0;G<F;++G)U[o[G]]=b(t,M+3*G,7);M+=3*F;var V=x(U),j=(1<<V)-1,H=m(U,V,1);for(G=0;G<z;){var W,q=H[b(t,M,j)];if(M+=15&q,(W=q>>4)<16)N[G++]=W;else{var X=0,Z=0;for(16==W?(Z=3+b(t,M,3),M+=2,X=N[G-1]):17==W?(Z=3+b(t,M,7),M+=3):18==W&&(Z=11+b(t,M,127),M+=7);Z--;)N[G++]=X}}var J=N.subarray(0,k),Y=N.subarray(k);P=x(J),L=x(Y),C=m(J,P,1),I=m(Y,L,1)}else S(1);if(M>R){f&&S(0);break}}p&&g(E+131072);for(var $=(1<<P)-1,K=(1<<L)-1,Q=M;;Q=M){var tt=(X=C[w(t,M)&$])>>4;if((M+=15&X)>R){f&&S(0);break}if(X||S(2),tt<256)n[E++]=tt;else{if(256==tt){Q=M,C=null;break}var et=tt-254;tt>264&&(et=b(t,M,(1<<(rt=r[G=tt-257]))-1)+c[G],M+=rt);var it=I[w(t,M)&K],nt=it>>4;if(it||S(3),M+=15&it,Y=u[nt],nt>3){var rt=s[nt];Y+=w(t,M)&(1<<rt)-1,M+=rt}if(M>R){f&&S(0);break}p&&g(E+131072);var st=E+et;if(E<Y){var ot=h-Y,at=Math.min(Y,st);for(ot+E<0&&S(3);E<at;++E)n[E]=a[ot+E]}for(;E<st;++E)n[E]=n[E-Y]}}i.l=C,i.p=Q,i.b=E,i.f=_,C&&(_=1,i.m=P,i.d=I,i.n=L)}while(!_);return E!=n.length&&d?T(n,0,E):n.subarray(0,E)}(this.p,this.s,this.o);this.ondata(T(n,i,this.s.b),this.d),this.o=T(n,this.s.b-32768),this.s.b=this.o.length,this.p=T(this.p,this.s.p/8|0),this.s.p&=7},t.prototype.push=function(t,e){this.e(t),this.c(e)},t}(),I=function(){function t(t,e){this.v=1,this.r=0,C.call(this,t,e)}return t.prototype.push=function(t,i){if(C.prototype.e.call(this,t),this.r+=t.length,this.v){var n=this.p.subarray(this.v-1),r=n.length>3?function(t){31==t[0]&&139==t[1]&&8==t[2]||S(6,"invalid gzip data");var e=t[3],i=10;4&e&&(i+=2+(t[10]|t[11]<<8));for(var n=(e>>3&1)+(e>>4&1);n>0;n-=!t[i++]);return i+(2&e)}(n):4;if(r>n.length){if(!i)return}else this.v>1&&this.onmember&&this.onmember(this.r-n.length);this.p=n.subarray(r),this.v=0}C.prototype.c.call(this,i),!this.s.f||this.s.l||i||(this.v=A(this.s.p)+9,this.s={i:0},this.o=new e(0),this.push(new e(0),i))},t}(),P="undefined"!=typeof TextDecoder&&new TextDecoder,L=0;try{P.decode(E,{stream:!0}),L=1}catch(t){}var R=function(){function t(t){this.ondata=t,L?this.t=new TextDecoder:this.p=E}return t.prototype.push=function(t,i){if(this.ondata||S(5),i=!!i,this.t)return this.ondata(this.t.decode(t,{stream:!0}),i),void(i&&(this.t.decode().length&&S(8),this.t=null));this.p||S(4);var n=new e(this.p.length+t.length);n.set(this.p),n.set(t,this.p.length);var r=function(t){for(var e="",i=0;;){var n=t[i++],r=(n>127)+(n>223)+(n>239);if(i+r>t.length)return{s:e,r:T(t,i-1)};r?3==r?(n=((15&n)<<18|(63&t[i++])<<12|(63&t[i++])<<6|63&t[i++])-65536,e+=String.fromCharCode(55296|n>>10,56320|1023&n)):e+=String.fromCharCode(1&r?(31&n)<<6|63&t[i++]:(15&n)<<12|(63&t[i++])<<6|63&t[i++]):e+=String.fromCharCode(n)}}(n),s=r.s,o=r.r;i?(o.length&&S(8),this.p=null):this.p=o,this.ondata(s,i)},t}();function B(t){return fetch(t).then((e=>{if(t.endsWith(".gz")){let t="";const i=e.body.getReader(),n=new R((e=>{t+=e})),r=new I(((t,e)=>{n.push(t,e)}));return i.read().then((function e({done:n,value:s}){return n?(r.push(new Uint8Array(0),!0),JSON.parse(t)):(r.push(s),i.read().then(e))}))}return e.json()}))}function D(t,e){const i=e||"id",n={};for(const e of t)n[e[i]]=e;return n}function O(t,e,i){return t*(1-i)+e*i}function k(t,e,i){return Math.min(Math.max(t,e),i)}function F(t,e){let i,n;if(!Array.isArray(t)&&"string"!=typeof t)return!1;if(!Array.isArray(e))return-1!==t.indexOf(e);for(i=0,n=e.length;i<n;i++)if(-1===t.indexOf(e[i]))return!1;return!0}function z(t){return t.normalize("NFD").replace(/\(.*\)|<.*>|〈.*〉|[\u0300-\u036F]/g,"")}function N(t,e){return void 0===t?e:t}function U(t){return"string"==typeof t?t.replace(/.*:/,""):Array.isArray(t)?t.map(U):t}function G(){const t=performance.now()%1500/1500*2;return t<1?t:2-t}function V(t,e){const[i,n]=t,[[r,s],[o,a],[l,c],[h,u]]=e;return(o-r)*(n-s)<(a-s)*(i-r)&&(l-o)*(n-a)<(c-a)*(i-o)&&(h-l)*(n-c)<(u-c)*(i-l)&&(r-h)*(n-u)<(s-u)*(i-h)}function j(t){return.2126*t.r+.7152*t.g+.0722*t.b}function H(t){const e=parseInt(t.replace("#",""),16);return[Math.floor(e/65536)%256,Math.floor(e/256)%256,e%256]}function W(t,e,i){const n=document.createElement(t);return Object.assign(n,e),i&&i.appendChild(n),n}function q(t,e){const i=W("div",{className:"notification",innerHTML:e},t);setTimeout((()=>{i.style.opacity=0}),1e3),setTimeout((()=>{t.removeChild(i)}),2e3)}var X="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Z(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function J(t){if(t.__esModule)return t;var e=t.default;if("function"==typeof e){var i=function t(){return this instanceof t?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};i.prototype=e.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(t).forEach((function(e){var n=Object.getOwnPropertyDescriptor(t,e);Object.defineProperty(i,e,n.get?n:{enumerable:!0,get:function(){return t[e]}})})),i}var Y={exports:{}};!function(t,e){t.exports=function(){var t,e,i;function n(n,r){if(t)if(e){var s="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+t+")(sharedChunk); ("+e+")(sharedChunk); self.onerror = null;",o={};t(o),i=r(o),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(i.workerUrl=window.URL.createObjectURL(new Blob([s],{type:"text/javascript"})))}else e=r;else t=r}n(["exports"],(function(t){var e="undefined"!=typeof self?self:{},i="2.15.0";let n;const r={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==n){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{n=null!=process.env.API_URL_REGEX?new RegExp(process.env.API_URL_REGEX):t}catch(e){n=t}}return n},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!r.API_URL)return null;try{const t=new URL(r.API_URL);return"api.mapbox.cn"===t.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===t.hostname?"https://events.mapbox.com/events/v2":null}catch(t){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},s={supported:!1,testSupport:function(t){!l&&a&&(c?h(t):o=t)}};let o,a,l=!1,c=!1;function h(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a),t.isContextLost())return;s.supported=!0}catch(t){}t.deleteTexture(e),l=!0}e.document&&(a=e.document.createElement("img"),a.onload=function(){o&&h(o),o=null,c=!0},a.onerror=function(){l=!0,o=null},a.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const u="01";function d(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var p=f;function f(t,e,i,n){this.cx=3*t,this.bx=3*(i-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(n-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=i,this.p2y=n}f.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(void 0===e&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var i=t,n=0;n<8;n++){var r=this.sampleCurveX(i)-t;if(Math.abs(r)<e)return i;var s=this.sampleCurveDerivativeX(i);if(Math.abs(s)<1e-6)break;i-=r/s}var o=0,a=1;for(i=t,n=0;n<20&&(r=this.sampleCurveX(i),!(Math.abs(r-t)<e));n++)t>r?o=i:a=i,i=.5*(a-o)+o;return i},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var m=d(p),g=_;function _(t,e){this.x=t,this.y=e}_.prototype={clone:function(){return new _(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,i=t.y-this.y;return e*e+i*i},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),i=Math.sin(t),n=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=n,this},_rotateAround:function(t,e){var i=Math.cos(t),n=Math.sin(t),r=e.y+n*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-n*(this.y-e.y),this.y=r,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},_.convert=function(t){return t instanceof _?t:Array.isArray(t)?new _(t[0],t[1]):t};var y=d(g);const v=Math.PI/180,x=180/Math.PI;function b(t){return t*v}function w(t){return t*x}const A=[[0,0],[1,0],[1,1],[0,1]];function T(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,i=e*t;return 4*(t<.5?i:3*(t-e)+i-.75)}function M(t,e,i,n){const r=new m(t,e,i,n);return function(t){return r.solve(t)}}const S=M(.25,.1,.25,1);function E(t,e,i){return Math.min(i,Math.max(e,t))}function C(t,e,i){return(i=E((i-t)/(e-t),0,1))*i*(3-2*i)}function I(t,e,i){const n=i-e,r=((t-e)%n+n)%n+e;return r===e?i:r}function P(t,e,i){if(!t.length)return i(null,[]);let n=t.length;const r=new Array(t.length);let s=null;t.forEach(((t,o)=>{e(t,((t,e)=>{t&&(s=t),r[o]=e,0==--n&&i(s,r)}))}))}function L(t){const e=[];for(const i in t)e.push(t[i]);return e}function R(t,...e){for(const i of e)for(const e in i)t[e]=i[e];return t}let B=1;function D(){return B++}function O(){return function t(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function k(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function F(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function z(t,e){t.forEach((t=>{e[t]&&(e[t]=e[t].bind(e))}))}function N(t,e){return-1!==t.indexOf(e,t.length-e.length)}function U(t,e,i){const n={};for(const r in t)n[r]=e.call(i||this,t[r],r,t);return n}function G(t,e,i){const n={};for(const r in t)e.call(i||this,t[r],r,t)&&(n[r]=t[r]);return n}function V(t){return Array.isArray(t)?t.map(V):"object"==typeof t&&t?U(t,V):t}const j={};function H(t){j[t]||(j[t]=!0)}function W(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)}function q(t){let e=0;for(let i,n,r=0,s=t.length,o=s-1;r<s;o=r++)i=t[r],n=t[o],e+=(n.x-i.x)*(i.y+n.y);return e}function X(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function Z(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((t,i,n,r)=>{const s=n||r;return e[i]=!s||s.toLowerCase(),""})),e["max-age"]){const t=parseInt(e["max-age"],10);isNaN(t)?delete e["max-age"]:e["max-age"]=t}return e}let J=null;function Y(t){if(null==J){const e=t.navigator?t.navigator.userAgent:null;J=!!t.safari||!(!e||!(/\b(iPad|iPhone|iPod)\b/.test(e)||e.match("Safari")&&!e.match("Chrome")))}return J}function $(t){try{const i=e[t];return i.setItem("_mapbox_test_",1),i.removeItem("_mapbox_test_"),!0}catch(t){return!1}}function K(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]}const Q="mapbox-tiles";let tt,et,it=500,nt=50;function rt(){try{return e.caches}catch(t){}}function st(){rt()&&!tt&&(tt=e.caches.open(Q))}function ot(t){const e=t.indexOf("?");if(e<0)return t;const i=function(t){const e=t.indexOf("?");return e>0?t.slice(e+1).split("&"):[]}(t),n=i.filter((t=>{const e=t.split("=");return"language"===e[0]||"worldview"===e[0]}));return n.length?`${t.slice(0,e)}?${n.join("&")}`:t.slice(0,e)}let at=1/0;const lt={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};"function"==typeof Object.freeze&&Object.freeze(lt);class ct extends Error{constructor(t,e,i){401===e&&xt(i)&&(t+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(t),this.status=e,this.url=i}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ht=X()?()=>self.worker&&self.worker.referrer:()=>("blob:"===e.location.protocol?e.parent:e).location.href,ut=function(t,i){if(!(/^file:/.test(n=t.url)||/^file:/.test(ht())&&!/^\w+:/.test(n))){if(e.fetch&&e.Request&&e.AbortController&&e.Request.prototype.hasOwnProperty("signal"))return function(t,i){const n=new e.AbortController,r=new e.Request(t.url,{method:t.method||"GET",body:t.body,credentials:t.credentials,headers:t.headers,referrer:ht(),referrerPolicy:t.referrerPolicy,signal:n.signal});let s=!1,o=!1;const a=(l=r.url).indexOf("sku=")>0&&xt(l);var l;"json"===t.type&&r.headers.set("Accept","application/json");const c=(n,s,l)=>{if(o)return;if(n&&"SecurityError"!==n.message&&H(n.toString()),s&&l)return h(s);const c=Date.now();e.fetch(r).then((e=>{if(e.ok){const t=a?e.clone():null;return h(e,t,c)}return i(new ct(e.statusText,e.status,t.url))})).catch((e=>{"AbortError"!==e.name&&i(new Error(`${e.message} ${t.url}`))}))},h=(n,a,l)=>{("arrayBuffer"===t.type?n.arrayBuffer():"json"===t.type?n.json():n.text()).then((t=>{o||(a&&l&&function(t,i,n){if(st(),!tt)return;const r={status:i.status,statusText:i.statusText,headers:new e.Headers};i.headers.forEach(((t,e)=>r.headers.set(e,t)));const s=Z(i.headers.get("Cache-Control")||"");if(s["no-store"])return;s["max-age"]&&r.headers.set("Expires",new Date(n+1e3*s["max-age"]).toUTCString());const o=r.headers.get("Expires");o&&(new Date(o).getTime()-n<42e4||function(t,e){if(void 0===et)try{new Response(new ReadableStream),et=!0}catch(t){et=!1}et?e(t.body):t.blob().then(e)}(i,(i=>{const n=new e.Response(i,r);st(),tt&&tt.then((e=>e.put(ot(t.url),n))).catch((t=>H(t.message)))})))}(r,a,l),s=!0,i(null,t,n.headers.get("Cache-Control"),n.headers.get("Expires")))})).catch((t=>{o||i(new Error(t.message))}))};return a?function(t,e){if(st(),!tt)return e(null);const i=ot(t.url);tt.then((t=>{t.match(i).then((n=>{const r=function(t){if(!t)return!1;const e=new Date(t.headers.get("Expires")||0),i=Z(t.headers.get("Cache-Control")||"");return e>Date.now()&&!i["no-cache"]}(n);t.delete(i),r&&t.put(i,n.clone()),e(null,n,r)})).catch(e)})).catch(e)}(r,c):c(null,null),{cancel:()=>{o=!0,s||n.abort()}}}(t,i);if(X()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,i,void 0,!0)}var n;return function(t,i){const n=new e.XMLHttpRequest;n.open(t.method||"GET",t.url,!0),"arrayBuffer"===t.type&&(n.responseType="arraybuffer");for(const e in t.headers)n.setRequestHeader(e,t.headers[e]);return"json"===t.type&&(n.responseType="text",n.setRequestHeader("Accept","application/json")),n.withCredentials="include"===t.credentials,n.onerror=()=>{i(new Error(n.statusText))},n.onload=()=>{if((n.status>=200&&n.status<300||0===n.status)&&null!==n.response){let e=n.response;if("json"===t.type)try{e=JSON.parse(n.response)}catch(t){return i(t)}i(null,e,n.getResponseHeader("Cache-Control"),n.getResponseHeader("Expires"))}else i(new ct(n.statusText,n.status,t.url))},n.send(t.body),{cancel:()=>n.abort()}}(t,i)},dt=function(t,e){return ut(R(t,{type:"arrayBuffer"}),e)};function pt(t){const i=e.document.createElement("a");return i.href=t,i.protocol===e.document.location.protocol&&i.host===e.document.location.host}const ft="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let mt,gt;mt=[],gt=0;const _t=function(t,i){if(s.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),gt>=r.MAX_PARALLEL_IMAGE_REQUESTS){const e={requestParameters:t,callback:i,cancelled:!1,cancel(){this.cancelled=!0}};return mt.push(e),e}gt++;let n=!1;const o=()=>{if(!n)for(n=!0,gt--;mt.length&&gt<r.MAX_PARALLEL_IMAGE_REQUESTS;){const t=mt.shift(),{requestParameters:e,callback:i,cancelled:n}=t;n||(t.cancel=_t(e,i).cancel)}},a=dt(t,((t,n,r,s)=>{o(),t?i(t):n&&(e.createImageBitmap?function(t,i){const n=new e.Blob([new Uint8Array(t)],{type:"image/png"});e.createImageBitmap(n).then((t=>{i(null,t)})).catch((t=>{i(new Error(`Could not load image because of ${t.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))}(n,((t,e)=>i(t,e,r,s))):function(t,i){const n=new e.Image,r=e.URL;n.onload=()=>{i(null,n),r.revokeObjectURL(n.src),n.onload=null,e.requestAnimationFrame((()=>{n.src=ft}))},n.onerror=()=>i(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const s=new e.Blob([new Uint8Array(t)],{type:"image/png"});n.src=t.byteLength?r.createObjectURL(s):ft}(n,((t,e)=>i(t,e,r,s))))}));return{cancel:()=>{a.cancel(),o()}}},yt="NO_ACCESS_TOKEN";function vt(t){return 0===t.indexOf("mapbox:")}function xt(t){return r.API_URL_REGEX.test(t)}function bt(t){return r.API_CDN_URL_REGEX.test(t)}function wt(t){return r.API_STYLE_REGEX.test(t)&&!At(t)}function At(t){return r.API_SPRITE_REGEX.test(t)}const Tt=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Mt(t){const e=t.match(Tt);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function St(t){const e=t.params.length?`?${t.params.join("&")}`:"";return`${t.protocol}://${t.authority}${t.path}${e}`}const Et="mapbox.eventData";function Ct(t){if(!t)return null;const i=t.split(".");if(!i||3!==i.length)return null;try{return JSON.parse(decodeURIComponent(e.atob(i[1]).split("").map((t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2))).join("")))}catch(t){return null}}class It{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const i=Ct(r.ACCESS_TOKEN);let n="";return n=i&&i.u?e.btoa(encodeURIComponent(i.u).replace(/%([0-9A-F]{2})/g,((t,e)=>String.fromCharCode(Number("0x"+e))))):r.ACCESS_TOKEN||"",t?`${Et}.${t}:${n}`:`${Et}:${n}`}fetchEventData(){const t=$("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{const t=e.localStorage.getItem(i);t&&(this.eventData=JSON.parse(t));const r=e.localStorage.getItem(n);r&&(this.anonId=r)}catch(t){H("Unable to read from LocalStorage")}}saveEventData(){const t=$("localStorage"),i=this.getStorageKey(),n=this.getStorageKey("uuid");if(t)try{e.localStorage.setItem(n,this.anonId),Object.keys(this.eventData).length>=1&&e.localStorage.setItem(i,JSON.stringify(this.eventData))}catch(t){H("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,e,i,n){if(!r.EVENTS_URL)return;const s=Mt(r.EVENTS_URL);s.params.push(`access_token=${n||r.ACCESS_TOKEN||""}`);const o={event:this.type,created:new Date(t).toISOString()},a=e?R(o,e):o,l={url:St(s),headers:{"Content-Type":"text/plain"},body:JSON.stringify([a])};this.pendingRequest=function(t,e){return ut(R(t,{method:"POST"}),e)}(l,(t=>{this.pendingRequest=null,i(t),this.saveEventData(),this.processRequests(n)}))}queueRequest(t,e){this.queue.push(t),this.processRequests(e)}}const Pt=new class extends It{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){r.EVENTS_URL&&r.ACCESS_TOKEN&&Array.isArray(t)&&t.some((t=>vt(t)||xt(t)))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Ct(r.ACCESS_TOKEN),n=e?e.u:r.ACCESS_TOKEN;let s=n!==this.eventData.tokenU;F(this.anonId)||(this.anonId=O(),s=!0);const o=this.queue.shift();if(this.eventData.lastSuccess){const t=new Date(this.eventData.lastSuccess),e=new Date(o),i=(o-this.eventData.lastSuccess)/864e5;s=s||i>=1||i<-1||t.getDate()!==e.getDate()}else s=!0;s?this.postEvent(o,{sdkIdentifier:"mapbox-gl-js",sdkVersion:i,skuId:u,"enabled.telemetry":!1,userId:this.anonId},(t=>{t||(this.eventData.lastSuccess=o,this.eventData.tokenU=n)}),t):this.processRequests()}},Lt=Pt.postTurnstileEvent.bind(Pt),Rt=new class extends It{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,i,n){this.skuToken=e,this.errorCb=n,r.EVENTS_URL&&(i||r.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(yt)))}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;const{id:e,timestamp:n}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),F(this.anonId)||(this.anonId=O()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:i,skuId:u,skuToken:this.skuToken,userId:this.anonId},(t=>{t?this.errorCb(t):e&&(this.success[e]=!0)}),t))}},Bt=Rt.postMapLoadEvent.bind(Rt),Dt=new class extends It{constructor(){super("gljs.performance")}postPerformanceEvent(t,e){r.EVENTS_URL&&(t||r.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},t)}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:n,performanceData:r}=this.queue.shift(),s=function(t){const n=e.performance.getEntriesByType("resource"),r=e.performance.getEntriesByType("mark"),s=function(t){const e={};if(t)for(const i in t)if("other"!==i)for(const n of t[i]){const t=`${i}ResolveRangeMin`,r=`${i}ResolveRangeMax`,s=`${i}RequestCount`,o=`${i}RequestCachedCount`;e[t]=Math.min(e[t]||1/0,n.startTime),e[r]=Math.max(e[r]||-1/0,n.responseEnd);const a=t=>{void 0===e[t]&&(e[t]=0),++e[t]};void 0!==n.transferSize&&0===n.transferSize&&a(o),a(s)}return e}(function(t,e){const i={};if(t)for(const n of t){const t=e(n);void 0===i[t]&&(i[t]=[]),i[t].push(n)}return i}(n,Gt)),o=e.devicePixelRatio,a=e.navigator.connection||e.navigator.mozConnection||e.navigator.webkitConnection,l={counters:[],metadata:[],attributes:[]},c=(t,e,i)=>{null!=i&&t.push({name:e,value:i.toString()})};for(const t in s)c(l.counters,t,s[t]);if(t.interactionRange[0]!==1/0&&t.interactionRange[1]!==-1/0&&(c(l.counters,"interactionRangeMin",t.interactionRange[0]),c(l.counters,"interactionRangeMax",t.interactionRange[1])),r)for(const t of Object.keys(Nt)){const e=Nt[t],i=r.find((t=>t.name===e));i&&c(l.counters,e,i.startTime)}return c(l.counters,"visibilityHidden",t.visibilityHidden),c(l.attributes,"style",function(t){if(t)for(const e of t){const t=e.name.split("?")[0];if(wt(t)){const e=t.split("/").slice(-2);if(2===e.length)return`mapbox://styles/${e[0]}/${e[1]}`}}}(n)),c(l.attributes,"terrainEnabled",t.terrainEnabled?"true":"false"),c(l.attributes,"fogEnabled",t.fogEnabled?"true":"false"),c(l.attributes,"projection",t.projection),c(l.attributes,"zoom",t.zoom),c(l.metadata,"devicePixelRatio",o),c(l.metadata,"connectionEffectiveType",a?a.effectiveType:void 0),c(l.metadata,"navigatorUserAgent",e.navigator.userAgent),c(l.metadata,"screenWidth",e.screen.width),c(l.metadata,"screenHeight",e.screen.height),c(l.metadata,"windowWidth",e.innerWidth),c(l.metadata,"windowHeight",e.innerHeight),c(l.metadata,"mapWidth",t.width/o),c(l.metadata,"mapHeight",t.height/o),c(l.metadata,"webglRenderer",t.renderer),c(l.metadata,"webglVendor",t.vendor),c(l.metadata,"sdkVersion",i),c(l.metadata,"sdkIdentifier","mapbox-gl-js"),l}(r);for(const t of s.metadata);for(const t of s.counters);for(const t of s.attributes);this.postEvent(n,s,(()=>{}),t)}},Ot=Dt.postPerformanceEvent.bind(Dt),kt=new class extends It{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,i,n){if(!r.API_URL||!r.SESSION_PATH)return;const s=Mt(r.API_URL+r.SESSION_PATH);s.params.push(`sku=${e||""}`),s.params.push(`access_token=${n||r.ACCESS_TOKEN||""}`);const o={url:St(s),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(t,e){return ut(R(t,{method:"GET"}),e)}(o,(t=>{this.pendingRequest=null,i(t),this.saveEventData(),this.processRequests(n)}))}getSessionAPI(t,e,i,n){this.skuToken=e,this.errorCb=n,r.SESSION_PATH&&r.API_URL&&(i||r.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(yt)))}processRequests(t){if(this.pendingRequest||0===this.queue.length)return;const{id:e,timestamp:i}=this.queue.shift();e&&this.success[e]||this.getSession(i,this.skuToken,(t=>{t?this.errorCb(t):e&&(this.success[e]=!0)}),t)}},Ft=kt.getSessionAPI.bind(kt),zt=new Set,Nt={create:"create",load:"load",fullLoad:"fullLoad"},Ut={mark(t){e.performance.mark(t)},measure(t,i,n){e.performance.measure(t,i,n)}};function Gt(t){const e=t.name.split("?")[0];return bt(e)&&e.includes("mapbox-gl.js")?"javascript":bt(e)&&e.includes("mapbox-gl.css")?"css":function(t){return r.API_FONTS_REGEX.test(t)}(e)?"fontRange":At(e)?"sprite":wt(e)?"style":function(t){return r.API_TILEJSON_REGEX.test(t)}(e)?"tilejson":"other"}const Vt=e.performance;function jt(t){const e=t?t.url.toString():void 0;return Vt.getEntriesByName(e)}let Ht,Wt,qt,Xt;const Zt={now:()=>void 0!==qt?qt:e.performance.now(),setNow(t){qt=t},restoreNow(){qt=void 0},frame(t){const i=e.requestAnimationFrame(t);return{cancel:()=>e.cancelAnimationFrame(i)}},getImageData(t,i=0){const{width:n,height:r}=t;Xt||(Xt=e.document.createElement("canvas"));const s=Xt.getContext("2d",{willReadFrequently:!0});if(!s)throw new Error("failed to create canvas 2d context");return(n>Xt.width||r>Xt.height)&&(Xt.width=n,Xt.height=r),s.clearRect(-i,-i,n+2*i,r+2*i),s.drawImage(t,0,0,n,r),s.getImageData(-i,-i,n+2*i,r+2*i)},resolveURL:t=>(Ht||(Ht=e.document.createElement("a")),Ht.href=t,Ht.href),get devicePixelRatio(){return e.devicePixelRatio},get prefersReducedMotion(){return!!e.matchMedia&&(null==Wt&&(Wt=e.matchMedia("(prefers-reduced-motion: reduce)")),Wt.matches)}};function Jt(t,e,i){i[t]&&-1!==i[t].indexOf(e)||(i[t]=i[t]||[],i[t].push(e))}function Yt(t,e,i){if(i&&i[t]){const n=i[t].indexOf(e);-1!==n&&i[t].splice(n,1)}}class $t{constructor(t,e={}){R(this,e),this.type=t}}class Kt extends $t{constructor(t,e={}){super("error",R({error:t},e))}}class Qt{on(t,e){return this._listeners=this._listeners||{},Jt(t,e,this._listeners),this}off(t,e){return Yt(t,e,this._listeners),Yt(t,e,this._oneTimeListeners),this}once(t,e){return e?(this._oneTimeListeners=this._oneTimeListeners||{},Jt(t,e,this._oneTimeListeners),this):new Promise((e=>this.once(t,e)))}fire(t,e){"string"==typeof t&&(t=new $t(t,e||{}));const i=t.type;if(this.listens(i)){t.target=this;const e=this._listeners&&this._listeners[i]?this._listeners[i].slice():[];for(const i of e)i.call(this,t);const n=this._oneTimeListeners&&this._oneTimeListeners[i]?this._oneTimeListeners[i].slice():[];for(const e of n)Yt(i,e,this._oneTimeListeners),e.call(this,t);const r=this._eventedParent;r&&(R(t,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),r.fire(t))}return this}listens(t){return!!(this._listeners&&this._listeners[t]&&this._listeners[t].length>0||this._oneTimeListeners&&this._oneTimeListeners[t]&&this._oneTimeListeners[t].length>0||this._eventedParent&&this._eventedParent.listens(t))}setEventedParent(t,e){return this._eventedParent=t,this._eventedParentData=e,this}}var te=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{},"globe":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90],"transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["source"]}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"requires":["fill-extrusion-edge-radius"]},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"requires":["fill-extrusion-edge-radius"],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":false,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"transition":false,"requires":[{"source":"geojson","has":{"lineMetrics":true}}],"property-type":"constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function ee(t,...e){for(const i of e)for(const e in i)t[e]=i[e];return t}function ie(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function ne(t){if(Array.isArray(t))return t.map(ne);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const i in t)e[i]=ne(t[i]);return e}return ie(t)}class re extends Error{constructor(t,e){super(e),this.message=e,this.key=t}}var se=re;class oe{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[t,i]of e)this.bindings[t]=i}concat(t){return new oe(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var ae=oe;const le={kind:"null"},ce={kind:"number"},he={kind:"string"},ue={kind:"boolean"},de={kind:"color"},pe={kind:"object"},fe={kind:"value"},me={kind:"collator"},ge={kind:"formatted"},_e={kind:"resolvedImage"};function ye(t,e){return{kind:"array",itemType:t,N:e}}function ve(t){if("array"===t.kind){const e=ve(t.itemType);return"number"==typeof t.N?`array<${e}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${e}>`}return t.kind}const xe=[le,ce,he,ue,de,ge,pe,ye(fe),_e];function be(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!be(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if("value"===t.kind)for(const t of xe)if(!be(t,e))return null}return`Expected ${ve(t)} but found ${ve(e)} instead.`}function we(t,e){return e.some((e=>e.kind===t.kind))}function Ae(t,e){return e.some((e=>"null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t))}var Te,Me={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Se(t){return(t=Math.round(t))<0?0:t>255?255:t}function Ee(t){return Se("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function Ce(t){return(e="%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e}function Ie(t,e,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?t+(e-t)*i*6:2*i<1?e:3*i<2?t+(e-t)*(2/3-i)*6:t}try{Te={}.parseCSSColor=function(t){var e,i=t.replace(/ /g,"").toLowerCase();if(i in Me)return Me[i].slice();if("#"===i[0])return 4===i.length?(e=parseInt(i.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===i.length&&(e=parseInt(i.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var n=i.indexOf("("),r=i.indexOf(")");if(-1!==n&&r+1===i.length){var s=i.substr(0,n),o=i.substr(n+1,r-(n+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=Ce(o.pop());case"rgb":return 3!==o.length?null:[Ee(o[0]),Ee(o[1]),Ee(o[2]),a];case"hsla":if(4!==o.length)return null;a=Ce(o.pop());case"hsl":if(3!==o.length)return null;var l=(parseFloat(o[0])%360+360)%360/360,c=Ce(o[1]),h=Ce(o[2]),u=h<=.5?h*(c+1):h+c-h*c,d=2*h-u;return[Se(255*Ie(d,u,l+1/3)),Se(255*Ie(d,u,l)),Se(255*Ie(d,u,l-1/3)),a];default:return null}}return null}}catch(t){}class Pe{constructor(t,e,i,n=1){this.r=t,this.g=e,this.b=i,this.a=n}static parse(t){if(!t)return;if(t instanceof Pe)return t;if("string"!=typeof t)return;const e=Te(t);return e?new Pe(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3]):void 0}toString(){const[t,e,i,n]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(i)},${n})`}toArray(){const{r:t,g:e,b:i,a:n}=this;return 0===n?[0,0,0,0]:[255*t/n,255*e/n,255*i/n,n]}toArray01(){const{r:t,g:e,b:i,a:n}=this;return 0===n?[0,0,0,0]:[t/n,e/n,i/n,n]}toArray01PremultipliedAlpha(){const{r:t,g:e,b:i,a:n}=this;return[t,e,i,n]}}Pe.black=new Pe(0,0,0,1),Pe.white=new Pe(1,1,1,1),Pe.transparent=new Pe(0,0,0,0),Pe.red=new Pe(1,0,0,1),Pe.blue=new Pe(0,0,1,1);var Le=Pe;class Re{constructor(t,e,i){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=i,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Be{constructor(t,e,i,n,r){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=i,this.fontStack=n,this.textColor=r}}class De{constructor(t){this.sections=t}static fromString(t){return new De([new Be(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((t=>0!==t.text.length||t.image&&0!==t.image.name.length))}static factory(t){return t instanceof De?t:De.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map((t=>t.text)).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const i={};e.fontStack&&(i["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(i["font-scale"]=e.scale),e.textColor&&(i["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(i)}return t}}class Oe{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new Oe({name:t,available:!1}):null}serialize(){return["image",this.name]}}function ke(t,e,i,n){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof i&&i>=0&&i<=255?void 0===n||"number"==typeof n&&n>=0&&n<=1?null:`Invalid rgba value [${[t,e,i,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof n?[t,e,i,n]:[t,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Fe(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof Le)return!0;if(t instanceof Re)return!0;if(t instanceof De)return!0;if(t instanceof Oe)return!0;if(Array.isArray(t)){for(const e of t)if(!Fe(e))return!1;return!0}if("object"==typeof t){for(const e in t)if(!Fe(t[e]))return!1;return!0}return!1}function ze(t){if(null===t)return le;if("string"==typeof t)return he;if("boolean"==typeof t)return ue;if("number"==typeof t)return ce;if(t instanceof Le)return de;if(t instanceof Re)return me;if(t instanceof De)return ge;if(t instanceof Oe)return _e;if(Array.isArray(t)){const e=t.length;let i;for(const e of t){const t=ze(e);if(i){if(i===t)continue;i=fe;break}i=t}return ye(i||fe,e)}return pe}function Ne(t){const e=typeof t;return null===t?"":"string"===e||"number"===e||"boolean"===e?String(t):t instanceof Le||t instanceof De||t instanceof Oe?t.toString():JSON.stringify(t)}class Ue{constructor(t,e){this.type=t,this.value=e}static parse(t,e){if(2!==t.length)return e.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Fe(t[1]))return e.error("invalid value");const i=t[1];let n=ze(i);const r=e.expectedType;return"array"!==n.kind||0!==n.N||!r||"array"!==r.kind||"number"==typeof r.N&&0!==r.N||(n=r),new Ue(n,i)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Le?["rgba"].concat(this.value.toArray()):this.value instanceof De?this.value.serialize():this.value}}var Ge=Ue,Ve=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const je={string:he,number:ce,boolean:ue,object:pe};class He{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");let i,n=1;const r=t[0];if("array"===r){let r,s;if(t.length>2){const i=t[1];if("string"!=typeof i||!(i in je)||"object"===i)return e.error('The item type argument of "array" must be one of string, number, boolean',1);r=je[i],n++}else r=fe;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return e.error('The length argument to "array" must be a positive integer literal',2);s=t[2],n++}i=ye(r,s)}else i=je[r];const s=[];for(;n<t.length;n++){const i=e.parse(t[n],n,fe);if(!i)return null;s.push(i)}return new He(i,s)}evaluate(t){for(let e=0;e<this.args.length;e++){const i=this.args[e].evaluate(t);if(!be(this.type,ze(i)))return i;if(e===this.args.length-1)throw new Ve(`Expected value to be of type ${ve(this.type)}, but found ${ve(ze(i))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=this.type,e=[t.kind];if("array"===t.kind){const i=t.itemType;if("string"===i.kind||"number"===i.kind||"boolean"===i.kind){e.push(i.kind);const n=t.N;("number"==typeof n||this.args.length>1)&&e.push(n)}}return e.concat(this.args.map((t=>t.serialize())))}}var We=He;class qe{constructor(t){this.type=ge,this.sections=t}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const i=t[1];if(!Array.isArray(i)&&"object"==typeof i)return e.error("First argument must be an image or text section.");const n=[];let r=!1;for(let i=1;i<=t.length-1;++i){const s=t[i];if(r&&"object"==typeof s&&!Array.isArray(s)){r=!1;let t=null;if(s["font-scale"]&&(t=e.parse(s["font-scale"],1,ce),!t))return null;let i=null;if(s["text-font"]&&(i=e.parse(s["text-font"],1,ye(he)),!i))return null;let o=null;if(s["text-color"]&&(o=e.parse(s["text-color"],1,de),!o))return null;const a=n[n.length-1];a.scale=t,a.font=i,a.textColor=o}else{const s=e.parse(t[i],1,fe);if(!s)return null;const o=s.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");r=!0,n.push({content:s,scale:null,font:null,textColor:null})}}return new qe(n)}evaluate(t){return new De(this.sections.map((e=>{const i=e.content.evaluate(t);return ze(i)===_e?new Be("",i,null,null,null):new Be(Ne(i),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)})))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const i={};e.scale&&(i["font-scale"]=e.scale.serialize()),e.font&&(i["text-font"]=e.font.serialize()),e.textColor&&(i["text-color"]=e.textColor.serialize()),t.push(i)}return t}}class Xe{constructor(t){this.type=_e,this.input=t}static parse(t,e){if(2!==t.length)return e.error("Expected two arguments.");const i=e.parse(t[1],1,he);return i?new Xe(i):e.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),i=Oe.fromString(e);return i&&t.availableImages&&(i.available=t.availableImages.indexOf(e)>-1),i}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Ze={"to-boolean":ue,"to-color":de,"to-number":ce,"to-string":he};class Je{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const i=t[0];if(("to-boolean"===i||"to-string"===i)&&2!==t.length)return e.error("Expected one argument.");const n=Ze[i],r=[];for(let i=1;i<t.length;i++){const n=e.parse(t[i],i,fe);if(!n)return null;r.push(n)}return new Je(n,r)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let e,i;for(const n of this.args){if(e=n.evaluate(t),i=null,e instanceof Le)return e;if("string"==typeof e){const i=t.parseColor(e);if(i)return i}else if(Array.isArray(e)&&(i=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:ke(e[0],e[1],e[2],e[3]),!i))return new Le(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new Ve(i||`Could not parse color from value '${"string"==typeof e?e:String(JSON.stringify(e))}'`)}if("number"===this.type.kind){let e=null;for(const i of this.args){if(e=i.evaluate(t),null===e)return 0;const n=Number(e);if(!isNaN(n))return n}throw new Ve(`Could not convert ${JSON.stringify(e)} to number.`)}return"formatted"===this.type.kind?De.fromString(Ne(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?Oe.fromString(Ne(this.args[0].evaluate(t))):Ne(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new qe([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Xe(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild((e=>{t.push(e.serialize())})),t}}var Ye=Je;const $e=["Unknown","Point","LineString","Polygon"];var Ke=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?$e[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:i,y:n}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(i*e-t[0])+this.featureDistanceData.bearing[1]*(n*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=Le.parse(t)),e}};class Qe{constructor(t,e,i,n){this.name=t,this.type=e,this._evaluate=i,this.args=n}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((t=>t.serialize())))}static parse(t,e){const i=t[0],n=Qe.definitions[i];if(!n)return e.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0);const r=Array.isArray(n)?n[0]:n.type,s=Array.isArray(n)?[[n[1],n[2]]]:n.overloads,o=s.filter((([e])=>!Array.isArray(e)||e.length===t.length-1));let a=null;for(const[n,s]of o){a=new Si(e.registry,e.path,null,e.scope);const o=[];let l=!1;for(let e=1;e<t.length;e++){const i=t[e],r=Array.isArray(n)?n[e-1]:n.type,s=a.parse(i,1+o.length,r);if(!s){l=!0;break}o.push(s)}if(!l)if(Array.isArray(n)&&n.length!==o.length)a.error(`Expected ${n.length} arguments, but found ${o.length} instead.`);else{for(let t=0;t<o.length;t++){const e=Array.isArray(n)?n[t]:n.type,i=o[t];a.concat(t+1).checkSubtype(e,i.type)}if(0===a.errors.length)return new Qe(i,r,s,o)}}if(1===o.length)e.errors.push(...a.errors);else{const i=(o.length?o:s).map((([t])=>{return e=t,Array.isArray(e)?`(${e.map(ve).join(", ")})`:`(${ve(e.type)}...)`;var e})).join(" | "),n=[];for(let i=1;i<t.length;i++){const r=e.parse(t[i],1+n.length);if(!r)return null;n.push(ve(r.type))}e.error(`Expected arguments of type ${i}, but found (${n.join(", ")}) instead.`)}return null}static register(t,e){Qe.definitions=e;for(const i in e)t[i]=Qe}}var ti=Qe;class ei{constructor(t,e,i){this.type=me,this.locale=i,this.caseSensitive=t,this.diacriticSensitive=e}static parse(t,e){if(2!==t.length)return e.error("Expected one argument.");const i=t[1];if("object"!=typeof i||Array.isArray(i))return e.error("Collator options argument must be an object.");const n=e.parse(void 0!==i["case-sensitive"]&&i["case-sensitive"],1,ue);if(!n)return null;const r=e.parse(void 0!==i["diacritic-sensitive"]&&i["diacritic-sensitive"],1,ue);if(!r)return null;let s=null;return i.locale&&(s=e.parse(i.locale,1,he),!s)?null:new ei(n,r,s)}evaluate(t){return new Re(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const ii=8192;function ni(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function ri(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function si(t,e){const i=(180+t[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,r=Math.pow(2,e.z);return[Math.round(i*r*ii),Math.round(n*r*ii)]}function oi(t,e,i){const n=t[0]-e[0],r=t[1]-e[1],s=t[0]-i[0],o=t[1]-i[1];return n*o-s*r==0&&n*s<=0&&r*o<=0}function ai(t,e){let i=!1;for(let o=0,a=e.length;o<a;o++){const a=e[o];for(let e=0,o=a.length;e<o-1;e++){if(oi(t,a[e],a[e+1]))return!1;(r=a[e])[1]>(n=t)[1]!=(s=a[e+1])[1]>n[1]&&n[0]<(s[0]-r[0])*(n[1]-r[1])/(s[1]-r[1])+r[0]&&(i=!i)}}var n,r,s;return i}function li(t,e){for(let i=0;i<e.length;i++)if(ai(t,e[i]))return!0;return!1}function ci(t,e,i,n){const r=n[0]-i[0],s=n[1]-i[1],o=(t[0]-i[0])*s-r*(t[1]-i[1]),a=(e[0]-i[0])*s-r*(e[1]-i[1]);return o>0&&a<0||o<0&&a>0}function hi(t,e,i){for(const c of i)for(let i=0;i<c.length-1;++i)if(0!=(a=[(o=c[i+1])[0]-(s=c[i])[0],o[1]-s[1]])[0]*(l=[(r=e)[0]-(n=t)[0],r[1]-n[1]])[1]-a[1]*l[0]&&ci(n,r,s,o)&&ci(s,o,n,r))return!0;var n,r,s,o,a,l;return!1}function ui(t,e){for(let i=0;i<t.length;++i)if(!ai(t[i],e))return!1;for(let i=0;i<t.length-1;++i)if(hi(t[i],t[i+1],e))return!1;return!0}function di(t,e){for(let i=0;i<e.length;i++)if(ui(t,e[i]))return!0;return!1}function pi(t,e,i){const n=[];for(let r=0;r<t.length;r++){const s=[];for(let n=0;n<t[r].length;n++){const o=si(t[r][n],i);ni(e,o),s.push(o)}n.push(s)}return n}function fi(t,e,i){const n=[];for(let r=0;r<t.length;r++){const s=pi(t[r],e,i);n.push(s)}return n}function mi(t,e,i,n){if(t[0]<i[0]||t[0]>i[2]){const e=.5*n;let r=t[0]-i[0]>e?-n:i[0]-t[0]>e?n:0;0===r&&(r=t[0]-i[2]>e?-n:i[2]-t[0]>e?n:0),t[0]+=r}ni(e,t)}function gi(t,e,i,n){const r=Math.pow(2,n.z)*ii,s=[n.x*ii,n.y*ii],o=[];if(!t)return o;for(const n of t)for(const t of n){const n=[t.x+s[0],t.y+s[1]];mi(n,e,i,r),o.push(n)}return o}function _i(t,e,i,n){const r=Math.pow(2,n.z)*ii,s=[n.x*ii,n.y*ii],o=[];if(!t)return o;for(const i of t){const t=[];for(const n of i){const i=[n.x+s[0],n.y+s[1]];ni(e,i),t.push(i)}o.push(t)}if(e[2]-e[0]<=r/2){(a=e)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const t of o)for(const n of t)mi(n,e,i,r)}var a;return o}class yi{constructor(t,e){this.type=ue,this.geojson=t,this.geometries=e}static parse(t,e){if(2!==t.length)return e.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Fe(t[1])){const e=t[1];if("FeatureCollection"===e.type)for(let t=0;t<e.features.length;++t){const i=e.features[t].geometry.type;if("Polygon"===i||"MultiPolygon"===i)return new yi(e,e.features[t].geometry)}else if("Feature"===e.type){const t=e.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new yi(e,e.geometry)}else if("Polygon"===e.type||"MultiPolygon"===e.type)return new yi(e,e)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=t.canonicalID();if(!r)return!1;if("Polygon"===e.type){const s=pi(e.coordinates,n,r),o=gi(t.geometry(),i,n,r);if(!ri(i,n))return!1;for(const t of o)if(!ai(t,s))return!1}if("MultiPolygon"===e.type){const s=fi(e.coordinates,n,r),o=gi(t.geometry(),i,n,r);if(!ri(i,n))return!1;for(const t of o)if(!li(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){const i=[1/0,1/0,-1/0,-1/0],n=[1/0,1/0,-1/0,-1/0],r=t.canonicalID();if(!r)return!1;if("Polygon"===e.type){const s=pi(e.coordinates,n,r),o=_i(t.geometry(),i,n,r);if(!ri(i,n))return!1;for(const t of o)if(!ui(t,s))return!1}if("MultiPolygon"===e.type){const s=fi(e.coordinates,n,r),o=_i(t.geometry(),i,n,r);if(!ri(i,n))return!1;for(const t of o)if(!di(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var vi=yi;function xi(t){if(t instanceof ti){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof vi)return!1;let e=!0;return t.eachChild((t=>{e&&!xi(t)&&(e=!1)})),e}function bi(t){if(t instanceof ti&&"feature-state"===t.name)return!1;let e=!0;return t.eachChild((t=>{e&&!bi(t)&&(e=!1)})),e}function wi(t,e){if(t instanceof ti&&e.indexOf(t.name)>=0)return!1;let i=!0;return t.eachChild((t=>{i&&!wi(t,e)&&(i=!1)})),i}class Ai{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(t,e){if(2!==t.length||"string"!=typeof t[1])return e.error("'var' expression requires exactly one string literal argument.");const i=t[1];return e.scope.has(i)?new Ai(i,e.scope.get(i)):e.error(`Unknown variable "${i}". Make sure "${i}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var Ti=Ai;class Mi{constructor(t,e=[],i,n=new ae,r=[]){this.registry=t,this.path=e,this.key=e.map((t=>`[${t}]`)).join(""),this.scope=n,this.errors=r,this.expectedType=i}parse(t,e,i,n,r={}){return e?this.concat(e,i,n)._parse(t,r):this._parse(t,r)}_parse(t,e){function i(t,e,i){return"assert"===i?new We(e,[t]):"coerce"===i?new Ye(e,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const n=t[0];if("string"!=typeof n)return this.error(`Expression name must be a string, but found ${typeof n} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const r=this.registry[n];if(r){let n=r.parse(t,this);if(!n)return null;if(this.expectedType){const t=this.expectedType,r=n.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==r.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==r.kind&&"string"!==r.kind){if(this.checkSubtype(t,r))return null}else n=i(n,t,e.typeAnnotation||"coerce");else n=i(n,t,e.typeAnnotation||"assert")}if(!(n instanceof Ge)&&"resolvedImage"!==n.type.kind&&Ei(n)){const e=new Ke;try{n=new Ge(n.type,n.evaluate(e))}catch(t){return this.error(t.message),null}}return n}return this.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,e,i){const n="number"==typeof t?this.path.concat(t):this.path,r=i?this.scope.concat(i):this.scope;return new Mi(this.registry,n,e||null,r,this.errors)}error(t,...e){const i=`${this.key}${e.map((t=>`[${t}]`)).join("")}`;this.errors.push(new se(i,t))}checkSubtype(t,e){const i=be(t,e);return i&&this.error(i),i}}var Si=Mi;function Ei(t){if(t instanceof Ti)return Ei(t.boundExpression);if(t instanceof ti&&"error"===t.name)return!1;if(t instanceof ei)return!1;if(t instanceof vi)return!1;const e=t instanceof Ye||t instanceof We;let i=!0;return t.eachChild((t=>{i=e?i&&Ei(t):i&&t instanceof Ge})),!!i&&xi(t)&&wi(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function Ci(t,e){const i=t.length-1;let n,r,s=0,o=i,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),n=t[a],r=t[a+1],n<=e){if(a===i||e<r)return a;s=a+1}else{if(!(n>e))throw new Ve("Input is not a number.");o=a-1}return 0}class Ii{constructor(t,e,i){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[t,e]of i)this.labels.push(t),this.outputs.push(e)}static parse(t,e){if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");const i=e.parse(t[1],1,ce);if(!i)return null;const n=[];let r=null;e.expectedType&&"value"!==e.expectedType.kind&&(r=e.expectedType);for(let i=1;i<t.length;i+=2){const s=1===i?-1/0:t[i],o=t[i+1],a=i,l=i+1;if("number"!=typeof s)return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(n.length&&n[n.length-1][0]>=s)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const c=e.parse(o,l,r);if(!c)return null;r=r||c.type,n.push([s,c])}return new Ii(r,i,n)}evaluate(t){const e=this.labels,i=this.outputs;if(1===e.length)return i[0].evaluate(t);const n=this.input.evaluate(t);if(n<=e[0])return i[0].evaluate(t);const r=e.length;return n>=e[r-1]?i[r-1].evaluate(t):i[Ci(e,n)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}}var Pi=Ii;function Li(t,e,i){return t*(1-i)+e*i}var Ri=Object.freeze({__proto__:null,array:function(t,e,i){return t.map(((t,n)=>Li(t,e[n],i)))},color:function(t,e,i){return new Le(Li(t.r,e.r,i),Li(t.g,e.g,i),Li(t.b,e.b,i),Li(t.a,e.a,i))},number:Li});const Bi=.95047,Di=1.08883,Oi=4/29,ki=6/29,Fi=3*ki*ki,zi=ki*ki*ki,Ni=Math.PI/180,Ui=180/Math.PI;function Gi(t){return t>zi?Math.pow(t,1/3):t/Fi+Oi}function Vi(t){return t>ki?t*t*t:Fi*(t-Oi)}function ji(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Hi(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Wi(t){const e=Hi(t.r),i=Hi(t.g),n=Hi(t.b),r=Gi((.4124564*e+.3575761*i+.1804375*n)/Bi),s=Gi((.2126729*e+.7151522*i+.072175*n)/1);return{l:116*s-16,a:500*(r-s),b:200*(s-Gi((.0193339*e+.119192*i+.9503041*n)/Di)),alpha:t.a}}function qi(t){let e=(t.l+16)/116,i=isNaN(t.a)?e:e+t.a/500,n=isNaN(t.b)?e:e-t.b/200;return e=1*Vi(e),i=Bi*Vi(i),n=Di*Vi(n),new Le(ji(3.2404542*i-1.5371385*e-.4985314*n),ji(-.969266*i+1.8760108*e+.041556*n),ji(.0556434*i-.2040259*e+1.0572252*n),t.alpha)}function Xi(t,e,i){const n=e-t;return t+i*(n>180||n<-180?n-360*Math.round(n/360):n)}const Zi={forward:Wi,reverse:qi,interpolate:function(t,e,i){return{l:Li(t.l,e.l,i),a:Li(t.a,e.a,i),b:Li(t.b,e.b,i),alpha:Li(t.alpha,e.alpha,i)}}},Ji={forward:function(t){const{l:e,a:i,b:n}=Wi(t),r=Math.atan2(n,i)*Ui;return{h:r<0?r+360:r,c:Math.sqrt(i*i+n*n),l:e,alpha:t.a}},reverse:function(t){const e=t.h*Ni,i=t.c;return qi({l:t.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:t.alpha})},interpolate:function(t,e,i){return{h:Xi(t.h,e.h,i),c:Li(t.c,e.c,i),l:Li(t.l,e.l,i),alpha:Li(t.alpha,e.alpha,i)}}};var Yi=Object.freeze({__proto__:null,hcl:Ji,lab:Zi});class $i{constructor(t,e,i,n,r){this.type=t,this.operator=e,this.interpolation=i,this.input=n,this.labels=[],this.outputs=[];for(const[t,e]of r)this.labels.push(t),this.outputs.push(e)}static interpolationFactor(t,e,i,n){let r=0;if("exponential"===t.name)r=Ki(e,t.base,i,n);else if("linear"===t.name)r=Ki(e,1,i,n);else if("cubic-bezier"===t.name){const s=t.controlPoints;r=new m(s[0],s[1],s[2],s[3]).solve(Ki(e,1,i,n))}return r}static parse(t,e){let[i,n,r,...s]=t;if(!Array.isArray(n)||0===n.length)return e.error("Expected an interpolation type expression.",1);if("linear"===n[0])n={name:"linear"};else if("exponential"===n[0]){const t=n[1];if("number"!=typeof t)return e.error("Exponential interpolation requires a numeric base.",1,1);n={name:"exponential",base:t}}else{if("cubic-bezier"!==n[0])return e.error(`Unknown interpolation type ${String(n[0])}`,1,0);{const t=n.slice(1);if(4!==t.length||t.some((t=>"number"!=typeof t||t<0||t>1)))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);n={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(r=e.parse(r,2,ce),!r)return null;const o=[];let a=null;"interpolate-hcl"===i||"interpolate-lab"===i?a=de:e.expectedType&&"value"!==e.expectedType.kind&&(a=e.expectedType);for(let t=0;t<s.length;t+=2){const i=s[t],n=s[t+1],r=t+3,l=t+4;if("number"!=typeof i)return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',r);if(o.length&&o[o.length-1][0]>=i)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',r);const c=e.parse(n,l,a);if(!c)return null;a=a||c.type,o.push([i,c])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new $i(a,i,n,r,o):e.error(`Type ${ve(a)} is not interpolatable.`)}evaluate(t){const e=this.labels,i=this.outputs;if(1===e.length)return i[0].evaluate(t);const n=this.input.evaluate(t);if(n<=e[0])return i[0].evaluate(t);const r=e.length;if(n>=e[r-1])return i[r-1].evaluate(t);const s=Ci(e,n),o=$i.interpolationFactor(this.interpolation,n,e[s],e[s+1]),a=i[s].evaluate(t),l=i[s+1].evaluate(t);return"interpolate"===this.operator?Ri[this.type.kind.toLowerCase()](a,l,o):"interpolate-hcl"===this.operator?Ji.reverse(Ji.interpolate(Ji.forward(a),Ji.forward(l),o)):Zi.reverse(Zi.interpolate(Zi.forward(a),Zi.forward(l),o))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)e.push(this.labels[t],this.outputs[t].serialize());return e}}function Ki(t,e,i,n){const r=n-i,s=t-i;return 0===r?0:1===e?s/r:(Math.pow(e,s)-1)/(Math.pow(e,r)-1)}var Qi=$i;class tn{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expectected at least one argument.");let i=null;const n=e.expectedType;n&&"value"!==n.kind&&(i=n);const r=[];for(const n of t.slice(1)){const t=e.parse(n,1+r.length,i,void 0,{typeAnnotation:"omit"});if(!t)return null;i=i||t.type,r.push(t)}const s=n&&r.some((t=>be(n,t.type)));return new tn(s?fe:i,r)}evaluate(t){let e,i=null,n=0;for(const r of this.args){if(n++,i=r.evaluate(t),i&&i instanceof Oe&&!i.available&&(e||(e=i),i=null,n===this.args.length))return e;if(null!==i)break}return i}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=["coalesce"];return this.eachChild((e=>{t.push(e.serialize())})),t}}var en=tn;class nn{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const i=[];for(let n=1;n<t.length-1;n+=2){const r=t[n];if("string"!=typeof r)return e.error(`Expected string, but found ${typeof r} instead.`,n);if(/[^a-zA-Z0-9_]/.test(r))return e.error("Variable names must contain only alphanumeric characters or '_'.",n);const s=e.parse(t[n+1],n+1);if(!s)return null;i.push([r,s])}const n=e.parse(t[t.length-1],t.length-1,e.expectedType,i);return n?new nn(i,n):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,i]of this.bindings)t.push(e,i.serialize());return t.push(this.result.serialize()),t}}var rn=nn;class sn{constructor(t,e,i){this.type=t,this.index=e,this.input=i}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,ce),n=e.parse(t[2],2,ye(e.expectedType||fe));return i&&n?new sn(n.type.itemType,i,n):null}evaluate(t){const e=this.index.evaluate(t),i=this.input.evaluate(t);if(e<0)throw new Ve(`Array index out of bounds: ${e} < 0.`);if(e>=i.length)throw new Ve(`Array index out of bounds: ${e} > ${i.length-1}.`);if(e!==Math.floor(e))throw new Ve(`Array index must be an integer, but found ${e} instead.`);return i[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var on=sn;class an{constructor(t,e){this.type=ue,this.needle=t,this.haystack=e}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,fe),n=e.parse(t[2],2,fe);return i&&n?we(i.type,[ue,he,ce,le,fe])?new an(i,n):e.error(`Expected first argument to be of type boolean, string, number or null, but found ${ve(i.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),i=this.haystack.evaluate(t);if(null==i)return!1;if(!Ae(e,["boolean","string","number","null"]))throw new Ve(`Expected first argument to be of type boolean, string, number or null, but found ${ve(ze(e))} instead.`);if(!Ae(i,["string","array"]))throw new Ve(`Expected second argument to be of type array or string, but found ${ve(ze(i))} instead.`);return i.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var ln=an;class cn{constructor(t,e,i){this.type=ce,this.needle=t,this.haystack=e,this.fromIndex=i}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,fe),n=e.parse(t[2],2,fe);if(!i||!n)return null;if(!we(i.type,[ue,he,ce,le,fe]))return e.error(`Expected first argument to be of type boolean, string, number or null, but found ${ve(i.type)} instead`);if(4===t.length){const r=e.parse(t[3],3,ce);return r?new cn(i,n,r):null}return new cn(i,n)}evaluate(t){const e=this.needle.evaluate(t),i=this.haystack.evaluate(t);if(!Ae(e,["boolean","string","number","null"]))throw new Ve(`Expected first argument to be of type boolean, string, number or null, but found ${ve(ze(e))} instead.`);if(!Ae(i,["string","array"]))throw new Ve(`Expected second argument to be of type array or string, but found ${ve(ze(i))} instead.`);if(this.fromIndex){const n=this.fromIndex.evaluate(t);return i.indexOf(e,n)}return i.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var hn=cn;class un{constructor(t,e,i,n,r,s){this.inputType=t,this.type=e,this.input=i,this.cases=n,this.outputs=r,this.otherwise=s}static parse(t,e){if(t.length<5)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return e.error("Expected an even number of arguments.");let i,n;e.expectedType&&"value"!==e.expectedType.kind&&(n=e.expectedType);const r={},s=[];for(let o=2;o<t.length-1;o+=2){let a=t[o];const l=t[o+1];Array.isArray(a)||(a=[a]);const c=e.concat(o);if(0===a.length)return c.error("Expected at least one branch label.");for(const t of a){if("number"!=typeof t&&"string"!=typeof t)return c.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return c.error("Numeric branch labels must be integer values.");if(i){if(c.checkSubtype(i,ze(t)))return null}else i=ze(t);if(void 0!==r[String(t)])return c.error("Branch labels must be unique.");r[String(t)]=s.length}const h=e.parse(l,o,n);if(!h)return null;n=n||h.type,s.push(h)}const o=e.parse(t[1],1,fe);if(!o)return null;const a=e.parse(t[t.length-1],t.length-1,n);return a?"value"!==o.type.kind&&e.concat(1).checkSubtype(i,o.type)?null:new un(i,n,o,r,s,a):null}evaluate(t){const e=this.input.evaluate(t);return(ze(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),i=[],n={};for(const t of e){const e=n[this.cases[t]];void 0===e?(n[this.cases[t]]=i.length,i.push([this.cases[t],[t]])):i[e][1].push(t)}const r=t=>"number"===this.inputType.kind?Number(t):t;for(const[e,n]of i)t.push(1===n.length?r(n[0]):n.map(r)),t.push(this.outputs[e].serialize());return t.push(this.otherwise.serialize()),t}}var dn=un;class pn{constructor(t,e,i){this.type=t,this.branches=e,this.otherwise=i}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return e.error("Expected an odd number of arguments.");let i;e.expectedType&&"value"!==e.expectedType.kind&&(i=e.expectedType);const n=[];for(let r=1;r<t.length-1;r+=2){const s=e.parse(t[r],r,ue);if(!s)return null;const o=e.parse(t[r+1],r+1,i);if(!o)return null;n.push([s,o]),i=i||o.type}const r=e.parse(t[t.length-1],t.length-1,i);return r?new pn(i,n,r):null}evaluate(t){for(const[e,i]of this.branches)if(e.evaluate(t))return i.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,i]of this.branches)t(e),t(i);t(this.otherwise)}outputDefined(){return this.branches.every((([t,e])=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild((e=>{t.push(e.serialize())})),t}}var fn=pn;class mn{constructor(t,e,i,n){this.type=t,this.input=e,this.beginIndex=i,this.endIndex=n}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const i=e.parse(t[1],1,fe),n=e.parse(t[2],2,ce);if(!i||!n)return null;if(!we(i.type,[ye(fe),he,fe]))return e.error(`Expected first argument to be of type array or string, but found ${ve(i.type)} instead`);if(4===t.length){const r=e.parse(t[3],3,ce);return r?new mn(i.type,i,n,r):null}return new mn(i.type,i,n)}evaluate(t){const e=this.input.evaluate(t),i=this.beginIndex.evaluate(t);if(!Ae(e,["string","array"]))throw new Ve(`Expected first argument to be of type array or string, but found ${ve(ze(e))} instead.`);if(this.endIndex){const n=this.endIndex.evaluate(t);return e.slice(i,n)}return e.slice(i)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var gn=mn;function _n(t,e){return"=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function yn(t,e,i,n){return 0===n.compare(e,i)}function vn(t,e,i){const n="=="!==t&&"!="!==t;return class r{constructor(t,e,i){this.type=ue,this.lhs=t,this.rhs=e,this.collator=i,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind}static parse(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");const i=t[0];let s=e.parse(t[1],1,fe);if(!s)return null;if(!_n(i,s.type))return e.concat(1).error(`"${i}" comparisons are not supported for type '${ve(s.type)}'.`);let o=e.parse(t[2],2,fe);if(!o)return null;if(!_n(i,o.type))return e.concat(2).error(`"${i}" comparisons are not supported for type '${ve(o.type)}'.`);if(s.type.kind!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return e.error(`Cannot compare types '${ve(s.type)}' and '${ve(o.type)}'.`);n&&("value"===s.type.kind&&"value"!==o.type.kind?s=new We(o.type,[s]):"value"!==s.type.kind&&"value"===o.type.kind&&(o=new We(s.type,[o])));let a=null;if(4===t.length){if("string"!==s.type.kind&&"string"!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return e.error("Cannot use collator to compare non-string types.");if(a=e.parse(t[3],3,me),!a)return null}return new r(s,o,a)}evaluate(r){const s=this.lhs.evaluate(r),o=this.rhs.evaluate(r);if(n&&this.hasUntypedArgument){const e=ze(s),i=ze(o);if(e.kind!==i.kind||"string"!==e.kind&&"number"!==e.kind)throw new Ve(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${e.kind}, ${i.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const t=ze(s),i=ze(o);if("string"!==t.kind||"string"!==i.kind)return e(r,s,o)}return this.collator?i(r,s,o,this.collator.evaluate(r)):e(r,s,o)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const e=[t];return this.eachChild((t=>{e.push(t.serialize())})),e}}}const xn=vn("==",(function(t,e,i){return e===i}),yn),bn=vn("!=",(function(t,e,i){return e!==i}),(function(t,e,i,n){return!yn(0,e,i,n)})),wn=vn("<",(function(t,e,i){return e<i}),(function(t,e,i,n){return n.compare(e,i)<0})),An=vn(">",(function(t,e,i){return e>i}),(function(t,e,i,n){return n.compare(e,i)>0})),Tn=vn("<=",(function(t,e,i){return e<=i}),(function(t,e,i,n){return n.compare(e,i)<=0})),Mn=vn(">=",(function(t,e,i){return e>=i}),(function(t,e,i,n){return n.compare(e,i)>=0}));class Sn{constructor(t,e,i,n,r,s){this.type=he,this.number=t,this.locale=e,this.currency=i,this.unit=n,this.minFractionDigits=r,this.maxFractionDigits=s}static parse(t,e){if(3!==t.length)return e.error("Expected two arguments.");const i=e.parse(t[1],1,ce);if(!i)return null;const n=t[2];if("object"!=typeof n||Array.isArray(n))return e.error("NumberFormat options argument must be an object.");let r=null;if(n.locale&&(r=e.parse(n.locale,1,he),!r))return null;let s=null;if(n.currency&&(s=e.parse(n.currency,1,he),!s))return null;let o=null;if(n.unit&&(o=e.parse(n.unit,1,he),!o))return null;let a=null;if(n["min-fraction-digits"]&&(a=e.parse(n["min-fraction-digits"],1,ce),!a))return null;let l=null;return n["max-fraction-digits"]&&(l=e.parse(n["max-fraction-digits"],1,ce),!l)?null:new Sn(i,r,s,o,a,l)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class En{constructor(t){this.type=ce,this.input=t}static parse(t,e){if(2!==t.length)return e.error(`Expected 1 argument, but found ${t.length-1} instead.`);const i=e.parse(t[1],1);return i?"array"!==i.type.kind&&"string"!==i.type.kind&&"value"!==i.type.kind?e.error(`Expected argument of type string or array, but found ${ve(i.type)} instead.`):new En(i):null}evaluate(t){const e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new Ve(`Expected value to be of type string or array, but found ${ve(ze(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild((e=>{t.push(e.serialize())})),t}}const Cn={"==":xn,"!=":bn,">":An,"<":wn,">=":Mn,"<=":Tn,array:We,at:on,boolean:We,case:fn,coalesce:en,collator:ei,format:qe,image:Xe,in:ln,"index-of":hn,interpolate:Qi,"interpolate-hcl":Qi,"interpolate-lab":Qi,length:En,let:rn,literal:Ge,match:dn,number:We,"number-format":Sn,object:We,slice:gn,step:Pi,string:We,"to-boolean":Ye,"to-color":Ye,"to-number":Ye,"to-string":Ye,var:Ti,within:vi};function In(t,[e,i,n,r]){e=e.evaluate(t),i=i.evaluate(t),n=n.evaluate(t);const s=r?r.evaluate(t):1,o=ke(e,i,n,s);if(o)throw new Ve(o);return new Le(e/255*s,i/255*s,n/255*s,s)}function Pn(t,e){return t in e}function Ln(t,e){const i=e[t];return void 0===i?null:i}function Rn(t){return{type:t}}ti.register(Cn,{error:[{kind:"error"},[he],(t,[e])=>{throw new Ve(e.evaluate(t))}],typeof:[he,[fe],(t,[e])=>ve(ze(e.evaluate(t)))],"to-rgba":[ye(ce,4),[de],(t,[e])=>e.evaluate(t).toArray()],rgb:[de,[ce,ce,ce],In],rgba:[de,[ce,ce,ce,ce],In],has:{type:ue,overloads:[[[he],(t,[e])=>Pn(e.evaluate(t),t.properties())],[[he,pe],(t,[e,i])=>Pn(e.evaluate(t),i.evaluate(t))]]},get:{type:fe,overloads:[[[he],(t,[e])=>Ln(e.evaluate(t),t.properties())],[[he,pe],(t,[e,i])=>Ln(e.evaluate(t),i.evaluate(t))]]},"feature-state":[fe,[he],(t,[e])=>Ln(e.evaluate(t),t.featureState||{})],properties:[pe,[],t=>t.properties()],"geometry-type":[he,[],t=>t.geometryType()],id:[fe,[],t=>t.id()],zoom:[ce,[],t=>t.globals.zoom],pitch:[ce,[],t=>t.globals.pitch||0],"distance-from-center":[ce,[],t=>t.distanceFromCenter()],"heatmap-density":[ce,[],t=>t.globals.heatmapDensity||0],"line-progress":[ce,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[ce,[],t=>t.globals.skyRadialProgress||0],accumulated:[fe,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[ce,Rn(ce),(t,e)=>{let i=0;for(const n of e)i+=n.evaluate(t);return i}],"*":[ce,Rn(ce),(t,e)=>{let i=1;for(const n of e)i*=n.evaluate(t);return i}],"-":{type:ce,overloads:[[[ce,ce],(t,[e,i])=>e.evaluate(t)-i.evaluate(t)],[[ce],(t,[e])=>-e.evaluate(t)]]},"/":[ce,[ce,ce],(t,[e,i])=>e.evaluate(t)/i.evaluate(t)],"%":[ce,[ce,ce],(t,[e,i])=>e.evaluate(t)%i.evaluate(t)],ln2:[ce,[],()=>Math.LN2],pi:[ce,[],()=>Math.PI],e:[ce,[],()=>Math.E],"^":[ce,[ce,ce],(t,[e,i])=>Math.pow(e.evaluate(t),i.evaluate(t))],sqrt:[ce,[ce],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[ce,[ce],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[ce,[ce],(t,[e])=>Math.log(e.evaluate(t))],log2:[ce,[ce],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[ce,[ce],(t,[e])=>Math.sin(e.evaluate(t))],cos:[ce,[ce],(t,[e])=>Math.cos(e.evaluate(t))],tan:[ce,[ce],(t,[e])=>Math.tan(e.evaluate(t))],asin:[ce,[ce],(t,[e])=>Math.asin(e.evaluate(t))],acos:[ce,[ce],(t,[e])=>Math.acos(e.evaluate(t))],atan:[ce,[ce],(t,[e])=>Math.atan(e.evaluate(t))],min:[ce,Rn(ce),(t,e)=>Math.min(...e.map((e=>e.evaluate(t))))],max:[ce,Rn(ce),(t,e)=>Math.max(...e.map((e=>e.evaluate(t))))],abs:[ce,[ce],(t,[e])=>Math.abs(e.evaluate(t))],round:[ce,[ce],(t,[e])=>{const i=e.evaluate(t);return i<0?-Math.round(-i):Math.round(i)}],floor:[ce,[ce],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[ce,[ce],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[ue,[he,fe],(t,[e,i])=>t.properties()[e.value]===i.value],"filter-id-==":[ue,[fe],(t,[e])=>t.id()===e.value],"filter-type-==":[ue,[he],(t,[e])=>t.geometryType()===e.value],"filter-<":[ue,[he,fe],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n<r}],"filter-id-<":[ue,[fe],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i<n}],"filter->":[ue,[he,fe],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n>r}],"filter-id->":[ue,[fe],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i>n}],"filter-<=":[ue,[he,fe],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n<=r}],"filter-id-<=":[ue,[fe],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i<=n}],"filter->=":[ue,[he,fe],(t,[e,i])=>{const n=t.properties()[e.value],r=i.value;return typeof n==typeof r&&n>=r}],"filter-id->=":[ue,[fe],(t,[e])=>{const i=t.id(),n=e.value;return typeof i==typeof n&&i>=n}],"filter-has":[ue,[fe],(t,[e])=>e.value in t.properties()],"filter-has-id":[ue,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[ue,[ye(he)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[ue,[ye(fe)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[ue,[he,ye(fe)],(t,[e,i])=>i.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[ue,[he,ye(fe)],(t,[e,i])=>function(t,e,i,n){for(;i<=n;){const r=i+n>>1;if(e[r]===t)return!0;e[r]>t?n=r-1:i=r+1}return!1}(t.properties()[e.value],i.value,0,i.value.length-1)],all:{type:ue,overloads:[[[ue,ue],(t,[e,i])=>e.evaluate(t)&&i.evaluate(t)],[Rn(ue),(t,e)=>{for(const i of e)if(!i.evaluate(t))return!1;return!0}]]},any:{type:ue,overloads:[[[ue,ue],(t,[e,i])=>e.evaluate(t)||i.evaluate(t)],[Rn(ue),(t,e)=>{for(const i of e)if(i.evaluate(t))return!0;return!1}]]},"!":[ue,[ue],(t,[e])=>!e.evaluate(t)],"is-supported-script":[ue,[he],(t,[e])=>{const i=t.globals&&t.globals.isSupportedScript;return!i||i(e.evaluate(t))}],upcase:[he,[he],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[he,[he],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[he,Rn(fe),(t,e)=>e.map((e=>Ne(e.evaluate(t)))).join("")],"resolved-locale":[he,[me],(t,[e])=>e.evaluate(t).resolvedLocale()]});var Bn=Cn;function Dn(t){return{result:"success",value:t}}function On(t){return{result:"error",value:t}}function kn(t){return"data-driven"===t["property-type"]}function Fn(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}function zn(t){return!!t.expression&&t.expression.interpolated}function Nn(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function Un(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function Gn(t){return t}function Vn(t,e){const i="color"===e.type,n=t.stops&&"object"==typeof t.stops[0][0],r=n||!(n||void 0!==t.property),s=t.type||(zn(e)?"exponential":"interval");if(i&&((t=ee({},t)).stops&&(t.stops=t.stops.map((t=>[t[0],Le.parse(t[1])]))),t.default=Le.parse(t.default?t.default:e.default)),t.colorSpace&&"rgb"!==t.colorSpace&&!Yi[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let o,a,l;if("exponential"===s)o=qn;else if("interval"===s)o=Wn;else if("categorical"===s){o=Hn,a=Object.create(null);for(const e of t.stops)a[e[0]]=e[1];l=typeof t.stops[0][0]}else{if("identity"!==s)throw new Error(`Unknown function type "${s}"`);o=Xn}if(n){const i={},n=[];for(let e=0;e<t.stops.length;e++){const r=t.stops[e],s=r[0].zoom;void 0===i[s]&&(i[s]={zoom:s,type:t.type,property:t.property,default:t.default,stops:[]},n.push(s)),i[s].stops.push([r[0].value,r[1]])}const r=[];for(const t of n)r.push([i[t].zoom,Vn(i[t],e)]);const s={name:"linear"};return{kind:"composite",interpolationType:s,interpolationFactor:Qi.interpolationFactor.bind(void 0,s),zoomStops:r.map((t=>t[0])),evaluate:({zoom:i},n)=>qn({stops:r,base:t.base},e,i).evaluate(i,n)}}if(r){const i="exponential"===s?{name:"exponential",base:void 0!==t.base?t.base:1}:null;return{kind:"camera",interpolationType:i,interpolationFactor:Qi.interpolationFactor.bind(void 0,i),zoomStops:t.stops.map((t=>t[0])),evaluate:({zoom:i})=>o(t,e,i,a,l)}}return{kind:"source",evaluate(i,n){const r=n&&n.properties?n.properties[t.property]:void 0;return void 0===r?jn(t.default,e.default):o(t,e,r,a,l)}}}function jn(t,e,i){return void 0!==t?t:void 0!==e?e:void 0!==i?i:void 0}function Hn(t,e,i,n,r){return jn(typeof i===r?n[i]:void 0,t.default,e.default)}function Wn(t,e,i){if("number"!==Nn(i))return jn(t.default,e.default);const n=t.stops.length;if(1===n)return t.stops[0][1];if(i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[n-1][0])return t.stops[n-1][1];const r=Ci(t.stops.map((t=>t[0])),i);return t.stops[r][1]}function qn(t,e,i){const n=void 0!==t.base?t.base:1;if("number"!==Nn(i))return jn(t.default,e.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[r-1][0])return t.stops[r-1][1];const s=Ci(t.stops.map((t=>t[0])),i),o=function(t,e,i,n){const r=n-i,s=t-i;return 0===r?0:1===e?s/r:(Math.pow(e,s)-1)/(Math.pow(e,r)-1)}(i,n,t.stops[s][0],t.stops[s+1][0]),a=t.stops[s][1],l=t.stops[s+1][1];let c=Ri[e.type]||Gn;if(t.colorSpace&&"rgb"!==t.colorSpace){const e=Yi[t.colorSpace];c=(t,i)=>e.reverse(e.interpolate(e.forward(t),e.forward(i),o))}return"function"==typeof a.evaluate?{evaluate(...t){const e=a.evaluate.apply(void 0,t),i=l.evaluate.apply(void 0,t);if(void 0!==e&&void 0!==i)return c(e,i,o)}}:c(a,l,o)}function Xn(t,e,i){return"color"===e.type?i=Le.parse(i):"formatted"===e.type?i=De.fromString(i.toString()):"resolvedImage"===e.type?i=Oe.fromString(i.toString()):Nn(i)===e.type||"enum"===e.type&&e.values[i]||(i=void 0),jn(i,t.default,e.default)}class Zn{constructor(t,e){this.expression=t,this._warningHistory={},this._evaluator=new Ke,this._defaultValue=e?function(t){return"color"===t.type&&(Un(t.default)||Array.isArray(t.default))?new Le(0,0,0,0):"color"===t.type?Le.parse(t.default)||null:void 0===t.default?null:t.default}(e):null,this._enumValues=e&&"enum"===e.type?e.values:null}evaluateWithoutErrorHandling(t,e,i,n,r,s,o,a){return this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=i,this._evaluator.canonical=n||null,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=s,this._evaluator.featureTileCoord=o||null,this._evaluator.featureDistanceData=a||null,this.expression.evaluate(this._evaluator)}evaluate(t,e,i,n,r,s,o,a){this._evaluator.globals=t,this._evaluator.feature=e||null,this._evaluator.featureState=i||null,this._evaluator.canonical=n||null,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=s||null,this._evaluator.featureTileCoord=o||null,this._evaluator.featureDistanceData=a||null;try{const t=this.expression.evaluate(this._evaluator);if(null==t||"number"==typeof t&&t!=t)return this._defaultValue;if(this._enumValues&&!(t in this._enumValues))throw new Ve(`Expected value to be one of ${Object.keys(this._enumValues).map((t=>JSON.stringify(t))).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(t){return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0),this._defaultValue}}}function Jn(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in Bn}function Yn(t,e){const i=new Si(Bn,[],e?function(t){const e={color:de,string:he,number:ce,enum:he,boolean:ue,formatted:ge,resolvedImage:_e};return"array"===t.type?ye(e[t.value]||fe,t.length):e[t.type]}(e):void 0),n=i.parse(t,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return n?Dn(new Zn(n,e)):On(i.errors)}class $n{constructor(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent="constant"!==t&&!bi(e.expression)}evaluateWithoutErrorHandling(t,e,i,n,r,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,i,n,r,s)}evaluate(t,e,i,n,r,s){return this._styleExpression.evaluate(t,e,i,n,r,s)}}class Kn{constructor(t,e,i,n){this.kind=t,this.zoomStops=i,this._styleExpression=e,this.isStateDependent="camera"!==t&&!bi(e.expression),this.interpolationType=n}evaluateWithoutErrorHandling(t,e,i,n,r,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,i,n,r,s)}evaluate(t,e,i,n,r,s){return this._styleExpression.evaluate(t,e,i,n,r,s)}interpolationFactor(t,e,i){return this.interpolationType?Qi.interpolationFactor(this.interpolationType,t,e,i):0}}function Qn(t,e){if("error"===(t=Yn(t,e)).result)return t;const i=t.value.expression,n=xi(i);if(!n&&!kn(e))return On([new se("","data expressions not supported")]);const r=wi(i,["zoom","pitch","distance-from-center"]);if(!r&&!Fn(e))return On([new se("","zoom expressions not supported")]);const s=er(i);return s||r?s instanceof se?On([s]):s instanceof Qi&&!zn(e)?On([new se("",'"interpolate" expressions cannot be used with this property')]):Dn(s?new Kn(n?"camera":"composite",t.value,s.labels,s instanceof Qi?s.interpolation:void 0):new $n(n?"constant":"source",t.value)):On([new se("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class tr{constructor(t,e){this._parameters=t,this._specification=e,ee(this,Vn(this._parameters,this._specification))}static deserialize(t){return new tr(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function er(t){let e=null;if(t instanceof rn)e=er(t.result);else if(t instanceof en){for(const i of t.args)if(e=er(i),e)break}else(t instanceof Pi||t instanceof Qi)&&t.input instanceof ti&&"zoom"===t.input.name&&(e=t);return e instanceof se||t.eachChild((t=>{const i=er(t);i instanceof se?e=i:!e&&i?e=new se("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):e&&i&&e!==i&&(e=new se("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}class ir{constructor(t,e,i,n){this.message=(t?`${t}: `:"")+i,n&&(this.identifier=n),null!=e&&e.__line__&&(this.line=e.__line__)}}function nr(t){const e=t.key,i=t.value,n=t.valueSpec||{},r=t.objectElementValidators||{},s=t.style,o=t.styleSpec;let a=[];const l=Nn(i);if("object"!==l)return[new ir(e,i,`object expected, ${l} found`)];for(const t in i){const l=t.split(".")[0];let c;r[l]?c=r[l]:n[l]?c=Fr:r["*"]?c=r["*"]:n["*"]&&(c=Fr),c?a=a.concat(c({key:(e?`${e}.`:e)+t,value:i[t],valueSpec:n[l]||n["*"],style:s,styleSpec:o,object:i,objectKey:t},i)):a.push(new ir(e,i[t],`unknown property "${t}"`))}for(const t in n)r[t]||n[t].required&&void 0===n[t].default&&void 0===i[t]&&a.push(new ir(e,i,`missing required property "${t}"`));return a}function rr(t){const e=t.value,i=t.valueSpec,n=t.style,r=t.styleSpec,s=t.key,o=t.arrayElementValidator||Fr;if("array"!==Nn(e))return[new ir(s,e,`array expected, ${Nn(e)} found`)];if(i.length&&e.length!==i.length)return[new ir(s,e,`array length ${i.length} expected, length ${e.length} found`)];if(i["min-length"]&&e.length<i["min-length"])return[new ir(s,e,`array length at least ${i["min-length"]} expected, length ${e.length} found`)];let a={type:i.value,values:i.values,minimum:i.minimum,maximum:i.maximum,function:void 0};r.$version<7&&(a.function=i.function),"object"===Nn(i.value)&&(a=i.value);let l=[];for(let t=0;t<e.length;t++)l=l.concat(o({array:e,arrayIndex:t,value:e[t],valueSpec:a,style:n,styleSpec:r,key:`${s}[${t}]`}));return l}function sr(t){const e=t.key,i=t.value,n=t.valueSpec;let r=Nn(i);if("number"===r&&i!=i&&(r="NaN"),"number"!==r)return[new ir(e,i,`number expected, ${r} found`)];if("minimum"in n){let r=n.minimum;if("array"===Nn(n.minimum)&&(r=n.minimum[t.arrayIndex]),i<r)return[new ir(e,i,`${i} is less than the minimum value ${r}`)]}if("maximum"in n){let r=n.maximum;if("array"===Nn(n.maximum)&&(r=n.maximum[t.arrayIndex]),i>r)return[new ir(e,i,`${i} is greater than the maximum value ${r}`)]}return[]}function or(t){const e=t.valueSpec,i=ie(t.value.type);let n,r,s,o={};const a="categorical"!==i&&void 0===t.value.property,l=!a,c="array"===Nn(t.value.stops)&&"array"===Nn(t.value.stops[0])&&"object"===Nn(t.value.stops[0][0]),h=nr({key:t.key,value:t.value,valueSpec:t.styleSpec.function,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{stops:function(t){if("identity"===i)return[new ir(t.key,t.value,'identity function may not have a "stops" property')];let e=[];const n=t.value;return e=e.concat(rr({key:t.key,value:n,valueSpec:t.valueSpec,style:t.style,styleSpec:t.styleSpec,arrayElementValidator:u})),"array"===Nn(n)&&0===n.length&&e.push(new ir(t.key,n,"array must have at least one stop")),e},default:function(t){return Fr({key:t.key,value:t.value,valueSpec:e,style:t.style,styleSpec:t.styleSpec})}}});return"identity"===i&&a&&h.push(new ir(t.key,t.value,'missing required property "property"')),"identity"===i||t.value.stops||h.push(new ir(t.key,t.value,'missing required property "stops"')),"exponential"===i&&t.valueSpec.expression&&!zn(t.valueSpec)&&h.push(new ir(t.key,t.value,"exponential functions not supported")),t.styleSpec.$version>=8&&(l&&!kn(t.valueSpec)?h.push(new ir(t.key,t.value,"property functions not supported")):a&&!Fn(t.valueSpec)&&h.push(new ir(t.key,t.value,"zoom functions not supported"))),"categorical"!==i&&!c||void 0!==t.value.property||h.push(new ir(t.key,t.value,'"property" property is required')),h;function u(t){let i=[];const n=t.value,a=t.key;if("array"!==Nn(n))return[new ir(a,n,`array expected, ${Nn(n)} found`)];if(2!==n.length)return[new ir(a,n,`array length 2 expected, length ${n.length} found`)];if(c){if("object"!==Nn(n[0]))return[new ir(a,n,`object expected, ${Nn(n[0])} found`)];if(void 0===n[0].zoom)return[new ir(a,n,"object stop key must have zoom")];if(void 0===n[0].value)return[new ir(a,n,"object stop key must have value")];const e=ie(n[0].zoom);if("number"!=typeof e)return[new ir(a,n[0].zoom,"stop zoom values must be numbers")];if(s&&s>e)return[new ir(a,n[0].zoom,"stop zoom values must appear in ascending order")];e!==s&&(s=e,r=void 0,o={}),i=i.concat(nr({key:`${a}[0]`,value:n[0],valueSpec:{zoom:{}},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{zoom:sr,value:d}}))}else i=i.concat(d({key:`${a}[0]`,value:n[0],valueSpec:{},style:t.style,styleSpec:t.styleSpec},n));return Jn(ne(n[1]))?i.concat([new ir(`${a}[1]`,n[1],"expressions are not allowed in function stops.")]):i.concat(Fr({key:`${a}[1]`,value:n[1],valueSpec:e,style:t.style,styleSpec:t.styleSpec}))}function d(t,s){const a=Nn(t.value),l=ie(t.value),c=null!==t.value?t.value:s;if(n){if(a!==n)return[new ir(t.key,c,`${a} stop domain type must match previous stop domain type ${n}`)]}else n=a;if("number"!==a&&"string"!==a&&"boolean"!==a&&"number"!=typeof l&&"string"!=typeof l&&"boolean"!=typeof l)return[new ir(t.key,c,"stop domain value must be a number, string, or boolean")];if("number"!==a&&"categorical"!==i){let n=`number expected, ${a} found`;return kn(e)&&void 0===i&&(n+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new ir(t.key,c,n)]}return"categorical"!==i||"number"!==a||"number"==typeof l&&isFinite(l)&&Math.floor(l)===l?"categorical"!==i&&"number"===a&&"number"==typeof l&&"number"==typeof r&&void 0!==r&&l<r?[new ir(t.key,c,"stop domain values must appear in ascending order")]:(r=l,"categorical"===i&&l in o?[new ir(t.key,c,"stop domain values must be unique")]:(o[l]=!0,[])):[new ir(t.key,c,`integer expected, found ${String(l)}`)]}}function ar(t){const e=("property"===t.expressionContext?Qn:Yn)(ne(t.value),t.valueSpec);if("error"===e.result)return e.value.map((e=>new ir(`${t.key}${e.key}`,t.value,e.message)));const i=e.value.expression||e.value._styleExpression.expression;if("property"===t.expressionContext&&"text-font"===t.propertyKey&&!i.outputDefined())return[new ir(t.key,t.value,`Invalid data expression for "${t.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===t.expressionContext&&"layout"===t.propertyType&&!bi(i))return[new ir(t.key,t.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===t.expressionContext)return lr(i,t);if(t.expressionContext&&0===t.expressionContext.indexOf("cluster")){if(!wi(i,["zoom","feature-state"]))return[new ir(t.key,t.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===t.expressionContext&&!xi(i))return[new ir(t.key,t.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function lr(t,e){const i=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(e.valueSpec&&e.valueSpec.expression)for(const t of e.valueSpec.expression.parameters)i.delete(t);if(0===i.size)return[];const n=[];return t instanceof ti&&i.has(t.name)?[new ir(e.key,e.value,`["${t.name}"] expression is not supported in a filter for a ${e.object.type} layer with id: ${e.object.id}`)]:(t.eachChild((t=>{n.push(...lr(t,e))})),n)}function cr(t){const e=t.key,i=t.value,n=t.valueSpec,r=[];return Array.isArray(n.values)?-1===n.values.indexOf(ie(i))&&r.push(new ir(e,i,`expected one of [${n.values.join(", ")}], ${JSON.stringify(i)} found`)):-1===Object.keys(n.values).indexOf(ie(i))&&r.push(new ir(e,i,`expected one of [${Object.keys(n.values).join(", ")}], ${JSON.stringify(i)} found`)),r}function hr(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":return t.length>=2&&"$id"!==t[1]&&"$type"!==t[1];case"in":return t.length>=3&&("string"!=typeof t[1]||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==t.length||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!hr(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}}function ur(t,e="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};hr(t)||(t=yr(t));const i=t;let n=!0;try{n=function(t){if(!fr(t))return t;let e=ne(t);return pr(e),e=dr(e),e}(i)}catch(t){}const r=te[`filter_${e}`],s=Yn(n,r);let o=null;if("error"===s.result)throw new Error(s.value.map((t=>`${t.key}: ${t.message}`)).join(", "));o=(t,e,i)=>s.value.evaluate(t,e,{},i);let a=null,l=null;if(n!==i){const t=Yn(i,r);if("error"===t.result)throw new Error(t.value.map((t=>`${t.key}: ${t.message}`)).join(", "));a=(e,i,n,r,s)=>t.value.evaluate(e,i,{},n,void 0,void 0,r,s),l=!xi(t.value.expression)}return{filter:o,dynamicFilter:a||void 0,needGeometry:_r(n),needFeature:!!l}}function dr(t){if(!Array.isArray(t))return t;const e=function(t){if(mr.has(t[0]))for(let e=1;e<t.length;e++)if(fr(t[e]))return!0;return t}(t);return!0===e?e:e.map((t=>dr(t)))}function pr(t){let e=!1;const i=[];if("case"===t[0]){for(let n=1;n<t.length-1;n+=2)e=e||fr(t[n]),i.push(t[n+1]);i.push(t[t.length-1])}else if("match"===t[0]){e=e||fr(t[1]);for(let e=2;e<t.length-1;e+=2)i.push(t[e+1]);i.push(t[t.length-1])}else if("step"===t[0]){e=e||fr(t[1]);for(let e=1;e<t.length-1;e+=2)i.push(t[e+1])}e&&(t.length=0,t.push("any",...i));for(let e=1;e<t.length;e++)pr(t[e])}function fr(t){if(!Array.isArray(t))return!1;if("pitch"===(e=t[0])||"distance-from-center"===e)return!0;var e;for(let e=1;e<t.length;e++)if(fr(t[e]))return!0;return!1}const mr=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function gr(t,e){return t<e?-1:t>e?1:0}function _r(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let e=1;e<t.length;e++)if(_r(t[e]))return!0;return!1}function yr(t){if(!t)return!0;const e=t[0];return t.length<=1?"any"!==e:"=="===e?vr(t[1],t[2],"=="):"!="===e?wr(vr(t[1],t[2],"==")):"<"===e||">"===e||"<="===e||">="===e?vr(t[1],t[2],e):"any"===e?(i=t.slice(1),["any"].concat(i.map(yr))):"all"===e?["all"].concat(t.slice(1).map(yr)):"none"===e?["all"].concat(t.slice(1).map(yr).map(wr)):"in"===e?xr(t[1],t.slice(2)):"!in"===e?wr(xr(t[1],t.slice(2))):"has"===e?br(t[1]):"!has"===e?wr(br(t[1])):"within"!==e||t;var i}function vr(t,e,i){switch(t){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,t,e]}}function xr(t,e){if(0===e.length)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((t=>typeof t!=typeof e[0]))?["filter-in-large",t,["literal",e.sort(gr)]]:["filter-in-small",t,["literal",e]]}}function br(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function wr(t){return["!",t]}function Ar(t){return hr(ne(t.value))?ar(ee({},t,{expressionContext:"filter",valueSpec:t.styleSpec[`filter_${t.layerType||"fill"}`]})):Tr(t)}function Tr(t){const e=t.value,i=t.key;if("array"!==Nn(e))return[new ir(i,e,`array expected, ${Nn(e)} found`)];const n=t.styleSpec;let r,s=[];if(e.length<1)return[new ir(i,e,"filter array must have at least 1 element")];switch(s=s.concat(cr({key:`${i}[0]`,value:e[0],valueSpec:n.filter_operator,style:t.style,styleSpec:t.styleSpec})),ie(e[0])){case"<":case"<=":case">":case">=":e.length>=2&&"$type"===ie(e[1])&&s.push(new ir(i,e,`"$type" cannot be use with operator "${e[0]}"`));case"==":case"!=":3!==e.length&&s.push(new ir(i,e,`filter array for operator "${e[0]}" must have 3 elements`));case"in":case"!in":e.length>=2&&(r=Nn(e[1]),"string"!==r&&s.push(new ir(`${i}[1]`,e[1],`string expected, ${r} found`)));for(let o=2;o<e.length;o++)r=Nn(e[o]),"$type"===ie(e[1])?s=s.concat(cr({key:`${i}[${o}]`,value:e[o],valueSpec:n.geometry_type,style:t.style,styleSpec:t.styleSpec})):"string"!==r&&"number"!==r&&"boolean"!==r&&s.push(new ir(`${i}[${o}]`,e[o],`string, number, or boolean expected, ${r} found`));break;case"any":case"all":case"none":for(let n=1;n<e.length;n++)s=s.concat(Tr({key:`${i}[${n}]`,value:e[n],style:t.style,styleSpec:t.styleSpec}));break;case"has":case"!has":r=Nn(e[1]),2!==e.length?s.push(new ir(i,e,`filter array for "${e[0]}" operator must have 2 elements`)):"string"!==r&&s.push(new ir(`${i}[1]`,e[1],`string expected, ${r} found`));break;case"within":r=Nn(e[1]),2!==e.length?s.push(new ir(i,e,`filter array for "${e[0]}" operator must have 2 elements`)):"object"!==r&&s.push(new ir(`${i}[1]`,e[1],`object expected, ${r} found`))}return s}function Mr(t,e){const i=t.key,n=t.style,r=t.styleSpec,s=t.value,o=t.objectKey,a=r[`${e}_${t.layerType}`];if(!a)return[];const l=o.match(/^(.*)-transition$/);if("paint"===e&&l&&a[l[1]]&&a[l[1]].transition)return Fr({key:i,value:s,valueSpec:r.transition,style:n,styleSpec:r});const c=t.valueSpec||a[o];if(!c)return[new ir(i,s,`unknown property "${o}"`)];let h;if("string"===Nn(s)&&kn(c)&&!c.tokens&&(h=/^{([^}]+)}$/.exec(s))){const t=`\`{ "type": "identity", "property": ${h?JSON.stringify(h[1]):'"_"'} }\``;return[new ir(i,s,`"${o}" does not support interpolation syntax\nUse an identity property function instead: ${t}.`)]}const u=[];return"symbol"===t.layerType&&("text-field"===o&&n&&!n.glyphs&&u.push(new ir(i,s,'use of "text-field" requires a style "glyphs" property')),"text-font"===o&&Un(ne(s))&&"identity"===ie(s.type)&&u.push(new ir(i,s,'"text-font" does not support identity functions'))),u.concat(Fr({key:t.key,value:s,valueSpec:c,style:n,styleSpec:r,expressionContext:"property",propertyType:e,propertyKey:o}))}function Sr(t){return Mr(t,"paint")}function Er(t){return Mr(t,"layout")}function Cr(t){let e=[];const i=t.value,n=t.key,r=t.style,s=t.styleSpec;i.type||i.ref||e.push(new ir(n,i,'either "type" or "ref" is required'));let o=ie(i.type);const a=ie(i.ref);if(i.id){const s=ie(i.id);for(let o=0;o<t.arrayIndex;o++){const t=r.layers[o];ie(t.id)===s&&e.push(new ir(n,i.id,`duplicate layer id "${i.id}", previously used at line ${t.id.__line__}`))}}if("ref"in i){let t;["type","source","source-layer","filter","layout"].forEach((t=>{t in i&&e.push(new ir(n,i[t],`"${t}" is prohibited for ref layers`))})),r.layers.forEach((e=>{ie(e.id)===a&&(t=e)})),t?t.ref?e.push(new ir(n,i.ref,"ref cannot reference another ref layer")):o=ie(t.type):"string"==typeof a&&e.push(new ir(n,i.ref,`ref layer "${a}" not found`))}else if("background"!==o&&"sky"!==o)if(i.source){const t=r.sources&&r.sources[i.source],s=t&&ie(t.type);t?"vector"===s&&"raster"===o?e.push(new ir(n,i.source,`layer "${i.id}" requires a raster source`)):"raster"===s&&"raster"!==o?e.push(new ir(n,i.source,`layer "${i.id}" requires a vector source`)):"vector"!==s||i["source-layer"]?"raster-dem"===s&&"hillshade"!==o?e.push(new ir(n,i.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==o||!i.paint||!i.paint["line-gradient"]&&!i.paint["line-trim-offset"]||"geojson"===s&&t.lineMetrics||e.push(new ir(n,i,`layer "${i.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):e.push(new ir(n,i,`layer "${i.id}" must specify a "source-layer"`)):e.push(new ir(n,i.source,`source "${i.source}" not found`))}else e.push(new ir(n,i,'missing required property "source"'));return e=e.concat(nr({key:n,value:i,valueSpec:s.layer,style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":()=>[],type:()=>Fr({key:`${n}.type`,value:i.type,valueSpec:s.layer.type,style:t.style,styleSpec:t.styleSpec,object:i,objectKey:"type"}),filter:t=>Ar(ee({layerType:o},t)),layout:t=>nr({layer:i,key:t.key,value:t.value,valueSpec:{},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":t=>Er(ee({layerType:o},t))}}),paint:t=>nr({layer:i,key:t.key,value:t.value,valueSpec:{},style:t.style,styleSpec:t.styleSpec,objectElementValidators:{"*":t=>Sr(ee({layerType:o},t))}})}})),e}function Ir(t){const e=t.value,i=t.key,n=Nn(e);return"string"!==n?[new ir(i,e,`string expected, ${n} found`)]:[]}const Pr={promoteId:function({key:t,value:e}){if("string"===Nn(e))return Ir({key:t,value:e});{const i=[];for(const n in e)i.push(...Ir({key:`${t}.${n}`,value:e[n]}));return i}}};function Lr(t){const e=t.value,i=t.key,n=t.styleSpec,r=t.style;if(!e.type)return[new ir(i,e,'"type" is required')];const s=ie(e.type);let o;switch(s){case"vector":case"raster":case"raster-dem":return o=nr({key:i,value:e,valueSpec:n[`source_${s.replace("-","_")}`],style:t.style,styleSpec:n,objectElementValidators:Pr}),o;case"geojson":if(o=nr({key:i,value:e,valueSpec:n.source_geojson,style:r,styleSpec:n,objectElementValidators:Pr}),e.cluster)for(const t in e.clusterProperties){const[n,r]=e.clusterProperties[t],s="string"==typeof n?[n,["accumulated"],["get",t]]:n;o.push(...ar({key:`${i}.${t}.map`,value:r,expressionContext:"cluster-map"})),o.push(...ar({key:`${i}.${t}.reduce`,value:s,expressionContext:"cluster-reduce"}))}return o;case"video":return nr({key:i,value:e,valueSpec:n.source_video,style:r,styleSpec:n});case"image":return nr({key:i,value:e,valueSpec:n.source_image,style:r,styleSpec:n});case"canvas":return[new ir(i,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return cr({key:`${i}.type`,value:e.type,valueSpec:{values:Rr(n)},style:r,styleSpec:n})}}function Rr(t){return t.source.reduce(((e,i)=>{const n=t[i];return"enum"===n.type.type&&(e=e.concat(Object.keys(n.type.values))),e}),[])}function Br(t){const e=t.value,i=t.styleSpec,n=i.light,r=t.style;let s=[];const o=Nn(e);if(void 0===e)return s;if("object"!==o)return s=s.concat([new ir("light",e,`object expected, ${o} found`)]),s;for(const t in e){const o=t.match(/^(.*)-transition$/);s=s.concat(o&&n[o[1]]&&n[o[1]].transition?Fr({key:t,value:e[t],valueSpec:i.transition,style:r,styleSpec:i}):n[t]?Fr({key:t,value:e[t],valueSpec:n[t],style:r,styleSpec:i}):[new ir(t,e[t],`unknown property "${t}"`)])}return s}function Dr(t){const e=t.value,i=t.key,n=t.style,r=t.styleSpec,s=r.terrain;let o=[];const a=Nn(e);if(void 0===e)return o;if("object"!==a)return o=o.concat([new ir("terrain",e,`object expected, ${a} found`)]),o;for(const t in e){const i=t.match(/^(.*)-transition$/);o=o.concat(i&&s[i[1]]&&s[i[1]].transition?Fr({key:t,value:e[t],valueSpec:r.transition,style:n,styleSpec:r}):s[t]?Fr({key:t,value:e[t],valueSpec:s[t],style:n,styleSpec:r}):[new ir(t,e[t],`unknown property "${t}"`)])}if(e.source){const t=n.sources&&n.sources[e.source],r=t&&ie(t.type);t?"raster-dem"!==r&&o.push(new ir(i,e.source,`terrain cannot be used with a source of type ${String(r)}, it only be used with a "raster-dem" source type`)):o.push(new ir(i,e.source,`source "${e.source}" not found`))}else o.push(new ir(i,e,'terrain is missing required property "source"'));return o}function Or(t){const e=t.value,i=t.style,n=t.styleSpec,r=n.fog;let s=[];const o=Nn(e);if(void 0===e)return s;if("object"!==o)return s=s.concat([new ir("fog",e,`object expected, ${o} found`)]),s;for(const t in e){const o=t.match(/^(.*)-transition$/);s=s.concat(o&&r[o[1]]&&r[o[1]].transition?Fr({key:t,value:e[t],valueSpec:n.transition,style:i,styleSpec:n}):r[t]?Fr({key:t,value:e[t],valueSpec:r[t],style:i,styleSpec:n}):[new ir(t,e[t],`unknown property "${t}"`)])}return s}const kr={"*":()=>[],array:rr,boolean:function(t){const e=t.value,i=t.key,n=Nn(e);return"boolean"!==n?[new ir(i,e,`boolean expected, ${n} found`)]:[]},number:sr,color:function(t){const e=t.key,i=t.value,n=Nn(i);return"string"!==n?[new ir(e,i,`color expected, ${n} found`)]:null===Te(i)?[new ir(e,i,`color expected, "${i}" found`)]:[]},enum:cr,filter:Ar,function:or,layer:Cr,object:nr,source:Lr,light:Br,terrain:Dr,fog:Or,string:Ir,formatted:function(t){return 0===Ir(t).length?[]:ar(t)},resolvedImage:function(t){return 0===Ir(t).length?[]:ar(t)},projection:function(t){const e=t.value,i=t.styleSpec,n=i.projection,r=t.style;let s=[];const o=Nn(e);if("object"===o)for(const t in e)s=s.concat(Fr({key:t,value:e[t],valueSpec:n[t],style:r,styleSpec:i}));else"string"!==o&&(s=s.concat([new ir("projection",e,`object or string expected, ${o} found`)]));return s}};function Fr(t){const e=t.value,i=t.valueSpec,n=t.styleSpec;return i.expression&&Un(ie(e))?or(t):i.expression&&Jn(ne(e))?ar(t):i.type&&kr[i.type]?kr[i.type](t):nr(ee({},t,{valueSpec:i.type?n[i.type]:i}))}function zr(t){const e=t.value,i=t.key,n=Ir(t);return n.length||(-1===e.indexOf("{fontstack}")&&n.push(new ir(i,e,'"glyphs" url must include a "{fontstack}" token')),-1===e.indexOf("{range}")&&n.push(new ir(i,e,'"glyphs" url must include a "{range}" token'))),n}function Nr(t,e=te){return Vr(Fr({key:"",value:t,valueSpec:e.$root,styleSpec:e,style:t,objectElementValidators:{glyphs:zr,"*":()=>[]}}))}const Ur=t=>Vr(Sr(t)),Gr=t=>Vr(Er(t));function Vr(t){return t.slice().sort(((t,e)=>t.line&&e.line?t.line-e.line:0))}function jr(t,e){let i=!1;if(e&&e.length)for(const n of e)t.fire(new Kt(new Error(n.message))),i=!0;return i}var Hr=qr,Wr=3;function qr(t,e,i){var n=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var r=new Int32Array(this.arrayBuffer);t=r[0],this.d=(e=r[1])+2*(i=r[2]);for(var s=0;s<this.d*this.d;s++){var o=r[Wr+s],a=r[Wr+s+1];n.push(o===a?null:r.subarray(o,a))}var l=r[Wr+n.length+1];this.keys=r.subarray(r[Wr+n.length],l),this.bboxes=r.subarray(l),this.insert=this._insertReadonly}else{this.d=e+2*i;for(var c=0;c<this.d*this.d;c++)n.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=i,this.scale=e/t,this.uid=0;var h=i/e*t;this.min=-h,this.max=t+h}qr.prototype.insert=function(t,e,i,n,r){this._forEachCell(e,i,n,r,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)},qr.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},qr.prototype._insertCell=function(t,e,i,n,r,s){this.cells[r].push(s)},qr.prototype.query=function(t,e,i,n,r){var s=this.min,o=this.max;if(t<=s&&e<=s&&o<=i&&o<=n&&!r)return Array.prototype.slice.call(this.keys);var a=[];return this._forEachCell(t,e,i,n,this._queryCell,a,{},r),a},qr.prototype._queryCell=function(t,e,i,n,r,s,o,a){var l=this.cells[r];if(null!==l)for(var c=this.keys,h=this.bboxes,u=0;u<l.length;u++){var d=l[u];if(void 0===o[d]){var p=4*d;(a?a(h[p+0],h[p+1],h[p+2],h[p+3]):t<=h[p+2]&&e<=h[p+3]&&i>=h[p+0]&&n>=h[p+1])?(o[d]=!0,s.push(c[d])):o[d]=!1}}},qr.prototype._forEachCell=function(t,e,i,n,r,s,o,a){for(var l=this._convertToCellCoord(t),c=this._convertToCellCoord(e),h=this._convertToCellCoord(i),u=this._convertToCellCoord(n),d=l;d<=h;d++)for(var p=c;p<=u;p++){var f=this.d*p+d;if((!a||a(this._convertFromCellCoord(d),this._convertFromCellCoord(p),this._convertFromCellCoord(d+1),this._convertFromCellCoord(p+1)))&&r.call(this,t,e,i,n,f,s,o,a))return}},qr.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},qr.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},qr.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=Wr+this.cells.length+1+1,i=0,n=0;n<this.cells.length;n++)i+=this.cells[n].length;var r=new Int32Array(e+i+this.keys.length+this.bboxes.length);r[0]=this.extent,r[1]=this.n,r[2]=this.padding;for(var s=e,o=0;o<t.length;o++){var a=t[o];r[Wr+o]=s,r.set(a,s),s+=a.length}return r[Wr+t.length]=s,r.set(this.keys,s),r[Wr+t.length+1]=s+=this.keys.length,r.set(this.bboxes,s),s+=this.bboxes.length,r.buffer};var Xr=d(Hr);const Zr={};function Jr(t,e,i={}){Object.defineProperty(t,"_classRegistryKey",{value:e,writeable:!1}),Zr[e]={klass:t,omit:i.omit||[]}}Jr(Object,"Object"),Xr.serialize=function(t,e){const i=t.toArrayBuffer();return e&&e.push(i),{buffer:i}},Xr.deserialize=function(t){return new Xr(t.buffer)},Object.defineProperty(Xr,"name",{value:"Grid"}),Jr(Xr,"Grid"),Jr(Le,"Color"),Jr(Error,"Error"),Jr(ct,"AJAXError"),Jr(Oe,"ResolvedImage"),Jr(tr,"StylePropertyFunction"),Jr(Zn,"StyleExpression",{omit:["_evaluator"]}),Jr(Kn,"ZoomDependentExpression"),Jr($n,"ZoomConstantExpression"),Jr(ti,"CompoundExpression",{omit:["_evaluate"]});for(const t in Bn)Zr[Bn[t]._classRegistryKey]||Jr(Bn[t],`Expression${t}`);function Yr(t){return t&&"undefined"!=typeof ArrayBuffer&&(t instanceof ArrayBuffer||t.constructor&&"ArrayBuffer"===t.constructor.name)}function $r(t){return e.ImageBitmap&&t instanceof e.ImageBitmap}function Kr(t,i){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(Yr(t)||$r(t))return i&&i.push(t),t;if(ArrayBuffer.isView(t)){const e=t;return i&&i.push(e.buffer),e}if(t instanceof e.ImageData)return i&&i.push(t.data.buffer),t;if(Array.isArray(t)){const e=[];for(const n of t)e.push(Kr(n,i));return e}if("object"==typeof t){const e=t.constructor,n=e._classRegistryKey;if(!n)throw new Error(`can't serialize object of unregistered class ${n}`);const r=e.serialize?e.serialize(t,i):{};if(!e.serialize){for(const e in t)t.hasOwnProperty(e)&&(Zr[n].omit.indexOf(e)>=0||(r[e]=Kr(t[e],i)));t instanceof Error&&(r.message=t.message)}if(r.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==n&&(r.$name=n),r}throw new Error("can't serialize object of type "+typeof t)}function Qr(t){if(null==t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||Yr(t)||$r(t)||ArrayBuffer.isView(t)||t instanceof e.ImageData)return t;if(Array.isArray(t))return t.map(Qr);if("object"==typeof t){const e=t.$name||"Object",{klass:i}=Zr[e];if(!i)throw new Error(`can't deserialize unregistered class ${e}`);if(i.deserialize)return i.deserialize(t);const n=Object.create(i.prototype);for(const e of Object.keys(t))"$name"!==e&&(n[e]=Qr(t[e]));return n}throw new Error("can't deserialize object of type "+typeof t)}const ts={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519};function es(t){for(const e of t)if(rs(e.charCodeAt(0)))return!0;return!1}function is(t){for(const e of t)if(!ns(e.charCodeAt(0)))return!1;return!0}function ns(t){return!(ts.Arabic(t)||ts["Arabic Supplement"](t)||ts["Arabic Extended-A"](t)||ts["Arabic Presentation Forms-A"](t)||ts["Arabic Presentation Forms-B"](t))}function rs(t){return!(746!==t&&747!==t&&(t<4352||!(ts["Bopomofo Extended"](t)||ts.Bopomofo(t)||ts["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||ts["CJK Compatibility Ideographs"](t)||ts["CJK Compatibility"](t)||ts["CJK Radicals Supplement"](t)||ts["CJK Strokes"](t)||!(!ts["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||ts["CJK Unified Ideographs Extension A"](t)||ts["CJK Unified Ideographs"](t)||ts["Enclosed CJK Letters and Months"](t)||ts["Hangul Compatibility Jamo"](t)||ts["Hangul Jamo Extended-A"](t)||ts["Hangul Jamo Extended-B"](t)||ts["Hangul Jamo"](t)||ts["Hangul Syllables"](t)||ts.Hiragana(t)||ts["Ideographic Description Characters"](t)||ts.Kanbun(t)||ts["Kangxi Radicals"](t)||ts["Katakana Phonetic Extensions"](t)||ts.Katakana(t)&&12540!==t||!(!ts["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!ts["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||ts["Unified Canadian Aboriginal Syllabics"](t)||ts["Unified Canadian Aboriginal Syllabics Extended"](t)||ts["Vertical Forms"](t)||ts["Yijing Hexagram Symbols"](t)||ts["Yi Syllables"](t)||ts["Yi Radicals"](t))))}function ss(t){return!(rs(t)||function(t){return!!(ts["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||ts["General Punctuation"](t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||ts["Letterlike Symbols"](t)||ts["Number Forms"](t)||ts["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||ts["Control Pictures"](t)&&9251!==t||ts["Optical Character Recognition"](t)||ts["Enclosed Alphanumerics"](t)||ts["Geometric Shapes"](t)||ts["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||ts["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||ts["CJK Symbols and Punctuation"](t)||ts.Katakana(t)||ts["Private Use Area"](t)||ts["CJK Compatibility Forms"](t)||ts["Small Form Variants"](t)||ts["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function os(t){return t>=1424&&t<=2303||ts["Arabic Presentation Forms-A"](t)||ts["Arabic Presentation Forms-B"](t)}function as(t,e){return!(!e&&os(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||ts.Khmer(t))}function ls(t){for(const e of t)if(os(e.charCodeAt(0)))return!0;return!1}const cs="deferred",hs="loading",us="loaded";let ds=null,ps="unavailable",fs=null;const ms=function(t){t&&"string"==typeof t&&t.indexOf("NetworkError")>-1&&(ps="error"),ds&&ds(t)};function gs(){_s.fire(new $t("pluginStateChange",{pluginStatus:ps,pluginURL:fs}))}const _s=new Qt,ys=function(){return ps},vs=function(){if(ps!==cs||!fs)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ps=hs,gs(),fs&&dt({url:fs},(t=>{t?ms(t):(ps=us,gs())}))},xs={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ps===us||null!=xs.applyArabicShaping,isLoading:()=>ps===hs,setState(t){ps=t.pluginStatus,fs=t.pluginURL},isParsed:()=>null!=xs.applyArabicShaping&&null!=xs.processBidirectionalText&&null!=xs.processStyledBidirectionalText,getPluginURL:()=>fs};class bs{constructor(t,e){this.zoom=t,e?(this.now=e.now,this.fadeDuration=e.fadeDuration,this.transition=e.transition,this.pitch=e.pitch):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0)}isSupportedScript(t){return function(t,e){for(const i of t)if(!as(i.charCodeAt(0),e))return!1;return!0}(t,xs.isLoaded())}}class ws{constructor(t,e){this.property=t,this.value=e,this.expression=function(t,e){if(Un(t))return new tr(t,e);if(Jn(t)){const i=Qn(t,e);if("error"===i.result)throw new Error(i.value.map((t=>`${t.key}: ${t.message}`)).join(", "));return i.value}{let i=t;return"string"==typeof t&&"color"===e.type&&(i=Le.parse(t)),{kind:"constant",evaluate:()=>i}}}(void 0===e?t.specification.default:e,t.specification)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(t,e,i){return this.property.possiblyEvaluate(this,t,e,i)}}class As{constructor(t){this.property=t,this.value=new ws(t,void 0)}transitioned(t,e){return new Ms(this.property,this.value,e,R({},t.transition,this.transition),t.now)}untransitioned(){return new Ms(this.property,this.value,null,{},0)}}class Ts{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitionablePropertyValues)}getValue(t){return V(this._values[t].value.value)}setValue(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new As(this._values[t].property)),this._values[t].value=new ws(this._values[t].property,null===e?void 0:V(e))}getTransition(t){return V(this._values[t].transition)}setTransition(t,e){this._values.hasOwnProperty(t)||(this._values[t]=new As(this._values[t].property)),this._values[t].transition=V(e)||void 0}serialize(){const t={};for(const e of Object.keys(this._values)){const i=this.getValue(e);void 0!==i&&(t[e]=i);const n=this.getTransition(e);void 0!==n&&(t[`${e}-transition`]=n)}return t}transitioned(t,e){const i=new Ss(this._properties);for(const n of Object.keys(this._values))i._values[n]=this._values[n].transitioned(t,e._values[n]);return i}untransitioned(){const t=new Ss(this._properties);for(const e of Object.keys(this._values))t._values[e]=this._values[e].untransitioned();return t}}class Ms{constructor(t,e,i,n,r){const s=n.delay||0,o=n.duration||0;r=r||0,this.property=t,this.value=e,this.begin=r+s,this.end=this.begin+o,t.specification.transition&&(n.delay||n.duration)&&(this.prior=i)}possiblyEvaluate(t,e,i){const n=t.now||0,r=this.value.possiblyEvaluate(t,e,i),s=this.prior;if(s){if(n>this.end)return this.prior=null,r;if(this.value.isDataDriven())return this.prior=null,r;if(n<this.begin)return s.possiblyEvaluate(t,e,i);{const o=(n-this.begin)/(this.end-this.begin);return this.property.interpolate(s.possiblyEvaluate(t,e,i),r,T(o))}}return r}}class Ss{constructor(t){this._properties=t,this._values=Object.create(t.defaultTransitioningPropertyValues)}possiblyEvaluate(t,e,i){const n=new Is(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].possiblyEvaluate(t,e,i);return n}hasTransition(){for(const t of Object.keys(this._values))if(this._values[t].prior)return!0;return!1}}class Es{constructor(t){this._properties=t,this._values=Object.create(t.defaultPropertyValues)}getValue(t){return V(this._values[t].value)}setValue(t,e){this._values[t]=new ws(this._values[t].property,null===e?void 0:V(e))}serialize(){const t={};for(const e of Object.keys(this._values)){const i=this.getValue(e);void 0!==i&&(t[e]=i)}return t}possiblyEvaluate(t,e,i){const n=new Is(this._properties);for(const r of Object.keys(this._values))n._values[r]=this._values[r].possiblyEvaluate(t,e,i);return n}}class Cs{constructor(t,e,i){this.property=t,this.value=e,this.parameters=i}isConstant(){return"constant"===this.value.kind}constantOr(t){return"constant"===this.value.kind?this.value.value:t}evaluate(t,e,i,n){return this.property.evaluate(this.value,this.parameters,t,e,i,n)}}class Is{constructor(t){this._properties=t,this._values=Object.create(t.defaultPossiblyEvaluatedValues)}get(t){return this._values[t]}}class Ps{constructor(t){this.specification=t}possiblyEvaluate(t,e){return t.expression.evaluate(e)}interpolate(t,e,i){const n=Ri[this.specification.type];return n?n(t,e,i):t}}class Ls{constructor(t,e){this.specification=t,this.overrides=e}possiblyEvaluate(t,e,i,n){return new Cs(this,"constant"===t.expression.kind||"camera"===t.expression.kind?{kind:"constant",value:t.expression.evaluate(e,null,{},i,n)}:t.expression,e)}interpolate(t,e,i){if("constant"!==t.value.kind||"constant"!==e.value.kind)return t;if(void 0===t.value.value||void 0===e.value.value)return new Cs(this,{kind:"constant",value:void 0},t.parameters);const n=Ri[this.specification.type];return n?new Cs(this,{kind:"constant",value:n(t.value.value,e.value.value,i)},t.parameters):t}evaluate(t,e,i,n,r,s){return"constant"===t.kind?t.value:t.evaluate(e,i,n,r,s)}}class Rs{constructor(t){this.specification=t}possiblyEvaluate(t,e,i,n){return!!t.expression.evaluate(e,null,{},i,n)}interpolate(){return!1}}class Bs{constructor(t){this.properties=t,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const e=new bs(0,{});for(const i in t){const n=t[i];n.specification.overridable&&this.overridableProperties.push(i);const r=this.defaultPropertyValues[i]=new ws(n,void 0),s=this.defaultTransitionablePropertyValues[i]=new As(n);this.defaultTransitioningPropertyValues[i]=s.untransitioned(),this.defaultPossiblyEvaluatedValues[i]=r.possiblyEvaluate(e)}}}function Ds(t,e){return 256*(t=E(Math.floor(t),0,255))+E(Math.floor(e),0,255)}Jr(Ls,"DataDrivenProperty"),Jr(Ps,"DataConstantProperty"),Jr(Rs,"ColorRampProperty");const Os={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class ks{constructor(t,e){this._structArray=t,this._pos1=e*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Fs{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(t,e){return t._trim(),e&&(t.isTransferred=!0,e.push(t.arrayBuffer)),{length:t.length,arrayBuffer:t.arrayBuffer}}static deserialize(t){const e=Object.create(this.prototype);return e.arrayBuffer=t.arrayBuffer,e.length=t.length,e.capacity=t.arrayBuffer.byteLength/e.bytesPerElement,e._refreshViews(),e}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(t){this.reserve(t),this.length=t}reserve(t){if(t>this.capacity){this.capacity=Math.max(t,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const e=this.uint8;this._refreshViews(),e&&this.uint8.set(e)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function zs(t,e=1){let i=0,n=0;return{members:t.map((t=>{const r=Os[t.type].BYTES_PER_ELEMENT,s=i=Ns(i,Math.max(e,r)),o=t.components||1;return n=Math.max(n,r),i+=r*o,{name:t.name,type:t.type,components:o,offset:s}})),size:Ns(i,Math.max(n,e)),alignment:e}}function Ns(t,e){return Math.ceil(t/e)*e}class Us extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.int16[n+0]=e,this.int16[n+1]=i,t}}Us.prototype.bytesPerElement=4,Jr(Us,"StructArrayLayout2i4");class Gs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.int16[r+0]=e,this.int16[r+1]=i,this.int16[r+2]=n,t}}Gs.prototype.bytesPerElement=6,Jr(Gs,"StructArrayLayout3i6");class Vs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const s=4*t;return this.int16[s+0]=e,this.int16[s+1]=i,this.int16[s+2]=n,this.int16[s+3]=r,t}}Vs.prototype.bytesPerElement=8,Jr(Vs,"StructArrayLayout4i8");class js extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o){const a=this.length;return this.resize(a+1),this.emplace(a,t,e,i,n,r,s,o)}emplace(t,e,i,n,r,s,o,a){const l=6*t,c=12*t,h=3*t;return this.int16[l+0]=e,this.int16[l+1]=i,this.uint8[c+4]=n,this.uint8[c+5]=r,this.uint8[c+6]=s,this.uint8[c+7]=o,this.float32[h+2]=a,t}}js.prototype.bytesPerElement=12,Jr(js,"StructArrayLayout2i4ub1f12");class Hs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const s=4*t;return this.float32[s+0]=e,this.float32[s+1]=i,this.float32[s+2]=n,this.float32[s+3]=r,t}}Hs.prototype.bytesPerElement=16,Jr(Hs,"StructArrayLayout4f16");class Ws extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r)}emplace(t,e,i,n,r,s){const o=6*t,a=3*t;return this.uint16[o+0]=e,this.uint16[o+1]=i,this.uint16[o+2]=n,this.uint16[o+3]=r,this.float32[a+2]=s,t}}Ws.prototype.bytesPerElement=12,Jr(Ws,"StructArrayLayout4ui1f12");class qs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const s=4*t;return this.uint16[s+0]=e,this.uint16[s+1]=i,this.uint16[s+2]=n,this.uint16[s+3]=r,t}}qs.prototype.bytesPerElement=8,Jr(qs,"StructArrayLayout4ui8");class Xs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s){const o=this.length;return this.resize(o+1),this.emplace(o,t,e,i,n,r,s)}emplace(t,e,i,n,r,s,o){const a=6*t;return this.int16[a+0]=e,this.int16[a+1]=i,this.int16[a+2]=n,this.int16[a+3]=r,this.int16[a+4]=s,this.int16[a+5]=o,t}}Xs.prototype.bytesPerElement=12,Jr(Xs,"StructArrayLayout6i12");class Zs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o,a,l,c,h,u){const d=this.length;return this.resize(d+1),this.emplace(d,t,e,i,n,r,s,o,a,l,c,h,u)}emplace(t,e,i,n,r,s,o,a,l,c,h,u,d){const p=12*t;return this.int16[p+0]=e,this.int16[p+1]=i,this.int16[p+2]=n,this.int16[p+3]=r,this.uint16[p+4]=s,this.uint16[p+5]=o,this.uint16[p+6]=a,this.uint16[p+7]=l,this.int16[p+8]=c,this.int16[p+9]=h,this.int16[p+10]=u,this.int16[p+11]=d,t}}Zs.prototype.bytesPerElement=24,Jr(Zs,"StructArrayLayout4i4ui4i24");class Js extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s){const o=this.length;return this.resize(o+1),this.emplace(o,t,e,i,n,r,s)}emplace(t,e,i,n,r,s,o){const a=10*t,l=5*t;return this.int16[a+0]=e,this.int16[a+1]=i,this.int16[a+2]=n,this.float32[l+2]=r,this.float32[l+3]=s,this.float32[l+4]=o,t}}Js.prototype.bytesPerElement=20,Jr(Js,"StructArrayLayout3i3f20");class Ys extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.uint32[1*t+0]=e,t}}Ys.prototype.bytesPerElement=4,Jr(Ys,"StructArrayLayout1ul4");class $s extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o,a,l,c,h,u,d){const p=this.length;return this.resize(p+1),this.emplace(p,t,e,i,n,r,s,o,a,l,c,h,u,d)}emplace(t,e,i,n,r,s,o,a,l,c,h,u,d,p){const f=20*t,m=10*t;return this.int16[f+0]=e,this.int16[f+1]=i,this.int16[f+2]=n,this.int16[f+3]=r,this.int16[f+4]=s,this.float32[m+3]=o,this.float32[m+4]=a,this.float32[m+5]=l,this.float32[m+6]=c,this.int16[f+14]=h,this.uint32[m+8]=u,this.uint16[f+18]=d,this.uint16[f+19]=p,t}}$s.prototype.bytesPerElement=40,Jr($s,"StructArrayLayout5i4f1i1ul2ui40");class Ks extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o){const a=this.length;return this.resize(a+1),this.emplace(a,t,e,i,n,r,s,o)}emplace(t,e,i,n,r,s,o,a){const l=8*t;return this.int16[l+0]=e,this.int16[l+1]=i,this.int16[l+2]=n,this.int16[l+4]=r,this.int16[l+5]=s,this.int16[l+6]=o,this.int16[l+7]=a,t}}Ks.prototype.bytesPerElement=16,Jr(Ks,"StructArrayLayout3i2i2i16");class Qs extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r)}emplace(t,e,i,n,r,s){const o=4*t,a=8*t;return this.float32[o+0]=e,this.float32[o+1]=i,this.float32[o+2]=n,this.int16[a+6]=r,this.int16[a+7]=s,t}}Qs.prototype.bytesPerElement=16,Jr(Qs,"StructArrayLayout2f1f2i16");class to extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const s=12*t,o=3*t;return this.uint8[s+0]=e,this.uint8[s+1]=i,this.float32[o+1]=n,this.float32[o+2]=r,t}}to.prototype.bytesPerElement=12,Jr(to,"StructArrayLayout2ub2f12");class eo extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.float32[r+0]=e,this.float32[r+1]=i,this.float32[r+2]=n,t}}eo.prototype.bytesPerElement=12,Jr(eo,"StructArrayLayout3f12");class io extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i){const n=this.length;return this.resize(n+1),this.emplace(n,t,e,i)}emplace(t,e,i,n){const r=3*t;return this.uint16[r+0]=e,this.uint16[r+1]=i,this.uint16[r+2]=n,t}}io.prototype.bytesPerElement=6,Jr(io,"StructArrayLayout3ui6");class no extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x){const b=this.length;return this.resize(b+1),this.emplace(b,t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x)}emplace(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b){const w=30*t,A=15*t,T=60*t;return this.int16[w+0]=e,this.int16[w+1]=i,this.int16[w+2]=n,this.float32[A+2]=r,this.float32[A+3]=s,this.uint16[w+8]=o,this.uint16[w+9]=a,this.uint32[A+5]=l,this.uint32[A+6]=c,this.uint32[A+7]=h,this.uint16[w+16]=u,this.uint16[w+17]=d,this.uint16[w+18]=p,this.float32[A+10]=f,this.float32[A+11]=m,this.uint8[T+48]=g,this.uint8[T+49]=_,this.uint8[T+50]=y,this.uint32[A+13]=v,this.int16[w+28]=x,this.uint8[T+58]=b,t}}no.prototype.bytesPerElement=60,Jr(no,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class ro extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T,M,S,E,C,I){const P=this.length;return this.resize(P+1),this.emplace(P,t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T,M,S,E,C,I)}emplace(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T,M,S,E,C,I,P){const L=38*t,R=19*t;return this.int16[L+0]=e,this.int16[L+1]=i,this.int16[L+2]=n,this.float32[R+2]=r,this.float32[R+3]=s,this.int16[L+8]=o,this.int16[L+9]=a,this.int16[L+10]=l,this.int16[L+11]=c,this.int16[L+12]=h,this.int16[L+13]=u,this.uint16[L+14]=d,this.uint16[L+15]=p,this.uint16[L+16]=f,this.uint16[L+17]=m,this.uint16[L+18]=g,this.uint16[L+19]=_,this.uint16[L+20]=y,this.uint16[L+21]=v,this.uint16[L+22]=x,this.uint16[L+23]=b,this.uint16[L+24]=w,this.uint16[L+25]=A,this.uint16[L+26]=T,this.uint16[L+27]=M,this.uint16[L+28]=S,this.uint32[R+15]=E,this.float32[R+16]=C,this.float32[R+17]=I,this.float32[R+18]=P,t}}ro.prototype.bytesPerElement=76,Jr(ro,"StructArrayLayout3i2f6i15ui1ul3f76");class so extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.float32[1*t+0]=e,t}}so.prototype.bytesPerElement=4,Jr(so,"StructArrayLayout1f4");class oo extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e,i,n,r){const s=this.length;return this.resize(s+1),this.emplace(s,t,e,i,n,r)}emplace(t,e,i,n,r,s){const o=5*t;return this.float32[o+0]=e,this.float32[o+1]=i,this.float32[o+2]=n,this.float32[o+3]=r,this.float32[o+4]=s,t}}oo.prototype.bytesPerElement=20,Jr(oo,"StructArrayLayout5f20");class ao extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e,i,n){const r=this.length;return this.resize(r+1),this.emplace(r,t,e,i,n)}emplace(t,e,i,n,r){const s=6*t;return this.uint32[3*t+0]=e,this.uint16[s+2]=i,this.uint16[s+3]=n,this.uint16[s+4]=r,t}}ao.prototype.bytesPerElement=12,Jr(ao,"StructArrayLayout1ul3ui12");class lo extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.uint16[n+0]=e,this.uint16[n+1]=i,t}}lo.prototype.bytesPerElement=4,Jr(lo,"StructArrayLayout2ui4");class co extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(t){const e=this.length;return this.resize(e+1),this.emplace(e,t)}emplace(t,e){return this.uint16[1*t+0]=e,t}}co.prototype.bytesPerElement=2,Jr(co,"StructArrayLayout1ui2");class ho extends Fs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(t,e){const i=this.length;return this.resize(i+1),this.emplace(i,t,e)}emplace(t,e,i){const n=2*t;return this.float32[n+0]=e,this.float32[n+1]=i,t}}ho.prototype.bytesPerElement=8,Jr(ho,"StructArrayLayout2f8");class uo extends ks{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}uo.prototype.size=40;class po extends $s{get(t){return new uo(this,t)}}Jr(po,"CollisionBoxArray");class fo extends ks{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(t){this._structArray.uint8[this._pos1+49]=t}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(t){this._structArray.uint8[this._pos1+50]=t}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(t){this._structArray.uint32[this._pos4+13]=t}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(t){this._structArray.uint8[this._pos1+58]=t}}fo.prototype.size=60;class mo extends no{get(t){return new fo(this,t)}}Jr(mo,"PlacedSymbolArray");class go extends ks{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13]}get key(){return this._structArray.uint16[this._pos2+14]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22]}get featureIndex(){return this._structArray.uint16[this._pos2+23]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25]}get numIconVertices(){return this._structArray.uint16[this._pos2+26]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28]}get crossTileID(){return this._structArray.uint32[this._pos4+15]}set crossTileID(t){this._structArray.uint32[this._pos4+15]=t}get textOffset0(){return this._structArray.float32[this._pos4+16]}get textOffset1(){return this._structArray.float32[this._pos4+17]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18]}}go.prototype.size=76;class _o extends ro{get(t){return new go(this,t)}}Jr(_o,"SymbolInstanceArray");class yo extends so{getoffsetX(t){return this.float32[1*t+0]}}Jr(yo,"GlyphOffsetArray");class vo extends Us{getx(t){return this.int16[2*t+0]}gety(t){return this.int16[2*t+1]}}Jr(vo,"SymbolLineVertexArray");class xo extends ks{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}xo.prototype.size=12;class bo extends ao{get(t){return new xo(this,t)}}Jr(bo,"FeatureIndexArray");class wo extends lo{geta_centroid_pos0(t){return this.uint16[2*t+0]}geta_centroid_pos1(t){return this.uint16[2*t+1]}}Jr(wo,"FillExtrusionCentroidArray");const Ao=zs([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),To=zs([{name:"a_dash",components:4,type:"Uint16"}]);var Mo={exports:{}},So={exports:{}};So.exports=function(t,e){var i,n,r,s,o,a,l,c;for(n=t.length-(i=3&t.length),r=e,o=3432918353,a=461845907,c=0;c<n;)l=255&t.charCodeAt(c)|(255&t.charCodeAt(++c))<<8|(255&t.charCodeAt(++c))<<16|(255&t.charCodeAt(++c))<<24,++c,r=27492+(65535&(s=5*(65535&(r=(r^=l=(65535&(l=(l=(65535&l)*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<13|r>>>19))+((5*(r>>>16)&65535)<<16)&4294967295))+((58964+(s>>>16)&65535)<<16);switch(l=0,i){case 3:l^=(255&t.charCodeAt(c+2))<<16;case 2:l^=(255&t.charCodeAt(c+1))<<8;case 1:r^=l=(65535&(l=(l=(65535&(l^=255&t.charCodeAt(c)))*o+(((l>>>16)*o&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295}return r^=t.length,r=2246822507*(65535&(r^=r>>>16))+((2246822507*(r>>>16)&65535)<<16)&4294967295,r=3266489909*(65535&(r^=r>>>13))+((3266489909*(r>>>16)&65535)<<16)&4294967295,(r^=r>>>16)>>>0};var Eo=So.exports,Co={exports:{}};Co.exports=function(t,e){for(var i,n=t.length,r=e^n,s=0;n>=4;)i=1540483477*(65535&(i=255&t.charCodeAt(s)|(255&t.charCodeAt(++s))<<8|(255&t.charCodeAt(++s))<<16|(255&t.charCodeAt(++s))<<24))+((1540483477*(i>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),n-=4,++s;switch(n){case 3:r^=(255&t.charCodeAt(s+2))<<16;case 2:r^=(255&t.charCodeAt(s+1))<<8;case 1:r=1540483477*(65535&(r^=255&t.charCodeAt(s)))+((1540483477*(r>>>16)&65535)<<16)}return r=1540483477*(65535&(r^=r>>>13))+((1540483477*(r>>>16)&65535)<<16),(r^=r>>>15)>>>0};var Io=Eo,Po=Co.exports;Mo.exports=Io,Mo.exports.murmur3=Io,Mo.exports.murmur2=Po;var Lo=d(Mo.exports);class Ro{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(t,e,i,n){this.ids.push(Bo(t)),this.positions.push(e,i,n)}getPositions(t){const e=Bo(t);let i=0,n=this.ids.length-1;for(;i<n;){const t=i+n>>1;this.ids[t]>=e?n=t:i=t+1}const r=[];for(;this.ids[i]===e;)r.push({index:this.positions[3*i],start:this.positions[3*i+1],end:this.positions[3*i+2]}),i++;return r}static serialize(t,e){const i=new Float64Array(t.ids),n=new Uint32Array(t.positions);return Do(i,n,0,i.length-1),e&&e.push(i.buffer,n.buffer),{ids:i,positions:n}}static deserialize(t){const e=new Ro;return e.ids=t.ids,e.positions=t.positions,e.indexed=!0,e}}function Bo(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Lo(String(t))}function Do(t,e,i,n){for(;i<n;){const r=t[i+n>>1];let s=i-1,o=n+1;for(;;){do{s++}while(t[s]<r);do{o--}while(t[o]>r);if(s>=o)break;Oo(t,s,o),Oo(e,3*s,3*o),Oo(e,3*s+1,3*o+1),Oo(e,3*s+2,3*o+2)}o-i<n-o?(Do(t,e,i,o),i=o+1):(Do(t,e,o+1,n),n=o)}}function Oo(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}Jr(Ro,"FeaturePositionMap");class ko{constructor(t){this.gl=t.gl,this.initialized=!1}fetchUniformLocation(t,e){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(t,e),this.initialized=!0),!!this.location}}class Fo extends ko{constructor(t){super(t),this.current=0}set(t,e,i){this.fetchUniformLocation(t,e)&&this.current!==i&&(this.current=i,this.gl.uniform1f(this.location,i))}}class zo extends ko{constructor(t){super(t),this.current=[0,0,0,0]}set(t,e,i){this.fetchUniformLocation(t,e)&&(i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]&&i[3]===this.current[3]||(this.current=i,this.gl.uniform4f(this.location,i[0],i[1],i[2],i[3])))}}class No extends ko{constructor(t){super(t),this.current=Le.transparent}set(t,e,i){this.fetchUniformLocation(t,e)&&(i.r===this.current.r&&i.g===this.current.g&&i.b===this.current.b&&i.a===this.current.a||(this.current=i,this.gl.uniform4f(this.location,i.r,i.g,i.b,i.a)))}}const Uo=new Float32Array(16),Go=new Float32Array(9),Vo=new Float32Array(4);function jo(t){return[Ds(255*t.r,255*t.g),Ds(255*t.b,255*t.a)]}class Ho{constructor(t,e,i){this.value=t,this.uniformNames=e.map((t=>`u_${t}`)),this.type=i}setUniform(t,e,i,n,r){e.set(t,r,n.constantOr(this.value))}getBinding(t,e){return"color"===this.type?new No(t):new Fo(t)}}class Wo{constructor(t,e){this.uniformNames=e.map((t=>`u_${t}`)),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(t){this.pixelRatio=t.pixelRatio||1,this.pattern=t.tl.concat(t.br)}setUniform(t,e,i,n,r){const s="u_pattern"===r||"u_dash"===r?this.pattern:"u_pixel_ratio"===r?this.pixelRatio:null;s&&e.set(t,r,s)}getBinding(t,e){return"u_pattern"===e||"u_dash"===e?new zo(t):new Fo(t)}}class qo{constructor(t,e,i,n){this.expression=t,this.type=i,this.maxValue=0,this.paintVertexAttributes=e.map((t=>({name:`a_${t}`,type:"Float32",components:"color"===i?2:1,offset:0}))),this.paintVertexArray=new n}populatePaintArray(t,e,i,n,r,s){const o=this.paintVertexArray.length,a=this.expression.evaluate(new bs(0),e,{},r,n,s);this.paintVertexArray.resize(t),this._setPaintValue(o,t,a)}updatePaintArray(t,e,i,n,r){const s=this.expression.evaluate({zoom:0},i,n,void 0,r);this._setPaintValue(t,e,s)}_setPaintValue(t,e,i){if("color"===this.type){const n=jo(i);for(let i=t;i<e;i++)this.paintVertexArray.emplace(i,n[0],n[1])}else{for(let n=t;n<e;n++)this.paintVertexArray.emplace(n,i);this.maxValue=Math.max(this.maxValue,Math.abs(i))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Xo{constructor(t,e,i,n,r,s){this.expression=t,this.uniformNames=e.map((t=>`u_${t}_t`)),this.type=i,this.useIntegerZoom=n,this.zoom=r,this.maxValue=0,this.paintVertexAttributes=e.map((t=>({name:`a_${t}`,type:"Float32",components:"color"===i?4:2,offset:0}))),this.paintVertexArray=new s}populatePaintArray(t,e,i,n,r,s){const o=this.expression.evaluate(new bs(this.zoom),e,{},r,n,s),a=this.expression.evaluate(new bs(this.zoom+1),e,{},r,n,s),l=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValue(l,t,o,a)}updatePaintArray(t,e,i,n,r){const s=this.expression.evaluate({zoom:this.zoom},i,n,void 0,r),o=this.expression.evaluate({zoom:this.zoom+1},i,n,void 0,r);this._setPaintValue(t,e,s,o)}_setPaintValue(t,e,i,n){if("color"===this.type){const r=jo(i),s=jo(n);for(let i=t;i<e;i++)this.paintVertexArray.emplace(i,r[0],r[1],s[0],s[1])}else{for(let r=t;r<e;r++)this.paintVertexArray.emplace(r,i,n);this.maxValue=Math.max(this.maxValue,Math.abs(i),Math.abs(n))}}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(t,e,i,n,r){const s=this.useIntegerZoom?Math.floor(i.zoom):i.zoom,o=E(this.expression.interpolationFactor(s,this.zoom,this.zoom+1),0,1);e.set(t,r,o)}getBinding(t,e){return new Fo(t)}}class Zo{constructor(t,e,i,n,r){this.expression=t,this.layerId=r,this.paintVertexAttributes=("array"===i?To:Ao).members;for(let t=0;t<e.length;++t);this.paintVertexArray=new n}populatePaintArray(t,e,i){const n=this.paintVertexArray.length;this.paintVertexArray.resize(t),this._setPaintValues(n,t,e.patterns&&e.patterns[this.layerId],i)}updatePaintArray(t,e,i,n,r,s){this._setPaintValues(t,e,i.patterns&&i.patterns[this.layerId],s)}_setPaintValues(t,e,i,n){if(!n||!i)return;const r=n[i];if(!r)return;const{tl:s,br:o,pixelRatio:a}=r;for(let i=t;i<e;i++)this.paintVertexArray.emplace(i,s[0],s[1],o[0],o[1],a)}upload(t){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=t.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Jo{constructor(t,e,i=(()=>!0)){this.binders={},this._buffers=[];const n=[];for(const r in t.paint._values){if(!i(r))continue;const s=t.paint.get(r);if(!(s instanceof Cs&&kn(s.property.specification)))continue;const o=Ko(r,t.type),a=s.value,l=s.property.specification.type,c=!!s.property.useIntegerZoom,h="line-dasharray"===r||r.endsWith("pattern"),u="line-dasharray"===r&&"constant"!==t.layout.get("line-cap").value.kind;if("constant"!==a.kind||u)if("source"===a.kind||u||h){const e=ea(r,l,"source");this.binders[r]=h?new Zo(a,o,l,e,t.id):new qo(a,o,l,e),n.push(`/a_${r}`)}else{const t=ea(r,l,"composite");this.binders[r]=new Xo(a,o,l,c,e,t),n.push(`/z_${r}`)}else this.binders[r]=h?new Wo(a.value,o):new Ho(a.value,o,l),n.push(`/u_${r}`)}this.cacheKey=n.sort().join("")}getMaxValue(t){const e=this.binders[t];return e instanceof qo||e instanceof Xo?e.maxValue:0}populatePaintArrays(t,e,i,n,r,s){for(const o in this.binders){const a=this.binders[o];(a instanceof qo||a instanceof Xo||a instanceof Zo)&&a.populatePaintArray(t,e,i,n,r,s)}}setConstantPatternPositions(t){for(const e in this.binders){const i=this.binders[e];i instanceof Wo&&i.setConstantPatternPositions(t)}}updatePaintArrays(t,e,i,n,r,s){let o=!1;for(const a in t){const l=e.getPositions(a);for(const e of l){const l=i.feature(e.index);for(const i in this.binders){const c=this.binders[i];if((c instanceof qo||c instanceof Xo||c instanceof Zo)&&!0===c.expression.isStateDependent){const h=n.paint.get(i);c.expression=h.value,c.updatePaintArray(e.start,e.end,l,t[a],r,s),o=!0}}}}return o}defines(){const t=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Ho||i instanceof Wo)&&t.push(...i.uniformNames.map((t=>`#define HAS_UNIFORM_${t}`)))}return t}getBinderAttributes(){const t=[];for(const e in this.binders){const i=this.binders[e];if(i instanceof qo||i instanceof Xo||i instanceof Zo)for(let e=0;e<i.paintVertexAttributes.length;e++)t.push(i.paintVertexAttributes[e].name)}return t}getBinderUniforms(){const t=[];for(const e in this.binders){const i=this.binders[e];if(i instanceof Ho||i instanceof Wo||i instanceof Xo)for(const e of i.uniformNames)t.push(e)}return t}getPaintVertexBuffers(){return this._buffers}getUniforms(t){const e=[];for(const i in this.binders){const n=this.binders[i];if(n instanceof Ho||n instanceof Wo||n instanceof Xo)for(const r of n.uniformNames)e.push({name:r,property:i,binding:n.getBinding(t,r)})}return e}setUniforms(t,e,i,n,r){for(const{name:e,property:s,binding:o}of i)this.binders[s].setUniform(t,o,r,n.get(s),e)}updatePaintBuffers(){this._buffers=[];for(const t in this.binders){const e=this.binders[t];(e instanceof qo||e instanceof Xo||e instanceof Zo)&&e.paintVertexBuffer&&this._buffers.push(e.paintVertexBuffer)}}upload(t){for(const e in this.binders){const i=this.binders[e];(i instanceof qo||i instanceof Xo||i instanceof Zo)&&i.upload(t)}this.updatePaintBuffers()}destroy(){for(const t in this.binders){const e=this.binders[t];(e instanceof qo||e instanceof Xo||e instanceof Zo)&&e.destroy()}}}class Yo{constructor(t,e,i=(()=>!0)){this.programConfigurations={};for(const n of t)this.programConfigurations[n.id]=new Jo(n,e,i);this.needsUpload=!1,this._featureMap=new Ro,this._bufferOffset=0}populatePaintArrays(t,e,i,n,r,s,o){for(const i in this.programConfigurations)this.programConfigurations[i].populatePaintArrays(t,e,n,r,s,o);void 0!==e.id&&this._featureMap.add(e.id,i,this._bufferOffset,t),this._bufferOffset=t,this.needsUpload=!0}updatePaintArrays(t,e,i,n,r){for(const s of i)this.needsUpload=this.programConfigurations[s.id].updatePaintArrays(t,this._featureMap,e,s,n,r)||this.needsUpload}get(t){return this.programConfigurations[t]}upload(t){if(this.needsUpload){for(const e in this.programConfigurations)this.programConfigurations[e].upload(t);this.needsUpload=!1}}destroy(){for(const t in this.programConfigurations)this.programConfigurations[t].destroy()}}const $o={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function Ko(t,e){return $o[t]||[t.replace(`${e}-`,"").replace(/-/g,"_")]}const Qo={"line-pattern":{source:Ws,composite:Ws},"fill-pattern":{source:Ws,composite:Ws},"fill-extrusion-pattern":{source:Ws,composite:Ws},"line-dasharray":{source:qs,composite:qs}},ta={color:{source:ho,composite:Hs},number:{source:so,composite:ho}};function ea(t,e,i){const n=Qo[t];return n&&n[i]||ta[e][i]}Jr(Ho,"ConstantBinder"),Jr(Wo,"PatternConstantBinder"),Jr(qo,"SourceExpressionBinder"),Jr(Zo,"PatternCompositeBinder"),Jr(Xo,"CompositeExpressionBinder"),Jr(Jo,"ProgramConfiguration",{omit:["_buffers"]}),Jr(Yo,"ProgramConfigurationSet");const ia="-transition";class na extends Qt{constructor(t,e){if(super(),this.id=t.id,this.type=t.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,"custom"!==t.type&&(this.metadata=t.metadata,this.minzoom=t.minzoom,this.maxzoom=t.maxzoom,"background"!==t.type&&"sky"!==t.type&&(this.source=t.source,this.sourceLayer=t["source-layer"],this.filter=t.filter),e.layout&&(this._unevaluatedLayout=new Es(e.layout)),e.paint)){this._transitionablePaint=new Ts(e.paint);for(const e in t.paint)this.setPaintProperty(e,t.paint[e],{validate:!1});for(const e in t.layout)this.setLayoutProperty(e,t.layout[e],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Is(e.paint)}}getLayoutProperty(t){return"visibility"===t?this.visibility:this._unevaluatedLayout.getValue(t)}setLayoutProperty(t,e,i={}){null!=e&&this._validate(Gr,`layers.${this.id}.layout.${t}`,t,e,i)||("visibility"!==t?this._unevaluatedLayout.setValue(t,e):this.visibility=e)}getPaintProperty(t){return N(t,ia)?this._transitionablePaint.getTransition(t.slice(0,-11)):this._transitionablePaint.getValue(t)}setPaintProperty(t,e,i={}){if(null!=e&&this._validate(Ur,`layers.${this.id}.paint.${t}`,t,e,i))return!1;if(N(t,ia))return this._transitionablePaint.setTransition(t.slice(0,-11),e||void 0),!1;{const i=this._transitionablePaint._values[t],n=i.value.isDataDriven(),r=i.value;this._transitionablePaint.setValue(t,e),this._handleSpecialPaintPropertyUpdate(t);const s=this._transitionablePaint._values[t].value,o=s.isDataDriven(),a=N(t,"pattern")||"line-dasharray"===t;return o||n||a||this._handleOverridablePaintPropertyUpdate(t,r,s)}}_handleSpecialPaintPropertyUpdate(t){}getProgramIds(){return null}getProgramConfiguration(t){return null}_handleOverridablePaintPropertyUpdate(t,e,i){return!1}isHidden(t){return!!(this.minzoom&&t<this.minzoom)||!!(this.maxzoom&&t>=this.maxzoom)||"none"===this.visibility}updateTransitions(t){this._transitioningPaint=this._transitionablePaint.transitioned(t,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(t,e){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(t,void 0,e)),this.paint=this._transitioningPaint.possiblyEvaluate(t,void 0,e)}serialize(){const t={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(t.layout=t.layout||{},t.layout.visibility=this.visibility),G(t,((t,e)=>!(void 0===t||"layout"===e&&!Object.keys(t).length||"paint"===e&&!Object.keys(t).length)))}_validate(t,e,i,n,r={}){return(!r||!1!==r.validate)&&jr(this,t.call(Nr,{key:e,layerType:this.type,objectKey:i,value:n,styleSpec:te,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const t in this.paint._values){const e=this.paint.get(t);if(e instanceof Cs&&kn(e.property.specification)&&("source"===e.value.kind||"composite"===e.value.kind)&&e.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=ur(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}}const ra=zs([{name:"a_pos",components:2,type:"Int16"}],4),sa=zs([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class oa{constructor(t=[]){this.segments=t}prepareSegment(t,e,i,n){let r=this.segments[this.segments.length-1];return t>oa.MAX_VERTEX_ARRAY_LENGTH&&H(`Max vertices per segment is ${oa.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${t}`),(!r||r.vertexLength+t>oa.MAX_VERTEX_ARRAY_LENGTH||r.sortKey!==n)&&(r={vertexOffset:e.length,primitiveOffset:i.length,vertexLength:0,primitiveLength:0},void 0!==n&&(r.sortKey=n),this.segments.push(r)),r}get(){return this.segments}destroy(){for(const t of this.segments)for(const e in t.vaos)t.vaos[e].destroy()}static simpleSegment(t,e,i,n){return new oa([{vertexOffset:t,primitiveOffset:e,vertexLength:i,primitiveLength:n,vaos:{},sortKey:0}])}}oa.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Jr(oa,"SegmentVector");var aa=8192;class la{constructor(t,e){t&&(e?this.setSouthWest(t).setNorthEast(e):4===t.length?this.setSouthWest([t[0],t[1]]).setNorthEast([t[2],t[3]]):this.setSouthWest(t[0]).setNorthEast(t[1]))}setNorthEast(t){return this._ne=t instanceof Vl?new Vl(t.lng,t.lat):Vl.convert(t),this}setSouthWest(t){return this._sw=t instanceof Vl?new Vl(t.lng,t.lat):Vl.convert(t),this}extend(t){const e=this._sw,i=this._ne;let n,r;if(t instanceof Vl)n=t,r=t;else{if(!(t instanceof la))return Array.isArray(t)?4===t.length||t.every(Array.isArray)?this.extend(la.convert(t)):this.extend(Vl.convert(t)):"object"==typeof t&&null!==t&&t.hasOwnProperty("lat")&&(t.hasOwnProperty("lon")||t.hasOwnProperty("lng"))?this.extend(Vl.convert(t)):this;if(n=t._sw,r=t._ne,!n||!r)return this}return e||i?(e.lng=Math.min(n.lng,e.lng),e.lat=Math.min(n.lat,e.lat),i.lng=Math.max(r.lng,i.lng),i.lat=Math.max(r.lat,i.lat)):(this._sw=new Vl(n.lng,n.lat),this._ne=new Vl(r.lng,r.lat)),this}getCenter(){return new Vl((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Vl(this.getWest(),this.getNorth())}getSouthEast(){return new Vl(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(t){const{lng:e,lat:i}=Vl.convert(t);let n=this._sw.lng<=e&&e<=this._ne.lng;return this._sw.lng>this._ne.lng&&(n=this._sw.lng>=e&&e>=this._ne.lng),this._sw.lat<=i&&i<=this._ne.lat&&n}static convert(t){return!t||t instanceof la?t:new la(t)}}var ca=1e-6,ha="undefined"!=typeof Float32Array?Float32Array:Array;function ua(){var t=new ha(9);return ha!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function da(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=i[0],p=i[1],f=i[2],m=i[3],g=i[4],_=i[5],y=i[6],v=i[7],x=i[8];return t[0]=d*n+p*o+f*c,t[1]=d*r+p*a+f*h,t[2]=d*s+p*l+f*u,t[3]=m*n+g*o+_*c,t[4]=m*r+g*a+_*h,t[5]=m*s+g*l+_*u,t[6]=y*n+v*o+x*c,t[7]=y*r+v*a+x*h,t[8]=y*s+v*l+x*u,t}function pa(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function fa(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],_=e[15],y=i*a-n*o,v=i*l-r*o,x=i*c-s*o,b=n*l-r*a,w=n*c-s*a,A=r*c-s*l,T=h*m-u*f,M=h*g-d*f,S=h*_-p*f,E=u*g-d*m,C=u*_-p*m,I=d*_-p*g,P=y*I-v*C+x*E+b*S-w*M+A*T;return P?(t[0]=(a*I-l*C+c*E)*(P=1/P),t[1]=(r*C-n*I-s*E)*P,t[2]=(m*A-g*w+_*b)*P,t[3]=(d*w-u*A-p*b)*P,t[4]=(l*S-o*I-c*M)*P,t[5]=(i*I-r*S+s*M)*P,t[6]=(g*x-f*A-_*v)*P,t[7]=(h*A-d*x+p*v)*P,t[8]=(o*C-a*S+c*T)*P,t[9]=(n*S-i*C-s*T)*P,t[10]=(f*w-m*x+_*y)*P,t[11]=(u*x-h*w-p*y)*P,t[12]=(a*M-o*E-l*T)*P,t[13]=(i*E-n*M+r*T)*P,t[14]=(m*v-f*b-g*y)*P,t[15]=(h*b-u*v+d*y)*P,t):null}function ma(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],m=e[12],g=e[13],_=e[14],y=e[15],v=i[0],x=i[1],b=i[2],w=i[3];return t[0]=v*n+x*a+b*u+w*m,t[1]=v*r+x*l+b*d+w*g,t[2]=v*s+x*c+b*p+w*_,t[3]=v*o+x*h+b*f+w*y,t[4]=(v=i[4])*n+(x=i[5])*a+(b=i[6])*u+(w=i[7])*m,t[5]=v*r+x*l+b*d+w*g,t[6]=v*s+x*c+b*p+w*_,t[7]=v*o+x*h+b*f+w*y,t[8]=(v=i[8])*n+(x=i[9])*a+(b=i[10])*u+(w=i[11])*m,t[9]=v*r+x*l+b*d+w*g,t[10]=v*s+x*c+b*p+w*_,t[11]=v*o+x*h+b*f+w*y,t[12]=(v=i[12])*n+(x=i[13])*a+(b=i[14])*u+(w=i[15])*m,t[13]=v*r+x*l+b*d+w*g,t[14]=v*s+x*c+b*p+w*_,t[15]=v*o+x*h+b*f+w*y,t}function ga(t,e,i){var n,r,s,o,a,l,c,h,u,d,p,f,m=i[0],g=i[1],_=i[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*_+e[12],t[13]=e[1]*m+e[5]*g+e[9]*_+e[13],t[14]=e[2]*m+e[6]*g+e[10]*_+e[14],t[15]=e[3]*m+e[7]*g+e[11]*_+e[15]):(r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],t[0]=n=e[0],t[1]=r,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=c,t[7]=h,t[8]=u,t[9]=d,t[10]=p,t[11]=f,t[12]=n*m+a*g+u*_+e[12],t[13]=r*m+l*g+d*_+e[13],t[14]=s*m+c*g+p*_+e[14],t[15]=o*m+h*g+f*_+e[15]),t}function _a(t,e,i){var n=i[0],r=i[1],s=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ya(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*r+c*n,t[5]=o*r+h*n,t[6]=a*r+u*n,t[7]=l*r+d*n,t[8]=c*r-s*n,t[9]=h*r-o*n,t[10]=u*r-a*n,t[11]=d*r-l*n,t}function va(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],u=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r-c*n,t[1]=o*r-h*n,t[2]=a*r-u*n,t[3]=l*r-d*n,t[8]=s*n+c*r,t[9]=o*n+h*r,t[10]=a*n+u*r,t[11]=l*n+d*r,t}function xa(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ba(t,e,i){var n,r,s,o=i[0],a=i[1],l=i[2],c=Math.hypot(o,a,l);return c<ca?null:(o*=c=1/c,a*=c,l*=c,n=Math.sin(e),r=Math.cos(e),t[0]=o*o*(s=1-r)+r,t[1]=a*o*s+l*n,t[2]=l*o*s-a*n,t[3]=0,t[4]=o*a*s-l*n,t[5]=a*a*s+r,t[6]=l*a*s+o*n,t[7]=0,t[8]=o*l*s+a*n,t[9]=a*l*s-o*n,t[10]=l*l*s+r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var wa=ma;function Aa(){var t=new ha(3);return ha!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ta(t){var e=new ha(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Ma(t){return Math.hypot(t[0],t[1],t[2])}function Sa(t,e,i){var n=new ha(3);return n[0]=t,n[1]=e,n[2]=i,n}function Ea(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function Ca(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Ia(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function Pa(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t}function La(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t}function Ra(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function Ba(t,e,i,n){return t[0]=e[0]+i[0]*n,t[1]=e[1]+i[1]*n,t[2]=e[2]+i[2]*n,t}function Da(t,e){var i=e[0],n=e[1],r=e[2],s=i*i+n*n+r*r;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function Oa(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ka(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[0],a=i[1],l=i[2];return t[0]=r*l-s*a,t[1]=s*o-n*l,t[2]=n*a-r*o,t}function Fa(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[3]*n+i[7]*r+i[11]*s+i[15];return t[0]=(i[0]*n+i[4]*r+i[8]*s+i[12])/(o=o||1),t[1]=(i[1]*n+i[5]*r+i[9]*s+i[13])/o,t[2]=(i[2]*n+i[6]*r+i[10]*s+i[14])/o,t}function za(t,e,i){var n=i[0],r=i[1],s=i[2],o=e[0],a=e[1],l=e[2],c=r*l-s*a,h=s*o-n*l,u=n*a-r*o,d=r*u-s*h,p=s*c-n*u,f=n*h-r*c,m=2*i[3];return h*=m,u*=m,p*=2,f*=2,t[0]=o+(c*=m)+(d*=2),t[1]=a+h+p,t[2]=l+u+f,t}var Na,Ua=Ca,Ga=Ia,Va=Ma;function ja(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function Ha(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i*i+n*n+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),t[0]=i*o,t[1]=n*o,t[2]=r*o,t[3]=s*o,t}function Wa(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3];return t[0]=i[0]*n+i[4]*r+i[8]*s+i[12]*o,t[1]=i[1]*n+i[5]*r+i[9]*s+i[13]*o,t[2]=i[2]*n+i[6]*r+i[10]*s+i[14]*o,t[3]=i[3]*n+i[7]*r+i[11]*s+i[15]*o,t}function qa(){var t=new ha(4);return ha!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Xa(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Za(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=n*l+o*a,t[1]=r*l+s*a,t[2]=s*l-r*a,t[3]=o*l-n*a,t}function Ja(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=n*l-s*a,t[1]=r*l+o*a,t[2]=s*l+n*a,t[3]=o*l-r*a,t}Aa(),Na=new ha(4),ha!=Float32Array&&(Na[0]=0,Na[1]=0,Na[2]=0,Na[3]=0);var Ya=Ha;Aa(),Sa(1,0,0),Sa(0,1,0),qa(),qa(),ua();const $a=zs([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Ka}=$a,Qa=zs([{name:"a_pos_3",components:3,type:"Int16"}]);var tl=zs([{name:"a_pos",type:"Int16",components:2}]);class el{constructor(t,e){this.pos=t,this.dir=e}intersectsPlane(t,e,i){const n=Oa(e,this.dir);if(Math.abs(n)<1e-6)return!1;const r=((t[0]-this.pos[0])*e[0]+(t[1]-this.pos[1])*e[1]+(t[2]-this.pos[2])*e[2])/n;return i[0]=this.pos[0]+this.dir[0]*r,i[1]=this.pos[1]+this.dir[1]*r,i[2]=this.pos[2]+this.dir[2]*r,!0}closestPointOnSphere(t,e,i){if(function(t,e){var i=t[0],n=t[1],r=t[2],s=e[0],o=e[1],a=e[2];return Math.abs(i-s)<=ca*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=ca*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-a)<=ca*Math.max(1,Math.abs(r),Math.abs(a))}(this.pos,t)||0===e)return i[0]=i[1]=i[2]=0,!1;const[n,r,s]=this.dir,o=this.pos[0]-t[0],a=this.pos[1]-t[1],l=this.pos[2]-t[2],c=n*n+r*r+s*s,h=2*(o*n+a*r+l*s),u=h*h-4*c*(o*o+a*a+l*l-e*e);if(u<0){const t=Math.max(-h/2,0),c=o+n*t,u=a+r*t,d=l+s*t,p=Math.hypot(c,u,d);return i[0]=c*e/p,i[1]=u*e/p,i[2]=d*e/p,!1}{const t=(-h-Math.sqrt(u))/(2*c);if(t<0){const t=Math.hypot(o,a,l);return i[0]=o*e/t,i[1]=a*e/t,i[2]=l*e/t,!1}return i[0]=o+n*t,i[1]=a+r*t,i[2]=l+s*t,!0}}}class il{constructor(t,e,i,n,r){this.TL=t,this.TR=e,this.BR=i,this.BL=n,this.horizon=r}static fromInvProjectionMatrix(t,e,i){const n=[-1,1,1],r=[1,1,1],s=[1,-1,1],o=[-1,-1,1],a=Fa(n,n,t),l=Fa(r,r,t),c=Fa(s,s,t),h=Fa(o,o,t);return new il(a,l,c,h,e/i)}}class nl{constructor(t,e){this.points=t,this.planes=e}static fromInvProjectionMatrix(t,e,i,n){const r=Math.pow(2,i),s=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((i=>{const s=Wa([],i,t),o=1/s[3]/e*r;return function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}(s,s,[o,o,n?1/s[3]:o,o])})),o=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((t=>{const e=Da([],ka([],Ua([],s[t[0]],s[t[1]]),Ua([],s[t[2]],s[t[1]]))),i=-Oa(e,s[t[1]]);return e.concat(i)}));return new nl(s,o)}}class rl{static fromPoints(t){const e=[1/0,1/0,1/0],i=[-1/0,-1/0,-1/0];for(const n of t)Pa(e,e,n),La(i,i,n);return new rl(e,i)}static applyTransform(t,e){const i=t.getCorners();for(let t=0;t<i.length;++t)Fa(i[t],i[t],e);return rl.fromPoints(i)}constructor(t,e){this.min=t,this.max=e,this.center=Ra([],Ea([],this.min,this.max),.5)}quadrant(t){const e=[t%2==0,t<2],i=Ta(this.min),n=Ta(this.max);for(let t=0;t<e.length;t++)i[t]=e[t]?this.min[t]:this.center[t],n[t]=e[t]?this.center[t]:this.max[t];return n[2]=this.max[2],new rl(i,n)}distanceX(t){return Math.max(Math.min(this.max[0],t[0]),this.min[0])-t[0]}distanceY(t){return Math.max(Math.min(this.max[1],t[1]),this.min[1])-t[1]}distanceZ(t){return Math.max(Math.min(this.max[2],t[2]),this.min[2])-t[2]}getCorners(){const t=this.min,e=this.max;return[[t[0],t[1],t[2]],[e[0],t[1],t[2]],[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]],[e[0],e[1],e[2]],[t[0],e[1],e[2]]]}intersects(t){const e=this.getCorners();let i=!0;for(let n=0;n<t.planes.length;n++){const r=t.planes[n];let s=0;for(let t=0;t<e.length;t++)s+=Oa(r,e[t])+r[3]>=0;if(0===s)return 0;s!==e.length&&(i=!1)}if(i)return 2;for(let e=0;e<3;e++){let i=Number.MAX_VALUE,n=-Number.MAX_VALUE;for(let r=0;r<t.points.length;r++){const s=t.points[r][e]-this.min[e];i=Math.min(i,s),n=Math.max(n,s)}if(n<0||i>this.max[e]-this.min[e])return 0}return 1}}const sl=5,ol=6,al=aa/Math.PI/2,ll=16383,cl=64,hl=[cl,32,16],ul=-al,dl=al,pl=[new rl([ul,ul,ul],[dl,dl,dl]),new rl([ul,ul,ul],[0,0,dl]),new rl([0,ul,ul],[dl,0,dl]),new rl([ul,0,ul],[0,dl,dl]),new rl([0,0,ul],[dl,dl,dl])];function fl(t){return t*al/Nl}function ml(t,e,i,n=!0){const r=Ra([],t._camera.position,t.worldSize),s=[e,i,1,1];Wa(s,s,t.pixelMatrixInverse),ja(s,s,1/s[3]);const o=Da([],Ua([],s,r)),a=t.globeMatrix,l=[a[12],a[13],a[14]],c=Ua([],l,r),h=Ma(c),u=Da([],c),d=t.worldSize/(2*Math.PI),p=Oa(u,o),f=Math.asin(d/h);if(f<Math.acos(p)){if(!n)return null;const t=[],e=[];Ra(t,o,h/p),Da(e,Ua(e,t,c)),Da(o,Ea(o,c,Ra(o,e,Math.tan(f)*h)))}const m=[];new el(r,o).closestPointOnSphere(l,d,m);const g=Da([],K(a,0)),_=Da([],K(a,1)),y=Da([],K(a,2)),v=Oa(g,m),x=Oa(_,m),b=Oa(y,m),A=w(Math.asin(-x/d));let T=w(Math.atan2(v,b));T=t.center.lng+function(t,e){const i=(e-t+180)%360-180;return i<-180?i+360:i}(t.center.lng,T);const M=Hl(T),S=E(Wl(A),0,1);return new Kl(M,S)}class gl{constructor(t,e,i){this.a=Ua([],t,i),this.b=Ua([],e,i),this.center=i;const n=Da([],this.a),r=Da([],this.b);this.angle=Math.acos(Oa(n,r))}}function _l(t,e){if(0===t.angle)return null;let i;return i=0===t.a[e]?1/t.angle*.5*Math.PI:1/t.angle*Math.atan(t.b[e]/t.a[e]/Math.sin(t.angle)-1/Math.tan(t.angle)),i<0||i>1?null:function(t,e,i,n){const r=Math.sin(i);return t*(Math.sin((1-n)*i)/r)+e*(Math.sin(n*i)/r)}(t.a[e],t.b[e],t.angle,E(i,0,1))+t.center[e]}function yl(t){if(t.z<=1)return pl[t.z+2*t.y+t.x];const e=Tl(Al(t));return rl.fromPoints(e)}function vl(t,e,i){return Ra(t,t,1-i),Ba(t,t,e,i)}function xl(t,e){const i=Bl(e.zoom);if(0===i)return yl(t);const n=Al(t),r=Tl(n),s=Hl(n.getWest())*e.worldSize,o=Hl(n.getEast())*e.worldSize,a=Wl(n.getNorth())*e.worldSize,l=Wl(n.getSouth())*e.worldSize,c=[s,a,0],h=[o,a,0],u=[s,l,0],d=[o,l,0],p=fa([],e.globeMatrix);return Fa(c,c,p),Fa(h,h,p),Fa(u,u,p),Fa(d,d,p),r[0]=vl(r[0],u,i),r[1]=vl(r[1],d,i),r[2]=vl(r[2],h,i),r[3]=vl(r[3],c,i),rl.fromPoints(r)}function bl(t,e,i){for(const n of t)Fa(n,n,e),Ra(n,n,i)}function wl(t,e,i){const n=e/t.worldSize,r=t.globeMatrix;if(i.z<=1){const t=yl(i).getCorners();return bl(t,r,n),rl.fromPoints(t)}const s=Al(i),o=Tl(s);bl(o,r,n);const a=Number.MAX_VALUE,l=[-a,-a,-a],c=[a,a,a];if(s.contains(t.center)){for(const t of o)Pa(c,c,t),La(l,l,t);l[2]=0;const e=t.point,i=[e.x*n,e.y*n,0];return Pa(c,c,i),La(l,l,i),new rl(c,l)}const h=[r[12]*n,r[13]*n,r[14]*n],u=s.getCenter(),d=E(t.center.lat,-Yl,Yl),p=E(u.lat,-Yl,Yl),f=Hl(t.center.lng),m=Wl(d);let g=f-Hl(u.lng);const _=m-Wl(p);g>.5?g-=1:g<-.5&&(g+=1);let y=0;Math.abs(g)>Math.abs(_)?y=g>=0?1:3:(y=_>=0?0:2,Ba(h,h,[r[4]*n,r[5]*n,r[6]*n],-Math.sin(b(_>=0?s.getSouth():s.getNorth()))*al));const v=o[y],x=o[(y+1)%4],w=new gl(v,x,h),A=[_l(w,0)||v[0],_l(w,1)||v[1],_l(w,2)||v[2]],T=Bl(t.zoom);if(T>0){const n=function({x:t,y:e,z:i},n,r,s,o){const a=1/(1<<i);let l=t*a,c=l+a,h=e*a,u=h+a,d=0;const p=(l+c)/2-s;return p>.5?d=-1:p<-.5&&(d=1),l=((l+d)*n-(s*=n))*r+s,c=((c+d)*n-s)*r+s,h=(h*n-(o*=n))*r+o,u=(u*n-o)*r+o,[[l,u,0],[c,u,0],[c,h,0],[l,h,0]]}(i,e,t._pixelsPerMercatorPixel,f,m);for(let t=0;t<o.length;t++)vl(o[t],n[t],T);const r=Ea([],n[y],n[(y+1)%4]);Ra(r,r,.5),vl(A,r,T)}for(const t of o)Pa(c,c,t),La(l,l,t);return c[2]=Math.min(v[2],x[2]),Pa(c,c,A),La(l,l,A),new rl(c,l)}function Al({x:t,y:e,z:i}){const n=1/(1<<i),r=new Vl(Xl(t*n),Zl((e+1)*n)),s=new Vl(Xl((t+1)*n),Zl(e*n));return new la(r,s)}function Tl(t){const e=b(t.getNorth()),i=b(t.getSouth()),n=Math.cos(e),r=Math.cos(i),s=Math.sin(e),o=Math.sin(i),a=t.getWest(),l=t.getEast();return[Ml(r,o,a),Ml(r,o,l),Ml(n,s,l),Ml(n,s,a)]}function Ml(t,e,i,n=al){return i=b(i),[t*Math.sin(i)*n,-e*n,t*Math.cos(i)*n]}function Sl(t,e,i){return Ml(Math.cos(b(t)),Math.sin(b(t)),e,i)}function El(t,e,i,n){const r=1<<i.z,s=(t/aa+i.x)/r;return Sl(Zl((e/aa+i.y)/r),Xl(s),n)}function Cl({min:t,max:e}){return ll/Math.max(e[0]-t[0],e[1]-t[1],e[2]-t[2])}const Il=new Float64Array(16);function Pl(t){const e=Cl(t),i=xa(Il,[e,e,e]);return ga(i,i,((n=[])[0]=-(r=t.min)[0],n[1]=-r[1],n[2]=-r[2],n));var n,r}function Ll(t){const e=(n=t.min,(i=Il)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=n[0],i[13]=n[1],i[14]=n[2],i[15]=1,i);var i,n;const r=1/Cl(t);return _a(e,e,[r,r,r])}function Rl(t,e,i,n,r){const s=function(t){const e=aa/(2*Math.PI);return t/(2*Math.PI)/e}(i),o=[t,e,-i/(2*Math.PI)],a=pa(new Float64Array(16));return ga(a,a,o),_a(a,a,[s,s,s]),ya(a,a,b(-r)),va(a,a,b(-n)),a}function Bl(t){return C(sl,ol,t)}function Dl(t,e){const i=Sl(e.lat,e.lng),n=function(t){const e=Sl(t._center.lat,t._center.lng);let i=ka([],Sa(0,1,0),e);const n=ba([],-t.angle,e);i=Fa(i,i,n),ba(n,-t._pitch,i);const r=Da([],e);return Ra(r,r,fl(t.cameraToCenterDistance/t.pixelsPerMeter)),Fa(r,r,n),Ea([],e,r)}(t);return o=(r=Ca([],n,i))[0],a=r[1],l=r[2],c=(s=i)[0],h=s[1],u=s[2],p=(d=Math.sqrt(o*o+a*a+l*l)*Math.sqrt(c*c+h*h+u*u))&&Oa(r,s)/d,Math.acos(Math.min(Math.max(p,-1),1));var r,s,o,a,l,c,h,u,d,p}function Ol(t,e){return Dl(t,e)>Math.PI/2*1.01}const kl=b(85),Fl=Math.cos(kl),zl=Math.sin(kl),Nl=6371008.8,Ul=2*Math.PI*Nl;class Gl{constructor(t,e){if(isNaN(t)||isNaN(e))throw new Error(`Invalid LngLat object: (${t}, ${e})`);if(this.lng=+t,this.lat=+e,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Gl(I(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(t){const e=Math.PI/180,i=this.lat*e,n=t.lat*e,r=Math.sin(i)*Math.sin(n)+Math.cos(i)*Math.cos(n)*Math.cos((t.lng-this.lng)*e);return Nl*Math.acos(Math.min(r,1))}toBounds(t=0){const e=360*t/40075017,i=e/Math.cos(Math.PI/180*this.lat);return new la(new Gl(this.lng-i,this.lat-e),new Gl(this.lng+i,this.lat+e))}toEcef(t){const e=fl(t);return Sl(this.lat,this.lng,al+e)}static convert(t){if(t instanceof Gl)return t;if(Array.isArray(t)&&(2===t.length||3===t.length))return new Gl(Number(t[0]),Number(t[1]));if(!Array.isArray(t)&&"object"==typeof t&&null!==t)return new Gl(Number("lng"in t?t.lng:t.lon),Number(t.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}var Vl=Gl;function jl(t){return Ul*Math.cos(t*Math.PI/180)}function Hl(t){return(180+t)/360}function Wl(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function ql(t,e){return t/jl(e)}function Xl(t){return 360*t-180}function Zl(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Jl(t,e){return t*jl(Zl(e))}const Yl=85.051129;function $l(t){return 1/Math.cos(t*Math.PI/180)}class Kl{constructor(t,e,i=0){this.x=+t,this.y=+e,this.z=+i}static fromLngLat(t,e=0){const i=Vl.convert(t);return new Kl(Hl(i.lng),Wl(i.lat),ql(e,i.lat))}toLngLat(){return new Vl(Xl(this.x),Zl(this.y))}toAltitude(){return Jl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ul*$l(Zl(this.y))}}function Ql(t,e,i,n,r,s,o,a,l){const c=(e+n)/2,h=(i+r)/2,u=new y(c,h);a(u),function(t,e,i,n,r,s){const o=i-r,a=n-s;return Math.abs((n-e)*o-(i-t)*a)/Math.hypot(o,a)}(u.x,u.y,s.x,s.y,o.x,o.y)>=l?(Ql(t,e,i,c,h,s,u,a,l),Ql(t,c,h,n,r,u,o,a,l)):t.push(o)}function tc(t,e,i){let n=t[0],r=n.x,s=n.y;e(n);const o=[n];for(let a=1;a<t.length;a++){const l=t[a],{x:c,y:h}=l;e(l),Ql(o,r,s,c,h,n,l,e,i),r=c,s=h,n=l}return o}function ec(t,e,i,n){if(n(e,i)){const r=e.add(i)._mult(.5);ec(t,e,r,n),ec(t,r,i,n)}else t.push(i)}function ic(t,e){let i=t[0];const n=[i];for(let r=1;r<t.length;r++){const s=t[r];ec(n,i,s,e),i=s}return n}const nc=Math.pow(2,14)-1,rc=-nc-1;function sc(t,e){const i=Math.round(t.x*e),n=Math.round(t.y*e);return t.x=E(i,rc,nc),t.y=E(n,rc,nc),(i<t.x||i>t.x+1||n<t.y||n>t.y+1)&&H("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function oc(t,e,i){const n=t.loadGeometry(),r=t.extent,s=aa/r;if(e&&i&&i.projection.isReprojectedInTileSpace){const s=1<<e.z,{scale:o,x:a,y:l,projection:c}=i,h=t=>{const i=Xl((e.x+t.x/r)/s),n=Zl((e.y+t.y/r)/s),h=c.project(i,n);t.x=(h.x*o-a)*r,t.y=(h.y*o-l)*r};for(let e=0;e<n.length;e++)if(1!==t.type)n[e]=tc(n[e],h,1);else{const t=[];for(const i of n[e])i.x<0||i.x>=r||i.y<0||i.y>=r||(h(i),t.push(i));n[e]=t}}for(const t of n)for(const e of t)sc(e,s);return n}function ac(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?oc(t):[]}}function lc(t,e,i,n,r){t.emplaceBack(2*e+(n+1)/2,2*i+(r+1)/2)}function cc(t,e,i){const n=16384;t.emplaceBack(e.x,e.y,e.z,i[0]*n,i[1]*n,i[2]*n)}class hc{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((t=>t.id)),this.index=t.index,this.hasPattern=!1,this.projection=t.projection,this.layoutVertexArray=new Us,this.indexArray=new io,this.segments=new oa,this.programConfigurations=new Yo(t.layers,t.zoom),this.stateDependentLayerIds=this.layers.filter((t=>t.isStateDependent())).map((t=>t.id))}populate(t,e,i,n){const r=this.layers[0],s=[];let o=null;"circle"===r.type&&(o=r.layout.get("circle-sort-key"));for(const{feature:e,id:r,index:a,sourceLayerIndex:l}of t){const t=this.layers[0]._featureFilter.needGeometry,c=ac(e,t);if(!this.layers[0]._featureFilter.filter(new bs(this.zoom),c,i))continue;const h=o?o.evaluate(c,{},i):void 0,u={id:r,properties:e.properties,type:e.type,sourceLayerIndex:l,index:a,geometry:t?c.geometry:oc(e,i,n),patterns:{},sortKey:h};s.push(u)}o&&s.sort(((t,e)=>t.sortKey-e.sortKey));let a=null;"globe"===n.projection.name&&(this.globeExtVertexArray=new Xs,a=n.projection);for(const n of s){const{geometry:r,index:s,sourceLayerIndex:o}=n,l=t[s].feature;this.addFeature(n,r,s,e.availableImages,i,a),e.featureIndex.insert(l,r,s,o,this.index)}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,ra.members),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,sa.members))),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(t,e,i,n,r,s){for(const i of e)for(const e of i){const i=e.x,n=e.y;if(i<0||i>=aa||n<0||n>=aa)continue;if(s){const t=s.projectTilePoint(i,n,r),e=s.upVector(r,i,n),o=this.globeExtVertexArray;cc(o,t,e),cc(o,t,e),cc(o,t,e),cc(o,t,e)}const o=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,t.sortKey),a=o.vertexLength;lc(this.layoutVertexArray,i,n,-1,-1),lc(this.layoutVertexArray,i,n,1,-1),lc(this.layoutVertexArray,i,n,1,1),lc(this.layoutVertexArray,i,n,-1,1),this.indexArray.emplaceBack(a,a+1,a+2),this.indexArray.emplaceBack(a,a+2,a+3),o.vertexLength+=4,o.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,{},n,r)}}function uc(t,e){for(let i=0;i<t.length;i++)if(xc(e,t[i]))return!0;for(let i=0;i<e.length;i++)if(xc(t,e[i]))return!0;return!!mc(t,e)}function dc(t,e,i){return!!xc(t,e)||!!_c(e,t,i)}function pc(t,e){if(1===t.length)return vc(e,t[0]);for(let i=0;i<e.length;i++){const n=e[i];for(let e=0;e<n.length;e++)if(xc(t,n[e]))return!0}for(let i=0;i<t.length;i++)if(vc(e,t[i]))return!0;for(let i=0;i<e.length;i++)if(mc(t,e[i]))return!0;return!1}function fc(t,e,i){if(t.length>1){if(mc(t,e))return!0;for(let n=0;n<e.length;n++)if(_c(e[n],t,i))return!0}for(let n=0;n<t.length;n++)if(_c(t[n],e,i))return!0;return!1}function mc(t,e){if(0===t.length||0===e.length)return!1;for(let i=0;i<t.length-1;i++){const n=t[i],r=t[i+1];for(let t=0;t<e.length-1;t++)if(gc(n,r,e[t],e[t+1]))return!0}return!1}function gc(t,e,i,n){return W(t,i,n)!==W(e,i,n)&&W(t,e,i)!==W(t,e,n)}function _c(t,e,i){const n=i*i;if(1===e.length)return t.distSqr(e[0])<n;for(let i=1;i<e.length;i++)if(yc(t,e[i-1],e[i])<n)return!0;return!1}function yc(t,e,i){const n=e.distSqr(i);if(0===n)return t.distSqr(e);const r=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/n;return t.distSqr(r<0?e:r>1?i:i.sub(e)._mult(r)._add(e))}function vc(t,e){let i,n,r,s=!1;for(let o=0;o<t.length;o++){i=t[o];for(let t=0,o=i.length-1;t<i.length;o=t++)n=i[t],r=i[o],n.y>e.y!=r.y>e.y&&e.x<(r.x-n.x)*(e.y-n.y)/(r.y-n.y)+n.x&&(s=!s)}return s}function xc(t,e){let i=!1;for(let n=0,r=t.length-1;n<t.length;r=n++){const s=t[n],o=t[r];s.y>e.y!=o.y>e.y&&e.x<(o.x-s.x)*(e.y-s.y)/(o.y-s.y)+s.x&&(i=!i)}return i}function bc(t,e,i,n,r){for(const s of t)if(e<=s.x&&i<=s.y&&n>=s.x&&r>=s.y)return!0;const s=[new y(e,i),new y(e,r),new y(n,r),new y(n,i)];if(t.length>2)for(const e of s)if(xc(t,e))return!0;for(let e=0;e<t.length-1;e++)if(wc(t[e],t[e+1],s))return!0;return!1}function wc(t,e,i){const n=i[0],r=i[2];if(t.x<n.x&&e.x<n.x||t.x>r.x&&e.x>r.x||t.y<n.y&&e.y<n.y||t.y>r.y&&e.y>r.y)return!1;const s=W(t,e,i[0]);return s!==W(t,e,i[1])||s!==W(t,e,i[2])||s!==W(t,e,i[3])}function Ac(t,e,i){const n=e.paint.get(t).value;return"constant"===n.kind?n.value:i.programConfigurations.get(e.id).getMaxValue(t)}function Tc(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function Mc(t,e,i,n,r){if(!e[0]&&!e[1])return t;const s=y.convert(e)._mult(r);"viewport"===i&&s._rotate(-n);const o=[];for(let e=0;e<t.length;e++)o.push(t[e].sub(s));return o}function Sc(t,e,i,n){const r=y.convert(t)._mult(n);return"viewport"===e&&r._rotate(-i),r}Jr(hc,"CircleBucket",{omit:["layers"]});const Ec=new Bs({"circle-sort-key":new Ls(te.layout_circle["circle-sort-key"])});var Cc={paint:new Bs({"circle-radius":new Ls(te.paint_circle["circle-radius"]),"circle-color":new Ls(te.paint_circle["circle-color"]),"circle-blur":new Ls(te.paint_circle["circle-blur"]),"circle-opacity":new Ls(te.paint_circle["circle-opacity"]),"circle-translate":new Ps(te.paint_circle["circle-translate"]),"circle-translate-anchor":new Ps(te.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Ps(te.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Ps(te.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ls(te.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ls(te.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ls(te.paint_circle["circle-stroke-opacity"])}),layout:Ec};function Ic(t,e,i,n,r,s,o,a,l){if(s&&t.queryGeometry.isAboveHorizon)return!1;s&&(l*=t.pixelToTileUnitsFactor);const c=t.tileID.canonical,h=i.projection.upVectorScale(c,i.center.lat,i.worldSize).metersToTile;for(const u of e)for(const e of u){const u=e.add(a),d=r&&i.elevation?i.elevation.exaggeration()*r.getElevationAt(u.x,u.y,!0):0,p=i.projection.projectTilePoint(u.x,u.y,c);if(d>0){const t=i.projection.upVector(c,u.x,u.y);p.x+=t[0]*h*d,p.y+=t[1]*h*d,p.z+=t[2]*h*d}const f=s?u:Pc(p.x,p.y,p.z,n),m=s?t.tilespaceRays.map((t=>Bc(t,d))):t.queryGeometry.screenGeometry,g=Wa([],[p.x,p.y,p.z,1],n);if(!o&&s?l*=g[3]/i.cameraToCenterDistance:o&&!s&&(l*=i.cameraToCenterDistance/g[3]),s){const t=Zl((e.y/aa+c.y)/(1<<c.z));l/=i.projection.pixelsPerMeter(t,1)/ql(1,t)}if(dc(m,f,l))return!0}return!1}function Pc(t,e,i,n){const r=Wa([],[t,e,i,1],n);return new y(r[0]/r[3],r[1]/r[3])}const Lc=Sa(0,0,0),Rc=Sa(0,0,1);function Bc(t,e){const i=Aa();return Lc[2]=e,t.intersectsPlane(Lc,Rc,i),new y(i[0],i[1])}class Dc extends hc{}function Oc(t,{width:e,height:i},n,r){if(r){if(r instanceof Uint8ClampedArray)r=new Uint8Array(r.buffer);else if(r.length!==e*i*n)throw new RangeError("mismatched image size")}else r=new Uint8Array(e*i*n);return t.width=e,t.height=i,t.data=r,t}function kc(t,e,i){const{width:n,height:r}=e;n===t.width&&r===t.height||(Fc(t,e,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,r)},i),t.width=n,t.height=r,t.data=e.data)}function Fc(t,e,i,n,r,s){if(0===r.width||0===r.height)return e;if(r.width>t.width||r.height>t.height||i.x>t.width-r.width||i.y>t.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>e.width||r.height>e.height||n.x>e.width-r.width||n.y>e.height-r.height)throw new RangeError("out of range destination coordinates for image copy");const o=t.data,a=e.data;for(let l=0;l<r.height;l++){const c=((i.y+l)*t.width+i.x)*s,h=((n.y+l)*e.width+n.x)*s;for(let t=0;t<r.width*s;t++)a[h+t]=o[c+t]}return e}Jr(Dc,"HeatmapBucket",{omit:["layers"]});class zc{constructor(t,e){Oc(this,t,1,e)}resize(t){kc(this,new zc(t),1)}clone(){return new zc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,i,n,r){Fc(t,e,i,n,r,1)}}class Nc{constructor(t,e){Oc(this,t,4,e)}resize(t){kc(this,new Nc(t),4)}replace(t,e){e?this.data.set(t):this.data=t instanceof Uint8ClampedArray?new Uint8Array(t.buffer):t}clone(){return new Nc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,i,n,r){Fc(t,e,i,n,r,4)}}Jr(zc,"AlphaImage"),Jr(Nc,"RGBAImage");var Uc={paint:new Bs({"heatmap-radius":new Ls(te.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ls(te.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Ps(te.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Rs(te.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Ps(te.paint_heatmap["heatmap-opacity"])})};function Gc(t){const e={},i=t.resolution||256,n=t.clips?t.clips.length:1,r=t.image||new Nc({width:i,height:n}),s=(i,n,s)=>{e[t.evaluationKey]=s;const o=t.expression.evaluate(e);r.data[i+n+0]=Math.floor(255*o.r/o.a),r.data[i+n+1]=Math.floor(255*o.g/o.a),r.data[i+n+2]=Math.floor(255*o.b/o.a),r.data[i+n+3]=Math.floor(255*o.a)};if(t.clips)for(let e=0,r=0;e<n;++e,r+=4*i)for(let n=0,o=0;n<i;n++,o+=4){const a=n/(i-1),{start:l,end:c}=t.clips[e];s(r,o,l*(1-a)+c*a)}else for(let t=0,e=0;t<i;t++,e+=4)s(0,e,t/(i-1));return r}var Vc={paint:new Bs({"hillshade-illumination-direction":new Ps(te.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Ps(te.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Ps(te.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Ps(te.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Ps(te.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Ps(te.paint_hillshade["hillshade-accent-color"])})};const jc=zs([{name:"a_pos",components:2,type:"Int16"}],4),{members:Hc}=jc;var Wc={exports:{}};function qc(t,e,i){i=i||2;var n,r,s,o,a,l,c,h=e&&e.length,u=h?e[0]*i:t.length,d=Xc(t,0,u,i,!0),p=[];if(!d||d.next===d.prev)return p;if(h&&(d=function(t,e,i,n){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=Xc(t,e[r]*n,r<s-1?e[r+1]*n:t.length,n,!1))===o.next&&(o.steiner=!0),a.push(rh(o));for(a.sort(th),r=0;r<a.length;r++)i=eh(a[r],i);return i}(t,e,d,i)),t.length>80*i){n=s=t[0],r=o=t[1];for(var f=i;f<u;f+=i)(a=t[f])<n&&(n=a),(l=t[f+1])<r&&(r=l),a>s&&(s=a),l>o&&(o=l);c=0!==(c=Math.max(s-n,o-r))?32767/c:0}return Jc(d,p,i,n,r,c,0),p}function Xc(t,e,i,n,r){var s,o;if(r===_h(t,e,i,n)>0)for(s=e;s<i;s+=n)o=fh(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=fh(s,t[s],t[s+1],o);return o&&lh(o,o.next)&&(mh(o),o=o.next),o}function Zc(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!lh(n,n.next)&&0!==ah(n.prev,n,n.next))n=n.next;else{if(mh(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function Jc(t,e,i,n,r,s,o){if(t){!o&&s&&function(t,e,i,n){var r=t;do{0===r.z&&(r.z=nh(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,s,o,a,l,c=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<c&&(a++,n=n.nextZ);e++);for(l=c;a>0||l>0&&n;)0!==a&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,l--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,c*=2}while(o>1)}(r)}(t,n,r,s);for(var a,l,c=t;t.prev!==t.next;)if(a=t.prev,l=t.next,s?$c(t,n,r,s):Yc(t))e.push(a.i/i|0),e.push(t.i/i|0),e.push(l.i/i|0),mh(t),t=l.next,c=l.next;else if((t=l)===c){o?1===o?Jc(t=Kc(Zc(t),e,i),e,i,n,r,s,2):2===o&&Qc(t,e,i,n,r,s):Jc(Zc(t),e,i,n,r,s,1);break}}}function Yc(t){var e=t.prev,i=t,n=t.next;if(ah(e,i,n)>=0)return!1;for(var r=e.x,s=i.x,o=n.x,a=e.y,l=i.y,c=n.y,h=r<s?r<o?r:o:s<o?s:o,u=a<l?a<c?a:c:l<c?l:c,d=r>s?r>o?r:o:s>o?s:o,p=a>l?a>c?a:c:l>c?l:c,f=n.next;f!==e;){if(f.x>=h&&f.x<=d&&f.y>=u&&f.y<=p&&sh(r,a,s,l,o,c,f.x,f.y)&&ah(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function $c(t,e,i,n){var r=t.prev,s=t,o=t.next;if(ah(r,s,o)>=0)return!1;for(var a=r.x,l=s.x,c=o.x,h=r.y,u=s.y,d=o.y,p=a<l?a<c?a:c:l<c?l:c,f=h<u?h<d?h:d:u<d?u:d,m=a>l?a>c?a:c:l>c?l:c,g=h>u?h>d?h:d:u>d?u:d,_=nh(p,f,e,i,n),y=nh(m,g,e,i,n),v=t.prevZ,x=t.nextZ;v&&v.z>=_&&x&&x.z<=y;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&sh(a,h,l,u,c,d,v.x,v.y)&&ah(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&sh(a,h,l,u,c,d,x.x,x.y)&&ah(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=_;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&sh(a,h,l,u,c,d,v.x,v.y)&&ah(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&sh(a,h,l,u,c,d,x.x,x.y)&&ah(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Kc(t,e,i){var n=t;do{var r=n.prev,s=n.next.next;!lh(r,s)&&ch(r,n,n.next,s)&&dh(r,s)&&dh(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),mh(n),mh(n.next),n=t=s),n=n.next}while(n!==t);return Zc(n)}function Qc(t,e,i,n,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&oh(o,a)){var l=ph(o,a);return o=Zc(o,o.next),l=Zc(l,l.next),Jc(o,e,i,n,r,s,0),void Jc(l,e,i,n,r,s,0)}a=a.next}o=o.next}while(o!==t)}function th(t,e){return t.x-e.x}function eh(t,e){var i=function(t,e){var i,n=e,r=t.x,s=t.y,o=-1/0;do{if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){var a=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>o&&(o=a,i=n.x<n.next.x?n:n.next,a===r))return i}n=n.next}while(n!==e);if(!i)return null;var l,c=i,h=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&sh(s<u?r:o,s,h,u,s<u?o:r,s,n.x,n.y)&&(l=Math.abs(s-n.y)/(r-n.x),dh(n,t)&&(l<d||l===d&&(n.x>i.x||n.x===i.x&&ih(i,n)))&&(i=n,d=l)),n=n.next}while(n!==c);return i}(t,e);if(!i)return e;var n=ph(i,t);return Zc(n,n.next),Zc(i,i.next)}function ih(t,e){return ah(t.prev,t,e.prev)<0&&ah(e.next,t,t.next)<0}function nh(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function rh(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function sh(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}function oh(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&ch(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(dh(t,e)&&dh(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(ah(t.prev,t,e.prev)||ah(t,e.prev,e))||lh(t,e)&&ah(t.prev,t,t.next)>0&&ah(e.prev,e,e.next)>0)}function ah(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function lh(t,e){return t.x===e.x&&t.y===e.y}function ch(t,e,i,n){var r=uh(ah(t,e,i)),s=uh(ah(t,e,n)),o=uh(ah(i,n,t)),a=uh(ah(i,n,e));return r!==s&&o!==a||!(0!==r||!hh(t,i,e))||!(0!==s||!hh(t,n,e))||!(0!==o||!hh(i,t,n))||!(0!==a||!hh(i,e,n))}function hh(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function uh(t){return t>0?1:t<0?-1:0}function dh(t,e){return ah(t.prev,t,t.next)<0?ah(t,e,t.next)>=0&&ah(t,t.prev,e)>=0:ah(t,e,t.prev)<0||ah(t,t.next,e)<0}function ph(t,e){var i=new gh(t.i,t.x,t.y),n=new gh(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}function fh(t,e,i,n){var r=new gh(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function mh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function gh(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function _h(t,e,i,n){for(var r=0,s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}Wc.exports=qc,Wc.exports.default=qc,qc.deviation=function(t,e,i,n){var r=e&&e.length,s=Math.abs(_h(t,0,r?e[0]*i:t.length,i));if(r)for(var o=0,a=e.length;o<a;o++)s-=Math.abs(_h(t,e[o]*i,o<a-1?e[o+1]*i:t.length,i));var l=0;for(o=0;o<n.length;o+=3){var c=n[o]*i,h=n[o+1]*i,u=n[o+2]*i;l+=Math.abs((t[c]-t[u])*(t[h+1]-t[c+1])-(t[c]-t[h])*(t[u+1]-t[c+1]))}return 0===s&&0===l?0:Math.abs((l-s)/s)},qc.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)i.vertices.push(t[r][s][o]);r>0&&i.holes.push(n+=t[r-1].length)}return i};var yh=d(Wc.exports);function vh(t,e,i,n,r){xh(t,e,i||0,n||t.length-1,r||wh)}function xh(t,e,i,n,r){for(;n>i;){if(n-i>600){var s=n-i+1,o=e-i+1,a=Math.log(s),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(s-l)/s)*(o-s/2<0?-1:1);xh(t,e,Math.max(i,Math.floor(e-o*l/s+c)),Math.min(n,Math.floor(e+(s-o)*l/s+c)),r)}var h=t[e],u=i,d=n;for(bh(t,i,e),r(t[n],h)>0&&bh(t,i,n);u<d;){for(bh(t,u,d),u++,d--;r(t[u],h)<0;)u++;for(;r(t[d],h)>0;)d--}0===r(t[i],h)?bh(t,i,d):bh(t,++d,n),d<=e&&(i=d+1),e<=d&&(n=d-1)}}function bh(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function wh(t,e){return t<e?-1:t>e?1:0}function Ah(t,e){const i=t.length;if(i<=1)return[t];const n=[];let r,s;for(let e=0;e<i;e++){const i=q(t[e]);0!==i&&(t[e].area=Math.abs(i),void 0===s&&(s=i<0),s===i<0?(r&&n.push(r),r=[t[e]]):r.push(t[e]))}if(r&&n.push(r),e>1)for(let t=0;t<n.length;t++)n[t].length<=e||(vh(n[t],e,1,n[t].length-1,Th),n[t]=n[t].slice(0,e));return n}function Th(t,e){return e.area-t.area}function Mh(t,e,i){const n=i.patternDependencies;let r=!1;for(const i of e){const e=i.paint.get(`${t}-pattern`);e.isConstant()||(r=!0);const s=e.constantOr(null);s&&(r=!0,n[s]=!0)}return r}function Sh(t,e,i,n,r){const s=r.patternDependencies;for(const o of e){const e=o.paint.get(`${t}-pattern`).value;if("constant"!==e.kind){let t=e.evaluate({zoom:n},i,{},r.availableImages);t=t&&t.name?t.name:t,s[t]=!0,i.patterns[o.id]=t}}return i}class Eh{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((t=>t.id)),this.index=t.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Us,this.indexArray=new io,this.indexArray2=new lo,this.programConfigurations=new Yo(t.layers,t.zoom),this.segments=new oa,this.segments2=new oa,this.stateDependentLayerIds=this.layers.filter((t=>t.isStateDependent())).map((t=>t.id)),this.projection=t.projection}populate(t,e,i,n){this.hasPattern=Mh("fill",this.layers,e);const r=this.layers[0].layout.get("fill-sort-key"),s=[];for(const{feature:o,id:a,index:l,sourceLayerIndex:c}of t){const t=this.layers[0]._featureFilter.needGeometry,h=ac(o,t);if(!this.layers[0]._featureFilter.filter(new bs(this.zoom),h,i))continue;const u=r?r.evaluate(h,{},i,e.availableImages):void 0,d={id:a,properties:o.properties,type:o.type,sourceLayerIndex:c,index:l,geometry:t?h.geometry:oc(o,i,n),patterns:{},sortKey:u};s.push(d)}r&&s.sort(((t,e)=>t.sortKey-e.sortKey));for(const n of s){const{geometry:r,index:s,sourceLayerIndex:o}=n;if(this.hasPattern){const t=Sh("fill",this.layers,n,this.zoom,e);this.patternFeatures.push(t)}else this.addFeature(n,r,s,i,{},e.availableImages);e.featureIndex.insert(t[s].feature,r,s,o,this.index)}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}addFeatures(t,e,i,n,r){for(const t of this.patternFeatures)this.addFeature(t,t.geometry,t.index,e,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Hc),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.indexBuffer2=t.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(t,e,i,n,r,s=[]){for(const t of Ah(e,500)){let e=0;for(const i of t)e+=i.length;const i=this.segments.prepareSegment(e,this.layoutVertexArray,this.indexArray),n=i.vertexLength,r=[],s=[];for(const e of t){if(0===e.length)continue;e!==t[0]&&s.push(r.length/2);const i=this.segments2.prepareSegment(e.length,this.layoutVertexArray,this.indexArray2),n=i.vertexLength;this.layoutVertexArray.emplaceBack(e[0].x,e[0].y),this.indexArray2.emplaceBack(n+e.length-1,n),r.push(e[0].x),r.push(e[0].y);for(let t=1;t<e.length;t++)this.layoutVertexArray.emplaceBack(e[t].x,e[t].y),this.indexArray2.emplaceBack(n+t-1,n+t),r.push(e[t].x),r.push(e[t].y);i.vertexLength+=e.length,i.primitiveLength+=e.length}const o=yh(r,s);for(let t=0;t<o.length;t+=3)this.indexArray.emplaceBack(n+o[t],n+o[t+1],n+o[t+2]);i.vertexLength+=e,i.primitiveLength+=o.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,s,n)}}Jr(Eh,"FillBucket",{omit:["layers","patternFeatures"]});const Ch=new Bs({"fill-sort-key":new Ls(te.layout_fill["fill-sort-key"])});var Ih={paint:new Bs({"fill-antialias":new Ps(te.paint_fill["fill-antialias"]),"fill-opacity":new Ls(te.paint_fill["fill-opacity"]),"fill-color":new Ls(te.paint_fill["fill-color"]),"fill-outline-color":new Ls(te.paint_fill["fill-outline-color"]),"fill-translate":new Ps(te.paint_fill["fill-translate"]),"fill-translate-anchor":new Ps(te.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ls(te.paint_fill["fill-pattern"])}),layout:Ch};const Ph=zs([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Lh=zs([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Rh=zs([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:Bh}=Ph;var Dh={},Oh=g,kh=Fh;function Fh(t,e,i,n,r){this.properties={},this.extent=i,this.type=0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=r,t.readFields(zh,this,e)}function zh(t,e,i){1==t?e.id=i.readVarint():2==t?function(t,e){for(var i=t.readVarint()+t.pos;t.pos<i;){var n=e._keys[t.readVarint()],r=e._values[t.readVarint()];e.properties[n]=r}}(i,e):3==t?e.type=i.readVarint():4==t&&(e._geometry=i.pos)}function Nh(t){for(var e,i,n=0,r=0,s=t.length,o=s-1;r<s;o=r++)n+=((i=t[o]).x-(e=t[r]).x)*(e.y+i.y);return n}Fh.types=["Unknown","Point","LineString","Polygon"],Fh.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,i=t.readVarint()+t.pos,n=1,r=0,s=0,o=0,a=[];t.pos<i;){if(r<=0){var l=t.readVarint();n=7&l,r=l>>3}if(r--,1===n||2===n)s+=t.readSVarint(),o+=t.readSVarint(),1===n&&(e&&a.push(e),e=[]),e.push(new Oh(s,o));else{if(7!==n)throw new Error("unknown command "+n);e&&e.push(e[0].clone())}}return e&&a.push(e),a},Fh.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,i=1,n=0,r=0,s=0,o=1/0,a=-1/0,l=1/0,c=-1/0;t.pos<e;){if(n<=0){var h=t.readVarint();i=7&h,n=h>>3}if(n--,1===i||2===i)(r+=t.readSVarint())<o&&(o=r),r>a&&(a=r),(s+=t.readSVarint())<l&&(l=s),s>c&&(c=s);else if(7!==i)throw new Error("unknown command "+i)}return[o,l,a,c]},Fh.prototype.toGeoJSON=function(t,e,i){var n,r,s=this.extent*Math.pow(2,i),o=this.extent*t,a=this.extent*e,l=this.loadGeometry(),c=Fh.types[this.type];function h(t){for(var e=0;e<t.length;e++){var i=t[e];t[e]=[360*(i.x+o)/s-180,360/Math.PI*Math.atan(Math.exp((180-360*(i.y+a)/s)*Math.PI/180))-90]}}switch(this.type){case 1:var u=[];for(n=0;n<l.length;n++)u[n]=l[n][0];h(l=u);break;case 2:for(n=0;n<l.length;n++)h(l[n]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return[t];for(var i,n,r=[],s=0;s<e;s++){var o=Nh(t[s]);0!==o&&(void 0===n&&(n=o<0),n===o<0?(i&&r.push(i),i=[t[s]]):i.push(t[s]))}return i&&r.push(i),r}(l),n=0;n<l.length;n++)for(r=0;r<l[n].length;r++)h(l[n][r])}1===l.length?l=l[0]:c="Multi"+c;var d={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return"id"in this&&(d.id=this.id),d};var Uh=kh,Gh=Vh;function Vh(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(jh,this,e),this.length=this._features.length}function jh(t,e,i){15===t?e.version=i.readVarint():1===t?e.name=i.readString():5===t?e.extent=i.readVarint():2===t?e._features.push(i.pos):3===t?e._keys.push(i.readString()):4===t&&e._values.push(function(t){for(var e=null,i=t.readVarint()+t.pos;t.pos<i;){var n=t.readVarint()>>3;e=1===n?t.readString():2===n?t.readFloat():3===n?t.readDouble():4===n?t.readVarint64():5===n?t.readVarint():6===n?t.readSVarint():7===n?t.readBoolean():null}return e}(i))}Vh.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new Uh(this._pbf,e,this.extent,this._keys,this._values)};var Hh=Gh;function Wh(t,e,i){if(3===t){var n=new Hh(i,i.readVarint()+i.pos);n.length&&(e[n.name]=n)}}var qh=Dh.VectorTile=function(t,e){this.layers=t.readFields(Wh,{},e)},Xh=Dh.VectorTileFeature=kh;function Zh(t,e,i,n){const r=[],s=0===n?(t,e,i,n,r,s)=>{t.push(new y(s,i+(s-e)/(n-e)*(r-i)))}:(t,e,i,n,r,s)=>{t.push(new y(e+(s-i)/(r-i)*(n-e),s))};for(const o of t){const t=[];for(const r of o){if(r.length<=2)continue;const o=[];for(let t=0;t<r.length-1;t++){const a=r[t].x,l=r[t].y,c=r[t+1].x,h=r[t+1].y,u=0===n?a:l,d=0===n?c:h;u<e?d>e&&s(o,a,l,c,h,e):u>i?d<i&&s(o,a,l,c,h,i):o.push(r[t]),d<e&&u>=e&&s(o,a,l,c,h,e),d>i&&u<=i&&s(o,a,l,c,h,i)}let a=r[r.length-1];const l=0===n?a.x:a.y;l>=e&&l<=i&&o.push(a),o.length&&(a=o[o.length-1],o[0].x===a.x&&o[0].y===a.y||o.push(o[0]),t.push(o))}t.length&&r.push(t)}return r}Dh.VectorTileLayer=Gh;const Jh=Xh.types,Yh=Math.pow(2,13);function $h(t,e,i,n,r,s,o,a){t.emplaceBack((e<<1)+o,(i<<1)+s,(Math.floor(n*Yh)<<1)+r,Math.round(a))}function Kh(t,e,i){const n=16384;t.emplaceBack(e.x,e.y,e.z,i[0]*n,i[1]*n,i[2]*n)}class Qh{constructor(){this.acc=new y(0,0),this.polyCount=[]}startRing(t){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new y(t.x,t.y),this.max=new y(t.x,t.y))}append(t,e){this.currentPolyCount.edges++,this.acc._add(t);const i=this.min,n=this.max;t.x<i.x?i.x=t.x:t.x>n.x&&(n.x=t.x),t.y<i.y?i.y=t.y:t.y>n.y&&(n.y=t.y),((0===t.x||t.x===aa)&&t.x===e.x)!=((0===t.y||t.y===aa)&&t.y===e.y)&&this.processBorderOverlap(t,e),e.x<0!=t.x<0&&this.addBorderIntersection(0,Li(e.y,t.y,(0-e.x)/(t.x-e.x))),e.x>aa!=t.x>aa&&this.addBorderIntersection(1,Li(e.y,t.y,(aa-e.x)/(t.x-e.x))),e.y<0!=t.y<0&&this.addBorderIntersection(2,Li(e.x,t.x,(0-e.y)/(t.y-e.y))),e.y>aa!=t.y>aa&&this.addBorderIntersection(3,Li(e.x,t.x,(aa-e.y)/(t.y-e.y)))}addBorderIntersection(t,e){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const i=this.borders[t];e<i[0]&&(i[0]=e),e>i[1]&&(i[1]=e)}processBorderOverlap(t,e){if(t.x===e.x){if(t.y===e.y)return;const i=0===t.x?0:1;this.addBorderIntersection(i,e.y),this.addBorderIntersection(i,t.y)}else{const i=0===t.y?2:3;this.addBorderIntersection(i,e.x),this.addBorderIntersection(i,t.x)}}centroid(){const t=this.polyCount.reduce(((t,e)=>t+e.edges),0);return 0!==t?this.acc.div(t)._round():new y(0,0)}span(){return new y(this.max.x-this.min.x,this.max.y-this.min.y)}intersectsCount(){return this.borders.reduce(((t,e)=>t+ +(e[0]!==Number.MAX_VALUE)),0)}}class tu{constructor(t){this.zoom=t.zoom,this.canonical=t.canonical,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((t=>t.id)),this.index=t.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=t.projection,this.layoutVertexArray=new Vs,this.centroidVertexArray=new wo,this.indexArray=new io,this.programConfigurations=new Yo(t.layers,t.zoom),this.segments=new oa,this.stateDependentLayerIds=this.layers.filter((t=>t.isStateDependent())).map((t=>t.id)),this.enableTerrain=t.enableTerrain}populate(t,e,i,n){this.features=[],this.hasPattern=Mh("fill-extrusion",this.layers,e),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=function(t){const e=Math.exp(Math.PI*(1-t.y/(1<<t.z)*2));return 80150034*e/(e*e+1)/aa/(1<<t.z)}(i),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:r,id:s,index:o,sourceLayerIndex:a}of t){const t=this.layers[0]._featureFilter.needGeometry,l=ac(r,t);if(!this.layers[0]._featureFilter.filter(new bs(this.zoom),l,i))continue;const c={id:s,sourceLayerIndex:a,index:o,geometry:t?l.geometry:oc(r,i,n),properties:r.properties,type:r.type,patterns:{}},h=this.layoutVertexArray.length;this.hasPattern?this.features.push(Sh("fill-extrusion",this.layers,c,this.zoom,e)):this.addFeature(c,c.geometry,o,i,{},e.availableImages,n),e.featureIndex.insert(r,c.geometry,o,a,this.index,h)}this.sortBorders()}addFeatures(t,e,i,n,r){for(const t of this.features){const{geometry:s}=t;this.addFeature(t,s,t.index,e,i,n,r)}this.sortBorders()}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Bh),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=t.createVertexBuffer(this.layoutVertexExtArray,Rh.members,!0))),this.programConfigurations.upload(t),this.uploaded=!0}uploadCentroid(t){0!==this.centroidVertexArray.length&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=t.createVertexBuffer(this.centroidVertexArray,Lh.members,!0),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(t,e,i,n,r,s,o){const a=[new y(0,0),new y(aa,aa)],l=o.projection,c="globe"===l.name,h=this.enableTerrain&&!c?new Qh:null,u="Polygon"===Jh[t.type];c&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Xs);const d=Ah(e,500);for(let t=d.length-1;t>=0;t--){const e=d[t];(0===e.length||(p=e[0]).every((t=>t.x<=0))||p.every((t=>t.x>=aa))||p.every((t=>t.y<=0))||p.every((t=>t.y>=aa)))&&d.splice(t,1)}var p;let f;if(c)f=lu(d,a,n);else{f=[];for(const t of d)f.push({polygon:t,bounds:a})}const m=u?this.edgeRadius:0;for(const{polygon:t,bounds:e}of f){let i=0,r=0;for(const e of t)u&&!e[0].equals(e[e.length-1])&&e.push(e[0]),r+=u?e.length-1:e.length;const s=this.segments.prepareSegment((u?5:4)*r,this.layoutVertexArray,this.indexArray);if(u){const e=[],r=[];i=s.vertexLength;for(const i of t){let o,a;i.length&&i!==t[0]&&r.push(e.length/2),o=i[1].sub(i[0])._perp()._unit();for(let t=1;t<i.length;t++){const r=i[t],h=i[t===i.length-1?1:t+1];let{x:u,y:d}=r;if(m){a=h.sub(r)._perp()._unit();const t=o.add(a)._unit(),e=m*Math.min(4,1/(o.x*t.x+o.y*t.y));u+=e*t.x,d+=e*t.y,o=a}$h(this.layoutVertexArray,u,d,0,0,1,1,0),s.vertexLength++,e.push(r.x,r.y),c&&Kh(this.layoutVertexExtArray,l.projectTilePoint(u,d,n),l.upVector(n,u,d))}}const o=yh(e,r);for(let t=0;t<o.length;t+=3)this.indexArray.emplaceBack(i+o[t],i+o[t+2],i+o[t+1]),s.primitiveLength++}for(const r of t){h&&r.length&&h.startRing(r[0]);let t,o,a,d=r.length>4&&su(r[r.length-2],r[0],r[1]),p=m?iu(r[r.length-2],r[0],r[1],m):0;o=r[1].sub(r[0])._perp()._unit();let f=!0;for(let g=1,_=0;g<r.length;g++){let y=r[g-1],v=r[g];const x=r[g===r.length-1?1:g+1];if(h&&u&&h.currentPolyCount.top++,ru(v,y,e)){m&&(o=x.sub(v)._perp()._unit(),f=!f);continue}h&&h.append(v,y);const b=v.sub(y)._perp(),w=b.x/(Math.abs(b.x)+Math.abs(b.y)),A=b.y>0?1:0,T=y.dist(v);if(_+T>32768&&(_=0),m){a=x.sub(v)._perp()._unit();let t=nu(y,v,x,eu(o,a),m);isNaN(t)&&(t=0);const e=v.sub(y)._unit();y=y.add(e.mult(p))._round(),v=v.add(e.mult(-t))._round(),p=t,o=a}const M=s.vertexLength,S=r.length>4&&su(y,v,x);let E=ou(_,d,f);if($h(this.layoutVertexArray,y.x,y.y,w,A,0,0,E),$h(this.layoutVertexArray,y.x,y.y,w,A,0,1,E),_+=T,E=ou(_,S,!f),d=S,$h(this.layoutVertexArray,v.x,v.y,w,A,0,0,E),$h(this.layoutVertexArray,v.x,v.y,w,A,0,1,E),s.vertexLength+=4,this.indexArray.emplaceBack(M+0,M+1,M+2),this.indexArray.emplaceBack(M+1,M+3,M+2),s.primitiveLength+=2,m){const n=i+(1===g?r.length-2:g-2),o=1===g?i:n+1;if(this.indexArray.emplaceBack(M+1,n,M+3),this.indexArray.emplaceBack(n,o,M+3),s.primitiveLength+=2,void 0===t&&(t=M),!ru(x,r[g],e)){const e=g===r.length-1?t:s.vertexLength;this.indexArray.emplaceBack(M+2,M+3,e),this.indexArray.emplaceBack(M+3,e+1,e),this.indexArray.emplaceBack(M+3,o,e+1),s.primitiveLength+=3}f=!f}if(c){const t=this.layoutVertexExtArray,e=l.projectTilePoint(y.x,y.y,n),i=l.projectTilePoint(v.x,v.y,n),r=l.upVector(n,y.x,y.y),s=l.upVector(n,v.x,v.y);Kh(t,e,r),Kh(t,e,r),Kh(t,i,s),Kh(t,i,s)}}u&&(i+=r.length-1)}}if(h&&h.polyCount.length>0){if(h.borders){h.vertexArrayOffset=this.centroidVertexArray.length;const t=h.borders,e=this.featuresOnBorder.push(h)-1;for(let i=0;i<4;i++)t[i][0]!==Number.MAX_VALUE&&this.borders[i].push(e)}this.encodeCentroid(h.borders?void 0:h.centroid(),h)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,s,n)}sortBorders(){for(let t=0;t<4;t++)this.borders[t].sort(((e,i)=>this.featuresOnBorder[e].borders[t][0]-this.featuresOnBorder[i].borders[t][0]))}encodeCentroid(t,e,i=!0){let n,r;if(t)if(0!==t.y){const i=e.span()._mult(this.tileToMeter);n=(Math.max(t.x,1)<<3)+Math.min(7,Math.round(i.x/10)),r=(Math.max(t.y,1)<<3)+Math.min(7,Math.round(i.y/10))}else n=Math.ceil(7*(t.x+450)),r=0;else n=0,r=+i;let s=i?this.centroidVertexArray.length:e.vertexArrayOffset;for(const t of e.polyCount){i&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*t.edges+t.top);for(let e=0;e<t.top;e++)this.centroidVertexArray.emplace(s++,n,r);for(let e=0;e<2*t.edges;e++)this.centroidVertexArray.emplace(s++,0,r),this.centroidVertexArray.emplace(s++,n,r)}}}function eu(t,e){const i=t.add(e)._unit();return t.x*i.x+t.y*i.y}function iu(t,e,i,n){const r=e.sub(t)._perp()._unit(),s=i.sub(e)._perp()._unit();return nu(t,e,i,eu(r,s),n)}function nu(t,e,i,n,r){const s=Math.sqrt(1-n*n);return Math.min(t.dist(e)/3,e.dist(i)/3,r*s/n)}function ru(t,e,i){return t.x<i[0].x&&e.x<i[0].x||t.x>i[1].x&&e.x>i[1].x||t.y<i[0].y&&e.y<i[0].y||t.y>i[1].y&&e.y>i[1].y}function su(t,e,i){if(t.x<0||t.x>=aa||e.x<0||e.x>=aa||i.x<0||i.x>=aa)return!1;const n=i.sub(e),r=n.perp(),s=t.sub(e);return(n.x*s.x+n.y*s.y)/Math.sqrt((n.x*n.x+n.y*n.y)*(s.x*s.x+s.y*s.y))>-.866&&r.x*s.x+r.y*s.y<0}function ou(t,e,i){const n=e?2|t:-3&t;return i?1|n:-2&n}function au(){const t=Math.PI/32,e=Math.tan(t),i=Nl;return i*Math.sqrt(1+2*e*e)-i}function lu(t,e,i){const n=1<<i.z,r=Xl(i.x/n),s=Xl((i.x+1)/n),o=Zl(i.y/n),a=Zl((i.y+1)/n);return function(t,e,i,n,r=0,s){const o=[];if(!t.length||!i||!n)return o;const a=(t,e)=>{for(const i of t)o.push({polygon:i,bounds:e})},l=Math.ceil(Math.log2(i)),c=Math.ceil(Math.log2(n)),h=l-c,u=[];for(let t=0;t<Math.abs(h);t++)u.push(h>0?0:1);for(let t=0;t<Math.min(l,c);t++)u.push(0),u.push(1);let d=t;if(d=Zh(d,e[0].y-r,e[1].y+r,1),d=Zh(d,e[0].x-r,e[1].x+r,0),!d.length)return o;const p=[];for(u.length?p.push({polygons:d,bounds:e,depth:0}):a(d,e);p.length;){const t=p.pop(),e=t.depth,i=u[e],n=t.bounds[0],o=t.bounds[1],l=0===i?n.x:n.y,c=0===i?o.x:o.y,h=s?s(i,l,c):.5*(l+c),d=Zh(t.polygons,l-r,h+r,i),f=Zh(t.polygons,h-r,c+r,i);if(d.length){const t=[n,new y(0===i?h:o.x,1===i?h:o.y)];u.length>e+1?p.push({polygons:d,bounds:t,depth:e+1}):a(d,t)}if(f.length){const t=[new y(0===i?h:n.x,1===i?h:n.y),o];u.length>e+1?p.push({polygons:f,bounds:t,depth:e+1}):a(f,t)}}return o}(t,e,Math.ceil((s-r)/11.25),Math.ceil((o-a)/11.25),1,((t,e,r)=>{if(0===t)return.5*(e+r);{const t=Zl((i.y+e/aa)/n);return(Wl(.5*(Zl((i.y+r/aa)/n)+t))*n-i.y)*aa}}))}Jr(tu,"FillExtrusionBucket",{omit:["layers","features"]}),Jr(Qh,"PartMetadata");const cu=new Bs({"fill-extrusion-edge-radius":new Ps(te["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var hu={paint:new Bs({"fill-extrusion-opacity":new Ps(te["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ls(te["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Ps(te["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Ps(te["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ls(te["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ls(te["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ls(te["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new Ps(te["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Ps(te["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Ps(te["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-rounded-roof":new Ps(te["paint_fill-extrusion"]["fill-extrusion-rounded-roof"])}),layout:cu};function uu(t,e,i){var n=2*Math.PI*6378137/256/Math.pow(2,i);return[t*n-2*Math.PI*6378137/2,e*n-2*Math.PI*6378137/2]}class du{constructor(t,e,i){this.z=t,this.x=e,this.y=i,this.key=mu(0,t,t,e,i)}equals(t){return this.z===t.z&&this.x===t.x&&this.y===t.y}url(t,e){const i=function(t,e,i){var n=uu(256*t,256*(e=Math.pow(2,i)-e-1),i),r=uu(256*(t+1),256*(e+1),i);return n[0]+","+n[1]+","+r[0]+","+r[1]}(this.x,this.y,this.z),n=function(t,e,i){let n,r="";for(let s=t;s>0;s--)n=1<<s-1,r+=(e&n?1:0)+(i&n?2:0);return r}(this.z,this.x,this.y);return t[(this.x+this.y)%t.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===e?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",n).replace("{bbox-epsg-3857}",i)}toString(){return`${this.z}/${this.x}/${this.y}`}}class pu{constructor(t,e){this.wrap=t,this.canonical=e,this.key=mu(t,e.z,e.z,e.x,e.y)}}class fu{constructor(t,e,i,n,r){this.overscaledZ=t,this.wrap=e,this.canonical=new du(i,+n,+r),this.key=0===e&&t===i?this.canonical.key:mu(e,t,i,n,r)}equals(t){return this.overscaledZ===t.overscaledZ&&this.wrap===t.wrap&&this.canonical.equals(t.canonical)}scaledTo(t){const e=this.canonical.z-t;return t>this.canonical.z?new fu(t,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new fu(t,this.wrap,t,this.canonical.x>>e,this.canonical.y>>e)}calculateScaledKey(t,e=!0){if(this.overscaledZ===t&&e)return this.key;if(t>this.canonical.z)return mu(this.wrap*+e,t,this.canonical.z,this.canonical.x,this.canonical.y);{const i=this.canonical.z-t;return mu(this.wrap*+e,t,t,this.canonical.x>>i,this.canonical.y>>i)}}isChildOf(t){if(t.wrap!==this.wrap)return!1;const e=this.canonical.z-t.canonical.z;return 0===t.overscaledZ||t.overscaledZ<this.overscaledZ&&t.canonical.x===this.canonical.x>>e&&t.canonical.y===this.canonical.y>>e}children(t){if(this.overscaledZ>=t)return[new fu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const e=this.canonical.z+1,i=2*this.canonical.x,n=2*this.canonical.y;return[new fu(e,this.wrap,e,i,n),new fu(e,this.wrap,e,i+1,n),new fu(e,this.wrap,e,i,n+1),new fu(e,this.wrap,e,i+1,n+1)]}isLessThan(t){return this.wrap<t.wrap||!(this.wrap>t.wrap)&&(this.overscaledZ<t.overscaledZ||!(this.overscaledZ>t.overscaledZ)&&(this.canonical.x<t.canonical.x||!(this.canonical.x>t.canonical.x)&&this.canonical.y<t.canonical.y))}wrapped(){return new fu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(t){return new fu(this.overscaledZ,t,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new pu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function mu(t,e,i,n,r){const s=1<<Math.min(i,22);let o=s*(r%s)+n%s;return t&&i<22&&(o+=s*s*((t<0?-2*t-1:2*t)%(1<<2*(22-i)))),16*(32*o+i)+(e-i)}Jr(du,"CanonicalTileID"),Jr(fu,"OverscaledTileID",{omit:["projMatrix"]});class gu extends y{constructor(t,e,i){super(t,e),this.z=i}}function _u(t,e){return t.x*e.x+t.y*e.y}function yu(t,e){if(1===t.length){let i=0;const n=e[i++];let r;for(;!r||n.equals(r);)if(r=e[i++],!r)return 1/0;for(;i<e.length;i++){const s=e[i],o=t[0],a=r.sub(n),l=s.sub(n),c=o.sub(n),h=_u(a,a),u=_u(a,l),d=_u(l,l),p=_u(c,a),f=_u(c,l),m=h*d-u*u,g=(d*p-u*f)/m,_=(h*f-u*p)/m,y=n.z*(1-g-_)+r.z*g+s.z*_;if(isFinite(y))return y}return 1/0}{let t=1/0;for(const i of e)t=Math.min(t,i.z);return t}}function vu(t,e,i,n,r,s,o,a){const l=o*r.getElevationAt(t,e,!0,!0),c=0!==s[0],h=c?0===s[1]?o*(s[0]/7-450):o*function(t,e,i){const n=Math.floor(e[0]/8),r=Math.floor(e[1]/8),s=10*(e[0]-8*n),o=10*(e[1]-8*r),a=t.getElevationAt(n,r,!0,!0),l=t.getMeterToDEM(i),c=Math.floor(.5*(s*l-1)),h=Math.floor(.5*(o*l-1)),u=t.tileCoordToPixel(n,r),d=2*c+1,p=2*h+1,f=function(t,e,i,n,r){return[t.getElevationAtPixel(e,i,!0),t.getElevationAtPixel(e+r,i,!0),t.getElevationAtPixel(e,i+r,!0),t.getElevationAtPixel(e+n,i+r,!0)]}(t,u.x-c,u.y-h,d,p),m=Math.abs(f[0]-f[1]),g=Math.abs(f[2]-f[3]),_=Math.abs(f[0]-f[2])+Math.abs(f[1]-f[3]),y=Math.min(.25,.5*l*(m+g)/d),v=Math.min(.25,.5*l*_/p);return a+Math.max(y*s,v*o)}(r,s,a):l;return{base:l+(0===i)?-1:i,top:c?Math.max(h+n,l+i+2):l+n}}const xu=zs([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:bu}=xu,wu=zs([{name:"a_packed",components:4,type:"Float32"}]),{members:Au}=wu,Tu=Xh.types,Mu=Math.cos(Math.PI/180*37.5);class Su{constructor(t){this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((t=>t.id)),this.index=t.index,this.projection=t.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((t=>{this.gradients[t.id]={}})),this.layoutVertexArray=new js,this.layoutVertexArray2=new Hs,this.indexArray=new io,this.programConfigurations=new Yo(t.layers,t.zoom),this.segments=new oa,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((t=>t.isStateDependent())).map((t=>t.id))}populate(t,e,i,n){this.hasPattern=Mh("line",this.layers,e);const r=this.layers[0].layout.get("line-sort-key"),s=[];for(const{feature:e,id:o,index:a,sourceLayerIndex:l}of t){const t=this.layers[0]._featureFilter.needGeometry,c=ac(e,t);if(!this.layers[0]._featureFilter.filter(new bs(this.zoom),c,i))continue;const h=r?r.evaluate(c,{},i):void 0,u={id:o,properties:e.properties,type:e.type,sourceLayerIndex:l,index:a,geometry:t?c.geometry:oc(e,i,n),patterns:{},sortKey:h};s.push(u)}r&&s.sort(((t,e)=>t.sortKey-e.sortKey));const{lineAtlas:o,featureIndex:a}=e,l=this.addConstantDashes(o);for(const n of s){const{geometry:r,index:s,sourceLayerIndex:c}=n;if(l&&this.addFeatureDashes(n,o),this.hasPattern){const t=Sh("line",this.layers,n,this.zoom,e);this.patternFeatures.push(t)}else this.addFeature(n,r,s,i,o.positions,e.availableImages);a.insert(t[s].feature,r,s,c,this.index)}}addConstantDashes(t){let e=!1;for(const i of this.layers){const n=i.paint.get("line-dasharray").value,r=i.layout.get("line-cap").value;if("constant"!==n.kind||"constant"!==r.kind)e=!0;else{const e=r.value,i=n.value;if(!i)continue;t.addDash(i,e)}}return e}addFeatureDashes(t,e){const i=this.zoom;for(const n of this.layers){const r=n.paint.get("line-dasharray").value,s=n.layout.get("line-cap").value;if("constant"===r.kind&&"constant"===s.kind)continue;let o,a;if("constant"===r.kind){if(o=r.value,!o)continue}else o=r.evaluate({zoom:i},t);a="constant"===s.kind?s.value:s.evaluate({zoom:i},t),e.addDash(o,a),t.patterns[n.id]=e.getKey(o,a)}}update(t,e,i,n){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(t,e,this.stateDependentLayers,i,n)}addFeatures(t,e,i,n,r){for(const t of this.patternFeatures)this.addFeature(t,t.geometry,t.index,e,i,n)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(t){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=t.createVertexBuffer(this.layoutVertexArray2,Au)),this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,bu),this.indexBuffer=t.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(t),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(t){if(t.properties&&t.properties.hasOwnProperty("mapbox_clip_start")&&t.properties.hasOwnProperty("mapbox_clip_end"))return{start:+t.properties.mapbox_clip_start,end:+t.properties.mapbox_clip_end}}addFeature(t,e,i,n,r,s){const o=this.layers[0].layout,a=o.get("line-join").evaluate(t,{}),l=o.get("line-cap").evaluate(t,{}),c=o.get("line-miter-limit"),h=o.get("line-round-limit");this.lineClips=this.lineFeatureClips(t);for(const i of e)this.addLine(i,t,a,l,c,h);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,t,i,r,s,n)}addLine(t,e,i,n,r,s){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let e=0;e<t.length-1;e++)this.totalDistance+=t[e].dist(t[e+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const o="Polygon"===Tu[e.type];let a=t.length;for(;a>=2&&t[a-1].equals(t[a-2]);)a--;let l=0;for(;l<a-1&&t[l].equals(t[l+1]);)l++;if(a<(o?3:2))return;"bevel"===i&&(r=1.05);const c=this.overscaling<=16?15*aa/(512*this.overscaling):0,h=this.segments.prepareSegment(10*a,this.layoutVertexArray,this.indexArray);let u,d,p,f,m;this.e1=this.e2=-1,o&&(u=t[a-2],m=t[l].sub(u)._unit()._perp());for(let e=l;e<a;e++){if(p=e===a-1?o?t[l+1]:void 0:t[e+1],p&&t[e].equals(p))continue;m&&(f=m),u&&(d=u),u=t[e],m=p?p.sub(u)._unit()._perp():f,f=f||m;let g=f.add(m);0===g.x&&0===g.y||g._unit();const _=f.x*m.x+f.y*m.y,y=g.x*m.x+g.y*m.y,v=0!==y?1/y:1/0,x=2*Math.sqrt(2-2*y),b=y<Mu&&d&&p,w=f.x*m.y-f.y*m.x>0;if(b&&e>l){const t=u.dist(d);if(t>2*c){const e=u.sub(u.sub(d)._mult(c/t)._round());this.updateDistance(d,e),this.addCurrentVertex(e,f,0,0,h),d=e}}const A=d&&p;let T=A?i:o?"butt":n;if(A&&"round"===T&&(v<s?T="miter":v<=2&&(T="fakeround")),"miter"===T&&v>r&&(T="bevel"),"bevel"===T&&(v>2&&(T="flipbevel"),v<r&&(T="miter")),d&&this.updateDistance(d,u),"miter"===T)g._mult(v),this.addCurrentVertex(u,g,0,0,h);else if("flipbevel"===T){if(v>100)g=m.mult(-1);else{const t=v*f.add(m).mag()/f.sub(m).mag();g._perp()._mult(t*(w?-1:1))}this.addCurrentVertex(u,g,0,0,h),this.addCurrentVertex(u,g.mult(-1),0,0,h)}else if("bevel"===T||"fakeround"===T){const t=-Math.sqrt(v*v-1),e=w?t:0,i=w?0:t;if(d&&this.addCurrentVertex(u,f,e,i,h),"fakeround"===T){const t=Math.round(180*x/Math.PI/20);for(let e=1;e<t;e++){let i=e/t;if(.5!==i){const t=i-.5;i+=i*t*(i-1)*((1.0904+_*(_*(3.55645-1.43519*_)-3.2452))*t*t+(.848013+_*(.215638*_-1.06021)))}const n=m.sub(f)._mult(i)._add(f)._unit()._mult(w?-1:1);this.addHalfVertex(u,n.x,n.y,!1,w,0,h)}}p&&this.addCurrentVertex(u,m,-e,-i,h)}else if("butt"===T)this.addCurrentVertex(u,g,0,0,h);else if("square"===T){const t=d?1:-1;d||this.addCurrentVertex(u,g,t,t,h),this.addCurrentVertex(u,g,0,0,h),d&&this.addCurrentVertex(u,g,t,t,h)}else"round"===T&&(d&&(this.addCurrentVertex(u,f,0,0,h),this.addCurrentVertex(u,f,1,1,h,!0)),p&&(this.addCurrentVertex(u,m,-1,-1,h,!0),this.addCurrentVertex(u,m,0,0,h)));if(b&&e<a-1){const t=u.dist(p);if(t>2*c){const e=u.add(p.sub(u)._mult(c/t)._round());this.updateDistance(u,e),this.addCurrentVertex(e,m,0,0,h),u=e}}}}addCurrentVertex(t,e,i,n,r,s=!1){const o=e.y*n-e.x,a=-e.y-e.x*n;this.addHalfVertex(t,e.x+e.y*i,e.y-e.x*i,s,!1,i,r),this.addHalfVertex(t,o,a,s,!0,-n,r)}addHalfVertex({x:t,y:e},i,n,r,s,o,a){this.layoutVertexArray.emplaceBack((t<<1)+(r?1:0),(e<<1)+(s?1:0),Math.round(63*i)+128,Math.round(63*n)+128,1+(0===o?0:o<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const l=a.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,l),a.primitiveLength++),s?this.e2=l:this.e1=l}updateScaledDistance(){if(this.lineClips){const t=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=t*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(t,e){this.distance+=t.dist(e),this.updateScaledDistance()}}Jr(Su,"LineBucket",{omit:["layers","patternFeatures"]});const Eu=new Bs({"line-cap":new Ls(te.layout_line["line-cap"]),"line-join":new Ls(te.layout_line["line-join"]),"line-miter-limit":new Ps(te.layout_line["line-miter-limit"]),"line-round-limit":new Ps(te.layout_line["line-round-limit"]),"line-sort-key":new Ls(te.layout_line["line-sort-key"])});var Cu={paint:new Bs({"line-opacity":new Ls(te.paint_line["line-opacity"]),"line-color":new Ls(te.paint_line["line-color"]),"line-translate":new Ps(te.paint_line["line-translate"]),"line-translate-anchor":new Ps(te.paint_line["line-translate-anchor"]),"line-width":new Ls(te.paint_line["line-width"]),"line-gap-width":new Ls(te.paint_line["line-gap-width"]),"line-offset":new Ls(te.paint_line["line-offset"]),"line-blur":new Ls(te.paint_line["line-blur"]),"line-dasharray":new Ls(te.paint_line["line-dasharray"]),"line-pattern":new Ls(te.paint_line["line-pattern"]),"line-gradient":new Rs(te.paint_line["line-gradient"]),"line-trim-offset":new Ps(te.paint_line["line-trim-offset"])}),layout:Eu};const Iu=new class extends Ls{possiblyEvaluate(t,e){return e=new bs(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,i,n){return e=R({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,i,n)}}(Cu.paint.properties["line-width"].specification);function Pu(t,e){return e>0?e+2*t:t}Iu.useIntegerZoom=!0;const Lu=zs([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Ru=zs([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),Bu=zs([{name:"a_projected_pos",components:4,type:"Float32"}],4);zs([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Du=zs([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),Ou=zs([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);zs([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const ku=zs([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),Fu=zs([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);zs([{name:"triangle",components:3,type:"Uint16"}]),zs([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),zs([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),zs([{type:"Float32",name:"offsetX"}]),zs([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var zu=24;const Nu=128;function Uu(t,e){const{expression:i}=e;if("constant"===i.kind)return{kind:"constant",layoutSize:i.evaluate(new bs(t+1))};if("source"===i.kind)return{kind:"source"};{const{zoomStops:e,interpolationType:n}=i;let r=0;for(;r<e.length&&e[r]<=t;)r++;r=Math.max(0,r-1);let s=r;for(;s<e.length&&e[s]<t+1;)s++;s=Math.min(e.length-1,s);const o=e[r],a=e[s];return"composite"===i.kind?{kind:"composite",minZoom:o,maxZoom:a,interpolationType:n}:{kind:"camera",minZoom:o,maxZoom:a,minSize:i.evaluate(new bs(o)),maxSize:i.evaluate(new bs(a)),interpolationType:n}}}function Gu(t,{uSize:e,uSizeT:i},{lowerSize:n,upperSize:r}){return"source"===t.kind?n/Nu:"composite"===t.kind?Li(n/Nu,r/Nu,i):e}function Vu(t,e){let i=0,n=0;if("constant"===t.kind)n=t.layoutSize;else if("source"!==t.kind){const{interpolationType:r,minZoom:s,maxZoom:o}=t,a=r?E(Qi.interpolationFactor(r,e,s,o),0,1):0;"camera"===t.kind?n=Li(t.minSize,t.maxSize,a):i=a}return{uSizeT:i,uSize:n}}var ju=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Nu,evaluateSizeForFeature:Gu,evaluateSizeForZoom:Vu,getSizeData:Uu});function Hu(t,e,i){return t.sections.forEach((t=>{t.text=function(t,e,i){const n=e.layout.get("text-transform").evaluate(i,{});return"uppercase"===n?t=t.toLocaleUpperCase():"lowercase"===n&&(t=t.toLocaleLowerCase()),xs.applyArabicShaping&&(t=xs.applyArabicShaping(t)),t}(t.text,e,i)})),t}const Wu={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function qu(t){return"︶"===t||"﹈"===t||"︸"===t||"﹄"===t||"﹂"===t||"︾"===t||"︼"===t||"︺"===t||"︘"===t||"﹀"===t||"︐"===t||"︓"===t||"︔"===t||"｀"===t||"￣"===t||"︑"===t||"︒"===t}function Xu(t){return"︵"===t||"﹇"===t||"︷"===t||"﹃"===t||"﹁"===t||"︽"===t||"︻"===t||"︹"===t||"︗"===t||"︿"===t}var Zu=$u,Ju=function(t,e,i,n,r){var s,o,a=8*r-n-1,l=(1<<a)-1,c=l>>1,h=-7,u=i?r-1:0,d=i?-1:1,p=t[e+u];for(u+=d,s=p&(1<<-h)-1,p>>=-h,h+=a;h>0;s=256*s+t[e+u],u+=d,h-=8);for(o=s&(1<<-h)-1,s>>=-h,h+=n;h>0;o=256*o+t[e+u],u+=d,h-=8);if(0===s)s=1-c;else{if(s===l)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,n),s-=c}return(p?-1:1)*o*Math.pow(2,s-n)},Yu=function(t,e,i,n,r,s){var o,a,l,c=8*s-r-1,h=(1<<c)-1,u=h>>1,d=23===r?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:s-1,f=n?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=h):(o=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-o))<1&&(o--,l*=2),(e+=o+u>=1?d/l:d*Math.pow(2,1-u))*l>=2&&(o++,l/=2),o+u>=h?(a=0,o=h):o+u>=1?(a=(e*l-1)*Math.pow(2,r),o+=u):(a=e*Math.pow(2,u-1)*Math.pow(2,r),o=0));r>=8;t[i+p]=255&a,p+=f,a/=256,r-=8);for(o=o<<r|a,c+=r;c>0;t[i+p]=255&o,p+=f,o/=256,c-=8);t[i+p-f]|=128*m};
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */function $u(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}$u.Varint=0,$u.Fixed64=1,$u.Bytes=2,$u.Fixed32=5;var Ku=4294967296,Qu=1/Ku,td="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function ed(t){return t.type===$u.Bytes?t.readVarint()+t.pos:t.pos+1}function id(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function nd(t,e,i){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(n);for(var r=i.pos-1;r>=t;r--)i.buf[r+n]=i.buf[r]}function rd(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function sd(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function od(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function ad(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function ld(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function cd(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function hd(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function ud(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function dd(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function pd(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function fd(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function md(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}$u.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var n=this.readVarint(),r=n>>3,s=this.pos;this.type=7&n,t(r,e,this),this.pos===s&&this.skip(n)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=pd(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=md(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=pd(this.buf,this.pos)+pd(this.buf,this.pos+4)*Ku;return this.pos+=8,t},readSFixed64:function(){var t=pd(this.buf,this.pos)+md(this.buf,this.pos+4)*Ku;return this.pos+=8,t},readFloat:function(){var t=Ju(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Ju(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,n=this.buf;return e=127&(i=n[this.pos++]),i<128?e:(e|=(127&(i=n[this.pos++]))<<7,i<128?e:(e|=(127&(i=n[this.pos++]))<<14,i<128?e:(e|=(127&(i=n[this.pos++]))<<21,i<128?e:function(t,e,i){var n,r,s=i.buf;if(n=(112&(r=s[i.pos++]))>>4,r<128)return id(t,n,e);if(n|=(127&(r=s[i.pos++]))<<3,r<128)return id(t,n,e);if(n|=(127&(r=s[i.pos++]))<<10,r<128)return id(t,n,e);if(n|=(127&(r=s[i.pos++]))<<17,r<128)return id(t,n,e);if(n|=(127&(r=s[i.pos++]))<<24,r<128)return id(t,n,e);if(n|=(1&(r=s[i.pos++]))<<31,r<128)return id(t,n,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=n[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&td?function(t,e,i){return td.decode(t.subarray(e,i))}(this.buf,e,t):function(t,e,i){for(var n="",r=e;r<i;){var s,o,a,l=t[r],c=null,h=l>239?4:l>223?3:l>191?2:1;if(r+h>i)break;1===h?l<128&&(c=l):2===h?128==(192&(s=t[r+1]))&&(c=(31&l)<<6|63&s)<=127&&(c=null):3===h?(o=t[r+2],128==(192&(s=t[r+1]))&&128==(192&o)&&((c=(15&l)<<12|(63&s)<<6|63&o)<=2047||c>=55296&&c<=57343)&&(c=null)):4===h&&(o=t[r+2],a=t[r+3],128==(192&(s=t[r+1]))&&128==(192&o)&&128==(192&a)&&((c=(15&l)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,h=1):c>65535&&(c-=65536,n+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),n+=String.fromCharCode(c),r+=h}return n}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==$u.Bytes)return t.push(this.readVarint(e));var i=ed(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==$u.Bytes)return t.push(this.readSVarint());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==$u.Bytes)return t.push(this.readBoolean());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==$u.Bytes)return t.push(this.readFloat());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==$u.Bytes)return t.push(this.readDouble());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==$u.Bytes)return t.push(this.readFixed32());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==$u.Bytes)return t.push(this.readSFixed32());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==$u.Bytes)return t.push(this.readFixed64());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==$u.Bytes)return t.push(this.readSFixed64());var e=ed(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===$u.Varint)for(;this.buf[this.pos++]>127;);else if(e===$u.Bytes)this.pos=this.readVarint()+this.pos;else if(e===$u.Fixed32)this.pos+=4;else{if(e!==$u.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),fd(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),fd(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),fd(this.buf,-1&t,this.pos),fd(this.buf,Math.floor(t*Qu),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),fd(this.buf,-1&t,this.pos),fd(this.buf,Math.floor(t*Qu),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var i,n;if(t>=0?(i=t%4294967296|0,n=t/4294967296|0):(n=~(-t/4294967296),4294967295^(i=~(-t%4294967296))?i=i+1|0:(i=0,n=n+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,i){i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,i.buf[i.pos]=127&(t>>>=7)}(i,0,e),function(t,e){var i=(7&t)<<4;e.buf[e.pos++]|=i|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=127&t)))))}(n,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,i){for(var n,r,s=0;s<e.length;s++){if((n=e.charCodeAt(s))>55295&&n<57344){if(!r){n>56319||s+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):r=n;continue}if(n<56320){t[i++]=239,t[i++]=191,t[i++]=189,r=n;continue}n=r-55296<<10|n-56320|65536,r=null}else r&&(t[i++]=239,t[i++]=191,t[i++]=189,r=null);n<128?t[i++]=n:(n<2048?t[i++]=n>>6|192:(n<65536?t[i++]=n>>12|224:(t[i++]=n>>18|240,t[i++]=n>>12&63|128),t[i++]=n>>6&63|128),t[i++]=63&n|128)}return i}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&nd(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),Yu(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Yu(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var n=this.pos-i;n>=128&&nd(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n},writeMessage:function(t,e,i){this.writeTag(t,$u.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,rd,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,sd,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,ld,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,od,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,ad,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,cd,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,hd,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,ud,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,dd,e)},writeBytesField:function(t,e){this.writeTag(t,$u.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,$u.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,$u.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,$u.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,$u.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,$u.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,$u.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,$u.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,$u.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,$u.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};var gd=d(Zu);const _d=3;function yd(t,e,i){e.glyphs=[],1===t&&i.readMessage(vd,e)}function vd(t,e,i){if(3===t){const{id:t,bitmap:n,width:r,height:s,left:o,top:a,advance:l}=i.readMessage(xd,{});e.glyphs.push({id:t,bitmap:new zc({width:r+2*_d,height:s+2*_d},n),metrics:{width:r,height:s,left:o,top:a,advance:l}})}else 4===t?e.ascender=i.readSVarint():5===t&&(e.descender=i.readSVarint())}function xd(t,e,i){1===t?e.id=i.readVarint():2===t?e.bitmap=i.readBytes():3===t?e.width=i.readVarint():4===t?e.height=i.readVarint():5===t?e.left=i.readSVarint():6===t?e.top=i.readSVarint():7===t&&(e.advance=i.readVarint())}const bd=_d;function wd(t){let e=0,i=0;for(const n of t)e+=n.w*n.h,i=Math.max(i,n.w);t.sort(((t,e)=>e.h-t.h));const n=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let r=0,s=0;for(const e of t)for(let t=n.length-1;t>=0;t--){const i=n[t];if(!(e.w>i.w||e.h>i.h)){if(e.x=i.x,e.y=i.y,s=Math.max(s,e.y+e.h),r=Math.max(r,e.x+e.w),e.w===i.w&&e.h===i.h){const e=n.pop();t<n.length&&(n[t]=e)}else e.h===i.h?(i.x+=e.w,i.w-=e.w):e.w===i.w?(i.y+=e.h,i.h-=e.h):(n.push({x:i.x+e.w,y:i.y,w:i.w-e.w,h:e.h}),i.y+=e.h,i.h-=e.h);break}}return{w:r,h:s,fill:e/(r*s)||0}}const Ad=1;class Td{constructor(t,{pixelRatio:e,version:i,stretchX:n,stretchY:r,content:s}){this.paddedRect=t,this.pixelRatio=e,this.stretchX=n,this.stretchY=r,this.content=s,this.version=i}get tl(){return[this.paddedRect.x+Ad,this.paddedRect.y+Ad]}get br(){return[this.paddedRect.x+this.paddedRect.w-Ad,this.paddedRect.y+this.paddedRect.h-Ad]}get displaySize(){return[(this.paddedRect.w-2*Ad)/this.pixelRatio,(this.paddedRect.h-2*Ad)/this.pixelRatio]}}class Md{constructor(t,e){const i={},n={};this.haveRenderCallbacks=[];const r=[];this.addImages(t,i,r),this.addImages(e,n,r);const{w:s,h:o}=wd(r),a=new Nc({width:s||1,height:o||1});for(const e in t){const n=t[e],r=i[e].paddedRect;Nc.copy(n.data,a,{x:0,y:0},{x:r.x+Ad,y:r.y+Ad},n.data)}for(const t in e){const i=e[t],r=n[t].paddedRect,s=r.x+Ad,o=r.y+Ad,l=i.data.width,c=i.data.height;Nc.copy(i.data,a,{x:0,y:0},{x:s,y:o},i.data),Nc.copy(i.data,a,{x:0,y:c-1},{x:s,y:o-1},{width:l,height:1}),Nc.copy(i.data,a,{x:0,y:0},{x:s,y:o+c},{width:l,height:1}),Nc.copy(i.data,a,{x:l-1,y:0},{x:s-1,y:o},{width:1,height:c}),Nc.copy(i.data,a,{x:0,y:0},{x:s+l,y:o},{width:1,height:c})}this.image=a,this.iconPositions=i,this.patternPositions=n}addImages(t,e,i){for(const n in t){const r=t[n],s={x:0,y:0,w:r.data.width+2*Ad,h:r.data.height+2*Ad};i.push(s),e[n]=new Td(s,r),r.hasRenderCallback&&this.haveRenderCallbacks.push(n)}}patchUpdatedImages(t,e){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((e=>t.hasImage(e))),t.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const i in t.updatedImages)this.patchUpdatedImage(this.iconPositions[i],t.getImage(i),e),this.patchUpdatedImage(this.patternPositions[i],t.getImage(i),e)}patchUpdatedImage(t,e,i){if(!t||!e)return;if(t.version===e.version)return;t.version=e.version;const[n,r]=t.tl;i.update(e.data,void 0,{x:n,y:r})}}Jr(Td,"ImagePosition"),Jr(Md,"ImageAtlas");const Sd={horizontal:1,vertical:2,horizontalOnly:3},Ed=-17;class Cd{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(t,e){const i=new Cd;return i.scale=t||1,i.fontStack=e,i}static forImage(t){const e=new Cd;return e.imageName=t,e}}class Id{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(t,e){const i=new Id;for(let n=0;n<t.sections.length;n++){const r=t.sections[n];r.image?i.addImageSection(r):i.addTextSection(r,e)}return i}length(){return this.text.length}getSection(t){return this.sections[this.sectionIndex[t]]}getSections(){return this.sections}getSectionIndex(t){return this.sectionIndex[t]}getCharCode(t){return this.text.charCodeAt(t)}verticalizePunctuation(t){this.text=function(t,e){let i="";for(let n=0;n<t.length;n++){const r=t.charCodeAt(n+1)||null,s=t.charCodeAt(n-1)||null;i+=!e&&(r&&ss(r)&&!Wu[t[n+1]]||s&&ss(s)&&!Wu[t[n-1]])||!Wu[t[n]]?t[n]:Wu[t[n]]}return i}(this.text,t)}trim(){let t=0;for(let e=0;e<this.text.length&&Ld[this.text.charCodeAt(e)];e++)t++;let e=this.text.length;for(let i=this.text.length-1;i>=0&&i>=t&&Ld[this.text.charCodeAt(i)];i--)e--;this.text=this.text.substring(t,e),this.sectionIndex=this.sectionIndex.slice(t,e)}substring(t,e){const i=new Id;return i.text=this.text.substring(t,e),i.sectionIndex=this.sectionIndex.slice(t,e),i.sections=this.sections,i}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((t,e)=>Math.max(t,this.sections[e].scale)),0)}addTextSection(t,e){this.text+=t.text,this.sections.push(Cd.forText(t.scale,t.fontStack||e));const i=this.sections.length-1;for(let e=0;e<t.text.length;++e)this.sectionIndex.push(i)}addImageSection(t){const e=t.image?t.image.name:"";if(0===e.length)return void H("Can't add FormattedSection with an empty image.");const i=this.getNextImageSectionCharCode();i?(this.text+=String.fromCharCode(i),this.sections.push(Cd.forImage(e)),this.sectionIndex.push(this.sections.length-1)):H("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Pd(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f){const m=Id.fromFeature(t,r);u===Sd.vertical&&m.verticalizePunctuation(d);let g=[];const _=function(t,e,i,n,r,s){if(!t)return[];const o=[],a=function(t,e,i,n,r,s){let o=0;for(let i=0;i<t.length();i++){const a=t.getSection(i);o+=Bd(t.getCharCode(i),a,n,r,e,s)}return o/Math.max(1,Math.ceil(o/i))}(t,e,i,n,r,s),l=t.text.indexOf("​")>=0;let c=0;for(let i=0;i<t.length();i++){const u=t.getSection(i),d=t.getCharCode(i);if(Ld[d]||(c+=Bd(d,u,n,r,e,s)),i<t.length()-1){const e=!((h=d)<11904||!(ts["Bopomofo Extended"](h)||ts.Bopomofo(h)||ts["CJK Compatibility Forms"](h)||ts["CJK Compatibility Ideographs"](h)||ts["CJK Compatibility"](h)||ts["CJK Radicals Supplement"](h)||ts["CJK Strokes"](h)||ts["CJK Symbols and Punctuation"](h)||ts["CJK Unified Ideographs Extension A"](h)||ts["CJK Unified Ideographs"](h)||ts["Enclosed CJK Letters and Months"](h)||ts["Halfwidth and Fullwidth Forms"](h)||ts.Hiragana(h)||ts["Ideographic Description Characters"](h)||ts["Kangxi Radicals"](h)||ts["Katakana Phonetic Extensions"](h)||ts.Katakana(h)||ts["Vertical Forms"](h)||ts["Yi Radicals"](h)||ts["Yi Syllables"](h)));(Rd[d]||e||u.imageName)&&o.push(kd(i+1,c,a,o,Od(d,t.getCharCode(i+1),e&&l),!1))}}var h;return Fd(kd(t.length(),c,a,o,0,!0))}(m,c,s,e,n,p),{processBidirectionalText:y,processStyledBidirectionalText:v}=xs;if(y&&1===m.sections.length){const t=y(m.toString(),_);for(const e of t){const t=new Id;t.text=e,t.sections=m.sections;for(let i=0;i<e.length;i++)t.sectionIndex.push(0);g.push(t)}}else if(v){const t=v(m.text,m.sectionIndex,_);for(const e of t){const t=new Id;t.text=e[0],t.sectionIndex=e[1],t.sections=m.sections,g.push(t)}}else g=function(t,e){const i=[],n=t.text;let r=0;for(const n of e)i.push(t.substring(r,n)),r=n;return r<n.length&&i.push(t.substring(r,n.length)),i}(m,_);const x=[],b={positionedLines:x,text:m.toString(),top:h[1],bottom:h[1],left:h[0],right:h[0],writingMode:u,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(t,e,i,n,r,s,o,a,l,c,h,u){let d=0,p=0,f=0;const m="right"===a?1:"left"===a?0:.5;let g=!1;for(const t of r){const i=t.getSections();for(const t of i){if(t.imageName)continue;const i=e[t.fontStack];if(i&&(g=void 0!==i.ascender&&void 0!==i.descender,!g))break}if(!g)break}let _=0;for(const o of r){o.trim();const r=o.getMaxScale(),a=(r-1)*zu,v={positionedGlyphs:[],lineOffset:0};t.positionedLines[_]=v;const x=v.positionedGlyphs;let b=0;if(!o.length()){p+=s,++_;continue}let w=0,A=0;for(let s=0;s<o.length();s++){const a=o.getSection(s),f=o.getSectionIndex(s),m=o.getCharCode(s);let _=a.scale,v=null,T=null,M=null,S=zu,E=0;const C=!(l===Sd.horizontal||!h&&!rs(m)||h&&(Ld[m]||(y=m,ts.Arabic(y)||ts["Arabic Supplement"](y)||ts["Arabic Extended-A"](y)||ts["Arabic Presentation Forms-A"](y)||ts["Arabic Presentation Forms-B"](y))));if(a.imageName){const e=n[a.imageName];if(!e)continue;M=a.imageName,t.iconsInText=t.iconsInText||!0,T=e.paddedRect;const i=e.displaySize;_=_*zu/u,v={width:i[0],height:i[1],left:Ad,top:-bd,advance:C?i[1]:i[0],localGlyph:!1},E=g?-v.height*_:Ed+r*zu-i[1]*_,S=v.advance;const s=(C?i[0]:i[1])*_-zu*r;s>0&&s>b&&(b=s)}else{const t=i[a.fontStack];if(!t)continue;t[m]&&(T=t[m]);const n=e[a.fontStack];if(!n)continue;const s=n.glyphs[m];if(!s)continue;if(v=s.metrics,S=8203!==m?zu:0,g){const t=void 0!==n.ascender?Math.abs(n.ascender):0,e=void 0!==n.descender?Math.abs(n.descender):0,i=(t+e)*_;w<i&&(w=i,A=(t-e)/2*_),E=-t*_}else E=Ed+(r-_)*zu}C?(t.verticalizable=!0,x.push({glyph:m,imageName:M,x:d,y:p+E,vertical:C,scale:_,localGlyph:v.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:v,rect:T}),d+=S*_+c):(x.push({glyph:m,imageName:M,x:d,y:p+E,vertical:C,scale:_,localGlyph:v.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:v,rect:T}),d+=v.advance*_+c)}0!==x.length&&(f=Math.max(d-c,f),g?Nd(x,m,b,A,s*r/2):Nd(x,m,b,0,s/2)),d=0;const T=s*r+b;v.lineOffset=Math.max(b,a),p+=T,++_}var y;const v=p,{horizontalAlign:x,verticalAlign:b}=zd(o);(function(t,e,i,n,r,s){const o=(e-i)*r,a=-s*n;for(const e of t)for(const t of e.positionedGlyphs)t.x+=o,t.y+=a})(t.positionedLines,m,x,b,f,v),t.top+=-b*v,t.bottom=t.top+v,t.left+=-x*f,t.right=t.left+f,t.hasBaseline=g}(b,e,i,n,g,o,a,l,u,c,d,f),!function(t){for(const e of t)if(0!==e.positionedGlyphs.length)return!1;return!0}(x)&&b}const Ld={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Rd={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Bd(t,e,i,n,r,s){if(e.imageName){const t=n[e.imageName];return t?t.displaySize[0]*e.scale*zu/s+r:0}{const n=i[e.fontStack],s=n&&n.glyphs[t];return s?s.metrics.advance*e.scale+r:0}}function Dd(t,e,i,n){const r=Math.pow(t-e,2);return n?t<e?r/2:2*r:r+Math.abs(i)*i}function Od(t,e,i){let n=0;return 10===t&&(n-=1e4),i&&(n+=150),40!==t&&65288!==t||(n+=50),41!==e&&65289!==e||(n+=50),n}function kd(t,e,i,n,r,s){let o=null,a=Dd(e,i,r,s);for(const t of n){const n=Dd(e-t.x,i,r,s)+t.badness;n<=a&&(o=t,a=n)}return{index:t,x:e,priorBreak:o,badness:a}}function Fd(t){return t?Fd(t.priorBreak).concat(t.index):[]}function zd(t){let e=.5,i=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Nd(t,e,i,n,r){if(!(e||i||n||r))return;const s=t.length-1,o=t[s],a=(o.x+o.metrics.advance*o.scale)*e;for(let e=0;e<=s;e++)t[e].x-=a,t[e].y+=i+n+r}function Ud(t,e,i){const{horizontalAlign:n,verticalAlign:r}=zd(i),s=e[0]-t.displaySize[0]*n,o=e[1]-t.displaySize[1]*r;return{image:t,top:o,bottom:o+t.displaySize[1],left:s,right:s+t.displaySize[0]}}function Gd(t,e,i,n,r,s){const o=t.image;let a;if(o.content){const t=o.content,e=o.pixelRatio||1;a=[t[0]/e,t[1]/e,o.displaySize[0]-t[2]/e,o.displaySize[1]-t[3]/e]}const l=e.left*s,c=e.right*s;let h,u,d,p;"width"===i||"both"===i?(p=r[0]+l-n[3],u=r[0]+c+n[1]):(p=r[0]+(l+c-o.displaySize[0])/2,u=p+o.displaySize[0]);const f=e.top*s,m=e.bottom*s;return"height"===i||"both"===i?(h=r[1]+f-n[0],d=r[1]+m+n[2]):(h=r[1]+(f+m-o.displaySize[1])/2,d=h+o.displaySize[1]),{image:o,top:h,right:u,bottom:d,left:p,collisionPadding:a}}class Vd extends y{constructor(t,e,i,n,r){super(t,e),this.angle=n,this.z=i,void 0!==r&&(this.segment=r)}clone(){return new Vd(this.x,this.y,this.z,this.angle,this.segment)}}function jd(t,e,i,n,r){if(void 0===e.segment)return!0;let s=e,o=e.segment+1,a=0;for(;a>-i/2;){if(o--,o<0)return!1;a-=t[o].dist(s),s=t[o]}a+=t[o].dist(t[o+1]),o++;const l=[];let c=0;for(;a<i/2;){const e=t[o],i=t[o+1];if(!i)return!1;let s=t[o-1].angleTo(e)-e.angleTo(i);for(s=Math.abs((s+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:s}),c+=s;a-l[0].distance>n;)c-=l.shift().angleDelta;if(c>r)return!1;o++,a+=e.dist(i)}return!0}function Hd(t){let e=0;for(let i=0;i<t.length-1;i++)e+=t[i].dist(t[i+1]);return e}function Wd(t,e,i){return t?.6*e*i:0}function qd(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function Xd(t,e,i,n,r,s){const o=Wd(i,r,s),a=qd(i,n)*s;let l=0;const c=Hd(t)/2;for(let i=0;i<t.length-1;i++){const n=t[i],r=t[i+1],s=n.dist(r);if(l+s>c){const h=(c-l)/s,u=Li(n.x,r.x,h),d=Li(n.y,r.y,h),p=new Vd(u,d,0,r.angleTo(n),i);return!o||jd(t,p,a,o,e)?p:void 0}l+=s}}function Zd(t,e,i,n,r,s,o,a,l){const c=Wd(n,s,o),h=qd(n,r),u=h*o,d=0===t[0].x||t[0].x===l||0===t[0].y||t[0].y===l;return e-u<e/4&&(e=u+e/4),Jd(t,d?e/2*a%e:(h/2+2*s)*o*a%e,e,c,i,u,d,!1,l)}function Jd(t,e,i,n,r,s,o,a,l){const c=s/2,h=Hd(t);let u=0,d=e-i,p=[];for(let e=0;e<t.length-1;e++){const o=t[e],a=t[e+1],f=o.dist(a),m=a.angleTo(o);for(;d+i<u+f;){d+=i;const g=(d-u)/f,_=Li(o.x,a.x,g),y=Li(o.y,a.y,g);if(_>=0&&_<l&&y>=0&&y<l&&d-c>=0&&d+c<=h){const i=new Vd(_,y,0,m,e);i._round(),n&&!jd(t,i,s,n,r)||p.push(i)}}u+=f}return a||p.length||o||(p=Jd(t,u/2,i,n,r,s,o,!0,l)),p}function Yd(t,e,i,n,r){const s=[];for(let o=0;o<t.length;o++){const a=t[o];let l;for(let t=0;t<a.length-1;t++){let o=a[t],c=a[t+1];o.x<e&&c.x<e||(o.x<e?o=new y(e,o.y+(e-o.x)/(c.x-o.x)*(c.y-o.y))._round():c.x<e&&(c=new y(e,o.y+(e-o.x)/(c.x-o.x)*(c.y-o.y))._round()),o.y<i&&c.y<i||(o.y<i?o=new y(o.x+(i-o.y)/(c.y-o.y)*(c.x-o.x),i)._round():c.y<i&&(c=new y(o.x+(i-o.y)/(c.y-o.y)*(c.x-o.x),i)._round()),o.x>=n&&c.x>=n||(o.x>=n?o=new y(n,o.y+(n-o.x)/(c.x-o.x)*(c.y-o.y))._round():c.x>=n&&(c=new y(n,o.y+(n-o.x)/(c.x-o.x)*(c.y-o.y))._round()),o.y>=r&&c.y>=r||(o.y>=r?o=new y(o.x+(r-o.y)/(c.y-o.y)*(c.x-o.x),r)._round():c.y>=r&&(c=new y(o.x+(r-o.y)/(c.y-o.y)*(c.x-o.x),r)._round()),l&&o.equals(l[l.length-1])||(l=[o],s.push(l)),l.push(c)))))}}return s}Jr(Vd,"Anchor");const $d=1e20;function Kd(t,e,i,n,r,s,o,a,l){for(let c=e;c<e+n;c++)Qd(t,i*s+c,s,r,o,a,l);for(let c=i;c<i+r;c++)Qd(t,c*s+e,1,n,o,a,l)}function Qd(t,e,i,n,r,s,o){s[0]=0,o[0]=-$d,o[1]=$d,r[0]=t[e];for(let a=1,l=0,c=0;a<n;a++){r[a]=t[e+a*i];const n=a*a;do{const t=s[l];c=(r[a]-r[t]+n-t*t)/(a-t)/2}while(c<=o[l]&&--l>-1);l++,s[l]=a,o[l]=c,o[l+1]=$d}for(let a=0,l=0;a<n;a++){for(;o[l+1]<a;)l++;const n=s[l],c=a-n;t[e+a*i]=r[n]+c*c}}const tp=2,ep={none:0,ideographs:1,all:2};class ip{constructor(t,e,i){this.requestManager=t,this.localGlyphMode=e,this.localFontFamily=i,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(t){this.url=t}getGlyphs(t,e){const i=[];for(const e in t)for(const n of t[e])i.push({stack:e,id:n});P(i,(({stack:t,id:e},i)=>{let n=this.entries[t];n||(n=this.entries[t]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let r=n.glyphs[e];if(void 0!==r)return void i(null,{stack:t,id:e,glyph:r});if(r=this._tinySDF(n,t,e),r)return n.glyphs[e]=r,void i(null,{stack:t,id:e,glyph:r});const s=Math.floor(e/256);if(256*s>65535)return void i(new Error("glyphs > 65535 not supported"));if(n.ranges[s])return void i(null,{stack:t,id:e,glyph:r});let o=n.requests[s];o||(o=n.requests[s]=[],ip.loadGlyphRange(t,s,this.url,this.requestManager,((t,e)=>{if(e){n.ascender=e.ascender,n.descender=e.descender;for(const t in e.glyphs)this._doesCharSupportLocalGlyph(+t)||(n.glyphs[+t]=e.glyphs[+t]);n.ranges[s]=!0}for(const i of o)i(t,e);delete n.requests[s]}))),o.push(((n,r)=>{n?i(n):r&&i(null,{stack:t,id:e,glyph:r.glyphs[e]||null})}))}),((t,i)=>{if(t)e(t);else if(i){const t={};for(const{stack:e,id:n,glyph:r}of i)void 0===t[e]&&(t[e]={}),void 0===t[e].glyphs&&(t[e].glyphs={}),t[e].glyphs[n]=r&&{id:r.id,bitmap:r.bitmap.clone(),metrics:r.metrics},t[e].ascender=this.entries[e].ascender,t[e].descender=this.entries[e].descender;e(null,t)}}))}_doesCharSupportLocalGlyph(t){return this.localGlyphMode!==ep.none&&(this.localGlyphMode===ep.all?!!this.localFontFamily:!!this.localFontFamily&&(ts["CJK Unified Ideographs"](t)||ts["Hangul Syllables"](t)||ts.Hiragana(t)||ts.Katakana(t)||ts["CJK Symbols and Punctuation"](t)))}_tinySDF(t,e,i){const n=this.localFontFamily;if(!n||!this._doesCharSupportLocalGlyph(i))return;let r=t.tinySDF;if(!r){let i="400";/bold/i.test(e)?i="900":/medium/i.test(e)?i="500":/light/i.test(e)&&(i="200"),r=t.tinySDF=new ip.TinySDF({fontFamily:n,fontWeight:i,fontSize:24*tp,buffer:3*tp,radius:8*tp}),r.fontWeight=i}if(this.localGlyphs[r.fontWeight][i])return this.localGlyphs[r.fontWeight][i];const s=String.fromCharCode(i),{data:o,width:a,height:l,glyphWidth:c,glyphHeight:h,glyphLeft:u,glyphTop:d,glyphAdvance:p}=r.draw(s);return this.localGlyphs[r.fontWeight][i]={id:i,bitmap:new zc({width:a,height:l},o),metrics:{width:c/tp,height:h/tp,left:u/tp,top:d/tp-27,advance:p/tp,localGlyph:!0}}}}ip.loadGlyphRange=function(t,e,i,n,r){const s=256*e,o=s+255,a=n.transformRequest(n.normalizeGlyphsURL(i).replace("{fontstack}",t).replace("{range}",`${s}-${o}`),lt.Glyphs);dt(a,((t,e)=>{if(t)r(t);else if(e){const t={},i=function(t){return new gd(t).readFields(yd,{})}(e);for(const e of i.glyphs)t[e.id]=e;r(null,{glyphs:t,ascender:i.ascender,descender:i.descender})}}))},ip.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:s="normal",fontStyle:o="normal"}={}){this.buffer=e,this.cutoff=n,this.radius=i;const a=this.size=t+4*e,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${o} ${s} ${t}px ${r}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:s}=this.ctx.measureText(t),o=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-r))),l=Math.min(this.size-this.buffer,o+Math.ceil(n)),c=a+2*this.buffer,h=l+2*this.buffer,u=Math.max(c*h,0),d=new Uint8ClampedArray(u),p={data:d,width:c,height:h,glyphWidth:a,glyphHeight:l,glyphTop:o,glyphLeft:0,glyphAdvance:e};if(0===a||0===l)return p;const{ctx:f,buffer:m,gridInner:g,gridOuter:_}=this;f.clearRect(m,m,a,l),f.fillText(t,m,m+o);const y=f.getImageData(m,m,a,l);_.fill($d,0,u),g.fill(0,0,u);for(let t=0;t<l;t++)for(let e=0;e<a;e++){const i=y.data[4*(t*a+e)+3]/255;if(0===i)continue;const n=(t+m)*c+e+m;if(1===i)_[n]=0,g[n]=$d;else{const t=.5-i;_[n]=t>0?t*t:0,g[n]=t<0?t*t:0}}Kd(_,0,0,c,h,c,this.f,this.v,this.z),Kd(g,m,m,a,l,c,this.f,this.v,this.z);for(let t=0;t<u;t++){const e=Math.sqrt(_[t])-Math.sqrt(g[t]);d[t]=Math.round(255-255*(e/this.radius+this.cutoff))}return p}};const np=Ad;function rp(t,e,i,n){const r=[],s=t.image,o=s.pixelRatio,a=s.paddedRect.w-2*np,l=s.paddedRect.h-2*np,c=t.right-t.left,h=t.bottom-t.top,u=s.stretchX||[[0,a]],d=s.stretchY||[[0,l]],p=(t,e)=>t+e[1]-e[0],f=u.reduce(p,0),m=d.reduce(p,0),g=a-f,_=l-m;let v=0,x=f,b=0,w=m,A=0,T=g,M=0,S=_;if(s.content&&n){const t=s.content;v=sp(u,0,t[0]),b=sp(d,0,t[1]),x=sp(u,t[0],t[2]),w=sp(d,t[1],t[3]),A=t[0]-v,M=t[1]-b,T=t[2]-t[0]-x,S=t[3]-t[1]-w}const E=(n,r,a,l)=>{const u=ap(n.stretch-v,x,c,t.left),d=lp(n.fixed-A,T,n.stretch,f),p=ap(r.stretch-b,w,h,t.top),g=lp(r.fixed-M,S,r.stretch,m),_=ap(a.stretch-v,x,c,t.left),E=lp(a.fixed-A,T,a.stretch,f),C=ap(l.stretch-b,w,h,t.top),I=lp(l.fixed-M,S,l.stretch,m),P=new y(u,p),L=new y(_,p),R=new y(_,C),B=new y(u,C),D=new y(d/o,g/o),O=new y(E/o,I/o),k=e*Math.PI/180;if(k){const t=Math.sin(k),e=Math.cos(k),i=[e,-t,t,e];P._matMult(i),L._matMult(i),B._matMult(i),R._matMult(i)}const F=n.stretch+n.fixed,z=r.stretch+r.fixed;return{tl:P,tr:L,bl:B,br:R,tex:{x:s.paddedRect.x+np+F,y:s.paddedRect.y+np+z,w:a.stretch+a.fixed-F,h:l.stretch+l.fixed-z},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:D,pixelOffsetBR:O,minFontScaleX:T/o/c,minFontScaleY:S/o/h,isSDF:i}};if(n&&(s.stretchX||s.stretchY)){const t=op(u,g,f),e=op(d,_,m);for(let i=0;i<t.length-1;i++){const n=t[i],s=t[i+1];for(let t=0;t<e.length-1;t++)r.push(E(n,e[t],s,e[t+1]))}}else r.push(E({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:a+1},{fixed:0,stretch:l+1}));return r}function sp(t,e,i){let n=0;for(const r of t)n+=Math.max(e,Math.min(i,r[1]))-Math.max(e,Math.min(i,r[0]));return n}function op(t,e,i){const n=[{fixed:-np,stretch:0}];for(const[e,i]of t){const t=n[n.length-1];n.push({fixed:e-t.stretch,stretch:t.stretch}),n.push({fixed:e-t.stretch,stretch:t.stretch+(i-e)})}return n.push({fixed:e+np,stretch:i}),n}function ap(t,e,i,n){return t/e*i+n}function lp(t,e,i,n){return t-e*i/n}function cp(t,e,i,n){const r=e+t.positionedLines[n].lineOffset;return 0===n?i+r/2:i+(r+(e+t.positionedLines[n-1].lineOffset))/2}class hp{constructor(t=[],e=up){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:i}=this,n=e[t];for(;t>0;){const r=t-1>>1,s=e[r];if(i(n,s)>=0)break;e[t]=s,t=r}e[t]=n}_down(t){const{data:e,compare:i}=this,n=this.length>>1,r=e[t];for(;t<n;){let n=1+(t<<1),s=e[n];const o=n+1;if(o<this.length&&i(e[o],s)<0&&(n=o,s=e[o]),i(s,r)>=0)break;e[t]=s,t=n}e[t]=r}}function up(t,e){return t<e?-1:t>e?1:0}function dp(t,e=1,i=!1){let n=1/0,r=1/0,s=-1/0,o=-1/0;const a=t[0];for(let t=0;t<a.length;t++){const e=a[t];(!t||e.x<n)&&(n=e.x),(!t||e.y<r)&&(r=e.y),(!t||e.x>s)&&(s=e.x),(!t||e.y>o)&&(o=e.y)}const l=Math.min(s-n,o-r);let c=l/2;const h=new hp([],pp);if(0===l)return new y(n,r);for(let e=n;e<s;e+=l)for(let i=r;i<o;i+=l)h.push(new fp(e+c,i+c,c,t));let u=function(t){let e=0,i=0,n=0;const r=t[0];for(let t=0,s=r.length,o=s-1;t<s;o=t++){const s=r[t],a=r[o],l=s.x*a.y-a.x*s.y;i+=(s.x+a.x)*l,n+=(s.y+a.y)*l,e+=3*l}return new fp(i/e,n/e,0,t)}(t),d=h.length;for(;h.length;){const i=h.pop();(i.d>u.d||!u.d)&&(u=i),i.max-u.d<=e||(c=i.h/2,h.push(new fp(i.p.x-c,i.p.y-c,c,t)),h.push(new fp(i.p.x+c,i.p.y-c,c,t)),h.push(new fp(i.p.x-c,i.p.y+c,c,t)),h.push(new fp(i.p.x+c,i.p.y+c,c,t)),d+=4)}return u.p}function pp(t,e){return e.max-t.max}class fp{constructor(t,e,i,n){this.p=new y(t,e),this.h=i,this.d=function(t,e){let i=!1,n=1/0;for(let r=0;r<e.length;r++){const s=e[r];for(let e=0,r=s.length,o=r-1;e<r;o=e++){const r=s[e],a=s[o];r.y>t.y!=a.y>t.y&&t.x<(a.x-r.x)*(t.y-r.y)/(a.y-r.y)+r.x&&(i=!i),n=Math.min(n,yc(t,r,a))}}return(i?1:-1)*Math.sqrt(n)}(this.p,n),this.max=this.d+this.h*Math.SQRT2}}const mp=7,gp=Number.POSITIVE_INFINITY,_p=Math.sqrt(2);function yp(t,[e,i]){let n=0,r=0;if(i===gp){e<0&&(e=0);const i=e/_p;switch(t){case"top-right":case"top-left":r=i-mp;break;case"bottom-right":case"bottom-left":r=-i+mp;break;case"bottom":r=-e+mp;break;case"top":r=e-mp}switch(t){case"top-right":case"bottom-right":n=-i;break;case"top-left":case"bottom-left":n=i;break;case"left":n=e;break;case"right":n=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),t){case"top-right":case"top-left":case"top":r=i-mp;break;case"bottom-right":case"bottom-left":case"bottom":r=-i+mp}switch(t){case"top-right":case"bottom-right":case"right":n=-e;break;case"top-left":case"bottom-left":case"left":n=e}}return[n,r]}function vp(t,e,i,n,r,s,o,a,l,c){t.createArrays(),t.tilePixelRatio=aa/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const h=t.layers[0].layout,u=t.layers[0]._unevaluatedLayout._values,d={};if("composite"===t.textSizeData.kind){const{minZoom:e,maxZoom:i}=t.textSizeData;d.compositeTextSizes=[u["text-size"].possiblyEvaluate(new bs(e),a),u["text-size"].possiblyEvaluate(new bs(i),a)]}if("composite"===t.iconSizeData.kind){const{minZoom:e,maxZoom:i}=t.iconSizeData;d.compositeIconSizes=[u["icon-size"].possiblyEvaluate(new bs(e),a),u["icon-size"].possiblyEvaluate(new bs(i),a)]}d.layoutTextSize=u["text-size"].possiblyEvaluate(new bs(l+1),a),d.layoutIconSize=u["icon-size"].possiblyEvaluate(new bs(l+1),a),d.textMaxSize=u["text-size"].possiblyEvaluate(new bs(18),a);const p="map"===h.get("text-rotation-alignment")&&"point"!==h.get("symbol-placement"),f=h.get("text-size");for(const s of t.features){const l=h.get("text-font").evaluate(s,{},a).join(","),u=f.evaluate(s,{},a),m=d.layoutTextSize.evaluate(s,{},a),g=(d.layoutIconSize.evaluate(s,{},a),{horizontal:{},vertical:void 0}),_=s.text;let y,v=[0,0];if(_){const n=_.toString(),o=h.get("text-letter-spacing").evaluate(s,{},a)*zu,c=h.get("text-line-height").evaluate(s,{},a)*zu,d=is(n)?o:0,f=h.get("text-anchor").evaluate(s,{},a),y=h.get("text-variable-anchor");if(!y){const t=h.get("text-radial-offset").evaluate(s,{},a);v=t?yp(f,[t*zu,gp]):h.get("text-offset").evaluate(s,{},a).map((t=>t*zu))}let x=p?"center":h.get("text-justify").evaluate(s,{},a);const b="point"===h.get("symbol-placement"),w=b?h.get("text-max-width").evaluate(s,{},a)*zu:1/0,A=s=>{t.allowVerticalPlacement&&es(n)&&(g.vertical=Pd(_,e,i,r,l,w,c,f,s,d,v,Sd.vertical,!0,m,u))};if(!p&&y){const t="auto"===x?y.map((t=>xp(t))):[x];let n=!1;for(let s=0;s<t.length;s++){const o=t[s];if(!g.horizontal[o])if(n)g.horizontal[o]=g.horizontal[0];else{const t=Pd(_,e,i,r,l,w,c,"center",o,d,v,Sd.horizontal,!1,m,u);t&&(g.horizontal[o]=t,n=1===t.positionedLines.length)}}A("left")}else{if("auto"===x&&(x=xp(f)),b||h.get("text-writing-mode").indexOf("horizontal")>=0||!es(n)){const t=Pd(_,e,i,r,l,w,c,f,x,d,v,Sd.horizontal,!1,m,u);t&&(g.horizontal[x]=t)}A(b?"left":x)}}let x=!1;if(s.icon&&s.icon.name){const e=n[s.icon.name];e&&(y=Ud(r[s.icon.name],h.get("icon-offset").evaluate(s,{},a),h.get("icon-anchor").evaluate(s,{},a)),x=e.sdf,void 0===t.sdfIcons?t.sdfIcons=e.sdf:t.sdfIcons!==e.sdf&&H("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(e.pixelRatio!==t.pixelRatio||0!==h.get("icon-rotate").constantOr(1))&&(t.iconsNeedLinear=!0))}const b=Mp(g.horizontal)||g.vertical;t.iconsInText||(t.iconsInText=!!b&&b.iconsInText),(b||y)&&bp(t,s,g,y,n,d,m,0,v,x,o,a,c)}s&&t.generateCollisionDebugBuffers(l,t.collisionBoxArray)}function xp(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function bp(t,e,i,n,r,s,o,a,l,c,h,u,d){let p=s.textMaxSize.evaluate(e,{},u);void 0===p&&(p=o);const f=t.layers[0].layout,m=f.get("icon-offset").evaluate(e,{},u),g=Mp(i.horizontal)||i.vertical,_="globe"===d.name,y=zu,v=o/y,x=t.tilePixelRatio*p/y,w=(P=t.overscaling,t.zoom>18&&P>2&&(P>>=1),Math.max(aa/(512*P),1)*f.get("symbol-spacing")),A=f.get("text-padding")*t.tilePixelRatio,T=f.get("icon-padding")*t.tilePixelRatio,M=b(f.get("text-max-angle")),S="map"===f.get("text-rotation-alignment")&&"point"!==f.get("symbol-placement"),E="map"===f.get("icon-rotation-alignment")&&"point"!==f.get("symbol-placement"),C=f.get("symbol-placement"),I=w/2;var P;const L=f.get("icon-text-fit");let R;n&&"none"!==L&&(t.allowVerticalPlacement&&i.vertical&&(R=Gd(n,i.vertical,L,f.get("icon-text-fit-padding"),m,v)),g&&(n=Gd(n,g,L,f.get("icon-text-fit-padding"),m,v)));const B=(o,a,p)=>{if(a.x<0||a.x>=aa||a.y<0||a.y>=aa)return;let f=null;if(_){const{x:t,y:e,z:i}=d.projectTilePoint(a.x,a.y,p);f={anchor:new Vd(t,e,i,0,void 0),up:d.upVector(p,a.x,a.y)}}!function(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T){const M=t.addToLineVertexArray(e,n);let S,E,C,I,P,L,R,B=0,D=0,O=0,k=0,F=-1,z=-1;const N={};let U=Lo("");const G=i?i.anchor:e;let V=0,j=0;if(void 0===l._unevaluatedLayout.getValue("text-radial-offset")?[V,j]=l.layout.get("text-offset").evaluate(x,{},T).map((t=>t*zu)):(V=l.layout.get("text-radial-offset").evaluate(x,{},T)*zu,j=gp),t.allowVerticalPlacement&&r.vertical){const t=r.vertical;if(f)L=Ep(t),a&&(R=Ep(a));else{const i=l.layout.get("text-rotate").evaluate(x,{},T)+90;C=Sp(c,G,e,h,u,d,t,p,i,m),a&&(I=Sp(c,G,e,h,u,d,a,_,i))}}if(s){const n=l.layout.get("icon-rotate").evaluate(x,{},T),r="none"!==l.layout.get("icon-text-fit"),o=rp(s,n,w,r),p=a?rp(a,n,w,r):void 0;E=Sp(c,G,e,h,u,d,s,_,n),B=4*o.length;const f=t.iconSizeData;let m=null;"source"===f.kind?(m=[Nu*l.layout.get("icon-size").evaluate(x,{},T)],m[0]>Ap&&H(`${t.layerIds[0]}: Value for "icon-size" is >= ${wp}. Reduce your "icon-size".`)):"composite"===f.kind&&(m=[Nu*b.compositeIconSizes[0].evaluate(x,{},T),Nu*b.compositeIconSizes[1].evaluate(x,{},T)],(m[0]>Ap||m[1]>Ap)&&H(`${t.layerIds[0]}: Value for "icon-size" is >= ${wp}. Reduce your "icon-size".`)),t.addSymbols(t.icon,o,m,v,y,x,!1,i,e,M.lineStartIndex,M.lineLength,-1,A,T),F=t.icon.placedSymbolArray.length-1,p&&(D=4*p.length,t.addSymbols(t.icon,p,m,v,y,x,Sd.vertical,i,e,M.lineStartIndex,M.lineLength,-1,A,T),z=t.icon.placedSymbolArray.length-1)}for(const n in r.horizontal){const s=r.horizontal[n];S||(U=Lo(s.text),f?P=Ep(s):S=Sp(c,G,e,h,u,d,s,p,l.layout.get("text-rotate").evaluate(x,{},T),m));const a=1===s.positionedLines.length;if(O+=Tp(t,i,e,s,o,l,f,x,m,M,r.vertical?Sd.horizontal:Sd.horizontalOnly,a?Object.keys(r.horizontal):[n],N,F,b,A,T),a)break}r.vertical&&(k+=Tp(t,i,e,r.vertical,o,l,f,x,m,M,Sd.vertical,["vertical"],N,z,b,A,T));let W=-1;const q=(t,e)=>t?Math.max(t,e):e;W=q(P,W),W=q(L,W),W=q(R,W);const X=W>-1?1:0;t.glyphOffsetArray.length>=af.MAX_GLYPHS&&H("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==x.sortKey&&t.addToSortKeyRanges(t.symbolInstances.length,x.sortKey),t.symbolInstances.emplaceBack(G.x,G.y,G.z,e.x,e.y,N.right>=0?N.right:-1,N.center>=0?N.center:-1,N.left>=0?N.left:-1,N.vertical>=0?N.vertical:-1,F,z,U,void 0!==S?S:t.collisionBoxArray.length,void 0!==S?S+1:t.collisionBoxArray.length,void 0!==C?C:t.collisionBoxArray.length,void 0!==C?C+1:t.collisionBoxArray.length,void 0!==E?E:t.collisionBoxArray.length,void 0!==E?E+1:t.collisionBoxArray.length,I||t.collisionBoxArray.length,I?I+1:t.collisionBoxArray.length,h,O,k,B,D,X,0,V,j,W)}(t,a,f,o,i,n,r,R,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,A,S,l,0,T,E,m,e,s,c,h,u)};if("line"===C)for(const r of Yd(e.geometry,0,0,aa,aa)){const e=Zd(r,w,M,i.vertical||g,n,y,x,t.overscaling,aa);for(const i of e)g&&Cp(t,g.text,I,i)||B(r,i,u)}else if("line-center"===C){for(const t of e.geometry)if(t.length>1){const e=Xd(t,M,i.vertical||g,n,y,x);e&&B(t,e,u)}}else if("Polygon"===e.type)for(const t of Ah(e.geometry,0)){const e=dp(t,16);B(t[0],new Vd(e.x,e.y,0,0,void 0),u)}else if("LineString"===e.type)for(const t of e.geometry)B(t,new Vd(t[0].x,t[0].y,0,0,void 0),u);else if("Point"===e.type)for(const t of e.geometry)for(const e of t)B([e],new Vd(e.x,e.y,0,0,void 0),u)}const wp=255,Ap=wp*Nu;function Tp(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g){const _=function(t,e,i,n,r,s,o,a){const l=[];if(0===e.positionedLines.length)return l;const c=n.layout.get("text-rotate").evaluate(s,{})*Math.PI/180,h=function(t){const e=t[0],i=t[1],n=e*i;return n>0?[e,-i]:n<0?[-e,i]:0===e?[i,e]:[i,-e]}(i);let u=Math.abs(e.top-e.bottom);for(const t of e.positionedLines)u-=t.lineOffset;const d=e.positionedLines.length,p=u/d;let f=e.top-i[1];for(let t=0;t<d;++t){const n=e.positionedLines[t];f=cp(e,p,f,t);for(const t of n.positionedGlyphs){if(!t.rect)continue;const n=t.rect||{};let s=bd+1,u=!0,d=1,p=0;if(t.imageName){const e=o[t.imageName];if(!e)continue;if(e.sdf){H("SDF images are not supported in formatted text and will be ignored.");continue}u=!1,d=e.pixelRatio,s=Ad/d}const m=(r||a)&&t.vertical,g=t.metrics.advance*t.scale/2,_=t.metrics,v=t.rect;if(null===v)continue;a&&e.verticalizable&&(p=t.imageName?g-t.metrics.width*t.scale/2:0);const x=r?[t.x+g,t.y]:[0,0];let b=[0,0],w=[0,0],A=!1;r||(m?(w=[t.x+g+h[0],t.y+h[1]-p],A=!0):b=[t.x+g+i[0],t.y+i[1]-p]);const T=v.w*t.scale/(d*(t.localGlyph?tp:1)),M=v.h*t.scale/(d*(t.localGlyph?tp:1));let S,E,C,I;if(m){const e=t.y-f,i=new y(-g,g-e),n=-Math.PI/2,r=new y(...w);S=new y(-g+b[0],b[1]),S._rotateAround(n,i)._add(r),S.x+=-e+g,S.y-=(_.left-s)*t.scale;const o=t.imageName?_.advance*t.scale:zu*t.scale,a=String.fromCharCode(t.glyph);qu(a)?S.x+=(1-s)*t.scale:Xu(a)?S.x+=o-_.height*t.scale+(-s-1)*t.scale:S.x+=t.imageName||_.width+2*s===v.w&&_.height+2*s===v.h?(o-M)/2:(o-(_.height+2*s)*t.scale)/2,E=new y(S.x,S.y-T),C=new y(S.x+M,S.y),I=new y(S.x+M,S.y-T)}else{const e=(_.left-s)*t.scale-g+b[0],i=(-_.top-s)*t.scale+b[1],n=e+T,r=i+M;S=new y(e,i),E=new y(n,i),C=new y(e,r),I=new y(n,r)}if(c){let t;t=r?new y(0,0):A?new y(h[0],h[1]):new y(i[0],i[1]),S._rotateAround(c,t),E._rotateAround(c,t),C._rotateAround(c,t),I._rotateAround(c,t)}const P=new y(0,0),L=new y(0,0);l.push({tl:S,tr:E,bl:C,br:I,tex:n,writingMode:e.writingMode,glyphOffset:x,sectionIndex:t.sectionIndex,isSDF:u,pixelOffsetTL:P,pixelOffsetBR:L,minFontScaleX:0,minFontScaleY:0})}}return l}(0,n,l,s,o,a,r,t.allowVerticalPlacement),v=t.textSizeData;let x=null;"source"===v.kind?(x=[Nu*s.layout.get("text-size").evaluate(a,{},g)],x[0]>Ap&&H(`${t.layerIds[0]}: Value for "text-size" is >= ${wp}. Reduce your "text-size".`)):"composite"===v.kind&&(x=[Nu*f.compositeTextSizes[0].evaluate(a,{},g),Nu*f.compositeTextSizes[1].evaluate(a,{},g)],(x[0]>Ap||x[1]>Ap)&&H(`${t.layerIds[0]}: Value for "text-size" is >= ${wp}. Reduce your "text-size".`)),t.addSymbols(t.text,_,x,l,o,a,h,e,i,c.lineStartIndex,c.lineLength,p,m,g);for(const e of u)d[e]=t.text.placedSymbolArray.length-1;return 4*_.length}function Mp(t){for(const e in t)return t[e];return null}function Sp(t,e,i,n,r,s,o,a,l,c){let h=o.top,u=o.bottom,d=o.left,p=o.right;const f=o.collisionPadding;if(f&&(d-=f[0],h-=f[1],p+=f[2],u+=f[3]),l){const t=new y(d,h),e=new y(p,h),i=new y(d,u),n=new y(p,u),r=b(l);let s=new y(0,0);c&&(s=new y(c[0],c[1])),t._rotateAround(r,s),e._rotateAround(r,s),i._rotateAround(r,s),n._rotateAround(r,s),d=Math.min(t.x,e.x,i.x,n.x),p=Math.max(t.x,e.x,i.x,n.x),h=Math.min(t.y,e.y,i.y,n.y),u=Math.max(t.y,e.y,i.y,n.y)}return t.emplaceBack(e.x,e.y,e.z,i.x,i.y,d,h,p,u,a,n,r,s),t.length-1}function Ep(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function Cp(t,e,i,n){const r=t.compareText;if(e in r){const t=r[e];for(let e=t.length-1;e>=0;e--)if(n.dist(t[e])<i)return!0}else r[e]=[];return r[e].push(n),!1}function Ip(t,e){const i=t.fovAboveCenter,n=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,r=(t._camera.position[2]*t.worldSize-n)/Math.cos(t._pitch);return Math.sin(i),Math.sin(Math.max(Math.PI/2-t._pitch-i,.01)),Math.sin(t._pitch),Math.max(r*(1/t._horizonShift),r+1e3*t.pixelsPerMeter/Math.cos(t._pitch))}function Pp(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const i=Math.pow(2,-t.z),n=t.x*i,r=(t.x+1)*i,s=t.y*i,o=(t.y+1)*i,a=Xl(n),l=Xl(r),c=Zl(s),h=Zl(o),u=e.project(a,c),d=e.project(l,c),p=e.project(l,h),f=e.project(a,h);let m=Math.min(u.x,d.x,p.x,f.x),g=Math.min(u.y,d.y,p.y,f.y),_=Math.max(u.x,d.x,p.x,f.x),y=Math.max(u.y,d.y,p.y,f.y);const v=i/16;function x(t,i,n,r,s,o){const a=(n+s)/2,l=(r+o)/2,c=e.project(Xl(a),Zl(l)),h=Math.max(0,m-c.x,g-c.y,c.x-_,c.y-y);m=Math.min(m,c.x),_=Math.max(_,c.x),g=Math.min(g,c.y),y=Math.max(y,c.y),h>v&&(x(t,c,n,r,a,l),x(c,i,a,l,s,o))}x(u,d,n,s,r,s),x(d,p,r,s,r,o),x(p,f,r,o,n,o),x(f,u,n,o,n,s),m-=v,g-=v,_+=v,y+=v;const b=1/Math.max(_-m,y-g);return{scale:b,x:m*b,y:g*b,x2:_*b,y2:y*b,projection:e}}const Lp=pa(new Float32Array(16));class Rp{constructor(t){this.spec=t,this.name=t.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(t,e){return{x:0,y:0,z:0}}unproject(t,e){return new Vl(0,0)}projectTilePoint(t,e,i){return{x:t,y:e,z:0}}locationPoint(t,e,i=!0){return t._coordinatePoint(t.locationCoordinate(e),i)}pixelsPerMeter(t,e){return ql(1,t)*e}pixelSpaceConversion(t,e,i){return 1}farthestPixelDistance(t){return Ip(t,t.pixelsPerMeter)}pointCoordinate(t,e,i,n){const r=t.horizonLineFromTop(!1),s=new y(e,Math.max(r,i));return t.rayIntersectionCoordinate(t.pointRayIntersection(s,n))}pointCoordinate3D(t,e,i){const n=new y(e,i);if(t.elevation)return t.elevation.pointCoordinate(n);{const e=this.pointCoordinate(t,n.x,n.y,0);return[e.x,e.y,e.z]}}isPointAboveHorizon(t,e){if(t.elevation)return!this.pointCoordinate3D(t,e.x,e.y);const i=t.horizonLineFromTop();return e.y<i}createInversionMatrix(t,e){return Lp}createTileMatrix(t,e,i){let n,r,s;const o=i.canonical,a=pa(new Float64Array(16));if(this.isReprojectedInTileSpace){const l=Pp(o,this);n=1,r=l.x+i.wrap*l.scale,s=l.y,_a(a,a,[n/l.scale,n/l.scale,t.pixelsPerMeter/e])}else n=e/t.zoomScale(o.z),r=(o.x+Math.pow(2,o.z)*i.wrap)*n,s=o.y*n;return ga(a,a,[r,s,0]),_a(a,a,[n/aa,n/aa,1]),a}upVector(t,e,i){return[0,0,1]}upVectorScale(t,e,i){return{metersToTile:1}}}class Bp extends Rp{constructor(t){super(t),this.range=[4,7],this.center=t.center||[-96,37.5];const[e,i]=this.parallels=t.parallels||[29.5,45.5],n=Math.sin(b(e));this.n=(n+Math.sin(b(i)))/2,this.c=1+n*(2*this.n-n),this.r0=Math.sqrt(this.c)/this.n}project(t,e){const{n:i,c:n,r0:r}=this,s=b(t-this.center[0]),o=b(e),a=Math.sqrt(n-2*i*Math.sin(o))/i;return{x:a*Math.sin(s*i),y:a*Math.cos(s*i)-r,z:0}}unproject(t,e){const{n:i,c:n,r0:r}=this,s=r+e;let o=Math.atan2(t,Math.abs(s))*Math.sign(s);s*i<0&&(o-=Math.PI*Math.sign(t)*Math.sign(s));const a=b(this.center[0])*i;o=I(o,-Math.PI-a,Math.PI-a);const l=E(w(o/i)+this.center[0],-180,180),c=Math.asin(E((n-(t*t+s*s)*i*i)/(2*i),-1,1)),h=E(w(c),-Yl,Yl);return new Vl(l,h)}}const Dp=1.340264,Op=-.081106,kp=893e-6,Fp=.003796,zp=Math.sqrt(3)/2;class Np extends Rp{project(t,e){e=e/180*Math.PI,t=t/180*Math.PI;const i=Math.asin(zp*Math.sin(e)),n=i*i,r=n*n*n;return{x:.5*(t*Math.cos(i)/(zp*(Dp+3*Op*n+r*(7*kp+9*Fp*n)))/Math.PI+.5),y:1-.5*(i*(Dp+Op*n+r*(kp+Fp*n))/Math.PI+1),z:0}}unproject(t,e){t=(2*t-.5)*Math.PI;let i=e=(2*(1-e)-1)*Math.PI,n=i*i,r=n*n*n;for(let t,s,o,a=0;a<12&&(s=i*(Dp+Op*n+r*(kp+Fp*n))-e,o=Dp+3*Op*n+r*(7*kp+9*Fp*n),t=s/o,i=E(i-t,-Math.PI/3,Math.PI/3),n=i*i,r=n*n*n,!(Math.abs(t)<1e-12));++a);const s=zp*t*(Dp+3*Op*n+r*(7*kp+9*Fp*n))/Math.cos(i),o=Math.asin(Math.sin(i)/zp),a=E(180*s/Math.PI,-180,180),l=E(180*o/Math.PI,-Yl,Yl);return new Vl(a,l)}}class Up extends Rp{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0}project(t,e){return{x:.5+t/360,y:.5-e/360,z:0}}unproject(t,e){const i=360*(t-.5),n=E(360*(.5-e),-Yl,Yl);return new Vl(i,n)}}const Gp=Math.PI/2;function Vp(t){return Math.tan((Gp+t)/2)}class jp extends Rp{constructor(t){super(t),this.center=t.center||[0,30];const[e,i]=this.parallels=t.parallels||[30,30];let n=b(e),r=b(i);this.southernCenter=n+r<0,this.southernCenter&&(n=-n,r=-r);const s=Math.cos(n),o=Vp(n);this.n=n===r?Math.sin(n):Math.log(s/Math.cos(r))/Math.log(Vp(r)/o),this.f=s*Math.pow(Vp(n),this.n)/this.n}project(t,e){e=b(e),this.southernCenter&&(e=-e),t=b(t-this.center[0]);const i=1e-6,{n:n,f:r}=this;r>0?e<-Gp+i&&(e=-Gp+i):e>Gp-i&&(e=Gp-i);const s=r/Math.pow(Vp(e),n);let o=s*Math.sin(n*t),a=r-s*Math.cos(n*t);return o=.5*(o/Math.PI+.5),a=.5*(a/Math.PI+.5),{x:o,y:this.southernCenter?a:1-a,z:0}}unproject(t,e){t=(2*t-.5)*Math.PI,this.southernCenter&&(e=1-e),e=(2*(1-e)-.5)*Math.PI;const{n:i,f:n}=this,r=n-e,s=Math.sign(r),o=Math.sign(i)*Math.sqrt(t*t+r*r);let a=Math.atan2(t,Math.abs(r))*s;r*i<0&&(a-=Math.PI*Math.sign(t)*s);const l=E(w(a/i)+this.center[0],-180,180),c=E(w(2*Math.atan(Math.pow(n/o,1/i))-Gp),-Yl,Yl);return new Vl(l,this.southernCenter?-c:c)}}class Hp extends Rp{constructor(t){super(t),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(t,e){return{x:Hl(t),y:Wl(e),z:0}}unproject(t,e){const i=Xl(t),n=Zl(e);return new Vl(i,n)}}const Wp=b(Yl);class qp extends Rp{project(t,e){const i=(e=b(e))*e,n=i*i;return{x:.5*((t=b(t))*(.8707-.131979*i+n*(n*(.003971*i-.001529*n)-.013791))/Math.PI+.5),y:1-.5*(e*(1.007226+i*(.015085+n*(.028874*i-.044475-.005916*n)))/Math.PI+1),z:0}}unproject(t,e){t=(2*t-.5)*Math.PI;let i=e=(2*(1-e)-1)*Math.PI,n=25,r=0,s=i*i;do{s=i*i;const t=s*s;r=(i*(1.007226+s*(.015085+t*(.028874*s-.044475-.005916*t)))-e)/(1.007226+s*(.045255+t*(.259866*s-.311325-.005916*11*t))),i=E(i-r,-Wp,Wp)}while(Math.abs(r)>1e-6&&--n>0);s=i*i;const o=E(w(t/(.8707+s*(s*(s*s*s*(.003971-.001529*s)-.013791)-.131979))),-180,180),a=w(i);return new Vl(o,a)}}const Xp=b(Yl);class Zp extends Rp{project(t,e){e=b(e),t=b(t);const i=Math.cos(e),n=2/Math.PI,r=Math.acos(i*Math.cos(t/2)),s=Math.sin(r)/r,o=.5*(t*n+2*i*Math.sin(t/2)/s)||0,a=.5*(e+Math.sin(e)/s)||0;return{x:.5*(o/Math.PI+.5),y:1-.5*(a/Math.PI+1),z:0}}unproject(t,e){let i=t=(2*t-.5)*Math.PI,n=e=(2*(1-e)-1)*Math.PI,r=25;const s=1e-6;let o=0,a=0;do{const r=Math.cos(n),s=Math.sin(n),l=2*s*r,c=s*s,h=r*r,u=Math.cos(i/2),d=Math.sin(i/2),p=2*u*d,f=d*d,m=1-h*u*u,g=m?1/m:0,_=m?Math.acos(r*u)*Math.sqrt(1/m):0,y=.5*(2*_*r*d+2*i/Math.PI)-t,v=.5*(_*s+n)-e,x=.5*g*(h*f+_*r*u*c)+1/Math.PI,b=g*(p*l/4-_*s*d),w=.125*g*(l*d-_*s*h*p),A=.5*g*(c*u+_*f*r)+.5,T=b*w-A*x;o=(v*b-y*A)/T,a=(y*w-v*x)/T,i=E(i-o,-Math.PI,Math.PI),n=E(n-a,-Xp,Xp)}while((Math.abs(o)>s||Math.abs(a)>s)&&--r>0);return new Vl(w(i),w(n))}}class Jp extends Rp{constructor(t){super(t),this.center=t.center||[0,0],this.parallels=t.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(b(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(t,e){const{scale:i,cosPhi:n}=this;return{x:b(t)*n*i+.5,y:-Math.sin(b(e))/n*i+.5,z:0}}unproject(t,e){const{scale:i,cosPhi:n}=this,r=-(e-.5)/i,s=E(w((t-.5)/i)/n,-180,180),o=Math.asin(E(r*n,-1,1)),a=E(w(o),-Yl,Yl);return new Vl(s,a)}}class Yp extends Hp{constructor(t){super(t),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(t,e,i){const n=El(t,e,i);return Fa(n,n,Pl(yl(i))),{x:n[0],y:n[1],z:n[2]}}locationPoint(t,e){const i=Sl(e.lat,e.lng),n=Da([],i),r=t.elevation?t.elevation.getAtPointOrZero(t.locationCoordinate(e),t._centerAltitude):t._centerAltitude;Ba(i,i,n,ql(1,0)*aa*r);const s=pa(new Float64Array(16));return ma(s,t.pixelMatrix,t.globeMatrix),Fa(i,i,s),new y(i[0],i[1])}pixelsPerMeter(t,e){return ql(1,0)*e}pixelSpaceConversion(t,e,i){const n=ql(1,t)*e,r=Li(ql(1,45)*e,n,i);return this.pixelsPerMeter(t,e)/r}createTileMatrix(t,e,i){const n=Ll(yl(i.canonical));return ma(new Float64Array(16),t.globeMatrix,n)}createInversionMatrix(t,e){const{center:i}=t,n=Pl(yl(e));return va(n,n,b(i.lng)),ya(n,n,b(i.lat)),_a(n,n,[t._pixelsPerMercatorPixel,t._pixelsPerMercatorPixel,1]),Float32Array.from(n)}pointCoordinate(t,e,i,n){return ml(t,e,i,!0)||new Kl(0,0)}pointCoordinate3D(t,e,i){const n=this.pointCoordinate(t,e,i,0);return[n.x,n.y,n.z]}isPointAboveHorizon(t,e){return!ml(t,e.x,e.y,!1)}farthestPixelDistance(t){const e=function(t,e){const i=t.cameraToCenterDistance,n=t._centerAltitude*e,r=t._camera,s=t._camera.forward(),o=Ea([],Ra([],s,-i),[0,0,n]),a=t.worldSize/(2*Math.PI),l=[0,0,-a],c=t.width/t.height,h=Math.tan(t.fovAboveCenter),u=Ra([],r.up(),h),d=Ra([],r.right(),h*c),p=Da([],Ea([],Ea([],s,u),d)),f=[];let m;if(new el(o,p).closestPointOnSphere(l,a,f)){const e=Ea([],f,l),i=Ua([],e,o);m=Math.cos(t.fovAboveCenter)*Ma(i)}else{const t=Ua([],o,l),e=Ua([],l,o);Da(e,e);const i=Ma(t)-a;m=Math.sqrt(i*(i+2*a));const n=Math.acos(m/(a+i))-Math.acos(Oa(s,e));m*=Math.cos(n)}return 1.01*m}(t,this.pixelsPerMeter(t.center.lat,t.worldSize)),i=Bl(t.zoom);if(i>0){const n=Ip(t,ql(1,t.center.lat)*t.worldSize),r=t.worldSize/(2*Math.PI),s=Math.max(t.width,t.height)/t.worldSize*Math.PI;return Li(e,n+r*(1-Math.cos(s)),Math.pow(i,10))}return e}upVector(t,e,i){return El(e,i,t,1)}upVectorScale(t){return{metersToTile:fl(Cl(yl(t)))}}}function $p(t){const e=t.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(t.name){case"mercator":return new Hp(t);case"equirectangular":return new Up(t);case"naturalEarth":return new qp(t);case"equalEarth":return new Np(t);case"winkelTripel":return new Zp(t);case"albers":return i?new Jp(t):new Bp(t);case"lambertConformalConic":return i?new Jp(t):new jp(t);case"globe":return new Yp(t)}throw new Error(`Invalid projection name: ${t.name}`)}const Kp=Xh.types,Qp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function tf(t,e,i,n,r,s,o,a,l,c,h,u,d){const p=a?Math.min(Ap,Math.round(a[0])):0,f=a?Math.min(Ap,Math.round(a[1])):0;t.emplaceBack(e,i,Math.round(32*n),Math.round(32*r),s,o,(p<<1)+(l?1:0),f,16*c,16*h,256*u,256*d)}function ef(t,e,i,n,r,s,o){t.emplaceBack(e,i,n,r,s,o)}function nf(t,e,i,n,r){t.emplaceBack(e,i,n,r),t.emplaceBack(e,i,n,r),t.emplaceBack(e,i,n,r),t.emplaceBack(e,i,n,r)}function rf(t){for(const e of t.sections)if(ls(e.text))return!0;return!1}class sf{constructor(t){this.layoutVertexArray=new Zs,this.indexArray=new io,this.programConfigurations=t,this.segments=new oa,this.dynamicLayoutVertexArray=new Hs,this.opacityVertexArray=new Ys,this.placedSymbolArray=new mo,this.globeExtVertexArray=new Js}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length}upload(t,e,i,n){this.isEmpty()||(i&&(this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,Lu.members),this.indexBuffer=t.createIndexBuffer(this.indexArray,e),this.dynamicLayoutVertexBuffer=t.createVertexBuffer(this.dynamicLayoutVertexArray,Bu.members,!0),this.opacityVertexBuffer=t.createVertexBuffer(this.opacityVertexArray,Qp,!0),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=t.createVertexBuffer(this.globeExtVertexArray,Ru.members,!0)),this.opacityVertexBuffer.itemSize=1),(i||n)&&this.programConfigurations.upload(t))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}}Jr(sf,"SymbolBuffers");class of{constructor(t,e,i){this.layoutVertexArray=new t,this.layoutAttributes=e,this.indexArray=new i,this.segments=new oa,this.collisionVertexArray=new to,this.collisionVertexArrayExt=new eo}upload(t){this.layoutVertexBuffer=t.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=t.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=t.createVertexBuffer(this.collisionVertexArray,Du.members,!0),this.collisionVertexBufferExt=t.createVertexBuffer(this.collisionVertexArrayExt,Ou.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Jr(of,"CollisionBuffers");class af{constructor(t){this.collisionBoxArray=t.collisionBoxArray,this.zoom=t.zoom,this.overscaling=t.overscaling,this.layers=t.layers,this.layerIds=this.layers.map((t=>t.id)),this.index=t.index,this.pixelRatio=t.pixelRatio,this.sourceLayerIndex=t.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=pa([]),this.placementViewportMatrix=pa([]);const e=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Uu(this.zoom,e["text-size"]),this.iconSizeData=Uu(this.zoom,e["icon-size"]);const i=this.layers[0].layout,n=i.get("symbol-sort-key"),r=i.get("symbol-z-order");this.canOverlap=i.get("text-allow-overlap")||i.get("icon-allow-overlap")||i.get("text-ignore-placement")||i.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==r&&void 0!==n.constantOr(1),this.sortFeaturesByY=("viewport-y"===r||"auto"===r&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=i.get("text-writing-mode").map((t=>Sd[t])),this.stateDependentLayerIds=this.layers.filter((t=>t.isStateDependent())).map((t=>t.id)),this.sourceID=t.sourceID,this.projection=t.projection}createArrays(){this.text=new sf(new Yo(this.layers,this.zoom,(t=>/^text/.test(t)))),this.icon=new sf(new Yo(this.layers,this.zoom,(t=>/^icon/.test(t)))),this.glyphOffsetArray=new yo,this.lineVertexArray=new vo,this.symbolInstances=new _o}calculateGlyphDependencies(t,e,i,n,r){for(let i=0;i<t.length;i++)if(e[t.charCodeAt(i)]=!0,n&&r){const n=Wu[t.charAt(i)];n&&(e[n.charCodeAt(0)]=!0)}}populate(t,e,i,n){const r=this.layers[0],s=r.layout,o="globe"===this.projection.name,a=s.get("text-font"),l=s.get("text-field"),c=s.get("icon-image"),h=("constant"!==l.value.kind||l.value.value instanceof De&&!l.value.value.isEmpty()||l.value.value.toString().length>0)&&("constant"!==a.value.kind||a.value.value.length>0),u="constant"!==c.value.kind||!!c.value.value||Object.keys(c.parameters).length>0,d=s.get("symbol-sort-key");if(this.features=[],!h&&!u)return;const p=e.iconDependencies,f=e.glyphDependencies,m=e.availableImages,g=new bs(this.zoom);for(const{feature:e,id:l,index:c,sourceLayerIndex:_}of t){const t=r._featureFilter.needGeometry,y=ac(e,t);if(!r._featureFilter.filter(g,y,i))continue;if(t||(y.geometry=oc(e,i,n)),o&&1!==e.type&&i.z<=5){const t=y.geometry,e=.98078528056,n=(t,n)=>Oa(El(t.x,t.y,i,1),El(n.x,n.y,i,1))<e;for(let e=0;e<t.length;e++)t[e]=ic(t[e],n)}let v,x;if(h){const t=r.getValueAndResolveTokens("text-field",y,i,m),e=De.factory(t);rf(e)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===ys()||this.hasRTLText&&xs.isParsed())&&(v=Hu(e,r,y))}if(u){const t=r.getValueAndResolveTokens("icon-image",y,i,m);x=t instanceof Oe?t:Oe.fromString(t)}if(!v&&!x)continue;const b=this.sortFeaturesByKey?d.evaluate(y,{},i):void 0;if(this.features.push({id:l,text:v,icon:x,index:c,sourceLayerIndex:_,geometry:y.geometry,properties:e.properties,type:Kp[e.type],sortKey:b}),x&&(p[x.name]=!0),v){const t=a.evaluate(y,{},i).join(","),e="map"===s.get("text-rotation-alignment")&&"point"!==s.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Sd.vertical)>=0;for(const i of v.sections)if(i.image)p[i.image.name]=!0;else{const n=es(v.toString()),r=i.fontStack||t,s=f[r]=f[r]||{};this.calculateGlyphDependencies(i.text,s,e,this.allowVerticalPlacement,n)}}}"line"===s.get("symbol-placement")&&(this.features=function(t){const e={},i={},n=[];let r=0;function s(e){n.push(t[e]),r++}function o(t,e,r){const s=i[t];return delete i[t],i[e]=s,n[s].geometry[0].pop(),n[s].geometry[0]=n[s].geometry[0].concat(r[0]),s}function a(t,i,r){const s=e[i];return delete e[i],e[t]=s,n[s].geometry[0].shift(),n[s].geometry[0]=r[0].concat(n[s].geometry[0]),s}function l(t,e,i){const n=i?e[0][e[0].length-1]:e[0][0];return`${t}:${n.x}:${n.y}`}for(let c=0;c<t.length;c++){const h=t[c],u=h.geometry,d=h.text?h.text.toString():null;if(!d){s(c);continue}const p=l(d,u),f=l(d,u,!0);if(p in i&&f in e&&i[p]!==e[f]){const t=a(p,f,u),r=o(p,f,n[t].geometry);delete e[p],delete i[f],i[l(d,n[r].geometry,!0)]=r,n[t].geometry=null}else p in i?o(p,f,u):f in e?a(p,f,u):(s(c),e[p]=r-1,i[f]=r-1)}return n.filter((t=>t.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((t,e)=>t.sortKey-e.sortKey))}update(t,e,i,n){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(t,e,this.layers,i,n),this.icon.programConfigurations.updatePaintArrays(t,e,this.layers,i,n))}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(t){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(t),this.iconCollisionBox.upload(t)),this.text.upload(t,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(t,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=$p(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(t,e){const i=this.lineVertexArray.length;if(void 0!==t.segment)for(const{x:t,y:i}of e)this.lineVertexArray.emplaceBack(t,i);return{lineStartIndex:i,lineLength:this.lineVertexArray.length-i}}addSymbols(t,e,i,n,r,s,o,a,l,c,h,u,d,p){const f=t.indexArray,m=t.layoutVertexArray,g=t.globeExtVertexArray,_=t.segments.prepareSegment(4*e.length,m,f,this.canOverlap?s.sortKey:void 0),y=this.glyphOffsetArray.length,v=_.vertexLength,x=this.allowVerticalPlacement&&o===Sd.vertical?Math.PI/2:0,b=s.text&&s.text.sections;for(let n=0;n<e.length;n++){const{tl:r,tr:o,bl:c,br:h,tex:u,pixelOffsetTL:y,pixelOffsetBR:v,minFontScaleX:w,minFontScaleY:A,glyphOffset:T,isSDF:M,sectionIndex:S}=e[n],E=_.vertexLength,C=T[1];if(tf(m,l.x,l.y,r.x,C+r.y,u.x,u.y,i,M,y.x,y.y,w,A),tf(m,l.x,l.y,o.x,C+o.y,u.x+u.w,u.y,i,M,v.x,y.y,w,A),tf(m,l.x,l.y,c.x,C+c.y,u.x,u.y+u.h,i,M,y.x,v.y,w,A),tf(m,l.x,l.y,h.x,C+h.y,u.x+u.w,u.y+u.h,i,M,v.x,v.y,w,A),a){const{x:e,y:i,z:n}=a.anchor,[r,s,o]=a.up;ef(g,e,i,n,r,s,o),ef(g,e,i,n,r,s,o),ef(g,e,i,n,r,s,o),ef(g,e,i,n,r,s,o),nf(t.dynamicLayoutVertexArray,e,i,n,x)}else nf(t.dynamicLayoutVertexArray,l.x,l.y,l.z,x);f.emplaceBack(E,E+1,E+2),f.emplaceBack(E+1,E+2,E+3),_.vertexLength+=4,_.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(T[0]),n!==e.length-1&&S===e[n+1].sectionIndex||t.programConfigurations.populatePaintArrays(m.length,s,s.index,{},d,p,b&&b[S])}const w=a?a.anchor:l;t.placedSymbolArray.emplaceBack(w.x,w.y,w.z,l.x,l.y,y,this.glyphOffsetArray.length-y,v,c,h,l.segment,i?i[0]:0,i?i[1]:0,n[0],n[1],o,0,!1,0,u,0)}_commitLayoutVertex(t,e,i,n,r,s,o){t.emplaceBack(e,i,n,r,s,Math.round(o.x),Math.round(o.y))}_addCollisionDebugVertices(t,e,i,n,r,s,o){const a=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),l=a.vertexLength,c=o.tileAnchorX,h=o.tileAnchorY;for(let t=0;t<4;t++)i.collisionVertexArray.emplaceBack(0,0,0,0);i.collisionVertexArrayExt.emplaceBack(e,-t.padding,-t.padding),i.collisionVertexArrayExt.emplaceBack(e,t.padding,-t.padding),i.collisionVertexArrayExt.emplaceBack(e,t.padding,t.padding),i.collisionVertexArrayExt.emplaceBack(e,-t.padding,t.padding),this._commitLayoutVertex(i.layoutVertexArray,n,r,s,c,h,new y(t.x1,t.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,s,c,h,new y(t.x2,t.y1)),this._commitLayoutVertex(i.layoutVertexArray,n,r,s,c,h,new y(t.x2,t.y2)),this._commitLayoutVertex(i.layoutVertexArray,n,r,s,c,h,new y(t.x1,t.y2)),a.vertexLength+=4;const u=i.indexArray;u.emplaceBack(l,l+1),u.emplaceBack(l+1,l+2),u.emplaceBack(l+2,l+3),u.emplaceBack(l+3,l),a.primitiveLength+=4}_addTextDebugCollisionBoxes(t,e,i,n,r,s){for(let o=n;o<r;o++){const n=i.get(o),r=this.getSymbolInstanceTextSize(t,s,e,o);this._addCollisionDebugVertices(n,r,this.textCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,s)}}_addIconDebugCollisionBoxes(t,e,i,n,r,s){for(let o=n;o<r;o++){const n=i.get(o),r=this.getSymbolInstanceIconSize(t,e,s.placedIconSymbolIndex);this._addCollisionDebugVertices(n,r,this.iconCollisionBox,n.projectedAnchorX,n.projectedAnchorY,n.projectedAnchorZ,s)}}generateCollisionDebugBuffers(t,e){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new of(Ks,ku.members,lo),this.iconCollisionBox=new of(Ks,ku.members,lo);const i=Vu(this.iconSizeData,t),n=Vu(this.textSizeData,t);for(let r=0;r<this.symbolInstances.length;r++){const s=this.symbolInstances.get(r);this._addTextDebugCollisionBoxes(n,t,e,s.textBoxStartIndex,s.textBoxEndIndex,s),this._addTextDebugCollisionBoxes(n,t,e,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s),this._addIconDebugCollisionBoxes(i,t,e,s.iconBoxStartIndex,s.iconBoxEndIndex,s),this._addIconDebugCollisionBoxes(i,t,e,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex,s)}}getSymbolInstanceTextSize(t,e,i,n){const r=this.text.placedSymbolArray.get(e.rightJustifiedTextSymbolIndex>=0?e.rightJustifiedTextSymbolIndex:e.centerJustifiedTextSymbolIndex>=0?e.centerJustifiedTextSymbolIndex:e.leftJustifiedTextSymbolIndex>=0?e.leftJustifiedTextSymbolIndex:e.verticalPlacedTextSymbolIndex>=0?e.verticalPlacedTextSymbolIndex:n),s=Gu(this.textSizeData,t,r)/zu;return this.tilePixelRatio*s}getSymbolInstanceIconSize(t,e,i){const n=this.icon.placedSymbolArray.get(i),r=Gu(this.iconSizeData,t,n);return this.tilePixelRatio*r}_commitDebugCollisionVertexUpdate(t,e,i){t.emplaceBack(e,-i,-i),t.emplaceBack(e,i,-i),t.emplaceBack(e,i,i),t.emplaceBack(e,-i,i)}_updateTextDebugCollisionBoxes(t,e,i,n,r,s){for(let o=n;o<r;o++){const n=i.get(o),r=this.getSymbolInstanceTextSize(t,s,e,o);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,r,n.padding)}}_updateIconDebugCollisionBoxes(t,e,i,n,r,s){for(let o=n;o<r;o++){const n=i.get(o),r=this.getSymbolInstanceIconSize(t,e,s);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,r,n.padding)}}updateCollisionDebugBuffers(t,e){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const i=Vu(this.iconSizeData,t),n=Vu(this.textSizeData,t);for(let r=0;r<this.symbolInstances.length;r++){const s=this.symbolInstances.get(r);this._updateTextDebugCollisionBoxes(n,t,e,s.textBoxStartIndex,s.textBoxEndIndex,s),this._updateTextDebugCollisionBoxes(n,t,e,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s),this._updateIconDebugCollisionBoxes(i,t,e,s.iconBoxStartIndex,s.iconBoxEndIndex,s.placedIconSymbolIndex),this._updateIconDebugCollisionBoxes(i,t,e,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex,s.placedIconSymbolIndex)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(t,e,i,n,r,s,o,a,l){const c={};if(e<i){const{x1:i,y1:n,x2:r,y2:s,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d,featureIndex:p}=t.get(e);c.textBox={x1:i,y1:n,x2:r,y2:s,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d},c.textFeatureIndex=p}if(n<r){const{x1:e,y1:i,x2:r,y2:s,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d,featureIndex:p}=t.get(n);c.verticalTextBox={x1:e,y1:i,x2:r,y2:s,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d},c.verticalTextFeatureIndex=p}if(s<o){const{x1:e,y1:i,x2:n,y2:r,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d,featureIndex:p}=t.get(s);c.iconBox={x1:e,y1:i,x2:n,y2:r,padding:o,projectedAnchorX:a,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d},c.iconFeatureIndex=p}if(a<l){const{x1:e,y1:i,x2:n,y2:r,padding:s,projectedAnchorX:o,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d,featureIndex:p}=t.get(a);c.verticalIconBox={x1:e,y1:i,x2:n,y2:r,padding:s,projectedAnchorX:o,projectedAnchorY:l,projectedAnchorZ:h,tileAnchorX:u,tileAnchorY:d},c.verticalIconFeatureIndex=p}return c}deserializeCollisionBoxes(t){this.collisionArrays=[];for(let e=0;e<this.symbolInstances.length;e++){const i=this.symbolInstances.get(e);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(t,i.textBoxStartIndex,i.textBoxEndIndex,i.verticalTextBoxStartIndex,i.verticalTextBoxEndIndex,i.iconBoxStartIndex,i.iconBoxEndIndex,i.verticalIconBoxStartIndex,i.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(t,e){const i=t.placedSymbolArray.get(e),n=i.vertexStartIndex+4*i.numGlyphs;for(let e=i.vertexStartIndex;e<n;e+=4)t.indexArray.emplaceBack(e,e+1,e+2),t.indexArray.emplaceBack(e+1,e+2,e+3)}getSortedSymbolIndexes(t){if(this.sortedAngle===t&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const e=Math.sin(t),i=Math.cos(t),n=[],r=[],s=[];for(let t=0;t<this.symbolInstances.length;++t){s.push(t);const o=this.symbolInstances.get(t);n.push(0|Math.round(e*o.tileAnchorX+i*o.tileAnchorY)),r.push(o.featureIndex)}return s.sort(((t,e)=>n[t]-n[e]||r[e]-r[t])),s}addToSortKeyRanges(t,e){const i=this.sortKeyRanges[this.sortKeyRanges.length-1];i&&i.sortKey===e?i.symbolInstanceEnd=t+1:this.sortKeyRanges.push({sortKey:e,symbolInstanceStart:t,symbolInstanceEnd:t+1})}sortFeatures(t){if(this.sortFeaturesByY&&this.sortedAngle!==t&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(t),this.sortedAngle=t,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const t of this.symbolInstanceIndexes){const e=this.symbolInstances.get(t);this.featureSortOrder.push(e.featureIndex);const{rightJustifiedTextSymbolIndex:i,centerJustifiedTextSymbolIndex:n,leftJustifiedTextSymbolIndex:r,verticalPlacedTextSymbolIndex:s,placedIconSymbolIndex:o,verticalPlacedIconSymbolIndex:a}=e;i>=0&&this.addIndicesForPlacedSymbol(this.text,i),n>=0&&n!==i&&this.addIndicesForPlacedSymbol(this.text,n),r>=0&&r!==n&&r!==i&&this.addIndicesForPlacedSymbol(this.text,r),s>=0&&this.addIndicesForPlacedSymbol(this.text,s),o>=0&&this.addIndicesForPlacedSymbol(this.icon,o),a>=0&&this.addIndicesForPlacedSymbol(this.icon,a)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Jr(af,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),af.MAX_GLYPHS=65535,af.addDynamicAttributes=nf;const lf=new Bs({"symbol-placement":new Ps(te.layout_symbol["symbol-placement"]),"symbol-spacing":new Ps(te.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Ps(te.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ls(te.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Ps(te.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new Ps(te.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Ps(te.layout_symbol["icon-ignore-placement"]),"icon-optional":new Ps(te.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Ps(te.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ls(te.layout_symbol["icon-size"]),"icon-text-fit":new Ps(te.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ps(te.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ls(te.layout_symbol["icon-image"]),"icon-rotate":new Ls(te.layout_symbol["icon-rotate"]),"icon-padding":new Ps(te.layout_symbol["icon-padding"]),"icon-keep-upright":new Ps(te.layout_symbol["icon-keep-upright"]),"icon-offset":new Ls(te.layout_symbol["icon-offset"]),"icon-anchor":new Ls(te.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Ps(te.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Ps(te.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Ps(te.layout_symbol["text-rotation-alignment"]),"text-field":new Ls(te.layout_symbol["text-field"]),"text-font":new Ls(te.layout_symbol["text-font"]),"text-size":new Ls(te.layout_symbol["text-size"]),"text-max-width":new Ls(te.layout_symbol["text-max-width"]),"text-line-height":new Ls(te.layout_symbol["text-line-height"]),"text-letter-spacing":new Ls(te.layout_symbol["text-letter-spacing"]),"text-justify":new Ls(te.layout_symbol["text-justify"]),"text-radial-offset":new Ls(te.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Ps(te.layout_symbol["text-variable-anchor"]),"text-anchor":new Ls(te.layout_symbol["text-anchor"]),"text-max-angle":new Ps(te.layout_symbol["text-max-angle"]),"text-writing-mode":new Ps(te.layout_symbol["text-writing-mode"]),"text-rotate":new Ls(te.layout_symbol["text-rotate"]),"text-padding":new Ps(te.layout_symbol["text-padding"]),"text-keep-upright":new Ps(te.layout_symbol["text-keep-upright"]),"text-transform":new Ls(te.layout_symbol["text-transform"]),"text-offset":new Ls(te.layout_symbol["text-offset"]),"text-allow-overlap":new Ps(te.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Ps(te.layout_symbol["text-ignore-placement"]),"text-optional":new Ps(te.layout_symbol["text-optional"])});var cf={paint:new Bs({"icon-opacity":new Ls(te.paint_symbol["icon-opacity"]),"icon-color":new Ls(te.paint_symbol["icon-color"]),"icon-halo-color":new Ls(te.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ls(te.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ls(te.paint_symbol["icon-halo-blur"]),"icon-translate":new Ps(te.paint_symbol["icon-translate"]),"icon-translate-anchor":new Ps(te.paint_symbol["icon-translate-anchor"]),"text-opacity":new Ls(te.paint_symbol["text-opacity"]),"text-color":new Ls(te.paint_symbol["text-color"],{runtimeType:de,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new Ls(te.paint_symbol["text-halo-color"]),"text-halo-width":new Ls(te.paint_symbol["text-halo-width"]),"text-halo-blur":new Ls(te.paint_symbol["text-halo-blur"]),"text-translate":new Ps(te.paint_symbol["text-translate"]),"text-translate-anchor":new Ps(te.paint_symbol["text-translate-anchor"])}),layout:lf};class hf{constructor(t){this.type=t.property.overrides?t.property.overrides.runtimeType:le,this.defaultValue=t}evaluate(t){if(t.formattedSection){const e=this.defaultValue.property.overrides;if(e&&e.hasOverride(t.formattedSection))return e.getOverride(t.formattedSection)}return t.feature&&t.featureState?this.defaultValue.evaluate(t.feature,t.featureState):this.defaultValue.property.specification.default}eachChild(t){this.defaultValue.isConstant()||t(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Jr(hf,"FormatSectionOverride",{omit:["defaultValue"]});class uf extends na{constructor(t){super(t,cf)}recalculate(t,e){super.recalculate(t,e),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const i=this.layout.get("text-writing-mode");if(i){const t=[];for(const e of i)t.indexOf(e)<0&&t.push(e);this.layout._values["text-writing-mode"]=t}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getValueAndResolveTokens(t,e,i,n){const r=this.layout.get(t).evaluate(e,{},i,n),s=this._unevaluatedLayout._values[t];return s.isDataDriven()||Jn(s.value)||!r?r:function(t,e){return e.replace(/{([^{}]+)}/g,((e,i)=>i in t?String(t[i]):""))}(e.properties,r)}createBucket(t){return new af(t)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const t of cf.paint.overridableProperties){if(!uf.hasPaintOverride(this.layout,t))continue;const e=this.paint.get(t),i=new hf(e),n=new Zn(i,e.property.specification);let r=null;r="constant"===e.value.kind||"source"===e.value.kind?new $n("source",n):new Kn("composite",n,e.value.zoomStops,e.value._interpolationType),this.paint._values[t]=new Cs(e.property,r,e.parameters)}}_handleOverridablePaintPropertyUpdate(t,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven())&&uf.hasPaintOverride(this.layout,t)}static hasPaintOverride(t,e){const i=t.get("text-field"),n=cf.paint.properties[e];let r=!1;const s=t=>{for(const e of t)if(n.overrides&&n.overrides.hasOverride(e))return void(r=!0)};if("constant"===i.value.kind&&i.value.value instanceof De)s(i.value.value.sections);else if("source"===i.value.kind){const t=e=>{r||(e instanceof Ge&&ze(e.value)===ge?s(e.value.sections):e instanceof qe?s(e.sections):e.eachChild(t))},e=i.value;e._styleExpression&&t(e._styleExpression.expression)}return r}getProgramConfiguration(t){return new Jo(this,t)}}var df={paint:new Bs({"background-color":new Ps(te.paint_background["background-color"]),"background-pattern":new Ps(te.paint_background["background-pattern"]),"background-opacity":new Ps(te.paint_background["background-opacity"])})},pf={paint:new Bs({"raster-opacity":new Ps(te.paint_raster["raster-opacity"]),"raster-hue-rotate":new Ps(te.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Ps(te.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Ps(te.paint_raster["raster-brightness-max"]),"raster-saturation":new Ps(te.paint_raster["raster-saturation"]),"raster-contrast":new Ps(te.paint_raster["raster-contrast"]),"raster-resampling":new Ps(te.paint_raster["raster-resampling"]),"raster-fade-duration":new Ps(te.paint_raster["raster-fade-duration"])})};class ff extends na{constructor(t){super(t,{}),this.implementation=t}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isLayerDraped(){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(t){this.implementation.onAdd&&this.implementation.onAdd(t,t.painter.context.gl)}onRemove(t){this.implementation.onRemove&&this.implementation.onRemove(t,t.painter.context.gl)}}var mf={paint:new Bs({"sky-type":new Ps(te.paint_sky["sky-type"]),"sky-atmosphere-sun":new Ps(te.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Ps(te.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Ps(te.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Ps(te.paint_sky["sky-gradient-radius"]),"sky-gradient":new Rs(te.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Ps(te.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Ps(te.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Ps(te.paint_sky["sky-opacity"])})};function gf(t,e,i){const n=[0,0,1],r=Xa([]);return Ja(r,r,i?-b(t)+Math.PI:b(t)),Za(r,r,-b(e)),za(n,n,r),Da(n,n)}const _f={circle:class extends na{constructor(t){super(t,Cc)}createBucket(t){return new hc(t)}queryRadius(t){const e=t;return Ac("circle-radius",this,e)+Ac("circle-stroke-width",this,e)+Tc(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,i,n,r,s,o,a){const l=Sc(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),s.angle,t.pixelToTileUnitsFactor),c=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return Ic(t,n,s,o,a,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),l,c)}getProgramIds(){return["circle"]}getProgramConfiguration(t){return new Jo(this,t)}},heatmap:class extends na{createBucket(t){return new Dc(t)}constructor(t){super(t,Uc),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){"heatmap-color"===t&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Gc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return Ac("heatmap-radius",this,t)}queryIntersectsFeature(t,e,i,n,r,s,o,a){const l=this.paint.get("heatmap-radius").evaluate(e,i);return Ic(t,n,s,o,a,!0,!0,new y(0,0),l)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getProgramConfiguration(t){return new Jo(this,t)}},hillshade:class extends na{constructor(t){super(t,Vc)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}},fill:class extends na{constructor(t){super(t,Ih)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getProgramConfiguration(t){return new Jo(this,t)}recalculate(t,e){super.recalculate(t,e);const i=this.paint._values["fill-outline-color"];"constant"===i.value.kind&&void 0===i.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new Eh(t)}queryRadius(){return Tc(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,i,n,r,s){return!t.queryGeometry.isAboveHorizon&&pc(Mc(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),s.angle,t.pixelToTileUnitsFactor),n)}isTileClipped(){return!0}},"fill-extrusion":class extends na{constructor(t){super(t,hu)}createBucket(t){return new tu(t)}queryRadius(){return Tc(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}getProgramConfiguration(t){return new Jo(this,t)}queryIntersectsFeature(t,e,i,n,r,s,o,a,l){const c=Sc(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),s.angle,t.pixelToTileUnitsFactor),h=this.paint.get("fill-extrusion-height").evaluate(e,i),u=this.paint.get("fill-extrusion-base").evaluate(e,i),d=[0,0],p=a&&s.elevation,f=s.elevation?s.elevation.exaggeration():1,m=t.tile.getBucket(this);if(p&&m instanceof tu){const t=m.centroidVertexArray,e=l+1;e<t.length&&(d[0]=t.geta_centroid_pos0(e),d[1]=t.geta_centroid_pos1(e))}if(0===d[0]&&1===d[1])return!1;"globe"===s.projection.name&&(n=lu([n],[new y(0,0),new y(aa,aa)],t.tileID.canonical).map((t=>t.polygon)).flat());const g=p?a:null,[_,v]=function(t,e,i,n,r,s,o,a,l,c,h){return"globe"===t.projection.name?function(t,e,i,n,r,s,o,a,l,c,h){const u=[],d=[],p=t.projection.upVectorScale(h,t.center.lat,t.worldSize).metersToTile,f=[0,0,0,1],m=[0,0,0,1],g=(t,e,i,n)=>{t[0]=e,t[1]=i,t[2]=n,t[3]=1},_=au();i>0&&(i+=_),n+=_;for(const _ of e){const e=[],y=[];for(const u of _){const d=u.x+r.x,_=u.y+r.y,v=t.projection.projectTilePoint(d,_,h),x=t.projection.upVector(h,u.x,u.y);let b=i,w=n;if(o){const t=vu(d,_,i,n,o,a,l,c);b+=t.base,w+=t.top}0!==i?g(f,v.x+x[0]*p*b,v.y+x[1]*p*b,v.z+x[2]*p*b):g(f,v.x,v.y,v.z),g(m,v.x+x[0]*p*w,v.y+x[1]*p*w,v.z+x[2]*p*w),Fa(f,f,s),Fa(m,m,s),e.push(new gu(f[0],f[1],f[2])),y.push(new gu(m[0],m[1],m[2]))}u.push(e),d.push(y)}return[u,d]}(t,e,i,n,r,s,o,a,l,c,h):o?function(t,e,i,n,r,s,o,a,l){const c=[],h=[],u=[0,0,0,1];for(const d of t){const t=[],p=[];for(const c of d){const h=c.x+n.x,d=c.y+n.y,f=vu(h,d,e,i,s,o,a,l);u[0]=h,u[1]=d,u[2]=f.base,u[3]=1,Wa(u,u,r),u[3]=Math.max(u[3],1e-5);const m=new gu(u[0]/u[3],u[1]/u[3],u[2]/u[3]);u[0]=h,u[1]=d,u[2]=f.top,u[3]=1,Wa(u,u,r),u[3]=Math.max(u[3],1e-5);const g=new gu(u[0]/u[3],u[1]/u[3],u[2]/u[3]);t.push(m),p.push(g)}c.push(t),h.push(p)}return[c,h]}(e,i,n,r,s,o,a,l,c):function(t,e,i,n,r){const s=[],o=[],a=r[8]*e,l=r[9]*e,c=r[10]*e,h=r[11]*e,u=r[8]*i,d=r[9]*i,p=r[10]*i,f=r[11]*i;for(const e of t){const t=[],i=[];for(const s of e){const e=s.x+n.x,o=s.y+n.y,m=r[0]*e+r[4]*o+r[12],g=r[1]*e+r[5]*o+r[13],_=r[2]*e+r[6]*o+r[14],y=r[3]*e+r[7]*o+r[15],v=m+a,x=g+l,b=_+c,w=Math.max(y+h,1e-5),A=m+u,T=g+d,M=_+p,S=Math.max(y+f,1e-5);t.push(new gu(v/w,x/w,b/w)),i.push(new gu(A/S,T/S,M/S))}s.push(t),o.push(i)}return[s,o]}(e,i,n,r,s)}(s,n,u,h,c,o,g,d,f,s.center.lat,t.tileID.canonical),x=t.queryGeometry;return function(t,e,i){let n=1/0;pc(i,e)&&(n=yu(i,e[0]));for(let r=0;r<e.length;r++){const s=e[r],o=t[r];for(let t=0;t<s.length-1;t++){const e=s[t],r=[e,s[t+1],o[t+1],o[t],e];uc(i,r)&&(n=Math.min(n,yu(i,r)))}}return n!==1/0&&n}(_,v,x.isPointQuery()?x.screenBounds:x.screenGeometry)}},line:class extends na{constructor(t){super(t,Cu),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if("line-gradient"===t){const t=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=t._styleExpression&&t._styleExpression.expression instanceof Pi,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=Iu.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new Su(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getProgramConfiguration(t){return new Jo(this,t)}queryRadius(t){const e=t,i=Pu(Ac("line-width",this,e),Ac("line-gap-width",this,e)),n=Ac("line-offset",this,e);return i/2+Math.abs(n)+Tc(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,i,n,r,s){if(t.queryGeometry.isAboveHorizon)return!1;const o=Mc(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),s.angle,t.pixelToTileUnitsFactor),a=t.pixelToTileUnitsFactor/2*Pu(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),l=this.paint.get("line-offset").evaluate(e,i);return l&&(n=function(t,e){const i=[],n=new y(0,0);for(let r=0;r<t.length;r++){const s=t[r],o=[];for(let t=0;t<s.length;t++){const i=s[t],r=s[t+1],a=0===t?n:i.sub(s[t-1])._unit()._perp(),l=t===s.length-1?n:r.sub(i)._unit()._perp(),c=a._add(l)._unit();c._mult(1/(c.x*l.x+c.y*l.y)),o.push(c._mult(e)._add(i))}i.push(o)}return i}(n,l*t.pixelToTileUnitsFactor)),function(t,e,i){for(let n=0;n<e.length;n++){const r=e[n];if(t.length>=3)for(let e=0;e<r.length;e++)if(xc(t,r[e]))return!0;if(fc(t,r,i))return!0}return!1}(o,n,a)}isTileClipped(){return!0}},symbol:uf,background:class extends na{constructor(t){super(t,df)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}},raster:class extends na{constructor(t){super(t,pf)}getProgramIds(){return["raster"]}},sky:class extends na{constructor(t){super(t,mf),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){"sky-gradient"===t?this._updateColorRamp():"sky-atmosphere-sun"!==t&&"sky-atmosphere-halo-color"!==t&&"sky-atmosphere-color"!==t&&"sky-atmosphere-sun-intensity"!==t||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Gc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(t,e){if("atmosphere"===this.paint.get("sky-type")){const i=this.paint.get("sky-atmosphere-sun"),n=!i,r=t.style.light,s=r.properties.get("position");return n&&"viewport"===r.properties.get("anchor")&&H("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),n?gf(s.azimuthal,90-s.polar,e):gf(i[0],90-i[1],e)}const i=this.paint.get("sky-gradient-center");return gf(i[0],90-i[1],e)}is3D(){return!1}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return"atmosphere"===t?["skyboxCapture","skybox"]:"gradient"===t?["skyboxGradient"]:null}}};class yf{constructor(t,e,i,n){this.context=t,this.format=i,this.texture=t.gl.createTexture(),this.update(e,n)}update(t,i,n){const{width:r,height:s}=t,{context:o}=this,{gl:a}=o,{HTMLImageElement:l,HTMLCanvasElement:c,HTMLVideoElement:h,ImageData:u,ImageBitmap:d}=e;if(a.bindTexture(a.TEXTURE_2D,this.texture),o.pixelStoreUnpackFlipY.set(!1),o.pixelStoreUnpack.set(1),o.pixelStoreUnpackPremultiplyAlpha.set(this.format===a.RGBA&&(!i||!1!==i.premultiply)),n||this.size&&this.size[0]===r&&this.size[1]===s){const{x:e,y:i}=n||{x:0,y:0};t instanceof l||t instanceof c||t instanceof h||t instanceof u||d&&t instanceof d?a.texSubImage2D(a.TEXTURE_2D,0,e,i,a.RGBA,a.UNSIGNED_BYTE,t):a.texSubImage2D(a.TEXTURE_2D,0,e,i,r,s,a.RGBA,a.UNSIGNED_BYTE,t.data)}else this.size=[r,s],t instanceof l||t instanceof c||t instanceof h||t instanceof u||d&&t instanceof d?a.texImage2D(a.TEXTURE_2D,0,this.format,this.format,a.UNSIGNED_BYTE,t):a.texImage2D(a.TEXTURE_2D,0,this.format,r,s,0,this.format,a.UNSIGNED_BYTE,t.data);this.useMipmap=Boolean(i&&i.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&a.generateMipmap(a.TEXTURE_2D)}bind(t,e){const{context:i}=this,{gl:n}=i;n.bindTexture(n.TEXTURE_2D,this.texture),t!==this.filter&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,this.useMipmap?t===n.NEAREST?n.NEAREST_MIPMAP_NEAREST:n.LINEAR_MIPMAP_NEAREST:t),this.filter=t),e!==this.wrap&&(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,e),this.wrap=e)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:t}=this.context;t.deleteTexture(this.texture),this.texture=null}}class vf{constructor(t){this._callback=t,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class xf{constructor(){this.tasks={},this.taskQueue=[],z(["process"],this),this.invoker=new vf(this.process),this.nextId=0}add(t,e){const i=this.nextId++,n=function({type:t,isSymbolTile:e,zoom:i}){return i=i||0,"message"===t?0:"maybePrepare"!==t||e?"parseTile"!==t||e?"parseTile"===t&&e?300-i:"maybePrepare"===t&&e?400-i:500:200-i:100-i}(e);if(0===n){X();try{t()}finally{}return{cancel:()=>{}}}return this.tasks[i]={fn:t,metadata:e,priority:n,id:i},this.taskQueue.push(i),this.invoker.trigger(),{cancel:()=>{delete this.tasks[i]}}}process(){X();try{if(this.taskQueue=this.taskQueue.filter((t=>!!this.tasks[t])),!this.taskQueue.length)return;const t=this.pick();if(null===t)return;const e=this.tasks[t];if(delete this.tasks[t],this.taskQueue.length&&this.invoker.trigger(),!e)return;e.fn()}finally{}}pick(){let t=null,e=1/0;for(let i=0;i<this.taskQueue.length;i++){const n=this.tasks[this.taskQueue[i]];n.priority<e&&(e=n.priority,t=i)}if(null===t)return null;const i=this.taskQueue[t];return this.taskQueue.splice(t,1),i}remove(){this.invoker.remove()}}class bf{constructor(t){this._stringToNumber={},this._numberToString=[];for(let e=0;e<t.length;e++){const i=t[e];this._stringToNumber[i]=e,this._numberToString[e]=i}}encode(t){return this._stringToNumber[t]}decode(t){return this._numberToString[t]}}const wf=["tile","layer","source","sourceLayer","state"];class Af{constructor(t,e,i,n,r){this.type="Feature",this._vectorTileFeature=t,this._z=e,this._x=i,this._y=n,this.properties=t.properties,this.id=r}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(t){this._geometry=t}toJSON(){const t={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};void 0!==this.id&&(t.id=this.id);for(const e of wf)void 0!==this[e]&&(t[e]=this[e]);return t}}const Tf=32,Mf=33,Sf=new Uint16Array(8184);for(let t=0;t<2046;t++){let e=t+2,i=0,n=0,r=0,s=0,o=0,a=0;for(1&e?r=s=o=Tf:i=n=a=Tf;(e>>=1)>1;){const t=i+r>>1,l=n+s>>1;1&e?(r=i,s=n,i=o,n=a):(i=r,n=s,r=o,s=a),o=t,a=l}const l=4*t;Sf[l+0]=i,Sf[l+1]=n,Sf[l+2]=r,Sf[l+3]=s}const Ef=new Uint16Array(2178),Cf=new Uint8Array(1089),If=new Uint16Array(1089);function Pf(t){return 0===t?-.03125:32===t?.03125:0}var Lf=zs([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const Rf={type:2,extent:aa,loadGeometry:()=>[[new y(0,0),new y(aa+1,0),new y(aa+1,aa+1),new y(0,aa+1),new y(0,0)]]};class Bf{constructor(t,e,i,n,r){this.tileID=t,this.uid=D(),this.uses=0,this.tileSize=e,this.tileZoom=i,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=r,this.expiredRequestCount=0,this.state="loading",n&&n.transform&&(this.projection=n.transform.projection)}registerFadeDuration(t){const e=t+this.timeAdded;e<Zt.now()||this.fadeEndTime&&e<this.fadeEndTime||(this.fadeEndTime=e)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=Pp(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,e,i){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=function(t,e){const i={};if(!e)return i;for(const n of t){const t=n.layerIds.map((t=>e.getLayer(t))).filter(Boolean);if(0!==t.length){n.layers=t,n.stateDependentLayerIds&&(n.stateDependentLayers=n.stateDependentLayerIds.map((e=>t.filter((t=>t.id===e))[0])));for(const e of t)i[e.id]=n}}return i}(t.buckets,e.style),this.hasSymbolBuckets=!1;for(const t in this.buckets){const e=this.buckets[t];if(e instanceof af){if(this.hasSymbolBuckets=!0,!i)break;e.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const t in this.buckets){const e=this.buckets[t];if(e instanceof af&&e.hasRTLText){this.hasRTLText=!0,xs.isLoading()||xs.isLoaded()||"deferred"!==ys()||vs();break}}this.queryPadding=0;for(const t in this.buckets){const i=this.buckets[t];this.queryPadding=Math.max(this.queryPadding,e.style.getLayer(t).queryRadius(i))}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas)}else this.collisionBoxArray=new po}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(t){return this.buckets[t.id]}upload(t){for(const e in this.buckets){const i=this.buckets[e];i.uploadPending()&&i.upload(t)}const e=t.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new yf(t,this.imageAtlas.image,e.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new yf(t,this.glyphAtlasImage,e.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new yf(t,this.lineAtlas.image,e.ALPHA),this.lineAtlas.uploaded=!0)}prepare(t){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture)}queryRenderedFeatures(t,e,i,n,r,s,o,a){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:n,pixelPosMatrix:o,transform:s,params:r,tileTransform:this.tileTransform},t,e,i):{}}querySourceFeatures(t,e){const i=this.latestFeatureIndex;if(!i||!i.rawTileData)return;const n=i.loadVTLayers(),r=e?e.sourceLayer:"",s=n._geojsonTileLayer||n[r];if(!s)return;const o=ur(e&&e.filter),{z:a,x:l,y:c}=this.tileID.canonical,h={z:a,x:l,y:c};for(let e=0;e<s.length;e++){const n=s.feature(e);if(o.needGeometry){const t=ac(n,!0);if(!o.filter(new bs(this.tileID.overscaledZ),t,this.tileID.canonical))continue}else if(!o.filter(new bs(this.tileID.overscaledZ),n))continue;const u=i.getId(n,r),d=new Af(n,a,l,c,u);d.tile=h,t.push(d)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const e=this.expirationTime;if(t.cacheControl){const e=Z(t.cacheControl);e["max-age"]&&(this.expirationTime=Date.now()+1e3*e["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const t=Date.now();let i=!1;if(this.expirationTime>t)i=!1;else if(e)if(this.expirationTime<e)i=!0;else{const n=this.expirationTime-e;n?this.expirationTime=t+Math.max(n,3e4):i=!0}else i=!0;i?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(t,e){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(t).length||!e)return;const i=this.latestFeatureIndex.loadVTLayers(),n=e.style.listImages();for(const r in this.buckets){if(!e.style.hasLayer(r))continue;const s=this.buckets[r],o=s.layers[0].sourceLayer||"_geojsonTileLayer",a=i[o],l=t[o];if(!a||!l||0===Object.keys(l).length)continue;if(s.update(l,a,n,this.imageAtlas&&this.imageAtlas.patternPositions||{}),s instanceof Su||s instanceof Eh){const t=e.style._getSourceCache(s.layers[0].source);e._terrain&&e._terrain.enabled&&t&&s.programConfigurations.needsUpload&&e._terrain._clearRenderCacheForTile(t.id,this.tileID)}const c=e&&e.style&&e.style.getLayer(r);c&&(this.queryPadding=Math.max(this.queryPadding,c.queryRadius(s)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<Zt.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=Zt.now()+t}setTexture(t,e){const i=e.context,n=i.gl;this.texture=this.texture||e.getTileTexture(t.width),this.texture?this.texture.update(t,{useMipmap:!0}):(this.texture=new yf(i,t,n.RGBA,{useMipmap:!0}),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE))}setDependencies(t,e){const i={};for(const t of e)i[t]=!0;this.dependencies[t]=i}hasDependency(t,e){for(const i of t){const t=this.dependencies[i];if(t)for(const i of e)if(t[i])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,e){if(!e||"mercator"===e.name||this._tileDebugBuffer)return;const i=oc(Rf,this.tileID.canonical,this.tileTransform)[0],n=new Us,r=new co;for(let t=0;t<i.length;t++){const{x:e,y:s}=i[t];n.emplaceBack(e,s),r.emplaceBack(t)}r.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(r),this._tileDebugBuffer=t.createVertexBuffer(n,tl.members),this._tileDebugSegments=oa.simpleSegment(0,0,n.length,r.length)}_makeTileBoundsBuffers(t,e){if(this._tileBoundsBuffer||!e||"mercator"===e.name)return;const i=oc(Rf,this.tileID.canonical,this.tileTransform)[0];let n,r;if(this.isRaster){const t=function(t,e){const i=Pp(t,e),n=Math.pow(2,t.z);for(let r=0;r<Mf;r++)for(let s=0;s<Mf;s++){const o=Xl((t.x+(s+Pf(s))/Tf)/n),a=Zl((t.y+(r+Pf(r))/Tf)/n),l=e.project(o,a),c=r*Mf+s;Ef[2*c+0]=Math.round((l.x*i.scale-i.x)*aa),Ef[2*c+1]=Math.round((l.y*i.scale-i.y)*aa)}Cf.fill(0),If.fill(0);for(let t=2045;t>=0;t--){const e=4*t,i=Sf[e+0],n=Sf[e+1],r=Sf[e+2],s=Sf[e+3],o=i+r>>1,a=n+s>>1,l=o+a-n,c=a+i-o,h=n*Mf+i,u=s*Mf+r,d=a*Mf+o,p=Math.hypot((Ef[2*h+0]+Ef[2*u+0])/2-Ef[2*d+0],(Ef[2*h+1]+Ef[2*u+1])/2-Ef[2*d+1])>=16;Cf[d]=Cf[d]||(p?1:0),t<1022&&(Cf[d]=Cf[d]||Cf[(n+c>>1)*Mf+(i+l>>1)]||Cf[(s+c>>1)*Mf+(r+l>>1)])}const r=new Vs,s=new io;let o=0;function a(t,e){const i=e*Mf+t;return 0===If[i]&&(r.emplaceBack(Ef[2*i+0],Ef[2*i+1],t*aa/Tf,e*aa/Tf),If[i]=++o),If[i]-1}function l(t,e,i,n,r,o){const c=t+i>>1,h=e+n>>1;if(Math.abs(t-r)+Math.abs(e-o)>1&&Cf[h*Mf+c])l(r,o,t,e,c,h),l(i,n,r,o,c,h);else{const l=a(t,e),c=a(i,n),h=a(r,o);s.emplaceBack(l,c,h)}}return l(0,0,Tf,Tf,Tf,0),l(Tf,Tf,0,0,0,Tf),{vertices:r,indices:s}}(this.tileID.canonical,e);n=t.vertices,r=t.indices}else{n=new Vs,r=new io;for(const{x:t,y:e}of i)n.emplaceBack(t,e,0,0);const t=yh(n.int16,void 0,4);for(let e=0;e<t.length;e+=3)r.emplaceBack(t[e],t[e+1],t[e+2])}this._tileBoundsBuffer=t.createVertexBuffer(n,Lf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(r),this._tileBoundsSegments=oa.simpleSegment(0,0,n.length,r.length)}_makeGlobeTileDebugBuffers(t,e){const i=e.projection;if(!i||"globe"!==i.name||e.freezeTileCoverage)return;const n=this.tileID.canonical,r=Pl(xl(n,e)),s=Bl(e.zoom);let o;s>0&&(o=fa(new Float64Array(16),e.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,n,e,r,o,s),this._makeGlobeTileDebugTextBuffer(t,n,e,r,o,s)}_globePoint(t,e,i,n,r,s,o){let a=El(t,e,i);if(s){const r=1<<i.z,l=Hl(n.center.lng),c=Wl(n.center.lat),h=(i.x+.5)/r-l;let u=0;h>.5?u=-1:h<-.5&&(u=1);let d=(t/aa+i.x)/r+u,p=(e/aa+i.y)/r;d=(d-l)*n._pixelsPerMercatorPixel+l,p=(p-c)*n._pixelsPerMercatorPixel+c;const f=[d*n.worldSize,p*n.worldSize,0];Fa(f,f,s),a=vl(a,f,o)}return Fa(a,a,r)}_makeGlobeTileDebugBorderBuffer(t,e,i,n,r,s){const o=new Us,a=new co,l=new Gs,c=(t,c,h,u,d)=>{const p=(h-t)/(d-1),f=(u-c)/(d-1),m=o.length;for(let h=0;h<d;h++){const u=t+h*p,d=c+h*f;o.emplaceBack(u,d);const g=this._globePoint(u,d,e,i,n,r,s);l.emplaceBack(g[0],g[1],g[2]),a.emplaceBack(m+h)}},h=aa;c(0,0,h,0,16),c(h,0,h,h,16),c(h,h,0,h,16),c(0,h,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(a),this._tileDebugBuffer=t.createVertexBuffer(o,tl.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(l,Qa.members),this._tileDebugSegments=oa.simpleSegment(0,0,o.length,a.length)}_makeGlobeTileDebugTextBuffer(t,e,i,n,r,s){const o=aa/4,a=new Us,l=new io,c=new Gs,h=25;l.reserve(32),a.reserve(h),c.reserve(h);const u=(t,e)=>h*t+e;for(let t=0;t<h;t++){const l=t*o;for(let t=0;t<h;t++){const h=t*o;a.emplaceBack(h,l);const u=this._globePoint(h,l,e,i,n,r,s);c.emplaceBack(u[0],u[1],u[2])}}for(let t=0;t<4;t++)for(let e=0;e<4;e++){const i=u(t,e),n=u(t,e+1),r=u(t+1,e),s=u(t+1,e+1);l.emplaceBack(i,n,r),l.emplaceBack(r,n,s)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(l),this._tileDebugTextBuffer=t.createVertexBuffer(a,tl.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(c,Qa.members),this._tileDebugTextSegments=oa.simpleSegment(0,0,h,32)}}class Df{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,e,i){const n=String(e);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][n]=this.stateChanges[t][n]||{},R(this.stateChanges[t][n],i),null===this.deletedStates[t]){this.deletedStates[t]={};for(const e in this.state[t])e!==n&&(this.deletedStates[t][e]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][n]){this.deletedStates[t][n]={};for(const e in this.state[t][n])i[e]||(this.deletedStates[t][n][e]=null)}else for(const e in i)this.deletedStates[t]&&this.deletedStates[t][n]&&null===this.deletedStates[t][n][e]&&delete this.deletedStates[t][n][e]}removeFeatureState(t,e,i){if(null===this.deletedStates[t])return;const n=String(e);if(this.deletedStates[t]=this.deletedStates[t]||{},i&&void 0!==e)null!==this.deletedStates[t][n]&&(this.deletedStates[t][n]=this.deletedStates[t][n]||{},this.deletedStates[t][n][i]=null);else if(void 0!==e)if(this.stateChanges[t]&&this.stateChanges[t][n])for(i in this.deletedStates[t][n]={},this.stateChanges[t][n])this.deletedStates[t][n][i]=null;else this.deletedStates[t][n]=null;else this.deletedStates[t]=null}getState(t,e){const i=String(e),n=R({},(this.state[t]||{})[i],(this.stateChanges[t]||{})[i]);if(null===this.deletedStates[t])return{};if(this.deletedStates[t]){const i=this.deletedStates[t][e];if(null===i)return{};for(const t in i)delete n[t]}return n}initializeTileState(t,e){t.setFeatureState(this.state,e)}coalesceChanges(t,e){const i={};for(const t in this.stateChanges){this.state[t]=this.state[t]||{};const e={};for(const i in this.stateChanges[t])this.state[t][i]||(this.state[t][i]={}),R(this.state[t][i],this.stateChanges[t][i]),e[i]=this.state[t][i];i[t]=e}for(const t in this.deletedStates){this.state[t]=this.state[t]||{};const e={};if(null===this.deletedStates[t])for(const i in this.state[t])e[i]={},this.state[t][i]={};else for(const i in this.deletedStates[t]){if(null===this.deletedStates[t][i])this.state[t][i]={};else if(this.state[t][i])for(const e of Object.keys(this.deletedStates[t][i]))delete this.state[t][i][e];e[i]=this.state[t][i]}i[t]=i[t]||{},R(i[t],e)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(i).length)for(const n in t)t[n].setFeatureState(i,e)}}class Of{constructor(t){this.size=t,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(t,e){const i=this.toIdx(t,e);return{min:this.minimums[i],max:this.maximums[i]}}isLeaf(t,e){return this.leaves[this.toIdx(t,e)]}toIdx(t,e){return e*this.size+t}}function kf(t,e,i,n){let r=0,s=Number.MAX_VALUE;for(let o=0;o<3;o++)if(Math.abs(n[o])<1e-15){if(i[o]<t[o]||i[o]>e[o])return null}else{const a=1/n[o];let l=(t[o]-i[o])*a,c=(e[o]-i[o])*a;if(l>c){const t=l;l=c,c=t}if(l>r&&(r=l),c<s&&(s=c),r>s)return null}return r}function Ff(t,e,i,n,r,s,o,a,l,c,h){const u=n-t,d=r-e,p=s-i,f=o-t,m=a-e,g=l-i,_=h[1]*g-h[2]*m,y=h[2]*f-h[0]*g,v=h[0]*m-h[1]*f,x=u*_+d*y+p*v;if(Math.abs(x)<1e-15)return null;const b=1/x,w=c[0]-t,A=c[1]-e,T=c[2]-i,M=(w*_+A*y+T*v)*b;if(M<0||M>1)return null;const S=A*p-T*d,E=T*u-w*p,C=w*d-A*u,I=(h[0]*S+h[1]*E+h[2]*C)*b;return I<0||M+I>1?null:(f*S+m*E+g*C)*b}function zf(t,e,i){return(t-e)/(i-e)}function Nf(t,e,i,n,r,s,o,a,l){const c=1<<i,h=s-n,u=o-r,d=(t+1)/c*h+n,p=(e+0)/c*u+r,f=(e+1)/c*u+r;a[0]=(t+0)/c*h+n,a[1]=p,l[0]=d,l[1]=f}class Uf{constructor(t){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=t,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const e=function(t){const e=Math.ceil(Math.log2(t.dim/8)),i=[];let n=Math.ceil(Math.pow(2,e));const r=1/n,s=(t,e,i,n,r)=>{const s=n?1:0,o=(t+1)*i-s,a=e*i,l=(e+1)*i-s;r[0]=t*i,r[1]=a,r[2]=o,r[3]=l};let o=new Of(n);const a=[];for(let e=0;e<n*n;e++){s(e%n,Math.floor(e/n),r,!1,a);const i=Vf(a[0],a[1],t),l=Vf(a[2],a[1],t),c=Vf(a[2],a[3],t),h=Vf(a[0],a[3],t);o.minimums.push(Math.min(i,l,c,h)),o.maximums.push(Math.max(i,l,c,h)),o.leaves.push(1)}for(i.push(o),n/=2;n>=1;n/=2){const t=i[i.length-1];o=new Of(n);for(let e=0;e<n*n;e++){s(e%n,Math.floor(e/n),2,!0,a);const i=t.getElevation(a[0],a[1]),r=t.getElevation(a[2],a[1]),l=t.getElevation(a[2],a[3]),c=t.getElevation(a[0],a[3]),h=t.isLeaf(a[0],a[1]),u=t.isLeaf(a[2],a[1]),d=t.isLeaf(a[2],a[3]),p=t.isLeaf(a[0],a[3]),f=Math.min(i.min,r.min,l.min,c.min),m=Math.max(i.max,r.max,l.max,c.max),g=h&&u&&d&&p;o.maximums.push(m),o.minimums.push(f),o.leaves.push(m-f<=5&&g?1:0)}i.push(o)}return i}(this.dem),i=e.length-1,n=e[i];this._addNode(n.minimums[0],n.maximums[0],n.leaves[0]),this._construct(e,0,0,i,0)}raycastRoot(t,e,i,n,r,s,o=1){return kf([t,e,-100],[i,n,this.maximums[0]*o],r,s)}raycast(t,e,i,n,r,s,o=1){if(!this.nodeCount)return null;const a=this.raycastRoot(t,e,i,n,r,s,o);if(null==a)return null;const l=[],c=[],h=[],u=[],d=[{idx:0,t:a,nodex:0,nodey:0,depth:0}];for(;d.length>0;){const{idx:a,t:p,nodex:f,nodey:m,depth:g}=d.pop();if(this.leaves[a]){Nf(f,m,g,t,e,i,n,h,u);const a=1<<g,l=(f+0)/a,c=(f+1)/a,d=(m+0)/a,_=(m+1)/a,y=Vf(l,d,this.dem)*o,v=Vf(c,d,this.dem)*o,x=Vf(c,_,this.dem)*o,b=Vf(l,_,this.dem)*o,w=Ff(h[0],h[1],y,u[0],h[1],v,u[0],u[1],x,r,s),A=Ff(u[0],u[1],x,h[0],u[1],b,h[0],h[1],y,r,s),T=Math.min(null!==w?w:Number.MAX_VALUE,null!==A?A:Number.MAX_VALUE);if(T!==Number.MAX_VALUE)return T;{const t=Ba([],r,s,p);if(Gf(y,v,b,x,zf(t[0],h[0],u[0]),zf(t[1],h[1],u[1]))>=t[2])return p}continue}let _=0;for(let d=0;d<this._siblingOffset.length;d++){Nf((f<<1)+this._siblingOffset[d][0],(m<<1)+this._siblingOffset[d][1],g+1,t,e,i,n,h,u),h[2]=-100,u[2]=this.maximums[this.childOffsets[a]+d]*o;const p=kf(h,u,r,s);if(null!=p){const t=p;l[d]=t;let e=!1;for(let i=0;i<_&&!e;i++)t>=l[c[i]]&&(c.splice(i,0,d),e=!0);e||(c[_]=d),_++}}for(let t=0;t<_;t++){const e=c[t];d.push({idx:this.childOffsets[a]+e,t:l[e],nodex:(f<<1)+this._siblingOffset[e][0],nodey:(m<<1)+this._siblingOffset[e][1],depth:g+1})}}return null}_addNode(t,e,i){return this.minimums.push(t),this.maximums.push(e),this.leaves.push(i),this.childOffsets.push(0),this.nodeCount++}_construct(t,e,i,n,r){if(1===t[n].isLeaf(e,i))return;this.childOffsets[r]||(this.childOffsets[r]=this.nodeCount);const s=n-1,o=t[s];let a=0,l=0;for(let t=0;t<this._siblingOffset.length;t++){const n=2*e+this._siblingOffset[t][0],r=2*i+this._siblingOffset[t][1],s=o.getElevation(n,r),c=o.isLeaf(n,r),h=this._addNode(s.min,s.max,c);c&&(a|=1<<t),l||(l=h)}for(let n=0;n<this._siblingOffset.length;n++)a&1<<n||this._construct(t,2*e+this._siblingOffset[n][0],2*i+this._siblingOffset[n][1],s,l+n)}}function Gf(t,e,i,n,r,s){return Li(Li(t,i,s),Li(e,n,s),r)}function Vf(t,e,i){const n=i.dim,r=E(t*n-.5,0,n-1),s=E(e*n-.5,0,n-1),o=Math.floor(r),a=Math.floor(s),l=Math.min(o+1,n-1),c=Math.min(a+1,n-1);return Gf(i.get(o,a),i.get(l,a),i.get(o,c),i.get(l,c),r-o,s-a)}const jf={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Hf(t,e,i){return(256*t*256+256*e+i)/10-1e4}function Wf(t,e,i){return 256*t+e+i/256-32768}class qf{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(t,e,i,n=!1,r=!1){if(this.uid=t,e.height!==e.width)throw new RangeError("DEM tiles must be square");if(i&&"mapbox"!==i&&"terrarium"!==i)return H(`"${i}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=e.height;const s=this.dim=e.height-2,o=new Uint32Array(e.data.buffer);if(this.pixels=new Uint8Array(e.data.buffer),this.encoding=i||"mapbox",this.borderReady=n,!n){for(let t=0;t<s;t++)o[this._idx(-1,t)]=o[this._idx(0,t)],o[this._idx(s,t)]=o[this._idx(s-1,t)],o[this._idx(t,-1)]=o[this._idx(t,0)],o[this._idx(t,s)]=o[this._idx(t,s-1)];o[this._idx(-1,-1)]=o[this._idx(0,0)],o[this._idx(s,-1)]=o[this._idx(s-1,0)],o[this._idx(-1,s)]=o[this._idx(0,s-1)],o[this._idx(s,s)]=o[this._idx(s-1,s-1)],r&&this._buildQuadTree()}}_buildQuadTree(){this._tree=new Uf(this)}get(t,e,i=!1){i&&(t=E(t,-1,this.dim),e=E(e,-1,this.dim));const n=4*this._idx(t,e);return("terrarium"===this.encoding?Wf:Hf)(this.pixels[n],this.pixels[n+1],this.pixels[n+2])}static getUnpackVector(t){return jf[t]}get unpackVector(){return jf[this.encoding]}_idx(t,e){if(t<-1||t>=this.dim+1||e<-1||e>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(e+1)*this.stride+(t+1)}static pack(t,e){const i=[0,0,0,0],n=qf.getUnpackVector(e);let r=Math.floor((t+n[3])/n[2]);return i[2]=r%256,r=Math.floor(r/256),i[1]=r%256,r=Math.floor(r/256),i[0]=r,i}getPixels(){return new Nc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(t,e,i){if(this.dim!==t.dim)throw new Error("dem dimension mismatch");let n=e*this.dim,r=e*this.dim+this.dim,s=i*this.dim,o=i*this.dim+this.dim;switch(e){case-1:n=r-1;break;case 1:r=n+1}switch(i){case-1:s=o-1;break;case 1:o=s+1}const a=-e*this.dim,l=-i*this.dim;for(let e=s;e<o;e++)for(let i=n;i<r;i++){const n=4*this._idx(i,e),r=4*this._idx(i+a,e+l);this.pixels[n+0]=t.pixels[r+0],this.pixels[n+1]=t.pixels[r+1],this.pixels[n+2]=t.pixels[r+2],this.pixels[n+3]=t.pixels[r+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Jr(qf,"DEMData"),Jr(Uf,"DemMinMaxQuadTree",{omit:["dem"]});class Xf{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){for(const t in this.data)for(const e of this.data[t])e.timeout&&clearTimeout(e.timeout),this.onRemove(e.value);return this.data={},this.order=[],this}add(t,e,i){const n=t.wrapped().key;void 0===this.data[n]&&(this.data[n]=[]);const r={value:e,timeout:void 0};if(void 0!==i&&(r.timeout=setTimeout((()=>{this.remove(t,r)}),i)),this.data[n].push(r),this.order.push(n),this.order.length>this.max){const t=this._getAndRemoveByKey(this.order[0]);t&&this.onRemove(t)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const e=this.data[t].shift();return e.timeout&&clearTimeout(e.timeout),0===this.data[t].length&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),e.value}getByKey(t){const e=this.data[t];return e?e[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,e){if(!this.has(t))return this;const i=t.wrapped().key,n=void 0===e?0:this.data[i].indexOf(e),r=this.data[i][n];return this.data[i].splice(n,1),r.timeout&&clearTimeout(r.timeout),0===this.data[i].length&&delete this.data[i],this.onRemove(r.value),this.order.splice(this.order.indexOf(i),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const t=this._getAndRemoveByKey(this.order[0]);t&&this.onRemove(t)}return this}filter(t){const e=[];for(const i in this.data)for(const n of this.data[i])t(n.value)||e.push(n);for(const t of e)this.remove(t.value.tileID,t)}}class Zf{constructor(t,e,i){this.func=t,this.mask=e,this.range=i}}Zf.ReadOnly=!1,Zf.ReadWrite=!0,Zf.disabled=new Zf(519,Zf.ReadOnly,[0,1]);const Jf=7680;class Yf{constructor(t,e,i,n,r,s){this.test=t,this.ref=e,this.mask=i,this.fail=n,this.depthFail=r,this.pass=s}}Yf.disabled=new Yf({func:519,mask:0},0,0,Jf,Jf,Jf);class $f{constructor(t,e,i){this.blendFunction=t,this.blendColor=e,this.mask=i}}$f.Replace=[1,0],$f.disabled=new $f($f.Replace,Le.transparent,[!1,!1,!1,!1]),$f.unblended=new $f($f.Replace,Le.transparent,[!0,!0,!0,!0]),$f.alphaBlended=new $f([1,771],Le.transparent,[!0,!0,!0,!0]);const Kf=1029,Qf=2305;class tm{constructor(t,e,i){this.enable=t,this.mode=e,this.frontFace=i}}tm.disabled=new tm(!1,Kf,Qf),tm.backCCW=new tm(!0,Kf,Qf),tm.backCW=new tm(!0,Kf,2304),tm.frontCW=new tm(!0,1028,2304),tm.frontCCW=new tm(!0,1028,Qf);class em extends Qt{constructor(t,e,i){super(),this.id=t,this._onlySymbols=i,e.on("data",(t=>{"source"===t.dataType&&"metadata"===t.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===t.dataType&&"content"===t.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))})),e.on("error",(()=>{this._sourceErrored=!0})),this._source=e,this._tiles={},this._cache=new Xf(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._loadedParentTiles={},this._coveredTiles={},this._state=new Df,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(t){this.map=t,this._minTileCacheSize=void 0===this._minTileCacheSize&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;for(const t in this._tiles){const e=this._tiles[t];if("loaded"!==e.state&&"errored"!==e.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,e){return t.isSymbolTile=this._onlySymbols,this._source.loadTile(t,e)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t,(()=>{}))}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t,(()=>{}))}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const e in this._tiles){const i=this._tiles[e];i.upload(t),i.prepare(this.map.style.imageManager)}}getIds(){return L(this._tiles).map((t=>t.tileID)).sort(im).map((t=>t.key))}getRenderableIds(t){const e=[];for(const i in this._tiles)this._isIdRenderable(+i,t)&&e.push(this._tiles[i]);return t?e.sort(((t,e)=>{const i=t.tileID,n=e.tileID,r=new y(i.canonical.x,i.canonical.y)._rotate(this.transform.angle),s=new y(n.canonical.x,n.canonical.y)._rotate(this.transform.angle);return i.overscaledZ-n.overscaledZ||s.y-r.y||s.x-r.x})).map((t=>t.tileID.key)):e.map((t=>t.tileID)).sort(im).map((t=>t.key))}hasRenderableParent(t){const e=this.findLoadedParent(t,0);return!!e&&this._isIdRenderable(e.tileID.key)}_isIdRenderable(t,e){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(e||!this._tiles[t].holdingForFade())}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(+t,"reloading")}}_reloadTile(t,e){const i=this._tiles[t];i&&("loading"!==i.state&&(i.state=e),this._loadTile(i,this._tileLoaded.bind(this,i,t,e)))}_tileLoaded(t,e,i,n){if(n)if(t.state="errored",404!==n.status)this._source.fire(new Kt(n,{tile:t}));else if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const t=this.map.painter.terrain;this.update(this.transform,t.getScaledDemTileSize(),!0),t.resetTileLookupCache(this.id)}else this.update(this.transform);else t.timeAdded=Zt.now(),"expired"===i&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(e,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new $t("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const e=this.getRenderableIds();for(let n=0;n<e.length;n++){const r=e[n];if(t.neighboringTiles&&t.neighboringTiles[r]){const e=this.getTileByID(r);i(t,e),i(e,t)}}function i(t,e){if(!t.dem||t.dem.borderReady)return;t.needsHillshadePrepare=!0,t.needsDEMTextureUpload=!0;let i=e.tileID.canonical.x-t.tileID.canonical.x;const n=e.tileID.canonical.y-t.tileID.canonical.y,r=Math.pow(2,t.tileID.canonical.z),s=e.tileID.key;0===i&&0===n||Math.abs(n)>1||(Math.abs(i)>1&&(1===Math.abs(i+r)?i+=r:1===Math.abs(i-r)&&(i-=r)),e.dem&&t.dem&&(t.dem.backfillBorder(e.dem,i,n),t.neighboringTiles&&t.neighboringTiles[s]&&(t.neighboringTiles[s].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,e,i,n){for(const r in this._tiles){let s=this._tiles[r];if(n[r]||!s.hasData()||s.tileID.overscaledZ<=e||s.tileID.overscaledZ>i)continue;let o=s.tileID;for(;s&&s.tileID.overscaledZ>e+1;){const t=s.tileID.scaledTo(s.tileID.overscaledZ-1);s=this._tiles[t.key],s&&s.hasData()&&(o=t)}let a=o;for(;a.overscaledZ>e;)if(a=a.scaledTo(a.overscaledZ-1),t[a.key]){n[o.key]=o;break}}}findLoadedParent(t,e){if(t.key in this._loadedParentTiles){const i=this._loadedParentTiles[t.key];return i&&i.tileID.overscaledZ>=e?i:null}for(let i=t.overscaledZ-1;i>=e;i--){const e=t.scaledTo(i),n=this._getLoadedTile(e);if(n)return n}}_getLoadedTile(t){const e=this._tiles[t.key];return e&&e.hasData()?e:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,e){e=e||this._source.tileSize;const i=Math.ceil(t.width/e)+1,n=Math.ceil(t.height/e)+1,r=Math.floor(i*n*5),s="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,r):r,o="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,s):s;this._cache.setMaxSize(o)}handleWrapJump(t){const e=Math.round((t-(void 0===this._prevLng?t:this._prevLng))/360);if(this._prevLng=t,e){const t={};for(const i in this._tiles){const n=this._tiles[i];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+e),t[n.tileID.key]=n}this._tiles=t;for(const t in this._timers)clearTimeout(this._timers[t]),delete this._timers[t];for(const t in this._tiles)this._setTileReloadTimer(+t,this._tiles[t])}}update(t,e,i){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!i)return;let n;this.updateCacheSize(t,e),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?n=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((t=>new fu(t.canonical.z,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y))):(n=t.coveringTiles({tileSize:e||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!i,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(n=n.filter((t=>this._source.hasTile(t))))):n=[];const r=this._updateRetainedTiles(n);if(nm(this._source.type)&&0!==n.length){const t={},e={},i=Object.keys(r);for(const n of i){const i=r[n],s=this._tiles[n];if(!s||s.fadeEndTime&&s.fadeEndTime<=Zt.now())continue;const o=this.findLoadedParent(i,Math.max(i.overscaledZ-em.maxOverzooming,this._source.minzoom));o&&(this._addTile(o.tileID),t[o.tileID.key]=o.tileID),e[n]=i}const s=n[n.length-1].overscaledZ;for(const t in this._tiles){const i=this._tiles[t];if(r[t]||!i.hasData())continue;let n=i.tileID;for(;n.overscaledZ>s;){n=n.scaledTo(n.overscaledZ-1);const s=this._tiles[n.key];if(s&&s.hasData()&&e[n.key]){r[t]=i.tileID;break}}}for(const e in t)r[e]||(this._coveredTiles[e]=!0,r[e]=t[e])}for(const t in r)this._tiles[t].clearFadeHold();const s=function(t,e){const i=[];for(const n in t)n in e||i.push(n);return i}(this._tiles,r);for(const t of s){const e=this._tiles[t];e.hasSymbolBuckets&&!e.holdingForFade()?e.setHoldDuration(this.map._fadeDuration):e.hasSymbolBuckets&&!e.symbolFadeFinished()||this._removeTile(+t)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const e={};if(0===t.length)return e;const i={},n=t.reduce(((t,e)=>Math.min(t,e.overscaledZ)),1/0),r=t[0].overscaledZ,s=Math.max(r-em.maxOverzooming,this._source.minzoom),o=Math.max(r+em.maxUnderzooming,this._source.minzoom),a={};for(const i of t){const t=this._addTile(i);e[i.key]=i,t.hasData()||n<this._source.maxzoom&&(a[i.key]=i)}this._retainLoadedChildren(a,n,o,e);for(const n of t){let t=this._tiles[n.key];if(t.hasData())continue;if(n.canonical.z>=this._source.maxzoom){const t=n.children(this._source.maxzoom)[0],i=this.getTile(t);if(i&&i.hasData()){e[t.key]=t;continue}}else{const t=n.children(this._source.maxzoom);if(e[t[0].key]&&e[t[1].key]&&e[t[2].key]&&e[t[3].key])continue}let r=t.wasRequested();for(let o=n.overscaledZ-1;o>=s;--o){const s=n.scaledTo(o);if(i[s.key])break;if(i[s.key]=!0,t=this.getTile(s),!t&&r&&(t=this._addTile(s)),t&&(e[s.key]=s,r=t.wasRequested(),t.hasData()))break}}return e}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const e=[];let i,n=this._tiles[t].tileID;for(;n.overscaledZ>0;){if(n.key in this._loadedParentTiles){i=this._loadedParentTiles[n.key];break}e.push(n.key);const t=n.scaledTo(n.overscaledZ-1);if(i=this._getLoadedTile(t),i)break;n=t}for(const t of e)this._loadedParentTiles[t]=i}}_addTile(t){let e=this._tiles[t.key];if(e)return e;e=this._cache.getAndRemove(t),e&&(this._setTileReloadTimer(t.key,e),e.tileID=t,this._state.initializeTileState(e,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,e)));const i=Boolean(e);if(!i){const i=this.map?this.map.painter:null;e=new Bf(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,i,this._isRaster),this._loadTile(e,this._tileLoaded.bind(this,e,t.key,e.state))}return e?(e.uses++,this._tiles[t.key]=e,i||this._source.fire(new $t("dataloading",{tile:e,coord:e.tileID,dataType:"source"})),e):null}_setTileReloadTimer(t,e){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const i=e.getExpiryTimeout();i&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),i))}_removeTile(t){const e=this._tiles[t];e&&(e.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),e.uses>0||(e.hasData()&&"reloading"!==e.state?this._cache.add(e.tileID,e,e.getExpiryTimeout()):(e.aborted=!0,this._abortTile(e),this._unloadTile(e))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,e,i){const n=[],r=this.transform;if(!r)return n;const s="globe"===r.projection.name,o=Hl(r.center.lng);for(const a in this._tiles){const l=this._tiles[a];if(i&&l.clearQueryDebugViz(),l.holdingForFade())continue;let c;if(s){const t=l.tileID.canonical;if(0===t.z){const e=[Math.abs(E(o,...rm(t,-1))-o),Math.abs(E(o,...rm(t,1))-o)];c=[0,2*e.indexOf(Math.min(...e))-1]}else{const e=[Math.abs(E(o,...rm(t,-1))-o),Math.abs(E(o,...rm(t,0))-o),Math.abs(E(o,...rm(t,1))-o)];c=[e.indexOf(Math.min(...e))-1]}}else c=[0];for(const i of c){const s=t.containsTile(l,r,e,i);s&&n.push(s)}}return n}getVisibleCoordinates(t){const e=this.getRenderableIds(t).map((t=>this._tiles[t].tileID));for(const t of e)t.projMatrix=this.transform.calculateProjMatrix(t.toUnwrapped());return e}hasTransition(){if(this._source.hasTransition())return!0;if(nm(this._source.type))for(const t in this._tiles){const e=this._tiles[t];if(void 0!==e.fadeEndTime&&e.fadeEndTime>=Zt.now())return!0}return!1}setFeatureState(t,e,i){this._state.updateState(t=t||"_geojsonTileLayer",e,i)}removeFeatureState(t,e,i){this._state.removeFeatureState(t=t||"_geojsonTileLayer",e,i)}getFeatureState(t,e){return this._state.getState(t=t||"_geojsonTileLayer",e)}setDependencies(t,e,i){const n=this._tiles[t];n&&n.setDependencies(e,i)}reloadTilesForDependencies(t,e){for(const i in this._tiles)this._tiles[i].hasDependency(t,e)&&this._reloadTile(+i,"reloading");this._cache.filter((i=>!i.hasDependency(t,e)))}_preloadTiles(t,e){if(!this._sourceLoaded){const i=()=>{this._sourceLoaded&&(this._source.off("data",i),this._preloadTiles(t,e))};return void this._source.on("data",i)}const i=new Map,n=Array.isArray(t)?t:[t],r=this.map.painter.terrain,s=this.usedForTerrain&&r?r.getScaledDemTileSize():this._source.tileSize;for(const t of n){const e=t.coveringTiles({tileSize:s,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const t of e)i.set(t.key,t);this.usedForTerrain&&t.updateElevation(!1)}P(Array.from(i.values()),((t,e)=>{const i=new Bf(t,this._source.tileSize*t.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(i,(t=>{"raster-dem"===this._source.type&&i.dem&&this._backfillDEM(i),e(t,i)}))}),e)}}function im(t,e){const i=Math.abs(2*t.wrap)-+(t.wrap<0),n=Math.abs(2*e.wrap)-+(e.wrap<0);return t.overscaledZ-e.overscaledZ||n-i||e.canonical.y-t.canonical.y||e.canonical.x-t.canonical.x}function nm(t){return"raster"===t||"image"===t||"video"===t||"custom"===t}function rm(t,e){const i=1<<t.z;return[t.x/i+e,(t.x+1)/i+e]}em.maxOverzooming=10,em.maxUnderzooming=3;class sm{constructor(t,e,i){this._demTile=t,this._dem=this._demTile.dem,this._scale=e,this._offset=i}static create(t,e,i){const n=i||t.findDEMTileFor(e);if(!n||!n.dem)return;const r=n.dem,s=n.tileID,o=1<<e.canonical.z-s.canonical.z;return new sm(n,n.tileSize/aa/o,[(e.canonical.x/o-s.canonical.x)*r.dim,(e.canonical.y/o-s.canonical.y)*r.dim])}tileCoordToPixel(t,e){const i=e*this._scale+this._offset[1],n=Math.floor(t*this._scale+this._offset[0]),r=Math.floor(i);return new y(n,r)}getElevationAt(t,e,i,n){const r=t*this._scale+this._offset[0],s=e*this._scale+this._offset[1],o=Math.floor(r),a=Math.floor(s),l=this._dem;return n=!!n,i?Li(Li(l.get(o,a,n),l.get(o,a+1,n),s-a),Li(l.get(o+1,a,n),l.get(o+1,a+1,n),s-a),r-o):l.get(o,a,n)}getElevationAtPixel(t,e,i){return this._dem.get(t,e,!!i)}getMeterToDEM(t){return(1<<this._demTile.tileID.canonical.z)*ql(1,t)*this._dem.stride}}class om{constructor(t,e){this.tileID=t,this.x=t.canonical.x,this.y=t.canonical.y,this.z=t.canonical.z,this.grid=new Xr(aa,16,0),this.featureIndexArray=new bo,this.promoteId=e}insert(t,e,i,n,r,s=0){const o=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(i,n,r,s);const a=this.grid;for(let t=0;t<e.length;t++){const i=e[t],n=[1/0,1/0,-1/0,-1/0];for(let t=0;t<i.length;t++){const e=i[t];n[0]=Math.min(n[0],e.x),n[1]=Math.min(n[1],e.y),n[2]=Math.max(n[2],e.x),n[3]=Math.max(n[3],e.y)}n[0]<aa&&n[1]<aa&&n[2]>=0&&n[3]>=0&&a.insert(o,n[0],n[1],n[2],n[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new qh(new gd(this.rawTileData)).layers,this.sourceLayerCoder=new bf(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const t in this.vtLayers)this.vtFeatures[t]=[]}return this.vtLayers}query(t,e,i,n){this.loadVTLayers();const r=t.params||{},s=ur(r.filter),o=t.tileResult,a=t.transform,l=o.bufferedTilespaceBounds,c=this.grid.query(l.min.x,l.min.y,l.max.x,l.max.y,((t,e,i,n)=>bc(o.bufferedTilespaceGeometry,t,e,i,n)));c.sort(lm);let h=null;a.elevation&&c.length>0&&(h=sm.create(a.elevation,this.tileID));const u={};let d;for(let a=0;a<c.length;a++){const l=c[a];if(l===d)continue;d=l;const p=this.featureIndexArray.get(l);let f=null;this.loadMatchingFeature(u,p,s,r.layers,r.availableImages,e,i,n,((e,i,n,r=0)=>(f||(f=oc(e,this.tileID.canonical,t.tileTransform)),i.queryIntersectsFeature(o,e,n,f,this.z,t.transform,t.pixelPosMatrix,h,r))))}return u}loadMatchingFeature(t,e,i,n,r,s,o,a,l){const{featureIndex:c,bucketIndex:h,sourceLayerIndex:u,layoutVertexArrayOffset:d}=e,p=this.bucketLayerIDs[h];if(n&&!function(t,e){for(let i=0;i<t.length;i++)if(e.indexOf(t[i])>=0)return!0;return!1}(n,p))return;const f=this.sourceLayerCoder.decode(u),m=this.vtLayers[f].feature(c);if(i.needGeometry){const t=ac(m,!0);if(!i.filter(new bs(this.tileID.overscaledZ),t,this.tileID.canonical))return}else if(!i.filter(new bs(this.tileID.overscaledZ),m))return;const g=this.getId(m,f);for(let e=0;e<p.length;e++){const i=p[e];if(n&&n.indexOf(i)<0)continue;const h=s[i];if(!h)continue;let u={};void 0!==g&&a&&(u=a.getState(h.sourceLayer||"_geojsonTileLayer",g));const f=R({},o[i]);f.paint=am(f.paint,h.paint,m,u,r),f.layout=am(f.layout,h.layout,m,u,r);const _=!l||l(m,h,u,d);if(!_)continue;const y=new Af(m,this.z,this.x,this.y,g);y.layer=f;let v=t[i];void 0===v&&(v=t[i]=[]),v.push({featureIndex:c,feature:y,intersectionZ:_})}}lookupSymbolFeatures(t,e,i,n,r,s,o,a){const l={};this.loadVTLayers();const c=ur(r);for(const r of t)this.loadMatchingFeature(l,{bucketIndex:i,sourceLayerIndex:n,featureIndex:r,layoutVertexArrayOffset:0},c,s,o,a,e);return l}loadFeature(t){const{featureIndex:e,sourceLayerIndex:i}=t;this.loadVTLayers();const n=this.sourceLayerCoder.decode(i),r=this.vtFeatures[n];if(r[e])return r[e];const s=this.vtLayers[n].feature(e);return r[e]=s,s}hasLayer(t){for(const e of this.bucketLayerIDs)for(const i of e)if(t===i)return!0;return!1}getId(t,e){let i=t.id;if(this.promoteId){const n="string"==typeof this.promoteId?this.promoteId:this.promoteId[e];null!=n&&(i=t.properties[n]),"boolean"==typeof i&&(i=Number(i))}return i}}function am(t,e,i,n,r){return U(t,((t,s)=>{const o=e instanceof Is?e.get(s):null;return o&&o.evaluate?o.evaluate(i,n,r):o}))}function lm(t,e){return e-t}Jr(om,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});class cm{constructor(t,e){this.width=t,this.height=e,this.nextRow=0,this.image=new zc({width:t,height:e}),this.positions={},this.uploaded=!1}getDash(t,e){const i=this.getKey(t,e);return this.positions[i]}trim(){const t=this.width,e=this.height=k(this.nextRow);this.image.resize({width:t,height:e})}getKey(t,e){return t.join(",")+e}getDashRanges(t,e,i){const n=[];let r=t.length%2==1?-t[t.length-1]*i:0,s=t[0]*i,o=!0;n.push({left:r,right:s,isDash:o,zeroLength:0===t[0]});let a=t[0];for(let e=1;e<t.length;e++){o=!o;const l=t[e];r=a*i,a+=l,s=a*i,n.push({left:r,right:s,isDash:o,zeroLength:0===l})}return n}addRoundDash(t,e,i){const n=e/2;for(let e=-i;e<=i;e++){const r=this.width*(this.nextRow+i+e);let s=0,o=t[s];for(let a=0;a<this.width;a++){a/o.right>1&&(o=t[++s]);const l=Math.abs(a-o.left),c=Math.abs(a-o.right),h=Math.min(l,c);let u;const d=e/i*(n+1);if(o.isDash){const t=n-Math.abs(d);u=Math.sqrt(h*h+t*t)}else u=n-Math.sqrt(h*h+d*d);this.image.data[r+a]=Math.max(0,Math.min(255,u+128))}}}addRegularDash(t,e){for(let e=t.length-1;e>=0;--e){const i=t[e],n=t[e+1];i.zeroLength?t.splice(e,1):n&&n.isDash===i.isDash&&(n.left=i.left,t.splice(e,1))}const i=t[0],n=t[t.length-1];i.isDash===n.isDash&&(i.left=n.left-this.width,n.right=i.right+this.width);const r=this.width*this.nextRow;let s=0,o=t[s];for(let i=0;i<this.width;i++){i/o.right>1&&(o=t[++s]);const n=Math.abs(i-o.left),a=Math.abs(i-o.right),l=Math.min(n,a);this.image.data[r+i]=Math.max(0,Math.min(255,(o.isDash?l:-l)+e+128))}}addDash(t,e){const i=this.getKey(t,e);if(this.positions[i])return this.positions[i];const n="round"===e,r=n?7:0,s=2*r+1;if(this.nextRow+s>this.height)return H("LineAtlas out of space"),null;0===t.length&&t.push(1);let o=0;for(let e=0;e<t.length;e++)t[e]<0&&(H("Negative value is found in line dasharray, replacing values with 0"),t[e]=0),o+=t[e];if(0!==o){const i=this.width/o,s=this.getDashRanges(t,this.width,i);n?this.addRoundDash(s,i,r):this.addRegularDash(s,"square"===e?.5*i:0)}const a=this.nextRow+r;this.nextRow+=s;const l={tl:[a,r],br:[o,0]};return this.positions[i]=l,l}}Jr(cm,"LineAtlas");const hm=1*tp;class um{constructor(t){const e={},i=[];for(const n in t){const r=t[n],s=e[n]={};for(const t in r.glyphs){const e=r.glyphs[+t];if(!e||0===e.bitmap.width||0===e.bitmap.height)continue;const n=e.metrics.localGlyph?hm:1,o={x:0,y:0,w:e.bitmap.width+2*n,h:e.bitmap.height+2*n};i.push(o),s[t]=o}}const{w:n,h:r}=wd(i),s=new zc({width:n||1,height:r||1});for(const i in t){const n=t[i];for(const t in n.glyphs){const r=n.glyphs[+t];if(!r||0===r.bitmap.width||0===r.bitmap.height)continue;const o=e[i][t],a=r.metrics.localGlyph?hm:1;zc.copy(r.bitmap,s,{x:0,y:0},{x:o.x+a,y:o.y+a},r.bitmap)}}this.image=s,this.positions=e}}Jr(um,"GlyphAtlas");class dm{constructor(t){this.tileID=new fu(t.tileID.overscaledZ,t.tileID.wrap,t.tileID.canonical.z,t.tileID.canonical.x,t.tileID.canonical.y),this.tileZoom=t.tileZoom,this.uid=t.uid,this.zoom=t.zoom,this.canonical=t.tileID.canonical,this.pixelRatio=t.pixelRatio,this.tileSize=t.tileSize,this.source=t.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=t.showCollisionBoxes,this.collectResourceTiming=!!t.collectResourceTiming,this.returnDependencies=!!t.returnDependencies,this.promoteId=t.promoteId,this.enableTerrain=!!t.enableTerrain,this.isSymbolTile=t.isSymbolTile,this.tileTransform=Pp(t.tileID.canonical,t.projection),this.projection=t.projection}parse(t,e,i,n,r){this.status="parsing",this.data=t,this.collisionBoxArray=new po;const s=new bf(Object.keys(t.layers).sort()),o=new om(this.tileID,this.promoteId);o.bucketLayerIDs=[];const a={},l=new cm(256,256),c={featureIndex:o,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:l,availableImages:i},h=e.familiesBySource[this.source];for(const e in h){const n=t.layers[e];if(!n)continue;let r=!1,l=!1;for(const t of h[e])"symbol"===t[0].type?r=!0:l=!0;if(!0===this.isSymbolTile&&!r)continue;if(!1===this.isSymbolTile&&!l)continue;1===n.version&&H(`Vector tile source "${this.source}" layer "${e}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const u=s.encode(e),d=[];for(let t=0;t<n.length;t++){const i=n.feature(t),r=o.getId(i,e);d.push({feature:i,id:r,index:t,sourceLayerIndex:u})}for(const t of h[e]){const e=t[0];void 0!==this.isSymbolTile&&"symbol"===e.type!==this.isSymbolTile||e.minzoom&&this.zoom<Math.floor(e.minzoom)||e.maxzoom&&this.zoom>=e.maxzoom||"none"!==e.visibility&&(pm(t,this.zoom,i),(a[e.id]=e.createBucket({index:o.bucketLayerIDs.length,layers:t,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:u,sourceID:this.source,enableTerrain:this.enableTerrain,projection:this.projection.spec,availableImages:i})).populate(d,c,this.tileID.canonical,this.tileTransform),o.bucketLayerIDs.push(t.map((t=>t.id))))}}let u,d,p,f;l.trim();const m={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},g=()=>{if(u)return r(u);if(d&&p&&f){const t=new um(d),e=new Md(p,f);for(const n in a){const r=a[n];r instanceof af?(pm(r.layers,this.zoom,i),vp(r,d,t.positions,p,e.iconPositions,this.showCollisionBoxes,i,this.tileID.canonical,this.tileZoom,this.projection)):r.hasPattern&&(r instanceof Su||r instanceof Eh||r instanceof tu)&&(pm(r.layers,this.zoom,i),r.addFeatures(c,this.tileID.canonical,e.patternPositions,i,this.tileTransform))}this.status="done",r(null,{buckets:L(a).filter((t=>!t.isEmpty())),featureIndex:o,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:t.image,lineAtlas:l,imageAtlas:e,glyphMap:this.returnDependencies?d:null,iconMap:this.returnDependencies?p:null,glyphPositions:this.returnDependencies?t.positions:null})}},_=U(c.glyphDependencies,(t=>Object.keys(t).map(Number)));Object.keys(_).length?n.send("getGlyphs",{uid:this.uid,stacks:_},((t,e)=>{u||(u=t,d=e,g())}),void 0,!1,m):d={};const y=Object.keys(c.iconDependencies);y.length?n.send("getImages",{icons:y,source:this.source,tileID:this.tileID,type:"icons"},((t,e)=>{u||(u=t,p=e,g())}),void 0,!1,m):p={};const v=Object.keys(c.patternDependencies);v.length?n.send("getImages",{icons:v,source:this.source,tileID:this.tileID,type:"patterns"},((t,e)=>{u||(u=t,f=e,g())}),void 0,!1,m):f={},g()}}function pm(t,e,i){const n=new bs(e);for(const e of t)e.recalculate(n,i)}class fm{constructor(t){this.entries={},this.scheduler=t}request(t,e,i,n){const r=this.entries[t]=this.entries[t]||{callbacks:[]};if(r.result){const[t,i]=r.result;return this.scheduler?this.scheduler.add((()=>{n(t,i)}),e):n(t,i),()=>{}}return r.callbacks.push(n),r.cancel||(r.cancel=i(((i,n)=>{r.result=[i,n];for(const t of r.callbacks)this.scheduler?this.scheduler.add((()=>{t(i,n)}),e):t(i,n);setTimeout((()=>delete this.entries[t]),3e3)}))),()=>{r.result||(r.callbacks=r.callbacks.filter((t=>t!==n)),r.callbacks.length||(r.cancel(),delete this.entries[t]))}}}function mm(t,e,i){const n=JSON.stringify(t.request);return t.data&&(this.deduped.entries[n]={result:[null,t.data]}),this.deduped.request(n,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},(e=>{const n=dt(t.request,((t,n,r,s)=>{t?e(t):n&&e(null,{vectorTile:i?void 0:new qh(new gd(n)),rawData:n,cacheControl:r,expires:s})}));return()=>{n.cancel(),e()}}),e)}const gm=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class _m{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,i]=new Uint8Array(t,0,2);if(219!==e)throw new Error("Data does not appear to be in a KDBush format.");const n=i>>4;if(1!==n)throw new Error(`Got v${n} data when expected v1.`);const r=gm[15&i];if(!r)throw new Error("Unrecognized array type.");const[s]=new Uint16Array(t,2,1),[o]=new Uint32Array(t,4,1);return new _m(o,s,r,t)}constructor(t,e=64,i=Float64Array,n){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=i,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const r=gm.indexOf(this.ArrayType),s=2*t*this.ArrayType.BYTES_PER_ELEMENT,o=t*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-o%8)%8;if(r<0)throw new Error(`Unexpected typed array class: ${i}.`);n&&n instanceof ArrayBuffer?(this.data=n,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+o+a,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+s+o+a),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+o+a,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+r]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){const i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=t,this.coords[this._pos++]=e,i}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return ym(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,e,i,n){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:r,coords:s,nodeSize:o}=this,a=[0,r.length-1,0],l=[];for(;a.length;){const c=a.pop()||0,h=a.pop()||0,u=a.pop()||0;if(h-u<=o){for(let o=u;o<=h;o++){const a=s[2*o],c=s[2*o+1];a>=t&&a<=i&&c>=e&&c<=n&&l.push(r[o])}continue}const d=u+h>>1,p=s[2*d],f=s[2*d+1];p>=t&&p<=i&&f>=e&&f<=n&&l.push(r[d]),(0===c?t<=p:e<=f)&&(a.push(u),a.push(d-1),a.push(1-c)),(0===c?i>=p:n>=f)&&(a.push(d+1),a.push(h),a.push(1-c))}return l}within(t,e,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:n,coords:r,nodeSize:s}=this,o=[0,n.length-1,0],a=[],l=i*i;for(;o.length;){const c=o.pop()||0,h=o.pop()||0,u=o.pop()||0;if(h-u<=s){for(let i=u;i<=h;i++)wm(r[2*i],r[2*i+1],t,e)<=l&&a.push(n[i]);continue}const d=u+h>>1,p=r[2*d],f=r[2*d+1];wm(p,f,t,e)<=l&&a.push(n[d]),(0===c?t-i<=p:e-i<=f)&&(o.push(u),o.push(d-1),o.push(1-c)),(0===c?t+i>=p:e+i>=f)&&(o.push(d+1),o.push(h),o.push(1-c))}return a}}function ym(t,e,i,n,r,s){if(r-n<=i)return;const o=n+r>>1;vm(t,e,o,n,r,s),ym(t,e,i,n,o-1,1-s),ym(t,e,i,o+1,r,1-s)}function vm(t,e,i,n,r,s){for(;r>n;){if(r-n>600){const o=r-n+1,a=i-n+1,l=Math.log(o),c=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*c*(o-c)/o)*(a-o/2<0?-1:1);vm(t,e,i,Math.max(n,Math.floor(i-a*c/o+h)),Math.min(r,Math.floor(i+(o-a)*c/o+h)),s)}const o=e[2*i+s];let a=n,l=r;for(xm(t,e,n,i),e[2*r+s]>o&&xm(t,e,n,r);a<l;){for(xm(t,e,a,l),a++,l--;e[2*a+s]<o;)a++;for(;e[2*l+s]>o;)l--}e[2*n+s]===o?xm(t,e,n,l):(l++,xm(t,e,l,r)),l<=i&&(n=l+1),i<=l&&(r=l-1)}}function xm(t,e,i,n){bm(t,i,n),bm(e,2*i,2*n),bm(e,2*i+1,2*n+1)}function bm(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function wm(t,e,i,n){const r=t-i,s=e-n;return r*r+s*s}t.ARRAY_TYPE=ha,t.AUTH_ERR_MSG=yt,t.Aabb=rl,t.Actor=class{constructor(t,i,n){this.target=t,this.parent=i,this.mapId=n,this.callbacks={},this.cancelCallbacks={},z(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=X()?t:e,this.scheduler=new xf}send(t,e,i,n,r=!1,s){const o=Math.round(1e18*Math.random()).toString(36).substring(0,10);i&&(i.metadata=s,this.callbacks[o]=i);const a=Y(this.globalScope)?void 0:[];return this.target.postMessage({id:o,type:t,hasCallback:!!i,targetMapId:n,mustQueue:r,sourceMapId:this.mapId,data:Kr(e,a)},a),{cancel:()=>{i&&delete this.callbacks[o],this.target.postMessage({id:o,type:"<cancel>",targetMapId:n,sourceMapId:this.mapId})}}}receive(t){const e=t.data,i=e.id;if(i&&(!e.targetMapId||this.mapId===e.targetMapId))if("<cancel>"===e.type){const t=this.cancelCallbacks[i];delete this.cancelCallbacks[i],t&&t.cancel()}else if(e.mustQueue||X()){const t=this.callbacks[i];this.cancelCallbacks[i]=this.scheduler.add((()=>this.processTask(i,e)),t&&t.metadata||{type:"message"})}else this.processTask(i,e)}processTask(t,e){if("<response>"===e.type){const i=this.callbacks[t];delete this.callbacks[t],i&&(e.error?i(Qr(e.error)):i(null,Qr(e.data)))}else{const i=Y(this.globalScope)?void 0:[],n=e.hasCallback?(e,n)=>{delete this.cancelCallbacks[t],this.target.postMessage({id:t,type:"<response>",sourceMapId:this.mapId,error:e?Kr(e):null,data:Kr(n,i)},i)}:t=>{},r=Qr(e.data);if(this.parent[e.type])this.parent[e.type](e.sourceMapId,r,n);else if(this.parent.getWorkerSource){const t=e.type.split(".");this.parent.getWorkerSource(e.sourceMapId,t[0],r.source)[t[1]](r,n)}else n(new Error(`Could not find function ${e.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}},t.CanonicalTileID=du,t.Color=Le,t.ColorMode=$f,t.CullFaceMode=tm,t.DEMData=qf,t.DataConstantProperty=Ps,t.DedupedRequest=fm,t.DepthMode=Zf,t.EXTENT=aa,t.Elevation=class{isDataAvailableAtPoint(t){const e=this._source();if(this.isUsingMockSource()||!e||t.y<0||t.y>1)return!1;const i=e.getSource().maxzoom,n=1<<i,r=Math.floor(t.x),s=Math.floor((t.x-r)*n),o=Math.floor(t.y*n),a=this.findDEMTileFor(new fu(i,r,i,s,o));return!(!a||!a.dem)}getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,i=!0){if(this.isUsingMockSource())return null;null==e&&(e=null);const n=this._source();if(!n)return e;if(t.y<0||t.y>1)return e;const r=n.getSource().maxzoom,s=1<<r,o=Math.floor(t.x),a=t.x-o,l=new fu(r,o,r,Math.floor(a*s),Math.floor(t.y*s)),c=this.findDEMTileFor(l);if(!c||!c.dem)return e;const h=c.dem,u=1<<c.tileID.canonical.z,d=(a*u-c.tileID.canonical.x)*h.dim,p=(t.y*u-c.tileID.canonical.y)*h.dim,f=Math.floor(d),m=Math.floor(p);return(i?this.exaggeration():1)*Li(Li(h.get(f,m),h.get(f,m+1),p-m),Li(h.get(f+1,m),h.get(f+1,m+1),p-m),d-f)}getAtTileOffset(t,e,i){const n=1<<t.canonical.z;return this.getAtPointOrZero(new Kl(t.wrap+(t.canonical.x+e/aa)/n,(t.canonical.y+i/aa)/n))}getAtTileOffsetFunc(t,e,i,n){return r=>{const s=this.getAtTileOffset(t,r.x,r.y),o=n.upVector(t.canonical,r.x,r.y);return Ra(o,o,s*n.upVectorScale(t.canonical,e,i).metersToTile),o}}getForTilePoints(t,e,i,n){if(this.isUsingMockSource())return!1;const r=sm.create(this,t,n);return!!r&&(e.forEach((t=>{t[2]=this.exaggeration()*r.getElevationAt(t[0],t[1],i)})),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const i=e.dem.tree,n=e.tileID,r=1<<t.canonical.z-n.canonical.z;let s=t.canonical.x/r-n.canonical.x,o=t.canonical.y/r-n.canonical.y,a=0;for(let e=0;e<t.canonical.z-n.canonical.z&&!i.leaves[a];e++){s*=2,o*=2;const t=2*Math.floor(o)+Math.floor(s);a=i.childOffsets[a]+t,s%=1,o%=1}return{min:this.exaggeration()*i.minimums[a],max:this.exaggeration()*i.maximums[a]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}},t.ErrorEvent=Kt,t.EvaluationParameters=bs,t.Event=$t,t.Evented=Qt,t.FillExtrusionBucket=tu,t.Frustum=nl,t.FrustumCorners=il,t.GLOBE_RADIUS=al,t.GLOBE_SCALE_MATCH_LATITUDE=45,t.GLOBE_ZOOM_THRESHOLD_MAX=ol,t.GLOBE_ZOOM_THRESHOLD_MIN=sl,t.GlobeSharedBuffers=class{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy();if(this._wireframeIndexBuffer){this._wireframeIndexBuffer.destroy();for(const t of this._wireframeSegments)t.destroy()}}_fillGridMeshWithLods(t,e){const i=new Us,n=new io,r=[],s=t+1+2,o=e[0]+1,a=e[0]+1+(1+e.length),l=(t,e,i)=>{let n=t===s-1?t-2:0===t?t:t-1;return n+=i?24575:0,[n,e]};for(let t=0;t<s;++t)i.emplaceBack(...l(t,0,!0));for(let t=0;t<o;++t)for(let e=0;e<s;++e)i.emplaceBack(...l(e,t,(0===e||e===s-1)&&!0));for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<s;++t)i.emplaceBack(...l(t,n,!0))}for(let t=0;t<e.length;++t){const o=n.length,l=e[t]+1+2,c=new io;for(let i=0;i<l-1;i++){const r=i===l-2,o=r?s*(a-e.length+t-i):s;for(let t=0;t<s-1;t++){const e=i*s+t;0===i||r||0===t||t===s-2?(c.emplaceBack(e+1,e,e+o),c.emplaceBack(e+o,e+o+1,e+1)):(n.emplaceBack(e+1,e,e+o),n.emplaceBack(e+o,e+o+1,e+1))}}const h=oa.simpleSegment(0,o,i.length,n.length-o);for(let t=0;t<c.uint16.length;t+=3)n.emplaceBack(c.uint16[t],c.uint16[t+1],c.uint16[t+2]);const u=oa.simpleSegment(0,o,i.length,n.length-o);r.push({withoutSkirts:h,withSkirts:u})}return{vertices:i,indices:n,segments:r}}_createGrid(t){const e=this._fillGridMeshWithLods(cl,hl);this._gridSegments=e.segments,this._gridBuffer=t.createVertexBuffer(e.vertices,tl.members),this._gridIndexBuffer=t.createIndexBuffer(e.indices,!0)}_createPoles(t){const e=new io;for(let t=0;t<=cl;t++)e.emplaceBack(0,t+1,t+2);this._poleIndexBuffer=t.createIndexBuffer(e,!0);const i=new oo,n=new oo;this._poleSegments=[];for(let t=0,e=0;t<sl;t++){const r=360/(1<<t);i.emplaceBack(0,-al,0,.5,0),n.emplaceBack(0,-al,0,.5,1);for(let t=0;t<=cl;t++){const e=t/cl,s=Li(0,r,e),[o,a,l]=Ml(Fl,zl,s,al);i.emplaceBack(o,a,l,e,0),n.emplaceBack(o,a,l,e,1)}this._poleSegments.push(oa.simpleSegment(e,0,66,64)),e+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(i,Ka,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(n,Ka,!1)}getGridBuffers(t,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t){return[this._poleNorthVertexBuffer,this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}getWirefameBuffers(t,e){if(!this._wireframeSegments){const e=new lo,i=cl,n=i+1+2,r=1;this._wireframeSegments=[];for(let t=0,s=0;t<hl.length;t++){const o=hl[t];for(let t=r;t<o+r;t++)for(let s=r;s<i+r;s++){const i=t*n+s;e.emplaceBack(i,i+1),e.emplaceBack(i,i+n),e.emplaceBack(i,i+n+1)}const a=o*i*3;this._wireframeSegments.push(oa.simpleSegment(0,s,(o+1)*n,a)),s+=a}this._wireframeIndexBuffer=t.createIndexBuffer(e)}return[this._gridBuffer,this._wireframeIndexBuffer,this._wireframeSegments[e]]}},t.GlyphManager=ip,t.ImagePosition=Td,t.KDBush=_m,t.LivePerformanceUtils=Ut,t.LngLat=Vl,t.LngLatBounds=la,t.LocalGlyphMode=ep,t.MAX_MERCATOR_LATITUDE=Yl,t.MercatorCoordinate=Kl,t.ONE_EM=zu,t.OverscaledTileID=fu,t.PerformanceMarkers=Nt,t.Point=y,t.Properties=Bs,t.RGBAImage=Nc,t.Ray=el,t.RequestManager=class{constructor(t,e,i){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!i,this._createSkuToken()}_createSkuToken(){const t=function(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",u,t].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!vt(t))return t;const i=Mt(t);return i.path=`/styles/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!vt(t))return t;const i=Mt(t);return i.path=`/fonts/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||e)}normalizeSourceURL(t,e,i,n){if(!vt(t))return t;const r=Mt(t);return r.path=`/v4/${r.authority}.json`,r.params.push("secure"),i&&r.params.push(`language=${i}`),n&&r.params.push(`worldview=${n}`),this._makeAPIURL(r,this._customAccessToken||e)}normalizeSpriteURL(t,e,i,n){const r=Mt(t);return vt(t)?(r.path=`/styles/v1${r.path}/sprite${e}${i}`,this._makeAPIURL(r,this._customAccessToken||n)):(r.path+=`${e}${i}`,St(r))}normalizeTileURL(t,e,i){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!vt(t))return t;const n=Mt(t);n.path=n.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||i&&"raster"!==n.authority&&512===i?"@2x":""}${s.supported?".webp":"$1"}`),"raster"===n.authority?n.path=`/${r.RASTER_URL_PREFIX}${n.path}`:(n.path=n.path.replace(/^.+\/v4\//,"/"),n.path=`/${r.TILE_URL_VERSION}${n.path}`);const o=this._customAccessToken||function(t){for(const e of t){const t=e.match(/^access_token=(.*)$/);if(t)return t[1]}return null}(n.params)||r.ACCESS_TOKEN;return r.REQUIRE_ACCESS_TOKEN&&o&&this._skuToken&&n.params.push(`sku=${this._skuToken}`),this._makeAPIURL(n,o)}canonicalizeTileURL(t,e){const i=Mt(t);if(!i.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!i.path.match(/\.[\w]+$/))return t;let n="mapbox://";i.path.match(/^\/raster\/v1\//)?n+=`raster/${i.path.replace(`/${r.RASTER_URL_PREFIX}/`,"")}`:n+=`tiles/${i.path.replace(`/${r.TILE_URL_VERSION}/`,"")}`;let s=i.params;return e&&(s=s.filter((t=>!t.match(/^access_token=/)))),s.length&&(n+=`?${s.join("&")}`),n}canonicalizeTileset(t,e){const i=!!e&&vt(e),n=[];for(const e of t.tiles||[])xt(e)?n.push(this.canonicalizeTileURL(e,i)):n.push(e);return n}_makeAPIURL(t,e){const i="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",n=Mt(r.API_URL);if(t.protocol=n.protocol,t.authority=n.authority,"http"===t.protocol){const e=t.params.indexOf("secure");e>=0&&t.params.splice(e,1)}if("/"!==n.path&&(t.path=`${n.path}${t.path}`),!r.REQUIRE_ACCESS_TOKEN)return St(t);if(e=e||r.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${i}`);if("s"===e[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${i}`)}return t.params=t.params.filter((t=>-1===t.indexOf("access_token"))),t.params.push(`access_token=${e||""}`),St(t)}},t.ResourceType=lt,t.SegmentVector=oa,t.SourceCache=em,t.StencilMode=Yf,t.StructArrayLayout1ui2=co,t.StructArrayLayout2f1f2i16=Qs,t.StructArrayLayout2i4=Us,t.StructArrayLayout2ui4=lo,t.StructArrayLayout3f12=eo,t.StructArrayLayout3ui6=io,t.StructArrayLayout4i8=Vs,t.StructArrayLayout5f20=oo,t.Texture=yf,t.Tile=Bf,t.Transitionable=Ts,t.Uniform1f=Fo,t.Uniform1i=class extends ko{constructor(t){super(t),this.current=0}set(t,e,i){this.fetchUniformLocation(t,e)&&this.current!==i&&(this.current=i,this.gl.uniform1i(this.location,i))}},t.Uniform2f=class extends ko{constructor(t){super(t),this.current=[0,0]}set(t,e,i){this.fetchUniformLocation(t,e)&&(i[0]===this.current[0]&&i[1]===this.current[1]||(this.current=i,this.gl.uniform2f(this.location,i[0],i[1])))}},t.Uniform3f=class extends ko{constructor(t){super(t),this.current=[0,0,0]}set(t,e,i){this.fetchUniformLocation(t,e)&&(i[0]===this.current[0]&&i[1]===this.current[1]&&i[2]===this.current[2]||(this.current=i,this.gl.uniform3f(this.location,i[0],i[1],i[2])))}},t.Uniform4f=zo,t.UniformColor=No,t.UniformMatrix2f=class extends ko{constructor(t){super(t),this.current=Vo}set(t,e,i){if(this.fetchUniformLocation(t,e))for(let t=0;t<4;t++)if(i[t]!==this.current[t]){this.current=i,this.gl.uniformMatrix2fv(this.location,!1,i);break}}},t.UniformMatrix3f=class extends ko{constructor(t){super(t),this.current=Go}set(t,e,i){if(this.fetchUniformLocation(t,e))for(let t=0;t<9;t++)if(i[t]!==this.current[t]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}},t.UniformMatrix4f=class extends ko{constructor(t){super(t),this.current=Uo}set(t,e,i){if(this.fetchUniformLocation(t,e)){if(i[12]!==this.current[12]||i[0]!==this.current[0])return this.current=i,void this.gl.uniformMatrix4fv(this.location,!1,i);for(let t=1;t<16;t++)if(i[t]!==this.current[t]){this.current=i,this.gl.uniformMatrix4fv(this.location,!1,i);break}}}},t.UnwrappedTileID=pu,t.ValidationError=ir,t.VectorTileFeature=Xh,t.VectorTileWorkerSource=class extends Qt{constructor(t,e,i,n,r){super(),this.actor=t,this.layerIndex=e,this.availableImages=i,this.loadVectorData=r||mm,this.loading={},this.loaded={},this.deduped=new fm(t.scheduler),this.isSpriteLoaded=n,this.scheduler=t.scheduler}loadTile(t,e){const i=t.uid,n=t&&t.request,r=n&&n.collectResourceTiming,s=this.loading[i]=new dm(t);s.abort=this.loadVectorData(t,((o,a)=>{const l=!this.loading[i];if(delete this.loading[i],l||o||!a)return s.status="done",l||(this.loaded[i]=s),e(o);const c=a.rawData,h={};a.expires&&(h.expires=a.expires),a.cacheControl&&(h.cacheControl=a.cacheControl),s.vectorTile=a.vectorTile||new qh(new gd(c));const u=()=>{s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,((t,i)=>{if(t||!i)return e(t);const s={};if(r){const t=jt(n);t.length>0&&(s.resourceTiming=JSON.parse(JSON.stringify(t)))}e(null,R({rawTileData:c.slice(0)},i,h,s))}))};this.isSpriteLoaded?u():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(u,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom}):u()})),this.loaded=this.loaded||{},this.loaded[i]=s}))}reloadTile(t,e){const i=this.loaded,n=t.uid,r=this;if(i&&i[n]){const s=i[n];s.showCollisionBoxes=t.showCollisionBoxes,s.enableTerrain=!!t.enableTerrain,s.projection=t.projection,s.tileTransform=Pp(t.tileID.canonical,t.projection);const o=(t,i)=>{const n=s.reloadCallback;n&&(delete s.reloadCallback,s.parse(s.vectorTile,r.layerIndex,this.availableImages,r.actor,n)),e(t,i)};"parsing"===s.status?s.reloadCallback=o:"done"===s.status&&(s.vectorTile?s.parse(s.vectorTile,this.layerIndex,this.availableImages,this.actor,o):o())}}abortTile(t,e){const i=t.uid,n=this.loading[i];n&&(n.abort&&n.abort(),delete this.loading[i]),e()}removeTile(t,e){const i=this.loaded,n=t.uid;i&&i[n]&&delete i[n],e()}},t.WritingMode=Sd,t.ZoomDependentExpression=Kn,t.add=Ea,t.addDynamicAttributes=nf,t.adjoint=function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return t[0]=o*h-a*c,t[1]=r*c-n*h,t[2]=n*a-r*o,t[3]=a*l-s*h,t[4]=i*h-r*l,t[5]=r*s-i*a,t[6]=s*c-o*l,t[7]=n*l-i*c,t[8]=i*o-n*s,t},t.asyncAll=P,t.bezier=M,t.bindAll=z,t.boundsAttributes=Lf,t.bufferConvexPolygon=function(t,e){const i=[];for(let n=0;n<t.length;n++){const r=I(n-1,-1,t.length-1),s=I(n+1,-1,t.length-1),o=t[n],a=t[s],l=t[r].sub(o).unit(),c=a.sub(o).unit(),h=c.angleWithSep(l.x,l.y),u=l.add(c).unit().mult(-1*e/Math.sin(h/2));i.push(o.add(u))}return i},t.cacheEntryPossiblyAdded=function(t){at++,at>nt&&(t.getActor().send("enforceCacheSizeLimit",it),at=0)},t.calculateGlobeLabelMatrix=function(t,e){const{x:i,y:n}=t.point,r=Rl(i,n,t.worldSize/t._pixelsPerMercatorPixel,0,0);return ma(r,r,Ll(yl(e)))},t.calculateGlobeMatrix=function(t){const{x:e,y:i}=t.point,{lng:n,lat:r}=t._center;return Rl(e,i,t.worldSize,n,r)},t.calculateGlobeMercatorMatrix=function(t){const e=t.pixelsPerMeter,i=e/ql(1,t.center.lat),n=pa(new Float64Array(16));return ga(n,n,[t.point.x,t.point.y,0]),_a(n,n,[i,i,e]),Float32Array.from(n)},t.circumferenceAtLatitude=jl,t.clamp=E,t.clearTileCache=function(t){if(!rt())return;const i=e.caches.delete(Q);t&&i.catch(t).then((()=>t()))},t.clipLine=Yd,t.clone=function(t){var e=new ha(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},t.clone$1=V,t.collisionCircleLayout=Fu,t.config=r,t.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},t.create=function(){var t=new ha(16);return ha!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},t.create$1=ua,t.createExpression=Yn,t.createLayout=zs,t.createStyleLayer=function(t){return"custom"===t.type?new ff(t):new _f[t.type](t)},t.cross=ka,t.degToRad=b,t.distance=function(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2])},t.div=function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t},t.dot=Oa,t.earthRadius=Nl,t.ease=S,t.easeCubicInOut=T,t.ecefToLatLng=function([t,e,i]){const n=Math.hypot(t,e,i),r=Math.atan2(t,i),s=.5*Math.PI-Math.acos(-e/n);return new Vl(w(r),w(s))},t.emitValidationErrors=jr,t.endsWith=N,t.enforceCacheSizeLimit=function(t){st(),tt&&tt.then((e=>{e.keys().then((i=>{for(let n=0;n<i.length-t;n++)e.delete(i[n])}))}))},t.evaluateSizeForFeature=Gu,t.evaluateSizeForZoom=Vu,t.evaluateVariableOffset=yp,t.evented=_s,t.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},t.exactEquals$1=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},t.exported=Zt,t.exported$1=s,t.extend=R,t.extend$1=ee,t.fillExtrusionHeightLift=au,t.filterObject=G,t.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},t.fromQuat=function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i+i,a=n+n,l=r+r,c=i*o,h=n*o,u=n*a,d=r*o,p=r*a,f=r*l,m=s*o,g=s*a,_=s*l;return t[0]=1-u-f,t[1]=h+_,t[2]=d-g,t[3]=0,t[4]=h-_,t[5]=1-c-f,t[6]=p+m,t[7]=0,t[8]=d+g,t[9]=p-m,t[10]=1-c-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},t.fromRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t[0]=n,t[1]=i,t[2]=0,t[3]=-i,t[4]=n,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},t.fromScaling=xa,t.furthestTileCorner=function(t){const e=Math.round((t+45+360)%360/90)%4;return A[e]},t.getAABBPointSquareDist=function(t,e,i){let n=0;for(let r=0;r<2;++r){const s=i?i[r]:0;t[r]>s&&(n+=(t[r]-s)*(t[r]-s)),e[r]<s&&(n+=(s-e[r])*(s-e[r]))}return n},t.getAnchorAlignment=zd,t.getAnchorJustification=xp,t.getBounds=function(t){let e=1/0,i=1/0,n=-1/0,r=-1/0;for(const s of t)e=Math.min(e,s.x),i=Math.min(i,s.y),n=Math.max(n,s.x),r=Math.max(r,s.y);return{min:new y(e,i),max:new y(n,r)}},t.getColumn=K,t.getDefaultExportFromCjs=d,t.getGridMatrix=function(t,e,i,n){const r=e.getNorth(),s=e.getSouth(),o=e.getWest(),a=e.getEast(),l=1<<t.z,c=a-o,h=r-s,u=c/cl,d=-h/hl[i],p=[0,u,0,d,0,0,r,o,0];if(t.z>0){const t=180/n;da(p,p,[t/c+1,0,0,0,t/h+1,0,-.5*t/u,.5*t/d,1])}return p[2]=l,p[5]=t.x,p[8]=t.y,p},t.getImage=_t,t.getJSON=function(t,e){return ut(R(t,{type:"json"}),e)},t.getLatitudinalLod=function(t){const e=Yl-5;t=E(t,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(b(t))),3);return Math.round(i*(hl.length-1))},t.getMapSessionAPI=Ft,t.getPerformanceMeasurement=jt,t.getProjection=$p,t.getRTLTextPluginStatus=ys,t.getReferrer=ht,t.getTilePoint=function(t,{x:e,y:i},n=0){return new y(((e-n)*t.scale-t.x)*aa,(i*t.scale-t.y)*aa)},t.getTileVec3=function(t,e,i=0){return Sa(((e.x-i)*t.scale-t.x)*aa,(e.y*t.scale-t.y)*aa,Jl(e.z,e.y))},t.getVideo=function(t,i){const n=e.document.createElement("video");n.muted=!0,n.onloadstart=function(){i(null,n)};for(let i=0;i<t.length;i++){const r=e.document.createElement("source");pt(t[i])||(n.crossOrigin="Anonymous"),r.src=t[i],n.appendChild(r)}return{cancel:()=>{}}},t.globeCenterToScreenPoint=function(t){const e=[0,0,0],i=pa(new Float64Array(16));return ma(i,t.pixelMatrix,t.globeMatrix),Fa(e,e,i),new y(e[0],e[1])},t.globeDenormalizeECEF=Ll,t.globeECEFOrigin=function(t,e){const i=[0,0,0];return Fa(i,i,Pl(yl(e.canonical))),Fa(i,i,t),i},t.globeMetersToEcef=fl,t.globeNormalizeECEF=Pl,t.globePixelsToTileUnits=function(t,e){return aa/(512*Math.pow(2,t))*Cl(yl(e))},t.globePoleMatrixForTile=function(t,e,i){const n=pa(new Float64Array(16)),r=(e/(1<<t)-.5)*Math.PI*2;return va(n,i.globeMatrix,r),Float32Array.from(n)},t.globeTileBounds=yl,t.globeTiltAtLngLat=Dl,t.globeToMercatorTransition=Bl,t.globeUseCustomAntiAliasing=function(t,e,i){const n=Bl(i.zoom),r=t.style.map._antialias,s=!!e.extStandardDerivatives,o=e.extStandardDerivativesForceOff||t.terrain&&t.terrain.exaggeration()>0;return 0===n&&!r&&!o&&s},t.identity=pa,t.identity$1=Xa,t.invert=fa,t.isFullscreen=function(){return!!e.document.fullscreenElement||!!e.document.webkitFullscreenElement},t.isLngLatBehindGlobe=Ol,t.isMapAuthenticated=function(t){return zt.has(t)},t.isMapboxURL=vt,t.isSafariWithAntialiasingBug=function(t){const e=t.navigator?t.navigator.userAgent:null;return!!Y(t)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},t.latFromMercatorY=Zl,t.latLngToECEF=Sl,t.len=Va,t.length=Ma,t.length$1=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},t.lngFromMercatorX=Xl,t.loadVectorTile=mm,t.makeRequest=ut,t.mapValue=function(t,e,i,n,r){return E((t-e)/(i-e)*(r-n)+n,n,r)},t.mercatorScale=$l,t.mercatorXfromLng=Hl,t.mercatorYfromLat=Wl,t.mercatorZfromAltitude=ql,t.mul=wa,t.mul$1=Ga,t.multiply=ma,t.multiply$1=da,t.multiply$2=Ia,t.nextPowerOfTwo=k,t.normalize=Da,t.normalize$1=Ya,t.normalize$2=Ha,t.number=Li,t.ortho=function(t,e,i,n,r,s,o){var a=1/(e-i),l=1/(n-r),c=1/(s-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*a,t[13]=(r+n)*l,t[14]=(o+s)*c,t[15]=1,t},t.pbf=Zu,t.perspective=function(t,e,i,n,r){var s,o=1/Math.tan(e/2);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(t[10]=(r+n)*(s=1/(n-r)),t[14]=2*r*n*s):(t[10]=-1,t[14]=-2*n),t},t.pick=function(t,e){const i={};for(let n=0;n<e.length;n++){const r=e[n];r in t&&(i[r]=t[r])}return i},t.plugin=xs,t.pointGeometry=g,t.polesInViewport=function(t){const e=pa(new Float64Array(16));ma(e,t.pixelMatrix,t.globeMatrix);const i=[0,ul,0],n=[0,dl,0];return Fa(i,i,e),Fa(n,n,e),[i[0]>0&&i[0]<=t.width&&i[1]>0&&i[1]<=t.height&&!Ol(t,new Vl(t.center.lat,90)),n[0]>0&&n[0]<=t.width&&n[1]>0&&n[1]<=t.height&&!Ol(t,new Vl(t.center.lat,-90))]},t.polygonContainsPoint=xc,t.polygonIntersectsBox=bc,t.polygonIntersectsPolygon=uc,t.polygonizeBounds=function(t,e,i=0,n=!0){const r=new y(i,i),s=t.sub(r),o=e.add(r),a=[s,new y(o.x,s.y),o,new y(s.x,o.y)];return n&&a.push(s.clone()),a},t.posAttributes=tl,t.postMapLoadEvent=Bt,t.postPerformanceEvent=Ot,t.postTurnstileEvent=Lt,t.potpack=wd,t.prevPowerOfTwo=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},t.radToDeg=w,t.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],t.registerForPluginStateChange=function(t){return t({pluginStatus:ps,pluginURL:fs}),_s.on("pluginStateChange",t),t},t.removeAuthState=function(t){zt.delete(t)},t.renderColorRamp=Gc,t.resample=tc,t.rotateX=ya,t.rotateX$1=Za,t.rotateY=va,t.rotateY$1=Ja,t.rotateZ=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r+c*n,t[1]=o*r+h*n,t[2]=a*r+u*n,t[3]=l*r+d*n,t[4]=c*r-s*n,t[5]=h*r-o*n,t[6]=u*r-a*n,t[7]=d*r-l*n,t},t.rotateZ$1=function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=n*l+r*a,t[1]=r*l-n*a,t[2]=s*l+o*a,t[3]=o*l-s*a,t},t.scale=_a,t.scale$1=ja,t.scale$2=Ra,t.scaleAndAdd=Ba,t.set=function(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t},t.setCacheLimits=function(t,e){it=t,nt=e},t.setColumn=function(t,e,i){t[4*e+0]=i[0],t[4*e+1]=i[1],t[4*e+2]=i[2],t[4*e+3]=i[3]},t.setRTLTextPlugin=function(t,e,i=!1){if(ps===cs||ps===hs||ps===us)throw new Error("setRTLTextPlugin cannot be called multiple times.");fs=Zt.resolveURL(t),ps=cs,ds=e,gs(),i||vs()},t.smoothstep=C,t.spec=te,t.squaredLength=function(t){var e=t[0],i=t[1],n=t[2];return e*e+i*i+n*n},t.storeAuthState=function(t,e){e?zt.add(t):zt.delete(t)},t.sub=Ua,t.subtract=Ca,t.symbolSize=ju,t.tileAABB=function(t,e,i,n,r,s,o,a,l){if("globe"===l.name)return wl(t,e,new du(i,n,r));const c=Pp({z:i,x:n,y:r},l);return new rl([(s+c.x/c.scale)*e,e*(c.y/c.scale),o],[(s+c.x2/c.scale)*e,e*(c.y2/c.scale),a])},t.tileCornersToBounds=Al,t.tileTransform=Pp,t.transformMat3=function(t,e,i){var n=e[0],r=e[1],s=e[2];return t[0]=n*i[0]+r*i[3]+s*i[6],t[1]=n*i[1]+r*i[4]+s*i[7],t[2]=n*i[2]+r*i[5]+s*i[8],t},t.transformMat4=Fa,t.transformMat4$1=Wa,t.transformQuat=za,t.transitionTileAABBinECEF=xl,t.translate=ga,t.transpose=function(t,e){if(t===e){var i=e[1],n=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=n,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},t.triggerPluginCompletionEvent=ms,t.uniqueId=D,t.updateGlobeVertexNormal=function(t,e,i,n,r){const s=5*e+2;t.float32[s+0]=i,t.float32[s+1]=n,t.float32[s+2]=r},t.validateCustomStyleLayer=function(t){const e=[],i=t.id;return void 0===i&&e.push({message:`layers.${i}: missing required property "id"`}),void 0===t.render&&e.push({message:`layers.${i}: missing required method "render"`}),t.renderingMode&&"2d"!==t.renderingMode&&"3d"!==t.renderingMode&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},t.validateFilter=t=>Vr(Ar(t)),t.validateFog=t=>Vr(Or(t)),t.validateLayer=t=>Vr(Cr(t)),t.validateLight=t=>Vr(Br(t)),t.validateSource=t=>Vr(Lr(t)),t.validateStyle=Nr,t.validateTerrain=t=>Vr(Dr(t)),t.values=L,t.vectorTile=Dh,t.version=i,t.warnOnce=H,t.window=e,t.wrap=I})),n(["./shared"],(function(t){function e(t){if("number"==typeof t||"boolean"==typeof t||"string"==typeof t||null==t)return JSON.stringify(t);if(Array.isArray(t)){let i="[";for(const n of t)i+=`${e(n)},`;return`${i}]`}let i="{";for(const n of Object.keys(t).sort())i+=`${n}:${e(t[n])},`;return`${i}}`}function i(i){let n="";for(const r of t.refProperties)n+=`/${e(i[r])}`;return n}class n{constructor(t){this.keyCache={},t&&this.replace(t)}replace(t){this._layerConfigs={},this._layers={},this.update(t,[])}update(e,n){for(const i of e)this._layerConfigs[i.id]=i,(this._layers[i.id]=t.createStyleLayer(i)).compileFilter(),this.keyCache[i.id]&&delete this.keyCache[i.id];for(const t of n)delete this.keyCache[t],delete this._layerConfigs[t],delete this._layers[t];this.familiesBySource={};const r=function(t,e){const n={};for(let r=0;r<t.length;r++){const s=e&&e[t[r].id]||i(t[r]);e&&(e[t[r].id]=s);let o=n[s];o||(o=n[s]=[]),o.push(t[r])}const r=[];for(const t in n)r.push(n[t]);return r}(t.values(this._layerConfigs),this.keyCache);for(const t of r){const e=t.map((t=>this._layers[t.id])),i=e[0];if("none"===i.visibility)continue;const n=i.source||"";let r=this.familiesBySource[n];r||(r=this.familiesBySource[n]={});const s=i.sourceLayer||"_geojsonTileLayer";let o=r[s];o||(o=r[s]=[]),o.push(e)}}}class r{loadTile(e,i){const{uid:n,encoding:r,rawImageData:s,padding:o,buildQuadTree:a}=e,l=t.window.ImageBitmap&&s instanceof t.window.ImageBitmap?this.getImageData(s,o):s;i(null,new t.DEMData(n,l,r,o<1,a))}getImageData(t,e){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(t.width,t.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height,this.offscreenCanvasContext.drawImage(t,0,0,t.width,t.height);const i=this.offscreenCanvasContext.getImageData(-e,-e,t.width+2*e,t.height+2*e);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),i}}function s(t,e){if(0!==t.length){o(t[0],e);for(var i=1;i<t.length;i++)o(t[i],!e)}}function o(t,e){for(var i=0,n=0,r=0,s=t.length,o=s-1;r<s;o=r++){var a=(t[r][0]-t[o][0])*(t[o][1]+t[r][1]),l=i+a;n+=Math.abs(i)>=Math.abs(a)?i-l+a:a-l+i,i=l}i+n>=0!=!!e&&t.reverse()}var a=t.getDefaultExportFromCjs((function t(e,i){var n,r=e&&e.type;if("FeatureCollection"===r)for(n=0;n<e.features.length;n++)t(e.features[n],i);else if("GeometryCollection"===r)for(n=0;n<e.geometries.length;n++)t(e.geometries[n],i);else if("Feature"===r)t(e.geometry,i);else if("Polygon"===r)s(e.coordinates,i);else if("MultiPolygon"===r)for(n=0;n<e.coordinates.length;n++)s(e.coordinates[n],i);return e}));const l=t.VectorTileFeature.prototype.toGeoJSON;var c={exports:{}},h=t.pointGeometry,u=t.vectorTile.VectorTileFeature,d=p;function p(t,e){this.options=e||{},this.features=t,this.length=t.length}function f(t,e){this.id="number"==typeof t.id?t.id:void 0,this.type=t.type,this.rawGeometry=1===t.type?[t.geometry]:t.geometry,this.properties=t.tags,this.extent=e||4096}p.prototype.feature=function(t){return new f(this.features[t],this.options.extent)},f.prototype.loadGeometry=function(){var t=this.rawGeometry;this.geometry=[];for(var e=0;e<t.length;e++){for(var i=t[e],n=[],r=0;r<i.length;r++)n.push(new h(i[r][0],i[r][1]));this.geometry.push(n)}return this.geometry},f.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var t=this.geometry,e=1/0,i=-1/0,n=1/0,r=-1/0,s=0;s<t.length;s++)for(var o=t[s],a=0;a<o.length;a++){var l=o[a];e=Math.min(e,l.x),i=Math.max(i,l.x),n=Math.min(n,l.y),r=Math.max(r,l.y)}return[e,n,i,r]},f.prototype.toGeoJSON=u.prototype.toGeoJSON;var m=t.pbf,g=d;function _(t){var e=new m;return function(t,e){for(var i in t.layers)e.writeMessage(3,y,t.layers[i])}(t,e),e.finish()}function y(t,e){var i;e.writeVarintField(15,t.version||1),e.writeStringField(1,t.name||""),e.writeVarintField(5,t.extent||4096);var n={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<t.length;i++)n.feature=t.feature(i),e.writeMessage(2,v,n);var r=n.keys;for(i=0;i<r.length;i++)e.writeStringField(3,r[i]);var s=n.values;for(i=0;i<s.length;i++)e.writeMessage(4,T,s[i])}function v(t,e){var i=t.feature;void 0!==i.id&&e.writeVarintField(1,i.id),e.writeMessage(2,x,t),e.writeVarintField(3,i.type),e.writeMessage(4,A,i)}function x(t,e){var i=t.feature,n=t.keys,r=t.values,s=t.keycache,o=t.valuecache;for(var a in i.properties){var l=i.properties[a],c=s[a];if(null!==l){void 0===c&&(n.push(a),s[a]=c=n.length-1),e.writeVarint(c);var h=typeof l;"string"!==h&&"boolean"!==h&&"number"!==h&&(l=JSON.stringify(l));var u=h+":"+l,d=o[u];void 0===d&&(r.push(l),o[u]=d=r.length-1),e.writeVarint(d)}}}function b(t,e){return(e<<3)+(7&t)}function w(t){return t<<1^t>>31}function A(t,e){for(var i=t.loadGeometry(),n=t.type,r=0,s=0,o=i.length,a=0;a<o;a++){var l=i[a],c=1;1===n&&(c=l.length),e.writeVarint(b(1,c));for(var h=3===n?l.length-1:l.length,u=0;u<h;u++){1===u&&1!==n&&e.writeVarint(b(2,h-1));var d=l[u].x-r,p=l[u].y-s;e.writeVarint(w(d)),e.writeVarint(w(p)),r+=d,s+=p}3===n&&e.writeVarint(b(7,1))}}function T(t,e){var i=typeof t;"string"===i?e.writeStringField(1,t):"boolean"===i?e.writeBooleanField(7,t):"number"===i&&(t%1!=0?e.writeDoubleField(3,t):t<0?e.writeSVarintField(6,t):e.writeVarintField(5,t))}c.exports=_,c.exports.fromVectorTileJs=_,c.exports.fromGeojsonVt=function(t,e){e=e||{};var i={};for(var n in t)i[n]=new g(t[n].features,e),i[n].name=n,i[n].version=e.version,i[n].extent=e.extent;return _({layers:i})},c.exports.GeoJSONWrapper=g;var M=t.getDefaultExportFromCjs(c.exports);const S={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:t=>t},E=Math.fround||(C=new Float32Array(1),t=>(C[0]=+t,C[0]));var C;const I=3,P=5,L=6;class R{constructor(t){this.options=Object.assign(Object.create(S),t),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(t){const{minZoom:e,maxZoom:i}=this.options;this.points=t;const n=[];for(let e=0;e<t.length;e++){const i=t[e];if(!i.geometry)continue;const[r,s]=i.geometry.coordinates,o=E(O(r)),a=E(k(s));n.push(o,a,1/0,e,-1,1),this.options.reduce&&n.push(0)}let r=this.trees[i+1]=this._createTree(n);for(let t=i;t>=e;t--)r=this.trees[t]=this._createTree(this._cluster(r,t));return this}getClusters(t,e){let i=((t[0]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,t[1]));let r=180===t[2]?180:((t[2]+180)%360+360)%360-180;const s=Math.max(-90,Math.min(90,t[3]));if(t[2]-t[0]>=360)i=-180,r=180;else if(i>r){const t=this.getClusters([i,n,180,s],e),o=this.getClusters([-180,n,r,s],e);return t.concat(o)}const o=this.trees[this._limitZoom(e)],a=o.range(O(i),k(s),O(r),k(n)),l=o.data,c=[];for(const t of a){const e=this.stride*t;c.push(l[e+P]>1?B(l,e,this.clusterProps):this.points[l[e+I]])}return c}getChildren(t){const e=this._getOriginId(t),i=this._getOriginZoom(t),n="No cluster with the specified id.",r=this.trees[i];if(!r)throw new Error(n);const s=r.data;if(e*this.stride>=s.length)throw new Error(n);const o=this.options.radius/(this.options.extent*Math.pow(2,i-1)),a=r.within(s[e*this.stride],s[e*this.stride+1],o),l=[];for(const e of a){const i=e*this.stride;s[i+4]===t&&l.push(s[i+P]>1?B(s,i,this.clusterProps):this.points[s[i+I]])}if(0===l.length)throw new Error(n);return l}getLeaves(t,e,i){const n=[];return this._appendLeaves(n,t,e=e||10,i=i||0,0),n}getTile(t,e,i){const n=this.trees[this._limitZoom(t)],r=Math.pow(2,t),{extent:s,radius:o}=this.options,a=o/s,l=(i-a)/r,c=(i+1+a)/r,h={features:[]};return this._addTileFeatures(n.range((e-a)/r,l,(e+1+a)/r,c),n.data,e,i,r,h),0===e&&this._addTileFeatures(n.range(1-a/r,l,1,c),n.data,r,i,r,h),e===r-1&&this._addTileFeatures(n.range(0,l,a/r,c),n.data,-1,i,r,h),h.features.length?h:null}getClusterExpansionZoom(t){let e=this._getOriginZoom(t)-1;for(;e<=this.options.maxZoom;){const i=this.getChildren(t);if(e++,1!==i.length)break;t=i[0].properties.cluster_id}return e}_appendLeaves(t,e,i,n,r){const s=this.getChildren(e);for(const e of s){const s=e.properties;if(s&&s.cluster?r+s.point_count<=n?r+=s.point_count:r=this._appendLeaves(t,s.cluster_id,i,n,r):r<n?r++:t.push(e),t.length===i)break}return r}_createTree(e){const i=new t.KDBush(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let t=0;t<e.length;t+=this.stride)i.add(e[t],e[t+1]);return i.finish(),i.data=e,i}_addTileFeatures(t,e,i,n,r,s){for(const o of t){const t=o*this.stride,a=e[t+P]>1;let l,c,h;if(a)l=D(e,t,this.clusterProps),c=e[t],h=e[t+1];else{const i=this.points[e[t+I]];l=i.properties;const[n,r]=i.geometry.coordinates;c=O(n),h=k(r)}const u={type:1,geometry:[[Math.round(this.options.extent*(c*r-i)),Math.round(this.options.extent*(h*r-n))]],tags:l};let d;d=a||this.options.generateId?e[t+I]:this.points[e[t+I]].id,void 0!==d&&(u.id=d),s.features.push(u)}}_limitZoom(t){return Math.max(this.options.minZoom,Math.min(Math.floor(+t),this.options.maxZoom+1))}_cluster(t,e){const{radius:i,extent:n,reduce:r,minPoints:s}=this.options,o=i/(n*Math.pow(2,e)),a=t.data,l=[],c=this.stride;for(let i=0;i<a.length;i+=c){if(a[i+2]<=e)continue;a[i+2]=e;const n=a[i],h=a[i+1],u=t.within(a[i],a[i+1],o),d=a[i+P];let p=d;for(const t of u){const i=t*c;a[i+2]>e&&(p+=a[i+P])}if(p>d&&p>=s){let t,s=n*d,o=h*d,f=-1;const m=((i/c|0)<<5)+(e+1)+this.points.length;for(const n of u){const l=n*c;if(a[l+2]<=e)continue;a[l+2]=e;const h=a[l+P];s+=a[l]*h,o+=a[l+1]*h,a[l+4]=m,r&&(t||(t=this._map(a,i,!0),f=this.clusterProps.length,this.clusterProps.push(t)),r(t,this._map(a,l)))}a[i+4]=m,l.push(s/p,o/p,1/0,m,-1,p),r&&l.push(f)}else{for(let t=0;t<c;t++)l.push(a[i+t]);if(p>1)for(const t of u){const i=t*c;if(!(a[i+2]<=e)){a[i+2]=e;for(let t=0;t<c;t++)l.push(a[i+t])}}}}return l}_getOriginId(t){return t-this.points.length>>5}_getOriginZoom(t){return(t-this.points.length)%32}_map(t,e,i){if(t[e+P]>1){const n=this.clusterProps[t[e+L]];return i?Object.assign({},n):n}const n=this.points[t[e+I]].properties,r=this.options.map(n);return i&&r===n?Object.assign({},r):r}}function B(t,e,i){return{type:"Feature",id:t[e+I],properties:D(t,e,i),geometry:{type:"Point",coordinates:[(n=t[e],360*(n-.5)),F(t[e+1])]}};var n}function D(t,e,i){const n=t[e+P],r=n>=1e4?`${Math.round(n/1e3)}k`:n>=1e3?Math.round(n/100)/10+"k":n,s=t[e+L],o=-1===s?{}:Object.assign({},i[s]);return Object.assign(o,{cluster:!0,cluster_id:t[e+I],point_count:n,point_count_abbreviated:r})}function O(t){return t/360+.5}function k(t){const e=Math.sin(t*Math.PI/180),i=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return i<0?0:i>1?1:i}function F(t){const e=(180-360*t)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function z(t,e,i,n){for(var r,s=n,o=i-e>>1,a=i-e,l=t[e],c=t[e+1],h=t[i],u=t[i+1],d=e+3;d<i;d+=3){var p=N(t[d],t[d+1],l,c,h,u);if(p>s)r=d,s=p;else if(p===s){var f=Math.abs(d-o);f<a&&(r=d,a=f)}}s>n&&(r-e>3&&z(t,e,r,n),t[r+2]=s,i-r>3&&z(t,r,i,n))}function N(t,e,i,n,r,s){var o=r-i,a=s-n;if(0!==o||0!==a){var l=((t-i)*o+(e-n)*a)/(o*o+a*a);l>1?(i=r,n=s):l>0&&(i+=o*l,n+=a*l)}return(o=t-i)*o+(a=e-n)*a}function U(t,e,i,n){var r={id:void 0===t?null:t,type:e,geometry:i,tags:n,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(t){var e=t.geometry,i=t.type;if("Point"===i||"MultiPoint"===i||"LineString"===i)G(t,e);else if("Polygon"===i||"MultiLineString"===i)for(var n=0;n<e.length;n++)G(t,e[n]);else if("MultiPolygon"===i)for(n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)G(t,e[n][r])}(r),r}function G(t,e){for(var i=0;i<e.length;i+=3)t.minX=Math.min(t.minX,e[i]),t.minY=Math.min(t.minY,e[i+1]),t.maxX=Math.max(t.maxX,e[i]),t.maxY=Math.max(t.maxY,e[i+1])}function V(t,e,i,n){if(e.geometry){var r=e.geometry.coordinates,s=e.geometry.type,o=Math.pow(i.tolerance/((1<<i.maxZoom)*i.extent),2),a=[],l=e.id;if(i.promoteId?l=e.properties[i.promoteId]:i.generateId&&(l=n||0),"Point"===s)j(r,a);else if("MultiPoint"===s)for(var c=0;c<r.length;c++)j(r[c],a);else if("LineString"===s)H(r,a,o,!1);else if("MultiLineString"===s){if(i.lineMetrics){for(c=0;c<r.length;c++)H(r[c],a=[],o,!1),t.push(U(l,"LineString",a,e.properties));return}W(r,a,o,!1)}else if("Polygon"===s)W(r,a,o,!0);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(c=0;c<e.geometry.geometries.length;c++)V(t,{id:l,geometry:e.geometry.geometries[c],properties:e.properties},i,n);return}throw new Error("Input data is not a valid GeoJSON object.")}for(c=0;c<r.length;c++){var h=[];W(r[c],h,o,!0),a.push(h)}}t.push(U(l,s,a,e.properties))}}function j(t,e){e.push(q(t[0])),e.push(X(t[1])),e.push(0)}function H(t,e,i,n){for(var r,s,o=0,a=0;a<t.length;a++){var l=q(t[a][0]),c=X(t[a][1]);e.push(l),e.push(c),e.push(0),a>0&&(o+=n?(r*c-l*s)/2:Math.sqrt(Math.pow(l-r,2)+Math.pow(c-s,2))),r=l,s=c}var h=e.length-3;e[2]=1,z(e,0,h,i),e[h+2]=1,e.size=Math.abs(o),e.start=0,e.end=e.size}function W(t,e,i,n){for(var r=0;r<t.length;r++){var s=[];H(t[r],s,i,n),e.push(s)}}function q(t){return t/360+.5}function X(t){var e=Math.sin(t*Math.PI/180),i=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return i<0?0:i>1?1:i}function Z(t,e,i,n,r,s,o,a){if(n/=e,s>=(i/=e)&&o<n)return t;if(o<i||s>=n)return null;for(var l=[],c=0;c<t.length;c++){var h=t[c],u=h.geometry,d=h.type,p=0===r?h.minX:h.minY,f=0===r?h.maxX:h.maxY;if(p>=i&&f<n)l.push(h);else if(!(f<i||p>=n)){var m=[];if("Point"===d||"MultiPoint"===d)J(u,m,i,n,r);else if("LineString"===d)Y(u,m,i,n,r,!1,a.lineMetrics);else if("MultiLineString"===d)K(u,m,i,n,r,!1);else if("Polygon"===d)K(u,m,i,n,r,!0);else if("MultiPolygon"===d)for(var g=0;g<u.length;g++){var _=[];K(u[g],_,i,n,r,!0),_.length&&m.push(_)}if(m.length){if(a.lineMetrics&&"LineString"===d){for(g=0;g<m.length;g++)l.push(U(h.id,d,m[g],h.tags));continue}"LineString"!==d&&"MultiLineString"!==d||(1===m.length?(d="LineString",m=m[0]):d="MultiLineString"),"Point"!==d&&"MultiPoint"!==d||(d=3===m.length?"Point":"MultiPoint"),l.push(U(h.id,d,m,h.tags))}}}return l.length?l:null}function J(t,e,i,n,r){for(var s=0;s<t.length;s+=3){var o=t[s+r];o>=i&&o<=n&&(e.push(t[s]),e.push(t[s+1]),e.push(t[s+2]))}}function Y(t,e,i,n,r,s,o){for(var a,l,c=$(t),h=0===r?tt:et,u=t.start,d=0;d<t.length-3;d+=3){var p=t[d],f=t[d+1],m=t[d+2],g=t[d+3],_=t[d+4],y=0===r?p:f,v=0===r?g:_,x=!1;o&&(a=Math.sqrt(Math.pow(p-g,2)+Math.pow(f-_,2))),y<i?v>i&&(l=h(c,p,f,g,_,i),o&&(c.start=u+a*l)):y>n?v<n&&(l=h(c,p,f,g,_,n),o&&(c.start=u+a*l)):Q(c,p,f,m),v<i&&y>=i&&(l=h(c,p,f,g,_,i),x=!0),v>n&&y<=n&&(l=h(c,p,f,g,_,n),x=!0),!s&&x&&(o&&(c.end=u+a*l),e.push(c),c=$(t)),o&&(u+=a)}var b=t.length-3;p=t[b],f=t[b+1],m=t[b+2],(y=0===r?p:f)>=i&&y<=n&&Q(c,p,f,m),b=c.length-3,s&&b>=3&&(c[b]!==c[0]||c[b+1]!==c[1])&&Q(c,c[0],c[1],c[2]),c.length&&e.push(c)}function $(t){var e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function K(t,e,i,n,r,s){for(var o=0;o<t.length;o++)Y(t[o],e,i,n,r,s,!1)}function Q(t,e,i,n){t.push(e),t.push(i),t.push(n)}function tt(t,e,i,n,r,s){var o=(s-e)/(n-e);return t.push(s),t.push(i+(r-i)*o),t.push(1),o}function et(t,e,i,n,r,s){var o=(s-i)/(r-i);return t.push(e+(n-e)*o),t.push(s),t.push(1),o}function it(t,e){for(var i=[],n=0;n<t.length;n++){var r,s=t[n],o=s.type;if("Point"===o||"MultiPoint"===o||"LineString"===o)r=nt(s.geometry,e);else if("MultiLineString"===o||"Polygon"===o){r=[];for(var a=0;a<s.geometry.length;a++)r.push(nt(s.geometry[a],e))}else if("MultiPolygon"===o)for(r=[],a=0;a<s.geometry.length;a++){for(var l=[],c=0;c<s.geometry[a].length;c++)l.push(nt(s.geometry[a][c],e));r.push(l)}i.push(U(s.id,o,r,s.tags))}return i}function nt(t,e){var i=[];i.size=t.size,void 0!==t.start&&(i.start=t.start,i.end=t.end);for(var n=0;n<t.length;n+=3)i.push(t[n]+e,t[n+1],t[n+2]);return i}function rt(t,e){if(t.transformed)return t;var i,n,r,s=1<<t.z,o=t.x,a=t.y;for(i=0;i<t.features.length;i++){var l=t.features[i],c=l.geometry,h=l.type;if(l.geometry=[],1===h)for(n=0;n<c.length;n+=2)l.geometry.push(st(c[n],c[n+1],e,s,o,a));else for(n=0;n<c.length;n++){var u=[];for(r=0;r<c[n].length;r+=2)u.push(st(c[n][r],c[n][r+1],e,s,o,a));l.geometry.push(u)}}return t.transformed=!0,t}function st(t,e,i,n,r,s){return[Math.round(i*(t*n-r)),Math.round(i*(e*n-s))]}function ot(t,e,i,n,r){for(var s=e===r.maxZoom?0:r.tolerance/((1<<e)*r.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:i,y:n,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},a=0;a<t.length;a++){o.numFeatures++,at(o,t[a],s,r);var l=t[a].minX,c=t[a].minY,h=t[a].maxX,u=t[a].maxY;l<o.minX&&(o.minX=l),c<o.minY&&(o.minY=c),h>o.maxX&&(o.maxX=h),u>o.maxY&&(o.maxY=u)}return o}function at(t,e,i,n){var r=e.geometry,s=e.type,o=[];if("Point"===s||"MultiPoint"===s)for(var a=0;a<r.length;a+=3)o.push(r[a]),o.push(r[a+1]),t.numPoints++,t.numSimplified++;else if("LineString"===s)lt(o,r,t,i,!1,!1);else if("MultiLineString"===s||"Polygon"===s)for(a=0;a<r.length;a++)lt(o,r[a],t,i,"Polygon"===s,0===a);else if("MultiPolygon"===s)for(var l=0;l<r.length;l++){var c=r[l];for(a=0;a<c.length;a++)lt(o,c[a],t,i,!0,0===a)}if(o.length){var h=e.tags||null;if("LineString"===s&&n.lineMetrics){for(var u in h={},e.tags)h[u]=e.tags[u];h.mapbox_clip_start=r.start/r.size,h.mapbox_clip_end=r.end/r.size}var d={geometry:o,type:"Polygon"===s||"MultiPolygon"===s?3:"LineString"===s||"MultiLineString"===s?2:1,tags:h};null!==e.id&&(d.id=e.id),t.features.push(d)}}function lt(t,e,i,n,r,s){var o=n*n;if(n>0&&e.size<(r?o:n))i.numPoints+=e.length/3;else{for(var a=[],l=0;l<e.length;l+=3)(0===n||e[l+2]>o)&&(i.numSimplified++,a.push(e[l]),a.push(e[l+1])),i.numPoints++;r&&function(t,e){for(var i=0,n=0,r=t.length,s=r-2;n<r;s=n,n+=2)i+=(t[n]-t[s])*(t[n+1]+t[s+1]);if(i>0===e)for(n=0,r=t.length;n<r/2;n+=2){var o=t[n],a=t[n+1];t[n]=t[r-2-n],t[n+1]=t[r-1-n],t[r-2-n]=o,t[r-1-n]=a}}(a,s),t.push(a)}}function ct(t,e){var i=(e=this.options=function(t,e){for(var i in e)t[i]=e[i];return t}(Object.create(this.options),e)).debug;if(e.maxZoom<0||e.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(e.promoteId&&e.generateId)throw new Error("promoteId and generateId cannot be used together.");var n=function(t,e){var i=[];if("FeatureCollection"===t.type)for(var n=0;n<t.features.length;n++)V(i,t.features[n],e,n);else V(i,"Feature"===t.type?t:{geometry:t},e);return i}(t,e);this.tiles={},this.tileCoords=[],i&&(this.stats={},this.total=0),n=function(t,e){var i=e.buffer/e.extent,n=t,r=Z(t,1,-1-i,i,0,-1,2,e),s=Z(t,1,1-i,2+i,0,-1,2,e);return(r||s)&&(n=Z(t,1,-i,1+i,0,-1,2,e)||[],r&&(n=it(r,1).concat(n)),s&&(n=n.concat(it(s,-1)))),n}(n,e),n.length&&this.splitTile(n,0,0,0)}function ht(t,e,i){return 32*((1<<t)*i+e)+t}function ut(e,i){const n=e.tileID.canonical;if(!this._geoJSONIndex)return i(null,null);const r=this._geoJSONIndex.getTile(n.z,n.x,n.y);if(!r)return i(null,null);const s=new class{constructor(e){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=t.EXTENT,this.length=e.length,this._features=e}feature(e){return new class{constructor(e){this._feature=e,this.extent=t.EXTENT,this.type=e.type,this.properties=e.tags,"id"in e&&!isNaN(e.id)&&(this.id=parseInt(e.id,10))}loadGeometry(){if(1===this._feature.type){const e=[];for(const i of this._feature.geometry)e.push([new t.Point(i[0],i[1])]);return e}{const e=[];for(const i of this._feature.geometry){const n=[];for(const e of i)n.push(new t.Point(e[0],e[1]));e.push(n)}return e}}toGeoJSON(t,e,i){return l.call(this,t,e,i)}}(this._features[e])}}(r.features);let o=M(s);0===o.byteOffset&&o.byteLength===o.buffer.byteLength||(o=new Uint8Array(o)),i(null,{vectorTile:s,rawData:o.buffer})}ct.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},ct.prototype.splitTile=function(t,e,i,n,r,s,o){for(var a=[t,e,i,n],l=this.options,c=l.debug;a.length;){n=a.pop(),i=a.pop(),e=a.pop(),t=a.pop();var h=1<<e,u=ht(e,i,n),d=this.tiles[u];if(!d&&(d=this.tiles[u]=ot(t,e,i,n,l),this.tileCoords.push({z:e,x:i,y:n}),c)){var p="z"+e;this.stats[p]=(this.stats[p]||0)+1,this.total++}if(d.source=t,r){if(e===l.maxZoom||e===r)continue;var f=1<<r-e;if(i!==Math.floor(s/f)||n!==Math.floor(o/f))continue}else if(e===l.indexMaxZoom||d.numPoints<=l.indexMaxPoints)continue;if(d.source=null,0!==t.length){var m,g,_,y,v,x,b=.5*l.buffer/l.extent,w=.5-b,A=.5+b,T=1+b;m=g=_=y=null,v=Z(t,h,i-b,i+A,0,d.minX,d.maxX,l),x=Z(t,h,i+w,i+T,0,d.minX,d.maxX,l),t=null,v&&(m=Z(v,h,n-b,n+A,1,d.minY,d.maxY,l),g=Z(v,h,n+w,n+T,1,d.minY,d.maxY,l),v=null),x&&(_=Z(x,h,n-b,n+A,1,d.minY,d.maxY,l),y=Z(x,h,n+w,n+T,1,d.minY,d.maxY,l),x=null),a.push(m||[],e+1,2*i,2*n),a.push(g||[],e+1,2*i,2*n+1),a.push(_||[],e+1,2*i+1,2*n),a.push(y||[],e+1,2*i+1,2*n+1)}}},ct.prototype.getTile=function(t,e,i){var n=this.options,r=n.extent;if(t<0||t>24)return null;var s=1<<t,o=ht(t,e=(e%s+s)%s,i);if(this.tiles[o])return rt(this.tiles[o],r);for(var a,l=t,c=e,h=i;!a&&l>0;)l--,c=Math.floor(c/2),h=Math.floor(h/2),a=this.tiles[ht(l,c,h)];return a&&a.source?(this.splitTile(a.source,l,c,h,t,e,i),this.tiles[o]?rt(this.tiles[o],r):null):null};class dt extends t.VectorTileWorkerSource{constructor(t,e,i,n,r){super(t,e,i,n,ut),r&&(this.loadGeoJSON=r)}loadData(e,i){const n=e&&e.request,r=n&&n.collectResourceTiming;this.loadGeoJSON(e,((s,o)=>{if(s||!o)return i(s);if("object"!=typeof o)return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));{a(o,!0);try{if(e.filter){const i=t.createExpression(e.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===i.result)throw new Error(i.value.map((t=>`${t.key}: ${t.message}`)).join(", "));const n=o.features.filter((t=>i.value.evaluate({zoom:0},t)));o={type:"FeatureCollection",features:n}}this._geoJSONIndex=e.cluster?new R(function({superclusterOptions:e,clusterProperties:i}){if(!i||!e)return e;const n={},r={},s={accumulated:null,zoom:0},o={properties:null},a=Object.keys(i);for(const e of a){const[s,o]=i[e],a=t.createExpression(o),l=t.createExpression("string"==typeof s?[s,["accumulated"],["get",e]]:s);n[e]=a.value,r[e]=l.value}return e.map=t=>{o.properties=t;const e={};for(const t of a)e[t]=n[t].evaluate(s,o);return e},e.reduce=(t,e)=>{o.properties=e;for(const e of a)s.accumulated=t[e],t[e]=r[e].evaluate(s,o)},e}(e)).load(o.features):function(t,e){return new ct(t,e)}(o,e.geojsonVtOptions)}catch(s){return i(s)}this.loaded={};const l={};if(r){const i=t.getPerformanceMeasurement(n);i&&(l.resourceTiming={},l.resourceTiming[e.source]=JSON.parse(JSON.stringify(i)))}i(null,l)}}))}reloadTile(t,e){const i=this.loaded;return i&&i[t.uid]?super.reloadTile(t,e):this.loadTile(t,e)}loadGeoJSON(e,i){if(e.request)t.getJSON(e.request,i);else{if("string"!=typeof e.data)return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`));try{return i(null,JSON.parse(e.data))}catch(t){return i(new Error(`Input data given to '${e.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(t,e){try{e(null,this._geoJSONIndex.getClusterExpansionZoom(t.clusterId))}catch(t){e(t)}}getClusterChildren(t,e){try{e(null,this._geoJSONIndex.getChildren(t.clusterId))}catch(t){e(t)}}getClusterLeaves(t,e){try{e(null,this._geoJSONIndex.getLeaves(t.clusterId,t.limit,t.offset))}catch(t){e(t)}}}class pt{constructor(e){this.self=e,this.actor=new t.Actor(e,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=t.getProjection({name:"mercator"}),this.workerSourceTypes={vector:t.VectorTileWorkerSource,geojson:dt},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(t,e)=>{if(this.workerSourceTypes[t])throw new Error(`Worker source with name "${t}" already registered.`);this.workerSourceTypes[t]=e},this.self.registerRTLTextPlugin=e=>{if(t.plugin.isParsed())throw new Error("RTL text plugin already registered.");t.plugin.applyArabicShaping=e.applyArabicShaping,t.plugin.processBidirectionalText=e.processBidirectionalText,t.plugin.processStyledBidirectionalText=e.processStyledBidirectionalText}}clearCaches(t,e,i){delete this.layerIndexes[t],delete this.availableImages[t],delete this.workerSources[t],delete this.demWorkerSources[t],i()}checkIfReady(t,e,i){i()}setReferrer(t,e){this.referrer=e}spriteLoaded(e,i){this.isSpriteLoaded[e]=i;for(const n in this.workerSources[e]){const r=this.workerSources[e][n];for(const e in r)r[e]instanceof t.VectorTileWorkerSource&&(r[e].isSpriteLoaded=i,r[e].fire(new t.Event("isSpriteLoaded")))}}setImages(t,e,i){this.availableImages[t]=e;for(const i in this.workerSources[t]){const n=this.workerSources[t][i];for(const t in n)n[t].availableImages=e}i()}enableTerrain(t,e,i){this.terrain=e,i()}setProjection(e,i){this.projections[e]=t.getProjection(i)}setLayers(t,e,i){this.getLayerIndex(t).replace(e),i()}updateLayers(t,e,i){this.getLayerIndex(t).update(e.layers,e.removedIds),i()}loadTile(e,i,n){const r=this.enableTerrain?t.extend({enableTerrain:this.terrain},i):i;r.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,i.type,i.source).loadTile(r,n)}loadDEMTile(e,i,n){const r=this.enableTerrain?t.extend({buildQuadTree:this.terrain},i):i;this.getDEMWorkerSource(e,i.source).loadTile(r,n)}reloadTile(e,i,n){const r=this.enableTerrain?t.extend({enableTerrain:this.terrain},i):i;r.projection=this.projections[e]||this.defaultProjection,this.getWorkerSource(e,i.type,i.source).reloadTile(r,n)}abortTile(t,e,i){this.getWorkerSource(t,e.type,e.source).abortTile(e,i)}removeTile(t,e,i){this.getWorkerSource(t,e.type,e.source).removeTile(e,i)}removeSource(t,e,i){if(!this.workerSources[t]||!this.workerSources[t][e.type]||!this.workerSources[t][e.type][e.source])return;const n=this.workerSources[t][e.type][e.source];delete this.workerSources[t][e.type][e.source],void 0!==n.removeSource?n.removeSource(e,i):i()}loadWorkerSource(t,e,i){try{this.self.importScripts(e.url),i()}catch(t){i(t.toString())}}syncRTLPluginState(e,i,n){try{t.plugin.setState(i);const e=t.plugin.getPluginURL();if(t.plugin.isLoaded()&&!t.plugin.isParsed()&&null!=e){this.self.importScripts(e);const i=t.plugin.isParsed();n(i?void 0:new Error(`RTL Text Plugin failed to import scripts from ${e}`),i)}}catch(t){n(t.toString())}}getAvailableImages(t){let e=this.availableImages[t];return e||(e=[]),e}getLayerIndex(t){let e=this.layerIndexes[t];return e||(e=this.layerIndexes[t]=new n),e}getWorkerSource(t,e,i){if(this.workerSources[t]||(this.workerSources[t]={}),this.workerSources[t][e]||(this.workerSources[t][e]={}),!this.workerSources[t][e][i]){const n={send:(e,i,n,r,s,o)=>{this.actor.send(e,i,n,t,s,o)},scheduler:this.actor.scheduler};this.workerSources[t][e][i]=new this.workerSourceTypes[e](n,this.getLayerIndex(t),this.getAvailableImages(t),this.isSpriteLoaded[t])}return this.workerSources[t][e][i]}getDEMWorkerSource(t,e){return this.demWorkerSources[t]||(this.demWorkerSources[t]={}),this.demWorkerSources[t][e]||(this.demWorkerSources[t][e]=new r),this.demWorkerSources[t][e]}enforceCacheSizeLimit(e,i){t.enforceCacheSizeLimit(i)}getWorkerPerformanceMetrics(t,e,i){i(void 0,void 0)}}return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new pt(self)),pt})),n(["./shared"],(function(t){function e(t,i){if(Array.isArray(t)){if(!Array.isArray(i)||t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],i[n]))return!1;return!0}if("object"==typeof t&&null!==t&&null!==i){if("object"!=typeof i)return!1;if(Object.keys(t).length!==Object.keys(i).length)return!1;for(const n in t)if(!e(t[n],i[n]))return!1;return!0}return t===i}var i=n;function n(t){return!function(t){return"undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var t,e,i=new Blob([""],{type:"text/javascript"}),n=URL.createObjectURL(i);try{e=new Worker(n),t=!0}catch(e){t=!1}return e&&e.terminate(),URL.revokeObjectURL(n),t}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var t=document.createElement("canvas");t.width=t.height=1;var e=t.getContext("2d");if(!e)return!1;var i=e.getImageData(0,0,1,1);return i&&i.width===t.width}()?(void 0===r[e=t&&t.failIfMajorPerformanceCaveat]&&(r[e]=function(t){var e,i=function(t){var e=document.createElement("canvas"),i=Object.create(n.webGLContextAttributes);return i.failIfMajorPerformanceCaveat=t,e.getContext("webgl",i)||e.getContext("experimental-webgl",i)}(t);if(!i)return!1;try{e=i.createShader(i.VERTEX_SHADER)}catch(t){return!1}return!(!e||i.isContextLost())&&(i.shaderSource(e,"void main() {}"),i.compileShader(e),!0===i.getShaderParameter(e,i.COMPILE_STATUS))}(e)),r[e]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var e}(t)}var r={};function s(e,i,n){const r=t.window.document.createElement(e);return void 0!==i&&(r.className=i),n&&n.appendChild(r),r}function o(e,i,n){const r=t.window.document.createElementNS("http://www.w3.org/2000/svg",e);for(const t of Object.keys(i))r.setAttributeNS(null,t,i[t]);return n&&n.appendChild(r),r}n.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const a=t.window.document&&t.window.document.documentElement.style,l=a&&void 0!==a.userSelect?"userSelect":"WebkitUserSelect";let c;function h(){a&&l&&(c=a[l],a[l]="none")}function u(){a&&l&&(a[l]=c)}function d(e){e.preventDefault(),e.stopPropagation(),t.window.removeEventListener("click",d,!0)}function p(){t.window.addEventListener("click",d,!0),t.window.setTimeout((()=>{t.window.removeEventListener("click",d,!0)}),0)}function f(t,e){const i=t.getBoundingClientRect();return _(t,i,e)}function m(t,e){const i=t.getBoundingClientRect(),n=[];for(let r=0;r<e.length;r++)n.push(_(t,i,e[r]));return n}function g(e){return void 0!==t.window.InstallTrigger&&2===e.button&&e.ctrlKey&&t.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:e.button}function _(e,i,n){const r=e.offsetWidth===i.width?1:e.offsetWidth/i.width;return new t.Point((n.clientX-i.left)*r,(n.clientY-i.top)*r)}function y(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i*s-r*n;return o?(t[0]=s*(o=1/o),t[1]=-n*o,t[2]=-r*o,t[3]=i*o,t):null}function v(t){const{userImage:e}=t;return!!(e&&e.render&&e.render())&&(t.data.replace(new Uint8Array(e.data.buffer)),!0)}class x extends t.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new t.RGBAImage({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(t){if(this.loaded!==t&&(this.loaded=t,t)){for(const{ids:t,callback:e}of this.requestors)this._notify(t,e);this.requestors=[]}}hasImage(t){return!!this.getImage(t)}getImage(t){return this.images[t]}addImage(t,e){this._validate(t,e)&&(this.images[t]=e)}_validate(e,i){let n=!0;return this._validateStretch(i.stretchX,i.data&&i.data.width)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "stretchX" value`))),n=!1),this._validateStretch(i.stretchY,i.data&&i.data.height)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "stretchY" value`))),n=!1),this._validateContent(i.content,i)||(this.fire(new t.ErrorEvent(new Error(`Image "${e}" has invalid "content" value`))),n=!1),n}_validateStretch(t,e){if(!t)return!0;let i=0;for(const n of t){if(n[0]<i||n[1]<n[0]||e<n[1])return!1;i=n[1]}return!0}_validateContent(t,e){return!(t&&(4!==t.length||t[0]<0||e.data.width<t[0]||t[1]<0||e.data.height<t[1]||t[2]<0||e.data.width<t[2]||t[3]<0||e.data.height<t[3]||t[2]<t[0]||t[3]<t[1]))}updateImage(t,e){e.version=this.images[t].version+1,this.images[t]=e,this.updatedImages[t]=!0}removeImage(t){const e=this.images[t];delete this.images[t],delete this.patterns[t],e.userImage&&e.userImage.onRemove&&e.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(t,e){let i=!0;if(!this.isLoaded())for(const e of t)this.images[e]||(i=!1);this.isLoaded()||i?this._notify(t,e):this.requestors.push({ids:t,callback:e})}_notify(e,i){const n={};for(const i of e){this.images[i]||this.fire(new t.Event("styleimagemissing",{id:i}));const e=this.images[i];e?n[i]={data:e.data.clone(),pixelRatio:e.pixelRatio,sdf:e.sdf,version:e.version,stretchX:e.stretchX,stretchY:e.stretchY,content:e.content,hasRenderCallback:Boolean(e.userImage&&e.userImage.render)}:t.warnOnce(`Image "${i}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}i(null,n)}getPixelSize(){const{width:t,height:e}=this.atlasImage;return{width:t,height:e}}getPattern(e){const i=this.patterns[e],n=this.getImage(e);if(!n)return null;if(i&&i.position.version===n.version)return i.position;if(i)i.position.version=n.version;else{const i={w:n.data.width+2,h:n.data.height+2,x:0,y:0},r=new t.ImagePosition(i,n);this.patterns[e]={bin:i,position:r}}return this._updatePatternAtlas(),this.patterns[e].position}bind(e){const i=e.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new t.Texture(e,this.atlasImage,i.RGBA),this.atlasTexture&&this.atlasTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE)}_updatePatternAtlas(){const e=[];for(const t in this.patterns)e.push(this.patterns[t].bin);const{w:i,h:n}=t.potpack(e),r=this.atlasImage;r.resize({width:i||1,height:n||1});for(const e in this.patterns){const{bin:i}=this.patterns[e],n=i.x+1,s=i.y+1,o=this.images[e].data,a=o.width,l=o.height;t.RGBAImage.copy(o,r,{x:0,y:0},{x:n,y:s},{width:a,height:l}),t.RGBAImage.copy(o,r,{x:0,y:l-1},{x:n,y:s-1},{width:a,height:1}),t.RGBAImage.copy(o,r,{x:0,y:0},{x:n,y:s+l},{width:a,height:1}),t.RGBAImage.copy(o,r,{x:a-1,y:0},{x:n-1,y:s},{width:1,height:l}),t.RGBAImage.copy(o,r,{x:0,y:0},{x:n+a,y:s},{width:1,height:l})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(t){for(const e of t){if(this.callbackDispatchedThisFrame[e])continue;this.callbackDispatchedThisFrame[e]=!0;const t=this.images[e];v(t)&&this.updateImage(e,t)}}}const b=new t.Properties({anchor:new t.DataConstantProperty(t.spec.light.anchor),position:new class{constructor(){this.specification=t.spec.light.position}possiblyEvaluate(e,i){return function([e,i,n]){const r=t.degToRad(i+90),s=t.degToRad(n);return{x:e*Math.cos(r)*Math.sin(s),y:e*Math.sin(r)*Math.sin(s),z:e*Math.cos(s),azimuthal:i,polar:n}}(e.expression.evaluate(i))}interpolate(e,i,n){return{x:t.number(e.x,i.x,n),y:t.number(e.y,i.y,n),z:t.number(e.z,i.z,n),azimuthal:t.number(e.azimuthal,i.azimuthal,n),polar:t.number(e.polar,i.polar,n)}}},color:new t.DataConstantProperty(t.spec.light.color),intensity:new t.DataConstantProperty(t.spec.light.intensity)});class w extends t.Evented{constructor(e){super(),this._transitionable=new t.Transitionable(b),this.setLight(e),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(e,i={}){if(!this._validate(t.validateLight,e,i))for(const i in e){const n=e[i];t.endsWith(i,"-transition")?this._transitionable.setTransition(i.slice(0,-11),n):this._transitionable.setValue(i,n)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(e,i,n){return(!n||!1!==n.validate)&&t.emitValidationErrors(this,e.call(t.validateStyle,t.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.spec})))}}const A=new t.Properties({source:new t.DataConstantProperty(t.spec.terrain.source),exaggeration:new t.DataConstantProperty(t.spec.terrain.exaggeration)});let T=class extends t.Evented{constructor(e,i){super(),this._transitionable=new t.Transitionable(A),this.set(e),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i}get(){return this._transitionable.serialize()}set(e){for(const i in e){const n=e[i];t.endsWith(i,"-transition")?this._transitionable.setTransition(i.slice(0,-11),n):this._transitionable.setValue(i,n)}}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}};function M(e,i,n,r){const s=t.smoothstep(45,65,n),[o,a]=S(e,r),l=t.length(i);let c=1-Math.min(1,Math.exp((l-o)/(a-o)*-6));return c*=c*c,c=Math.min(1,1.00747*c),c*s*e.alpha}function S(t,e){const i=.5/Math.tan(.5*e);return[t.range[0]+i,t.range[1]+i]}const E=new t.Properties({range:new t.DataConstantProperty(t.spec.fog.range),color:new t.DataConstantProperty(t.spec.fog.color),"high-color":new t.DataConstantProperty(t.spec.fog["high-color"]),"space-color":new t.DataConstantProperty(t.spec.fog["space-color"]),"horizon-blend":new t.DataConstantProperty(t.spec.fog["horizon-blend"]),"star-intensity":new t.DataConstantProperty(t.spec.fog["star-intensity"])});class C extends t.Evented{constructor(e,i){super(),this._transitionable=new t.Transitionable(E),this.set(e),this._transitioning=this._transitionable.untransitioned(),this._transform=i}get state(){const e=this._transform,i="globe"===e.projection.name,n=t.globeToMercatorTransition(e.zoom),r=this.properties.get("range"),s=[.5,3];return{range:i?[t.number(s[0],r[0],n),t.number(s[1],r[1],n)]:r,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(e,i={}){if(!this._validate(t.validateFog,e,i)){for(const i of Object.keys(t.spec.fog))e&&void 0===e[i]&&(e[i]=t.spec.fog[i].default);for(const i in e){const n=e[i];t.endsWith(i,"-transition")?this._transitionable.setTransition(i.slice(0,-11),n):this._transitionable.setValue(i,n)}}}getOpacity(e){if(!this._transform.projection.supportsFog)return 0;const i=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:t.smoothstep(45,65,e))*i.a}getOpacityAtLatLng(e,i){return this._transform.projection.supportsFog?function(e,i,n){const r=t.MercatorCoordinate.fromLngLat(i),s=n.elevation?n.elevation.getAtPointOrZero(r):0,o=[r.x,r.y,s];return t.transformMat4(o,o,n.mercatorFogMatrix),M(e,o,n.pitch,n._fov)}(this.state,e,i):0}getFovAdjustedRange(t){return this._transform.projection.supportsFog?S(this.state,t):[0,1]}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(e,i,n){return(!n||!1!==n.validate)&&t.emitValidationErrors(this,e.call(t.validateStyle,t.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:t.spec})))}}class I{constructor(e,i){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=t.uniqueId();const n=this.workerPool.acquire(this.id);for(let t=0;t<n.length;t++){const e=new I.Actor(n[t],i,this.id);e.name=`Worker ${t}`,this.actors.push(e)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,i,n){t.asyncAll(this.actors,((t,n)=>{t.send(e,i,n)}),n=n||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((t=>{t.remove()})),this.actors=[],this.workerPool.release(this.id)}}function P(e,i,n){return i*(t.EXTENT/(e.tileSize*Math.pow(2,n-e.tileID.overscaledZ)))}I.Actor=t.Actor;class L{constructor(t,e,i,n){this.screenBounds=t,this.cameraPoint=e,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=i,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,n)}static createFromScreenPoints(e,i){let n,r;if(e instanceof t.Point||"number"==typeof e[0]){const s=t.Point.convert(e);n=[s],r=i.isPointAboveHorizon(s)}else{const s=t.Point.convert(e[0]),o=t.Point.convert(e[1]);n=[s,o],r=t.polygonizeBounds(s,o).every((t=>i.isPointAboveHorizon(t)))}return new L(n,i.getCameraPoint(),r,i)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(e){return t.polygonizeBounds(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],e)}bufferedCameraGeometry(e){const i=this.screenBounds[0],n=1===this.screenBounds.length?this.screenBounds[0].add(new t.Point(1,1)):this.screenBounds[1],r=t.polygonizeBounds(i,n,0,!1);return this.cameraPoint.y>n.y&&(this.cameraPoint.x>i.x&&this.cameraPoint.x<n.x?r.splice(3,0,this.cameraPoint):this.cameraPoint.x>=n.x?r[2]=this.cameraPoint:this.cameraPoint.x<=i.x&&(r[3]=this.cameraPoint)),t.bufferConvexPolygon(r,e)}bufferedCameraGeometryGlobe(e){const i=this.screenBounds[0],n=1===this.screenBounds.length?this.screenBounds[0].add(new t.Point(1,1)):this.screenBounds[1],r=t.polygonizeBounds(i,n,e),s=this.cameraPoint.clone();switch(3*((s.y>i.y)+(s.y>n.y))+((s.x>i.x)+(s.x>n.x))){case 0:r[0]=s,r[4]=s.clone();break;case 1:r.splice(1,0,s);break;case 2:r[1]=s;break;case 3:r.splice(4,0,s);break;case 5:r.splice(2,0,s);break;case 6:r[3]=s;break;case 7:r.splice(3,0,s);break;case 8:r[2]=s}return r}containsTile(e,i,n,r=0){const s=e.queryPadding/i._pixelsPerMercatorPixel+1,o=n?this._bufferedCameraMercator(s,i):this._bufferedScreenMercator(s,i);let a=e.tileID.wrap+(o.unwrapped?r:0);const l=o.polygon.map((i=>t.getTilePoint(e.tileTransform,i,a)));if(!t.polygonIntersectsBox(l,0,0,t.EXTENT,t.EXTENT))return;a=e.tileID.wrap+(this.screenGeometryMercator.unwrapped?r:0);const c=this.screenGeometryMercator.polygon.map((i=>t.getTileVec3(e.tileTransform,i,a))),h=c.map((e=>new t.Point(e[0],e[1]))),u=i.getFreeCameraOptions().position||new t.MercatorCoordinate(0,0,0),d=t.getTileVec3(e.tileTransform,u,a),p=c.map((e=>{const i=t.sub(e,e,d);return t.normalize(i,i),new t.Ray(d,i)})),f=P(e,1,i.zoom)*i._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:h,tilespaceRays:p,bufferedTilespaceGeometry:l,bufferedTilespaceBounds:(m=t.getBounds(l),m.min.x=t.clamp(m.min.x,0,t.EXTENT),m.min.y=t.clamp(m.min.y,0,t.EXTENT),m.max.x=t.clamp(m.max.x,0,t.EXTENT),m.max.y=t.clamp(m.max.y,0,t.EXTENT),m),tile:e,tileID:e.tileID,pixelToTileUnitsFactor:f};var m}_bufferedScreenMercator(t,e){const i=D(t);if(this._screenRaycastCache[i])return this._screenRaycastCache[i];{let n;return n="globe"===e.projection.name?this._projectAndResample(this.bufferedScreenGeometry(t),e):{polygon:this.bufferedScreenGeometry(t).map((t=>e.pointCoordinate3D(t))),unwrapped:!0},this._screenRaycastCache[i]=n,n}}_bufferedCameraMercator(t,e){const i=D(t);if(this._cameraRaycastCache[i])return this._cameraRaycastCache[i];{let n;return n="globe"===e.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),e):{polygon:this.bufferedCameraGeometry(t).map((t=>e.pointCoordinate3D(t))),unwrapped:!0},this._cameraRaycastCache[i]=n,n}}_projectAndResample(e,i){const n=function(e,i){const n=t.multiply([],i.pixelMatrix,i.globeMatrix),r=[0,-t.GLOBE_RADIUS,0,1],s=[0,t.GLOBE_RADIUS,0,1],o=[0,0,0,1];t.transformMat4$1(r,r,n),t.transformMat4$1(s,s,n),t.transformMat4$1(o,o,n);const a=new t.Point(r[0]/r[3],r[1]/r[3]),l=new t.Point(s[0]/s[3],s[1]/s[3]),c=t.polygonContainsPoint(e,a)&&r[3]<o[3],h=t.polygonContainsPoint(e,l)&&s[3]<o[3];if(!c&&!h)return null;const u=function(t,e,i){for(let n=1;n<t.length;n++){const r=B(e.pointCoordinate3D(t[n-1]).x),s=B(e.pointCoordinate3D(t[n]).x);if(i<0){if(r<s)return{idx:n,t:-r/(s-1-r)}}else if(s<r)return{idx:n,t:(1-r)/(s+1-r)}}return null}(e,i,c?-1:1);if(!u)return null;const{idx:d,t:p}=u;let f=d>1?R(e.slice(0,d),i):[],m=d<e.length?R(e.slice(d),i):[];f=f.map((e=>new t.Point(B(e.x),e.y))),m=m.map((e=>new t.Point(B(e.x),e.y)));const g=[...f];0===g.length&&g.push(m[m.length-1]);const _=t.number(g[g.length-1].y,(0===m.length?f[0]:m[0]).y,p);let y;return y=c?[new t.Point(0,_),new t.Point(0,0),new t.Point(1,0),new t.Point(1,_)]:[new t.Point(1,_),new t.Point(1,1),new t.Point(0,1),new t.Point(0,_)],g.push(...y),0===m.length?g.push(f[0]):g.push(...m),{polygon:g.map((e=>new t.MercatorCoordinate(e.x,e.y))),unwrapped:!1}}(e,i);if(n)return n;const r=function(e,i){let n=!1,r=-1/0,s=0;for(let t=0;t<e.length-1;t++)e[t].x>r&&(r=e[t].x,s=t);for(let t=0;t<e.length-1;t++){const i=(s+t)%(e.length-1),r=e[i],o=e[i+1];Math.abs(r.x-o.x)>.5&&(r.x<o.x?(r.x+=1,0===i&&(e[e.length-1].x+=1)):(o.x+=1,i+1===e.length-1&&(e[0].x+=1)),n=!0)}const o=t.mercatorXfromLng(i.center.lng);return n&&o<Math.abs(o-1)&&e.forEach((t=>{t.x-=1})),{polygon:e,unwrapped:n}}(R(e,i).map((e=>new t.Point(B(e.x),e.y))),i);return{polygon:r.polygon.map((e=>new t.MercatorCoordinate(e.x,e.y))),unwrapped:r.unwrapped}}}function R(e,i){return t.resample(e,(t=>{const e=i.pointCoordinate3D(t);t.x=e.x,t.y=e.y}),1/256)}function B(t){return t<0?1+t%1:t%1}function D(t){return 100*t|0}function O(e,i,n,r,s){const o=function(n,r){if(n)return s(n);if(r){e.url&&r.tiles&&e.tiles&&delete e.tiles;const n=t.pick(t.extend(r,e),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);r.vector_layers&&(n.vectorLayers=r.vector_layers,n.vectorLayerIds=n.vectorLayers.map((t=>t.id))),n.tiles=i.canonicalizeTileset(n,e.url),s(null,n)}};return e.url?t.getJSON(i.transformRequest(i.normalizeSourceURL(e.url,null,n,r),t.ResourceType.Source),o):t.exported.frame((()=>o(null,e)))}class k{constructor(e,i,n){this.bounds=t.LngLatBounds.convert(this.validateBounds(e)),this.minzoom=i||0,this.maxzoom=n||24}validateBounds(t){return Array.isArray(t)&&4===t.length?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(e){const i=Math.pow(2,e.z),n=Math.floor(t.mercatorXfromLng(this.bounds.getWest())*i),r=Math.floor(t.mercatorYfromLat(this.bounds.getNorth())*i),s=Math.ceil(t.mercatorXfromLng(this.bounds.getEast())*i),o=Math.ceil(t.mercatorYfromLat(this.bounds.getSouth())*i);return e.x>=n&&e.x<s&&e.y>=r&&e.y<o}}class F{constructor(t,e,i){this.context=t;const n=t.gl;this.buffer=n.createBuffer(),this.dynamicDraw=Boolean(i),this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?n.DYNAMIC_DRAW:n.STATIC_DRAW),this.dynamicDraw||e.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){const e=this.context.gl;this.context.unbindVAO(),this.bind(),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const z={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class N{constructor(t,e,i,n){this.length=e.length,this.attributes=i,this.itemSize=e.bytesPerElement,this.dynamicDraw=n,this.context=t;const r=t.gl;this.buffer=r.createBuffer(),t.bindVertexBuffer.set(this.buffer),r.bufferData(r.ARRAY_BUFFER,e.arrayBuffer,this.dynamicDraw?r.DYNAMIC_DRAW:r.STATIC_DRAW),this.dynamicDraw||e.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const e=this.context.gl;this.bind(),e.bufferSubData(e.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,e){for(let i=0;i<this.attributes.length;i++){const n=e.attributes[this.attributes[i].name];void 0!==n&&t.enableVertexAttribArray(n)}}setVertexAttribPointers(t,e,i){for(let n=0;n<this.attributes.length;n++){const r=this.attributes[n],s=e.attributes[r.name];void 0!==s&&t.vertexAttribPointer(s,r.components,t[z[r.type]],!1,this.itemSize,r.offset+this.itemSize*(i||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class U{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class G extends U{getDefault(){return t.Color.transparent}set(t){const e=this.current;(t.r!==e.r||t.g!==e.g||t.b!==e.b||t.a!==e.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class V extends U{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class j extends U{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class H extends U{getDefault(){return[!0,!0,!0,!0]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class W extends U{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class q extends U{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class X extends U{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const e=this.current;(t.func!==e.func||t.ref!==e.ref||t.mask!==e.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Z extends U{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class J extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.current=t,this.dirty=!1}}class Y extends U{getDefault(){return[0,1]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class $ extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.current=t,this.dirty=!1}}class K extends U{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Q extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.current=t,this.dirty=!1}}class tt extends U{getDefault(){const t=this.gl;return[t.ONE,t.ZERO]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||this.dirty)&&(this.gl.blendFunc(t[0],t[1]),this.current=t,this.dirty=!1)}}class et extends U{getDefault(){return t.Color.transparent}set(t){const e=this.current;(t.r!==e.r||t.g!==e.g||t.b!==e.b||t.a!==e.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class it extends U{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquation(t),this.current=t,this.dirty=!1)}}class nt extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;t?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this.current=t,this.dirty=!1}}class rt extends U{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class st extends U{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let ot,at=class extends U{getDefault(){return null}set(t){(t!==this.current||this.dirty)&&(this.gl.useProgram(t),this.current=t,this.dirty=!1)}};class lt extends U{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class ct extends U{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const e=this.current;(t[0]!==e[0]||t[1]!==e[1]||t[2]!==e[2]||t[3]!==e[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class ht extends U{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class ut extends U{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindRenderbuffer(e.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class dt extends U{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindTexture(e.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class pt extends U{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class ft extends U{getDefault(){return null}set(t){const e=this.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class mt extends U{constructor(t){super(t),this.vao=t.extVertexArrayObject}getDefault(){return null}set(t){this.vao&&(t!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(t),this.current=t,this.dirty=!1)}}class gt extends U{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class _t extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class yt extends U{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class vt extends U{constructor(t,e){super(t),this.context=t,this.parent=e}getDefault(){return null}}class xt extends vt{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const e=this.gl;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class bt extends vt{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const e=this.gl;e.framebufferRenderbuffer(e.FRAMEBUFFER,this.attachment(),e.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class wt extends bt{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class At{constructor(t,e,i,n){this.context=t,this.width=e,this.height=i;const r=this.framebuffer=t.gl.createFramebuffer();this.colorAttachment=new xt(t,r),n&&(this.depthAttachment=new bt(t,r))}destroy(){const t=this.context.gl,e=this.colorAttachment.get();if(e&&t.deleteTexture(e),this.depthAttachment){const e=this.depthAttachment.get();e&&t.deleteRenderbuffer(e)}t.deleteFramebuffer(this.framebuffer)}}class Tt{constructor(t,e=!1){if(this.gl=t,this.isWebGL2=e,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),e){const e=t;this.extVertexArrayObject={createVertexArrayOES:e.createVertexArray.bind(t),deleteVertexArrayOES:e.deleteVertexArray.bind(t),bindVertexArrayOES:e.bindVertexArray.bind(t)}}this.clearColor=new G(this),this.clearDepth=new V(this),this.clearStencil=new j(this),this.colorMask=new H(this),this.depthMask=new W(this),this.stencilMask=new q(this),this.stencilFunc=new X(this),this.stencilOp=new Z(this),this.stencilTest=new J(this),this.depthRange=new Y(this),this.depthTest=new $(this),this.depthFunc=new K(this),this.blend=new Q(this),this.blendFunc=new tt(this),this.blendColor=new et(this),this.blendEquation=new it(this),this.cullFace=new nt(this),this.cullFaceSide=new rt(this),this.frontFace=new st(this),this.program=new at(this),this.activeTexture=new lt(this),this.viewport=new ct(this),this.bindFramebuffer=new ht(this),this.bindRenderbuffer=new ut(this),this.bindTexture=new dt(this),this.bindVertexBuffer=new pt(this),this.bindElementBuffer=new ft(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new mt(this),this.pixelStoreUnpack=new gt(this),this.pixelStoreUnpackPremultiplyAlpha=new _t(this),this.pixelStoreUnpackFlipY=new yt(this),this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extStandardDerivativesForceOff=!1,this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),e||(this.extTextureHalfFloat=t.getExtension("OES_texture_half_float")),(e||this.extTextureHalfFloat&&t.getExtension("OES_texture_half_float_linear"))&&(this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float")),this.extStandardDerivatives=e||t.getExtension("OES_standard_derivatives"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE)}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,e){return new F(this,t,e)}createVertexBuffer(t,e,i){return new N(this,t,e,i)}createRenderbuffer(t,e,i){const n=this.gl,r=n.createRenderbuffer();return this.bindRenderbuffer.set(r),n.renderbufferStorage(n.RENDERBUFFER,t,e,i),this.bindRenderbuffer.set(null),r}createFramebuffer(t,e,i){return new At(this,t,e,i)}clear({color:t,depth:e,stencil:i}){const n=this.gl;let r=0;t&&(r|=n.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set([!0,!0,!0,!0])),void 0!==e&&(r|=n.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(e),this.depthMask.set(!0)),void 0!==i&&(r|=n.STENCIL_BUFFER_BIT,this.clearStencil.set(i),this.stencilMask.set(255)),n.clear(r)}setCullFace(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(i){e(i.blendFunction,t.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(i.blendFunction),this.blendColor.set(i.blendColor)),this.colorMask.set(i.mask)}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null)}}class Mt extends t.Evented{constructor(e,i,n,r){if(super(),this.id=e,this.dispatcher=n,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,t.extend(this,t.pick(i,["url","scheme","tileSize","promoteId"])),this._options=t.extend({type:"vector"},i),this._collectResourceTiming=i.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(r),this._tileWorkers={},this._deduped=new t.DedupedRequest}load(e){this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"}));const i=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map._worldview;this._tileJSONRequest=O(this._options,this.map._requestManager,i,n,((i,n)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new t.ErrorEvent(i)):n&&(t.extend(this,n),n.bounds&&(this.tileBounds=new k(n.bounds,this.minzoom,this.maxzoom)),t.postTurnstileEvent(n.tiles,this.map._requestManager._customAccessToken),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"}))),e&&e(i)}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest(),this.load((()=>this.map.style._clearSource(this.id)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return t.extend({},this._options)}loadTile(e,i){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme)),r={request:this.map._requestManager.transformRequest(n,t.ResourceType.Tile),data:void 0,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,tileSize:this.tileSize*e.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:t.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:e.isSymbolTile};if(r.request.collectResourceTiming=this._collectResourceTiming,e.actor&&"expired"!==e.state)"loading"===e.state?e.reloadCallback=i:e.request=e.actor.send("reloadTile",r,s.bind(this));else if(e.actor=this._tileWorkers[n]=this._tileWorkers[n]||this.dispatcher.getActor(),this.dispatcher.ready)e.request=e.actor.send("loadTile",r,s.bind(this),void 0,!0);else{const i=t.loadVectorTile.call({deduped:this._deduped},r,((t,i)=>{t||!i?s.call(this,t):(r.data={cacheControl:i.cacheControl,expires:i.expires,rawData:i.rawData.slice(0)},e.actor&&e.actor.send("loadTile",r,s.bind(this),void 0,!0))}),!0);e.request={cancel:i}}function s(n,r){return delete e.request,e.aborted?i(null):n&&404!==n.status?i(n):(r&&r.resourceTiming&&(e.resourceTiming=r.resourceTiming),this.map._refreshExpiredTiles&&r&&e.setExpiryData(r),e.loadVectorData(r,this.map.painter),t.cacheEntryPossiblyAdded(this.dispatcher),i(null),void(e.reloadCallback&&(this.loadTile(e,e.reloadCallback),e.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id})}unloadTile(t){t.unloadVectorData(),t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id})}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class St extends t.Evented{constructor(e,i,n,r){super(),this.id=e,this.dispatcher=n,this.setEventedParent(r),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=t.extend({type:"raster"},i),t.extend(this,t.pick(i,["url","scheme","tileSize"]))}load(e){this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=O(this._options,this.map._requestManager,null,null,((i,n)=>{this._tileJSONRequest=null,this._loaded=!0,i?this.fire(new t.ErrorEvent(i)):n&&(t.extend(this,n),n.bounds&&(this.tileBounds=new k(n.bounds,this.minzoom,this.maxzoom)),t.postTurnstileEvent(n.tiles),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"}))),e&&e(i)}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest(),this.load((()=>this.map.style._clearSource(this.id)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return t.extend({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(e,i){const n=t.exported.devicePixelRatio>=2,r=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),n,this.tileSize);e.request=t.getImage(this.map._requestManager.transformRequest(r,t.ResourceType.Tile),((n,r,s,o)=>(delete e.request,e.aborted?(e.state="unloaded",i(null)):n?(e.state="errored",i(n)):r?(this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:s,expires:o}),e.setTexture(r,this.map.painter),e.state="loaded",t.cacheEntryPossiblyAdded(this.dispatcher),void i(null)):i(null))))}static loadTileData(t,e,i){t.setTexture(e,i)}static unloadTileData(t,e){t.texture&&e.saveTileTexture(t.texture)}abortTile(t,e){t.request&&(t.request.cancel(),delete t.request),e()}unloadTile(t,e){t.texture&&this.map.painter.saveTileTexture(t.texture),e()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}function Et(e,i,n,r,s,o,a,l){const c=[e,n,s,i,r,o,1,1,1],h=[a,l,1],u=t.adjoint([],c),[d,p,f]=t.transformMat3(h,h,t.transpose(u,u));return t.multiply$1(c,[d,0,0,0,p,0,0,0,f],c)}class Ct extends t.Evented{constructor(t,e,i,n){super(),this.id=t,this.dispatcher=i,this.coordinates=e.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(n),this.options=e,this._dirty=!1}load(e,i){this._loaded=i||!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this.url=this.options.url,this._imageRequest=t.getImage(this.map._requestManager.transformRequest(this.url,t.ResourceType.Image),((i,n)=>{if(this._imageRequest=null,this._loaded=!0,i)this.fire(new t.ErrorEvent(i));else if(n){const{HTMLImageElement:i}=t.window;this.image=n instanceof i?t.exported.getImageData(n):n,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading()}}))}loaded(){return this._loaded}updateImage(t){return this.image&&t.url?(this._imageRequest&&t.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=t.url,this.load(t.coordinates,this._loaded),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(t){this.map=t,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),this.texture&&this.texture.destroy()}setCoordinates(e){this.coordinates=e,this._boundsArray=void 0;const i=e.map(t.MercatorCoordinate.fromLngLat);return this.tileID=function(e){let i=1/0,n=1/0,r=-1/0,s=-1/0;for(const t of e)i=Math.min(i,t.x),n=Math.min(n,t.y),r=Math.max(r,t.x),s=Math.max(s,t.y);const o=Math.max(r-i,s-n),a=Math.max(0,Math.floor(-Math.log(o)/Math.LN2)),l=Math.pow(2,a);return new t.CanonicalTileID(a,Math.floor((i+r)/2*l),Math.floor((n+s)/2*l))}(i),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0}_prepareData(e){for(const t in this.tiles){const e=this.tiles[t];"loaded"!==e.state&&(e.state="loaded",e.texture=this.texture)}if(this._boundsArray)return;const i=t.tileTransform(this.tileID,this.map.transform.projection),[n,r,s,o]=this.coordinates.map((e=>{const n=i.projection.project(e[0],e[1]);return t.getTilePoint(i,n)._round()}));this.perspectiveTransform=function(e,i,n,r,s,o,a,l,c,h){const u=Et(0,0,e,0,0,i,e,i),d=Et(n,r,s,o,a,l,c,h);return t.multiply$1(d,t.adjoint(u,u),d),[d[6]/d[8]*e/t.EXTENT,d[7]/d[8]*i/t.EXTENT]}(this.width,this.height,n.x,n.y,r.x,r.y,o.x,o.y,s.x,s.y);const a=this._boundsArray=new t.StructArrayLayout4i8;a.emplaceBack(n.x,n.y,0,0),a.emplaceBack(r.x,r.y,t.EXTENT,0),a.emplaceBack(o.x,o.y,0,t.EXTENT),a.emplaceBack(s.x,s.y,t.EXTENT,t.EXTENT),this.boundsBuffer&&this.boundsBuffer.destroy(),this.boundsBuffer=e.createVertexBuffer(a,t.boundsAttributes.members),this.boundsSegments=t.SegmentVector.simpleSegment(0,0,4,2)}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const e=this.map.painter.context,i=e.gl;this._dirty&&(this.texture?this.texture.update(this.image):(this.texture=new t.Texture(e,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE)),this._dirty=!1),this._prepareData(e)}loadTile(t,e){this.tileID&&this.tileID.equals(t.tileID.canonical)?(this.tiles[String(t.tileID.wrap)]=t,t.buckets={},e(null)):(t.state="errored",e(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}}const It={vector:Mt,raster:St,"raster-dem":class extends St{constructor(e,i,n,r){super(e,i,n,r),this.type="raster-dem",this.maxzoom=22,this._options=t.extend({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox"}loadTile(e,i){const n=this.map._requestManager.normalizeTileURL(e.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function r(t,n){t&&(e.state="errored",i(t)),n&&(e.dem=n,e.dem.onDeserialize(),e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0,e.state="loaded",i(null))}e.request=t.getImage(this.map._requestManager.transformRequest(n,t.ResourceType.Tile),function(n,s,o,a){if(delete e.request,e.aborted)e.state="unloaded",i(null);else if(n)e.state="errored",i(n);else if(s){this.map._refreshExpiredTiles&&e.setExpiryData({cacheControl:o,expires:a});const i=t.window.ImageBitmap&&s instanceof t.window.ImageBitmap&&(null==ot&&(ot=t.window.OffscreenCanvas&&new t.window.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof t.window.createImageBitmap),ot),n=1-(s.width-t.prevPowerOfTwo(s.width))/2;n<1||e.neighboringTiles||(e.neighboringTiles=this._getNeighboringTiles(e.tileID));const l=i?s:t.exported.getImageData(s,n),c={uid:e.uid,coord:e.tileID,source:this.id,rawImageData:l,encoding:this.encoding,padding:n};e.actor&&"expired"!==e.state||(e.actor=this.dispatcher.getActor(),e.actor.send("loadDEMTile",c,r.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(e){const i=e.canonical,n=Math.pow(2,i.z),r=(i.x-1+n)%n,s=0===i.x?e.wrap-1:e.wrap,o=(i.x+1+n)%n,a=i.x+1===n?e.wrap+1:e.wrap,l={};return l[new t.OverscaledTileID(e.overscaledZ,s,i.z,r,i.y).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,a,i.z,o,i.y).key]={backfilled:!1},i.y>0&&(l[new t.OverscaledTileID(e.overscaledZ,s,i.z,r,i.y-1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,e.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,a,i.z,o,i.y-1).key]={backfilled:!1}),i.y+1<n&&(l[new t.OverscaledTileID(e.overscaledZ,s,i.z,r,i.y+1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,e.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},l[new t.OverscaledTileID(e.overscaledZ,a,i.z,o,i.y+1).key]={backfilled:!1}),l}unloadTile(t){t.demTexture&&this.map.painter.saveTileTexture(t.demTexture),t.fbo&&(t.fbo.destroy(),delete t.fbo),t.dem&&delete t.dem,delete t.neighboringTiles,t.state="unloaded"}},geojson:class extends t.Evented{constructor(e,i,n,r){super(),this.id=e,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(r),this._data=i.data,this._options=t.extend({},i),this._collectResourceTiming=i.collectResourceTiming,void 0!==i.maxzoom&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const s=t.EXTENT/this.tileSize;this.workerOptions=t.extend({source:this.id,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(void 0!==i.buffer?i.buffer:128)*s,tolerance:(void 0!==i.tolerance?i.tolerance:.375)*s,extent:t.EXTENT,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:void 0!==i.clusterMaxZoom?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:t.EXTENT,radius:(void 0!==i.clusterRadius?i.clusterRadius:50)*s,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions)}onAdd(t){this.map=t,this.setData(this._data)}setData(t){return this._data=t,this._updateWorkerData(),this}getClusterExpansionZoom(t,e){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:t,source:this.id},e),this}getClusterChildren(t,e){return this.actor.send("geojson.getClusterChildren",{clusterId:t,source:this.id},e),this}getClusterLeaves(t,e,i,n){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:t,limit:e,offset:i},n),this}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new t.Event("dataloading",{dataType:"source"})),this._loaded=!1;const e=t.extend({},this.workerOptions),i=this._data;"string"==typeof i?(e.request=this.map._requestManager.transformRequest(t.exported.resolveURL(i),t.ResourceType.Source),e.request.collectResourceTiming=this._collectResourceTiming):e.data=JSON.stringify(i),this._pendingLoad=this.actor.send(`${this.type}.loadData`,e,((e,i)=>{if(this._loaded=!0,this._pendingLoad=null,e)this.fire(new t.ErrorEvent(e));else{const e={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&i&&i.resourceTiming&&i.resourceTiming[this.id]&&(e.resourceTiming=i.resourceTiming[this.id]),this.fire(new t.Event("data",e)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1)}))}loaded(){return this._loaded}loadTile(e,i){const n=e.actor?"reloadTile":"loadTile";e.actor=this.actor,e.request=this.actor.send(n,{type:this.type,uid:e.uid,tileID:e.tileID,tileZoom:e.tileZoom,zoom:e.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:t.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},((t,r)=>(delete e.request,e.unloadVectorData(),e.aborted?i(null):t?i(t):(e.loadVectorData(r,this.map.painter,"reloadTile"===n),i(null)))),void 0,"loadTile"===n)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.aborted=!0}unloadTile(t){t.unloadVectorData(),this.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id})}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return t.extend({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends Ct{constructor(t,e,i,n){super(t,e,i,n),this.roundZoom=!0,this.type="video",this.options=e}load(){this._loaded=!1;const e=this.options;this.urls=[];for(const i of e.urls)this.urls.push(this.map._requestManager.transformRequest(i,t.ResourceType.Source).url);t.getVideo(this.urls,((e,i)=>{this._loaded=!0,e?this.fire(new t.ErrorEvent(e)):i&&(this.video=i,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(e){if(this.video){const i=this.video.seekable;e<i.start(0)||e>i.end(0)?this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=e}}getVideo(){return this.video}onAdd(t){this.map||(this.map=t,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const e=this.map.painter.context,i=e.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new t.Texture(e,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(e)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:Ct,canvas:class extends Ct{constructor(e,i,n,r){super(e,i,n,r),i.coordinates?Array.isArray(i.coordinates)&&4===i.coordinates.length&&!i.coordinates.some((t=>!Array.isArray(t)||2!==t.length||t.some((t=>"number"!=typeof t))))||this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${e}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${e}`,null,'missing required property "coordinates"'))),i.animate&&"boolean"!=typeof i.animate&&this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${e}`,null,'optional "animate" property must be a boolean value'))),i.canvas?"string"==typeof i.canvas||i.canvas instanceof t.window.HTMLCanvasElement||this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${e}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new t.ErrorEvent(new t.ValidationError(`sources.${e}`,null,'missing required property "canvas"'))),this.options=i,this.animate=void 0===i.animate||i.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof t.window.HTMLCanvasElement?this.options.canvas:t.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new t.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(t){this.map=t,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let e=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,e=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,e=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const i=this.map.painter.context;this.texture?(e||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new t.Texture(i,this.canvas,i.gl.RGBA,{premultiply:!0}),this._prepareData(i)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const t of[this.canvas.width,this.canvas.height])if(isNaN(t)||t<=0)return!0;return!1}},custom:class extends t.Evented{constructor(e,i,n,r){super(),this.id=e,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=i,this.setEventedParent(r),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new t.ErrorEvent(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new t.ErrorEvent(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new k(this._implementation.bounds,this.minzoom,this.maxzoom)),i.update=this._update.bind(this),i.clearTiles=this._clearTiles.bind(this),i.coveringTiles=this._coveringTiles.bind(this),t.extend(this,t.pick(i,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return t.pick(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new t.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(e){this._map=e,this._loaded=!1,this.fire(new t.Event("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(e),this.load()}onRemove(t){this._implementation.onRemove&&this._implementation.onRemove(t)}hasTile(t){if(this._implementation.hasTile){const{x:e,y:i,z:n}=t.canonical;return this._implementation.hasTile({x:e,y:i,z:n})}return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(e,i){const{x:n,y:r,z:s}=e.tileID.canonical,o=new t.window.AbortController;e.request=Promise.resolve(this._implementation.loadTile({x:n,y:r,z:s},{signal:o.signal})).then(function(n){return delete e.request,e.aborted?(e.state="unloaded",i(null)):void 0===n?(e.state="errored",i(null)):null===n?(this.loadTileData(e,{width:this.tileSize,height:this.tileSize,data:null}),e.state="loaded",i(null)):function(e){return e instanceof t.window.ImageData||e instanceof t.window.HTMLCanvasElement||e instanceof t.window.ImageBitmap||e instanceof t.window.HTMLImageElement}(n)?(this.loadTileData(e,n),e.state="loaded",void i(null)):(e.state="errored",i(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}.bind(this)).catch((t=>{20!==t.code&&(e.state="errored",i(t))})),e.request.cancel=()=>o.abort()}loadTileData(t,e){St.loadTileData(t,e,this._map.painter)}unloadTileData(t){St.unloadTileData(t,this._map.painter)}unloadTile(t,e){if(this.unloadTileData(t),this._implementation.unloadTile){const{x:e,y:i,z:n}=t.tileID.canonical;this._implementation.unloadTile({x:e,y:i,z:n})}e()}abortTile(t,e){t.request&&t.request.cancel&&(t.request.cancel(),delete t.request),e()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((t=>({x:t.canonical.x,y:t.canonical.y,z:t.canonical.z})))}_clearTiles(){this._map.style._clearSource(this.id)}_update(){this.fire(new t.Event("data",{dataType:"source",sourceDataType:"content"}))}}},Pt=function(e,i,n,r){const s=new It[i.type](e,i,n,r);if(s.id!==e)throw new Error(`Expected Source id to be ${e} instead of ${s.id}`);return t.bindAll(["load","abort","unload","serialize","prepare"],s),s};function Lt(e,i){const n=t.identity([]);return t.scale(n,n,[.5*e.width,.5*-e.height,1]),t.translate(n,n,[1,-1,0]),t.multiply(n,n,e.calculateProjMatrix(i.toUnwrapped())),Float32Array.from(n)}function Rt(t,e,i,n,r,s,o,a=!1){const l=t.tilesIn(n,o,a);l.sort(Dt);const c=[];for(const n of l)c.push({wrappedTileID:n.tile.tileID.wrapped().key,queryResults:n.tile.queryRenderedFeatures(e,i,t._state,n,r,s,Lt(t.transform,n.tile.tileID),a)});const h=function(t){const e={},i={};for(const n of t){const t=n.queryResults,r=n.wrappedTileID,s=i[r]=i[r]||{};for(const i in t){const n=t[i],r=s[i]=s[i]||{},o=e[i]=e[i]||[];for(const t of n)r[t.featureIndex]||(r[t.featureIndex]=!0,o.push(t))}}return e}(c);for(const e in h)h[e].forEach((e=>{const i=e.feature,n=i.layer;n&&"background"!==n.type&&"sky"!==n.type&&(i.source=n.source,n["source-layer"]&&(i.sourceLayer=n["source-layer"]),i.state=void 0!==i.id?t.getFeatureState(n["source-layer"],i.id):{})}));return h}function Bt(t,e){const i=t.getRenderableIds().map((e=>t.getTileByID(e))),n=[],r={};for(let t=0;t<i.length;t++){const s=i[t],o=s.tileID.canonical.key;r[o]||(r[o]=!0,s.querySourceFeatures(n,e))}return n}function Dt(t,e){const i=t.tileID,n=e.tileID;return i.overscaledZ-n.overscaledZ||i.canonical.y-n.canonical.y||i.wrap-n.wrap||i.canonical.x-n.canonical.x}function Ot(){return null!=ds.workerClass?new ds.workerClass:new t.window.Worker(ds.workerUrl)}const kt="mapboxgl_preloaded_worker_pool";class Ft{constructor(){this.active={}}acquire(t){if(!this.workers)for(this.workers=[];this.workers.length<Ft.workerCount;)this.workers.push(new Ot);return this.active[t]=!0,this.workers.slice()}release(t){delete this.active[t],0===this.numActive()&&(this.workers.forEach((t=>{t.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[kt]}numActive(){return Object.keys(this.active).length}}let zt;function Nt(){return zt||(zt=new Ft),zt}function Ut(e,i){const n={};for(const t in e)"ref"!==t&&(n[t]=e[t]);return t.refProperties.forEach((t=>{t in i&&(n[t]=i[t])})),n}function Gt(t){t=t.slice();const e=Object.create(null);for(let i=0;i<t.length;i++)e[t[i].id]=t[i];for(let i=0;i<t.length;i++)"ref"in t[i]&&(t[i]=Ut(t[i],e[t[i].ref]));return t}Ft.workerCount=2;const Vt={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function jt(t,e,i){i.push({command:Vt.addSource,args:[t,e[t]]})}function Ht(t,e,i){e.push({command:Vt.removeSource,args:[t]}),i[t]=!0}function Wt(t,e,i,n){Ht(t,i,n),jt(t,e,i)}function qt(t,i,n){let r;for(r in t[n])if(t[n].hasOwnProperty(r)&&"data"!==r&&!e(t[n][r],i[n][r]))return!1;for(r in i[n])if(i[n].hasOwnProperty(r)&&"data"!==r&&!e(t[n][r],i[n][r]))return!1;return!0}function Xt(t,i,n,r,s,o){let a;for(a in i=i||{},t=t||{})t.hasOwnProperty(a)&&(e(t[a],i[a])||n.push({command:o,args:[r,a,i[a],s]}));for(a in i)i.hasOwnProperty(a)&&!t.hasOwnProperty(a)&&(e(t[a],i[a])||n.push({command:o,args:[r,a,i[a],s]}))}function Zt(t){return t.id}function Jt(t,e){return t[e.id]=e,t}class Yt{constructor(t,e){this.reset(t,e)}reset(t,e){this.points=t||[],this._distances=[0];for(let t=1;t<this.points.length;t++)this._distances[t]=this._distances[t-1]+this.points[t].dist(this.points[t-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(e||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(e){if(1===this.points.length)return this.points[0];e=t.clamp(e,0,1);let i=1,n=this._distances[i];const r=e*this.paddedLength+this.padding;for(;n<r&&i<this._distances.length;)n=this._distances[++i];const s=i-1,o=this._distances[s],a=n-o,l=a>0?(r-o)/a:0;return this.points[s].mult(1-l).add(this.points[i].mult(l))}}class $t{constructor(t,e,i){const n=this.boxCells=[],r=this.circleCells=[];this.xCellCount=Math.ceil(t/i),this.yCellCount=Math.ceil(e/i);for(let t=0;t<this.xCellCount*this.yCellCount;t++)n.push([]),r.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=e,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/e,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,e,i,n,r){this._forEachCell(e,i,n,r,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(e),this.bboxes.push(i),this.bboxes.push(n),this.bboxes.push(r)}insertCircle(t,e,i,n){this._forEachCell(e-n,i-n,e+n,i+n,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(e),this.circles.push(i),this.circles.push(n)}_insertBoxCell(t,e,i,n,r,s){this.boxCells[r].push(s)}_insertCircleCell(t,e,i,n,r,s){this.circleCells[r].push(s)}_query(t,e,i,n,r,s){if(i<0||t>this.width||n<0||e>this.height)return!r&&[];const o=[];if(t<=0&&e<=0&&this.width<=i&&this.height<=n){if(r)return!0;for(let t=0;t<this.boxKeys.length;t++)o.push({key:this.boxKeys[t],x1:this.bboxes[4*t],y1:this.bboxes[4*t+1],x2:this.bboxes[4*t+2],y2:this.bboxes[4*t+3]});for(let t=0;t<this.circleKeys.length;t++){const e=this.circles[3*t],i=this.circles[3*t+1],n=this.circles[3*t+2];o.push({key:this.circleKeys[t],x1:e-n,y1:i-n,x2:e+n,y2:i+n})}return s?o.filter(s):o}return this._forEachCell(t,e,i,n,this._queryCell,o,{hitTest:r,seenUids:{box:{},circle:{}}},s),r?o.length>0:o}_queryCircle(t,e,i,n,r){const s=t-i,o=t+i,a=e-i,l=e+i;if(o<0||s>this.width||l<0||a>this.height)return!n&&[];const c=[];return this._forEachCell(s,a,o,l,this._queryCellCircle,c,{hitTest:n,circle:{x:t,y:e,radius:i},seenUids:{box:{},circle:{}}},r),n?c.length>0:c}query(t,e,i,n,r){return this._query(t,e,i,n,!1,r)}hitTest(t,e,i,n,r){return this._query(t,e,i,n,!0,r)}hitTestCircle(t,e,i,n){return this._queryCircle(t,e,i,!0,n)}_queryCell(t,e,i,n,r,s,o,a){const l=o.seenUids,c=this.boxCells[r];if(null!==c){const r=this.bboxes;for(const h of c)if(!l.box[h]){l.box[h]=!0;const c=4*h;if(t<=r[c+2]&&e<=r[c+3]&&i>=r[c+0]&&n>=r[c+1]&&(!a||a(this.boxKeys[h]))){if(o.hitTest)return s.push(!0),!0;s.push({key:this.boxKeys[h],x1:r[c],y1:r[c+1],x2:r[c+2],y2:r[c+3]})}}}const h=this.circleCells[r];if(null!==h){const r=this.circles;for(const c of h)if(!l.circle[c]){l.circle[c]=!0;const h=3*c;if(this._circleAndRectCollide(r[h],r[h+1],r[h+2],t,e,i,n)&&(!a||a(this.circleKeys[c]))){if(o.hitTest)return s.push(!0),!0;{const t=r[h],e=r[h+1],i=r[h+2];s.push({key:this.circleKeys[c],x1:t-i,y1:e-i,x2:t+i,y2:e+i})}}}}}_queryCellCircle(t,e,i,n,r,s,o,a){const l=o.circle,c=o.seenUids,h=this.boxCells[r];if(null!==h){const t=this.bboxes;for(const e of h)if(!c.box[e]){c.box[e]=!0;const i=4*e;if(this._circleAndRectCollide(l.x,l.y,l.radius,t[i+0],t[i+1],t[i+2],t[i+3])&&(!a||a(this.boxKeys[e])))return s.push(!0),!0}}const u=this.circleCells[r];if(null!==u){const t=this.circles;for(const e of u)if(!c.circle[e]){c.circle[e]=!0;const i=3*e;if(this._circlesCollide(t[i],t[i+1],t[i+2],l.x,l.y,l.radius)&&(!a||a(this.circleKeys[e])))return s.push(!0),!0}}}_forEachCell(t,e,i,n,r,s,o,a){const l=this._convertToXCellCoord(t),c=this._convertToYCellCoord(e),h=this._convertToXCellCoord(i),u=this._convertToYCellCoord(n);for(let d=l;d<=h;d++)for(let l=c;l<=u;l++)if(r.call(this,t,e,i,n,this.xCellCount*l+d,s,o,a))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,e,i,n,r,s){const o=n-t,a=r-e,l=i+s;return l*l>o*o+a*a}_circleAndRectCollide(t,e,i,n,r,s,o){const a=(s-n)/2,l=Math.abs(t-(n+a));if(l>a+i)return!1;const c=(o-r)/2,h=Math.abs(e-(r+c));if(h>c+i)return!1;if(l<=a||h<=c)return!0;const u=l-a,d=h-c;return u*u+d*d<=i*i}}const Kt={unknown:0,flipRequired:1,flipNotRequired:2},Qt=Math.tan(85*Math.PI/180);function te(e,i,n,r,s,o,a){const l=t.create();if(n)if("globe"===o.name){const e=t.calculateGlobeLabelMatrix(s,i);t.multiply(l,l,e)}else{const e=y([],a);l[0]=e[0],l[1]=e[1],l[4]=e[2],l[5]=e[3],r||t.rotateZ(l,l,s.angle)}else t.multiply(l,s.labelPlaneMatrix,e);return l}function ee(t,e,i,n,r,s,o){const a=te(t,e,i,n,r,s,o);return"globe"===s.name&&i||(a[2]=a[6]=a[10]=a[14]=0),a}function ie(e,i,n,r,s,o,a){if(n){if("globe"===o.name){const l=te(e,i,n,r,s,o,a);return t.invert(l,l),t.multiply(l,e,l),l}{const i=t.clone(e),n=t.identity([]);return n[0]=a[0],n[1]=a[1],n[4]=a[2],n[5]=a[3],t.multiply(i,i,n),r||t.rotateZ(i,i,-s.angle),i}}return s.glCoordMatrix}function ne(e,i,n,r){const s=[e,i,n,1];n?t.transformMat4$1(s,s,r):fe(s,s,r);const o=s[3];return s[0]/=o,s[1]/=o,s[2]/=o,s}function re(t,e){return Math.min(.5+t/e*.5,1.5)}function se(t,e){const i=t[0]/t[3],n=t[1]/t[3];return i>=-e[0]&&i<=e[0]&&n>=-e[1]&&n<=e[1]}function oe(e,i,n,r,s,o,a,l,c,h){const u=n.transform,d=r?e.textSizeData:e.iconSizeData,p=t.evaluateSizeForZoom(d,n.transform.zoom),f="globe"===u.projection.name,m=[256/n.width*2+1,256/n.height*2+1],g=r?e.text.dynamicLayoutVertexArray:e.icon.dynamicLayoutVertexArray;g.clear();let _=null;f&&(_=r?e.text.globeExtVertexArray:e.icon.globeExtVertexArray);const y=e.lineVertexArray,v=r?e.text.placedSymbolArray:e.icon.placedSymbolArray,x=n.transform.width/n.transform.height;let b,w=!1;for(let r=0;r<v.length;r++){const f=v.get(r),{numGlyphs:A,writingMode:T}=f;if(T!==t.WritingMode.vertical||w||b===t.WritingMode.horizontal||(w=!0),b=T,(f.hidden||T===t.WritingMode.vertical)&&!w){pe(A,g);continue}w=!1;const M=new t.Point(f.tileAnchorX,f.tileAnchorY);let{x:S,y:E,z:C}=u.projection.projectTilePoint(M.x,M.y,h.canonical);if(c){const[t,e,i]=c(M);S+=t,E+=e,C+=i}const I=[S,E,C,1];if(t.transformMat4$1(I,I,i),!se(I,m)){pe(A,g);continue}const P=re(n.transform.cameraToCenterDistance,I[3]),L=t.evaluateSizeForFeature(d,p,f),R=a?L/P:L*P,B=ne(S,E,C,s);if(B[3]<=0){pe(A,g);continue}let D={};const O=a?null:c,k=ce(f,R,!1,l,i,s,o,e.glyphOffsetArray,y,g,_,B,M,D,x,O,u.projection,h,a);w=k.useVertical,O&&k.needsFlipping&&(D={}),(k.notEnoughRoom||w||k.needsFlipping&&ce(f,R,!0,l,i,s,o,e.glyphOffsetArray,y,g,_,B,M,D,x,O,u.projection,h,a).notEnoughRoom)&&pe(A,g)}r?(e.text.dynamicLayoutVertexBuffer.updateData(g),_&&e.text.globeExtVertexBuffer.updateData(_)):(e.icon.dynamicLayoutVertexBuffer.updateData(g),_&&e.icon.globeExtVertexBuffer.updateData(_))}function ae(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){const{lineStartIndex:g,glyphStartIndex:_,segment:y}=a,v=_+a.numGlyphs,x=g+a.lineLength,b=e.getoffsetX(_),w=e.getoffsetX(v-1),A=de(t*b,i,n,r,s,o,y,g,x,l,c,h,u,d,!0,p,f,m);if(!A)return null;const T=de(t*w,i,n,r,s,o,y,g,x,l,c,h,u,d,!0,p,f,m);return T?{first:A,last:T}:null}function le(e,i,n,r){return e===t.WritingMode.horizontal&&Math.abs(r)>Math.abs(n)?{useVertical:!0}:e===t.WritingMode.vertical?r>0?{needsFlipping:!0}:null:i!==Kt.unknown&&function(t,e){return 0===t||Math.abs(e/t)>Qt}(n,r)?i===Kt.flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null}function ce(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v){const x=i/24,b=e.lineOffsetX*x,w=e.lineOffsetY*x,{lineStartIndex:A,glyphStartIndex:T,numGlyphs:M,segment:S,writingMode:E,flipState:C}=e,I=A+e.lineLength,P=e=>{if(u){const[i,n,r]=e.up,s=h.length;t.updateGlobeVertexNormal(u,s+0,i,n,r),t.updateGlobeVertexNormal(u,s+1,i,n,r),t.updateGlobeVertexNormal(u,s+2,i,n,r),t.updateGlobeVertexNormal(u,s+3,i,n,r)}const[i,n,r]=e.point;t.addDynamicAttributes(h,i,n,r,e.angle)};if(M>1){const t=ae(x,l,b,w,n,d,p,e,c,o,f,g,!1,_,y,v);if(!t)return{notEnoughRoom:!0};if(r&&!n){let[i,n,r]=t.first.point,[s,o,l]=t.last.point;[i,n]=ne(i,n,r,a),[s,o]=ne(s,o,l,a);const c=le(E,C,(s-i)*m,o-n);if(e.flipState=c&&c.needsFlipping?Kt.flipRequired:Kt.flipNotRequired,c)return c}P(t.first);for(let t=T+1;t<T+M-1;t++){const e=de(x*l.getoffsetX(t),b,w,n,d,p,S,A,I,c,o,f,g,!1,!1,_,y,v);if(!e)return h.length-=4*(t-T),{notEnoughRoom:!0};P(e)}P(t.last)}else{if(r&&!n){const i=ne(p.x,p.y,0,s),n=A+S+1,r=new t.Point(c.getx(n),c.gety(n)),o=ne(r.x,r.y,0,s),a=o[3]>0?o:ue(p,r,i,1,s,void 0,_,y.canonical),l=le(E,C,(a[0]-i[0])*m,a[1]-i[1]);if(e.flipState=l&&l.needsFlipping?Kt.flipRequired:Kt.flipNotRequired,l)return l}const i=de(x*l.getoffsetX(T),b,w,n,d,p,S,A,I,c,o,f,g,!1,!1,_,y,v);if(!i)return{notEnoughRoom:!0};P(i)}return{}}function he(t,e,i,n,r){const{x:s,y:o,z:a}=n.projectTilePoint(t.x,t.y,e);if(!r)return ne(s,o,a,i);const[l,c,h]=r(t);return ne(s+l,o+c,a+h,i)}function ue(e,i,n,r,s,o,a,l){const c=he(e.sub(i)._unit()._add(e),l,s,a,o);return t.sub(c,n,c),t.normalize(c,c),t.scaleAndAdd(c,n,c,r)}function de(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y){const v=r?e-i:e+i;let x=v>0?1:-1,b=0;r&&(x*=-1,b=Math.PI),x<0&&(b+=Math.PI);let w=l+a+(x>0?0:1)|0,A=s,T=s,M=0,S=0;const E=Math.abs(v),C=[],I=[];let P=o,L=P;const R=()=>ue(L,P,T,E-M+1,u,p,g,_.canonical);for(;M+S<=E;){if(w+=x,w<l||w>=c)return null;if(T=A,L=P,C.push(T),f&&I.push(L),P=new t.Point(h.getx(w),h.gety(w)),A=d[w],!A){const t=he(P,_.canonical,u,g,p);A=t[3]>0?d[w]=t:R()}M+=S,S=t.distance(T,A)}m&&p&&(d[w]&&(A=R(),S=t.distance(T,A)),d[w]=A);const B=(E-M)/S,D=P.sub(L)._mult(B)._add(L),O=t.sub([],A,T),k=t.scaleAndAdd([],T,O,B);let F=[0,0,1],z=O[0],N=O[1];if(y&&(F=g.upVector(_.canonical,D.x,D.y),0!==F[0]||0!==F[1]||1!==F[2])){const e=[F[2],0,-F[0]],i=t.cross([],F,e);t.normalize(e,e),t.normalize(i,i),z=t.dot(O,e),N=t.dot(O,i)}if(n){const e=t.cross([],F,O);t.normalize(e,e),t.scaleAndAdd(k,k,e,n*x)}const U=b+Math.atan2(N,z);return C.push(k),f&&I.push(D),{point:k,angle:U,path:C,tilePath:I,up:F}}function pe(t,e){const i=e.length,n=i+4*t;e.resize(n),e.float32.fill(-1/0,4*i,4*n)}function fe(t,e,i){const n=e[0],r=e[1];return t[0]=i[0]*n+i[4]*r+i[12],t[1]=i[1]*n+i[5]*r+i[13],t[3]=i[3]*n+i[7]*r+i[15],t}const me=100;class ge{constructor(t,e,i=new $t(t.width+200,t.height+200,25),n=new $t(t.width+200,t.height+200,25)){this.transform=t,this.grid=i,this.ignoredGrid=n,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+me,this.screenBottomBoundary=t.height+me,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=e}placeCollisionBox(t,e,i,n,r,s,o,a){let l=i.projectedAnchorX,c=i.projectedAnchorY,h=i.projectedAnchorZ;const u=i.elevation,d=i.tileID,p=t.getProjection();if(u&&d){const[t,e,n]=p.upVector(d.canonical,i.tileAnchorX,i.tileAnchorY),r=p.upVectorScale(d.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;l+=t*u*r,c+=e*u*r,h+=n*u*r}const f=this.projectAndGetPerspectiveRatio(o,l,c,h,i.tileID,"globe"===p.name||!!u||this.transform.pitch>0,p),m=s*f.perspectiveRatio,g=(i.x1*e+n.x-i.padding)*m+f.point.x,_=(i.y1*e+n.y-i.padding)*m+f.point.y,y=(i.x2*e+n.x+i.padding)*m+f.point.x,v=(i.y2*e+n.y+i.padding)*m+f.point.y,x=f.perspectiveRatio<=.55||f.occluded;return!this.isInsideGrid(g,_,y,v)||!r&&this.grid.hitTest(g,_,y,v,a)||x?{box:[],offscreen:!1,occluded:f.occluded}:{box:[g,_,y,v],offscreen:this.isOffscreen(g,_,y,v),occluded:!1}}placeCollisionCircles(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){const g=[],_=this.transform.elevation,y=e.getProjection(),v=_?_.getAtTileOffsetFunc(m,this.transform.center.lat,this.transform.worldSize,y):null,x=new t.Point(n.tileAnchorX,n.tileAnchorY);let{x:b,y:w,z:A}=y.projectTilePoint(x.x,x.y,m.canonical);if(v){const[t,e,i]=v(x);b+=t,w+=e,A+=i}const T="globe"===y.name,M=this.projectAndGetPerspectiveRatio(a,b,w,A,m,T||!!_||this.transform.pitch>0,y),{perspectiveRatio:S}=M,E=(u?o/S:o*S)/t.ONE_EM,C=ne(b,w,A,l),I=M.signedDistanceFromCamera>0?ae(E,s,n.lineOffsetX*E,n.lineOffsetY*E,!1,C,x,n,r,l,{},_&&!u?v:null,u&&!!_,y,m,u):null;let P=!1,L=!1,R=!0;if(I&&!M.occluded){const e=.5*p*S+f,n=new t.Point(-100,-100),r=new t.Point(this.screenRightBoundary,this.screenBottomBoundary),s=new Yt,{first:o,last:a}=I,l=o.path.length;let u=[];for(let t=l-1;t>=1;t--)u.push(o.path[t]);for(let t=1;t<a.path.length;t++)u.push(a.path[t]);const m=2.5*e;c&&(u=u.map((([t,e,i],n)=>(v&&!T&&(i=v(n<l-1?o.tilePath[l-1-n]:a.tilePath[n-l+2])[2]),ne(t,e,i,c)))),u.some((t=>t[3]<=0))&&(u=[]));let _=[];if(u.length>0){let e=1/0,i=-1/0,s=1/0,o=-1/0;for(const t of u)e=Math.min(e,t[0]),s=Math.min(s,t[1]),i=Math.max(i,t[0]),o=Math.max(o,t[1]);i>=n.x&&e<=r.x&&o>=n.y&&s<=r.y&&(_=[u.map((e=>new t.Point(e[0],e[1])))],(e<n.x||i>r.x||s<n.y||o>r.y)&&(_=t.clipLine(_,n.x,n.y,r.x,r.y)))}for(const t of _){s.reset(t,.25*e);let n=0;n=s.length<=.5*e?1:Math.ceil(s.paddedLength/m)+1;for(let t=0;t<n;t++){const r=t/Math.max(n-1,1),o=s.lerp(r),a=o.x+me,l=o.y+me;g.push(a,l,e,0);const c=a-e,u=l-e,p=a+e,f=l+e;if(R=R&&this.isOffscreen(c,u,p,f),L=L||this.isInsideGrid(c,u,p,f),!i&&this.grid.hitTestCircle(a,l,e,d)&&(P=!0,!h))return{circles:[],offscreen:!1,collisionDetected:P,occluded:!1}}}}return{circles:!h&&P||!L?[]:g,offscreen:R,collisionDetected:P,occluded:M.occluded}}queryRenderedSymbols(e){if(0===e.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const i=[];let n=1/0,r=1/0,s=-1/0,o=-1/0;for(const a of e){const e=new t.Point(a.x+me,a.y+me);n=Math.min(n,e.x),r=Math.min(r,e.y),s=Math.max(s,e.x),o=Math.max(o,e.y),i.push(e)}const a=this.grid.query(n,r,s,o).concat(this.ignoredGrid.query(n,r,s,o)),l={},c={};for(const e of a){const n=e.key;if(void 0===l[n.bucketInstanceId]&&(l[n.bucketInstanceId]={}),l[n.bucketInstanceId][n.featureIndex])continue;const r=[new t.Point(e.x1,e.y1),new t.Point(e.x2,e.y1),new t.Point(e.x2,e.y2),new t.Point(e.x1,e.y2)];t.polygonIntersectsPolygon(i,r)&&(l[n.bucketInstanceId][n.featureIndex]=!0,void 0===c[n.bucketInstanceId]&&(c[n.bucketInstanceId]=[]),c[n.bucketInstanceId].push(n.featureIndex))}return c}insertCollisionBox(t,e,i,n,r){(e?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:n,collisionGroupID:r},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,e,i,n,r){const s=e?this.ignoredGrid:this.grid,o={bucketInstanceId:i,featureIndex:n,collisionGroupID:r};for(let e=0;e<t.length;e+=4)s.insertCircle(o,t[e],t[e+1],t[e+2])}projectAndGetPerspectiveRatio(e,i,n,r,s,o,a){const l=[i,n,r,1];let c=!1;if(r||this.transform.pitch>0){if(t.transformMat4$1(l,l,e),this.fogState&&s&&"globe"!==a.name){const e=function(e,i,n,r,s,o){const a=o.calculateFogTileMatrix(s),l=[i,n,r];return t.transformMat4(l,l,a),M(e,l,o.pitch,o._fov)}(this.fogState,i,n,r,s.toUnwrapped(),this.transform);c=e>.9}}else fe(l,l,e);const h=l[3];return{point:new t.Point((l[0]/h+1)/2*this.transform.width+me,(-l[1]/h+1)/2*this.transform.height+me),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(a)/h*.5,1.5),signedDistanceFromCamera:h,occluded:o&&l[2]>h||c}}isOffscreen(t,e,i,n){return i<me||t>=this.screenRightBoundary||n<me||e>this.screenBottomBoundary}isInsideGrid(t,e,i,n){return i>=0&&t<this.gridRightBoundary&&n>=0&&e<this.gridBottomBoundary}getViewportMatrix(){const e=t.identity([]);return t.translate(e,e,[-100,-100,0]),e}}function _e(e,i,n){const r=i.createTileMatrix(e,e.worldSize,n.toUnwrapped());return t.multiply(new Float32Array(16),e.projMatrix,r)}function ye(t,e,i){if(e.projection.name===i.projection.name)return t.projMatrix;const n=i.clone();return n.setProjection(e.projection),_e(n,e.getProjection(),t)}function ve(t,e,i){return e.name===i.projection.name?t.projMatrix:_e(i,e,t)}class xe{constructor(t,e,i,n){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?e:-e))):n&&i?1:0,this.placed=i}isHidden(){return 0===this.opacity&&!this.placed}}class be{constructor(t,e,i,n,r,s=!1){this.text=new xe(t?t.text:null,e,i,r),this.icon=new xe(t?t.icon:null,e,n,r),this.clipped=s}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class we{constructor(t,e,i,n=!1){this.text=t,this.icon=e,this.skipFade=i,this.clipped=n}}class Ae{constructor(){this.invProjMatrix=t.create(),this.viewportMatrix=t.create(),this.circles=[]}}class Te{constructor(t,e,i,n,r){this.bucketInstanceId=t,this.featureIndex=e,this.sourceLayerIndex=i,this.bucketIndex=n,this.tileID=r}}class Me{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const e=++this.maxGroupID;this.collisionGroups[t]={ID:e,predicate:t=>t.collisionGroupID===e}}return this.collisionGroups[t]}}function Se(e,i,n,r,s){const{horizontalAlign:o,verticalAlign:a}=t.getAnchorAlignment(e),l=-(o-.5)*i,c=-(a-.5)*n,h=t.evaluateVariableOffset(e,r);return new t.Point(l+h[0]*s,c+h[1]*s)}function Ee(e,i,n,r,s){const o=new t.Point(e,i);return n&&o._rotate(r?s:-s),o}class Ce{constructor(t,e,i,n,r){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new ge(this.transform,r),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=e,this.retainedQueryData={},this.collisionGroups=new Me(i),this.collisionCircleArrays={},this.prevPlacement=n,n&&(n.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(e,i,n,r){const s=n.getBucket(i),o=n.latestFeatureIndex;if(!s||!o||i.id!==s.layerIds[0])return;const a=s.layers[0].layout,l=n.collisionBoxArray,c=Math.pow(2,this.transform.zoom-n.tileID.overscaledZ),h=n.tileSize/t.EXTENT,u=n.tileID.toUnwrapped();this.transform.setProjection(s.projection);const d=(p=n.tileID,f=s.getProjection(),m=this.transform,f.name===this.projection?m.calculateProjMatrix(p.toUnwrapped()):_e(m,f,p));var p,f,m;const g="map"===a.get("text-pitch-alignment"),_="map"===a.get("text-rotation-alignment");i.compileFilter();const y=i.dynamicFilter(),v=i.dynamicFilterNeedsFeature(),x=this.transform.calculatePixelsToTileUnitsMatrix(n),b=ee(d,n.tileID.canonical,g,_,this.transform,s.getProjection(),x);let w=null;if(g){const e=ie(d,n.tileID.canonical,g,_,this.transform,s.getProjection(),x);w=t.multiply([],this.transform.labelPlaneMatrix,e)}let A=null;y&&n.latestFeatureIndex&&(A={unwrappedTileID:u,dynamicFilter:y,dynamicFilterNeedsFeature:v,featureIndex:n.latestFeatureIndex}),this.retainedQueryData[s.bucketInstanceId]=new Te(s.bucketInstanceId,o,s.sourceLayerIndex,s.index,n.tileID);const T={bucket:s,layout:a,posMatrix:d,textLabelPlaneMatrix:b,labelToScreenMatrix:w,clippingData:A,scale:c,textPixelRatio:h,holdingForFade:n.holdingForFade(),collisionBoxArray:l,partiallyEvaluatedTextSize:t.evaluateSizeForZoom(s.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:t.evaluateSizeForZoom(s.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(s.sourceID)};if(r)for(const t of s.sortKeyRanges){const{sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r}=t;e.push({sortKey:i,symbolInstanceStart:n,symbolInstanceEnd:r,parameters:T})}else e.push({symbolInstanceStart:0,symbolInstanceEnd:s.symbolInstances.length,parameters:T})}attemptAnchorPlacement(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_){const{textOffset0:y,textOffset1:v,crossTileID:x}=u,b=[y,v],w=Se(t,i,n,b,r),A=this.collisionIndex.placeCollisionBox(p,r,e,Ee(w.x,w.y,s,o,this.transform.angle),h,a,l,c.predicate);if(m){const t=p.getSymbolInstanceIconSize(_,this.transform.zoom,u.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(p,t,m,Ee(w.x,w.y,s,o,this.transform.angle),h,a,l,c.predicate).box.length)return}if(A.box.length>0){let e;return this.prevPlacement&&this.prevPlacement.variableOffsets[x]&&this.prevPlacement.placements[x]&&this.prevPlacement.placements[x].text&&(e=this.prevPlacement.variableOffsets[x].anchor),this.variableOffsets[x]={textOffset:b,width:i,height:n,anchor:t,textScale:r,prevAnchor:e},this.markUsedJustification(p,t,u,f),p.allowVerticalPlacement&&(this.markUsedOrientation(p,f,u),this.placedOrientations[x]=f),{shift:w,placedGlyphBoxes:A}}}placeLayerBucketPart(e,i,n,r){const{bucket:s,layout:o,posMatrix:a,textLabelPlaneMatrix:l,labelToScreenMatrix:c,clippingData:h,textPixelRatio:u,holdingForFade:d,collisionBoxArray:p,partiallyEvaluatedTextSize:f,partiallyEvaluatedIconSize:m,collisionGroup:g}=e.parameters,_=o.get("text-optional"),y=o.get("icon-optional"),v=o.get("text-allow-overlap"),x=o.get("icon-allow-overlap"),b="map"===o.get("text-rotation-alignment"),w="map"===o.get("text-pitch-alignment"),A="none"!==o.get("icon-text-fit"),T="viewport-y"===o.get("symbol-z-order");this.transform.setProjection(s.projection);let M=v&&(x||!s.hasIconData()||y),S=x&&(v||!s.hasTextData()||_);!s.collisionArrays&&p&&s.deserializeCollisionBoxes(p),n&&r&&s.updateCollisionDebugBuffers(this.transform.zoom,p);const E=(e,r,p)=>{const{crossTileID:T,numVerticalGlyphVertices:E}=e;if(h){const n={zoom:this.transform.zoom,pitch:this.transform.pitch};let r=null;if(h.dynamicFilterNeedsFeature){const t=this.retainedQueryData[s.bucketInstanceId];r=h.featureIndex.loadFeature({featureIndex:e.featureIndex,bucketIndex:t.bucketIndex,sourceLayerIndex:t.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,h.dynamicFilter)(n,r,this.retainedQueryData[s.bucketInstanceId].tileID.canonical,new t.Point(e.tileAnchorX,e.tileAnchorY),this.transform.calculateDistanceTileData(h.unwrappedTileID)))return this.placements[T]=new we(!1,!1,!1,!0),void i.add(T)}if(i.has(T))return;if(d)return void(this.placements[T]=new we(!1,!1,!1));let C=!1,I=!1,P=!0,L=!1,R=!1,B=null,D={box:null,offscreen:null,occluded:null},O={box:null,offscreen:null,occluded:null},k=null,F=null,z=null,N=0,U=0,G=0;p.textFeatureIndex?N=p.textFeatureIndex:e.useRuntimeCollisionCircles&&(N=e.featureIndex),p.verticalTextFeatureIndex&&(U=p.verticalTextFeatureIndex);const V=t=>{t.tileID=this.retainedQueryData[s.bucketInstanceId].tileID;const e=this.transform.elevation;(e||t.elevation)&&(t.elevation=e?e.getAtTileOffset(t.tileID,t.tileAnchorX,t.tileAnchorY):0)},j=p.textBox;if(j){V(j);const i=i=>{let n=t.WritingMode.horizontal;if(s.allowVerticalPlacement&&!i&&this.prevPlacement){const t=this.prevPlacement.placedOrientations[T];t&&(this.placedOrientations[T]=t,n=t,this.markUsedOrientation(s,n,e))}return n},n=(e,i)=>{if(s.allowVerticalPlacement&&E>0&&p.verticalTextBox){for(const n of s.writingModes)if(n===t.WritingMode.vertical?(D=i(),O=D):D=e(),D&&D.box&&D.box.length)break}else D=e()};if(o.get("text-variable-anchor")){let l=o.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[T]){const t=this.prevPlacement.variableOffsets[T];l.indexOf(t.anchor)>0&&(l=l.filter((e=>e!==t.anchor)),l.unshift(t.anchor))}const c=(t,i,n)=>{const o=s.getSymbolInstanceTextSize(f,e,this.transform.zoom,r),c=(t.x2-t.x1)*o+2*t.padding,h=(t.y2-t.y1)*o+2*t.padding,d=A&&!x?i:null;d&&V(d);let p={box:[],offscreen:!1,occluded:!1};const _=v?2*l.length:l.length;for(let i=0;i<_;++i){const _=this.attemptAnchorPlacement(l[i%l.length],t,c,h,o,b,w,u,a,g,i>=l.length,e,r,s,n,d,f,m);if(_&&(p=_.placedGlyphBoxes,p&&p.box&&p.box.length)){C=!0,B=_.shift;break}}return p};n((()=>c(j,p.iconBox,t.WritingMode.horizontal)),(()=>{const e=p.verticalTextBox;return e&&V(e),s.allowVerticalPlacement&&!(D&&D.box&&D.box.length)&&E>0&&e?c(e,p.verticalIconBox,t.WritingMode.vertical):{box:null,offscreen:null,occluded:null}})),D&&(C=D.box,P=D.offscreen,L=D.occluded);const h=i(!(!D||!D.box));if(!C&&this.prevPlacement){const t=this.prevPlacement.variableOffsets[T];t&&(this.variableOffsets[T]=t,this.markUsedJustification(s,t.anchor,e,h))}}else{const o=(i,n)=>{const o=s.getSymbolInstanceTextSize(f,e,this.transform.zoom,r),l=this.collisionIndex.placeCollisionBox(s,o,i,new t.Point(0,0),v,u,a,g.predicate);return l&&l.box&&l.box.length&&(this.markUsedOrientation(s,n,e),this.placedOrientations[T]=n),l};n((()=>o(j,t.WritingMode.horizontal)),(()=>{const e=p.verticalTextBox;return s.allowVerticalPlacement&&E>0&&e?(V(e),o(e,t.WritingMode.vertical)):{box:null,offscreen:null,occluded:null}})),i(!!(D&&D.box&&D.box.length))}}if(k=D,C=k&&k.box&&k.box.length>0,P=k&&k.offscreen,L=k&&k.occluded,e.useRuntimeCollisionCircles){const i=s.text.placedSymbolArray.get(e.centerJustifiedTextSymbolIndex>=0?e.centerJustifiedTextSymbolIndex:e.verticalPlacedTextSymbolIndex),r=t.evaluateSizeForFeature(s.textSizeData,f,i),h=o.get("text-padding");F=this.collisionIndex.placeCollisionCircles(s,v,i,s.lineVertexArray,s.glyphOffsetArray,r,a,l,c,n,w,g.predicate,e.collisionCircleDiameter*r/t.ONE_EM,h,this.retainedQueryData[s.bucketInstanceId].tileID),C=v||F.circles.length>0&&!F.collisionDetected,P=P&&F.offscreen,L=F.occluded}if(p.iconFeatureIndex&&(G=p.iconFeatureIndex),p.iconBox){const i=i=>{V(i);const n=A&&B?Ee(B.x,B.y,b,w,this.transform.angle):new t.Point(0,0),r=s.getSymbolInstanceIconSize(m,this.transform.zoom,e.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(s,r,i,n,x,u,a,g.predicate)};O&&O.box&&O.box.length&&p.verticalIconBox?(z=i(p.verticalIconBox),I=z.box.length>0):(z=i(p.iconBox),I=z.box.length>0),P=P&&z.offscreen,R=z.occluded}const H=_||0===e.numHorizontalGlyphVertices&&0===E,W=y||0===e.numIconVertices;if(H||W?W?H||(I=I&&C):C=I&&C:I=C=I&&C,C&&k&&k.box&&this.collisionIndex.insertCollisionBox(k.box,o.get("text-ignore-placement"),s.bucketInstanceId,O&&O.box&&U?U:N,g.ID),I&&z&&this.collisionIndex.insertCollisionBox(z.box,o.get("icon-ignore-placement"),s.bucketInstanceId,G,g.ID),F&&(C&&this.collisionIndex.insertCollisionCircles(F.circles,o.get("text-ignore-placement"),s.bucketInstanceId,N,g.ID),n)){const t=s.bucketInstanceId;let e=this.collisionCircleArrays[t];void 0===e&&(e=this.collisionCircleArrays[t]=new Ae);for(let t=0;t<F.circles.length;t+=4)e.circles.push(F.circles[t+0]),e.circles.push(F.circles[t+1]),e.circles.push(F.circles[t+2]),e.circles.push(F.collisionDetected?1:0)}const q="globe"!==s.projection.name;M=M&&(q||!L),S=S&&(q||!R),this.placements[T]=new we(C||M,I||S,P||s.justReloaded),i.add(T)};if(T){const t=s.getSortedSymbolIndexes(this.transform.angle);for(let e=t.length-1;e>=0;--e){const i=t[e];E(s.symbolInstances.get(i),i,s.collisionArrays[i])}}else for(let t=e.symbolInstanceStart;t<e.symbolInstanceEnd;t++)E(s.symbolInstances.get(t),t,s.collisionArrays[t]);if(n&&s.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[s.bucketInstanceId];t.invert(e.invProjMatrix,a),e.viewportMatrix=this.collisionIndex.getViewportMatrix()}s.justReloaded=!1}markUsedJustification(e,i,n,r){const{leftJustifiedTextSymbolIndex:s,centerJustifiedTextSymbolIndex:o,rightJustifiedTextSymbolIndex:a,verticalPlacedTextSymbolIndex:l,crossTileID:c}=n,h=t.getAnchorJustification(i),u=r===t.WritingMode.vertical?l:"left"===h?s:"center"===h?o:"right"===h?a:-1;s>=0&&(e.text.placedSymbolArray.get(s).crossTileID=u>=0&&s!==u?0:c),o>=0&&(e.text.placedSymbolArray.get(o).crossTileID=u>=0&&o!==u?0:c),a>=0&&(e.text.placedSymbolArray.get(a).crossTileID=u>=0&&a!==u?0:c),l>=0&&(e.text.placedSymbolArray.get(l).crossTileID=u>=0&&l!==u?0:c)}markUsedOrientation(e,i,n){const r=i===t.WritingMode.horizontal||i===t.WritingMode.horizontalOnly?i:0,s=i===t.WritingMode.vertical?i:0,{leftJustifiedTextSymbolIndex:o,centerJustifiedTextSymbolIndex:a,rightJustifiedTextSymbolIndex:l,verticalPlacedTextSymbolIndex:c}=n,h=e.text.placedSymbolArray;o>=0&&(h.get(o).placedOrientation=r),a>=0&&(h.get(a).placedOrientation=r),l>=0&&(h.get(l).placedOrientation=r),c>=0&&(h.get(c).placedOrientation=s)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const e=this.prevPlacement;let i=!1;this.prevZoomAdjustment=e?e.zoomAdjustment(this.transform.zoom):0;const n=e?e.symbolFadeChange(t):1,r=e?e.opacities:{},s=e?e.variableOffsets:{},o=e?e.placedOrientations:{};for(const t in this.placements){const e=this.placements[t],s=r[t];s?(this.opacities[t]=new be(s,n,e.text,e.icon,null,e.clipped),i=i||e.text!==s.text.placed||e.icon!==s.icon.placed):(this.opacities[t]=new be(null,n,e.text,e.icon,e.skipFade,e.clipped),i=i||e.text||e.icon)}for(const t in r){const e=r[t];if(!this.opacities[t]){const r=new be(e,n,!1,!1);r.isHidden()||(this.opacities[t]=r,i=i||e.text.placed||e.icon.placed)}}for(const t in s)this.variableOffsets[t]||!this.opacities[t]||this.opacities[t].isHidden()||(this.variableOffsets[t]=s[t]);for(const t in o)this.placedOrientations[t]||!this.opacities[t]||this.opacities[t].isHidden()||(this.placedOrientations[t]=o[t]);i?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=e?e.lastPlacementChangeTime:t)}updateLayerOpacities(t,e){const i=new Set;for(const n of e){const e=n.getBucket(t);e&&n.latestFeatureIndex&&t.id===e.layerIds[0]&&this.updateBucketOpacities(e,i,n.collisionBoxArray)}}updateBucketOpacities(e,i,n){e.hasTextData()&&e.text.opacityVertexArray.clear(),e.hasIconData()&&e.icon.opacityVertexArray.clear(),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexArray.clear(),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexArray.clear();const r=e.layers[0].layout,s=!!e.layers[0].dynamicFilter(),o=new be(null,0,!1,!1,!0),a=r.get("text-allow-overlap"),l=r.get("icon-allow-overlap"),c=r.get("text-variable-anchor"),h="map"===r.get("text-rotation-alignment"),u="map"===r.get("text-pitch-alignment"),d="none"!==r.get("icon-text-fit"),p=new be(null,0,a&&(l||!e.hasIconData()||r.get("icon-optional")),l&&(a||!e.hasTextData()||r.get("text-optional")),!0);!e.collisionArrays&&n&&(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData())&&e.deserializeCollisionBoxes(n);const f=(t,e,i)=>{for(let n=0;n<e/4;n++)t.opacityVertexArray.emplaceBack(i)};let m=0;for(let n=0;n<e.symbolInstances.length;n++){const r=e.symbolInstances.get(n),{numHorizontalGlyphVertices:a,numVerticalGlyphVertices:l,crossTileID:g,numIconVertices:_}=r,y=i.has(g);let v=this.opacities[g];y?v=o:v||(v=p,this.opacities[g]=v),i.add(g);const x=a>0||l>0,b=_>0,w=this.placedOrientations[g],A=w===t.WritingMode.vertical,T=w===t.WritingMode.horizontal||w===t.WritingMode.horizontalOnly;if(!x&&!b||v.isHidden()||m++,x){const t=Fe(v.text);f(e.text,a,A?ze:t),f(e.text,l,T?ze:t);const i=v.text.isHidden(),{leftJustifiedTextSymbolIndex:n,centerJustifiedTextSymbolIndex:s,rightJustifiedTextSymbolIndex:o,verticalPlacedTextSymbolIndex:c}=r,h=e.text.placedSymbolArray,u=i||A?1:0;n>=0&&(h.get(n).hidden=u),s>=0&&(h.get(s).hidden=u),o>=0&&(h.get(o).hidden=u),c>=0&&(h.get(c).hidden=i||T?1:0);const d=this.variableOffsets[g];d&&this.markUsedJustification(e,d.anchor,r,w);const p=this.placedOrientations[g];p&&(this.markUsedJustification(e,"left",r,p),this.markUsedOrientation(e,p,r))}if(b){const t=Fe(v.icon),{placedIconSymbolIndex:i,verticalPlacedIconSymbolIndex:n}=r,s=e.icon.placedSymbolArray,o=v.icon.isHidden()?1:0;i>=0&&(f(e.icon,_,A?ze:t),s.get(i).hidden=o),n>=0&&(f(e.icon,r.numVerticalIconVertices,T?ze:t),s.get(n).hidden=o)}if(e.hasIconCollisionBoxData()||e.hasTextCollisionBoxData()){const i=e.collisionArrays[n];if(i){let n=new t.Point(0,0),r=!0;if(i.textBox||i.verticalTextBox){if(c){const t=this.variableOffsets[g];t?(n=Se(t.anchor,t.width,t.height,t.textOffset,t.textScale),h&&n._rotate(u?this.transform.angle:-this.transform.angle)):r=!1}s&&(r=!v.clipped),i.textBox&&Ie(e.textCollisionBox.collisionVertexArray,v.text.placed,!r||A,n.x,n.y),i.verticalTextBox&&Ie(e.textCollisionBox.collisionVertexArray,v.text.placed,!r||T,n.x,n.y)}const o=r&&Boolean(!T&&i.verticalIconBox);i.iconBox&&Ie(e.iconCollisionBox.collisionVertexArray,v.icon.placed,o,d?n.x:0,d?n.y:0),i.verticalIconBox&&Ie(e.iconCollisionBox.collisionVertexArray,v.icon.placed,!o,d?n.x:0,d?n.y:0)}}}if(e.fullyClipped=0===m,e.sortFeatures(this.transform.angle),this.retainedQueryData[e.bucketInstanceId]&&(this.retainedQueryData[e.bucketInstanceId].featureSortOrder=e.featureSortOrder),e.hasTextData()&&e.text.opacityVertexBuffer&&e.text.opacityVertexBuffer.updateData(e.text.opacityVertexArray),e.hasIconData()&&e.icon.opacityVertexBuffer&&e.icon.opacityVertexBuffer.updateData(e.icon.opacityVertexArray),e.hasIconCollisionBoxData()&&e.iconCollisionBox.collisionVertexBuffer&&e.iconCollisionBox.collisionVertexBuffer.updateData(e.iconCollisionBox.collisionVertexArray),e.hasTextCollisionBoxData()&&e.textCollisionBox.collisionVertexBuffer&&e.textCollisionBox.collisionVertexBuffer.updateData(e.textCollisionBox.collisionVertexArray),e.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[e.bucketInstanceId];e.placementInvProjMatrix=t.invProjMatrix,e.placementViewportMatrix=t.viewportMatrix,e.collisionCircleArray=t.circles,delete this.collisionCircleArrays[e.bucketInstanceId]}}symbolFadeChange(t){return 0===this.fadeDuration?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,e){const i=this.zoomAtLastRecencyCheck===e?1-this.zoomAdjustment(e):1;return this.zoomAtLastRecencyCheck=e,this.commitTime+this.fadeDuration*i>t}setStale(){this.stale=!0}}function Ie(t,e,i,n,r){t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0),t.emplaceBack(e?1:0,i?1:0,n||0,r||0)}const Pe=Math.pow(2,25),Le=Math.pow(2,24),Re=Math.pow(2,17),Be=Math.pow(2,16),De=Math.pow(2,9),Oe=Math.pow(2,8),ke=Math.pow(2,1);function Fe(t){if(0===t.opacity&&!t.placed)return 0;if(1===t.opacity&&t.placed)return 4294967295;const e=t.placed?1:0,i=Math.floor(127*t.opacity);return i*Pe+e*Le+i*Re+e*Be+i*De+e*Oe+i*ke+e}const ze=0;class Ne{constructor(t){this._sortAcrossTiles="viewport-y"!==t.layout.get("symbol-z-order")&&void 0!==t.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,e,i,n,r){const s=this._bucketParts;for(;this._currentTileIndex<t.length;)if(e.getBucketParts(s,n,t[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,r())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,s.sort(((t,e)=>t.sortKey-e.sortKey)));this._currentPartIndex<s.length;){const t=s[this._currentPartIndex];if(e.placeLayerBucketPart(t,this._seenCrossTileIDs,i,0===t.symbolInstanceStart),this._currentPartIndex++,r())return!0}return!1}}class Ue{constructor(t,e,i,n,r,s,o,a){this.placement=new Ce(t,r,s,o,a),this._currentPlacementIndex=e.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=n,this._done=!1}isDone(){return this._done}continuePlacement(e,i,n){const r=t.exported.now(),s=()=>{const e=t.exported.now()-r;return!this._forceFullPlacement&&e>2};for(;this._currentPlacementIndex>=0;){const t=i[e[this._currentPlacementIndex]],r=this.placement.collisionIndex.transform.zoom;if("symbol"===t.type&&(!t.minzoom||t.minzoom<=r)&&(!t.maxzoom||t.maxzoom>r)){if(this._inProgressLayer||(this._inProgressLayer=new Ne(t)),this._inProgressLayer.continuePlacement(n[t.source],this.placement,this._showCollisionBoxes,t,s))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Ge=512/t.EXTENT/2;class Ve{constructor(e,i,n){this.tileID=e,this.bucketInstanceId=n,this.index=new t.KDBush(i.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const r=e.canonical.x*t.EXTENT,s=e.canonical.y*t.EXTENT;for(let t=0;t<i.length;t++){const{key:e,crossTileID:n,tileAnchorX:o,tileAnchorY:a}=i.get(t),l=Math.floor((r+o)*Ge),c=Math.floor((s+a)*Ge);this.index.add(l,c),this.keys.push(e),this.crossTileIDs.push(n)}this.index.finish()}findMatches(e,i,n){const r=this.tileID.canonical.z<i.canonical.z?1:Math.pow(2,this.tileID.canonical.z-i.canonical.z),s=Ge/Math.pow(2,i.canonical.z-this.tileID.canonical.z),o=i.canonical.x*t.EXTENT,a=i.canonical.y*t.EXTENT;for(let t=0;t<e.length;t++){const i=e.get(t);if(i.crossTileID)continue;const{key:l,tileAnchorX:c,tileAnchorY:h}=i,u=Math.floor((o+c)*s),d=Math.floor((a+h)*s),p=this.index.range(u-r,d-r,u+r,d+r);for(const t of p){const e=this.crossTileIDs[t];if(this.keys[t]===l&&!n.has(e)){n.add(e),i.crossTileID=e;break}}}}}class je{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class He{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const e=Math.round((t-this.lng)/360);if(0!==e)for(const t in this.indexes){const i=this.indexes[t],n={};for(const t in i){const r=i[t];r.tileID=r.tileID.unwrapTo(r.tileID.wrap+e),n[r.tileID.key]=r}this.indexes[t]=n}this.lng=t}addBucket(t,e,i){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===e.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let t=0;t<e.symbolInstances.length;t++)e.symbolInstances.get(t).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const n=this.usedCrossTileIDs[t.overscaledZ];for(const i in this.indexes){const r=this.indexes[i];if(Number(i)>t.overscaledZ)for(const i in r){const s=r[i];s.tileID.isChildOf(t)&&s.findMatches(e.symbolInstances,t,n)}else{const s=r[t.scaledTo(Number(i)).key];s&&s.findMatches(e.symbolInstances,t,n)}}for(let t=0;t<e.symbolInstances.length;t++){const r=e.symbolInstances.get(t);r.crossTileID||(r.crossTileID=i.generate(),n.add(r.crossTileID))}return void 0===this.indexes[t.overscaledZ]&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Ve(t,e.symbolInstances,e.bucketInstanceId),!0}removeBucketCrossTileIDs(t,e){for(const i of e.crossTileIDs)this.usedCrossTileIDs[t].delete(i)}removeStaleBuckets(t){let e=!1;for(const i in this.indexes){const n=this.indexes[i];for(const r in n)t[n[r].bucketInstanceId]||(this.removeBucketCrossTileIDs(i,n[r]),delete n[r],e=!0)}return e}}class We{constructor(){this.layerIndexes={},this.crossTileIDs=new je,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,e,i,n){let r=this.layerIndexes[t.id];void 0===r&&(r=this.layerIndexes[t.id]=new He);let s=!1;const o={};"globe"!==n.name&&r.handleWrapJump(i);for(const i of e){const e=i.getBucket(t);e&&t.id===e.layerIds[0]&&(e.bucketInstanceId||(e.bucketInstanceId=++this.maxBucketInstanceId),r.addBucket(i.tileID,e,this.crossTileIDs)&&(s=!0),o[e.bucketInstanceId]=!0)}return r.removeStaleBuckets(o)&&(s=!0),s}pruneUnusedLayers(t){const e={};t.forEach((t=>{e[t]=!0}));for(const t in this.layerIndexes)e[t]||delete this.layerIndexes[t]}}const qe=(e,i)=>t.emitValidationErrors(e,i&&i.filter((t=>"source.canvas"!==t.identifier))),Xe=t.pick(Vt,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Ze=t.pick(Vt,["setCenter","setZoom","setBearing","setPitch"]),Je={version:8,layers:[],sources:{}},Ye={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class $e extends t.Evented{constructor(e,i={}){super(),this.map=e,this.dispatcher=new I(Nt(),this),this.imageManager=new x,this.imageManager.setEventedParent(this),this.glyphManager=new t.GlyphManager(e._requestManager,i.localFontFamily?t.LocalGlyphMode.all:i.localIdeographFontFamily?t.LocalGlyphMode.ideographs:t.LocalGlyphMode.none,i.localFontFamily||i.localIdeographFontFamily),this.crossTileSymbolIndex=new We,this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",t.getReferrer());const n=this;this._rtlTextPluginCallback=$e.registerForPluginStateChange((e=>{n.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:e.pluginStatus,pluginURL:e.pluginURL},((e,i)=>{if(t.triggerPluginCompletionEvent(e),i&&i.every((t=>t)))for(const t in n._sourceCaches){const e=n._sourceCaches[t],i=e.getSource().type;"vector"!==i&&"geojson"!==i||e.reload()}}))})),this.on("data",(t=>{if("source"!==t.dataType||"metadata"!==t.sourceDataType)return;const e=this.getSource(t.sourceId);if(e&&e.vectorLayerIds)for(const t in this._layers){const i=this._layers[t];i.source===e.id&&this._validateLayer(i)}}))}loadURL(e,i={}){this.fire(new t.Event("dataloading",{dataType:"style"}));const n="boolean"==typeof i.validate?i.validate:!t.isMapboxURL(e);e=this.map._requestManager.normalizeStyleURL(e,i.accessToken);const r=this.map._requestManager.transformRequest(e,t.ResourceType.Style);this._request=t.getJSON(r,((e,i)=>{this._request=null,e?this.fire(new t.ErrorEvent(e)):i&&this._load(i,n)}))}loadJSON(e,i={}){this.fire(new t.Event("dataloading",{dataType:"style"})),this._request=t.exported.frame((()=>{this._request=null,this._load(e,!1!==i.validate)}))}loadEmpty(){this.fire(new t.Event("dataloading",{dataType:"style"})),this._load(Je,!1)}_updateLayerCount(t,e){const i=e?1:-1;t.is3D()&&(this._num3DLayers+=i),"circle"===t.type&&(this._numCircleLayers+=i),"symbol"===t.type&&(this._numSymbolLayers+=i)}_load(e,i){if(i&&qe(this,t.validateStyle(e)))return;this._loaded=!0,this.stylesheet=t.clone$1(e),this._updateMapProjection();for(const t in e.sources)this.addSource(t,e.sources[t],{validate:!1});this._changed=!1,e.sprite?this._loadSprite(e.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(e.glyphs);const n=Gt(this.stylesheet.layers);this._order=n.map((t=>t.id)),this._layers={},this._serializedLayers={};for(const e of n){const i=t.createStyleLayer(e);i.setEventedParent(this,{layer:{id:i.id}}),this._layers[i.id]=i,this._serializedLayers[i.id]=i.serialize(),this._updateLayerCount(i,!0)}this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new w(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new t.Event("data",{dataType:"style"})),this.fire(new t.Event("style.load"))}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null))}_updateMapProjection(){this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.stylesheet.projection)}_loadSprite(e){this._spriteRequest=function(e,i,n){let r,s,o;const a=t.exported.devicePixelRatio>1?"@2x":"";let l=t.getJSON(i.transformRequest(i.normalizeSpriteURL(e,a,".json"),t.ResourceType.SpriteJSON),((t,e)=>{l=null,o||(o=t,r=e,h())})),c=t.getImage(i.transformRequest(i.normalizeSpriteURL(e,a,".png"),t.ResourceType.SpriteImage),((t,e)=>{c=null,o||(o=t,s=e,h())}));function h(){if(o)n(o);else if(r&&s){const e=t.exported.getImageData(s),i={};for(const n in r){const{width:s,height:o,x:a,y:l,sdf:c,pixelRatio:h,stretchX:u,stretchY:d,content:p}=r[n],f=new t.RGBAImage({width:s,height:o});t.RGBAImage.copy(e,f,{x:a,y:l},{x:0,y:0},{width:s,height:o}),i[n]={data:f,pixelRatio:h,sdf:c,stretchX:u,stretchY:d,content:p}}n(null,i)}}return{cancel(){l&&(l.cancel(),l=null),c&&(c.cancel(),c=null)}}}(e,this.map._requestManager,((e,i)=>{if(this._spriteRequest=null,e)this.fire(new t.ErrorEvent(e));else if(i)for(const t in i)this.imageManager.addImage(t,i[t]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new t.Event("data",{dataType:"style"}))}))}_validateLayer(e){const i=this.getSource(e.source);if(!i)return;const n=e.sourceLayer;n&&("geojson"===i.type||i.vectorLayerIds&&-1===i.vectorLayerIds.indexOf(n))&&this.fire(new t.ErrorEvent(new Error(`Source layer "${n}" does not exist on source "${i.id}" as specified by style layer "${e.id}"`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._updatedSources).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeLayers(t){const e=[];for(const i of t){const t=this._layers[i];"custom"!==t.type&&e.push(t.serialize())}return e}hasTransitions(){if(this.light&&this.light.hasTransition())return!0;if(this.fog&&this.fog.hasTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order}isLayerDraped(t){return!!this.terrain&&("function"==typeof t.isLayerDraped?t.isLayerDraped():Ye[t.type])}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}update(e){if(!this._loaded)return;const i=this._changed;if(this._changed){const t=Object.keys(this._updatedLayers),i=Object.keys(this._removedLayers);(t.length||i.length)&&this._updateWorkerLayers(t,i);for(const t in this._updatedSources){const e=this._updatedSources[t];"reload"===e?this._reloadSource(t):"clear"===e&&this._clearSource(t)}this._updateTilesForChangedImages();for(const t in this._updatedPaintProps)this._layers[t].updateTransitions(e);this.light.updateTransitions(e),this.fog&&this.fog.updateTransitions(e),this._resetUpdates()}const n={};for(const t in this._sourceCaches){const e=this._sourceCaches[t];n[t]=e.used,e.used=!1}for(const t of this._order){const i=this._layers[t];if(i.recalculate(e,this._availableImages),!i.isHidden(e.zoom)){const t=this._getLayerSourceCache(i);t&&(t.used=!0)}const n=this.map.painter;if(n){const t=i.getProgramIds();if(!t)continue;const r=i.getProgramConfiguration(e.zoom);for(const e of t)n.useProgram(e,r)}}for(const e in n){const i=this._sourceCaches[e];n[e]!==i.used&&i.getSource().fire(new t.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:i.getSource().id}))}this.light.recalculate(e),this.terrain&&this.terrain.recalculate(e),this.fog&&this.fog.recalculate(e),this.z=e.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),i&&this.fire(new t.Event("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=Object.keys(this._changedImages);if(t.length){for(const e in this._sourceCaches)this._sourceCaches[e].reloadTilesForDependencies(["icons","patterns"],t);this._changedImages={}}}_updateWorkerLayers(t,e){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(t),removedIds:e})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={}}setState(i){if(this._checkLoaded(),qe(this,t.validateStyle(i)))return!1;(i=t.clone$1(i)).layers=Gt(i.layers);const n=function(t,i){if(!t)return[{command:Vt.setStyle,args:[i]}];let n=[];try{if(!e(t.version,i.version))return[{command:Vt.setStyle,args:[i]}];e(t.center,i.center)||n.push({command:Vt.setCenter,args:[i.center]}),e(t.zoom,i.zoom)||n.push({command:Vt.setZoom,args:[i.zoom]}),e(t.bearing,i.bearing)||n.push({command:Vt.setBearing,args:[i.bearing]}),e(t.pitch,i.pitch)||n.push({command:Vt.setPitch,args:[i.pitch]}),e(t.sprite,i.sprite)||n.push({command:Vt.setSprite,args:[i.sprite]}),e(t.glyphs,i.glyphs)||n.push({command:Vt.setGlyphs,args:[i.glyphs]}),e(t.transition,i.transition)||n.push({command:Vt.setTransition,args:[i.transition]}),e(t.light,i.light)||n.push({command:Vt.setLight,args:[i.light]}),e(t.fog,i.fog)||n.push({command:Vt.setFog,args:[i.fog]}),e(t.projection,i.projection)||n.push({command:Vt.setProjection,args:[i.projection]});const r={},s=[];!function(t,i,n,r){let s;for(s in i=i||{},t=t||{})t.hasOwnProperty(s)&&(i.hasOwnProperty(s)||Ht(s,n,r));for(s in i){if(!i.hasOwnProperty(s))continue;const o=i[s];t.hasOwnProperty(s)?e(t[s],o)||("geojson"===t[s].type&&"geojson"===o.type&&qt(t,i,s)?n.push({command:Vt.setGeoJSONSourceData,args:[s,o.data]}):Wt(s,i,n,r)):jt(s,i,n)}}(t.sources,i.sources,s,r);const o=[];t.layers&&t.layers.forEach((t=>{t.source&&r[t.source]?n.push({command:Vt.removeLayer,args:[t.id]}):o.push(t)}));let a=t.terrain;a&&r[a.source]&&(n.push({command:Vt.setTerrain,args:[void 0]}),a=void 0),n=n.concat(s),e(a,i.terrain)||n.push({command:Vt.setTerrain,args:[i.terrain]}),function(t,i,n){i=i||[];const r=(t=t||[]).map(Zt),s=i.map(Zt),o=t.reduce(Jt,{}),a=i.reduce(Jt,{}),l=r.slice(),c=Object.create(null);let h,u,d,p,f,m,g;for(h=0,u=0;h<r.length;h++)d=r[h],a.hasOwnProperty(d)?u++:(n.push({command:Vt.removeLayer,args:[d]}),l.splice(l.indexOf(d,u),1));for(h=0,u=0;h<s.length;h++)d=s[s.length-1-h],l[l.length-1-h]!==d&&(o.hasOwnProperty(d)?(n.push({command:Vt.removeLayer,args:[d]}),l.splice(l.lastIndexOf(d,l.length-u),1)):u++,m=l[l.length-h],n.push({command:Vt.addLayer,args:[a[d],m]}),l.splice(l.length-h,0,d),c[d]=!0);for(h=0;h<s.length;h++)if(d=s[h],p=o[d],f=a[d],!c[d]&&!e(p,f))if(e(p.source,f.source)&&e(p["source-layer"],f["source-layer"])&&e(p.type,f.type)){for(g in Xt(p.layout,f.layout,n,d,null,Vt.setLayoutProperty),Xt(p.paint,f.paint,n,d,null,Vt.setPaintProperty),e(p.filter,f.filter)||n.push({command:Vt.setFilter,args:[d,f.filter]}),e(p.minzoom,f.minzoom)&&e(p.maxzoom,f.maxzoom)||n.push({command:Vt.setLayerZoomRange,args:[d,f.minzoom,f.maxzoom]}),p)p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?Xt(p[g],f[g],n,d,g.slice(6),Vt.setPaintProperty):e(p[g],f[g])||n.push({command:Vt.setLayerProperty,args:[d,g,f[g]]}));for(g in f)f.hasOwnProperty(g)&&!p.hasOwnProperty(g)&&"layout"!==g&&"paint"!==g&&"filter"!==g&&"metadata"!==g&&"minzoom"!==g&&"maxzoom"!==g&&(0===g.indexOf("paint.")?Xt(p[g],f[g],n,d,g.slice(6),Vt.setPaintProperty):e(p[g],f[g])||n.push({command:Vt.setLayerProperty,args:[d,g,f[g]]}))}else n.push({command:Vt.removeLayer,args:[d]}),m=l[l.lastIndexOf(d)+1],n.push({command:Vt.addLayer,args:[f,m]})}(o,i.layers,n)}catch(t){n=[{command:Vt.setStyle,args:[i]}]}return n}(this.serialize(),i).filter((t=>!(t.command in Ze)));if(0===n.length)return!1;const r=n.filter((t=>!(t.command in Xe)));if(r.length>0)throw new Error(`Unimplemented: ${r.map((t=>t.command)).join(", ")}.`);return n.forEach((t=>{"setTransition"!==t.command&&"setProjection"!==t.command&&this[t.command].apply(this,t.args)})),this.stylesheet=i,this._updateMapProjection(),!0}addImage(e,i){return this.getImage(e)?this.fire(new t.ErrorEvent(new Error("An image with this name already exists."))):(this.imageManager.addImage(e,i),this._afterImageUpdated(e),this)}updateImage(t,e){this.imageManager.updateImage(t,e)}getImage(t){return this.imageManager.getImage(t)}removeImage(e){return this.getImage(e)?(this.imageManager.removeImage(e),this._afterImageUpdated(e),this):this.fire(new t.ErrorEvent(new Error("No image with this name exists.")))}_afterImageUpdated(e){this._availableImages=this.imageManager.listImages(),this._changedImages[e]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new t.Event("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addSource(e,i,n={}){if(this._checkLoaded(),void 0!==this.getSource(e))throw new Error("There is already a source with this ID");if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(t.validateSource,`sources.${e}`,i,null,n))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const r=Pt(e,i,this.dispatcher,this);r.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(e),source:r.serialize(),sourceId:e})));const s=i=>{const n=(i?"symbol:":"other:")+e,s=this._sourceCaches[n]=new t.SourceCache(n,r,i);(i?this._symbolSourceCaches:this._otherSourceCaches)[e]=s,s.style=this,s.onAdd(this.map)};s(!1),"vector"!==i.type&&"geojson"!==i.type||s(!0),r.onAdd&&r.onAdd(this.map),this._changed=!0}removeSource(e){this._checkLoaded();const i=this.getSource(e);if(!i)throw new Error("There is no source with this ID");for(const i in this._layers)if(this._layers[i].source===e)return this.fire(new t.ErrorEvent(new Error(`Source "${e}" cannot be removed while layer "${i}" is using it.`)));if(this.terrain&&this.terrain.get().source===e)return this.fire(new t.ErrorEvent(new Error(`Source "${e}" cannot be removed while terrain is using it.`)));const n=this._getSourceCaches(e);for(const e of n)delete this._sourceCaches[e.id],delete this._updatedSources[e.id],e.fire(new t.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:e.getSource().id})),e.setEventedParent(null),e.clearTiles();return delete this._otherSourceCaches[e],delete this._symbolSourceCaches[e],i.setEventedParent(null),i.onRemove&&i.onRemove(this.map),this._changed=!0,this}setGeoJSONSourceData(t,e){this._checkLoaded(),this.getSource(t).setData(e),this._changed=!0}getSource(t){const e=this._getSourceCache(t);return e&&e.getSource()}_getSources(){const t=[];for(const e in this._otherSourceCaches){const i=this._getSourceCache(e);i&&t.push(i.getSource())}return t}addLayer(e,i,n={}){this._checkLoaded();const r=e.id;if(this.getLayer(r))return void this.fire(new t.ErrorEvent(new Error(`Layer with id "${r}" already exists on this map`)));let s;if("custom"===e.type){if(qe(this,t.validateCustomStyleLayer(e)))return;s=t.createStyleLayer(e)}else{if("object"==typeof e.source&&(this.addSource(r,e.source),e=t.clone$1(e),e=t.extend(e,{source:r})),this._validate(t.validateLayer,`layers.${r}`,e,{arrayIndex:-1},n))return;s=t.createStyleLayer(e),this._validateLayer(s),s.setEventedParent(this,{layer:{id:r}}),this._serializedLayers[s.id]=s.serialize(),this._updateLayerCount(s,!0)}const o=i?this._order.indexOf(i):this._order.length;if(i&&-1===o)return void this.fire(new t.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`)));this._order.splice(o,0,r),this._layerOrderChanged=!0,this._layers[r]=s;const a=this._getLayerSourceCache(s);if(this._removedLayers[r]&&s.source&&a&&"custom"!==s.type){const t=this._removedLayers[r];delete this._removedLayers[r],t.type!==s.type?this._updatedSources[s.source]="clear":(this._updatedSources[s.source]="reload",a.pause())}this._updateLayer(s),s.onAdd&&s.onAdd(this.map),this._updateDrapeFirstLayers()}moveLayer(e,i){if(this._checkLoaded(),this._changed=!0,!this._layers[e])return void this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be moved.`)));if(e===i)return;const n=this._order.indexOf(e);this._order.splice(n,1);const r=i?this._order.indexOf(i):this._order.length;i&&-1===r?this.fire(new t.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`))):(this._order.splice(r,0,e),this._layerOrderChanged=!0,this._updateDrapeFirstLayers())}removeLayer(e){this._checkLoaded();const i=this._layers[e];if(!i)return void this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be removed.`)));i.setEventedParent(null),this._updateLayerCount(i,!1);const n=this._order.indexOf(e);this._order.splice(n,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[e]=i,delete this._layers[e],delete this._serializedLayers[e],delete this._updatedLayers[e],delete this._updatedPaintProps[e],i.onRemove&&i.onRemove(this.map),this._updateDrapeFirstLayers()}getLayer(t){return this._layers[t]}hasLayer(t){return t in this._layers}hasLayerType(t){for(const e in this._layers)if(this._layers[e].type===t)return!0;return!1}setLayerZoomRange(e,i,n){this._checkLoaded();const r=this.getLayer(e);r?r.minzoom===i&&r.maxzoom===n||(null!=i&&(r.minzoom=i),null!=n&&(r.maxzoom=n),this._updateLayer(r)):this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot have zoom extent.`)))}setFilter(i,n,r={}){this._checkLoaded();const s=this.getLayer(i);if(s){if(!e(s.filter,n))return null==n?(s.filter=void 0,void this._updateLayer(s)):void(this._validate(t.validateFilter,`layers.${s.id}.filter`,n,{layerType:s.type},r)||(s.filter=t.clone$1(n),this._updateLayer(s)))}else this.fire(new t.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be filtered.`)))}getFilter(e){const i=this.getLayer(e);return i&&t.clone$1(i.filter)}setLayoutProperty(i,n,r,s={}){this._checkLoaded();const o=this.getLayer(i);o?e(o.getLayoutProperty(n),r)||(o.setLayoutProperty(n,r,s),this._updateLayer(o)):this.fire(new t.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be styled.`)))}getLayoutProperty(e,i){const n=this.getLayer(e);if(n)return n.getLayoutProperty(i);this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style.`)))}setPaintProperty(i,n,r,s={}){this._checkLoaded();const o=this.getLayer(i);o?e(o.getPaintProperty(n),r)||(o.setPaintProperty(n,r,s)&&this._updateLayer(o),this._changed=!0,this._updatedPaintProps[i]=!0):this.fire(new t.ErrorEvent(new Error(`The layer '${i}' does not exist in the map's style and cannot be styled.`)))}getPaintProperty(t,e){const i=this.getLayer(t);return i&&i.getPaintProperty(e)}setFeatureState(e,i){this._checkLoaded();const n=e.source,r=e.sourceLayer,s=this.getSource(n);if(!s)return void this.fire(new t.ErrorEvent(new Error(`The source '${n}' does not exist in the map's style.`)));const o=s.type;if("geojson"===o&&r)return void this.fire(new t.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===o&&!r)return void this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===e.id&&this.fire(new t.ErrorEvent(new Error("The feature id parameter must be provided.")));const a=this._getSourceCaches(n);for(const t of a)t.setFeatureState(r,e.id,i)}removeFeatureState(e,i){this._checkLoaded();const n=e.source,r=this.getSource(n);if(!r)return void this.fire(new t.ErrorEvent(new Error(`The source '${n}' does not exist in the map's style.`)));const s=r.type,o="vector"===s?e.sourceLayer:void 0;if("vector"===s&&!o)return void this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(i&&"string"!=typeof e.id&&"number"!=typeof e.id)return void this.fire(new t.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const a=this._getSourceCaches(n);for(const t of a)t.removeFeatureState(o,e.id,i)}getFeatureState(e){this._checkLoaded();const i=e.source,n=e.sourceLayer,r=this.getSource(i);if(r){if("vector"!==r.type||n)return void 0===e.id&&this.fire(new t.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(i)[0].getFeatureState(n,e.id);this.fire(new t.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")))}else this.fire(new t.ErrorEvent(new Error(`The source '${i}' does not exist in the map's style.`)))}getTransition(){return t.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){const e={};for(const t in this._sourceCaches){const i=this._sourceCaches[t].getSource();e[i.id]||(e[i.id]=i.serialize())}return t.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.getTerrain()||void 0,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:e,layers:this._serializeLayers(this._order)},(t=>void 0!==t))}_updateLayer(t){this._updatedLayers[t.id]=!0;const e=this._getLayerSourceCache(t);t.source&&!this._updatedSources[t.source]&&e&&"raster"!==e.getSource().type&&(this._updatedSources[t.source]="reload",e.pause()),this._changed=!0,t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const e=t=>"fill-extrusion"===this._layers[t].type,i={},n=[];for(let r=this._order.length-1;r>=0;r--){const s=this._order[r];if(e(s)){i[s]=r;for(const e of t){const t=e[s];if(t)for(const e of t)n.push(e)}}}n.sort(((t,e)=>e.intersectionZ-t.intersectionZ));const r=[];for(let s=this._order.length-1;s>=0;s--){const o=this._order[s];if(e(o))for(let t=n.length-1;t>=0;t--){const e=n[t].feature;if(i[e.layer.id]<s)break;r.push(e),n.pop()}else for(const e of t){const t=e[o];if(t)for(const e of t)r.push(e.feature)}}return r}queryRenderedFeatures(e,i,n){i&&i.filter&&this._validate(t.validateFilter,"queryRenderedFeatures.filter",i.filter,null,i);const r={};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new t.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const e of i.layers){const i=this._layers[e];if(!i)return this.fire(new t.ErrorEvent(new Error(`The layer '${e}' does not exist in the map's style and cannot be queried for features.`))),[];r[i.source]=!0}}const s=[];i.availableImages=this._availableImages;const o=i&&i.layers?i.layers.some((t=>{const e=this.getLayer(t);return e&&e.is3D()})):this.has3DLayers(),a=L.createFromScreenPoints(e,n);for(const t in this._sourceCaches){const e=this._sourceCaches[t].getSource().id;i.layers&&!r[e]||s.push(Rt(this._sourceCaches[t],this._layers,this._serializedLayers,a,i,n,o,!!this.map._showQueryGeometry))}return this.placement&&s.push(function(t,e,i,n,r,s,o){const a={},l=s.queryRenderedSymbols(n),c=[];for(const t of Object.keys(l).map(Number))c.push(o[t]);c.sort(Dt);for(const i of c){const n=i.featureIndex.lookupSymbolFeatures(l[i.bucketInstanceId],e,i.bucketIndex,i.sourceLayerIndex,r.filter,r.layers,r.availableImages,t);for(const t in n){const e=a[t]=a[t]||[],r=n[t];r.sort(((t,e)=>{const n=i.featureSortOrder;if(n){const i=n.indexOf(t.featureIndex);return n.indexOf(e.featureIndex)-i}return e.featureIndex-t.featureIndex}));for(const t of r)e.push(t)}}for(const e in a)a[e].forEach((n=>{const r=n.feature,s=i(t[e]);if(!s)return;const o=s.getFeatureState(r.layer["source-layer"],r.id);r.source=r.layer.source,r.layer["source-layer"]&&(r.sourceLayer=r.layer["source-layer"]),r.state=o}));return a}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),a.screenGeometry,i,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(s)}querySourceFeatures(e,i){i&&i.filter&&this._validate(t.validateFilter,"querySourceFeatures.filter",i.filter,null,i);const n=this._getSourceCaches(e);let r=[];for(const t of n)r=r.concat(Bt(t,i));return r}addSourceType(t,e,i){return $e.getSourceType(t)?i(new Error(`A source type called "${t}" already exists.`)):($e.setSourceType(t,e),e.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:e.workerSourceURL},i):i(null,null))}getLight(){return this.light.getLight()}setLight(t,i={}){this._checkLoaded();const n=this.light.getLight();let r=!1;for(const i in t)if(!e(t[i],n[i])){r=!0;break}if(!r)return;const s=this._setTransitionParameters({duration:300,delay:0});this.light.setLight(t,i),this.light.updateTransitions(s)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(i,n=1){if(this._checkLoaded(),!i)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let r=i;if(1===n){if("object"==typeof r.source){const e="terrain-dem-src";this.addSource(e,r.source),r=t.clone$1(r),r=t.extend(r,{source:e})}if(this._validate(t.validateTerrain,"terrain",r))return}if(!this.terrain||this.terrain&&n!==this.terrain.drapeRenderMode){if(!r)return;this._createTerrain(r,n)}else{const i=this.terrain,n=i.get();for(const e of Object.keys(t.spec.terrain))!r.hasOwnProperty(e)&&t.spec.terrain[e].default&&(r[e]=t.spec.terrain[e].default);for(const t in r)if(!e(r[t],n[t])){i.set(r),this.stylesheet.terrain=r;const t=this._setTransitionParameters({duration:0});i.updateTransitions(t);break}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const e=this.fog=new C(t,this.map.transform);this.stylesheet.fog=t;const i=this._setTransitionParameters({duration:0});e.updateTransitions(i)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask((()=>{for(const t of this.map._markers)t._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const i=this.fog,n=i.get();0===Object.keys(t).length&&i.set(t);for(const r in t)if(!e(t[r],n[r])){i.set(t),this.stylesheet.fog=t;const e=this._setTransitionParameters({duration:0});i.updateTransitions(e);break}}else this._createFog(t);this._markersNeedUpdate=!0}_setTransitionParameters(e){return{now:t.exported.now(),transition:t.extend(e,this.stylesheet.transition)}}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const t=this._order.filter((t=>this.isLayerDraped(this._layers[t]))),e=this._order.filter((t=>!this.isLayerDraped(this._layers[t])));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...e)}_createTerrain(t,e){const i=this.terrain=new T(t,e);this.stylesheet.terrain=t,this.dispatcher.broadcast("enableTerrain",!this.terrainSetForDrapingOnly()),this._force3DLayerUpdate();const n=this._setTransitionParameters({duration:0});i.updateTransitions(n)}_force3DLayerUpdate(){for(const t in this._layers){const e=this._layers[t];"fill-extrusion"===e.type&&this._updateLayer(e)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const e=this._layers[t];"symbol"===e.type&&this._updateLayer(e)}}_validate(e,i,n,r,s={}){return(!s||!1!==s.validate)&&qe(this,e.call(t.validateStyle,t.extend({key:i,style:this.serialize(),value:n,styleSpec:t.spec},r)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),t.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._layers)this._layers[t].setEventedParent(null);for(const t in this._sourceCaches)this._sourceCaches[t].clearTiles(),this._sourceCaches[t].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove()}_clearSource(t){const e=this._getSourceCaches(t);for(const t of e)t.clearTiles()}_reloadSource(t){const e=this._getSourceCaches(t);for(const t of e)t.resume(),t.reload()}_reloadSources(){for(const t of this._getSources())t.reload&&t.reload()}_updateSources(t){for(const e in this._sourceCaches)this._sourceCaches[e].update(t)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const e=this._sourceCaches[t];e.resume(),e.reload()}}_updatePlacement(e,i,n,r,s=!1){let o=!1,a=!1;const l={};for(const t of this._order){const i=this._layers[t];if("symbol"!==i.type)continue;if(!l[i.source]){const t=this._getLayerSourceCache(i);if(!t)continue;l[i.source]=t.getRenderableIds(!0).map((e=>t.getTileByID(e))).sort(((t,e)=>e.tileID.overscaledZ-t.tileID.overscaledZ||(t.tileID.isLessThan(e.tileID)?-1:1)))}const n=this.crossTileSymbolIndex.addLayer(i,l[i.source],e.center.lng,e.projection);o=o||n}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),s=s||this._layerOrderChanged||0===n,this._layerOrderChanged&&this.fire(new t.Event("neworder")),(s||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(t.exported.now(),e.zoom))&&(this.pauseablePlacement=new Ue(e,this._order,s,i,n,r,this.placement,this.fog&&e.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,l),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(t.exported.now()),a=!0),o&&this.pauseablePlacement.placement.setStale()),a||o)for(const t of this._order){const e=this._layers[t];"symbol"===e.type&&this.placement.updateLayerOpacities(e,l[e.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(t.exported.now())}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}getImages(t,e,i){this.imageManager.getImages(e.icons,i),this._updateTilesForChangedImages();const n=t=>{t&&t.setDependencies(e.tileID.key,e.type,e.icons)};n(this._otherSourceCaches[e.source]),n(this._symbolSourceCaches[e.source])}getGlyphs(t,e,i){this.glyphManager.getGlyphs(e.stacks,i)}getResource(e,i,n){return t.makeRequest(i,n)}_getSourceCache(t){return this._otherSourceCaches[t]}_getLayerSourceCache(t){return"symbol"===t.type?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}_getSourceCaches(t){const e=[];return this._otherSourceCaches[t]&&e.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&e.push(this._symbolSourceCaches[t]),e}_isSourceCacheLoaded(e){const i=this._getSourceCaches(e);return 0===i.length?(this.fire(new t.ErrorEvent(new Error(`There is no source with ID '${e}'`))),!1):i.every((t=>t.loaded()))}has3DLayers(){return this._num3DLayers>0}hasSymbolLayers(){return this._numSymbolLayers>0}hasCircleLayers(){return this._numCircleLayers>0}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}$e.getSourceType=function(t){return It[t]},$e.setSourceType=function(t,e){It[t]=e},$e.registerForPluginStateChange=t.registerForPluginStateChange;var Ke="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#define EXTENT 8192.0\n#define HALF_PI PI/2.0\n#define QUARTER_PI PI/4.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0",Qe="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",ti="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\nconst float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}\n#ifdef TERRAIN\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#else\nuniform sampler2D u_dem;uniform sampler2D u_dem_prev;\n#endif\nuniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));\n#ifdef TERRAIN_DEM_NEAREST_FILTER\nreturn u_exaggeration*tl;\n#endif\nfloat tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nhighp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nfloat tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;\n#else\nvec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);\n#endif\nreturn vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",ei="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",ii="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump float u_fog_temporal_offset;varying vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif";let ni={},ri={};const si=[];hi(Ke,si),hi(ti,si),hi(ei,si),hi(ii,si),ni=ui("",ti),ri=ui(ii,ei);const oi=ui("\n#if __VERSION__ >=300\n#define varying in\n#define gl_FragColor glFragColor\n#define texture2D texture\n#define textureCube texture\nout vec4 glFragColor;\n#endif\nhighp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}","\n#if __VERSION__ >=300\n#define attribute in\n#define varying out\n#define texture2D texture\n#endif\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered."),ai=Ke,li="\n#ifdef GL_ES\nprecision mediump float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif";var ci={background:ui("uniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nvarying vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform vec4 u_color;varying vec4 v_color;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting(u_color);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),backgroundPattern:ui("uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),circle:ui("varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\ngl_FragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}"),clippingMask:ui("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:ui("uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {gl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),heatmapTexture:ui("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}","attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:ui("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}","attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:ui("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:ui("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;\n#endif\nvarying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}"),fill:ui("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutline:ui("varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutlinePattern:ui("uniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;varying vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillPattern:ui("uniform vec2 u_texsize;uniform sampler2D u_image;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillExtrusion:ui("varying vec4 v_color;\n#ifdef RENDER_SHADOWS\nvarying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef ZERO_ROOF_RADIUS\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)\nvarying highp vec3 v_normal;\n#endif\nvoid main() {\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)\nvec3 normal=v_normal;\n#endif\nfloat z;vec4 color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);color=mix(v_color,v_roof_color,z);\n#else\ncolor=v_color;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);color.rgb=color.rgb*shade;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef ZERO_ROOF_RADIUS\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#endif\ncolor.xyz=shadowed_color_normal(color.xyz,normalize(normal),v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec4 v_color;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying highp vec4 v_pos_light_view_0;varying highp vec4 v_pos_light_view_1;varying float v_depth;\n#endif\n#ifdef ZERO_ROOF_RADIUS\nvarying vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)\nvarying highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS)\nv_normal=normal;\n#endif\nbase=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele;vec3 pos;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nv_pos_light_view_0=u_light_matrix_0*vec4(pos,1);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1);v_depth=gl_Position.w;\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}v_color=vec4(0.0,0.0,0.0,1.0);\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting(color,NdotL);\n#else\nv_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));\n#endif\nv_color*=u_opacity;\n#ifdef ZERO_ROOF_RADIUS\nv_roof_color=vec4(0.0,0.0,0.0,1.0);\n#ifdef LIGHTING_3D_MODE\nv_roof_color=apply_lighting(color,calculate_NdotL(vec3(0.0,0.0,1.0)));\n#else\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));\n#endif\nv_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),fillExtrusionPattern:ui("uniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying float v_NdotL;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec4 out_color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,v_NdotL)*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec2 v_pos;varying vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;varying vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nvarying float v_NdotL;\n#endif\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_NdotL=NdotL;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}"),hillshadePrepare:ui("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nreturn texture2D(u_image,coord).a/4.0;\n#else\nvec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;\n#endif\n}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:ui("uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\ngl_FragColor=apply_lighting(gl_FragColor);\n#endif\n#ifdef FOG\ngl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),line:ui("uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\nuniform float u_border_width;uniform vec4 u_border_color;float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture2D(u_dash_image,v_tex).a;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture2D(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trimmed=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef RENDER_LINE_ALPHA_DISCARD\nif (alpha < u_alpha_discard_threshold) {discard;}\n#endif\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=(u_border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);\n#ifdef RENDER_LINE_BORDER_AUTO\nfloat Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}\n#else\nout_color.rgb=mix(u_border_color.rgb*u_border_color.a*trimmed,out_color.rgb,smoothAlpha);\n#endif\n}\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define EXTRUDE_SCALE 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nattribute highp vec4 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nattribute float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;varying highp vec4 v_uv;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;varying vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);\n#else\nv_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),linePattern:ui("uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x=mod(v_linesofar/pattern_size.x*aspect,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec4 color=texture2D(u_image,pos);\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting(color);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),raster:ui("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply(out_color,v_fog_pos));\n#endif\ngl_FragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),symbolIcon:ui("uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nvarying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#endif\nfloat projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}"),symbolSDF:ui("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nvarying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);\n#endif\nvec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#endif\nfloat gamma_scale=gl_Position.w;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}"),symbolTextAndIcon:ui("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_projected_pos;attribute float a_fade_opacity;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_globe_anchor;attribute vec3 a_globe_normal;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nvarying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;vec3 h=elevationVector(tile_anchor)*elevation(tile_anchor);float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\nfloat occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projected_point.w <=0.0 || occlusion_fade==0.0));\n#endif\nfloat gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}"),terrainRaster:ui("uniform sampler2D u_image0;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nvarying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nvoid main() {vec4 color=texture2D(u_image0,v_pos0);\n#ifdef RENDER_SHADOWS\ncolor.xyz=shadowed_color(color.xyz,v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\ngl_FragColor=color;\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;varying vec4 v_pos_light_view_0;varying vec4 v_pos_light_view_1;varying float v_depth;\n#endif\nconst float wireframeOffset=0.00015;void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;\n#ifdef TERRAIN_WIREFRAME\nelevation+=wireframeOffset;\n#endif\nv_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);v_depth=gl_Position.w;\n#endif\n}"),terrainDepth:ui("#ifdef GL_ES\nprecision highp float;\n#endif\nvarying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}","uniform mat4 u_matrix;attribute vec2 a_pos;varying float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:ui("\nvarying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Qe),skyboxGradient:ui("varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Qe),skyboxCapture:ui("\nvarying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;\n#ifdef GL_ES\nprecision highp float;\n#endif\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}","attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:ui("uniform sampler2D u_image0;varying vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nvec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture2D(u_image0,v_pos0);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#else\ncolor=texture2D(u_image0,v_pos0);\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nattribute vec3 a_globe_pos;attribute vec2 a_uv;\n#else\nattribute vec2 a_pos;\n#endif\nvarying vec2 v_pos0;const float wireframeOffset=1e3;float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(QUARTER_PI+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);\n#ifdef TERRAIN_WIREFRAME\nheight+=wireframeOffset;\n#endif\nglobe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}"),globeAtmosphere:ui("uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec3 u_start_color;uniform vec4 u_color;uniform vec4 u_space_color;uniform vec4 u_high_color;uniform float u_star_intensity;uniform float u_star_size;uniform float u_star_density;uniform float u_horizon_angle;uniform mat4 u_rotation_matrix;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;highp float random(highp vec3 p) {p=fract(p*vec3(23.2342,97.1231,91.2342));p+=dot(p.zxy,p.yxz+123.1234);return fract(p.x*p.y);}float stars(vec3 p,float scale,vec2 offset) {vec2 uv_scale=(u_viewport/u_star_size)*scale;vec3 position=vec3(p.xy*uv_scale+offset*u_viewport,p.z);vec3 q=fract(position)-0.5;vec3 id=floor(position);float random_visibility=step(random(id),u_star_density);float circle=smoothstep(0.5+u_star_intensity,0.5,length(q));return circle*random_visibility;}void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {discard;return;}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(dot(dir,horizon_dir)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;float closest_point_to_center=length(closest_point-u_globe_pos);float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c =mix(color_stop_2,c2,t);float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);vec2 uv=gl_FragCoord.xy/u_viewport-0.5;float aspect_ratio=u_viewport.x/u_viewport.y;vec4 uv_dir=vec4(normalize(vec3(uv.x*aspect_ratio,uv.y,1.0)),1.0);uv_dir=u_rotation_matrix*uv_dir;vec3 n=abs(uv_dir.xyz);vec2 uv_remap=(n.x > n.y && n.x > n.z) ? uv_dir.yz/uv_dir.x:\n(n.y > n.x && n.y > n.z) ? uv_dir.zx/uv_dir.y:\nuv_dir.xy/uv_dir.z;uv_remap.x/=aspect_ratio;vec3 D=vec3(uv_remap,1.0);highp float star_field=0.0;if (u_star_intensity > 0.0) {star_field+=stars(D,1.2,vec2(0.0,0.0));star_field+=stars(D,1.0,vec2(1.0,0.0));star_field+=stars(D,0.8,vec2(0.0,1.0));star_field+=stars(D,0.6,vec2(1.0,1.0));star_field*=(1.0-pow(t,0.25+(1.0-u_high_color.a)*0.75));c+=star_field*alpha_2;}c=dither(c,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=vec4(c,a);}","attribute vec3 a_pos;attribute vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;varying highp vec3 v_ray_dir;varying highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}")};function hi(t,e){const i=t.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let t of i)if(t=t.trim(),"#"===t[0]&&t.includes("if")&&!t.includes("endif")){t=t.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const i=t.split(" ");for(const t of i)e.includes(t)||e.push(t)}}function ui(t,e){const i=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,n=e.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),r={},s=[...si];return hi(t,s),hi(e,s),{fragmentSource:t=t.replace(i,((t,e,i,n,s)=>(r[s]=!0,"define"===e?`\n#ifndef HAS_UNIFORM_u_${s}\nvarying ${i} ${n} ${s};\n#else\nuniform ${i} ${n} u_${s};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${s}\n    ${i} ${n} ${s} = u_${s};\n#endif\n`))),vertexSource:e=e.replace(i,((t,e,i,n,s)=>{const o="float"===n?"vec2":"vec4",a=s.match(/color/)?"color":o;return r[s]?"define"===e?`\n#ifndef HAS_UNIFORM_u_${s}\nuniform lowp float u_${s}_t;\nattribute ${i} ${o} a_${s};\nvarying ${i} ${n} ${s};\n#else\nuniform ${i} ${n} u_${s};\n#endif\n`:"vec4"===a?`\n#ifndef HAS_UNIFORM_u_${s}\n    ${s} = a_${s};\n#else\n    ${i} ${n} ${s} = u_${s};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${s}\n    ${s} = unpack_mix_${a}(a_${s}, u_${s}_t);\n#else\n    ${i} ${n} ${s} = u_${s};\n#endif\n`:"define"===e?`\n#ifndef HAS_UNIFORM_u_${s}\nuniform lowp float u_${s}_t;\nattribute ${i} ${o} a_${s};\n#else\nuniform ${i} ${n} u_${s};\n#endif\n`:"vec4"===a?`\n#ifndef HAS_UNIFORM_u_${s}\n    ${i} ${n} ${s} = a_${s};\n#else\n    ${i} ${n} ${s} = u_${s};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${s}\n    ${i} ${n} ${s} = unpack_mix_${a}(a_${s}, u_${s}_t);\n#else\n    ${i} ${n} ${s} = u_${s};\n#endif\n`})),staticAttributes:n,usedDefines:s}}class di{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,e,i,n,r,s,o){this.context=t;let a=this.boundPaintVertexBuffers.length!==n.length;for(let t=0;!a&&t<n.length;t++)this.boundPaintVertexBuffers[t]!==n[t]&&(a=!0);let l=this.boundDynamicVertexBuffers.length!==o.length;for(let t=0;!l&&t<o.length;t++)this.boundDynamicVertexBuffers[t]!==o[t]&&(l=!0);if(!t.extVertexArrayObject||!this.vao||this.boundProgram!==e||this.boundLayoutVertexBuffer!==i||a||l||this.boundIndexBuffer!==r||this.boundVertexOffset!==s)this.freshBind(e,i,n,r,s,o);else{t.bindVertexArrayOES.set(this.vao);for(const t of o)t&&t.bind();r&&r.dynamicDraw&&r.bind()}}freshBind(t,e,i,n,r,s){let o;const a=t.numAttributes,l=this.context,c=l.gl;if(l.extVertexArrayObject)this.vao&&this.destroy(),this.vao=l.extVertexArrayObject.createVertexArrayOES(),l.bindVertexArrayOES.set(this.vao),o=0,this.boundProgram=t,this.boundLayoutVertexBuffer=e,this.boundPaintVertexBuffers=i,this.boundIndexBuffer=n,this.boundVertexOffset=r,this.boundDynamicVertexBuffers=s;else{o=l.currentNumAttributes||0;for(let t=a;t<o;t++)c.disableVertexAttribArray(t)}e.enableAttributes(c,t),e.bind(),e.setVertexAttribPointers(c,t,r);for(const e of i)e.enableAttributes(c,t),e.bind(),e.setVertexAttribPointers(c,t,r);for(const e of s)e&&(e.enableAttributes(c,t),e.bind(),e.setVertexAttribPointers(c,t,r));n&&n.bind(),l.currentNumAttributes=a}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null)}}function pi(e,i){const n=Math.pow(2,i.canonical.z),r=i.canonical.y;return[new t.MercatorCoordinate(0,r/n).toLngLat().lat,new t.MercatorCoordinate(0,(r+1)/n).toLngLat().lat]}function fi(e,i,n,r,s,o,a){const l=e.context,c=l.gl,h=n.fbo;if(!h)return;e.prepareDrawTile();const u=e.useProgram("hillshade");l.activeTexture.set(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,h.colorAttachment.get());const d=((t,e,i,n)=>{const r=i.paint.get("hillshade-shadow-color"),s=i.paint.get("hillshade-highlight-color"),o=i.paint.get("hillshade-accent-color");let a=i.paint.get("hillshade-illumination-direction")*(Math.PI/180);"viewport"===i.paint.get("hillshade-illumination-anchor")&&(a-=t.transform.angle);const l=!t.options.moving;return{u_matrix:n||t.transform.calculateProjMatrix(e.tileID.toUnwrapped(),l),u_image:0,u_latrange:pi(0,e.tileID),u_light:[i.paint.get("hillshade-exaggeration"),a],u_shadow:r,u_highlight:s,u_accent:o}})(e,n,r,e.terrain?i.projMatrix:null);e.prepareDrawProgram(l,u,i.toUnwrapped());const{tileBoundsBuffer:p,tileBoundsIndexBuffer:f,tileBoundsSegments:m}=e.getTileBoundsBuffers(n);u.draw(l,c.TRIANGLES,s,o,a,t.CullFaceMode.disabled,d,r.id,p,f,m)}function mi(e,i,n){if(!i.needsDEMTextureUpload)return;const r=e.context,s=r.gl;r.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||e.getTileTexture(n.stride);const o=n.getPixels();i.demTexture?i.demTexture.update(o,{premultiply:!1}):i.demTexture=new t.Texture(r,o,s.RGBA,{premultiply:!1}),i.needsDEMTextureUpload=!1}function gi(e,i,n,r,s,o){const a=e.context,l=a.gl;if(!i.dem)return;const c=i.dem;if(a.activeTexture.set(l.TEXTURE1),mi(e,i,c),!i.demTexture)return;i.demTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE);const h=c.dim;a.activeTexture.set(l.TEXTURE0);let u=i.fbo;if(!u){const e=new t.Texture(a,{width:h,height:h,data:null},l.RGBA);e.bind(l.LINEAR,l.CLAMP_TO_EDGE),u=i.fbo=a.createFramebuffer(h,h,!0),u.colorAttachment.set(e.texture)}a.bindFramebuffer.set(u.framebuffer),a.viewport.set([0,0,h,h]);const{tileBoundsBuffer:d,tileBoundsIndexBuffer:p,tileBoundsSegments:f}=e.getMercatorTileBoundsBuffers();e.useProgram("hillshadePrepare").draw(a,l.TRIANGLES,r,s,o,t.CullFaceMode.disabled,((e,i)=>{const n=i.stride,r=t.create();return t.ortho(r,0,t.EXTENT,-t.EXTENT,0,0,1),t.translate(r,r,[0,-t.EXTENT,0]),{u_matrix:r,u_image:1,u_dimension:[n,n],u_zoom:e.overscaledZ,u_unpack:i.unpackVector}})(i.tileID,c),n.id,d,p,f),i.needsHillshadePrepare=!1}const _i=e=>({u_matrix:new t.UniformMatrix4f(e),u_image0:new t.Uniform1i(e),u_skirt_height:new t.Uniform1f(e)}),yi=(t,e)=>({u_matrix:t,u_image0:0,u_skirt_height:e}),vi=(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f)=>({u_proj_matrix:Float32Array.from(t),u_globe_matrix:e,u_normalize_matrix:Float32Array.from(n),u_merc_matrix:i,u_zoom_transition:r,u_merc_center:s,u_image0:0,u_frustum_tl:o,u_frustum_tr:a,u_frustum_br:l,u_frustum_bl:c,u_globe_pos:h,u_globe_radius:u,u_viewport:d,u_grid_matrix:f?Float32Array.from(f):new Float32Array(9),u_skirt_height:p});function xi(t,e){return null!=t&&null!=e&&!(!t.hasData()||!e.hasData())&&null!=t.demTexture&&null!=e.demTexture&&t.tileID.key!==e.tileID.key}const bi=new class{constructor(){this.operations={}}newMorphing(t,e,i,n,r){if(t in this.operations){const e=this.operations[t];e.to.tileID.key!==i.tileID.key&&(e.queued=i)}else this.operations[t]={startTime:n,phase:0,duration:r,from:e,to:i,queued:null}}getMorphValuesForProxy(t){if(!(t in this.operations))return null;const e=this.operations[t];return{from:e.from,to:e.to,phase:e.phase}}update(t){for(const e in this.operations){const i=this.operations[e];for(i.phase=(t-i.startTime)/i.duration;i.phase>=1||!this._validOp(i);)if(!this._nextOp(i,t)){delete this.operations[e];break}}}_nextOp(t,e){return!!t.queued&&(t.from=t.to,t.to=t.queued,t.queued=null,t.phase=0,t.startTime=e,!0)}_validOp(t){return t.from.hasData()&&t.to.hasData()}},wi={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function Ai(t){return 6*Math.pow(1.5,22-t)}function Ti(t,e){const i=1<<t.z;return!e&&(0===t.x||t.x===i-1)||0===t.y||t.y===i-1}const Mi=t=>({u_matrix:t});function Si(e,i,n,r,s){if(s>0){const o=t.exported.now(),a=(o-e.timeAdded)/s,l=i?(o-i.timeAdded)/s:-1,c=n.getSource(),h=r.coveringZoomLevel({tileSize:c.tileSize,roundZoom:c.roundZoom}),u=!i||Math.abs(i.tileID.overscaledZ-h)>Math.abs(e.tileID.overscaledZ-h),d=u&&e.refreshedUponExpiration?1:t.clamp(u?a:1-l,0,1);return e.refreshedUponExpiration&&a>=1&&(e.refreshedUponExpiration=!1),i?{opacity:1,mix:1-d}:{opacity:d,mix:0}}return{opacity:1,mix:0}}class Ei extends t.SourceCache{constructor(t){const e={type:"raster-dem",maxzoom:t.transform.maxZoom},i=new I(Nt(),null),n=Pt("mock-dem",e,i,t.style);super("mock-dem",n,!1),n.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,e){t.state="loaded",e(null)}}class Ci extends t.SourceCache{constructor(t){const e=Pt("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new I(Nt(),null),t.style);super("proxy",e,!1),e.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(e,i,n){if(e.freezeTileCoverage)return;this.transform=e;const r=e.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((i,n)=>{if(i[n.key]="",!this._tiles[n.key]){const i=new t.Tile(n,this._source.tileSize*n.overscaleFactor(),e.tileZoom);i.state="loaded",this._tiles[n.key]=i}return i}),{});for(const t in this._tiles)t in r||(this.freeFBO(t),this._tiles[t].unloadVectorData(),delete this._tiles[t])}freeFBO(t){const e=this.proxyCachedFBO[t];if(void 0!==e){const i=Object.values(e);this.renderCachePool.push(...i),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach((t=>t.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Ii extends t.OverscaledTileID{constructor(t,e,i){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=e,this.projMatrix=i}}class Pi extends t.Elevation{constructor(e,i){super(),this.painter=e,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[n,r,s]=function(e){const i=new t.StructArrayLayout2i4,n=new t.StructArrayLayout3ui6,r=131;i.reserve(17161),n.reserve(33800);const s=t.EXTENT/128,o=t.EXTENT+s/2,a=o+s;for(let e=-s;e<a;e+=s)for(let n=-s;n<a;n+=s){const r=n<0||n>o||e<0||e>o?24575:0,s=t.clamp(Math.round(n),0,t.EXTENT),a=t.clamp(Math.round(e),0,t.EXTENT);i.emplaceBack(s+r,a)}const l=(t,e)=>{const i=e*r+t;n.emplaceBack(i+1,i,i+r),n.emplaceBack(i+r,i+r+1,i+1)};for(let t=1;t<129;t++)for(let e=1;e<129;e++)l(e,t);return[0,129].forEach((t=>{for(let e=0;e<130;e++)l(e,t),l(t,e)})),[i,n,32768]}(),o=e.context;this.gridBuffer=o.createVertexBuffer(n,t.posAttributes.members),this.gridIndexBuffer=o.createIndexBuffer(r),this.gridSegments=t.SegmentVector.simpleSegment(0,0,n.length,r.length),this.gridNoSkirtSegments=t.SegmentVector.simpleSegment(0,0,n.length,s),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Ci(i.map),this.orthoMatrix=t.create(),t.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,t.EXTENT,0,t.EXTENT,0,1);const a=o.gl;this._overlapStencilMode=new t.StencilMode({func:a.GEQUAL,mask:255},0,255,a.KEEP,a.KEEP,a.REPLACE),this._previousZoom=e.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=i,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Ei(i.map)}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),t.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=t,this._checkRenderCacheEfficiency(),this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(e,i,n){if(e&&e.terrain){this._style!==e&&(this.style=e),this.enabled=!0;const r=e.terrain.properties;this.sourceCache=0===e.terrain.drapeRenderMode?this._mockSourceCache:e._getSourceCache(r.get("source")),this._exaggeration=r.get("exaggeration");const s=()=>{this.sourceCache.used&&t.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const e=this.getScaledDemTileSize();this.sourceCache.update(i,e,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,s(),this._initializing=!0),s(),i.updateElevation(!0,n),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(i),this._emptyDEMTextureDirty=!0}else this._disable()}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_checkRenderCacheEfficiency(){const e=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||100!==e.efficiency&&t.warnOnce(`Terrain render cache efficiency is not optimal (${e.efficiency}%) and performance\n                may be affected negatively, consider placing all background, fill and line layers before layer\n                with id '${e.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`)}_onStyleDataEvent(t){t.coord&&"source"===t.dataType?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):"style"===t.dataType&&(this._invalidateRenderCache=!0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._sourceCaches)this._style._sourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach((t=>t.fb.destroy())),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0)}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(e){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const i=this.proxySourceCache,n=this.painter.transform;this._initializing&&(this._initializing=0===n._centerAltitude&&-1===this.getAtPointOrZero(t.MercatorCoordinate.fromLngLat(n.center),-1),this._emptyDEMTextureDirty=!this._initializing);const r=this.proxyCoords=i.getIds().map((t=>{const e=i.getTileByID(t).tileID;return e.projMatrix=n.calculateProjMatrix(e.toUnwrapped()),e}));!function(e,i){const n=i.transform.pointCoordinate(i.transform.getCameraPoint()),r=new t.Point(n.x,n.y);e.sort(((e,i)=>{if(i.overscaledZ-e.overscaledZ)return i.overscaledZ-e.overscaledZ;const n=new t.Point(e.canonical.x+(1<<e.canonical.z)*e.wrap,e.canonical.y),s=new t.Point(i.canonical.x+(1<<i.canonical.z)*i.wrap,i.canonical.y),o=r.mult(1<<e.canonical.z);return o.x-=.5,o.y-=.5,o.distSqr(n)-o.distSqr(s)}))}(r,this.painter),this._previousZoom=n.zoom;const s=this.proxyToSource||{};this.proxyToSource={},r.forEach((t=>{this.proxyToSource[t.key]={}})),this.terrainTileForTile={};const o=this._style._sourceCaches;for(const t in o){const i=o[t];if(!i.used)continue;if(i!==this.sourceCache&&this.resetTileLookupCache(i.id),this._setupProxiedCoordsForOrtho(i,e[t],s),i.usedForTerrain)continue;const n=e[t];i.getSource().reparseOverscaled&&this._assignTerrainTiles(n)}this.proxiedCoords[i.id]=r.map((t=>new Ii(t,t.key,this.orthoMatrix))),this._assignTerrainTiles(r),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(s),this.renderingToTexture=!1,this._updateTimestamp=t.exported.now();const a={};this._visibleDemTiles=[];for(const t of this.proxyCoords){const e=this.terrainTileForTile[t.key];if(!e)continue;const i=e.tileID.key;i in a||(this._visibleDemTiles.push(e),a[i]=i)}}_assignTerrainTiles(t){this._initializing||t.forEach((t=>{if(this.terrainTileForTile[t.key])return;const e=this._findTileCoveringTileID(t,this.sourceCache);e&&(this.terrainTileForTile[t.key]=e)}))}_prepareDEMTextures(){const t=this.painter.context,e=t.gl;for(const i in this.terrainTileForTile){const n=this.terrainTileForTile[i],r=n.dem;!r||n.demTexture&&!n.needsDEMTextureUpload||(t.activeTexture.set(e.TEXTURE1),mi(this.painter,n,r))}}_prepareDemTileUniforms(t,e,i,n){if(!e||null==e.demTexture)return!1;const r=t.tileID.canonical,s=Math.pow(2,e.tileID.canonical.z-r.z),o=n||"";return i[`u_dem_tl${o}`]=[r.x*s%1,r.y*s%1],i[`u_dem_scale${o}`]=s,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const e=this.painter.context,i=e.gl;if(!this._emptyDepthBufferTexture){const n=new t.RGBAImage({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new t.Texture(e,n,i.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let t=0;const e=this._visibleDemTiles.reduce(((e,i)=>{if(!i.dem)return e;const n=i.dem.tree.minimums[0];return n>0&&t++,e+n}),0);return t?e/t:0}_updateEmptyDEMTexture(){const e=this.painter.context,i=e.gl;e.activeTexture.set(i.TEXTURE2);const n=this._getLoadedAreaMinimum(),r=new t.RGBAImage({width:1,height:1},new Uint8Array(t.DEMData.pack(n,this.sourceCache.getSource().encoding)));this._emptyDEMTextureDirty=!1;let s=this._emptyDEMTexture;return s?s.update(r,{premultiply:!1}):s=this._emptyDEMTexture=new t.Texture(e,r,i.RGBA,{premultiply:!1}),s}setupElevationDraw(e,i,n){const r=this.painter.context,s=r.gl,o=(a=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:t.DEMData.getUnpackVector(a),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0});var a;o.u_dem_size=this.sourceCache.getSource().tileSize,o.u_exaggeration=this.exaggeration();let l=null,c=null,h=1;if(n&&n.morphing&&this._useVertexMorphing){const t=n.morphing.srcDemTile,i=n.morphing.dstDemTile;h=n.morphing.phase,t&&i&&(this._prepareDemTileUniforms(e,t,o,"_prev")&&(c=t),this._prepareDemTileUniforms(e,i,o)&&(l=i))}if(c&&l?(r.activeTexture.set(s.TEXTURE2),l.demTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE,s.NEAREST),r.activeTexture.set(s.TEXTURE4),c.demTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE,s.NEAREST),o.u_dem_lerp=h):(l=this.terrainTileForTile[e.tileID.key],r.activeTexture.set(s.TEXTURE2),(this._prepareDemTileUniforms(e,l,o)?l.demTexture:this.emptyDEMTexture).bind(s.NEAREST,s.CLAMP_TO_EDGE)),r.activeTexture.set(s.TEXTURE3),n&&n.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),this._depthFBO&&(o.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(s.NEAREST,s.CLAMP_TO_EDGE),o.u_depth_size_inv=[1,1]),n&&n.useMeterToDem&&l){const e=(1<<l.tileID.canonical.z)*t.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;o.u_meter_to_dem=e}if(n&&n.labelPlaneMatrixInv&&(o.u_label_plane_matrix_inv=n.labelPlaneMatrixInv),i.setTerrainUniformValues(r,o),"globe"===this.painter.transform.projection.name){const t=this.globeUniformValues(this.painter.transform,e.tileID.canonical,n&&n.useDenormalizedUpVectorScale);i.setGlobeUniformValues(r,t)}}globeUniformValues(e,i,n){const r=e.projection;return{u_tile_tl_up:r.upVector(i,0,0),u_tile_tr_up:r.upVector(i,t.EXTENT,0),u_tile_br_up:r.upVector(i,t.EXTENT,t.EXTENT),u_tile_bl_up:r.upVector(i,0,t.EXTENT),u_tile_up_scale:n?t.globeMetersToEcef(1):r.upVectorScale(i,e.center.lat,e.worldSize).metersToTile}}renderToBackBuffer(e){const i=this.painter,n=this.painter.context;0!==e.length&&(n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),i.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(e,i,n,r,s){if("globe"===e.transform.projection.name)!function(e,i,n,r,s){const o=e.context,a=o.gl;let l,c;const h=e.options.showTerrainWireframe?2:0,u=e.transform,d=t.globeUseCustomAntiAliasing(e,o,u),p=(t,i)=>{if(c===t)return;const n=[wi[t],"PROJECTION_GLOBE_VIEW"];d&&n.push("CUSTOM_ANTIALIASING"),i&&n.push(wi[h]),l=e.useProgram("globeRaster",null,n),c=t},f=e.colorModeForRenderPass(),m=new t.DepthMode(a.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);bi.update(s);const g=t.calculateGlobeMercatorMatrix(u),_=[t.mercatorXfromLng(u.center.lng),t.mercatorYfromLat(u.center.lat)],y=h?[!1,!0]:[!1],v=e.globeSharedBuffers,x=[u.width*t.exported.devicePixelRatio,u.height*t.exported.devicePixelRatio],b=Float32Array.from(u.globeMatrix),w={useDenormalizedUpVectorScale:!0};if(y.forEach((h=>{const u=e.transform,d=Ai(u.zoom)*i.exaggeration();c=-1;const y=h?a.LINES:a.TRIANGLES;for(const c of r){const r=n.getTile(c),A=t.StencilMode.disabled,T=i.prevTerrainTileForTile[c.key],M=i.terrainTileForTile[c.key];xi(T,M)&&bi.newMorphing(c.key,T,M,s,250),o.activeTexture.set(a.TEXTURE0),r.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);const S=bi.getMorphValuesForProxy(c.key),E=S?1:0;S&&t.extend$1(w,{morphing:{srcDemTile:S.from,dstDemTile:S.to,phase:t.easeCubicInOut(S.phase)}});const C=t.tileCornersToBounds(c.canonical),I=t.getLatitudinalLod(C.getCenter().lat),P=t.getGridMatrix(c.canonical,C,I,u.worldSize/u._pixelsPerMercatorPixel),L=t.globeNormalizeECEF(t.globeTileBounds(c.canonical)),R=vi(u.projMatrix,b,g,L,t.globeToMercatorTransition(u.zoom),_,u.frustumCorners.TL,u.frustumCorners.TR,u.frustumCorners.BR,u.frustumCorners.BL,u.globeCenterInViewSpace,u.globeRadius,x,d,P);if(p(E,h),i.setupElevationDraw(r,l,w),e.prepareDrawProgram(o,l,c.toUnwrapped()),v){const[i,n,r]=h?v.getWirefameBuffers(e.context,I):v.getGridBuffers(I,0!==d);l.draw(o,y,m,A,f,t.CullFaceMode.backCCW,R,"globe_raster",i,n,r)}}})),v){const s=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];d&&s.push("CUSTOM_ANTIALIASING"),l=e.useProgram("globeRaster",null,s);for(const s of r){const{x:r,y:c,z:h}=s.canonical,d=0===c,p=c===(1<<h)-1,[g,y,b,A]=v.getPoleBuffers(h);if(A&&(d||p)){const c=n.getTile(s);o.activeTexture.set(a.TEXTURE0),c.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);let v=t.globePoleMatrixForTile(h,r,u);const T=t.globeNormalizeECEF(t.globeTileBounds(s.canonical)),M=(e,i)=>e.draw(o,a.TRIANGLES,m,t.StencilMode.disabled,f,t.CullFaceMode.disabled,vi(u.projMatrix,v,v,T,0,_,u.frustumCorners.TL,u.frustumCorners.TR,u.frustumCorners.BR,u.frustumCorners.BL,u.globeCenterInViewSpace,u.globeRadius,x,0),"globe_pole_raster",i,b,A);i.setupElevationDraw(c,l,w),e.prepareDrawProgram(o,l,s.toUnwrapped()),d&&M(l,g),p&&(v=t.scale(t.create(),v,[1,-1,1]),M(l,y))}}}}(e,i,n,r,s);else{const o=e.context,a=o.gl;let l,c;const h=e.options.showTerrainWireframe?2:0,u=(t,i)=>{if(c===t)return;const n=[wi[t]];i&&n.push(wi[h]),l=e.useProgram("terrainRaster",null,n),c=t},d=e.colorModeForRenderPass(),p=new t.DepthMode(a.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);bi.update(s);const f=e.transform,m=Ai(f.zoom)*i.exaggeration();(h?[!1,!0]:[!1]).forEach((h=>{c=-1;const g=h?a.LINES:a.TRIANGLES,[_,y]=h?i.getWirefameBuffer():[i.gridIndexBuffer,i.gridSegments];for(const c of r){const r=n.getTile(c),v=t.StencilMode.disabled,x=i.prevTerrainTileForTile[c.key],b=i.terrainTileForTile[c.key];xi(x,b)&&bi.newMorphing(c.key,x,b,s,250),o.activeTexture.set(a.TEXTURE0),r.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE,a.LINEAR_MIPMAP_NEAREST);const w=bi.getMorphValuesForProxy(c.key),A=w?1:0;let T;w&&(T={morphing:{srcDemTile:w.from,dstDemTile:w.to,phase:t.easeCubicInOut(w.phase)}});const M=yi(c.projMatrix,Ti(c.canonical,f.renderWorldCopies)?m/10:m);u(A,h),i.setupElevationDraw(r,l,T),e.prepareDrawProgram(o,l,c.toUnwrapped()),l.draw(o,g,p,v,d,t.CullFaceMode.backCCW,M,"terrain_raster",i.gridBuffer,_,y)}}))}}(i,this,this.proxySourceCache,e,this._updateTimestamp),this.renderingToTexture=!0,i.gpuTimingDeferredRenderEnd(),e.splice(0,e.length))}renderBatch(e){if(0===this._drapedRenderBatches.length)return e+1;this.renderingToTexture=!0;const i=this.painter,n=this.painter.context,r=this.proxySourceCache,s=this.proxiedCoords[r.id],o=this._drapedRenderBatches.shift(),a=[],l=i.style.order;let c=0;for(const h of s){const s=r.getTileByID(h.proxyTileKey),u=r.proxyCachedFBO[h.key]?r.proxyCachedFBO[h.key][e]:void 0,d=void 0!==u?r.renderCache[u]:this.pool[c++],p=void 0!==u;if(s.texture=d.tex,p&&!d.dirty){a.push(s.tileID);continue}let f;n.bindFramebuffer.set(d.fb.framebuffer),this.renderedToTile=!1,d.dirty&&(n.clear({color:t.Color.transparent,stencil:0}),d.dirty=!1);for(let t=o.start;t<=o.end;++t){const e=i.style._layers[l[t]];if(e.isHidden(i.transform.zoom))continue;const r=i.style._getLayerSourceCache(e),s=r?this.proxyToSource[h.key][r.id]:[h];if(!s)continue;const o=s;n.viewport.set([0,0,d.fb.width,d.fb.height]),f!==(r?r.id:null)&&(this._setupStencil(d,s,e,r),f=r?r.id:null),i.renderLayer(i,r,e,o)}this.renderedToTile?(d.dirty=!0,a.push(s.tileID)):p||--c,5===c&&(c=0,this.renderToBackBuffer(a))}return this.renderToBackBuffer(a),this.renderingToTexture=!1,n.bindFramebuffer.set(null),n.viewport.set([0,0,i.width,i.height]),o.end+1}postRender(){}renderCacheEfficiency(t){const e=t.order.length;if(0===e)return{efficiency:100};let i,n=0,r=0,s=!1;for(let o=0;o<e;++o){const e=t._layers[t.order[o]];this._style.isLayerDraped(e)?(s&&++n,++r):s||(s=!0,i=e.id)}return 0===r?{efficiency:100}:{efficiency:100*(1-n/r),firstUndrapedLayer:i}}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter((t=>t.dem)).forEach((e=>{t=Math.min(t,e.dem.tree.minimums[0])})),0===t?t:(t-30)*this._exaggeration}raycast(t,e,i){if(!this._visibleDemTiles)return null;const n=this._visibleDemTiles.filter((t=>t.dem)).map((n=>{const r=n.tileID,s=1<<r.overscaledZ,{x:o,y:a}=r.canonical,l=o/s,c=(o+1)/s,h=a/s,u=(a+1)/s;return{minx:l,miny:h,maxx:c,maxy:u,t:n.dem.tree.raycastRoot(l,h,c,u,t,e,i),tile:n}}));n.sort(((t,e)=>(null!==t.t?t.t:Number.MAX_VALUE)-(null!==e.t?e.t:Number.MAX_VALUE)));for(const r of n){if(null==r.t)return null;const n=r.tile.dem.tree.raycast(r.minx,r.miny,r.maxx,r.maxy,t,e,i);if(null!=n)return n}return null}_createFBO(){const e=this.painter.context,i=e.gl,n=this.drapeBufferSize;e.activeTexture.set(i.TEXTURE0);const r=new t.Texture(e,{width:n[0],height:n[1],data:null},i.RGBA);r.bind(i.LINEAR,i.CLAMP_TO_EDGE);const s=e.createFramebuffer(n[0],n[1],!1);return s.colorAttachment.set(r.texture),s.depthAttachment=new wt(e,s.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=e.createRenderbuffer(e.gl.DEPTH_STENCIL,n[0],n[1]),this._stencilRef=0,s.depthAttachment.set(this._sharedDepthStencil),e.clear({stencil:0})):s.depthAttachment.set(this._sharedDepthStencil),e.extTextureFilterAnisotropic&&!e.extTextureFilterAnisotropicForceOff&&i.texParameterf(i.TEXTURE_2D,e.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.extTextureFilterAnisotropicMax),{fb:s,tex:r,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return!0;for(const t in this._style._sourceCaches)if(this._style._sourceCaches[t].hasTransition())return!0;return this._style.order.some((t=>{const e=this._style._layers[t],i=e.isHidden(this.painter.transform.zoom);return"custom"===e.type?!i&&e.shouldRedrape():!i&&e.hasTransition()}))}_clearLineLayersFromRenderCache(){let e=!1;for(const t of this._style._getSources())if(t instanceof Mt){e=!0;break}if(!e)return;const i={};for(let e=0;e<this._style.order.length;++e){const n=this._style._layers[this._style.order[e]],r=this._style._getLayerSourceCache(n);if(r&&!i[r.id]&&!n.isHidden(this.painter.transform.zoom)&&"line"===n.type&&n.widthExpression()instanceof t.ZoomDependentExpression){i[r.id]=!0;for(const t of this.proxyCoords){const e=this.proxyToSource[t.key][r.id];if(e)for(const t of e)this._clearRenderCacheForTile(r.id,t)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const e in this._style._sourceCaches)if(this._style._sourceCaches[e]._source instanceof St){t=!0;break}if(!t)return;const e={};for(let t=0;t<this._style.order.length;++t){const i=this._style._layers[this._style.order[t]],n=this._style._getLayerSourceCache(i);if(!n||e[n.id])continue;if(i.isHidden(this.painter.transform.zoom)||"raster"!==i.type)continue;const r=i.paint.get("raster-fade-duration");for(const t of this.proxyCoords){const e=this.proxyToSource[t.key][n.id];if(e)for(const t of e){const e=Si(n.getTile(t),n.findLoadedParent(t,0),n,this.painter.transform,r);(1!==e.opacity||0!==e.mix)&&this._clearRenderCacheForTile(n.id,t)}}}}_setupDrapedRenderBatches(){const t=this._style.order,e=t.length;if(0===e)return;const i=[];let n,r=0,s=this._style._layers[t[r]];for(;!this._style.isLayerDraped(s)&&s.isHidden(this.painter.transform.zoom)&&++r<e;)s=this._style._layers[t[r]];for(;r<e;++r){const e=this._style._layers[t[r]];e.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(e)?void 0===n&&(n=r):void 0!==n&&(i.push({start:n,end:r-1}),n=void 0))}void 0!==n&&i.push({start:n,end:r-1}),this._drapedRenderBatches=i}_setupRenderCache(t){const e=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,e.renderCache.length>e.renderCachePool.length){const t=Object.values(e.proxyCachedFBO);e.proxyCachedFBO={};for(let i=0;i<t.length;++i){const n=Object.values(t[i]);e.renderCachePool.push(...n)}}return}this._clearRasterLayersFromRenderCache();const i=this.proxyCoords,n=this._tilesDirty;for(let r=i.length-1;r>=0;r--){const s=i[r];if(e.getTileByID(s.key),void 0!==e.proxyCachedFBO[s.key]){const i=t[s.key],r=this.proxyToSource[s.key];let o=0;for(const t in r){const e=r[t],s=i[t];if(!s||s.length!==e.length||e.some(((e,i)=>e!==s[i]||n[t]&&n[t].hasOwnProperty(e.key)))){o=-1;break}++o}for(const t in e.proxyCachedFBO[s.key])e.renderCache[e.proxyCachedFBO[s.key][t]].dirty=o<0||o!==Object.values(i).length}}const r=[...this._drapedRenderBatches];r.sort(((t,e)=>e.end-e.start-(t.end-t.start)));for(const t of r)for(const n of i){if(e.proxyCachedFBO[n.key])continue;let i=e.renderCachePool.pop();void 0===i&&e.renderCache.length<50&&(i=e.renderCache.length,e.renderCache.push(this._createFBO())),void 0!==i&&(e.proxyCachedFBO[n.key]={},e.proxyCachedFBO[n.key][t.start]=i,e.renderCache[i].dirty=!0)}this._tilesDirty={}}_setupStencil(t,e,i,n){if(!n||!this._sourceTilesOverlap[n.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const r=this.painter.context,s=r.gl;if(e.length<=1)return void(this._overlapStencilType=!1);let o;if(i.isTileClipped())o=e.length,this._overlapStencilMode.test={func:s.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(e[0].overscaledZ>e[e.length-1].overscaledZ))return void(this._overlapStencilType=!1);o=1,this._overlapStencilMode.test={func:s.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+o>255&&(r.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=o,this._overlapStencilMode.ref=this._stencilRef,i.isTileClipped()&&this._renderTileClippingMasks(e,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(e){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[e.key]),this._overlapStencilMode):t.StencilMode.disabled}_renderTileClippingMasks(e,i){const n=this.painter,r=this.painter.context,s=r.gl;n._tileClippingMaskIDs={},r.setColorMode(t.ColorMode.disabled),r.setDepthMode(t.DepthMode.disabled);const o=n.useProgram("clippingMask");for(const a of e){const e=n._tileClippingMaskIDs[a.key]=--i;o.draw(r,s.TRIANGLES,t.DepthMode.disabled,new t.StencilMode({func:s.ALWAYS,mask:0},e,255,s.KEEP,s.KEEP,s.REPLACE),t.ColorMode.disabled,t.CullFaceMode.disabled,Mi(a.projMatrix),"$clipping",n.tileExtentBuffer,n.quadTriangleIndexBuffer,n.tileExtentSegments)}}pointCoordinate(e){const i=this.painter.transform;if(e.x<0||e.x>i.width||e.y<0||e.y>i.height)return null;const n=[e.x,e.y,1,1];t.transformMat4$1(n,n,i.pixelMatrixInverse),t.scale$1(n,n,1/n[3]),n[0]/=i.worldSize,n[1]/=i.worldSize;const r=i._camera.position,s=t.mercatorZfromAltitude(1,i.center.lat),o=[r[0],r[1],r[2]/s,0],a=t.subtract([],n.slice(0,3),o);t.normalize(a,a);const l=this.raycast(o,a,this._exaggeration);return null!==l&&l?(t.scaleAndAdd(o,o,a,l),o[3]=o[2],o[2]*=s,o):null}drawDepth(){const e=this.painter,i=e.context,n=this.proxySourceCache,r=Math.ceil(e.width),s=Math.ceil(e.height);if(!this._depthFBO||this._depthFBO.width===r&&this._depthFBO.height===s||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const e=i.gl,n=i.createFramebuffer(r,s,!0);i.activeTexture.set(e.TEXTURE0);const o=new t.Texture(i,{width:r,height:s,data:null},e.RGBA);o.bind(e.NEAREST,e.CLAMP_TO_EDGE),n.colorAttachment.set(o.texture);const a=i.createRenderbuffer(i.gl.DEPTH_COMPONENT16,r,s);n.depthAttachment.set(a),this._depthFBO=n,this._depthTexture=o}i.bindFramebuffer.set(this._depthFBO.framebuffer),i.viewport.set([0,0,r,s]),function(e,i,n,r){if("globe"===e.transform.projection.name)return;const s=e.context,o=s.gl;s.clear({depth:1});const a=e.useProgram("terrainDepth"),l=new t.DepthMode(o.LESS,t.DepthMode.ReadWrite,e.depthRangeFor3D);for(const e of r){const r=n.getTile(e),c=yi(e.projMatrix,0);i.setupElevationDraw(r,a),a.draw(s,o.TRIANGLES,l,t.StencilMode.disabled,t.ColorMode.unblended,t.CullFaceMode.backCCW,c,"terrain_depth",i.gridBuffer,i.gridIndexBuffer,i.gridNoSkirtSegments)}}(e,this,n,this.proxyCoords)}_setupProxiedCoordsForOrtho(t,e,i){if(t.getSource()instanceof Ct)return this._setupProxiedCoordsForImageSource(t,e,i);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const n=this.proxiedCoords[t.id]=[],r=this.proxyCoords;for(let e=0;e<r.length;e++){const s=r[e],o=this._findTileCoveringTileID(s,t);if(o){const e=this._createProxiedId(s,o,i[s.key]&&i[s.key][t.id]);n.push(e),this.proxyToSource[s.key][t.id]=[e]}}let s=!1;for(let r=0;r<e.length;r++){const o=t.getTile(e[r]);if(!o||!o.hasData())continue;const a=this._findTileCoveringTileID(o.tileID,this.proxySourceCache);if(a&&a.tileID.canonical.z!==o.tileID.canonical.z){const e=this.proxyToSource[a.tileID.key][t.id],r=this._createProxiedId(a.tileID,o,i[a.tileID.key]&&i[a.tileID.key][t.id]);e?e.splice(e.length-1,0,r):this.proxyToSource[a.tileID.key][t.id]=[r],n.push(r),s=!0}}this._sourceTilesOverlap[t.id]=s}_setupProxiedCoordsForImageSource(e,i,n){if(!e.getSource().loaded())return;const r=this.proxiedCoords[e.id]=[],s=this.proxyCoords,o=e.getSource(),a=new t.Point(o.tileID.x,o.tileID.y)._div(1<<o.tileID.z),l=o.coordinates.map(t.MercatorCoordinate.fromLngLat).reduce(((t,e)=>(t.min.x=Math.min(t.min.x,e.x-a.x),t.min.y=Math.min(t.min.y,e.y-a.y),t.max.x=Math.max(t.max.x,e.x-a.x),t.max.y=Math.max(t.max.y,e.y-a.y),t)),{min:new t.Point(Number.MAX_VALUE,Number.MAX_VALUE),max:new t.Point(-Number.MAX_VALUE,-Number.MAX_VALUE)}),c=(e,i)=>{const n=e.wrap+e.canonical.x/(1<<e.canonical.z),r=e.canonical.y/(1<<e.canonical.z),s=t.EXTENT/(1<<e.canonical.z),o=i.wrap+i.canonical.x/(1<<i.canonical.z),a=i.canonical.y/(1<<i.canonical.z);return n+s<o+l.min.x||n>o+l.max.x||r+s<a+l.min.y||r>a+l.max.y};for(let t=0;t<s.length;t++){const o=s[t];for(let t=0;t<i.length;t++){const s=e.getTile(i[t]);if(!s||!s.hasData())continue;if(c(o,s.tileID))continue;const a=this._createProxiedId(o,s,n[o.key]&&n[o.key][e.id]),l=this.proxyToSource[o.key][e.id];l?l.push(a):this.proxyToSource[o.key][e.id]=[a],r.push(a)}}}_createProxiedId(e,i,n){let r=this.orthoMatrix;if(n){const t=n.find((t=>t.key===i.tileID.key));if(t)return t}if(i.tileID.key!==e.key){const n=e.canonical.z-i.tileID.canonical.z;let s,o,a;r=t.create();const l=i.tileID.wrap-e.wrap<<e.overscaledZ;n>0?(s=t.EXTENT>>n,o=s*((i.tileID.canonical.x<<n)-e.canonical.x+l),a=s*((i.tileID.canonical.y<<n)-e.canonical.y)):(s=t.EXTENT<<-n,o=t.EXTENT*(i.tileID.canonical.x-(e.canonical.x+l<<-n)),a=t.EXTENT*(i.tileID.canonical.y-(e.canonical.y<<-n))),t.ortho(r,0,s,0,s,0,1),t.translate(r,r,[o,a,0])}return new Ii(i.tileID,e.key,r)}_findTileCoveringTileID(e,i){let n=i.getTile(e);if(n&&n.hasData())return n;const r=this._findCoveringTileCache[i.id],s=r[e.key];if(n=s?i.getTileByID(s):null,n&&n.hasData()||null===s)return n;let o=n?n.tileID:e,a=o.overscaledZ;const l=i.getSource().minzoom,c=[];if(!s){const r=i.getSource().maxzoom;if(e.canonical.z>=r){const n=e.canonical.z-r;i.getSource().reparseOverscaled?(a=Math.max(e.canonical.z+2,i.transform.tileZoom),o=new t.OverscaledTileID(a,e.wrap,r,e.canonical.x>>n,e.canonical.y>>n)):0!==n&&(a=r,o=new t.OverscaledTileID(a,e.wrap,r,e.canonical.x>>n,e.canonical.y>>n))}o.key!==e.key&&(c.push(o.key),n=i.getTile(o))}const h=t=>{c.forEach((e=>{r[e]=t})),c.length=0};for(a-=1;a>=l&&(!n||!n.hasData());a--){n&&h(n.tileID.key);const t=o.calculateScaledKey(a);if(n=i.getTileByID(t),n&&n.hasData())break;const e=r[t];if(null===e)break;void 0===e?c.push(t):n=i.getTileByID(e)}return h(n?n.tileID.key:null),n&&n.hasData()?n:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,e){let i=this._tilesDirty[t];i||(i=this._tilesDirty[t]={}),i[e.key]=!0}getWirefameBuffer(){if(!this.wireframeSegments){const e=function(e){let i=0;const n=new t.StructArrayLayout2ui4,r=131;for(let t=1;t<129;t++){for(let e=1;e<129;e++)i=t*r+e,n.emplaceBack(i,i+1),n.emplaceBack(i,i+r),n.emplaceBack(i+1,i+r),128===t&&n.emplaceBack(i+r,i+r+1);n.emplaceBack(i+1,i+1+r)}return n}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(e),this.wireframeSegments=t.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,e.length)}return[this.wireframeIndexBuffer,this.wireframeSegments]}}class Li{static cacheKey(t,e,i,n){let r=`${e}${n?n.cacheKey:""}`;for(const e of i)t.usedDefines.includes(e)&&(r+=`/${e}`);return r}constructor(e,i,n,r,s,o){const a=e.gl;this.program=a.createProgram();const l=function(t){const e=[];for(let i=0;i<t.length;i++){if(null===t[i])continue;const n=t[i].split(" ");e.push(n.pop())}return e}(n.staticAttributes),c=r?r.getBinderAttributes():[],h=l.concat(c);let u=r?r.defines():[];u=u.concat(o.map((t=>`#define ${t}`)));const d=e.isWebGL2?"#version 300 es\n":"",p=d+u.concat(e.extStandardDerivatives&&0===d.length?"#extension GL_OES_standard_derivatives : enable\n".concat(li):li,li,ai,oi.fragmentSource,ri.fragmentSource,n.fragmentSource).join("\n"),f=d+u.concat("\n#ifdef GL_ES\nprecision highp float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",ai,oi.vertexSource,ri.vertexSource,ni.vertexSource,n.vertexSource).join("\n"),m=a.createShader(a.FRAGMENT_SHADER);if(a.isContextLost())return void(this.failedToCreate=!0);a.shaderSource(m,p),a.compileShader(m),a.attachShader(this.program,m);const g=a.createShader(a.VERTEX_SHADER);if(a.isContextLost())this.failedToCreate=!0;else{a.shaderSource(g,f),a.compileShader(g),a.attachShader(this.program,g),this.attributes={},this.numAttributes=h.length;for(let t=0;t<this.numAttributes;t++)h[t]&&(a.bindAttribLocation(this.program,t,h[t]),this.attributes[h[t]]=t);a.linkProgram(this.program),a.deleteShader(g),a.deleteShader(m),this.fixedUniforms=s(e),this.binderUniforms=r?r.getUniforms(e):[],o.includes("TERRAIN")&&(this.terrainUniforms=(e=>({u_dem:new t.Uniform1i(e),u_dem_prev:new t.Uniform1i(e),u_dem_unpack:new t.Uniform4f(e),u_dem_tl:new t.Uniform2f(e),u_dem_scale:new t.Uniform1f(e),u_dem_tl_prev:new t.Uniform2f(e),u_dem_scale_prev:new t.Uniform1f(e),u_dem_size:new t.Uniform1f(e),u_dem_lerp:new t.Uniform1f(e),u_exaggeration:new t.Uniform1f(e),u_depth:new t.Uniform1i(e),u_depth_size_inv:new t.Uniform2f(e),u_meter_to_dem:new t.Uniform1f(e),u_label_plane_matrix_inv:new t.UniformMatrix4f(e)}))(e)),o.includes("GLOBE")&&(this.globeUniforms=(e=>({u_tile_tl_up:new t.Uniform3f(e),u_tile_tr_up:new t.Uniform3f(e),u_tile_br_up:new t.Uniform3f(e),u_tile_bl_up:new t.Uniform3f(e),u_tile_up_scale:new t.Uniform1f(e)}))(e)),o.includes("FOG")&&(this.fogUniforms=(e=>({u_fog_matrix:new t.UniformMatrix4f(e),u_fog_range:new t.Uniform2f(e),u_fog_color:new t.Uniform4f(e),u_fog_horizon_blend:new t.Uniform1f(e),u_fog_temporal_offset:new t.Uniform1f(e),u_frustum_tl:new t.Uniform3f(e),u_frustum_tr:new t.Uniform3f(e),u_frustum_br:new t.Uniform3f(e),u_frustum_bl:new t.Uniform3f(e),u_globe_pos:new t.Uniform3f(e),u_globe_radius:new t.Uniform1f(e),u_globe_transition:new t.Uniform1f(e),u_is_globe:new t.Uniform1i(e),u_viewport:new t.Uniform2f(e)}))(e))}}setTerrainUniformValues(t,e){if(!this.terrainUniforms)return;const i=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const t in e)i[t]&&i[t].set(this.program,t,e[t])}}setGlobeUniformValues(t,e){if(!this.globeUniforms)return;const i=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const t in e)i[t]&&i[t].set(this.program,t,e[t])}}setFogUniformValues(t,e){if(!this.fogUniforms)return;const i=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const t in e)i[t].set(this.program,t,e[t])}}draw(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f){const m=t.gl;if(this.failedToCreate)return;t.program.set(this.program),t.setDepthMode(i),t.setStencilMode(n),t.setColorMode(r),t.setCullFace(s);for(const t of Object.keys(this.fixedUniforms))this.fixedUniforms[t].set(this.program,t,o[t]);p&&p.setUniforms(this.program,t,this.binderUniforms,u,{zoom:d});const g={[m.LINES]:2,[m.TRIANGLES]:3,[m.LINE_STRIP]:1}[e];for(const i of h.get()){const n=i.vaos||(i.vaos={});(n[a]||(n[a]=new di)).bind(t,this,l,p?p.getPaintVertexBuffers():[],c,i.vertexOffset,f||[]),m.drawElements(e,i.primitiveLength*g,m.UNSIGNED_SHORT,i.primitiveOffset*g*2)}}}function Ri(t,e){const i=Math.pow(2,e.tileID.overscaledZ),n=e.tileSize*Math.pow(2,t.transform.tileZoom)/i,r=n*(e.tileID.canonical.x+e.tileID.wrap*i),s=n*e.tileID.canonical.y;return{u_image:0,u_texsize:e.imageAtlasTexture.size,u_tile_units_to_pixels:1/P(e,1,t.transform.tileZoom),u_pixel_coord_upper:[r>>16,s>>16],u_pixel_coord_lower:[65535&r,65535&s]}}const Bi=t.create(),Di=(e,i,n,r,s,o,a,l,c,h,u)=>{const d=i.style.light,p=d.properties.get("position"),f=[p.x,p.y,p.z],m=t.create$1();"viewport"===d.properties.get("anchor")&&(t.fromRotation(m,-i.transform.angle),t.transformMat3(f,f,m));const g=d.properties.get("color"),_=i.transform,y={u_matrix:e,u_lightpos:f,u_lightintensity:d.properties.get("intensity"),u_lightcolor:[g.r,g.g,g.b],u_vertical_gradient:+n,u_opacity:r,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Bi,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:s,u_edge_radius:o};return"globe"===_.projection.name&&(y.u_tile_id=[a.canonical.x,a.canonical.y,1<<a.canonical.z],y.u_zoom_transition=c,y.u_inv_rot_matrix=u,y.u_merc_center=h,y.u_up_dir=_.projection.upVector(new t.CanonicalTileID(0,0,0),h[0]*t.EXTENT,h[1]*t.EXTENT),y.u_height_lift=l),y},Oi=(e,i,n,r,s,o,a,l,c,h,u,d)=>{const p=Di(e,i,n,r,s,o,a,c,h,u,d),f={u_height_factor:-Math.pow(2,a.overscaledZ)/l.tileSize/8};return t.extend(p,Ri(i,l),f)},ki=t=>({u_matrix:t}),Fi=(e,i,n)=>t.extend(ki(e),Ri(i,n)),zi=(t,e)=>({u_matrix:t,u_world:e}),Ni=(e,i,n,r)=>t.extend(Fi(e,i,n),{u_world:r}),Ui=t.create(),Gi=(e,i,n,r,s,o)=>{const a=e.transform,l="globe"===a.projection.name;let c;if("map"===o.paint.get("circle-pitch-alignment"))if(l){const e=t.globePixelsToTileUnits(a.zoom,i.canonical)*a._pixelsPerMercatorPixel;c=Float32Array.from([e,0,0,e])}else c=a.calculatePixelsToTileUnitsMatrix(n);else c=new Float32Array([a.pixelsToGLUnits[0],0,0,a.pixelsToGLUnits[1]]);const h={u_camera_to_center_distance:a.cameraToCenterDistance,u_matrix:e.translatePosMatrix(i.projMatrix,n,o.paint.get("circle-translate"),o.paint.get("circle-translate-anchor")),u_device_pixel_ratio:t.exported.devicePixelRatio,u_extrude_scale:c,u_inv_rot_matrix:Ui,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(l){h.u_inv_rot_matrix=r,h.u_merc_center=s,h.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],h.u_zoom_transition=t.globeToMercatorTransition(a.zoom);const e=s[0]*t.EXTENT,n=s[1]*t.EXTENT;h.u_up_dir=a.projection.upVector(new t.CanonicalTileID(0,0,0),e,n)}return h},Vi=t=>{const e=[];return"map"===t.paint.get("circle-pitch-alignment")&&e.push("PITCH_WITH_MAP"),"map"===t.paint.get("circle-pitch-scale")&&e.push("SCALE_WITH_MAP"),e},ji=(e,i,n,r)=>{const s=t.EXTENT/n.tileSize;return{u_matrix:e,u_camera_to_center_distance:i.getCameraToCenterDistance(r),u_extrude_scale:[i.pixelsToGLUnits[0]/s,i.pixelsToGLUnits[1]/s]}},Hi=(t,e,i=1)=>({u_matrix:t,u_color:e,u_overlay:0,u_overlay_scale:i}),Wi=t.create(),qi=(e,i,n,r,s,o,a)=>{const l=e.transform,c="globe"===l.projection.name,h=c?t.globePixelsToTileUnits(l.zoom,i.canonical)*l._pixelsPerMercatorPixel:P(n,1,o),u={u_matrix:i.projMatrix,u_extrude_scale:h,u_intensity:a,u_inv_rot_matrix:Wi,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(c){u.u_inv_rot_matrix=r,u.u_merc_center=s,u.u_tile_id=[i.canonical.x,i.canonical.y,1<<i.canonical.z],u.u_zoom_transition=t.globeToMercatorTransition(l.zoom);const e=s[0]*t.EXTENT,n=s[1]*t.EXTENT;u.u_up_dir=l.projection.upVector(new t.CanonicalTileID(0,0,0),e,n)}return u},Xi=(t,e,i,n,r,s,o)=>{const a=t.transform,l=a.calculatePixelsToTileUnitsMatrix(e);return{u_matrix:Yi(t,e,i,n),u_pixels_to_tile_units:l,u_device_pixel_ratio:s,u_units_to_pixels:[1/a.pixelsToGLUnits[0],1/a.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:r,u_texsize:$i(i)?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Ji(e,t.transform),u_alpha_discard_threshold:0,u_trim_offset:o}},Zi=(t,e,i,n,r)=>{const s=t.transform;return{u_matrix:Yi(t,e,i,n),u_texsize:e.imageAtlasTexture.size,u_pixels_to_tile_units:s.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:r,u_image:0,u_tile_units_to_pixels:Ji(e,s),u_units_to_pixels:[1/s.pixelsToGLUnits[0],1/s.pixelsToGLUnits[1]],u_alpha_discard_threshold:0}};function Ji(t,e){return 1/P(t,1,e.tileZoom)}function Yi(t,e,i,n){return t.translatePosMatrix(n||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}function $i(t){const e=t.paint.get("line-dasharray").value;return e.value||"constant"!==e.kind}const Ki=(t,e,i,n,r,s)=>{return{u_matrix:t,u_tl_parent:e,u_scale_parent:i,u_fade_t:n.mix,u_opacity:n.opacity*r.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:r.paint.get("raster-brightness-min"),u_brightness_high:r.paint.get("raster-brightness-max"),u_saturation_factor:(a=r.paint.get("raster-saturation"),a>0?1-1/(1.001-a):-a),u_contrast_factor:(o=r.paint.get("raster-contrast"),o>0?1/(1-o):1+o),u_spin_weights:Qi(r.paint.get("raster-hue-rotate")),u_perspective_transform:s};var o,a};function Qi(t){t*=Math.PI/180;const e=Math.sin(t),i=Math.cos(t);return[(2*i+1)/3,(-Math.sqrt(3)*e-i+1)/3,(Math.sqrt(3)*e-i+1)/3]}const tn=t.create(),en=(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g)=>{const _=s.transform,y={u_is_size_zoom_constant:+("constant"===e||"source"===e),u_is_size_feature_constant:+("constant"===e||"camera"===e),u_size_t:i?i.uSizeT:0,u_size:i?i.uSize:0,u_camera_to_center_distance:_.cameraToCenterDistance,u_rotate_symbol:+n,u_aspect_ratio:_.width/_.height,u_fade_change:s.options.fadeDuration?s.symbolFadeChange:1,u_matrix:o,u_label_plane_matrix:a,u_coord_matrix:l,u_is_text:+c,u_pitch_with_map:+r,u_texsize:h,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:tn,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:tn,u_up_vector:[0,-1,0]};return"globe"===g.name&&(y.u_tile_id=[u.canonical.x,u.canonical.y,1<<u.canonical.z],y.u_zoom_transition=d,y.u_inv_rot_matrix=f,y.u_merc_center=p,y.u_camera_forward=_._camera.forward(),y.u_ecef_origin=t.globeECEFOrigin(_.globeMatrix,u.toUnwrapped()),y.u_tile_matrix=Float32Array.from(_.globeMatrix),y.u_up_vector=m),y},nn=(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_)=>t.extend(en(e,i,n,r,s,o,a,l,c,h,d,p,f,m,g,_),{u_gamma_scale:r?s.transform.cameraToCenterDistance*Math.cos(s.terrain?0:s.transform._pitch):1,u_device_pixel_ratio:t.exported.devicePixelRatio,u_is_halo:+u}),rn=(e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g)=>t.extend(nn(e,i,n,r,s,o,a,l,!0,c,!0,u,d,p,f,m,g),{u_texsize_icon:h,u_texture_icon:1}),sn=(t,e,i)=>({u_matrix:t,u_opacity:e,u_color:i}),on=(e,i,n,r,s)=>t.extend(function(t,e,i){const n=e.imageManager.getPattern(t.toString()),{width:r,height:s}=e.imageManager.getPixelSize(),o=Math.pow(2,i.tileID.overscaledZ),a=i.tileSize*Math.pow(2,e.transform.tileZoom)/o,l=a*(i.tileID.canonical.x+i.tileID.wrap*o),c=a*i.tileID.canonical.y;return{u_image:0,u_pattern_tl:n.tl,u_pattern_br:n.br,u_texsize:[r,s],u_pattern_size:n.displaySize,u_tile_units_to_pixels:1/P(i,1,e.transform.tileZoom),u_pixel_coord_upper:[l>>16,c>>16],u_pixel_coord_lower:[65535&l,65535&c]}}(r,n,s),{u_matrix:e,u_opacity:i}),an={fillExtrusion:e=>({u_matrix:new t.UniformMatrix4f(e),u_lightpos:new t.Uniform3f(e),u_lightintensity:new t.Uniform1f(e),u_lightcolor:new t.Uniform3f(e),u_vertical_gradient:new t.Uniform1f(e),u_opacity:new t.Uniform1f(e),u_edge_radius:new t.Uniform1f(e),u_ao:new t.Uniform2f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_up_dir:new t.Uniform3f(e),u_height_lift:new t.Uniform1f(e)}),fillExtrusionPattern:e=>({u_matrix:new t.UniformMatrix4f(e),u_lightpos:new t.Uniform3f(e),u_lightintensity:new t.Uniform1f(e),u_lightcolor:new t.Uniform3f(e),u_vertical_gradient:new t.Uniform1f(e),u_height_factor:new t.Uniform1f(e),u_edge_radius:new t.Uniform1f(e),u_ao:new t.Uniform2f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_up_dir:new t.Uniform3f(e),u_height_lift:new t.Uniform1f(e),u_image:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_pixel_coord_upper:new t.Uniform2f(e),u_pixel_coord_lower:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e),u_opacity:new t.Uniform1f(e)}),fill:e=>({u_matrix:new t.UniformMatrix4f(e)}),fillPattern:e=>({u_matrix:new t.UniformMatrix4f(e),u_image:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_pixel_coord_upper:new t.Uniform2f(e),u_pixel_coord_lower:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e)}),fillOutline:e=>({u_matrix:new t.UniformMatrix4f(e),u_world:new t.Uniform2f(e)}),fillOutlinePattern:e=>({u_matrix:new t.UniformMatrix4f(e),u_world:new t.Uniform2f(e),u_image:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_pixel_coord_upper:new t.Uniform2f(e),u_pixel_coord_lower:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e)}),circle:e=>({u_camera_to_center_distance:new t.Uniform1f(e),u_extrude_scale:new t.UniformMatrix2f(e),u_device_pixel_ratio:new t.Uniform1f(e),u_matrix:new t.UniformMatrix4f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_up_dir:new t.Uniform3f(e)}),collisionBox:e=>({u_matrix:new t.UniformMatrix4f(e),u_camera_to_center_distance:new t.Uniform1f(e),u_extrude_scale:new t.Uniform2f(e)}),collisionCircle:e=>({u_matrix:new t.UniformMatrix4f(e),u_inv_matrix:new t.UniformMatrix4f(e),u_camera_to_center_distance:new t.Uniform1f(e),u_viewport_size:new t.Uniform2f(e)}),debug:e=>({u_color:new t.UniformColor(e),u_matrix:new t.UniformMatrix4f(e),u_overlay:new t.Uniform1i(e),u_overlay_scale:new t.Uniform1f(e)}),clippingMask:e=>({u_matrix:new t.UniformMatrix4f(e)}),heatmap:e=>({u_extrude_scale:new t.Uniform1f(e),u_intensity:new t.Uniform1f(e),u_matrix:new t.UniformMatrix4f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_up_dir:new t.Uniform3f(e)}),heatmapTexture:e=>({u_image:new t.Uniform1i(e),u_color_ramp:new t.Uniform1i(e),u_opacity:new t.Uniform1f(e)}),hillshade:e=>({u_matrix:new t.UniformMatrix4f(e),u_image:new t.Uniform1i(e),u_latrange:new t.Uniform2f(e),u_light:new t.Uniform2f(e),u_shadow:new t.UniformColor(e),u_highlight:new t.UniformColor(e),u_accent:new t.UniformColor(e)}),hillshadePrepare:e=>({u_matrix:new t.UniformMatrix4f(e),u_image:new t.Uniform1i(e),u_dimension:new t.Uniform2f(e),u_zoom:new t.Uniform1f(e),u_unpack:new t.Uniform4f(e)}),line:e=>({u_matrix:new t.UniformMatrix4f(e),u_pixels_to_tile_units:new t.UniformMatrix2f(e),u_device_pixel_ratio:new t.Uniform1f(e),u_units_to_pixels:new t.Uniform2f(e),u_dash_image:new t.Uniform1i(e),u_gradient_image:new t.Uniform1i(e),u_image_height:new t.Uniform1f(e),u_texsize:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e),u_alpha_discard_threshold:new t.Uniform1f(e),u_trim_offset:new t.Uniform2f(e)}),linePattern:e=>({u_matrix:new t.UniformMatrix4f(e),u_texsize:new t.Uniform2f(e),u_pixels_to_tile_units:new t.UniformMatrix2f(e),u_device_pixel_ratio:new t.Uniform1f(e),u_image:new t.Uniform1i(e),u_units_to_pixels:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e),u_alpha_discard_threshold:new t.Uniform1f(e)}),raster:e=>({u_matrix:new t.UniformMatrix4f(e),u_tl_parent:new t.Uniform2f(e),u_scale_parent:new t.Uniform1f(e),u_fade_t:new t.Uniform1f(e),u_opacity:new t.Uniform1f(e),u_image0:new t.Uniform1i(e),u_image1:new t.Uniform1i(e),u_brightness_low:new t.Uniform1f(e),u_brightness_high:new t.Uniform1f(e),u_saturation_factor:new t.Uniform1f(e),u_contrast_factor:new t.Uniform1f(e),u_spin_weights:new t.Uniform3f(e),u_perspective_transform:new t.Uniform2f(e)}),symbolIcon:e=>({u_is_size_zoom_constant:new t.Uniform1i(e),u_is_size_feature_constant:new t.Uniform1i(e),u_size_t:new t.Uniform1f(e),u_size:new t.Uniform1f(e),u_camera_to_center_distance:new t.Uniform1f(e),u_rotate_symbol:new t.Uniform1i(e),u_aspect_ratio:new t.Uniform1f(e),u_fade_change:new t.Uniform1f(e),u_matrix:new t.UniformMatrix4f(e),u_label_plane_matrix:new t.UniformMatrix4f(e),u_coord_matrix:new t.UniformMatrix4f(e),u_is_text:new t.Uniform1i(e),u_pitch_with_map:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_camera_forward:new t.Uniform3f(e),u_tile_matrix:new t.UniformMatrix4f(e),u_up_vector:new t.Uniform3f(e),u_ecef_origin:new t.Uniform3f(e),u_texture:new t.Uniform1i(e)}),symbolSDF:e=>({u_is_size_zoom_constant:new t.Uniform1i(e),u_is_size_feature_constant:new t.Uniform1i(e),u_size_t:new t.Uniform1f(e),u_size:new t.Uniform1f(e),u_camera_to_center_distance:new t.Uniform1f(e),u_rotate_symbol:new t.Uniform1i(e),u_aspect_ratio:new t.Uniform1f(e),u_fade_change:new t.Uniform1f(e),u_matrix:new t.UniformMatrix4f(e),u_label_plane_matrix:new t.UniformMatrix4f(e),u_coord_matrix:new t.UniformMatrix4f(e),u_is_text:new t.Uniform1i(e),u_pitch_with_map:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_texture:new t.Uniform1i(e),u_gamma_scale:new t.Uniform1f(e),u_device_pixel_ratio:new t.Uniform1f(e),u_tile_id:new t.Uniform3f(e),u_zoom_transition:new t.Uniform1f(e),u_inv_rot_matrix:new t.UniformMatrix4f(e),u_merc_center:new t.Uniform2f(e),u_camera_forward:new t.Uniform3f(e),u_tile_matrix:new t.UniformMatrix4f(e),u_up_vector:new t.Uniform3f(e),u_ecef_origin:new t.Uniform3f(e),u_is_halo:new t.Uniform1i(e)}),symbolTextAndIcon:e=>({u_is_size_zoom_constant:new t.Uniform1i(e),u_is_size_feature_constant:new t.Uniform1i(e),u_size_t:new t.Uniform1f(e),u_size:new t.Uniform1f(e),u_camera_to_center_distance:new t.Uniform1f(e),u_rotate_symbol:new t.Uniform1i(e),u_aspect_ratio:new t.Uniform1f(e),u_fade_change:new t.Uniform1f(e),u_matrix:new t.UniformMatrix4f(e),u_label_plane_matrix:new t.UniformMatrix4f(e),u_coord_matrix:new t.UniformMatrix4f(e),u_is_text:new t.Uniform1i(e),u_pitch_with_map:new t.Uniform1i(e),u_texsize:new t.Uniform2f(e),u_texsize_icon:new t.Uniform2f(e),u_texture:new t.Uniform1i(e),u_texture_icon:new t.Uniform1i(e),u_gamma_scale:new t.Uniform1f(e),u_device_pixel_ratio:new t.Uniform1f(e),u_is_halo:new t.Uniform1i(e)}),background:e=>({u_matrix:new t.UniformMatrix4f(e),u_opacity:new t.Uniform1f(e),u_color:new t.UniformColor(e)}),backgroundPattern:e=>({u_matrix:new t.UniformMatrix4f(e),u_opacity:new t.Uniform1f(e),u_image:new t.Uniform1i(e),u_pattern_tl:new t.Uniform2f(e),u_pattern_br:new t.Uniform2f(e),u_texsize:new t.Uniform2f(e),u_pattern_size:new t.Uniform2f(e),u_pixel_coord_upper:new t.Uniform2f(e),u_pixel_coord_lower:new t.Uniform2f(e),u_tile_units_to_pixels:new t.Uniform1f(e)}),terrainRaster:_i,terrainDepth:_i,skybox:e=>({u_matrix:new t.UniformMatrix4f(e),u_sun_direction:new t.Uniform3f(e),u_cubemap:new t.Uniform1i(e),u_opacity:new t.Uniform1f(e),u_temporal_offset:new t.Uniform1f(e)}),skyboxGradient:e=>({u_matrix:new t.UniformMatrix4f(e),u_color_ramp:new t.Uniform1i(e),u_center_direction:new t.Uniform3f(e),u_radius:new t.Uniform1f(e),u_opacity:new t.Uniform1f(e),u_temporal_offset:new t.Uniform1f(e)}),skyboxCapture:e=>({u_matrix_3f:new t.UniformMatrix3f(e),u_sun_direction:new t.Uniform3f(e),u_sun_intensity:new t.Uniform1f(e),u_color_tint_r:new t.Uniform4f(e),u_color_tint_m:new t.Uniform4f(e),u_luminance:new t.Uniform1f(e)}),globeRaster:e=>({u_proj_matrix:new t.UniformMatrix4f(e),u_globe_matrix:new t.UniformMatrix4f(e),u_normalize_matrix:new t.UniformMatrix4f(e),u_merc_matrix:new t.UniformMatrix4f(e),u_zoom_transition:new t.Uniform1f(e),u_merc_center:new t.Uniform2f(e),u_image0:new t.Uniform1i(e),u_grid_matrix:new t.UniformMatrix3f(e),u_skirt_height:new t.Uniform1f(e),u_frustum_tl:new t.Uniform3f(e),u_frustum_tr:new t.Uniform3f(e),u_frustum_br:new t.Uniform3f(e),u_frustum_bl:new t.Uniform3f(e),u_globe_pos:new t.Uniform3f(e),u_globe_radius:new t.Uniform1f(e),u_viewport:new t.Uniform2f(e)}),globeAtmosphere:e=>({u_frustum_tl:new t.Uniform3f(e),u_frustum_tr:new t.Uniform3f(e),u_frustum_br:new t.Uniform3f(e),u_frustum_bl:new t.Uniform3f(e),u_horizon:new t.Uniform1f(e),u_transition:new t.Uniform1f(e),u_fadeout_range:new t.Uniform1f(e),u_color:new t.Uniform4f(e),u_high_color:new t.Uniform4f(e),u_space_color:new t.Uniform4f(e),u_star_intensity:new t.Uniform1f(e),u_star_density:new t.Uniform1f(e),u_star_size:new t.Uniform1f(e),u_temporal_offset:new t.Uniform1f(e),u_horizon_angle:new t.Uniform1f(e),u_rotation_matrix:new t.UniformMatrix4f(e)})};let ln;function cn(e,i,n,r,s,o,a){const l=e.context,c=l.gl,h=e.transform,u=e.useProgram("collisionBox"),d=[];let p=0,f=0;for(let m=0;m<r.length;m++){const g=r[m],_=i.getTile(g),y=_.getBucket(n);if(!y)continue;const v=ye(g,y,h);let x=v;0===s[0]&&0===s[1]||(x=e.translatePosMatrix(v,_,s,o));const b=a?y.textCollisionBox:y.iconCollisionBox,w=y.collisionCircleArray;if(w.length>0){const e=t.create(),i=x;t.mul(e,y.placementInvProjMatrix,h.glCoordMatrix),t.mul(e,e,y.placementViewportMatrix),d.push({circleArray:w,circleOffset:f,transform:i,invTransform:e,projection:y.getProjection()}),p+=w.length/4,f=p}b&&(e.terrain&&e.terrain.setupElevationDraw(_,u),u.draw(l,c.LINES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,ji(x,h,_,y.getProjection()),n.id,b.layoutVertexBuffer,b.indexBuffer,b.segments,null,h.zoom,null,[b.collisionVertexBuffer,b.collisionVertexBufferExt]))}if(!a||!d.length)return;const m=e.useProgram("collisionCircle"),g=new t.StructArrayLayout2f1f2i16;g.resize(4*p),g._trim();let _=0;for(const t of d)for(let e=0;e<t.circleArray.length/4;e++){const i=4*e,n=t.circleArray[i+0],r=t.circleArray[i+1],s=t.circleArray[i+2],o=t.circleArray[i+3];g.emplace(_++,n,r,s,o,0),g.emplace(_++,n,r,s,o,1),g.emplace(_++,n,r,s,o,2),g.emplace(_++,n,r,s,o,3)}(!ln||ln.length<2*p)&&(ln=function(e){const i=2*e,n=new t.StructArrayLayout3ui6;n.resize(i),n._trim();for(let t=0;t<i;t++){const e=6*t;n.uint16[e+0]=4*t+0,n.uint16[e+1]=4*t+1,n.uint16[e+2]=4*t+2,n.uint16[e+3]=4*t+2,n.uint16[e+4]=4*t+3,n.uint16[e+5]=4*t+0}return n}(p));const y=l.createIndexBuffer(ln,!0),v=l.createVertexBuffer(g,t.collisionCircleLayout.members,!0);for(const i of d){const r={u_matrix:i.transform,u_inv_matrix:i.invTransform,u_camera_to_center_distance:(x=h).getCameraToCenterDistance(i.projection),u_viewport_size:[x.width,x.height]};m.draw(l,c.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,r,n.id,v,y,t.SegmentVector.simpleSegment(0,2*i.circleOffset,i.circleArray.length,i.circleArray.length/2),null,h.zoom)}var x;v.destroy(),y.destroy()}const hn=t.create();function un({width:e,height:i,anchor:n,textOffset:r,textScale:s},o){const{horizontalAlign:a,verticalAlign:l}=t.getAnchorAlignment(n),c=-(a-.5)*e,h=-(l-.5)*i,u=t.evaluateVariableOffset(n,r);return new t.Point((c/s+u[0])*o,(h/s+u[1])*o)}function dn(e,i,n,r,s,o,a,l,c,h,u){const d=e.text.placedSymbolArray,p=e.text.dynamicLayoutVertexArray,f=e.icon.dynamicLayoutVertexArray,m={},g=e.getProjection(),_=ve(l,g,o),y=o.elevation,v=g.upVectorScale(l.canonical,o.center.lat,o.worldSize).metersToTile;p.clear();for(let f=0;f<d.length;f++){const x=d.get(f),{tileAnchorX:b,tileAnchorY:w,numGlyphs:A}=x,T=x.hidden||!x.crossTileID||e.allowVerticalPlacement&&!x.placedOrientation?null:r[x.crossTileID];if(T){let r=0,d=0,f=0;if(y){const t=y?y.getAtTileOffset(l,b,w):0,[e,i,n]=g.upVector(l.canonical,b,w);r=t*e*v,d=t*i*v,f=t*n*v}let[M,S,E,C]=ne(x.projectedAnchorX+r,x.projectedAnchorY+d,x.projectedAnchorZ+f,n?_:a);const I=re(o.getCameraToCenterDistance(g),C);let P=s.evaluateSizeForFeature(e.textSizeData,h,x)*I/t.ONE_EM;n&&(P*=e.tilePixelRatio/c);const L=un(T,P);n?(({x:M,y:S,z:E}=g.projectTilePoint(b+L.x,w+L.y,l.canonical)),[M,S,E]=ne(M+r,S+d,E+f,a)):(i&&L._rotate(-o.angle),M+=L.x,S+=L.y,E=0);const R=e.allowVerticalPlacement&&x.placedOrientation===t.WritingMode.vertical?Math.PI/2:0;for(let e=0;e<A;e++)t.addDynamicAttributes(p,M,S,E,R);u&&x.associatedIconIndex>=0&&(m[x.associatedIconIndex]={x:M,y:S,z:E,angle:R})}else pe(A,p)}if(u){f.clear();const i=e.icon.placedSymbolArray;for(let e=0;e<i.length;e++){const n=i.get(e),{numGlyphs:r}=n,s=m[e];if(n.hidden||!s)pe(r,f);else{const{x:e,y:i,z:n,angle:o}=s;for(let s=0;s<r;s++)t.addDynamicAttributes(f,e,i,n,o)}}e.icon.dynamicLayoutVertexBuffer.updateData(f)}e.text.dynamicLayoutVertexBuffer.updateData(p)}function pn(t,e,i){return i.iconsInText&&e?"symbolTextAndIcon":t?"symbolSDF":"symbolIcon"}function fn(e,i,n,r,s,o,a,l,c,h,u,d){const p=e.context,f=p.gl,m=e.transform,g="map"===l,_="map"===c,y=g&&"point"!==n.layout.get("symbol-placement"),v=g&&!_&&!y,x=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let b=!1;const w=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),A=[t.mercatorXfromLng(m.center.lng),t.mercatorYfromLat(m.center.lat)],T=n.layout.get("text-variable-anchor"),M="globe"===m.projection.name,S=[],E=[0,-1,0];let C=E;!M&&!m.mercatorFromTransition||g||(C=function(e){const i=e._camera.getWorldToCamera(e.worldSize,1),n=t.multiply([],i,e.globeMatrix);t.invert(n,n);const r=[0,0,0],s=[0,1,0,0];return t.transformMat4$1(s,s,n),r[0]=s[0],r[1]=s[1],r[2]=s[2],t.normalize(r,r),r}(m));for(const l of r){const r=i.getTile(l),c=r.getBucket(n);if(!c)continue;if("mercator"===c.projection.name&&M)continue;const u=s?c.text:c.icon;if(!u||c.fullyClipped||!u.segments.get().length)continue;const d=u.programConfigurations.get(n.id),p=s||c.sdfIcons,w=s?c.textSizeData:c.iconSizeData,I=_||0!==m.pitch,P=t.evaluateSizeForZoom(w,m.zoom);let L,R,B,D,O=[0,0],k=null;if(s)R=r.glyphAtlasTexture,B=f.LINEAR,L=r.glyphAtlasTexture.size,c.iconsInText&&(O=r.imageAtlasTexture.size,k=r.imageAtlasTexture,D=I||e.options.rotating||e.options.zooming||"composite"===w.kind||"camera"===w.kind?f.LINEAR:f.NEAREST);else{const t=1!==n.layout.get("icon-size").constantOr(0)||c.iconsNeedLinear;R=r.imageAtlasTexture,B=p||e.options.rotating||e.options.zooming||t||I?f.LINEAR:f.NEAREST,L=r.imageAtlasTexture.size}const F="globe"===c.projection.name,z=F?C:E,N=F?t.globeToMercatorTransition(m.zoom):0,U=ve(l,c.getProjection(),m),G=m.calculatePixelsToTileUnitsMatrix(r),V=te(U,r.tileID.canonical,_,g,m,c.getProjection(),G),j=e.terrain&&_&&y?t.invert(t.create(),V):hn,H=ie(U,r.tileID.canonical,_,g,m,c.getProjection(),G),W=T&&c.hasTextData(),q="none"!==n.layout.get("icon-text-fit")&&W&&c.hasIconData();if(y){const t=m.elevation,i=t?t.getAtTileOffsetFunc(l,m.center.lat,m.worldSize,c.getProjection()):null,n=ee(U,r.tileID.canonical,_,g,m,c.getProjection(),G);oe(c,U,e,s,n,H,_,h,i,l)}const X=y||s&&T||q,Z=e.translatePosMatrix(U,r,o,a),J=X?hn:V,Y=e.translatePosMatrix(H,r,o,a,!0),$=c.getProjection().createInversionMatrix(m,l.canonical),K=[];e.terrainRenderModeElevated()&&_&&K.push("PITCH_WITH_MAP_TERRAIN"),F&&K.push("PROJECTION_GLOBE_VIEW"),X&&K.push("PROJECTED_POS_ON_VIEWPORT");const Q=p&&0!==n.paint.get(s?"text-halo-width":"icon-halo-width").constantOr(1);let tt;tt=p?c.iconsInText?rn(w.kind,P,v,_,e,Z,J,Y,L,O,l,N,A,$,z,c.getProjection()):nn(w.kind,P,v,_,e,Z,J,Y,s,L,!0,l,N,A,$,z,c.getProjection()):en(w.kind,P,v,_,e,Z,J,Y,s,L,l,N,A,$,z,c.getProjection());const et={program:e.useProgram(pn(p,s,c),d,K),buffers:u,uniformValues:tt,atlasTexture:R,atlasTextureIcon:k,atlasInterpolation:B,atlasInterpolationIcon:D,isSDF:p,hasHalo:Q,tile:r,labelPlaneMatrixInv:j};if(x&&c.canOverlap){b=!0;const e=u.segments.get();for(const i of e)S.push({segments:new t.SegmentVector([i]),sortKey:i.sortKey,state:et})}else S.push({segments:u.segments,sortKey:0,state:et})}b&&S.sort(((t,e)=>t.sortKey-e.sortKey));for(const t of S){const i=t.state;if(e.terrain&&e.terrain.setupElevationDraw(i.tile,i.program,{useDepthForOcclusion:!M,labelPlaneMatrixInv:i.labelPlaneMatrixInv}),p.activeTexture.set(f.TEXTURE0),i.atlasTexture.bind(i.atlasInterpolation,f.CLAMP_TO_EDGE),i.atlasTextureIcon&&(p.activeTexture.set(f.TEXTURE1),i.atlasTextureIcon&&i.atlasTextureIcon.bind(i.atlasInterpolationIcon,f.CLAMP_TO_EDGE)),i.isSDF){const r=i.uniformValues;i.hasHalo&&(r.u_is_halo=1,mn(i.buffers,t.segments,n,e,i.program,w,u,d,r)),r.u_is_halo=0}mn(i.buffers,t.segments,n,e,i.program,w,u,d,i.uniformValues)}}function mn(e,i,n,r,s,o,a,l,c){const h=r.context,u=[e.dynamicLayoutVertexBuffer,e.opacityVertexBuffer,e.globeExtVertexBuffer];s.draw(h,h.gl.TRIANGLES,o,a,l,t.CullFaceMode.disabled,c,n.id,e.layoutVertexBuffer,e.indexBuffer,i,n.paint,r.transform.zoom,e.programConfigurations.get(n.id),u)}function gn(e,i,n,r,s,o,a){const l=e.context.gl,c=n.paint.get("fill-pattern"),h=c&&c.constantOr(1);let u,d,p,f,m;a?(d=h&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",u=l.LINES):(d=h?"fillPattern":"fill",u=l.TRIANGLES);for(const g of r){const r=i.getTile(g);if(h&&!r.patternsLoaded())continue;const _=r.getBucket(n);if(!_)continue;e.prepareDrawTile();const y=_.programConfigurations.get(n.id),v=e.useProgram(d,y);h&&(e.context.activeTexture.set(l.TEXTURE0),r.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),y.updatePaintBuffers());const x=c.constantOr(null);if(x&&r.imageAtlas){const t=r.imageAtlas.patternPositions[x.toString()];t&&y.setConstantPatternPositions(t)}const b=e.translatePosMatrix(g.projMatrix,r,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor"));if(a){f=_.indexBuffer2,m=_.segments2;const t=e.terrain&&e.terrain.renderingToTexture?e.terrain.drapeBufferSize:[l.drawingBufferWidth,l.drawingBufferHeight];p="fillOutlinePattern"===d&&h?Ni(b,e,r,t):zi(b,t)}else f=_.indexBuffer,m=_.segments,p=h?Fi(b,e,r):ki(b);e.prepareDrawProgram(e.context,v,g.toUnwrapped()),v.draw(e.context,u,s,e.stencilModeForClipping(g),o,t.CullFaceMode.disabled,p,n.id,_.layoutVertexBuffer,f,m,n.paint,e.transform.zoom,y)}}function _n(e,i,n,r,s,o,a){const l=e.context,c=l.gl,h=e.transform,u=n.paint.get("fill-extrusion-pattern"),d=u.constantOr(1),p=n.paint.get("fill-extrusion-opacity"),f=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),n.paint.get("fill-extrusion-ambient-occlusion-radius")],m=n.layout.get("fill-extrusion-edge-radius"),g=m>0&&!n.paint.get("fill-extrusion-rounded-roof"),_=g?0:m,y="globe"===h.projection.name?t.fillExtrusionHeightLift():0,v="globe"===h.projection.name,x=v?t.globeToMercatorTransition(h.zoom):0,b=[t.mercatorXfromLng(h.center.lng),t.mercatorYfromLat(h.center.lat)],w=[];v&&w.push("PROJECTION_GLOBE_VIEW"),f[0]>0&&w.push("FAUX_AO"),g&&w.push("ZERO_ROOF_RADIUS");for(const m of r){const r=i.getTile(m),g=r.getBucket(n);if(!g||g.projection.name!==h.projection.name)continue;const A=g.programConfigurations.get(n.id),T=e.useProgram(d?"fillExtrusionPattern":"fillExtrusion",A,w);if(e.terrain){const t=e.terrain;if(e.style.terrainSetForDrapingOnly())t.setupElevationDraw(r,T,{useMeterToDem:!0});else{if(!g.enableTerrain)continue;if(t.setupElevationDraw(r,T,{useMeterToDem:!0}),yn(l,i,m,g,n,t),!g.centroidVertexBuffer){const t=T.attributes.a_centroid_pos;void 0!==t&&c.vertexAttrib2f(t,0,0)}}}d&&(e.context.activeTexture.set(c.TEXTURE0),r.imageAtlasTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),A.updatePaintBuffers());const M=u.constantOr(null);if(M&&r.imageAtlas){const t=r.imageAtlas.patternPositions[M.toString()];t&&A.setConstantPatternPositions(t)}const S=e.translatePosMatrix(m.projMatrix,r,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),E=h.projection.createInversionMatrix(h,m.canonical),C=n.paint.get("fill-extrusion-vertical-gradient"),I=d?Oi(S,e,C,p,f,_,m,r,y,x,b,E):Di(S,e,C,p,f,_,m,y,x,b,E);e.prepareDrawProgram(l,T,m.toUnwrapped());const P=[];e.terrain&&P.push(g.centroidVertexBuffer),v&&P.push(g.layoutVertexExtBuffer),T.draw(l,l.gl.TRIANGLES,s,o,a,t.CullFaceMode.backCCW,I,n.id,g.layoutVertexBuffer,g.indexBuffer,g.segments,n.paint,e.transform.zoom,A,P)}}function yn(e,i,n,r,s,o){const a=[e=>{let i=e.canonical.x-1,n=e.wrap;return i<0&&(i=(1<<e.canonical.z)-1,n--),new t.OverscaledTileID(e.overscaledZ,n,e.canonical.z,i,e.canonical.y)},e=>{let i=e.canonical.x+1,n=e.wrap;return i===1<<e.canonical.z&&(i=0,n++),new t.OverscaledTileID(e.overscaledZ,n,e.canonical.z,i,e.canonical.y)},e=>new t.OverscaledTileID(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,(0===e.canonical.y?1<<e.canonical.z:e.canonical.y)-1),e=>new t.OverscaledTileID(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y===(1<<e.canonical.z)-1?0:e.canonical.y+1)],l=t=>{const e=i.getSource().minzoom,n=t=>{const e=i.getTileByID(t);if(e&&e.hasData())return e.getBucket(s)},r=[0,-1,1];for(const i of r){if(t.overscaledZ+i<e)continue;const r=n(t.calculateScaledKey(t.overscaledZ+i));if(r)return r}},c=[0,0,0],h=(e,i)=>(c[0]=Math.min(e.min.y,i.min.y),c[1]=Math.max(e.max.y,i.max.y),c[2]=t.EXTENT-i.min.x>e.max.x?i.min.x-t.EXTENT:e.max.x,c),u=(e,i)=>(c[0]=Math.min(e.min.x,i.min.x),c[1]=Math.max(e.max.x,i.max.x),c[2]=t.EXTENT-i.min.y>e.max.y?i.min.y-t.EXTENT:e.max.y,c),d=[(t,e)=>h(t,e),(t,e)=>h(e,t),(t,e)=>u(t,e),(t,e)=>u(e,t)],p=new t.Point(0,0);let f,m,g;const _=(e,i,r,s,a)=>{const l=[[s?r:e,s?e:r,0],[s?r:i,s?i:r,0]],c=a<0?t.EXTENT+a:a,h=[s?c:(e+i)/2,s?(e+i)/2:c,0];return 0===r&&a<0||0!==r&&a>0?o.getForTilePoints(g,[h],!0,m):l.push(h),o.getForTilePoints(n,l,!0,f),Math.max(l[0][2],l[1][2],h[2])/o.exaggeration()};for(let e=0;e<4;e++){const i=(e<2?1:5)-e,s=r.borders[e];if(0===s.length)continue;const c=g=a[e](n),h=l(c);if(!(h&&h instanceof t.FillExtrusionBucket&&h.enableTerrain))continue;if(r.borderDoneWithNeighborZ[e]===h.canonical.z&&h.borderDoneWithNeighborZ[i]===r.canonical.z)continue;if(m=o.findDEMTileFor(c),!m||!m.dem)continue;if(!f){const t=o.findDEMTileFor(n);if(!t||!t.dem)return;f=t}const u=h.borders[i];let y=0;const v=h.borderDoneWithNeighborZ[i]!==r.canonical.z;if(r.canonical.z===h.canonical.z){for(let n=0;n<s.length;n++){const o=r.featuresOnBorder[s[n]],a=o.borders[e];let l;for(;y<u.length&&(l=h.featuresOnBorder[u[y]],!(l.borders[i][1]>a[0]+3));)v&&h.encodeCentroid(void 0,l,!1),y++;if(l&&y<u.length){const n=y;let s=0;for(;!(l.borders[i][0]>a[1]-3)&&(s++,++y!==u.length);)l=h.featuresOnBorder[u[y]];if(l=h.featuresOnBorder[u[n]],o.intersectsCount()>1||l.intersectsCount()>1||1!==s){1!==s&&(y=n),r.encodeCentroid(void 0,o,!1),v&&h.encodeCentroid(void 0,l,!1);continue}const c=d[e](o,l),f=e%2?t.EXTENT-1:0;p.x=_(c[0],Math.min(t.EXTENT-1,c[1]),f,e<2,c[2]),p.y=0,r.encodeCentroid(p,o,!1),v&&h.encodeCentroid(p,l,!1)}else r.encodeCentroid(void 0,o,!1)}r.borderDoneWithNeighborZ[e]=h.canonical.z,r.needsCentroidUpdate=!0,v&&(h.borderDoneWithNeighborZ[i]=r.canonical.z,h.needsCentroidUpdate=!0)}else{for(const t of s)r.encodeCentroid(void 0,r.featuresOnBorder[t],!1);if(v){for(const t of u)h.encodeCentroid(void 0,h.featuresOnBorder[t],!1);h.borderDoneWithNeighborZ[i]=r.canonical.z,h.needsCentroidUpdate=!0}r.borderDoneWithNeighborZ[e]=h.canonical.z,r.needsCentroidUpdate=!0}}(r.needsCentroidUpdate||!r.centroidVertexBuffer&&0!==r.centroidVertexArray.length)&&r.uploadCentroid(e)}const vn=new t.Color(1,0,0,1),xn=new t.Color(0,1,0,1),bn=new t.Color(0,0,1,1),wn=new t.Color(1,0,1,1),An=new t.Color(0,1,1,1);function Tn(e,i,n){const r=e.context,s=e.transform,o=r.gl,a="globe"===s.projection.name,l=a?["PROJECTION_GLOBE_VIEW"]:null;let c=n.projMatrix;if(a&&t.globeToMercatorTransition(s.zoom)>0){const e=t.transitionTileAABBinECEF(n.canonical,s),i=t.globeDenormalizeECEF(e);c=t.multiply(new Float32Array(16),s.globeMatrix,i),t.multiply(c,s.projMatrix,c)}const h=e.useProgram("debug",null,l),u=i.getTileByID(n.key);e.terrain&&e.terrain.setupElevationDraw(u,h);const d=t.DepthMode.disabled,p=t.StencilMode.disabled,f=e.colorModeForRenderPass(),m="$debug";r.activeTexture.set(o.TEXTURE0),e.emptyTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE),a?u._makeGlobeTileDebugBuffers(e.context,s):u._makeDebugTileBoundsBuffers(e.context,s.projection);const g=u._tileDebugBuffer||e.debugBuffer,_=u._tileDebugIndexBuffer||e.debugIndexBuffer,y=u._tileDebugSegments||e.debugSegments;h.draw(r,o.LINE_STRIP,d,p,f,t.CullFaceMode.disabled,Hi(c,t.Color.red),m,g,_,y,null,null,null,[u._globeTileDebugBorderBuffer]);const v=u.latestRawTileData,x=Math.floor((v&&v.byteLength||0)/1024),b=i.getTile(n).tileSize,w=512/Math.min(b,512)*(n.overscaledZ/s.zoom)*.5;let A=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(A+=` => ${n.overscaledZ}`),A+=` ${x}kb`,function(t,e){t.initDebugOverlayCanvas();const i=t.debugOverlayCanvas,n=t.context.gl,r=t.debugOverlayCanvas.getContext("2d");r.clearRect(0,0,i.width,i.height),r.shadowColor="white",r.shadowBlur=2,r.lineWidth=1.5,r.strokeStyle="white",r.textBaseline="top",r.font="bold 36px Open Sans, sans-serif",r.fillText(e,5,5),r.strokeText(e,5,5),t.debugOverlayTexture.update(i),t.debugOverlayTexture.bind(n.LINEAR,n.CLAMP_TO_EDGE)}(e,A);const T=u._tileDebugTextBuffer||e.debugBuffer,M=u._tileDebugTextIndexBuffer||e.quadTriangleIndexBuffer,S=u._tileDebugTextSegments||e.debugSegments;h.draw(r,o.TRIANGLES,d,p,t.ColorMode.alphaBlended,t.CullFaceMode.disabled,Hi(c,t.Color.transparent,w),m,T,M,S,null,null,null,[u._globeTileDebugTextBuffer])}function Mn(t,e,i,n){En(t,0,e+i/2,t.transform.width,i,n)}function Sn(t,e,i,n){En(t,e-i/2,0,i,t.transform.height,n)}function En(e,i,n,r,s,o){const a=e.context,l=a.gl;l.enable(l.SCISSOR_TEST),l.scissor(i*t.exported.devicePixelRatio,n*t.exported.devicePixelRatio,r*t.exported.devicePixelRatio,s*t.exported.devicePixelRatio),a.clear({color:o}),l.disable(l.SCISSOR_TEST)}const Cn=t.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:In}=Cn;function Pn(t,e,i,n){t.emplaceBack(e,i,n)}class Ln{constructor(e){this.vertexArray=new t.StructArrayLayout3f12,this.indices=new t.StructArrayLayout3ui6,Pn(this.vertexArray,-1,-1,1),Pn(this.vertexArray,1,-1,1),Pn(this.vertexArray,-1,1,1),Pn(this.vertexArray,1,1,1),Pn(this.vertexArray,-1,-1,-1),Pn(this.vertexArray,1,-1,-1),Pn(this.vertexArray,-1,1,-1),Pn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=e.createVertexBuffer(this.vertexArray,In),this.indexBuffer=e.createIndexBuffer(this.indices),this.segment=t.SegmentVector.simpleSegment(0,0,36,12)}}function Rn(e,i,n,r,s,o){const a=e.gl,l=i.paint.get("sky-atmosphere-color"),c=i.paint.get("sky-atmosphere-halo-color"),h=i.paint.get("sky-atmosphere-sun-intensity"),u=((t,e,i,n,r)=>({u_matrix_3f:t,u_sun_direction:e,u_sun_intensity:i,u_color_tint_r:[n.r,n.g,n.b,n.a],u_color_tint_m:[r.r,r.g,r.b,r.a],u_luminance:5e-5}))(t.fromMat4(t.create$1(),r),s,h,l,c);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+o,i.skyboxTexture,0),n.draw(e,a.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,t.ColorMode.unblended,t.CullFaceMode.frontCW,u,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}const Bn=t.createLayout([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Dn{constructor(e){const i=new t.StructArrayLayout5f20;i.emplaceBack(-1,1,1,0,0),i.emplaceBack(1,1,1,1,0),i.emplaceBack(1,-1,1,1,1),i.emplaceBack(-1,-1,1,0,1);const n=new t.StructArrayLayout3ui6;n.emplaceBack(0,1,2),n.emplaceBack(2,3,0),this.vertexBuffer=e.createVertexBuffer(i,Bn.members),this.indexBuffer=e.createIndexBuffer(n),this.segments=t.SegmentVector.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const On={symbol:function(e,i,n,r,s){if("translucent"!==e.renderPass)return;const o=t.StencilMode.disabled,a=e.colorModeForRenderPass();n.layout.get("text-variable-anchor")&&function(e,i,n,r,s,o,a){const l=i.transform,c="map"===s,h="map"===o;for(const i of e){const e=r.getTile(i),s=e.getBucket(n);if(!s||!s.text||!s.text.segments.get().length)continue;const o=t.evaluateSizeForZoom(s.textSizeData,l.zoom),u=ve(i,s.getProjection(),l),d=l.calculatePixelsToTileUnitsMatrix(e),p=te(u,e.tileID.canonical,h,c,l,s.getProjection(),d),f="none"!==n.layout.get("icon-text-fit")&&s.hasIconData();if(o){const n=Math.pow(2,l.zoom-e.tileID.overscaledZ);dn(s,c,h,a,t.symbolSize,l,p,i,n,o,f)}}}(r,e,n,i,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),s),0!==n.paint.get("icon-opacity").constantOr(1)&&fn(e,i,n,r,!1,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),n.layout.get("icon-rotation-alignment"),n.layout.get("icon-pitch-alignment"),n.layout.get("icon-keep-upright"),o,a),0!==n.paint.get("text-opacity").constantOr(1)&&fn(e,i,n,r,!0,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),n.layout.get("text-keep-upright"),o,a),i.map.showCollisionBoxes&&(cn(e,i,n,r,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),cn(e,i,n,r,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(e,i,n,r){if("translucent"!==e.renderPass)return;const s=n.paint.get("circle-opacity"),o=n.paint.get("circle-stroke-width"),a=n.paint.get("circle-stroke-opacity"),l=void 0!==n.layout.get("circle-sort-key").constantOr(1);if(0===s.constantOr(1)&&(0===o.constantOr(1)||0===a.constantOr(1)))return;const c=e.context,h=c.gl,u=e.transform,d=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),p=t.StencilMode.disabled,f=e.colorModeForRenderPass(),m="globe"===u.projection.name,g=[t.mercatorXfromLng(u.center.lng),t.mercatorYfromLat(u.center.lat)],_=[];for(let s=0;s<r.length;s++){const o=r[s],a=i.getTile(o),c=a.getBucket(n);if(!c||c.projection.name!==u.projection.name)continue;const h=c.programConfigurations.get(n.id),d=Vi(n);m&&d.push("PROJECTION_GLOBE_VIEW");const p=e.useProgram("circle",h,d),f=c.layoutVertexBuffer,y=c.globeExtVertexBuffer,v=c.indexBuffer,x=u.projection.createInversionMatrix(u,o.canonical),b={programConfiguration:h,program:p,layoutVertexBuffer:f,globeExtVertexBuffer:y,indexBuffer:v,uniformValues:Gi(e,o,a,x,g,n),tile:a};if(l){const e=c.segments.get();for(const i of e)_.push({segments:new t.SegmentVector([i]),sortKey:i.sortKey,state:b})}else _.push({segments:c.segments,sortKey:0,state:b})}l&&_.sort(((t,e)=>t.sortKey-e.sortKey));const y={useDepthForOcclusion:!m};for(const i of _){const{programConfiguration:r,program:s,layoutVertexBuffer:o,globeExtVertexBuffer:a,indexBuffer:l,uniformValues:m,tile:g}=i.state,_=i.segments;e.terrain&&e.terrain.setupElevationDraw(g,s,y),e.prepareDrawProgram(c,s,g.tileID.toUnwrapped()),s.draw(c,h.TRIANGLES,d,p,f,t.CullFaceMode.disabled,m,n.id,o,l,_,n.paint,u.zoom,r,[a])}},heatmap:function(e,i,n,r){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===e.renderPass){const s=e.context,o=s.gl,a=t.StencilMode.disabled,l=new t.ColorMode([o.ONE,o.ONE],t.Color.transparent,[!0,!0,!0,!0]);!function(t,e,i,n){const r=t.gl,s=e.width*n,o=e.height*n;t.activeTexture.set(r.TEXTURE1),t.viewport.set([0,0,s,o]);let a=i.heatmapFbo;if(!a||a&&(a.width!==s||a.height!==o)){a&&a.destroy();const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),a=i.heatmapFbo=t.createFramebuffer(s,o,!1),function(t,e,i,n,r,s){const o=t.gl;o.texImage2D(o.TEXTURE_2D,0,t.isWebGL2&&t.extRenderToTextureHalfFloat?o.RGBA16F:o.RGBA,r,s,0,o.RGBA,t.extRenderToTextureHalfFloat?t.isWebGL2?o.HALF_FLOAT:t.extTextureHalfFloat.HALF_FLOAT_OES:o.UNSIGNED_BYTE,null),n.colorAttachment.set(i)}(t,0,e,a,s,o)}else r.bindTexture(r.TEXTURE_2D,a.colorAttachment.get()),t.bindFramebuffer.set(a.framebuffer)}(s,e,n,"globe"===e.transform.projection.name?.5:.25),s.clear({color:t.Color.transparent});const c=e.transform,h="globe"===c.projection.name,u=h?["PROJECTION_GLOBE_VIEW"]:null,d=h?t.CullFaceMode.frontCCW:t.CullFaceMode.disabled,p=[t.mercatorXfromLng(c.center.lng),t.mercatorYfromLat(c.center.lat)];for(let f=0;f<r.length;f++){const m=r[f];if(i.hasRenderableParent(m))continue;const g=i.getTile(m),_=g.getBucket(n);if(!_||_.projection.name!==c.projection.name)continue;const y=_.programConfigurations.get(n.id),v=e.useProgram("heatmap",y,u),{zoom:x}=e.transform;e.terrain&&e.terrain.setupElevationDraw(g,v),e.prepareDrawProgram(s,v,m.toUnwrapped());const b=c.projection.createInversionMatrix(c,m.canonical);v.draw(s,o.TRIANGLES,t.DepthMode.disabled,a,l,d,qi(e,m,g,b,p,x,n.paint.get("heatmap-intensity")),n.id,_.layoutVertexBuffer,_.indexBuffer,_.segments,n.paint,e.transform.zoom,y,h?[_.globeExtVertexBuffer]:null)}s.viewport.set([0,0,e.width,e.height])}else"translucent"===e.renderPass&&(e.context.setColorMode(e.colorModeForRenderPass()),function(e,i){const n=e.context,r=n.gl,s=i.heatmapFbo;if(!s)return;n.activeTexture.set(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,s.colorAttachment.get()),n.activeTexture.set(r.TEXTURE1);let o=i.colorRampTexture;o||(o=i.colorRampTexture=new t.Texture(n,i.colorRamp,r.RGBA)),o.bind(r.LINEAR,r.CLAMP_TO_EDGE),e.useProgram("heatmapTexture").draw(n,r.TRIANGLES,t.DepthMode.disabled,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.disabled,((t,e,i,n)=>({u_image:0,u_color_ramp:1,u_opacity:e.paint.get("heatmap-opacity")}))(0,i),i.id,e.viewportBuffer,e.quadTriangleIndexBuffer,e.viewportSegments,i.paint,e.transform.zoom)}(e,n))},line:function(e,i,n,r){if("translucent"!==e.renderPass)return;const s=n.paint.get("line-opacity"),o=n.paint.get("line-width");if(0===s.constantOr(1)||0===o.constantOr(1))return;const a=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),l=e.colorModeForRenderPass(),c=e.terrain&&e.terrain.renderingToTexture?1:t.exported.devicePixelRatio,h=n.paint.get("line-dasharray"),u=h.constantOr(1),d=n.layout.get("line-cap"),p=n.paint.get("line-pattern"),f=p.constantOr(1),m=n.paint.get("line-gradient"),g=f?"linePattern":"line",_=e.context,y=_.gl,v=(t=>{const e=[];$i(t)&&e.push("RENDER_LINE_DASH"),t.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=t.paint.get("line-trim-offset");0===i[0]&&0===i[1]||e.push("RENDER_LINE_TRIM_OFFSET");const n=t.paint.get("line-pattern").constantOr(1),r=1!==t.paint.get("line-opacity").constantOr(1);return!n&&r&&e.push("RENDER_LINE_ALPHA_DISCARD"),e})(n);let x=v.includes("RENDER_LINE_ALPHA_DISCARD");e.terrain&&e.terrain.clipOrMaskOverlapStencilType()&&(x=!1);for(const s of r){const r=i.getTile(s);if(f&&!r.patternsLoaded())continue;const o=r.getBucket(n);if(!o)continue;e.prepareDrawTile();const b=o.programConfigurations.get(n.id),w=e.useProgram(g,b,v),A=p.constantOr(null);if(A&&r.imageAtlas){const t=r.imageAtlas.patternPositions[A.toString()];t&&b.setConstantPatternPositions(t)}const T=h.constantOr(null),M=d.constantOr(null);if(!f&&T&&M&&r.lineAtlas){const t=r.lineAtlas.getDash(T,M);t&&b.setConstantPatternPositions(t)}let[S,E]=n.paint.get("line-trim-offset");if("round"===M||"square"===M){const t=1;S!==E&&(0===S&&(S-=t),1===E&&(E+=t))}const C=e.terrain?s.projMatrix:null,I=f?Zi(e,r,n,C,c):Xi(e,r,n,C,o.lineClipsArray.length,c,[S,E]);if(m){const r=o.gradients[n.id];let a=r.texture;if(n.gradientVersion!==r.version){let l=256;if(n.stepInterpolant){const n=i.getSource().maxzoom,r=s.canonical.z===n?Math.ceil(1<<e.transform.maxZoom-s.canonical.z):1;l=t.clamp(t.nextPowerOfTwo(o.maxLineLength/t.EXTENT*1024*r),256,_.maxTextureSize)}r.gradient=t.renderColorRamp({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:l,image:r.gradient||void 0,clips:o.lineClipsArray}),r.texture?r.texture.update(r.gradient):r.texture=new t.Texture(_,r.gradient,y.RGBA),r.version=n.gradientVersion,a=r.texture}_.activeTexture.set(y.TEXTURE1),a.bind(n.stepInterpolant?y.NEAREST:y.LINEAR,y.CLAMP_TO_EDGE)}u&&(_.activeTexture.set(y.TEXTURE0),r.lineAtlasTexture.bind(y.LINEAR,y.REPEAT),b.updatePaintBuffers()),f&&(_.activeTexture.set(y.TEXTURE0),r.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),b.updatePaintBuffers()),e.prepareDrawProgram(_,w,s.toUnwrapped());const P=i=>{w.draw(_,y.TRIANGLES,a,i,l,t.CullFaceMode.disabled,I,n.id,o.layoutVertexBuffer,o.indexBuffer,o.segments,n.paint,e.transform.zoom,b,[o.layoutVertexBuffer2])};if(x){const i=e.stencilModeForClipping(s).ref;0===i&&e.terrain&&_.clear({stencil:0});const n={func:y.EQUAL,mask:255};I.u_alpha_discard_threshold=.8,P(new t.StencilMode(n,i,255,y.KEEP,y.KEEP,y.INVERT)),I.u_alpha_discard_threshold=0,P(new t.StencilMode(n,i,255,y.KEEP,y.KEEP,y.KEEP))}else P(e.stencilModeForClipping(s))}x&&(e.resetStencilClippingMasks(),e.terrain&&_.clear({stencil:0}))},fill:function(e,i,n,r){const s=n.paint.get("fill-color"),o=n.paint.get("fill-opacity");if(0===o.constantOr(1))return;const a=e.colorModeForRenderPass(),l=n.paint.get("fill-pattern"),c=e.opaquePassEnabledForLayer()&&!l.constantOr(1)&&1===s.constantOr(t.Color.transparent).a&&1===o.constantOr(0)?"opaque":"translucent";if(e.renderPass===c){const s=e.depthModeForSublayer(1,"opaque"===e.renderPass?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly);gn(e,i,n,r,s,a,!1)}if("translucent"===e.renderPass&&n.paint.get("fill-antialias")){const s=e.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,t.DepthMode.ReadOnly);gn(e,i,n,r,s,a,!0)}},"fill-extrusion":function(e,i,n,r){const s=n.paint.get("fill-extrusion-opacity");if(0!==s&&"translucent"===e.renderPass){const o=new t.DepthMode(e.context.gl.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D);if(1!==s||n.paint.get("fill-extrusion-pattern").constantOr(1))_n(e,i,n,r,o,t.StencilMode.disabled,t.ColorMode.disabled),_n(e,i,n,r,o,e.stencilModeFor3D(),e.colorModeForRenderPass()),e.resetStencilClippingMasks();else{const s=e.colorModeForRenderPass();_n(e,i,n,r,o,t.StencilMode.disabled,s)}}},hillshade:function(e,i,n,r){if("offscreen"!==e.renderPass&&"translucent"!==e.renderPass)return;const s=e.context,o=e.depthModeForSublayer(0,t.DepthMode.ReadOnly),a=e.colorModeForRenderPass(),l=e.terrain&&e.terrain.renderingToTexture,[c,h]="translucent"!==e.renderPass||l?[{},r]:e.stencilConfigForOverlap(r);for(const r of h){const s=i.getTile(r);if(s.needsHillshadePrepare&&"offscreen"===e.renderPass)gi(e,s,n,o,t.StencilMode.disabled,a);else if("translucent"===e.renderPass){const t=l&&e.terrain?e.terrain.stencilModeForRTTOverlap(r):c[r.overscaledZ];fi(e,r,s,n,o,t,a)}}s.viewport.set([0,0,e.width,e.height]),e.resetStencilClippingMasks()},raster:function(e,i,n,r,s,o){if("translucent"!==e.renderPass)return;if(0===n.paint.get("raster-opacity"))return;if(!r.length)return;const a=e.context,l=a.gl,c=i.getSource(),h=e.useProgram("raster"),u=e.colorModeForRenderPass(),d=e.terrain&&e.terrain.renderingToTexture,[p,f]=c instanceof Ct||d?[{},r]:e.stencilConfigForOverlap(r),m=f[f.length-1].overscaledZ,g=!e.options.moving;for(const r of f){const s=d?t.DepthMode.disabled:e.depthModeForSublayer(r.overscaledZ-m,1===n.paint.get("raster-opacity")?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly,l.LESS),f=r.toUnwrapped(),_=i.getTile(r);if(d&&(!_||!_.hasData()))continue;const y=d?r.projMatrix:e.transform.calculateProjMatrix(f,g),v=e.terrain&&d?e.terrain.stencilModeForRTTOverlap(r):p[r.overscaledZ],x=o?0:n.paint.get("raster-fade-duration");_.registerFadeDuration(x);const b=i.findLoadedParent(r,0),w=Si(_,b,i,e.transform,x);let A,T;e.terrain&&e.terrain.prepareDrawTile();const M="nearest"===n.paint.get("raster-resampling")?l.NEAREST:l.LINEAR;a.activeTexture.set(l.TEXTURE0),_.texture.bind(M,l.CLAMP_TO_EDGE),a.activeTexture.set(l.TEXTURE1),b?(b.texture.bind(M,l.CLAMP_TO_EDGE),A=Math.pow(2,b.tileID.overscaledZ-_.tileID.overscaledZ),T=[_.tileID.canonical.x*A%1,_.tileID.canonical.y*A%1]):_.texture.bind(M,l.CLAMP_TO_EDGE),_.texture.useMipmap&&a.extTextureFilterAnisotropic&&e.transform.pitch>20&&l.texParameterf(l.TEXTURE_2D,a.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a.extTextureFilterAnisotropicMax);const S=Ki(y,T||[0,0],A||1,w,n,c instanceof Ct?c.perspectiveTransform:[0,0]);if(e.prepareDrawProgram(a,h,f),c instanceof Ct)c.boundsBuffer&&c.boundsSegments&&h.draw(a,l.TRIANGLES,s,t.StencilMode.disabled,u,t.CullFaceMode.disabled,S,n.id,c.boundsBuffer,e.quadTriangleIndexBuffer,c.boundsSegments);else{const{tileBoundsBuffer:i,tileBoundsIndexBuffer:r,tileBoundsSegments:o}=e.getTileBoundsBuffers(_);h.draw(a,l.TRIANGLES,s,v,u,t.CullFaceMode.disabled,S,n.id,i,r,o)}}e.resetStencilClippingMasks()},background:function(e,i,n,r){const s=n.paint.get("background-color"),o=n.paint.get("background-opacity");if(0===o)return;const a=e.context,l=a.gl,c=e.transform,h=c.tileSize,u=n.paint.get("background-pattern");if(e.isPatternMissing(u))return;const d=!u&&1===s.a&&1===o&&e.opaquePassEnabledForLayer()?"opaque":"translucent";if(e.renderPass!==d)return;const p=t.StencilMode.disabled,f=e.depthModeForSublayer(0,"opaque"===d?t.DepthMode.ReadWrite:t.DepthMode.ReadOnly),m=e.colorModeForRenderPass(),g=e.useProgram(u?"backgroundPattern":"background");let _,y=r;y||(_=e.getBackgroundTiles(),y=Object.values(_).map((t=>t.tileID))),u&&(a.activeTexture.set(l.TEXTURE0),e.imageManager.bind(e.context));for(const d of y){const y=d.toUnwrapped(),v=r?d.projMatrix:e.transform.calculateProjMatrix(y);e.prepareDrawTile();const x=i?i.getTile(d):_?_[d.key]:new t.Tile(d,h,c.zoom,e),b=u?on(v,o,e,u,{tileID:d,tileSize:h}):sn(v,o,s);e.prepareDrawProgram(a,g,y);const{tileBoundsBuffer:w,tileBoundsIndexBuffer:A,tileBoundsSegments:T}=e.getTileBoundsBuffers(x);g.draw(a,l.TRIANGLES,f,p,m,t.CullFaceMode.disabled,b,n.id,w,A,T)}},sky:function(e,i,n){const r=e.transform,s="mercator"===r.projection.name||"globe"===r.projection.name?1:t.smoothstep(7,8,r.zoom),o=n.paint.get("sky-opacity")*s;if(0===o)return;const a=e.context,l=n.paint.get("sky-type"),c=new t.DepthMode(a.gl.LEQUAL,t.DepthMode.ReadOnly,[0,1]),h=e.frameCounter/1e3%1;"atmosphere"===l?"offscreen"===e.renderPass?n.needsSkyboxCapture(e)&&(function(e,i,n,r){const s=e.context,o=s.gl;let a=i.skyboxFbo;if(!a){a=i.skyboxFbo=s.createFramebuffer(32,32,!1),i.skyboxGeometry=new Ln(s),i.skyboxTexture=s.gl.createTexture(),o.bindTexture(o.TEXTURE_CUBE_MAP,i.skyboxTexture),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_CUBE_MAP,o.TEXTURE_MAG_FILTER,o.LINEAR);for(let t=0;t<6;++t)o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,o.RGBA,32,32,0,o.RGBA,o.UNSIGNED_BYTE,null)}s.bindFramebuffer.set(a.framebuffer),s.viewport.set([0,0,32,32]);const l=i.getCenter(e,!0),c=e.useProgram("skyboxCapture"),h=new Float64Array(16);t.identity(h),t.rotateY(h,h,.5*-Math.PI),Rn(s,i,c,h,l,0),t.identity(h),t.rotateY(h,h,.5*Math.PI),Rn(s,i,c,h,l,1),t.identity(h),t.rotateX(h,h,.5*-Math.PI),Rn(s,i,c,h,l,2),t.identity(h),t.rotateX(h,h,.5*Math.PI),Rn(s,i,c,h,l,3),t.identity(h),Rn(s,i,c,h,l,4),t.identity(h),t.rotateY(h,h,Math.PI),Rn(s,i,c,h,l,5),s.viewport.set([0,0,e.width,e.height])}(e,n),n.markSkyboxValid(e)):"sky"===e.renderPass&&function(e,i,n,r,s){const o=e.context,a=o.gl,l=e.transform,c=e.useProgram("skybox");o.activeTexture.set(a.TEXTURE0),a.bindTexture(a.TEXTURE_CUBE_MAP,i.skyboxTexture);const h=((t,e,i,n,r)=>({u_matrix:t,u_sun_direction:e,u_cubemap:0,u_opacity:n,u_temporal_offset:r}))(l.skyboxMatrix,i.getCenter(e,!1),0,r,s);e.prepareDrawProgram(o,c),c.draw(o,a.TRIANGLES,n,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.backCW,h,"skybox",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}(e,n,c,o,h):"gradient"===l&&"sky"===e.renderPass&&function(e,i,n,r,s){const o=e.context,a=o.gl,l=e.transform,c=e.useProgram("skyboxGradient");i.skyboxGeometry||(i.skyboxGeometry=new Ln(o)),o.activeTexture.set(a.TEXTURE0);let h=i.colorRampTexture;h||(h=i.colorRampTexture=new t.Texture(o,i.colorRamp,a.RGBA)),h.bind(a.LINEAR,a.CLAMP_TO_EDGE);const u=((e,i,n,r,s)=>({u_matrix:e,u_color_ramp:0,u_center_direction:i,u_radius:t.degToRad(n),u_opacity:r,u_temporal_offset:s}))(l.skyboxMatrix,i.getCenter(e,!1),i.paint.get("sky-gradient-radius"),r,s);e.prepareDrawProgram(o,c),c.draw(o,a.TRIANGLES,n,t.StencilMode.disabled,e.colorModeForRenderPass(),t.CullFaceMode.backCW,u,"skyboxGradient",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment)}(e,n,c,o,h)},debug:function(t,e,i){for(let n=0;n<i.length;n++)Tn(t,e,i[n])},custom:function(e,i,n,r){const s=e.context,o=n.implementation;if(!e.transform.projection.unsupportedLayers||!e.transform.projection.unsupportedLayers.includes("custom")||e.terrain&&(e.terrain.renderingToTexture||"offscreen"===e.renderPass)&&n.isLayerDraped()){if("offscreen"===e.renderPass){const i=o.prerender;if(i){if(e.setCustomLayerDefaults(),s.setColorMode(e.colorModeForRenderPass()),"globe"===e.transform.projection.name){const n=e.transform.pointMerc;i.call(o,s.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),t.globeToMercatorTransition(e.transform.zoom),[n.x,n.y],e.transform.pixelsPerMeterRatio)}else i.call(o,s.gl,e.transform.customLayerMatrix());s.setDirty(),e.setBaseState()}}else if("translucent"===e.renderPass){if(e.terrain&&e.terrain.renderingToTexture){const i=o.renderToTile;if(i){const n=r[0].canonical,a=new t.MercatorCoordinate(n.x+r[0].wrap*(1<<n.z),n.y,n.z);s.setDepthMode(t.DepthMode.disabled),s.setStencilMode(t.StencilMode.disabled),s.setColorMode(e.colorModeForRenderPass()),e.setCustomLayerDefaults(),i.call(o,s.gl,a),s.setDirty(),e.setBaseState()}return}e.setCustomLayerDefaults(),s.setColorMode(e.colorModeForRenderPass()),s.setStencilMode(t.StencilMode.disabled);const i="3d"===o.renderingMode?new t.DepthMode(e.context.gl.LEQUAL,t.DepthMode.ReadWrite,e.depthRangeFor3D):e.depthModeForSublayer(0,t.DepthMode.ReadOnly);if(s.setDepthMode(i),"globe"===e.transform.projection.name){const i=e.transform.pointMerc;o.render(s.gl,e.transform.customLayerMatrix(),e.transform.getProjection(),e.transform.globeToMercatorMatrix(),t.globeToMercatorTransition(e.transform.zoom),[i.x,i.y],e.transform.pixelsPerMeterRatio)}else o.render(s.gl,e.transform.customLayerMatrix());s.setDirty(),e.setBaseState(),s.bindFramebuffer.set(null)}}else t.warnOnce("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")}};class kn{constructor(e,i,n=!1){this.context=new Tt(e,n),this.transform=i,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=t.SourceCache.maxUnderzooming+t.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={}}updateTerrain(t,e){const i=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(i||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Pi(this,t));const n=this._terrain;this.transform.elevation=i?n:null,n.update(t,this.transform,e)}_updateFog(t){const e=t.fog;if(!e||"globe"===this.transform.projection.name||e.getOpacity(this.transform.pitch)<1||e.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[i,n]=e.getFovAdjustedRange(this.transform._fov);if(i>n)return void(this.transform.fogCullDistSq=null);const r=i+.78*(n-i);this.transform.fogCullDistSq=r*r}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}resize(e,i){if(this.width=e*t.exported.devicePixelRatio,this.height=i*t.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const t of this.style.order)this.style._layers[t].resize()}setup(){const e=this.context,i=new t.StructArrayLayout2i4;i.emplaceBack(0,0),i.emplaceBack(t.EXTENT,0),i.emplaceBack(0,t.EXTENT),i.emplaceBack(t.EXTENT,t.EXTENT),this.tileExtentBuffer=e.createVertexBuffer(i,t.posAttributes.members),this.tileExtentSegments=t.SegmentVector.simpleSegment(0,0,4,2);const n=new t.StructArrayLayout2i4;n.emplaceBack(0,0),n.emplaceBack(t.EXTENT,0),n.emplaceBack(0,t.EXTENT),n.emplaceBack(t.EXTENT,t.EXTENT),this.debugBuffer=e.createVertexBuffer(n,t.posAttributes.members),this.debugSegments=t.SegmentVector.simpleSegment(0,0,4,5);const r=new t.StructArrayLayout2i4;r.emplaceBack(-1,-1),r.emplaceBack(1,-1),r.emplaceBack(-1,1),r.emplaceBack(1,1),this.viewportBuffer=e.createVertexBuffer(r,t.posAttributes.members),this.viewportSegments=t.SegmentVector.simpleSegment(0,0,4,2);const s=new t.StructArrayLayout4i8;s.emplaceBack(0,0,0,0),s.emplaceBack(t.EXTENT,0,t.EXTENT,0),s.emplaceBack(0,t.EXTENT,0,t.EXTENT),s.emplaceBack(t.EXTENT,t.EXTENT,t.EXTENT,t.EXTENT),this.mercatorBoundsBuffer=e.createVertexBuffer(s,t.boundsAttributes.members),this.mercatorBoundsSegments=t.SegmentVector.simpleSegment(0,0,4,2);const o=new t.StructArrayLayout3ui6;o.emplaceBack(0,1,2),o.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=e.createIndexBuffer(o);const a=new t.StructArrayLayout1ui2;for(const t of[0,1,3,2,0])a.emplaceBack(t);this.debugIndexBuffer=e.createIndexBuffer(a),this.emptyTexture=new t.Texture(e,new t.RGBAImage({width:1,height:1},Uint8Array.of(0,0,0,0)),e.gl.RGBA),this.identityMat=t.create();const l=this.context.gl;this.stencilClearMode=new t.StencilMode({func:l.ALWAYS,mask:0},0,255,l.ZERO,l.ZERO,l.ZERO),this.loadTimeStamps.push(t.window.performance.now()),this.atmosphereBuffer=new Dn(this.context)}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const e=this.context,i=e.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(e,i.TRIANGLES,t.DepthMode.disabled,this.stencilClearMode,t.ColorMode.disabled,t.CullFaceMode.disabled,Mi(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(e,i,n){if(!i||this.currentStencilSource===i.id||!e.isTileClipped()||!n||0===n.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let t=!1;for(const e of n)if(void 0===this._tileClippingMaskIDs[e.key]){t=!0;break}if(!t)return}this.currentStencilSource=i.id;const r=this.context,s=r.gl;this.nextStencilID+n.length>256&&this.clearStencil(),r.setColorMode(t.ColorMode.disabled),r.setDepthMode(t.DepthMode.disabled);const o=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const e of n){const n=i.getTile(e),a=this._tileClippingMaskIDs[e.key]=this.nextStencilID++,{tileBoundsBuffer:l,tileBoundsIndexBuffer:c,tileBoundsSegments:h}=this.getTileBoundsBuffers(n);o.draw(r,s.TRIANGLES,t.DepthMode.disabled,new t.StencilMode({func:s.ALWAYS,mask:0},a,255,s.KEEP,s.KEEP,s.REPLACE),t.ColorMode.disabled,t.CullFaceMode.disabled,Mi(e.projMatrix),"$clipping",l,c,h)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const e=this.nextStencilID++,i=this.context.gl;return new t.StencilMode({func:i.NOTEQUAL,mask:255},e,255,i.KEEP,i.KEEP,i.REPLACE)}stencilModeForClipping(e){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(e);const i=this.context.gl;return new t.StencilMode({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[e.key],0,i.KEEP,i.KEEP,i.REPLACE)}stencilConfigForOverlap(e){const i=this.context.gl,n=e.sort(((t,e)=>e.overscaledZ-t.overscaledZ)),r=n[n.length-1].overscaledZ,s=n[0].overscaledZ-r+1;if(s>1){this.currentStencilSource=void 0,this.nextStencilID+s>256&&this.clearStencil();const e={};for(let n=0;n<s;n++)e[n+r]=new t.StencilMode({func:i.GEQUAL,mask:255},n+this.nextStencilID,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID+=s,[e,n]}return[{[r]:t.StencilMode.disabled},n]}colorModeForRenderPass(){const e=this.context.gl;if(this._showOverdrawInspector){const i=1/8;return new t.ColorMode([e.CONSTANT_COLOR,e.ONE],new t.Color(i,i,i,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?t.ColorMode.unblended:t.ColorMode.alphaBlended}depthModeForSublayer(e,i,n){if(!this.opaquePassEnabledForLayer())return t.DepthMode.disabled;const r=1-((1+this.currentLayer)*this.numSublayers+e)*this.depthEpsilon;return new t.DepthMode(n||this.context.gl.LEQUAL,i,[r,r])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(e,i){this.style=e,this.options=i,this.imageManager=e.imageManager,this.glyphManager=e.glyphManager,this.symbolFadeChange=e.placement.symbolFadeChange(t.exported.now()),this.imageManager.beginFrame();const n=this.style.order,r=this.style._sourceCaches;for(const t in r){const e=r[t];e.used&&e.prepare(this.context)}const s={},o={},a={};for(const t in r){const e=r[t];s[t]=e.getVisibleCoordinates(),o[t]=s[t].slice().reverse(),a[t]=e.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let t=0;t<n.length;t++)if(this.style._layers[n[t]].is3D()){this.opaquePassCutoff=t;break}if(this.terrain&&(this.terrain.updateTileBinding(a),this.opaquePassCutoff=0),"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new t.GlobeSharedBuffers(this.context)),!t.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const t of n){const i=this.style._layers[t],n=e._getLayerSourceCache(i);if(!i.hasOffscreenPass()||i.isHidden(this.transform.zoom))continue;const r=n?o[n.id]:void 0;("custom"===i.type||i.isSky()||r&&r.length)&&this.renderLayer(this,n,i,r)}this.depthRangeFor3D=[0,1-(e.order.length+2)*this.numSublayers*this.depthEpsilon];const l=this.terrain;if(l&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&l.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]),this.context.clear({color:i.showOverdrawInspector?t.Color.black:t.Color.transparent,depth:1}),this.clearStencil(),this._showOverdrawInspector=i.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=n.length-1;this.currentLayer>=0;this.currentLayer--){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);if(t.isSky())continue;const r=i?o[i.id]:void 0;this._renderTileClippingMasks(t,i,r),this.renderLayer(this,i,t,r)}if(this.style.fog&&this.transform.projection.supportsFog&&function(e,i){const n=e.context,r=n.gl,s=e.transform,o=new t.DepthMode(r.LEQUAL,t.DepthMode.ReadOnly,[0,1]),a=e.useProgram("globeAtmosphere",null,"globe"===s.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"]),l=t.globeToMercatorTransition(s.zoom),c=i.properties.get("color").toArray01(),h=i.properties.get("high-color").toArray01(),u=i.properties.get("space-color").toArray01PremultipliedAlpha(),d=t.identity$1([]);t.rotateY$1(d,d,-t.degToRad(s._center.lng)),t.rotateX$1(d,d,t.degToRad(s._center.lat)),t.rotateZ$1(d,d,s.angle),t.rotateX$1(d,d,-s._pitch);const p=t.fromQuat(new Float32Array(16),d),f=t.mapValue(i.properties.get("star-intensity"),0,1,0,.25),m=5e-4,g=t.mapValue(i.properties.get("horizon-blend"),0,1,m,.25),_=t.globeUseCustomAntiAliasing(e,n,s)&&g===m?s.worldSize/(2*Math.PI*1.025)-1:s.globeRadius,y=e.frameCounter/1e3%1,v=t.length(s.globeCenterInViewSpace),x=Math.sqrt(Math.pow(v,2)-Math.pow(_,2)),b=Math.acos(x/v),w=((e,i,n,r,s,o,a,l,c,h,u,d,p,f)=>({u_frustum_tl:e,u_frustum_tr:i,u_frustum_br:n,u_frustum_bl:r,u_horizon:s,u_transition:o,u_fadeout_range:a,u_color:l,u_high_color:c,u_space_color:h,u_star_intensity:u,u_star_size:5*t.exported.devicePixelRatio,u_star_density:0,u_temporal_offset:d,u_horizon_angle:p,u_rotation_matrix:f}))(s.frustumCorners.TL,s.frustumCorners.TR,s.frustumCorners.BR,s.frustumCorners.BL,s.frustumCorners.horizon,l,g,c,h,u,f,y,b,p);e.prepareDrawProgram(n,a);const A=e.atmosphereBuffer;A&&a.draw(n,r.TRIANGLES,o,t.StencilMode.disabled,t.ColorMode.alphaBlended,t.CullFaceMode.backCW,w,"skybox",A.vertexBuffer,A.indexBuffer,A.segments)}(this,this.style.fog),this.renderPass="sky",(t.globeToMercatorTransition(this.transform.zoom)>0||"globe"!==this.transform.projection.name)&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<n.length;this.currentLayer++){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);t.isSky()&&this.renderLayer(this,i,t,i?o[i.id]:void 0)}for(this.renderPass="translucent",this.currentLayer=0;this.currentLayer<n.length;){const t=this.style._layers[n[this.currentLayer]],i=e._getLayerSourceCache(t);if(t.isSky()){++this.currentLayer;continue}if(this.terrain&&this.style.isLayerDraped(t)){if(t.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue}const r=i?("symbol"===t.type?a:o)[i.id]:void 0;this._renderTileClippingMasks(t,i,i?s[i.id]:void 0),this.renderLayer(this,i,t,r),++this.currentLayer}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let i=null;t.values(this.style._layers).forEach((t=>{const n=e._getLayerSourceCache(t);n&&!t.isHidden(this.transform.zoom)&&(!i||i.getSource().maxzoom<n.getSource().maxzoom)&&(i=n)})),i&&this.options.showTileBoundaries&&On.debug(this,i,i.getVisibleCoordinates())}this.options.showPadding&&function(t){const e=t.transform.padding;Mn(t,t.transform.height-(e.top||0),3,vn),Mn(t,e.bottom||0,3,xn),Sn(t,e.left||0,3,bn),Sn(t,t.transform.width-(e.right||0),3,wn);const i=t.transform.centerPoint;!function(t,e,i,n){En(t,e-1,i-10,2,20,n),En(t,e-10,i-1,20,2,n)}(t,i.x,t.transform.height-i.y,An)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(t.window.performance.now()),this.saveCanvasCopy())}renderLayer(t,e,i,n){i.isHidden(this.transform.zoom)||("background"===i.type||"sky"===i.type||"custom"===i.type||n&&n.length)&&(this.id=i.id,this.gpuTimingStart(i),(!t.transform.projection.unsupportedLayers||!t.transform.projection.unsupportedLayers.includes(i.type)||t.terrain&&"custom"===i.type)&&On[i.type](t,e,i,n,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const e=this.context.extTimerQuery;let i=this.gpuTimers[t.id];i||(i=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:e.createQueryEXT()}),i.calls++,e.beginQueryEXT(e.TIME_ELAPSED_EXT,i.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,e=t.createQueryEXT();this.deferredRenderGpuTimeQueries.push(e),t.beginQueryEXT(t.TIME_ELAPSED_EXT,e)}}gpuTimingDeferredRenderEnd(){if(!this.options.gpuTimingDeferredRender)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}gpuTimingEnd(){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;t.endQueryEXT(t.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const e={};for(const i in t){const n=t[i],r=this.context.extTimerQuery,s=r.getQueryObjectEXT(n.query,r.QUERY_RESULT_EXT)/1e6;r.deleteQueryEXT(n.query),e[i]=s}return e}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const e=this.context.extTimerQuery;let i=0;for(const n of t)i+=e.getQueryObjectEXT(n,e.QUERY_RESULT_EXT)/1e6,e.deleteQueryEXT(n);return i}translatePosMatrix(e,i,n,r,s){if(!n[0]&&!n[1])return e;const o=s?"map"===r?this.transform.angle:0:"viewport"===r?-this.transform.angle:0;if(o){const t=Math.sin(o),e=Math.cos(o);n=[n[0]*e-n[1]*t,n[0]*t+n[1]*e]}const a=[s?n[0]:P(i,n[0],this.transform.zoom),s?n[1]:P(i,n[1],this.transform.zoom),0],l=new Float32Array(16);return t.translate(l,e,a),l}saveTileTexture(t){const e=this._tileTextures[t.size[0]];e?e.push(t):this._tileTextures[t.size[0]]=[t]}getTileTexture(t){const e=this._tileTextures[t];return e&&e.length>0?e.pop():null}isPatternMissing(t){return null===t||void 0!==t&&!this.imageManager.getPattern(t.toString())}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}currentGlobalDefines(){const t=this.terrain&&this.terrain.renderingToTexture,e=this.terrain&&0===this.terrain.exaggeration(),i=this.style&&this.style.fog,n=[];return this.terrainRenderModeElevated()&&n.push("TERRAIN"),"globe"===this.transform.projection.name&&n.push("GLOBE"),e&&n.push("ZERO_EXAGGERATION"),i&&!t&&0!==i.getOpacity(this.transform.pitch)&&n.push("FOG"),t&&n.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&n.push("OVERDRAW_INSPECTOR"),n}useProgram(t,e,i){this.cache=this.cache||{};const n=i||[],r=this.currentGlobalDefines().concat(n),s=Li.cacheKey(ci[t],t,r,e);return this.cache[s]||(this.cache[s]=new Li(this.context,t,ci[t],e,an[t],r)),this.cache[s]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=t.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new t.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this.atmosphereBuffer&&this.atmosphereBuffer.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}prepareDrawProgram(e,i,n){if(this.terrain&&this.terrain.renderingToTexture)return;const r=this.style.fog;if(r){const s=r.getOpacity(this.transform.pitch),o=((e,i,n,r,s,o,a,l,c,h,u)=>{const d=e.transform,p=i.properties.get("color").toArray01();p[3]=r;const f=e.frameCounter/1e3%1;return{u_fog_matrix:n?d.calculateFogTileMatrix(n):e.identityMat,u_fog_range:i.getFovAdjustedRange(d._fov),u_fog_color:p,u_fog_horizon_blend:i.properties.get("horizon-blend"),u_fog_temporal_offset:f,u_frustum_tl:s,u_frustum_tr:o,u_frustum_br:a,u_frustum_bl:l,u_globe_pos:c,u_globe_radius:h,u_viewport:u,u_globe_transition:t.globeToMercatorTransition(d.zoom),u_is_globe:+("globe"===d.projection.name)}})(this,r,n,s,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*t.exported.devicePixelRatio,this.transform.height*t.exported.devicePixelRatio]);i.setFogUniformValues(e,o)}}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,e=t.createTexture();return t.bindTexture(t.TEXTURE_2D,e),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),e}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&0!==t.getOpacity(this.transform.pitch)}getBackgroundTiles(){const e=this._backgroundTiles,i=this._backgroundTiles={},n=this.transform.coveringTiles({tileSize:512});for(const r of n)i[r.key]=e[r.key]||new t.Tile(r,512,this.transform.tileZoom,this);return i}clearBackgroundTiles(){this._backgroundTiles={}}}class Fn{constructor(t=0,e=0,i=0,n=0){if(isNaN(t)||t<0||isNaN(e)||e<0||isNaN(i)||i<0||isNaN(n)||n<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=e,this.left=i,this.right=n}interpolate(e,i,n){return null!=i.top&&null!=e.top&&(this.top=t.number(e.top,i.top,n)),null!=i.bottom&&null!=e.bottom&&(this.bottom=t.number(e.bottom,i.bottom,n)),null!=i.left&&null!=e.left&&(this.left=t.number(e.left,i.left,n)),null!=i.right&&null!=e.right&&(this.right=t.number(e.right,i.right,n)),this}getCenter(e,i){const n=t.clamp((this.left+e-this.right)/2,0,e),r=t.clamp((this.top+i-this.bottom)/2,0,i);return new t.Point(n,r)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Fn(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function zn(e,i){const n=t.getColumn(e,3);t.fromQuat(e,i),t.setColumn(e,3,n)}function Nn(e,i){const n=t.identity$1([]);return t.rotateZ$1(n,n,-i),t.rotateX$1(n,n,-e),n}function Un(e,i){const n=[e[0],e[1],0],r=[i[0],i[1],0];if(t.length(n)>=1e-15){const e=t.normalize([],n);t.scale$2(r,e,t.dot(r,e)),i[0]=r[0],i[1]=r[1]}const s=t.cross([],i,e);if(t.len(s)<1e-15)return null;const o=Math.atan2(-s[1],s[0]);return Nn(Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2]),o)}class Gn{constructor(t,e){this.position=t,this.orientation=e}get position(){return this._position}set position(e){if(e){const i=e instanceof t.MercatorCoordinate?e:new t.MercatorCoordinate(e[0],e[1],e[2]);this._renderWorldCopies&&(i.x=t.wrap(i.x,0,1)),this._position=i}else this._position=null}lookAtPoint(e,i){if(this.orientation=null,!this.position)return;const n=this.position,r=this._elevation?this._elevation.getAtPointOrZero(t.MercatorCoordinate.fromLngLat(e)):0,s=t.MercatorCoordinate.fromLngLat(e,r),o=[s.x-n.x,s.y-n.y,s.z-n.z];i||(i=[0,0,1]),i[2]=Math.abs(i[2]),this.orientation=Un(o,i)}setPitchBearing(e,i){this.orientation=Nn(t.degToRad(e),t.degToRad(-i))}}class Vn{constructor(e,i){this._transform=t.identity([]),this.orientation=i,this.position=e}get mercatorPosition(){const e=this.position;return new t.MercatorCoordinate(e[0],e[1],e[2])}get position(){const e=t.getColumn(this._transform,3);return[e[0],e[1],e[2]]}set position(e){var i;e&&t.setColumn(this._transform,3,[(i=e)[0],i[1],i[2],1])}get orientation(){return this._orientation}set orientation(e){this._orientation=e||t.identity$1([]),e&&zn(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),e=this.right();return{bearing:Math.atan2(-e[1],e[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,e){this._orientation=Nn(t,e),zn(this._transform,this._orientation)}forward(){const e=t.getColumn(this._transform,2);return[-e[0],-e[1],-e[2]]}up(){const e=t.getColumn(this._transform,1);return[-e[0],-e[1],-e[2]]}right(){const e=t.getColumn(this._transform,0);return[e[0],e[1],e[2]]}getCameraToWorld(e,i){const n=new Float64Array(16);return t.invert(n,this.getWorldToCamera(e,i)),n}getWorldToCameraPosition(e,i,n){const r=this.position;t.scale$2(r,r,-e);const s=new Float64Array(16);return t.fromScaling(s,[n,n,n]),t.translate(s,s,r),s[10]*=i,s}getWorldToCamera(e,i){const n=new Float64Array(16),r=new Float64Array(4),s=this.position;return t.conjugate(r,this._orientation),t.scale$2(s,s,-e),t.fromQuat(n,r),t.translate(n,n,s),n[1]*=-1,n[5]*=-1,n[9]*=-1,n[13]*=-1,n[8]*=i,n[9]*=i,n[10]*=i,n[11]*=i,n}getCameraToClipPerspective(e,i,n,r){const s=new Float64Array(16);return t.perspective(s,e,i,n,r),s}getDistanceToElevation(e,i=!1){const n=0===e?0:t.mercatorZfromAltitude(e,i?t.latFromMercatorY(this.position[1]):this.position[1]),r=this.forward();return(n-this.position[2])/r[2]}clone(){return new Vn([...this.position],[...this.orientation])}}function jn(e,i){const n=Wn(e.projection,e.zoom,e.width,e.height),r=function(e,i,n,r,s){const o=new t.LngLat(n.lng-180*qn,n.lat),a=new t.LngLat(n.lng+180*qn,n.lat),l=e.project(o.lng,o.lat),c=e.project(a.lng,a.lat),h=-Math.atan2(c.y-l.y,c.x-l.x),u=t.MercatorCoordinate.fromLngLat(n);u.y=t.clamp(u.y,-1+qn,1-qn);const d=u.toLngLat(),p=e.project(d.lng,d.lat),f=t.MercatorCoordinate.fromLngLat(d);f.x+=qn;const m=f.toLngLat(),g=e.project(m.lng,m.lat),_=Zn(g.x-p.x,g.y-p.y,h),y=t.MercatorCoordinate.fromLngLat(d);y.y+=qn;const v=y.toLngLat(),x=e.project(v.lng,v.lat),b=Zn(x.x-p.x,x.y-p.y,h),w=Math.abs(_.x)/Math.abs(b.y),A=t.identity([]);t.rotateZ(A,A,-h*(1-(s?0:r)));const T=t.identity([]);return t.scale(T,T,[1,1-(1-w)*r,1]),T[4]=-b.x/b.y*r,t.rotateZ(T,T,h),t.multiply(T,A,T),T}(e.projection,0,e.center,n,i),s=Hn(e);return t.scale(r,r,[s,s,1]),r}function Hn(e){const i=e.projection,n=Wn(e.projection,e.zoom,e.width,e.height),r=Xn(i,e.center),s=Xn(i,t.LngLat.convert(i.center));return Math.pow(2,r*n+(1-n)*s)}function Wn(e,i,n,r,s=1/0){const o=e.range;if(!o)return 0;const a=Math.min(s,Math.max(n,r)),l=Math.log(a/1024)/Math.LN2;return t.smoothstep(o[0]+l,o[1]+l,i)}const qn=1/4e4;function Xn(e,i){const n=t.clamp(i.lat,-t.MAX_MERCATOR_LATITUDE,t.MAX_MERCATOR_LATITUDE),r=new t.LngLat(i.lng-180*qn,n),s=new t.LngLat(i.lng+180*qn,n),o=e.project(r.lng,n),a=e.project(s.lng,n),l=t.MercatorCoordinate.fromLngLat(r),c=t.MercatorCoordinate.fromLngLat(s),h=a.x-o.x,u=a.y-o.y,d=c.x-l.x,p=c.y-l.y,f=Math.sqrt((d*d+p*p)/(h*h+u*u));return Math.log(f)/Math.LN2}function Zn(t,e,i){const n=Math.cos(i),r=Math.sin(i);return{x:t*n-e*r,y:t*r+e*n}}class Jn{constructor(e,i,n,r,s,o,a){this.tileSize=512,this._renderWorldCopies=void 0===s||s,this._minZoom=e||0,this._maxZoom=i||22,this._minPitch=null==n?0:n,this._maxPitch=null==r?60:r,this.setProjection(o),this.setMaxBounds(a),this.width=0,this.height=0,this._center=new t.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Fn,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new Vn,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._horizonShift=.1}clone(){const t=new Jn(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}updateElevation(t,e=!1){const i=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||i)&&this._updateCameraOnTerrain(),(t||i)&&this._constrainCamera(e),this._calcMatrices()}getProjection(){return t.pick(this.projection,["name","center","parallels"])}setProjection(i){this.projectionOptions=i||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=t.getProjection(this.projectionOptions);const r=!e(n,this.getProjection());return r&&this._calcMatrices(),this.mercatorFromTransition=!1,r}setMercatorFromTransition(){const e=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=t.getProjection({name:"mercator"});const i=e!==this.projection.name;return i&&this._calcMatrices(),i}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(t){void 0===t?t=!0:null===t&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return t.mercatorZfromAltitude(this.center.lat,this.cameraWorldSizeForFog)}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new t.Point(this.width,this.height)}get bearing(){return t.wrap(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(e){const i=-e*Math.PI/180;var n;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=(n=new t.ARRAY_TYPE(4),t.ARRAY_TYPE!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n),function(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);t[0]=n*l+s*a,t[1]=r*l+o*a,t[2]=n*-a+s*l,t[3]=r*-a+o*l}(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(e){const i=t.clamp(e,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=t.degToRad(e),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const e=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==e&&(this._unmodified=!1,this._setZoom(e),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}_updateCameraOnTerrain(){if(!this._elevation||!this._elevation.isDataAvailableAtPoint(this.locationCoordinate(this.center)))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const t=this._elevation;this._centerAltitude=t.getAtPointOrZero(this.locationCoordinate(this.center)),this._centerAltitudeValidForExaggeration=t.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const e=this._elevation,i=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],n=this.horizonLineFromTop();let r=0,s=0;for(let o=0;o<i.length;o++){const a=new t.Point(i[o][0]*this.width,n+i[o][1]*(this.height-n)),l=e.pointCoordinate(a);if(!l)continue;const c=1/Math.hypot(l[0]-this._camera.position[0],l[1]-this._camera.position[1]);r+=l[3]*c,s+=c}return 0===s?NaN:r/s}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const t=this._seaLevelZoom,e=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),i=this.pixelsPerMeter/this.worldSize*e,n=this._mercatorZfromZoom(t),r=this._mercatorZfromZoom(this._maxZoom),s=Math.max(n-i,r);this._setZoom(this._zoomFromMercatorZ(s))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(e){const i=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,e.toAltitude()));let n;n=e.z<this._camera.position[2]?[i.x,i.y,i.z]:[e.x,e.y,e.z];const r=t.length(t.sub([],this._camera.position,n));return t.clamp(this._zoomFromMercatorZ(r),this._minZoom,this._maxZoom)}setFreeCameraOptions(e){if(!this.height)return;if(!e.position&&!e.orientation)return;this._updateCameraState();let i=!1;if(e.orientation&&!t.exactEquals(e.orientation,this._camera.orientation)&&(i=this._setCameraOrientation(e.orientation)),e.position){const n=[e.position.x,e.position.y,e.position.z];t.exactEquals$1(n,this._camera.position)||(this._setCameraPosition(n),i=!0)}i&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const e=this._camera.position,i=new Gn;return i.position=new t.MercatorCoordinate(e[0],e[1],e[2]),i.orientation=this._camera.orientation,i._elevation=this.elevation,i._renderWorldCopies=this.renderWorldCopies,i}_setCameraOrientation(e){if(!t.length$1(e))return!1;t.normalize$1(e,e);const i=t.transformQuat([],[0,0,-1],e),n=t.transformQuat([],[0,-1,0],e);if(n[2]<0)return!1;const r=Un(i,n);return!!r&&(this._camera.orientation=r,!0)}_setCameraPosition(e){const i=this.zoomScale(this.minZoom)*this.tileSize,n=this.zoomScale(this.maxZoom)*this.tileSize,r=this.cameraToCenterDistance;e[2]=t.clamp(e[2],r/n,r/i),this._camera.position=e}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,e,i){this._unmodified=!1,this._edgeInsets.interpolate(t,e,i),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const e=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,e)}getVisibleUnwrappedCoordinates(e){const i=[new t.UnwrappedTileID(0,e)];if(this.renderWorldCopies){const n=this.pointCoordinate(new t.Point(0,0)),r=this.pointCoordinate(new t.Point(this.width,0)),s=this.pointCoordinate(new t.Point(this.width,this.height)),o=this.pointCoordinate(new t.Point(0,this.height)),a=Math.floor(Math.min(n.x,r.x,s.x,o.x)),l=Math.floor(Math.max(n.x,r.x,s.x,o.x)),c=1;for(let n=a-c;n<=l+c;n++)0!==n&&i.push(new t.UnwrappedTileID(n,e))}return i}coveringTiles(e){let i=this.coveringZoomLevel(e);const n=i,r=this.elevation&&!e.isTerrainDEM,s="mercator"===this.projection.name;if(void 0!==e.minzoom&&i<e.minzoom)return[];void 0!==e.maxzoom&&i>e.maxzoom&&(i=e.maxzoom);const o=this.locationCoordinate(this.center),a=this.center.lat,l=1<<i,c=[l*o.x,l*o.y,0],h="globe"===this.projection.name,u=!h,d=t.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,u),p=h?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),f=l*t.mercatorZfromAltitude(1,this.center.lat),m=this._camera.position[2]/t.mercatorZfromAltitude(1,this.center.lat),g=[l*p.x,l*p.y,m*(u?1:f)],_=this.cameraToCenterDistance/e.tileSize*(e.roundZoom?1:.502),y=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?i:0,v=e.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,x=e.isTerrainDEM?-v:this._elevation?this._elevation.getMinElevationBelowMSL():0,b=this.projection.isReprojectedInTileSpace?Hn(this):1,w=e=>{const i=1/4e4,n=new t.MercatorCoordinate(e.x+i,e.y,e.z),r=new t.MercatorCoordinate(e.x,e.y+i,e.z),s=e.toLngLat(),o=n.toLngLat(),a=r.toLngLat(),l=this.locationCoordinate(s),c=this.locationCoordinate(o),h=this.locationCoordinate(a),u=Math.hypot(c.x-l.x,c.y-l.y),d=Math.hypot(h.x-l.x,h.y-l.y);return Math.sqrt(u*d)*b/i},A=e=>{const i=v,n=x;return{aabb:t.tileAABB(this,l,0,0,0,e,n,i,this.projection),zoom:0,x:0,y:0,minZ:n,maxZ:i,wrap:e,fullyVisible:!1}},T=[];let M=[];const S=i,E=e.reparseOverscaled?n:i,C=t=>t*t,I=C((m-this._centerAltitude)*f),P=t=>{if(!this._elevation||!t.tileID||!s)return;const e=this._elevation.getMinMaxForTile(t.tileID),i=t.aabb;e?(i.min[2]=e.min,i.max[2]=e.max,i.center[2]=(i.min[2]+i.max[2])/2):(t.shouldSplit=L(t),t.shouldSplit||(i.min[2]=i.max[2]=i.center[2]=this._centerAltitude))},L=e=>{if(e.zoom<y)return!0;if(e.zoom===S)return!1;if(null!=e.shouldSplit)return e.shouldSplit;const i=e.aabb.distanceX(g),s=e.aabb.distanceY(g);let o=I,l=1;if(h){o=C(e.aabb.distanceZ(g));const i=Math.pow(2,e.zoom),n=t.latFromMercatorY((e.y+1)/i),r=t.latFromMercatorY(e.y/i),s=Math.min(Math.max(a,n),r),c=t.circumferenceAtLatitude(s)/t.circumferenceAtLatitude(a);if(l=s===a?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,c/this._mercatorScaleRatio),this.zoom<=t.GLOBE_ZOOM_THRESHOLD_MIN&&e.zoom===S-1&&c>=.9)return!0}else if(r&&(o=C(e.aabb.distanceZ(g)*f)),this.projection.isReprojectedInTileSpace&&n<=5){const i=Math.pow(2,e.zoom),n=w(new t.MercatorCoordinate((e.x+.5)/i,(e.y+.5)/i));l=n>.85?1:n}const c=i*i+s*s+o,u=C((1<<S-e.zoom)*_*l*((t,e)=>{if(e*C(.707)<t)return 1;const i=Math.sqrt(e/t);return i/(1.4144271570014144+(Math.pow(1.1,i-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(o,I),c));return c<u};if(this.renderWorldCopies)for(let t=1;t<=3;t++)T.push(A(-t)),T.push(A(t));for(T.push(A(0));T.length>0;){const n=T.pop(),o=n.x,a=n.y;let u=n.fullyVisible;if(!u){const t=n.aabb.intersects(d);if(0===t)continue;u=2===t}if(n.zoom!==S&&L(n))for(let e=0;e<4;e++){const i=(o<<1)+e%2,c=(a<<1)+(e>>1),d={aabb:s?n.aabb.quadrant(e):t.tileAABB(this,l,n.zoom+1,i,c,n.wrap,n.minZ,n.maxZ,this.projection),zoom:n.zoom+1,x:i,y:c,wrap:n.wrap,fullyVisible:u,tileID:void 0,shouldSplit:void 0,minZ:n.minZ,maxZ:n.maxZ};r&&!h&&(d.tileID=new t.OverscaledTileID(n.zoom+1===S?E:n.zoom+1,n.wrap,n.zoom+1,i,c),P(d)),T.push(d)}else{const r=n.zoom===S?E:n.zoom;if(e.minzoom&&e.minzoom>r)continue;const s=c[0]-(.5+o+(n.wrap<<n.zoom))*(1<<i-n.zoom),l=c[1]-.5-a,h=n.tileID?n.tileID:new t.OverscaledTileID(r,n.wrap,n.zoom,o,a);M.push({tileID:h,distanceSq:s*s+l*l})}}if(this.fogCullDistSq){const i=this.fogCullDistSq,n=this.horizonLineFromTop();M=M.filter((r=>{const s=[0,0,0,1],o=[t.EXTENT,t.EXTENT,0,1],a=this.calculateFogTileMatrix(r.tileID.toUnwrapped());t.transformMat4$1(s,s,a),t.transformMat4$1(o,o,a);const l=t.getAABBPointSquareDist(s,o);if(0===l)return!0;let c=!1;const h=this._elevation;if(h&&l>i&&0!==n){const i=this.calculateProjMatrix(r.tileID.toUnwrapped());let s;e.isTerrainDEM||(s=h.getMinMaxForTile(r.tileID)),s||(s={min:x,max:v});const o=t.furthestTileCorner(this.rotation),a=[o[0]*t.EXTENT,o[1]*t.EXTENT,s.max];t.transformMat4(a,a,i),c=(1-a[1])*this.height*.5<n}return l<i||c}))}return M.sort(((t,e)=>t.distanceSq-e.distanceSq)).map((t=>t.tileID))}resize(t,e){this.width=t,this.height=e,this.pixelsToGLUnits=[2/t,-2/e],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(e){const i=t.clamp(e.lat,-t.MAX_MERCATOR_LATITUDE,t.MAX_MERCATOR_LATITUDE),n=this.projection.project(e.lng,i);return new t.Point(n.x*this.worldSize,n.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/t.mercatorZfromAltitude(1,this.center.lat)/this.worldSize}setLocationAtPoint(e,i){let n,r;const s=this.centerPoint;if("globe"===this.projection.name){const t=this.worldSize;n=(i.x-s.x)/t,r=(i.y-s.y)/t}else{const t=this.pointCoordinate(i),e=this.pointCoordinate(s);n=t.x-e.x,r=t.y-e.y}const o=this.locationCoordinate(e);this.setLocation(new t.MercatorCoordinate(o.x-n,o.y-r))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(e,i){const n=i?t.mercatorZfromAltitude(i,e.lat):void 0,r=this.projection.project(e.lng,e.lat);return new t.MercatorCoordinate(r.x,r.y,n)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(e,i){const n=null!=i?i:this._centerAltitude,r=[e.x,e.y,0,1],s=[e.x,e.y,1,1];t.transformMat4$1(r,r,this.pixelMatrixInverse),t.transformMat4$1(s,s,this.pixelMatrixInverse);const o=s[3];t.scale$1(r,r,1/r[3]),t.scale$1(s,s,1/o);const a=r[2],l=s[2];return{p0:r,p1:s,t:a===l?0:(n-a)/(l-a)}}screenPointToMercatorRay(e){const i=[e.x,e.y,0,1],n=[e.x,e.y,1,1];return t.transformMat4$1(i,i,this.pixelMatrixInverse),t.transformMat4$1(n,n,this.pixelMatrixInverse),t.scale$1(i,i,1/i[3]),t.scale$1(n,n,1/n[3]),i[2]=t.mercatorZfromAltitude(i[2],this._center.lat)*this.worldSize,n[2]=t.mercatorZfromAltitude(n[2],this._center.lat)*this.worldSize,t.scale$1(i,i,1/this.worldSize),t.scale$1(n,n,1/this.worldSize),new t.Ray([i[0],i[1],i[2]],t.normalize([],t.sub([],n,i)))}rayIntersectionCoordinate(e){const{p0:i,p1:n,t:r}=e,s=t.mercatorZfromAltitude(i[2],this._center.lat),o=t.mercatorZfromAltitude(n[2],this._center.lat);return new t.MercatorCoordinate(t.number(i[0],n[0],r)/this.worldSize,t.number(i[1],n[1],r)/this.worldSize,t.number(s,o,r))}pointCoordinate(t,e=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,e)}pointCoordinate3D(e){if(!this.elevation)return this.pointCoordinate(e);let i=this.projection.pointCoordinate3D(this,e.x,e.y);if(i)return new t.MercatorCoordinate(i[0],i[1],i[2]);let n=0,r=this.horizonLineFromTop();if(e.y>r)return this.pointCoordinate(e);const s=.02*r,o=e.clone();for(let e=0;e<10&&r-n>s;e++){o.y=t.number(n,r,.66);const e=this.projection.pointCoordinate3D(this,o.x,o.y);e?(r=o.y,i=e):n=o.y}return i?new t.MercatorCoordinate(i[0],i[1],i[2]):this.pointCoordinate(e)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(e){if(e.y<0||e.y>this.height||e.x<0||e.x>this.width)return!1;if(this.elevation||this.zoom>=t.GLOBE_ZOOM_THRESHOLD_MAX)return!this.isPointAboveHorizon(e);const i=this.pointCoordinate(e);return i.y>=0&&i.y<=1}_coordinatePoint(e,i){const n=i&&this.elevation?this.elevation.getAtPointOrZero(e,this._centerAltitude):this._centerAltitude,r=[e.x*this.worldSize,e.y*this.worldSize,n+e.toAltitude(),1];return t.transformMat4$1(r,r,this.pixelMatrix),r[3]>0?new t.Point(r[0]/r[3],r[1]/r[3]):new t.Point(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:e,left:i}=this._edgeInsets,n=this.height-this._edgeInsets.bottom,r=this.width-this._edgeInsets.right,s=this.pointLocation3D(new t.Point(i,e)),o=this.pointLocation3D(new t.Point(r,e)),a=this.pointLocation3D(new t.Point(r,n)),l=this.pointLocation3D(new t.Point(i,n));let c=Math.min(s.lng,o.lng,a.lng,l.lng),h=Math.max(s.lng,o.lng,a.lng,l.lng),u=Math.min(s.lat,o.lat,a.lat,l.lat),d=Math.max(s.lat,o.lat,a.lat,l.lat);const p=Math.pow(2,-this.zoom)/16*270,f="globe"===this.projection.name?1:4,m=(e,i,n,r,s)=>{const o=(e+n)/2,a=(i+r)/2,l=new t.Point(o,a),{lng:g,lat:_}=this.pointLocation3D(l),y=Math.max(0,c-g,u-_,g-h,_-d);c=Math.min(c,g),h=Math.max(h,g),u=Math.min(u,_),d=Math.max(d,_),(s<f||y>p)&&(m(e,i,o,a,s+1),m(o,a,n,r,s+1))};if(m(i,e,r,e,1),m(r,e,r,n,1),m(r,n,i,n,1),m(i,n,i,e,1),"globe"===this.projection.name){const[e,i]=t.polesInViewport(this);e?(d=90,h=180,c=-180):i&&(u=-90,h=180,c=-180)}return new t.LngLatBounds(new t.LngLat(c,u),new t.LngLat(h,d))}_getBoundsRectangular(e,i){const{top:n,left:r}=this._edgeInsets,s=this.height-this._edgeInsets.bottom,o=this.width-this._edgeInsets.right,a=new t.Point(r,n),l=new t.Point(o,n),c=new t.Point(o,s),h=new t.Point(r,s);let u=this.pointCoordinate(a,e),d=this.pointCoordinate(l,e);const p=this.pointCoordinate(c,i),f=this.pointCoordinate(h,i),m=(t,e)=>(e.y-t.y)/(e.x-t.x);return u.y>1&&d.y>=0?u=new t.MercatorCoordinate((1-f.y)/m(f,u)+f.x,1):u.y<0&&d.y<=1&&(u=new t.MercatorCoordinate(-f.y/m(f,u)+f.x,0)),d.y>1&&u.y>=0?d=new t.MercatorCoordinate((1-p.y)/m(p,d)+p.x,1):d.y<0&&u.y<=1&&(d=new t.MercatorCoordinate(-p.y/m(p,d)+p.x,0)),(new t.LngLatBounds).extend(this.coordinateLocation(u)).extend(this.coordinateLocation(d)).extend(this.coordinateLocation(f)).extend(this.coordinateLocation(p))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const e=t.visibleDemTiles.reduce(((t,e)=>{if(e.dem){const i=e.dem.tree;t.min=Math.min(t.min,i.minimums[0]),t.max=Math.max(t.max,i.maximums[0])}return t}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(e.min*t.exaggeration(),e.max*t.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const e=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,i=this.height/2-e*(1-this._horizonShift);return t?Math.max(0,i):i}getMaxBounds(){return this.maxBounds}setMaxBounds(e){this.maxBounds=e,this.minLat=-t.MAX_MERCATOR_LATITUDE,this.maxLat=t.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,e&&(this.minLat=e.getSouth(),this.maxLat=e.getNorth(),this.minLng=e.getWest(),this.maxLng=e.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=t.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=t.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=t.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=t.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,e){return this.projection.createTileMatrix(this,e,t)}calculateDistanceTileData(e){const i=e.key,n=this._distanceTileDataCache;if(n[i])return n[i];const r=e.canonical,s=1/this.height,o=this.cameraWorldSize,a=o/this.zoomScale(r.z),l=(r.x+Math.pow(2,r.z)*e.wrap)*a,c=r.y*a,h=this.point;h.x*=o/this.worldSize,h.y*=o/this.worldSize;const u=this.angle,d=Math.sin(-u),p=-Math.cos(-u);return n[i]={bearing:[d,p],center:[(h.x-l)*s,(h.y-c)*s],scale:a/t.EXTENT*s},n[i]}calculateFogTileMatrix(e){const i=e.key,n=this._fogTileMatrixCache;if(n[i])return n[i];const r=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,e);return t.multiply(r,this.worldToFogMatrix,r),n[i]=new Float32Array(r),n[i]}calculateProjMatrix(e,i=!1){const n=e.key,r=i?this._alignedProjMatrixCache:this._projMatrixCache;if(r[n])return r[n];const s=this.calculatePosMatrix(e,this.worldSize);return t.multiply(s,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:i?this.alignedProjMatrix:this.projMatrix,s),r[n]=new Float32Array(s),r[n]}calculatePixelsToTileUnitsMatrix(e){const i=e.tileID.key,n=this._pixelsToTileUnitsCache;if(n[i])return n[i];const r=function(e,i){const{scale:n}=e.tileTransform,r=n*t.EXTENT/(e.tileSize*Math.pow(2,i.zoom-e.tileID.overscaledZ+e.tileID.canonical.z));return s=new Float32Array(4),l=(o=i.inverseAdjustmentMatrix)[1],c=o[2],h=o[3],d=(a=[r,r])[1],s[0]=o[0]*(u=a[0]),s[1]=l*u,s[2]=c*d,s[3]=h*d,s;var s,o,a,l,c,h,u,d}(e,this);return n[i]=r,n[i]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const e=1/this.worldSize,i=t.fromScaling([],[e,e,e]);return t.multiply(i,i,this.globeMatrix),i}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const e=this._elevation;this._updateCameraState();const i=t.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,n=this._computeCameraPosition(i),r=this._camera.forward(),s=t.mercatorZfromAltitude(1,this._center.lat);n[2]/=s,r[2]/=s,t.normalize(r,r);const o=e.raycast(n,r,e.exaggeration());if(o){const e=t.scaleAndAdd([],n,r,o),i=new t.MercatorCoordinate(e[0],e[1],t.mercatorZfromAltitude(e[2],t.latFromMercatorY(e[1]))),a=(i.z+t.length([i.x-n[0],i.y-n[1],i.z-n[2]*s]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(a),this._centerAltitude=i.toAltitude(),this._center=this.coordinateLocation(i),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(e=!1){if(!this._elevation)return;const i=this._elevation,n=t.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(n),s=i.getAtPointOrZero(new t.MercatorCoordinate(...r)),o=this.pixelsPerMeter/this.worldSize*s,a=this._minimumHeightOverTerrain(),l=r[2]-o;if(l<=a)if(l<0||e){const e=this.locationCoordinate(this._center,this._centerAltitude),i=[r[0],r[1],e.z-r[2]],n=t.length(i);i[2]-=(a-l)/this._pixelsPerMercatorPixel;const s=t.length(i);if(0===s)return;t.scale$2(i,i,n/s*this._pixelsPerMercatorPixel),this._camera.position=[r[0],r[1],e.z*this._pixelsPerMercatorPixel-i[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const e="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||e){const i=this.center;return i.lat=t.clamp(i.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!e)&&(i.lng=t.clamp(i.lng,this.minLng,this.maxLng)),this.center=i,void(this._constraining=!1)}const i=this._unmodified,{x:n,y:r}=this.point;let s=0,o=n,a=r;const l=this.width/2,c=this.height/2,h=this.worldMinY*this.scale,u=this.worldMaxY*this.scale;if(r-c<h&&(a=h+c),r+c>u&&(a=u-c),u-h<this.height&&(s=Math.max(s,this.height/(u-h)),a=(u+h)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const t=this.worldMinX*this.scale,e=this.worldMaxX*this.scale,i=this.worldSize/2-(t+e)/2;o=(n+i+this.worldSize)%this.worldSize-i,o-l<t&&(o=t+l),o+l>e&&(o=e-l),e-t<this.width&&(s=Math.max(s,this.width/(e-t)),o=(e+t)/2)}o===n&&a===r||(this.center=this.unproject(new t.Point(o,a))),s&&(this.zoom+=this.scaleZoom(s)),this._constrainCamera(),this._unmodified=i,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const e=this.centerOffset,i=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=t.mercatorZfromAltitude(1,this.center.lat)/t.mercatorZfromAltitude(1,t.GLOBE_SCALE_MATCH_LATITUDE));const n=Wn(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,n),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const r="meters"===this.projection.zAxisUnit?i:1,s=this._camera.getWorldToCamera(this.worldSize,r),o=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);o[8]=2*-e.x/this.width,o[9]=2*e.y/this.height;let a=t.mul([],o,s);if(this.projection.isReprojectedInTileSpace){const e=this.locationCoordinate(this.center),i=t.identity([]);t.translate(i,i,[e.x*this.worldSize,e.y*this.worldSize,0]),t.multiply(i,i,jn(this)),t.translate(i,i,[-e.x*this.worldSize,-e.y*this.worldSize,0]),t.multiply(a,a,i),this.inverseAdjustmentMatrix=function(t){const e=jn(t,!0);return y([],[e[0],e[1],e[4],e[5]])}(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=t.scale([],a,[this.worldSize,this.worldSize,this.worldSize/r,1]),this.projMatrix=a,this.invProjMatrix=t.invert(new Float64Array(16),this.projMatrix);const l=t.invert([],o);this.frustumCorners=t.FrustumCorners.fromInvProjectionMatrix(l,this.horizonLineFromTop(),this.height);const c=new Float32Array(16);t.identity(c),t.scale(c,c,[1,-1,1]),t.rotateX(c,c,this._pitch),t.rotateZ(c,c,this.angle);const h=t.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),u=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;h[8]=2*-e.x/this.width,h[9]=2*(e.y+u)/this.height,this.skyboxMatrix=t.multiply(c,h,c);const d=this.point,p=d.x,f=d.y,m=this.width%2/2,g=this.height%2/2,_=Math.cos(this.angle),v=Math.sin(this.angle),x=p-Math.round(p)+_*m+v*g,b=f-Math.round(f)+_*g+v*m,w=new Float64Array(a);if(t.translate(w,w,[x>.5?x-1:x,b>.5?b-1:b,0]),this.alignedProjMatrix=w,a=t.create(),t.scale(a,a,[this.width/2,-this.height/2,1]),t.translate(a,a,[1,-1,0]),this.labelPlaneMatrix=a,a=t.create(),t.scale(a,a,[1,-1,1]),t.translate(a,a,[-1,-1,0]),t.scale(a,a,[2/this.width,2/this.height,1]),this.glCoordMatrix=a,this.pixelMatrix=t.multiply(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},a=t.invert(new Float64Array(16),this.pixelMatrix),!a)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=a,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=t.calculateGlobeMatrix(this);const e=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=t.transformMat4(e,e,s),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=a;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const e=this.cameraWorldSizeForFog,i=this.cameraPixelsPerMeter,n=this._camera.position,r=1/this.height/this._pixelsPerMercatorPixel,s=[e,e,i];t.scale$2(s,s,r),t.scale$2(n,n,-1),t.multiply$2(n,n,s);const o=t.create();t.translate(o,o,n),t.scale(o,o,s),this.mercatorFogMatrix=o,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(e,i,r)}_computeCameraPosition(t){const e=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,i=this._camera.forward(),n=this.point,r=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*e-t/this.worldSize*this._centerAltitude;return[n.x/this.worldSize-i[0]*r,n.y/this.worldSize-i[1]*r,t/this.worldSize*this._centerAltitude-i[2]*r]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(e){const i=this._maxCameraBoundsDistance()*Math.cos(this._pitch),n=this._camera.position[2],r=e[2];let s=1;this.projection.wrap&&(this.center=this.center.wrap()),r>0&&(s=Math.min((i-n)/r,1)),this._camera.position=t.scaleAndAdd([],this._camera.position,e,s),this._updateStateFromCamera()}_updateStateFromCamera(){const e=this._camera.position,i=this._camera.forward(),{pitch:n,bearing:r}=this._camera.getPitchBearing(),s=t.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,o=this._mercatorZfromZoom(this._maxZoom)*Math.cos(t.degToRad(this._maxPitch)),a=Math.max((e[2]-s)/Math.cos(n),o),l=this._zoomFromMercatorZ(a);t.scaleAndAdd(e,e,i,a),this._pitch=t.clamp(n,t.degToRad(this.minPitch),t.degToRad(this.maxPitch)),this.angle=t.wrap(r,-Math.PI,Math.PI),this._setZoom(t.clamp(l,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new t.MercatorCoordinate(e[0],e[1],e[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min((null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom)+4,this._maxZoom);return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(e){let i=0,n=t.GLOBE_ZOOM_THRESHOLD_MAX,r=0,s=1/0;for(;n-i>1e-6&&n>i;){const t=i+.5*(n-i),o=this.tileSize*Math.pow(2,t),a=this.getCameraToCenterDistance(this.projection,t,o),l=this.scaleZoom(a/(e*this.tileSize)),c=Math.abs(t-l);c<s&&(s=c,r=t),t<l?i=t:n=t}return r}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(t.warnOnce("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(e,i){const n=Math.min(e.x,i.x),r=Math.max(e.x,i.x),s=Math.min(e.y,i.y),o=Math.max(e.y,i.y);if(s<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const a=[new t.Point(n,s),new t.Point(r,o),new t.Point(n,o),new t.Point(r,s)],l=this.renderWorldCopies?-3:0,c=this.renderWorldCopies?4:1;for(const t of a){const e=this.pointRayIntersection(t);if(e.t<0)return!0;const i=this.rayIntersectionCoordinate(e);if(i.x<l||i.y<0||i.x>c||i.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+t.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new t.Point(0,0),new t.Point(this.width,this.height))}zoomDeltaToMovement(e,i){const n=t.length(t.sub([],this._camera.position,e)),r=this._zoomFromMercatorZ(n)+i;return n-this._mercatorZfromZoom(r)}getCameraPoint(){if("globe"===this.projection.name){const e=function([e,i,n],r){const s=[e,i,n,1];t.transformMat4$1(s,s,r);const o=s[3]=Math.max(s[3],1e-6);return s[0]/=o,s[1]/=o,s[2]/=o,s}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new t.Point(e[0],e[1])}{const e=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new t.Point(0,e))}}getCameraToCenterDistance(t,e=this.zoom,i=this.worldSize){const n=Wn(t,e,this.width,this.height,1024),r=t.pixelSpaceConversion(this.center.lat,i,n);return.5/Math.tan(.5*this._fov)*this.height*r}getWorldToCameraMatrix(){const e=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&t.multiply(e,e,this.globeMatrix),e}}function Yn(t,e){let i=!1,n=null;const r=()=>{n=null,i&&(t(),n=setTimeout(r,e),i=!1)};return()=>(i=!0,n||r(),n)}class $n{constructor(e){this._hashName=e&&encodeURIComponent(e),t.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Yn(this._updateHashUnthrottled.bind(this),300)}addTo(e){return this._map=e,t.window.addEventListener("hashchange",this._onHashChange,!1),e.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),t.window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const e=this._map;if(!e)return"";const i=Kn(e);if(this._hashName){const e=this._hashName;let n=!1;const r=t.window.location.hash.slice(1).split("&").map((t=>{const r=t.split("=")[0];return r===e?(n=!0,`${r}=${i}`):t})).filter((t=>t));return n||r.push(`${e}=${i}`),`#${r.join("&")}`}return`#${i}`}_getCurrentHash(){const e=t.window.location.hash.replace("#","");if(this._hashName){let t;return e.split("&").map((t=>t.split("="))).forEach((e=>{e[0]===this._hashName&&(t=e)})),(t&&t[1]||"").split("/")}return e.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const e=this._getCurrentHash();if(e.length>=3&&!e.some((t=>isNaN(t)))){const i=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(e[3]||0):t.getBearing();return t.jumpTo({center:[+e[2],+e[1]],zoom:+e[0],bearing:i,pitch:+(e[4]||0)}),!0}return!1}_updateHashUnthrottled(){const e=t.window.location.href.replace(/(#.+)?$/,this.getHashString());t.window.history.replaceState(t.window.history.state,null,e)}}function Kn(t,e){const i=t.getCenter(),n=Math.round(100*t.getZoom())/100,r=Math.ceil((n*Math.LN2+Math.log(512/360/.5))/Math.LN10),s=Math.pow(10,r),o=Math.round(i.lng*s)/s,a=Math.round(i.lat*s)/s,l=t.getBearing(),c=t.getPitch();let h=e?`/${o}/${a}/${n}`:`${n}/${a}/${o}`;return(l||c)&&(h+="/"+Math.round(10*l)/10),c&&(h+=`/${Math.round(c)}`),h}const Qn={linearity:.3,easing:t.bezier(0,0,.3,1)},tr=t.extend({deceleration:2500,maxSpeed:1400},Qn),er=t.extend({deceleration:20,maxSpeed:1400},Qn),ir=t.extend({deceleration:1e3,maxSpeed:360},Qn),nr=t.extend({deceleration:1e3,maxSpeed:90},Qn);class rr{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(e){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:t.exported.now(),settings:e})}_drainInertiaBuffer(){const e=this._inertiaBuffer,i=t.exported.now();for(;e.length>0&&i-e[0].time>160;)e.shift()}_onMoveEnd(e){if(this._map._prefersReducedMotion())return;if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const i={zoom:0,bearing:0,pitch:0,pan:new t.Point(0,0),pinchAround:void 0,around:void 0};for(const{settings:t}of this._inertiaBuffer)i.zoom+=t.zoomDelta||0,i.bearing+=t.bearingDelta||0,i.pitch+=t.pitchDelta||0,t.panDelta&&i.pan._add(t.panDelta),t.around&&(i.around=t.around),t.pinchAround&&(i.pinchAround=t.pinchAround);const n=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,r={};if(i.pan.mag()){const s=or(i.pan.mag(),n,t.extend({},tr,e||{}));r.offset=i.pan.mult(s.amount/i.pan.mag()),r.center=this._map.transform.center,sr(r,s)}if(i.zoom){const t=or(i.zoom,n,er);r.zoom=this._map.transform.zoom+t.amount,sr(r,t)}if(i.bearing){const e=or(i.bearing,n,ir);r.bearing=this._map.transform.bearing+t.clamp(e.amount,-179,179),sr(r,e)}if(i.pitch){const t=or(i.pitch,n,nr);r.pitch=this._map.transform.pitch+t.amount,sr(r,t)}if(r.zoom||r.bearing){const t=void 0===i.pinchAround?i.around:i.pinchAround;r.around=t?this._map.unproject(t):this._map.getCenter()}return this.clear(),r.noMoveStart=!0,r}}function sr(t,e){(!t.duration||t.duration<e.duration)&&(t.duration=e.duration,t.easing=e.easing)}function or(e,i,n){const{maxSpeed:r,linearity:s,deceleration:o}=n,a=t.clamp(e*s/(i/1e3),-r,r),l=Math.abs(a)/(o*s);return{easing:n.easing,duration:1e3*l,amount:a*(l/2)}}class ar extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,n,r={}){const s=f(i.getCanvasContainer(),n),o=i.unproject(s);super(e,t.extend({point:s,lngLat:o,originalEvent:n},r)),this._defaultPrevented=!1,this.target=i}}class lr extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(e,i,n){const r="touchend"===e?n.changedTouches:n.touches,s=m(i.getCanvasContainer(),r),o=s.map((t=>i.unproject(t))),a=s.reduce(((t,e,i,n)=>t.add(e.div(n.length))),new t.Point(0,0));super(e,{points:s,point:a,lngLats:o,lngLat:i.unproject(a),originalEvent:n}),this._defaultPrevented=!1}}class cr extends t.Event{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,e,i){super(t,{originalEvent:i}),this._defaultPrevented=!1}}class hr{constructor(t,e){this._map=t,this._clickTolerance=e.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new cr(t.type,this._map,t))}mousedown(t,e){return this._mousedownPos=e,this._firePreventable(new ar(t.type,this._map,t))}mouseup(t){this._map.fire(new ar(t.type,this._map,t))}preclick(e){const i=t.extend({},e);i.type="preclick",this._map.fire(new ar(i.type,this._map,i))}click(t,e){this._mousedownPos&&this._mousedownPos.dist(e)>=this._clickTolerance||(this.preclick(t),this._map.fire(new ar(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new ar(t.type,this._map,t))}mouseover(t){this._map.fire(new ar(t.type,this._map,t))}mouseout(t){this._map.fire(new ar(t.type,this._map,t))}touchstart(t){return this._firePreventable(new lr(t.type,this._map,t))}touchmove(t){this._map.fire(new lr(t.type,this._map,t))}touchend(t){this._map.fire(new lr(t.type,this._map,t))}touchcancel(t){this._map.fire(new lr(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class ur{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new ar(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ar("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new ar(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class dr{constructor(t,e){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=e.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,e){this.isEnabled()&&t.shiftKey&&0===t.button&&(h(),this._startPos=this._lastPos=e,this._active=!0)}mousemoveWindow(t,e){if(!this._active)return;const i=e,n=this._startPos,r=this._lastPos;if(!n||!r||r.equals(i)||!this._box&&i.dist(n)<this._clickTolerance)return;this._lastPos=i,this._box||(this._box=s("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const o=Math.min(n.x,i.x),a=Math.max(n.x,i.x),l=Math.min(n.y,i.y),c=Math.max(n.y,i.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${o}px,${l}px)`,this._box.style.width=a-o+"px",this._box.style.height=c-l+"px")}))}mouseupWindow(e,i){if(!this._active)return;const n=this._startPos,r=i;if(n&&0===e.button){if(this.reset(),p(),n.x!==r.x||n.y!==r.y)return this._map.fire(new t.Event("boxzoomend",{originalEvent:e})),{cameraAnimation:t=>t.fitScreenCoordinates(n,r,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",e)}}keydown(t){this._active&&27===t.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),u(),delete this._startPos,delete this._lastPos}_fireEvent(e,i){return this._map.fire(new t.Event(e,{originalEvent:i}))}}function pr(t,e){const i={};for(let n=0;n<t.length;n++)i[t[n].identifier]=e[n];return i}class fr{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(e,i,n){(this.centroid||n.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=e.timeStamp),n.length===this.numTouches&&(this.centroid=function(e){const i=new t.Point(0,0);for(const t of e)i._add(t);return i.div(e.length)}(i),this.touches=pr(n,i)))}touchmove(t,e,i){if(this.aborted||!this.centroid)return;const n=pr(i,e);for(const t in this.touches){const e=n[t];(!e||e.dist(this.touches[t])>30)&&(this.aborted=!0)}}touchend(t,e,i){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),0===i.length){const t=!this.aborted&&this.centroid;if(this.reset(),t)return t}}}class mr{constructor(t){this.singleTap=new fr(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,e,i){this.singleTap.touchstart(t,e,i)}touchmove(t,e,i){this.singleTap.touchmove(t,e,i)}touchend(t,e,i){const n=this.singleTap.touchend(t,e,i);if(n){const e=t.timeStamp-this.lastTime<500,i=!this.lastTap||this.lastTap.dist(n)<30;if(e&&i||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=n,this.count===this.numTaps)return this.reset(),n}}}class gr{constructor(){this._zoomIn=new mr({numTouches:1,numTaps:2}),this._zoomOut=new mr({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,e,i){this._zoomIn.touchstart(t,e,i),this._zoomOut.touchstart(t,e,i)}touchmove(t,e,i){this._zoomIn.touchmove(t,e,i),this._zoomOut.touchmove(t,e,i)}touchend(t,e,i){const n=this._zoomIn.touchend(t,e,i),r=this._zoomOut.touchend(t,e,i);return n?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:e=>e.easeTo({duration:300,zoom:e.getZoom()+1,around:e.unproject(n)},{originalEvent:t})}):r?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:e=>e.easeTo({duration:300,zoom:e.getZoom()-1,around:e.unproject(r)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const _r={0:1,2:2};class yr{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,e){return!1}_move(t,e){return{}}mousedown(t,e){if(this._lastPoint)return;const i=g(t);this._correctButton(t,i)&&(this._lastPoint=e,this._eventButton=i)}mousemoveWindow(t,e){const i=this._lastPoint;if(i)if(t.preventDefault(),null!=this._eventButton&&function(t,e){const i=_r[e];return void 0===t.buttons||(t.buttons&i)!==i}(t,this._eventButton))this.reset();else if(this._moved||!(e.dist(i)<this._clickTolerance))return this._moved=!0,this._lastPoint=e,this._move(i,e)}mouseupWindow(t){this._lastPoint&&g(t)===this._eventButton&&(this._moved&&p(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class vr extends yr{mousedown(t,e){super.mousedown(t,e),this._lastPoint&&(this._active=!0)}_correctButton(t,e){return 0===e&&!t.ctrlKey}_move(t,e){return{around:e,panDelta:e.sub(t)}}}class xr extends yr{_correctButton(t,e){return 0===e&&t.ctrlKey||2===e}_move(t,e){const i=.8*(e.x-t.x);if(i)return this._active=!0,{bearingDelta:i}}contextmenu(t){t.preventDefault()}}class br extends yr{_correctButton(t,e){return 0===e&&t.ctrlKey||2===e}_move(t,e){const i=-.5*(e.y-t.y);if(i)return this._active=!0,{pitchDelta:i}}contextmenu(t){t.preventDefault()}}class wr{constructor(e,i){this._map=e,this._el=e.getCanvasContainer(),this._minTouches=1,this._clickTolerance=i.clickTolerance||1,this.reset(),t.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new t.Point(0,0)}touchstart(t,e,i){return this._calculateTransform(t,e,i)}touchmove(e,i,n){if(this._active&&!(n.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===n.length&&!t.isFullscreen())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return e.cancelable&&e.preventDefault(),this._calculateTransform(e,i,n)}}touchend(t,e,i){this._calculateTransform(t,e,i),this._active&&i.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(e,i,n){n.length>0&&(this._active=!0);const r=pr(n,i),s=new t.Point(0,0),o=new t.Point(0,0);let a=0;for(const t in r){const e=r[t],i=this._touches[t];i&&(s._add(e),o._add(e.sub(i)),a++,r[t]=e)}if(this._touches=r,a<this._minTouches||!o.mag())return;const l=o.div(a);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:s.div(a),panDelta:l}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","null")}),500)}}class Ar{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,e,i){return{}}touchstart(t,e,i){this._firstTwoTouches||i.length<2||(this._firstTwoTouches=[i[0].identifier,i[1].identifier],this._start([e[0],e[1]]))}touchmove(t,e,i){const n=this._firstTwoTouches;if(!n)return;t.preventDefault();const[r,s]=n,o=Tr(i,e,r),a=Tr(i,e,s);if(!o||!a)return;const l=this._aroundCenter?null:o.add(a).div(2);return this._move([o,a],l,t)}touchend(t,e,i){if(!this._firstTwoTouches)return;const[n,r]=this._firstTwoTouches,s=Tr(i,e,n),o=Tr(i,e,r);s&&o||(this._active&&p(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Tr(t,e,i){for(let n=0;n<t.length;n++)if(t[n].identifier===i)return e[n]}function Mr(t,e){return Math.log(t/e)/Math.LN2}class Sr extends Ar{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,e){const i=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(Mr(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Mr(this._distance,i),pinchAround:e}}}function Er(t,e){return 180*t.angleWith(e)/Math.PI}class Cr extends Ar{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,e){const i=this._vector;if(this._vector=t[0].sub(t[1]),i&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Er(this._vector,i),pinchAround:e}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const e=25/(Math.PI*this._minDiameter)*360,i=this._startVector;if(!i)return!1;const n=Er(t,i);return Math.abs(n)<e}}function Ir(t){return Math.abs(t.y)>Math.abs(t.x)}class Pr extends Ar{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,Ir(t[0].sub(t[1]))&&(this._valid=!1)}_move(e,i,n){const r=this._lastPoints;if(!r)return;const s=e[0].sub(r[0]),o=e[1].sub(r[1]);return this._map._cooperativeGestures&&!t.isFullscreen()&&n.touches.length<3||(this._valid=this.gestureBeginsVertically(s,o,n.timeStamp),!this._valid)?void 0:(this._lastPoints=e,this._active=!0,{pitchDelta:(s.y+o.y)/2*-.5})}gestureBeginsVertically(t,e,i){if(void 0!==this._valid)return this._valid;const n=t.mag()>=2,r=e.mag()>=2;if(!n&&!r)return;if(!n||!r)return null==this._firstMove&&(this._firstMove=i),i-this._firstMove<100&&void 0;const s=t.y>0==e.y>0;return Ir(t)&&Ir(e)&&s}}const Lr={panStep:100,bearingStep:15,pitchStep:10};class Rr{constructor(){const t=Lr;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let e=0,i=0,n=0,r=0,s=0;switch(t.keyCode){case 61:case 107:case 171:case 187:e=1;break;case 189:case 109:case 173:e=-1;break;case 37:t.shiftKey?i=-1:(t.preventDefault(),r=-1);break;case 39:t.shiftKey?i=1:(t.preventDefault(),r=1);break;case 38:t.shiftKey?n=1:(t.preventDefault(),s=-1);break;case 40:t.shiftKey?n=-1:(t.preventDefault(),s=1);break;default:return}return this._rotationDisabled&&(i=0,n=0),{cameraAnimation:o=>{const a=o.getZoom();o.easeTo({duration:300,easeId:"keyboardHandler",easing:Br,zoom:e?Math.round(a)+e*(t.shiftKey?2:1):a,bearing:o.getBearing()+i*this._bearingStep,pitch:o.getPitch()+n*this._pitchStep,offset:[-r*this._panStep,-s*this._panStep],center:o.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Br(t){return t*(2-t)}const Dr=4.000244140625;class Or{constructor(e,i){this._map=e,this._el=e.getCanvasContainer(),this._handler=i,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,t.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(e){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(e.ctrlKey||e.metaKey||this.isZooming()||t.isFullscreen()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let i=e.deltaMode===t.window.WheelEvent.DOM_DELTA_LINE?40*e.deltaY:e.deltaY;const n=t.exported.now(),r=n-(this._lastWheelEventTime||0);this._lastWheelEventTime=n,0!==i&&i%Dr==0?this._type="wheel":0!==i&&Math.abs(i)<4?this._type="trackpad":r>400?(this._type=null,this._lastValue=i,this._timeout=setTimeout(this._onTimeout,40,e)):this._type||(this._type=Math.abs(r*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),e.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=e,this._delta-=i,this._active||this._start(e)),e.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const e=f(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:e,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const e=this._map.transform;"wheel"===this._type&&e.projection.wrap&&(e._center.lng>=180||e._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const i=()=>e._terrainEnabled()&&this._aroundCoord?e.computeZoomRelativeTo(this._aroundCoord):e.zoom;if(0!==this._delta){const t="wheel"===this._type&&Math.abs(this._delta)>Dr?this._wheelZoomRate:this._defaultZoomRate;let n=2/(1+Math.exp(-Math.abs(this._delta*t)));this._delta<0&&0!==n&&(n=1/n);const r=i(),s=Math.pow(2,r),o="number"==typeof this._targetZoom?e.zoomScale(this._targetZoom):s;this._targetZoom=Math.min(e.maxZoom,Math.max(e.minZoom,e.scaleZoom(o*n))),"wheel"===this._type&&(this._startZoom=r,this._easing=this._smoothOutEasing(200)),this._delta=0}const n="number"==typeof this._targetZoom?this._targetZoom:i(),r=this._startZoom,s=this._easing;let o,a=!1;if("wheel"===this._type&&r&&s){const e=Math.min((t.exported.now()-this._lastWheelEventTime)/200,1),i=s(e);o=t.number(r,n,i),e<1?this._frameId||(this._frameId=!0):a=!0}else o=n,a=!0;return this._active=!0,a&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200)),{noInertia:!0,needsRenderFrame:!a,zoomDelta:o-i(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(e){let i=t.ease;if(this._prevEase){const e=this._prevEase,n=(t.exported.now()-e.start)/e.duration,r=e.easing(n+.01)-e.easing(n),s=.27/Math.sqrt(r*r+1e-4)*.01,o=Math.sqrt(.0729-s*s);i=t.bezier(s,o,.25,1)}return this._prevEase={start:t.exported.now(),duration:e,easing:i},i}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(t.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","null")}),200)}}class kr{constructor(t,e){this._clickZoom=t,this._tapZoom=e}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Fr{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,e){return t.preventDefault(),{cameraAnimation:i=>{i.easeTo({duration:300,zoom:i.getZoom()+(t.shiftKey?-1:1),around:i.unproject(e)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class zr{constructor(){this._tap=new mr({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,e,i){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?i.length>0&&(this._swipePoint=e[0],this._swipeTouch=i[0].identifier):this._tap.touchstart(t,e,i))}touchmove(t,e,i){if(this._tapTime){if(this._swipePoint){if(i[0].identifier!==this._swipeTouch)return;const n=e[0],r=n.y-this._swipePoint.y;return this._swipePoint=n,t.preventDefault(),this._active=!0,{zoomDelta:r/128}}}else this._tap.touchmove(t,e,i)}touchend(t,e,i){this._tapTime?this._swipePoint&&0===i.length&&this.reset():this._tap.touchend(t,e,i)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Nr{constructor(t,e,i){this._el=t,this._mousePan=e,this._touchPan=i}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Ur{constructor(t,e,i){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=e,this._mousePitch=i}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Gr{constructor(t,e,i,n){this._el=t,this._touchZoom=e,this._touchRotate=i,this._tapDragZoom=n,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Vr=t=>t.zoom||t.drag||t.pitch||t.rotate;class jr extends t.Event{}class Hr{constructor(){this.constants=[1,1,.01],this.radius=0}setup(e,i){const n=t.sub([],i,e);this.radius=t.length(n[2]<0?t.div([],n,this.constants):[n[0],n[1],0])}projectRay(e){t.div(e,e,this.constants),t.normalize(e,e),t.mul$1(e,e,this.constants);const i=t.scale$2([],e,this.radius);if(i[2]>0){const e=t.scale$2([],[0,0,1],t.dot(i,[0,0,1])),n=t.scale$2([],t.normalize([],[i[0],i[1],0]),this.radius),r=t.add([],i,t.scale$2([],t.sub([],t.add([],n,e),i),2));i[0]=r[0],i[1]=r[1]}return i}}function Wr(t){return t.panDelta&&t.panDelta.mag()||t.zoomDelta||t.bearingDelta||t.pitchDelta}class qr{constructor(e,i){this._map=e,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new rr(e),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Hr,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(i),t.bindAll(["handleEvent","handleWindowEvent"],this);const n=this._el;this._listeners=[[n,"touchstart",{passive:!0}],[n,"touchmove",{passive:!1}],[n,"touchend",void 0],[n,"touchcancel",void 0],[n,"mousedown",void 0],[n,"mousemove",void 0],[n,"mouseup",void 0],[t.window.document,"mousemove",{capture:!0}],[t.window.document,"mouseup",void 0],[n,"mouseover",void 0],[n,"mouseout",void 0],[n,"dblclick",void 0],[n,"click",void 0],[n,"keydown",{capture:!1}],[n,"keyup",void 0],[n,"wheel",{passive:!1}],[n,"contextmenu",void 0],[t.window,"blur",void 0]];for(const[e,i,n]of this._listeners)e.addEventListener(i,e===t.window.document?this.handleWindowEvent:this.handleEvent,n)}destroy(){for(const[e,i,n]of this._listeners)e.removeEventListener(i,e===t.window.document?this.handleWindowEvent:this.handleEvent,n)}_addDefaultHandlers(t){const e=this._map,i=e.getCanvasContainer();this._add("mapEvent",new hr(e,t));const n=e.boxZoom=new dr(e,t);this._add("boxZoom",n);const r=new gr,s=new Fr;e.doubleClickZoom=new kr(s,r),this._add("tapZoom",r),this._add("clickZoom",s);const o=new zr;this._add("tapDragZoom",o);const a=e.touchPitch=new Pr(e);this._add("touchPitch",a);const l=new xr(t),c=new br(t);e.dragRotate=new Ur(t,l,c),this._add("mouseRotate",l,["mousePitch"]),this._add("mousePitch",c,["mouseRotate"]);const h=new vr(t),u=new wr(e,t);e.dragPan=new Nr(i,h,u),this._add("mousePan",h),this._add("touchPan",u,["touchZoom","touchRotate"]);const d=new Cr,p=new Sr;e.touchZoomRotate=new Gr(i,p,d,o),this._add("touchRotate",d,["touchPan","touchZoom"]),this._add("touchZoom",p,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ur(e));const f=e.scrollZoom=new Or(e,this);this._add("scrollZoom",f,["mousePan"]);const m=e.keyboard=new Rr;this._add("keyboard",m);for(const i of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[i]&&e[i].enable(t[i])}_add(t,e,i){this._handlers.push({handlerName:t,handler:e,allowed:i}),this._handlersById[t]=e}stop(t){if(!this._updatingCamera){for(const{handler:t}of this._handlers)t.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[]}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Vr(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,e,i){for(const n in t)if(n!==i&&(!e||e.indexOf(n)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const e=[];for(const i of t)this._el.contains(i.target)&&e.push(i);return e}handleEvent(t,e){this._updatingCamera=!0;const i="renderFrame"===t.type,n=i?void 0:t,r={needsRenderFrame:!1},s={},o={},a=t.touches?this._getMapTouches(t.touches):void 0,l=a?m(this._el,a):i?void 0:f(this._el,t);for(const{handlerName:i,handler:c,allowed:h}of this._handlers){if(!c.isEnabled())continue;let u;this._blockedByActive(o,h,i)?c.reset():c[e||t.type]&&(u=c[e||t.type](t,l,a),this.mergeHandlerResult(r,s,u,i,n),u&&u.needsRenderFrame&&this._triggerRenderFrame()),(u||c.isActive())&&(o[i]=c)}const c={};for(const t in this._previousActiveHandlers)o[t]||(c[t]=n);this._previousActiveHandlers=o,(Object.keys(c).length||Wr(r))&&(this._changes.push([r,s,c]),this._triggerRenderFrame()),(Object.keys(o).length||Wr(r))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:h}=r;h&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],h(this._map))}mergeHandlerResult(e,i,n,r,s){if(!n)return;t.extend(e,n);const o={handlerName:r,originalEvent:n.originalEvent||s};void 0!==n.zoomDelta&&(i.zoom=o),void 0!==n.panDelta&&(i.drag=o),void 0!==n.pitchDelta&&(i.pitch=o),void 0!==n.bearingDelta&&(i.rotate=o)}_applyChanges(){const e={},i={},n={};for(const[r,s,o]of this._changes)r.panDelta&&(e.panDelta=(e.panDelta||new t.Point(0,0))._add(r.panDelta)),r.zoomDelta&&(e.zoomDelta=(e.zoomDelta||0)+r.zoomDelta),r.bearingDelta&&(e.bearingDelta=(e.bearingDelta||0)+r.bearingDelta),r.pitchDelta&&(e.pitchDelta=(e.pitchDelta||0)+r.pitchDelta),void 0!==r.around&&(e.around=r.around),void 0!==r.aroundCoord&&(e.aroundCoord=r.aroundCoord),void 0!==r.pinchAround&&(e.pinchAround=r.pinchAround),r.noInertia&&(e.noInertia=r.noInertia),t.extend(i,s),t.extend(n,o);this._updateMapTransform(e,i,n),this._changes=[]}_updateMapTransform(e,i,n){const r=this._map,s=r.transform,o=t=>[t.x,t.y,t.z];if((t=>{const e=this._eventsInProgress.drag;return e&&!this._handlersById[e.handlerName].isActive()})()&&!Wr(e)){const t=s.zoom;s.cameraElevationReference="sea",s.recenterOnTerrain(),s.cameraElevationReference="ground",t!==s.zoom&&this._map._update(!0)}if(s._isCameraConstrained&&r._stop(!0),!Wr(e))return void this._fireEvents(i,n,!0);let{panDelta:a,zoomDelta:l,bearingDelta:c,pitchDelta:h,around:u,aroundCoord:d,pinchAround:p}=e;s._isCameraConstrained&&(l>0&&(l=0),s._isCameraConstrained=!1),void 0!==p&&(u=p),(l||(t=>i[t]&&!this._eventsInProgress[t])("drag"))&&u&&(this._dragOrigin=o(s.pointCoordinate3D(u)),this._trackingEllipsoid.setup(s._camera.position,this._dragOrigin)),s.cameraElevationReference="sea",r._stop(!0),u=u||r.transform.centerPoint,c&&(s.bearing+=c),h&&(s.pitch+=h),s._updateCameraState();const f=[0,0,0];if(a)if("mercator"===s.projection.name){const t=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(u).dir),e=this._trackingEllipsoid.projectRay(s.screenPointToMercatorRay(u.sub(a)).dir);f[0]=e[0]-t[0],f[1]=e[1]-t[1]}else{const e=s.pointCoordinate(u);if("globe"===s.projection.name){a=a.rotate(-s.angle);const i=s._pixelsPerMercatorPixel/s.worldSize;f[0]=-a.x*t.mercatorScale(t.latFromMercatorY(e.y))*i,f[1]=-a.y*t.mercatorScale(s.center.lat)*i}else{const t=s.pointCoordinate(u.sub(a));e&&t&&(f[0]=t.x-e.x,f[1]=t.y-e.y)}}const m=s.zoom,g=[0,0,0];if(l){const e=o(d||s.pointCoordinate3D(u)),i={dir:t.normalize([],t.sub([],e,s._camera.position))};if(i.dir[2]<0){const n=s.zoomDeltaToMovement(e,l);t.scale$2(g,i.dir,n)}}const _=t.add(f,f,g);s._translateCameraConstrained(_),l&&Math.abs(s.zoom-m)>1e-4&&s.recenterOnTerrain(),s.cameraElevationReference="ground",this._map._update(),e.noInertia||this._inertia.record(e),this._fireEvents(i,n,!0)}_fireEvents(e,i,n){const r=Vr(this._eventsInProgress),s=Vr(e),o={};for(const t in e){const{originalEvent:i}=e[t];this._eventsInProgress[t]||(o[`${t}start`]=i),this._eventsInProgress[t]=e[t]}!r&&s&&this._fireEvent("movestart",s.originalEvent);for(const t in o)this._fireEvent(t,o[t]);s&&this._fireEvent("move",s.originalEvent);for(const t in e){const{originalEvent:i}=e[t];this._fireEvent(t,i)}const a={};let l;for(const t in this._eventsInProgress){const{handlerName:e,originalEvent:n}=this._eventsInProgress[t];this._handlersById[e].isActive()||(delete this._eventsInProgress[t],l=i[e]||n,a[`${t}end`]=l)}for(const t in a)this._fireEvent(t,a[t]);const c=Vr(this._eventsInProgress);if(n&&(r||s)&&!c){this._updatingCamera=!0;const e=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=t=>0!==t&&-this._bearingSnap<t&&t<this._bearingSnap;e?(i(e.bearing||this._map.getBearing())&&(e.bearing=0),this._map.easeTo(e,{originalEvent:l})):(this._map.fire(new t.Event("moveend",{originalEvent:l})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(e,i){this._map.fire(new t.Event(e,i?{originalEvent:i}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{this._frameId=void 0,this.handleEvent(new jr("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const Xr="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Zr extends t.Evented{constructor(e,i){super(),this._moving=!1,this._zooming=!1,this.transform=e,this._bearingSnap=i.bearingSnap,this._respectPrefersReducedMotion=!1!==i.respectPrefersReducedMotion,t.bindAll(["_renderFrameCallback"],this)}getCenter(){return new t.LngLat(this.transform.center.lng,this.transform.center.lat)}setCenter(t,e){return this.jumpTo({center:t},e)}panBy(e,i,n){return e=t.Point.convert(e).mult(-1),this.panTo(this.transform.center,t.extend({offset:e},i),n)}panTo(e,i,n){return this.easeTo(t.extend({center:e},i),n)}getZoom(){return this.transform.zoom}setZoom(t,e){return this.jumpTo({zoom:t},e),this}zoomTo(e,i,n){return this.easeTo(t.extend({zoom:e},i),n)}zoomIn(t,e){return this.zoomTo(this.getZoom()+1,t,e),this}zoomOut(t,e){return this.zoomTo(this.getZoom()-1,t,e),this}getBearing(){return this.transform.bearing}setBearing(t,e){return this.jumpTo({bearing:t},e),this}getPadding(){return this.transform.padding}setPadding(t,e){return this.jumpTo({padding:t},e),this}rotateTo(e,i,n){return this.easeTo(t.extend({bearing:e},i),n)}resetNorth(e,i){return this.rotateTo(0,t.extend({duration:1e3},e),i),this}resetNorthPitch(e,i){return this.easeTo(t.extend({bearing:0,pitch:0,duration:1e3},e),i),this}snapToNorth(t,e){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,e):this}getPitch(){return this.transform.pitch}setPitch(t,e){return this.jumpTo({pitch:t},e),this}cameraForBounds(e,i){e=t.LngLatBounds.convert(e);const n=i&&i.bearing||0,r=i&&i.pitch||0,s=e.getNorthWest(),o=e.getSouthEast();return this._cameraForBounds(this.transform,s,o,n,r,i)}_extendCameraOptions(e){const i={top:0,bottom:0,right:0,left:0};if("number"==typeof(e=t.extend({padding:i,offset:[0,0],maxZoom:this.transform.maxZoom},e)).padding){const t=e.padding;e.padding={top:t,bottom:t,right:t,left:t}}return e.padding=t.extend(i,e.padding),e}_minimumAABBFrustumDistance(t,e){const i=e.max[0]-e.min[0],n=e.max[1]-e.min[1];return i/n>t.aspect?i/(2*Math.tan(.5*t.fovX)*t.aspect):n/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(e,i,n,r,s,o){const a=e.clone(),l=this._extendCameraOptions(o);a.bearing=r,a.pitch=s;const c=t.LngLat.convert(i),h=t.LngLat.convert(n),u=.5*(c.lat+h.lat),d=.5*(c.lng+h.lng),p=t.latLngToECEF(u,d),f=t.normalize([],p),m=t.normalize([],t.cross([],f,[0,1,0])),g=t.cross([],m,f),_=[m[0],m[1],m[2],0,g[0],g[1],g[2],0,f[0],f[1],f[2],0,0,0,0,1],y=[p,t.latLngToECEF(c.lat,c.lng),t.latLngToECEF(h.lat,c.lng),t.latLngToECEF(h.lat,h.lng),t.latLngToECEF(c.lat,h.lng),t.latLngToECEF(u,c.lng),t.latLngToECEF(u,h.lng),t.latLngToECEF(c.lat,d),t.latLngToECEF(h.lat,d)];let v=t.Aabb.fromPoints(y.map((e=>[t.dot(m,e),t.dot(g,e),t.dot(f,e)])));const x=t.transformMat4([],v.center,_);0===t.squaredLength(x)&&t.set(x,0,0,1),t.normalize(x,x),t.scale$2(x,x,t.GLOBE_RADIUS),a.center=t.ecefToLatLng(x);const b=a.getWorldToCameraMatrix(),w=t.invert(new Float64Array(16),b);v=t.Aabb.applyTransform(v,t.multiply([],b,_)),t.transformMat4(x,x,b);const A=.5*(v.max[2]-v.min[2]),T=this._minimumAABBFrustumDistance(a,v),M=t.scale$2([],[0,0,1],A),S=t.add(M,x,M),E=T+(0===a.pitch?0:t.distance(x,S)),C=a.globeCenterInViewSpace,I=t.sub([],x,[C[0],C[1],C[2]]);t.normalize(I,I),t.scale$2(I,I,E);const P=t.add([],x,I);t.transformMat4(P,P,w);const L=t.earthRadius/t.GLOBE_RADIUS,R=t.length(P),B=t.mercatorZfromAltitude(Math.max(R*L-t.earthRadius,Number.EPSILON),0),D=Math.min(a.zoomFromMercatorZAdjusted(B),l.maxZoom);return D>.5*(t.GLOBE_ZOOM_THRESHOLD_MIN+t.GLOBE_ZOOM_THRESHOLD_MAX)?(a.setProjection({name:"mercator"}),a.zoom=D,this._cameraForBounds(a,i,n,r,s,o)):{center:a.center,zoom:D,bearing:r,pitch:s}}queryTerrainElevation(e,i){const n=this.transform.elevation;return n?(i=t.extend({},{exaggerated:!0},i),n.getAtPoint(t.MercatorCoordinate.fromLngLat(e),null,i.exaggerated)):null}_cameraForBounds(e,i,n,r,s,o){if("globe"===e.projection.name)return this._cameraForBoundsOnGlobe(e,i,n,r,s,o);const a=e.clone(),l=this._extendCameraOptions(o),c=a.padding;a.bearing=r,a.pitch=s;const h=t.LngLat.convert(i),u=t.LngLat.convert(n),d=new t.LngLat(h.lng,u.lat),p=new t.LngLat(u.lng,h.lat),f=a.project(h),m=a.project(u),g=this.queryTerrainElevation(h),_=this.queryTerrainElevation(u),y=this.queryTerrainElevation(d),v=this.queryTerrainElevation(p),x=[[f.x,f.y,Math.min(g||0,_||0,y||0,v||0)],[m.x,m.y,Math.max(g||0,_||0,y||0,v||0)]];let b=t.Aabb.fromPoints(x);const w=a.getWorldToCameraMatrix(),A=t.invert(new Float64Array(16),w);b=t.Aabb.applyTransform(b,w);const T=t.sub([],b.max,b.min),M=c.left||0,S=c.right||0,E=c.bottom||0,C=c.top||0,{left:I,right:P,top:L,bottom:R}=l.padding,B=.5*(M+S),D=.5*(C+E),O=Math.min(a.scaleZoom(a.scale*Math.min((a.width-(M+S+I+P))/T[0],(a.height-(E+C+R+L))/T[1])),l.maxZoom),k=a.scale/a.zoomScale(O);b=new t.Aabb([b.min[0]-(I+B)*k,b.min[1]-(R+D)*k,b.min[2]],[b.max[0]+(P+B)*k,b.max[1]+(L+D)*k,b.max[2]]);const F=.5*T[2],z=this._minimumAABBFrustumDistance(a,b),N=[0,0,1,0];t.transformMat4$1(N,N,w),t.normalize$2(N,N);const U=t.scale$2([],N,z+F),G=t.add([],b.center,U),V=("number"==typeof l.offset.x&&"number"==typeof l.offset.y?new t.Point(l.offset.x,l.offset.y):t.Point.convert(l.offset)).rotate(-t.degToRad(r));b.center[0]-=V.x*k,b.center[1]+=V.y*k,t.transformMat4(b.center,b.center,A),t.transformMat4(G,G,A);const j=[b.center[0],b.center[1],G[2]*a.pixelsPerMeter];t.scale$2(j,j,1/a.worldSize);const H=t.lngFromMercatorX(j[0]),W=t.latFromMercatorY(j[1]),q=Math.min(a._zoomFromMercatorZ(j[2]),l.maxZoom),X=new t.LngLat(H,W);return a.mercatorFromTransition&&q<.5*(t.GLOBE_ZOOM_THRESHOLD_MIN+t.GLOBE_ZOOM_THRESHOLD_MAX)?(a.setProjection({name:"globe"}),a.zoom=q,this._cameraForBounds(a,i,n,r,s,o)):{center:X,zoom:q,bearing:r,pitch:s}}fitBounds(t,e,i){const n=this.cameraForBounds(t,e);return this._fitInternal(n,e,i)}fitScreenCoordinates(e,i,n,r,s){const o=t.Point.convert(e),a=t.Point.convert(i),l=new t.Point(Math.min(o.x,a.x),Math.min(o.y,a.y)),c=new t.Point(Math.max(o.x,a.x),Math.max(o.y,a.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(o,a))return this;const h=this.transform.pointLocation3D(l),u=this.transform.pointLocation3D(c),d=this.transform.pointLocation3D(new t.Point(l.x,c.y)),p=this.transform.pointLocation3D(new t.Point(c.x,l.y)),f=[Math.min(h.lng,u.lng,d.lng,p.lng),Math.min(h.lat,u.lat,d.lat,p.lat)],m=[Math.max(h.lng,u.lng,d.lng,p.lng),Math.max(h.lat,u.lat,d.lat,p.lat)],g=r&&r.pitch?r.pitch:this.getPitch(),_=this._cameraForBounds(this.transform,f,m,n,g,r);return this._fitInternal(_,r,s)}_fitInternal(e,i,n){return e?(delete(i=t.extend(e,i)).padding,i.linear?this.easeTo(i,n):this.flyTo(i,n)):this}jumpTo(e,i){this.stop();const n=e.preloadOnly?this.transform.clone():this.transform;let r=!1,s=!1,o=!1;return"zoom"in e&&n.zoom!==+e.zoom&&(r=!0,n.zoom=+e.zoom),void 0!==e.center&&(n.center=t.LngLat.convert(e.center)),"bearing"in e&&n.bearing!==+e.bearing&&(s=!0,n.bearing=+e.bearing),"pitch"in e&&n.pitch!==+e.pitch&&(o=!0,n.pitch=+e.pitch),null==e.padding||n.isPaddingEqual(e.padding)||(n.padding=e.padding),e.preloadOnly?(this._preloadTiles(n),this):(this.fire(new t.Event("movestart",i)).fire(new t.Event("move",i)),r&&this.fire(new t.Event("zoomstart",i)).fire(new t.Event("zoom",i)).fire(new t.Event("zoomend",i)),s&&this.fire(new t.Event("rotatestart",i)).fire(new t.Event("rotate",i)).fire(new t.Event("rotateend",i)),o&&this.fire(new t.Event("pitchstart",i)).fire(new t.Event("pitch",i)).fire(new t.Event("pitchend",i)),this.fire(new t.Event("moveend",i)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||t.warnOnce(Xr),this.transform.getFreeCameraOptions()}setFreeCameraOptions(e,i){const n=this.transform;if(!n.projection.supportsFreeCamera)return t.warnOnce(Xr),this;this.stop();const r=n.zoom,s=n.pitch,o=n.bearing;n.setFreeCameraOptions(e);const a=r!==n.zoom,l=s!==n.pitch,c=o!==n.bearing;return this.fire(new t.Event("movestart",i)).fire(new t.Event("move",i)),a&&this.fire(new t.Event("zoomstart",i)).fire(new t.Event("zoom",i)).fire(new t.Event("zoomend",i)),c&&this.fire(new t.Event("rotatestart",i)).fire(new t.Event("rotate",i)).fire(new t.Event("rotateend",i)),l&&this.fire(new t.Event("pitchstart",i)).fire(new t.Event("pitch",i)).fire(new t.Event("pitchend",i)),this.fire(new t.Event("moveend",i)),this}easeTo(e,i){this._stop(!1,e.easeId),(!1===(e=t.extend({offset:[0,0],duration:500,easing:t.ease},e)).animate||this._prefersReducedMotion(e))&&(e.duration=0);const n=this.transform,r=this.getZoom(),s=this.getBearing(),o=this.getPitch(),a=this.getPadding(),l="zoom"in e?+e.zoom:r,c="bearing"in e?this._normalizeBearing(e.bearing,s):s,h="pitch"in e?+e.pitch:o,u="padding"in e?e.padding:n.padding,d=t.Point.convert(e.offset);let p,f,m;if("globe"===n.projection.name){const i=t.MercatorCoordinate.fromLngLat(n.center),r=d.rotate(-n.angle);i.x+=r.x/n.worldSize,i.y+=r.y/n.worldSize;const s=i.toLngLat(),o=t.LngLat.convert(e.center||s);this._normalizeCenter(o),p=n.centerPoint.add(r),f=new t.Point(i.x,i.y).mult(n.worldSize),m=new t.Point(t.mercatorXfromLng(o.lng),t.mercatorYfromLat(o.lat)).mult(n.worldSize).sub(f)}else{p=n.centerPoint.add(d);const i=n.pointLocation(p),r=t.LngLat.convert(e.center||i);this._normalizeCenter(r),f=n.project(i),m=n.project(r).sub(f)}const g=n.zoomScale(l-r);let _,y;e.around&&(_=t.LngLat.convert(e.around),y=n.locationPoint(_));const v=this._zooming||l!==r,x=this._rotating||s!==c,b=this._pitching||h!==o,w=!n.isPaddingEqual(u),A=n=>A=>{if(v&&(n.zoom=t.number(r,l,A)),x&&(n.bearing=t.number(s,c,A)),b&&(n.pitch=t.number(o,h,A)),w&&(n.interpolatePadding(a,u,A),p=n.centerPoint.add(d)),_)n.setLocationAtPoint(_,y);else{const t=n.zoomScale(n.zoom-r),e=l>r?Math.min(2,g):Math.max(.5,g),i=Math.pow(e,1-A),s=n.unproject(f.add(m.mult(A*i)).mult(t));n.setLocationAtPoint(n.renderWorldCopies?s.wrap():s,p)}return e.preloadOnly||this._fireMoveEvents(i),n};if(e.preloadOnly){const t=this._emulate(A,e.duration,n);return this._preloadTiles(t),this}const T={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=v,this._rotating=x,this._pitching=b,this._padding=w,this._easeId=e.easeId,this._prepareEase(i,e.noMoveStart,T),this._ease(A(n),(t=>{n.recenterOnTerrain(),this._afterEase(i,t)}),e),this}_prepareEase(e,i,n={}){this._moving=!0,this.transform.cameraElevationReference="sea",i||n.moving||this.fire(new t.Event("movestart",e)),this._zooming&&!n.zooming&&this.fire(new t.Event("zoomstart",e)),this._rotating&&!n.rotating&&this.fire(new t.Event("rotatestart",e)),this._pitching&&!n.pitching&&this.fire(new t.Event("pitchstart",e))}_fireMoveEvents(e){this.fire(new t.Event("move",e)),this._zooming&&this.fire(new t.Event("zoom",e)),this._rotating&&this.fire(new t.Event("rotate",e)),this._pitching&&this.fire(new t.Event("pitch",e))}_afterEase(e,i){if(this._easeId&&i&&this._easeId===i)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const n=this._zooming,r=this._rotating,s=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,n&&this.fire(new t.Event("zoomend",e)),r&&this.fire(new t.Event("rotateend",e)),s&&this.fire(new t.Event("pitchend",e)),this.fire(new t.Event("moveend",e))}flyTo(e,i){if(this._prefersReducedMotion(e)){const n=t.pick(e,["center","zoom","bearing","pitch","around"]);return this.jumpTo(n,i)}this.stop(),e=t.extend({offset:[0,0],speed:1.2,curve:1.42,easing:t.ease},e);const n=this.transform,r=this.getZoom(),s=this.getBearing(),o=this.getPitch(),a=this.getPadding(),l="zoom"in e?t.clamp(+e.zoom,n.minZoom,n.maxZoom):r,c="bearing"in e?this._normalizeBearing(e.bearing,s):s,h="pitch"in e?+e.pitch:o,u="padding"in e?e.padding:n.padding,d=n.zoomScale(l-r),p=t.Point.convert(e.offset);let f=n.centerPoint.add(p);const m=n.pointLocation(f),g=t.LngLat.convert(e.center||m);this._normalizeCenter(g);const _=n.project(m),y=n.project(g).sub(_);let v=e.curve;const x=Math.max(n.width,n.height),b=x/d,w=y.mag();if("minZoom"in e){const i=t.clamp(Math.min(e.minZoom,r,l),n.minZoom,n.maxZoom),s=x/n.zoomScale(i-r);v=Math.sqrt(s/w*2)}const A=v*v;function T(t){const e=(b*b-x*x+(t?-1:1)*A*A*w*w)/(2*(t?b:x)*A*w);return Math.log(Math.sqrt(e*e+1)-e)}function M(t){return(Math.exp(t)-Math.exp(-t))/2}function S(t){return(Math.exp(t)+Math.exp(-t))/2}const E=T(0);let C=function(t){return S(E)/S(E+v*t)},I=function(t){return x*((S(E)*(M(e=E+v*t)/S(e))-M(E))/A)/w;var e},P=(T(1)-E)/v;if(Math.abs(w)<1e-6||!isFinite(P)){if(Math.abs(x-b)<1e-6)return this.easeTo(e,i);const t=b<x?-1:1;P=Math.abs(Math.log(b/x))/v,I=function(){return 0},C=function(e){return Math.exp(t*v*e)}}e.duration="duration"in e?+e.duration:1e3*P/("screenSpeed"in e?+e.screenSpeed/v:+e.speed),e.maxDuration&&e.duration>e.maxDuration&&(e.duration=0);const L=s!==c,R=h!==o,B=!n.isPaddingEqual(u),D=n=>d=>{const m=d*P,v=1/C(m);n.zoom=1===d?l:r+n.scaleZoom(v),L&&(n.bearing=t.number(s,c,d)),R&&(n.pitch=t.number(o,h,d)),B&&(n.interpolatePadding(a,u,d),f=n.centerPoint.add(p));const x=1===d?g:n.unproject(_.add(y.mult(I(m))).mult(v));return n.setLocationAtPoint(n.renderWorldCopies?x.wrap():x,f),n._updateCameraOnTerrain(),e.preloadOnly||this._fireMoveEvents(i),n};if(e.preloadOnly){const t=this._emulate(D,e.duration,n);return this._preloadTiles(t),this}return this._zooming=!0,this._rotating=L,this._pitching=R,this._padding=B,this._prepareEase(i,!1),this._ease(D(n),(()=>this._afterEase(i)),e),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(t,e){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const t=this._onEaseEnd;this._onEaseEnd=void 0,t.call(this,e)}if(!t){const t=this.handlers;t&&t.stop(!1)}return this}_ease(e,i,n){!1===n.animate||0===n.duration?(e(1),i()):(this._easeStart=t.exported.now(),this._easeOptions=n,this._onEaseFrame=e,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const e=Math.min((t.exported.now()-this._easeStart)/this._easeOptions.duration,1),i=this._onEaseFrame;i&&i(this._easeOptions.easing(e)),e<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(e,i){e=t.wrap(e,-180,180);const n=Math.abs(e-i);return Math.abs(e-360-i)<n&&(e-=360),Math.abs(e+360-i)<n&&(e+=360),e}_normalizeCenter(t){const e=this.transform;if(!e.renderWorldCopies||e.maxBounds)return;const i=t.lng-e.center.lng;t.lng+=i>180?-360:i<-180?360:0}_prefersReducedMotion(e){return this._respectPrefersReducedMotion&&t.exported.prefersReducedMotion&&!(e&&e.essential)}_emulate(t,e,i){const n=Math.ceil(15*e/1e3),r=[],s=t(i.clone());for(let t=0;t<=n;t++){const e=s(t/n);r.push(e.clone())}return r}}class Jr{constructor(e={}){this.options=e,t.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const e=this.options&&this.options.compact;return this._map=t,this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=s("button","mapboxgl-ctrl-attrib-button",this._container),s("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=s("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),e&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===e&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(t,e){const i=this._map._getUIString(`AttributionControl.${e}`);t.setAttribute("aria-label",i),t.removeAttribute("title"),t.firstElementChild&&t.firstElementChild.setAttribute("title",i)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let e=this._editLink;e||(e=this._editLink=this._container.querySelector(".mapbox-improve-map"));const i=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||t.config.ACCESS_TOKEN}];if(e){const n=i.reduce(((t,e,n)=>(e.value&&(t+=`${e.key}=${e.value}${n<i.length-1?"&":""}`),t)),"?");e.href=`${t.config.FEEDBACK_URL}/${n}#${Kn(this._map,!0)}`,e.rel="noopener nofollow",this._setElementTitle(e,"MapFeedback")}}_updateData(t){!t||"metadata"!==t.sourceDataType&&"visibility"!==t.sourceDataType&&"style"!==t.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const t=this._map.style.stylesheet;this.styleOwner=t.owner,this.styleId=t.id}const e=this._map.style._sourceCaches;for(const i in e){const n=e[i];if(n.used){const e=n.getSource();e.attribution&&t.indexOf(e.attribution)<0&&t.push(e.attribution)}}t.sort(((t,e)=>t.length-e.length)),t=t.filter(((e,i)=>{for(let n=i+1;n<t.length;n++)if(t[n].indexOf(e)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const i=t.join(" | ");i!==this._attribHTML&&(this._attribHTML=i,t.length?(this._innerContainer.innerHTML=i,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Yr{constructor(){t.bindAll(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=s("div","mapboxgl-ctrl");const e=s("a","mapboxgl-ctrl-logo");return e.target="_blank",e.rel="noopener nofollow",e.href="https://www.mapbox.com/",e.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),e.setAttribute("rel","noopener nofollow"),this._container.appendChild(e),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&"metadata"!==t.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(0===Object.entries(t).length)return!0;for(const e in t){const i=t[e].getSource();if(i.hasOwnProperty("mapbox_logo")&&!i.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const e=t[0];this._map.getCanvasContainer().offsetWidth<250?e.classList.add("mapboxgl-compact"):e.classList.remove("mapboxgl-compact")}}}class $r{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const e=++this._id;return this._queue.push({callback:t,id:e,cancelled:!1}),e}remove(t){const e=this._currentlyRunning,i=e?this._queue.concat(e):this._queue;for(const e of i)if(e.id===t)return void(e.cancelled=!0)}run(t=0){const e=this._currentlyRunning=this._queue;this._queue=[];for(const i of e)if(!i.cancelled&&(i.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Kr(e,i,n){if(e=new t.LngLat(e.lng,e.lat),i){const r=new t.LngLat(e.lng-360,e.lat),s=new t.LngLat(e.lng+360,e.lat),o=360*Math.ceil(Math.abs(e.lng-n.center.lng)/360),a=n.locationPoint(e).distSqr(i),l=i.x<0||i.y<0||i.x>n.width||i.y>n.height;n.locationPoint(r).distSqr(i)<a&&(l||Math.abs(r.lng-n.center.lng)<o)?e=r:n.locationPoint(s).distSqr(i)<a&&(l||Math.abs(s.lng-n.center.lng)<o)&&(e=s)}for(;Math.abs(e.lng-n.center.lng)>180;){const t=n.locationPoint(e);if(t.x>=0&&t.y>=0&&t.x<=n.width&&t.y<=n.height)break;e.lng>n.center.lng?e.lng-=360:e.lng+=360}return e}const Qr={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class ts extends t.Evented{constructor(e,i){if(super(),(e instanceof t.window.HTMLElement||i)&&(e=t.extend({element:e},i)),t.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=e&&e.anchor||"center",this._color=e&&e.color||"#3FB1CE",this._scale=e&&e.scale||1,this._draggable=e&&e.draggable||!1,this._clickTolerance=e&&e.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=e&&e.rotation||0,this._rotationAlignment=e&&e.rotationAlignment||"auto",this._pitchAlignment=e&&e.pitchAlignment&&e.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=e&&e.occludedOpacity||.2,e&&e.element)this._element=e.element,this._offset=t.Point.convert(e&&e.offset||[0,0]);else{this._defaultMarker=!0,this._element=s("div");const i=41,n=27,r=o("svg",{display:"block",height:i*this._scale+"px",width:n*this._scale+"px",viewBox:`0 0 ${n} ${i}`},this._element),a=o("radialGradient",{id:"shadowGradient"},o("defs",{},r));o("stop",{offset:"10%","stop-opacity":.4},a),o("stop",{offset:"100%","stop-opacity":.05},a),o("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},r),o("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},r),o("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},r),o("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},r),this._offset=t.Point.convert(e&&e.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(t=>{t.preventDefault()})),this._element.addEventListener("mousedown",(t=>{t.preventDefault()}));const n=this._element.classList;for(const t in Qr)n.remove(`mapboxgl-marker-anchor-${t}`);n.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(e){return this._lngLat=t.LngLat.convert(e),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const e=38.1,i=13.5,n=Math.sqrt(Math.pow(i,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-e],"bottom-left":[n,-1*(e-i+n)],"bottom-right":[-n,-1*(e-i+n)],left:[i,-1*(e-i)],right:[-i,-1*(e-i)]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const e=t.code,i=t.charCode||t.keyCode;"Space"!==e&&"Enter"!==e&&32!==i&&13!==i||this.togglePopup()}_onMapClick(t){const e=t.originalEvent.target,i=this._element;this._popup&&(e===i||i.contains(e))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,e=this._pos;if(!t||!e)return!1;const i=t.unproject(e),n=t.getFreeCameraOptions();if(!n.position)return!1;const r=n.position.toLngLat();return r.distanceTo(i)<.9*r.distanceTo(this._lngLat)}_evaluateOpacity(){const e=this._map;if(!e)return;const i=this._pos;if(!i||i.x<0||i.x>e.transform.width||i.y<0||i.y>e.transform.height)return void this._clearFadeTimer();const n=e.unproject(i);let r;e._showingGlobe()&&t.isLngLatBehindGlobe(e.transform,this._lngLat)?r=0:(r=1-e._queryFogOpacity(n),e.transform._terrainEnabled()&&e.getTerrain()&&this._behindTerrain()&&(r*=this._occludedOpacity)),this._element.style.opacity=`${r}`,this._element.style.pointerEvents=r>0?"auto":"none",this._popup&&this._popup._setOpacity(r),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const e=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${t.x}px,${t.y}px)\n            ${Qr[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${e.x}px,${e.y}px)\n        `}_calculateXYTransform(){const e=this._pos,i=this._map,n=this.getPitchAlignment();if(!i||!e||"map"!==n)return"";if(!i._showingGlobe()){const t=i.getPitch();return t?`rotateX(${t}deg)`:""}const r=t.radToDeg(t.globeTiltAtLngLat(i.transform,this._lngLat)),s=e.sub(t.globeCenterToScreenPoint(i.transform)),o=Math.abs(s.x)+Math.abs(s.y);if(0===o)return"";const a=r/o;return`rotateX(${-s.y*a}deg) rotateY(${s.x*a}deg)`}_calculateZTransform(){const e=this._pos,i=this._map;if(!i||!e)return"";let n=0;const r=this.getRotationAlignment();if("map"===r)if(i._showingGlobe()){const e=i.project(new t.LngLat(this._lngLat.lng,this._lngLat.lat+.001)),r=i.project(new t.LngLat(this._lngLat.lng,this._lngLat.lat-.001)).sub(e);n=t.radToDeg(Math.atan2(r.y,r.x))-90}else n=-i.getBearing();else if("horizon"===r){const r=t.smoothstep(4,6,i.getZoom()),s=t.globeCenterToScreenPoint(i.transform);s.y+=r*i.transform.height;const o=e.sub(s),a=t.radToDeg(Math.atan2(o.y,o.x));n=(a>90?a-270:a+90)*(1-r)}return n+=this._rotation,n?`rotateZ(${n}deg)`:""}_update(e){t.window.cancelAnimationFrame(this._updateFrameId);const i=this._map;i&&(i.transform.renderWorldCopies&&(this._lngLat=Kr(this._lngLat,this._pos,i.transform)),this._pos=i.project(this._lngLat),!0===e?this._updateFrameId=t.window.requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),i._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(i._showingGlobe()||i.getTerrain()||i.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(e){return this._offset=t.Point.convert(e),this._update(),this}_onMove(e){const i=this._map;if(!i)return;const n=this._pointerdownPos,r=this._positionDelta;if(n&&r){if(!this._isDragging){const t=this._clickTolerance||i._clickTolerance;if(e.point.dist(n)<t)return;this._isDragging=!0}this._pos=e.point.sub(r),this._lngLat=i.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new t.Event("dragstart"))),this.fire(new t.Event("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const e=this._map;e&&(e.off("mousemove",this._onMove),e.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new t.Event("dragend")),this._state="inactive"}_addDragHandler(t){const e=this._map,i=this._pos;e&&i&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(i),this._pointerdownPos=t.point,this._state="pending",e.on("mousemove",this._onMove),e.on("touchmove",this._onMove),e.once("mouseup",this._onUp),e.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const e=this._map;return e&&(t?(e.on("mousedown",this._addDragHandler),e.on("touchstart",this._addDragHandler)):(e.off("mousedown",this._addDragHandler),e.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const es={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},is=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function ns(e=new t.Point(0,0),i="bottom"){if("number"==typeof e){const n=Math.round(Math.sqrt(.5*Math.pow(e,2)));switch(i){case"top":return new t.Point(0,e);case"top-left":return new t.Point(n,n);case"top-right":return new t.Point(-n,n);case"bottom":return new t.Point(0,-e);case"bottom-left":return new t.Point(n,-n);case"bottom-right":return new t.Point(-n,-n);case"left":return new t.Point(e,0);case"right":return new t.Point(-e,0)}return new t.Point(0,0)}return e instanceof t.Point||Array.isArray(e)?t.Point.convert(e):t.Point.convert(e[i]||[0,0])}class rs{constructor(t){this.jumpTo(t)}getValue(e){if(e<=this._startTime)return this._start;if(e>=this._endTime)return this._end;const i=t.easeCubicInOut((e-this._startTime)/(this._endTime-this._startTime));return this._start*(1-i)+this._end*i}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,e,i){this._start=this.getValue(e),this._end=t,this._startTime=e,this._endTime=e+i}}const ss={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},os={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0},as={showCompass:!0,showZoom:!0,visualizePitch:!1};class ls{constructor(e,i,n=!1){this._clickTolerance=10,this.element=i,this.mouseRotate=new xr({clickTolerance:e.dragRotate._mouseRotate._clickTolerance}),this.map=e,n&&(this.mousePitch=new br({clickTolerance:e.dragRotate._mousePitch._clickTolerance})),t.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),i.addEventListener("mousedown",this.mousedown),i.addEventListener("touchstart",this.touchstart,{passive:!1}),i.addEventListener("touchmove",this.touchmove),i.addEventListener("touchend",this.touchend),i.addEventListener("touchcancel",this.reset)}down(t,e){this.mouseRotate.mousedown(t,e),this.mousePitch&&this.mousePitch.mousedown(t,e),h()}move(t,e){const i=this.map,n=this.mouseRotate.mousemoveWindow(t,e),r=n&&n.bearingDelta;if(r&&i.setBearing(i.getBearing()+r),this.mousePitch){const n=this.mousePitch.mousemoveWindow(t,e),r=n&&n.pitchDelta;r&&i.setPitch(i.getPitch()+r)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){u(),t.window.removeEventListener("mousemove",this.mousemove),t.window.removeEventListener("mouseup",this.mouseup)}mousedown(e){this.down(t.extend({},e,{ctrlKey:!0,preventDefault:()=>e.preventDefault()}),f(this.element,e)),t.window.addEventListener("mousemove",this.mousemove),t.window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,f(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){1!==t.targetTouches.length?this.reset():(this._startPos=this._lastPos=m(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){1!==t.targetTouches.length?this.reset():(this._lastPos=m(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){0===t.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const cs={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},hs={maxWidth:100,unit:"metric"},us={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},ds={version:t.version,supported:i,setRTLTextPlugin:t.setRTLTextPlugin,getRTLTextPluginStatus:t.getRTLTextPluginStatus,Map:class extends Zr{constructor(e){if(t.LivePerformanceUtils.mark(t.PerformanceMarkers.create),null!=(e=t.extend({},os,e)).minZoom&&null!=e.maxZoom&&e.minZoom>e.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=e.minPitch&&null!=e.maxPitch&&e.minPitch>e.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=e.minPitch&&e.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=e.maxPitch&&e.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(e.antialias&&t.isSafariWithAntialiasingBug(t.window)&&(e.antialias=!1,t.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Jn(e.minZoom,e.maxZoom,e.minPitch,e.maxPitch,e.renderWorldCopies),e),this._interactive=e.interactive,this._minTileCacheSize=e.minTileCacheSize,this._maxTileCacheSize=e.maxTileCacheSize,this._failIfMajorPerformanceCaveat=e.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=e.preserveDrawingBuffer,this._antialias=e.antialias,this._useWebGL2=e.useWebGL2,this._trackResize=e.trackResize,this._bearingSnap=e.bearingSnap,this._refreshExpiredTiles=e.refreshExpiredTiles,this._fadeDuration=e.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=e.crossSourceCollisions,this._collectResourceTiming=e.collectResourceTiming,this._optimizeForTerrain=e.optimizeForTerrain,this._language=this._parseLanguage(e.language),this._worldview=e.worldview,this._renderTaskQueue=new $r,this._domRenderTaskQueue=new $r,this._controls=[],this._markers=[],this._popups=[],this._mapId=t.uniqueId(),this._locale=t.extend({},ss,e.locale),this._clickTolerance=e.clickTolerance,this._cooperativeGestures=e.cooperativeGestures,this._performanceMetricsCollection=e.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new rs(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new t.RequestManager(e.transformRequest,e.accessToken,e.testMode),this._silenceAuthErrors=!!e.testMode,"string"==typeof e.container){if(this._container=t.window.document.getElementById(e.container),!this._container)throw new Error(`Container '${e.container}' not found.`)}else{if(!(e.container instanceof t.window.HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=e.container}if(this._container.childNodes.length>0&&t.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),e.maxBounds&&this.setMaxBounds(e.maxBounds),t.bindAll(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),void 0!==t.window&&(t.window.addEventListener("online",this._onWindowOnline,!1),t.window.addEventListener("resize",this._onWindowResize,!1),t.window.addEventListener("orientationchange",this._onWindowResize,!1),t.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1),t.window.addEventListener("visibilitychange",this._onVisibilityChange,!1)),this.handlers=new qr(this,e),this._localFontFamily=e.localFontFamily,this._localIdeographFontFamily=e.localIdeographFontFamily,e.style&&this.setStyle(e.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),e.projection&&this.setProjection(e.projection),this._hash=e.hash&&new $n("string"==typeof e.hash&&e.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:e.center,zoom:e.zoom,bearing:e.bearing,pitch:e.pitch}),e.bounds&&(this.resize(),this.fitBounds(e.bounds,t.extend({},e.fitBoundsOptions,{duration:0})))),this.resize(),e.attributionControl&&this.addControl(new Jr({customAttribution:e.customAttribution})),this._logoControl=new Yr,this.addControl(this._logoControl,e.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet)})),this.on("data",(e=>{this._update("style"===e.dataType),this.fire(new t.Event(`${e.dataType}data`,e))})),this.on("dataloading",(e=>{this.fire(new t.Event(`${e.dataType}dataloading`,e))}))}_getMapId(){return this._mapId}addControl(e,i){if(void 0===i&&(i=e.getDefaultPosition?e.getDefaultPosition():"top-right"),!e||!e.onAdd)return this.fire(new t.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=e.onAdd(this);this._controls.push(e);const r=this._controlPositions[i];return-1!==i.indexOf("bottom")?r.insertBefore(n,r.firstChild):r.appendChild(n),this}removeControl(e){if(!e||!e.onRemove)return this.fire(new t.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(e);return i>-1&&this._controls.splice(i,1),e.onRemove(this),this}hasControl(t){return this._controls.indexOf(t)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(e){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new t.Event("movestart",e)).fire(new t.Event("move",e)),this.fire(new t.Event("resize",e)),i&&this.fire(new t.Event("moveend",e)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(e){return this.transform.setMaxBounds(t.LngLatBounds.convert(e)),this._update()}setMinZoom(e){if((e=null==e?-2:e)>=-2&&e<=this.transform.maxZoom)return this.transform.minZoom=e,this._update(),this.getZoom()<e?this.setZoom(e):this.fire(new t.Event("zoomstart")).fire(new t.Event("zoom")).fire(new t.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(e){if((e=null==e?22:e)>=this.transform.minZoom)return this.transform.maxZoom=e,this._update(),this.getZoom()>e?this.setZoom(e):this.fire(new t.Event("zoomstart")).fire(new t.Event("zoom")).fire(new t.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(e){if((e=null==e?0:e)<0)throw new Error("minPitch must be greater than or equal to 0");if(e>=0&&e<=this.transform.maxPitch)return this.transform.minPitch=e,this._update(),this.getPitch()<e?this.setPitch(e):this.fire(new t.Event("pitchstart")).fire(new t.Event("pitch")).fire(new t.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(e){if((e=null==e?85:e)>85)throw new Error("maxPitch must be less than or equal to 85");if(e>=this.transform.minPitch)return this.transform.maxPitch=e,this._update(),this.getPitch()>e?this.setPitch(e):this.fire(new t.Event("pitchstart")).fire(new t.Event("pitch")).fire(new t.Event("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(t){return this.transform.renderWorldCopies=t,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(e){return"auto"===e?t.window.navigator.language:Array.isArray(e)?0===e.length?void 0:e.map((e=>"auto"===e?t.window.navigator.language:e)):e}setLanguage(t){const e=this._parseLanguage(t);if(!this.style||e===this._language)return this;this._language=e,this.style._reloadSources();for(const t of this._controls)t._setLanguage&&t._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(t){return this.style&&t!==this._worldview?(this._worldview=t,this.style._reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(t){return this._lazyInitEmptyStyle(),t?"string"==typeof t&&(t={name:t}):t=null,this._useExplicitProjection=!!t,this._prioritizeAndUpdateProjection(t,this.style.stylesheet?this.style.stylesheet.projection:null)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const e=this.transform,i=e.projection.name;let n;"globe"===i&&e.zoom>=t.GLOBE_ZOOM_THRESHOLD_MAX?(e.setMercatorFromTransition(),n=!0):"mercator"===i&&e.zoom<t.GLOBE_ZOOM_THRESHOLD_MAX&&(e.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(t,e){return this._updateProjection(t||e||{name:"mercator"})}_updateProjection(e){let i;if(i="globe"===e.name&&this.transform.zoom>=t.GLOBE_ZOOM_THRESHOLD_MAX?this.transform.setMercatorFromTransition():this.transform.setProjection(e),this.style.applyProjectionUpdate(),i){this.painter.clearBackgroundTiles();for(const t in this.style._sourceCaches)this.style._sourceCaches[t].clearTiles();this._update(!0),this._forceMarkerAndPopupUpdate(!0)}return this}project(e){return this.transform.locationPoint3D(t.LngLat.convert(e))}unproject(e){return this.transform.pointLocation3D(t.Point.convert(e))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(t,e,i){if("mouseenter"===t||"mouseover"===t){let n=!1;const r=r=>{const s=e.filter((t=>this.getLayer(t))),o=s.length?this.queryRenderedFeatures(r.point,{layers:s}):[];o.length?n||(n=!0,i.call(this,new ar(t,this,r.originalEvent,{features:o}))):n=!1},s=()=>{n=!1};return{layers:new Set(e),listener:i,delegates:{mousemove:r,mouseout:s}}}if("mouseleave"===t||"mouseout"===t){let n=!1;const r=r=>{const s=e.filter((t=>this.getLayer(t)));(s.length?this.queryRenderedFeatures(r.point,{layers:s}):[]).length?n=!0:n&&(n=!1,i.call(this,new ar(t,this,r.originalEvent)))},s=e=>{n&&(n=!1,i.call(this,new ar(t,this,e.originalEvent)))};return{layers:new Set(e),listener:i,delegates:{mousemove:r,mouseout:s}}}{const n=t=>{const n=e.filter((t=>this.getLayer(t))),r=n.length?this.queryRenderedFeatures(t.point,{layers:n}):[];r.length&&(t.features=r,i.call(this,t),delete t.features)};return{layers:new Set(e),listener:i,delegates:{[t]:n}}}}on(t,e,i){if(void 0===i)return super.on(t,e);Array.isArray(e)||(e=[e]);const n=this._createDelegatedListener(t,e,i);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[t]=this._delegatedListeners[t]||[],this._delegatedListeners[t].push(n);for(const t in n.delegates)this.on(t,n.delegates[t]);return this}once(t,e,i){if(void 0===i)return super.once(t,e);Array.isArray(e)||(e=[e]);const n=this._createDelegatedListener(t,e,i);for(const t in n.delegates)this.once(t,n.delegates[t]);return this}off(t,e,i){if(void 0===i)return super.off(t,e);e=new Set(Array.isArray(e)?e:[e]);const n=(t,e)=>{if(t.size!==e.size)return!1;for(const i of t)if(!e.has(i))return!1;return!0},r=this._delegatedListeners?this._delegatedListeners[t]:void 0;return r&&(t=>{for(let r=0;r<t.length;r++){const s=t[r];if(s.listener===i&&n(s.layers,e)){for(const t in s.delegates)this.off(t,s.delegates[t]);return t.splice(r,1),this}}})(r),this}queryRenderedFeatures(e,i){return this.style?(void 0!==i||void 0===e||e instanceof t.Point||Array.isArray(e)||(i=e,e=void 0),this.style.queryRenderedFeatures(e=e||[[0,0],[this.transform.width,this.transform.height]],i=i||{},this.transform)):[]}querySourceFeatures(t,e){return this.style.querySourceFeatures(t,e)}isPointOnSurface(e){const{name:i}=this.transform.projection;return"globe"!==i&&"mercator"!==i&&t.warnOnce(`${i} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(t.Point.convert(e))}setStyle(e,i){return!1!==(i=t.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i)).diff&&i.localIdeographFontFamily===this._localIdeographFontFamily&&i.localFontFamily===this._localFontFamily&&this.style&&e?(this._diffStyle(e,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(e,i))}_getUIString(t){const e=this._locale[t];if(null==e)throw new Error(`Missing UI string '${t}'`);return e}_updateStyle(t,e){return this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),t&&(this.style=new $e(this,e||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof t?this.style.loadURL(t):this.style.loadJSON(t)),this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new $e(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(e,i){if("string"==typeof e){const n=this._requestManager.normalizeStyleURL(e),r=this._requestManager.transformRequest(n,t.ResourceType.Style);t.getJSON(r,((e,n)=>{e?this.fire(new t.ErrorEvent(e)):n&&this._updateDiff(n,i)}))}else"object"==typeof e&&this._updateDiff(e,i)}_updateDiff(e,i){try{this.style.setState(e)&&this._update(!0)}catch(n){t.warnOnce(`Unable to perform style diff: ${n.message||n.error||n}.  Rebuilding the style from scratch.`),this._updateStyle(e,i)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(t.warnOnce("There is no style added to the map."),!1)}addSource(t,e){return this._lazyInitEmptyStyle(),this.style.addSource(t,e),this._update(!0)}isSourceLoaded(t){return!!this.style&&this.style._isSourceCacheLoaded(t)}areTilesLoaded(){const t=this.style&&this.style._sourceCaches;for(const e in t){const i=t[e]._tiles;for(const t in i){const e=i[t];if("loaded"!==e.state&&"errored"!==e.state)return!1}}return!0}addSourceType(t,e,i){this._lazyInitEmptyStyle(),this.style.addSourceType(t,e,i)}removeSource(t){return this.style.removeSource(t),this._updateTerrain(),this._update(!0)}getSource(t){return this.style.getSource(t)}addImage(e,i,{pixelRatio:n=1,sdf:r=!1,stretchX:s,stretchY:o,content:a}={}){if(this._lazyInitEmptyStyle(),i instanceof t.window.HTMLImageElement||t.window.ImageBitmap&&i instanceof t.window.ImageBitmap){const{width:l,height:c,data:h}=t.exported.getImageData(i);this.style.addImage(e,{data:new t.RGBAImage({width:l,height:c},h),pixelRatio:n,stretchX:s,stretchY:o,content:a,sdf:r,version:0})}else if(void 0===i.width||void 0===i.height)this.fire(new t.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:l,height:c}=i,h=i;this.style.addImage(e,{data:new t.RGBAImage({width:l,height:c},new Uint8Array(h.data)),pixelRatio:n,stretchX:s,stretchY:o,content:a,sdf:r,version:0,userImage:h}),h.onAdd&&h.onAdd(this,e)}}updateImage(e,i){const n=this.style.getImage(e);if(!n)return void this.fire(new t.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const r=i instanceof t.window.HTMLImageElement||t.window.ImageBitmap&&i instanceof t.window.ImageBitmap?t.exported.getImageData(i):i,{width:s,height:o}=r;void 0!==s&&void 0!==o?s===n.data.width&&o===n.data.height?(n.data.replace(r.data,!(i instanceof t.window.HTMLImageElement||t.window.ImageBitmap&&i instanceof t.window.ImageBitmap)),this.style.updateImage(e,n)):this.fire(new t.ErrorEvent(new Error(`The width and height of the updated image (${s}, ${o})\n                must be that same as the previous version of the image\n                (${n.data.width}, ${n.data.height})`))):this.fire(new t.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")))}hasImage(e){return e?!!this.style.getImage(e):(this.fire(new t.ErrorEvent(new Error("Missing required image id"))),!1)}removeImage(t){this.style.removeImage(t)}loadImage(e,i){t.getImage(this._requestManager.transformRequest(e,t.ResourceType.Image),((e,n)=>{i(e,n instanceof t.window.HTMLImageElement?t.exported.getImageData(n):n)}))}listImages(){return this.style.listImages()}addLayer(t,e){return this._lazyInitEmptyStyle(),this.style.addLayer(t,e),this._update(!0)}moveLayer(t,e){return this.style.moveLayer(t,e),this._update(!0)}removeLayer(t){return this.style.removeLayer(t),this._update(!0)}getLayer(t){return this.style.getLayer(t)}setLayerZoomRange(t,e,i){return this.style.setLayerZoomRange(t,e,i),this._update(!0)}setFilter(t,e,i={}){return this.style.setFilter(t,e,i),this._update(!0)}getFilter(t){return this.style.getFilter(t)}setPaintProperty(t,e,i,n={}){return this.style.setPaintProperty(t,e,i,n),this._update(!0)}getPaintProperty(t,e){return this.style.getPaintProperty(t,e)}setLayoutProperty(t,e,i,n={}){return this.style.setLayoutProperty(t,e,i,n),this._update(!0)}getLayoutProperty(t,e){return this.style.getLayoutProperty(t,e)}setLight(t,e={}){return this._lazyInitEmptyStyle(),this.style.setLight(t,e),this._update(!0)}getLight(){return this.style.getLight()}setTerrain(t){return this._lazyInitEmptyStyle(),!t&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(t),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(t){return this._lazyInitEmptyStyle(),this.style.setFog(t),this._update(!0)}getFog(){return this.style?this.style.getFog():null}_queryFogOpacity(e){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(t.LngLat.convert(e),this.transform):0}setFeatureState(t,e){return this.style.setFeatureState(t,e),this._update()}removeFeatureState(t,e){return this.style.removeFeatureState(t,e),this._update()}getFeatureState(t){return this.style.getFeatureState(t)}_updateContainerDimensions(){if(!this._container)return;const e=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300;let n,r,s,o=this._container;for(;o&&(!r||!s);){const e=t.window.getComputedStyle(o).transform;e&&"none"!==e&&(n=e.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&"0"!==n[0]&&"1"!==n[0]&&(r=n[0]),n[3]&&"0"!==n[3]&&"1"!==n[3]&&(s=n[3])),o=o.parentElement}this._containerWidth=r?Math.abs(e/r):e,this._containerHeight=s?Math.abs(i/s):i}_detectMissingCSS(){"rgb(250, 128, 114)"!==t.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&t.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const t=this._container;t.classList.add("mapboxgl-map"),(this._missingCSSCanary=s("div","mapboxgl-canary",t)).style.visibility="hidden",this._detectMissingCSS();const e=this._canvasContainer=s("div","mapboxgl-canvas-container",t);this._interactive&&e.classList.add("mapboxgl-interactive"),this._canvas=s("canvas","mapboxgl-canvas",e),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const i=this._controlContainer=s("div","mapboxgl-control-container",t),n=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((t=>{n[t]=s("div",`mapboxgl-ctrl-${t}`,i)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(e,i){const n=t.exported.devicePixelRatio||1;this._canvas.width=n*Math.ceil(e),this._canvas.height=n*Math.ceil(i),this._canvas.style.width=`${e}px`,this._canvas.style.height=`${i}px`}_addMarker(t){this._markers.push(t)}_removeMarker(t){const e=this._markers.indexOf(t);-1!==e&&this._markers.splice(e,1)}_addPopup(t){this._popups.push(t)}_removePopup(t){const e=this._popups.indexOf(t);-1!==e&&this._popups.splice(e,1)}_setupPainter(){const e=t.extend({},i.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),n=this._useWebGL2&&this._canvas.getContext("webgl2",e),r=n||this._canvas.getContext("webgl",e)||this._canvas.getContext("experimental-webgl",e);r?(this._useWebGL2&&!n&&t.warnOnce("Failed to create WebGL 2 context. Using WebGL 1."),t.storeAuthState(r,!0),this.painter=new kn(r,this.transform,!!n),this.on("data",(t=>{"source"===t.dataType&&this.painter.setTileLoadedFlag(!0)})),t.exported$1.testSupport(r)):this.fire(new t.ErrorEvent(new Error("Failed to initialize WebGL")))}_contextLost(e){e.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new t.Event("webglcontextlost",{originalEvent:e}))}_contextRestored(e){this._setupPainter(),this.resize(),this._update(),this.fire(new t.Event("webglcontextrestored",{originalEvent:e}))}_onMapScroll(t){if(t.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(t){return this.style?(this._styleDirty=this._styleDirty||t,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(t){return this._update(),this._renderTaskQueue.add(t)}_cancelRenderFrame(t){this._renderTaskQueue.remove(t)}_requestDomTask(t){!this.loaded()||this.loaded()&&!this.isMoving()?t():this._domRenderTaskQueue.add(t)}_render(e){let i;const n=this.painter.context.extTimerQuery,r=t.exported.now();if(this.listens("gpu-timing-frame")&&(i=n.createQueryEXT(),n.beginQueryEXT(n.TIME_ELAPSED_EXT,i)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],t.window.performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],t.window.performance.now())),this._renderTaskQueue.run(e),this._domRenderTaskQueue.run(e),this._removed)return;this._updateProjectionTransition();const s=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const e=this.transform.zoom,i=this.transform.pitch,n=t.exported.now(),r=new t.EvaluationParameters(e,{now:n,fadeDuration:s,pitch:i,transition:this.style.getTransition()});this.style.update(r)}this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let o=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),o=this._updateAverageElevation(r),this.style._updateSources(this.transform),this._forceMarkerAndPopupUpdate()):o=this._updateAverageElevation(r),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,s,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:s,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new t.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new t.Event("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),i){const e=t.exported.now()-r;n.endQueryEXT(n.TIME_ELAPSED_EXT,i),setTimeout((()=>{const s=n.getQueryObjectEXT(i,n.QUERY_RESULT_EXT)/1e6;n.deleteQueryEXT(i),this.fire(new t.Event("gpu-timing-frame",{cpuTime:e,gpuTime:s})),t.window.performance.mark("frame-gpu",{startTime:r,detail:{gpuTime:s}})}),50)}if(this.listens("gpu-timing-layer")){const e=this.painter.collectGpuTimers();setTimeout((()=>{const i=this.painter.queryGpuTimers(e);this.fire(new t.Event("gpu-timing-layer",{layerTimes:i}))}),50)}if(this.listens("gpu-timing-deferred-render")){const e=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const i=this.painter.queryGpuTimeDeferredRender(e);this.fire(new t.Event("gpu-timing-deferred-render",{gpuTime:i}))}),50)}const a=this._sourcesDirty||this._styleDirty||this._placementDirty||o;if(a||this._repaint)this.triggerRepaint();else{const e=!this.isMoving()&&this.loaded();if(e&&(o=this._updateAverageElevation(r,!0)),o)this.triggerRepaint();else if(this._triggerFrame(!1),e&&(this.fire(new t.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const e=this._calculateSpeedIndex();this.fire(new t.Event("speedindexcompleted",{speedIndex:e})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||a||(this._fullyLoaded=!0,t.LivePerformanceUtils.mark(t.PerformanceMarkers.fullLoad),this._performanceMetricsCollection&&t.postPerformanceEvent(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(t){for(const e of this._markers)t&&!this.getRenderWorldCopies()&&(e._lngLat=e._lngLat.wrap()),e._update();for(const e of this._popups)!t||this.getRenderWorldCopies()||e._trackPointer||(e._lngLat=e._lngLat.wrap()),e._update()}_updateAverageElevation(t,e=!1){const i=t=>(this.transform.averageElevation=t,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);if((e||t-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(t)){const e=this.transform.averageElevation;let n=this.transform.sampleAverageElevation(),r=!1;this.transform.elevation&&(r=this.transform.elevation.exaggeration()!==this._averageElevationExaggeration,this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(n)?n=0:this._averageElevationLastSampledAt=t;const s=Math.abs(e-n);if(s>1){if(this._isInitialLoad||r)return this._averageElevation.jumpTo(n),i(n);this._averageElevation.easeTo(n,t,300)}else if(s>1e-4)return this._averageElevation.jumpTo(n),i(n)}return!!this._averageElevation.isEasing(t)&&i(this._averageElevation.getValue(t))}_authenticate(){t.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(e=>{if(e&&(e.message===t.AUTH_ERR_MSG||401===e.status)){const e=this.painter.context.gl;t.storeAuthState(e,!1),this._logoControl instanceof Yr&&this._logoControl._updateLogo(),e&&e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new t.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),t.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_updateTerrain(){const t=this._isDragging();this.painter.updateTerrain(this.style,t)}_calculateSpeedIndex(){const t=this.painter.canvasCopy(),e=this.painter.getCanvasCopiesAndTimestamps();e.timeStamps.push(performance.now());const i=this.painter.context.gl,n=i.createFramebuffer();function r(t){i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0);const e=new Uint8Array(i.drawingBufferWidth*i.drawingBufferHeight*4);return i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,e),e}return i.bindFramebuffer(i.FRAMEBUFFER,n),this._canvasPixelComparison(r(t),e.canvasCopies.map(r),e.timeStamps)}_canvasPixelComparison(t,e,i){let n=i[1]-i[0];const r=t.length/4;for(let s=0;s<e.length;s++){const o=e[s];let a=0;for(let e=0;e<o.length;e+=4)o[e]===t[e]&&o[e+1]===t[e+1]&&o[e+2]===t[e+2]&&o[e+3]===t[e+3]&&(a+=1);n+=(i[s+2]-i[s+1])*(1-a/r)}return n}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),void 0!==t.window&&(t.window.removeEventListener("resize",this._onWindowResize,!1),t.window.removeEventListener("orientationchange",this._onWindowResize,!1),t.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),t.window.removeEventListener("online",this._onWindowOnline,!1),t.window.removeEventListener("visibilitychange",this._onVisibilityChange,!1));const e=this.painter.context.gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),t.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new t.Event("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(e){this._renderNextFrame=this._renderNextFrame||e,this.style&&!this._frame&&(this._frame=t.exported.frame((t=>{const e=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,e&&this._render(t)})))}_preloadTiles(e){const i=this.style?Object.values(this.style._sourceCaches):[];return t.asyncAll(i,((t,i)=>t._preloadTiles(e,i)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(t){this._trackResize&&this.resize({originalEvent:t})._update()}_onVisibilityChange(){"hidden"===t.window.document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(t){this._showTileBoundaries!==t&&(this._showTileBoundaries=t,this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(t){this._showTerrainWireframe!==t&&(this._showTerrainWireframe=t,this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(t){this._speedIndexTiming!==t&&(this._speedIndexTiming=t,this._update())}get showPadding(){return!!this._showPadding}set showPadding(t){this._showPadding!==t&&(this._showPadding=t,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(t){this._showCollisionBoxes!==t&&(this._showCollisionBoxes=t,t?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(t){this._showOverdrawInspector!==t&&(this._showOverdrawInspector=t,this._update())}get repaint(){return!!this._repaint}set repaint(t){this._repaint!==t&&(this._repaint=t,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(t){this._vertices=t,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(t){this._showTileAABBs!==t&&(this._showTileAABBs=t,t&&this._update())}_setCacheLimits(e,i){t.setCacheLimits(e,i)}get version(){return t.version}},NavigationControl:class{constructor(e){this.options=t.extend({},as,e),this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(t.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(t=>{this._map&&this._map.zoomIn({},{originalEvent:t})})),s("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(t=>{this._map&&this._map.zoomOut({},{originalEvent:t})})),s("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(t.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(t=>{const e=this._map;e&&(this.options.visualizePitch?e.resetNorthPitch({},{originalEvent:t}):e.resetNorth({},{originalEvent:t}))})),this._compassIcon=s("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const t=this._map;if(!t)return;const e=t.getZoom(),i=e===t.getMaxZoom(),n=e===t.getMinZoom();this._zoomInButton.disabled=i,this._zoomOutButton.disabled=n,this._zoomInButton.setAttribute("aria-disabled",i.toString()),this._zoomOutButton.setAttribute("aria-disabled",n.toString())}_rotateCompassArrow(){const t=this._map;if(!t)return;const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(t.transform.pitch*(Math.PI/180)),.5)}) rotateX(${t.transform.pitch}deg) rotateZ(${t.transform.angle*(180/Math.PI)}deg)`:`rotate(${t.transform.angle*(180/Math.PI)}deg)`;t._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=e)}))}onAdd(t){return this._map=t,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),t.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&t.on("pitch",this._rotateCompassArrow),t.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ls(t,this._compass,this.options.visualizePitch)),this._container}onRemove(){const t=this._map;t&&(this._container.remove(),this.options.showZoom&&t.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&t.off("pitch",this._rotateCompassArrow),t.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(t,e){const i=s("button",t,this._container);return i.type="button",i.addEventListener("click",e),i}_setButtonTitle(t,e){if(!this._map)return;const i=this._map._getUIString(`NavigationControl.${e}`);t.setAttribute("aria-label",i),t.firstElementChild&&t.firstElementChild.setAttribute("title",i)}},GeolocateControl:class extends t.Evented{constructor(e){super(),this.options=t.extend({geolocation:t.window.navigator.geolocation},cs,e),t.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Yn(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(t){return this._map=t,this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(e){const i=(t=!!this.options.geolocation)=>{this._supportsGeolocation=t,e(t)};void 0!==this._supportsGeolocation?e(this._supportsGeolocation):void 0!==t.window.navigator.permissions?t.window.navigator.permissions.query({name:"geolocation"}).then((t=>i("denied"!==t.state))).catch((()=>i())):i()}_isOutOfMapMaxBounds(t){const e=this._map.getMaxBounds(),i=t.coords;return!!e&&(i.longitude<e.getWest()||i.longitude>e.getEast()||i.latitude<e.getSouth()||i.latitude>e.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(e){if(this._map){if(this._isOutOfMapMaxBounds(e))return this._setErrorState(),this.fire(new t.Event("outofmaxbounds",e)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=e,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(e),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(e),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new t.Event("geolocate",e)),this._finish()}}_updateCamera(e){const i=new t.LngLat(e.coords.longitude,e.coords.latitude),n=e.coords.accuracy,r=this._map.getBearing(),s=t.extend({bearing:r},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(n),s,{geolocateSource:!0})}_updateMarker(e){if(e){const i=new t.LngLat(e.coords.longitude,e.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=e.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const e=this._map.transform,i=t.mercatorZfromAltitude(1,e._center.lat)*e.worldSize,n=Math.ceil(2*this._accuracy*i);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(e){if(this._map){if(this.options.trackUserLocation)if(1===e.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===e.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new t.Event("error",e)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(e){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=s("button","mapboxgl-ctrl-geolocate",this._container),s("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===e){t.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=s("div","mapboxgl-user-location"),this._dotElement.appendChild(s("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(s("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ts({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=s("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ts({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(e=>{e.geolocateSource||"ACTIVE_LOCK"!==this._watchState||e.originalEvent&&"resize"===e.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new t.Event("trackuserlocationend")))}))}}_onDeviceOrientation(t){this._userLocationDotMarker&&(t.webkitCompassHeading?this._heading=t.webkitCompassHeading:!0===t.absolute&&(this._heading=-1*t.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return t.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new t.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new t.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new t.Event("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let t;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(t={maximumAge:6e5,timeout:0},this._noTimeout=!0):(t=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,t),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const e=()=>{t.window.addEventListener("ondeviceorientationabsolute"in t.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientation)};void 0!==t.window.DeviceMotionEvent&&"function"==typeof t.window.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then((t=>{"granted"===t&&e()})).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),t.window.removeEventListener("deviceorientation",this._onDeviceOrientation),t.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Jr,ScaleControl:class{constructor(e){this.options=t.extend({},hs,e),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(t){return!1}}(),t.bindAll(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const t=this.options.maxWidth||100,e=this._map,i=e._containerHeight/2,n=e._containerWidth/2-t/2,r=e.unproject([n,i]),s=e.unproject([n+t,i]),o=r.distanceTo(s);if("imperial"===this.options.unit){const e=3.2808*o;e>5280?this._setScale(t,e/5280,"mile"):this._setScale(t,e,"foot")}else"nautical"===this.options.unit?this._setScale(t,o/1852,"nautical-mile"):o>=1e3?this._setScale(t,o/1e3,"kilometer"):this._setScale(t,o,"meter")}_setScale(t,e,i){this._map._requestDomTask((()=>{const n=function(t){const e=Math.pow(10,`${Math.floor(t)}`.length-1);let i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:i>=1?1:function(t){const e=Math.pow(10,Math.ceil(-Math.log(t)/Math.LN10));return Math.round(t*e)/e}(i),e*i}(e),r=n/e;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==i?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:i}).format(n):`${n}&nbsp;${us[i]}`,this._container.style.width=t*r+"px"}))}onAdd(t){return this._map=t,this._language=t.getLanguage(),this._container=s("div","mapboxgl-ctrl mapboxgl-ctrl-scale",t.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(t){this._language=t,this._update()}setUnit(t){this.options.unit=t,this._update()}},FullscreenControl:class{constructor(e){this._fullscreen=!1,e&&e.container&&(e.container instanceof t.window.HTMLElement?this._container=e.container:t.warnOnce("Full screen control 'container' must be a DOM element.")),t.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in t.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in t.window.document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(e){return this._map=e,this._container||(this._container=this._map.getContainer()),this._controlContainer=s("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",t.warnOnce("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,t.window.document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!t.window.document.fullscreenEnabled&&!t.window.document.webkitFullscreenEnabled)}_setupUI(){const e=this._fullscreenButton=s("button","mapboxgl-ctrl-fullscreen",this._controlContainer);s("span","mapboxgl-ctrl-icon",e).setAttribute("aria-hidden","true"),e.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),t.window.document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const t=this._getTitle();this._fullscreenButton.setAttribute("aria-label",t),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",t)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(t.window.document.fullscreenElement||t.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?t.window.document.exitFullscreen?t.window.document.exitFullscreen():t.window.document.webkitCancelFullScreen&&t.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends t.Evented{constructor(e){super(),this.options=t.extend(Object.create(es),e),t.bindAll(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(e&&e.className?e.className.trim().split(/\s+/):[])}addTo(e){return this._map&&this.remove(),this._map=e,this.options.closeOnClick&&e.on("preclick",this._onClose),this.options.closeOnMove&&e.on("move",this._onClose),e.on("remove",this.remove),this._update(),e._addPopup(this),this._focusFirstElement(),this._trackPointer?(e.on("mousemove",this._onMouseEvent),e.on("mouseup",this._onMouseEvent),e._canvasContainer.classList.add("mapboxgl-track-pointer")):e.on("move",this._update),this.fire(new t.Event("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const e=this._map;return e&&(e.off("move",this._update),e.off("move",this._onClose),e.off("preclick",this._onClose),e.off("click",this._onClose),e.off("remove",this.remove),e.off("mousemove",this._onMouseEvent),e.off("mouseup",this._onMouseEvent),e.off("drag",this._onMouseEvent),e._canvasContainer&&e._canvasContainer.classList.remove("mapboxgl-track-pointer"),e._removePopup(this),this._map=void 0),this.fire(new t.Event("close")),this}getLngLat(){return this._lngLat}setLngLat(e){this._lngLat=t.LngLat.convert(e),this._pos=null,this._trackPointer=!1,this._update();const i=this._map;return i&&(i.on("move",this._update),i.off("mousemove",this._onMouseEvent),i._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const t=this._map;return t&&(t.off("move",this._update),t.on("mousemove",this._onMouseEvent),t.on("drag",this._onMouseEvent),t._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(e){return this.setDOMContent(t.window.document.createTextNode(e))}setHTML(e){const i=t.window.document.createDocumentFragment(),n=t.window.document.createElement("body");let r;for(n.innerHTML=e;r=n.firstChild,r;)i.appendChild(r);return this.setDOMContent(i)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(t){return this.options.maxWidth=t,this._update(),this}setDOMContent(t){let e=this._content;if(e)for(;e.hasChildNodes();)e.firstChild&&e.removeChild(e.firstChild);else e=this._content=s("div","mapboxgl-popup-content",this._container||void 0);if(e.appendChild(t),this.options.closeButton){const t=this._closeButton=s("button","mapboxgl-popup-close-button",e);t.type="button",t.setAttribute("aria-label","Close popup"),t.setAttribute("aria-hidden","true"),t.innerHTML="&#215;",t.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(t){return this._classList.add(t),this._updateClassList(),this}removeClassName(t){return this._classList.delete(t),this._updateClassList(),this}setOffset(t){return this.options.offset=t,this._update(),this}toggleClassName(t){let e;return this._classList.delete(t)?e=!1:(this._classList.add(t),e=!0),this._updateClassList(),e}_onMouseEvent(t){this._update(t.point)}_getAnchor(t){if(this.options.anchor)return this.options.anchor;const e=this._map,i=this._container,n=this._pos;if(!e||!i||!n)return"bottom";const r=i.offsetWidth,s=i.offsetHeight,o=n.x<r/2,a=n.x>e.transform.width-r/2;if(n.y+t<s)return o?"top-left":a?"top-right":"top";if(n.y>e.transform.height-s){if(o)return"bottom-left";if(a)return"bottom-right"}return o?"left":a?"right":"bottom"}_updateClassList(){const t=this._container;if(!t)return;const e=[...this._classList];e.push("mapboxgl-popup"),this._anchor&&e.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&e.push("mapboxgl-popup-track-pointer"),t.className=e.join(" ")}_update(e){const i=this._map,n=this._content;if(!i||!this._lngLat&&!this._trackPointer||!n)return;let r=this._container;if(r||(r=this._container=s("div","mapboxgl-popup",i.getContainer()),this._tip=s("div","mapboxgl-popup-tip",r),r.appendChild(n)),this.options.maxWidth&&r.style.maxWidth!==this.options.maxWidth&&(r.style.maxWidth=this.options.maxWidth),i.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Kr(this._lngLat,this._pos,i.transform)),!this._trackPointer||e){const t=this._pos=this._trackPointer&&e?e:i.project(this._lngLat),n=ns(this.options.offset),r=this._anchor=this._getAnchor(n.y),s=ns(this.options.offset,r),o=t.add(s).round();i._requestDomTask((()=>{this._container&&r&&(this._container.style.transform=`${Qr[r]} translate(${o.x}px,${o.y}px)`)}))}if(!this._marker&&i._showingGlobe()){const e=t.isLngLatBehindGlobe(i.transform,this._lngLat)?0:1;this._setOpacity(e)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const t=this._container.querySelector(is);t&&t.focus()}_onClose(){this.remove()}_setOpacity(t){this._container&&(this._container.style.opacity=`${t}`),this._content&&(this._content.style.pointerEvents=t?"auto":"none")}},Marker:ts,Style:$e,LngLat:t.LngLat,LngLatBounds:t.LngLatBounds,Point:t.Point,MercatorCoordinate:t.MercatorCoordinate,FreeCameraOptions:Gn,Evented:t.Evented,config:t.config,prewarm:function(){Nt().acquire(kt)},clearPrewarmedResources:function(){const t=zt;t&&t.isPreloaded()&&1===t.numActive()&&(t.release(kt),zt=null)},get accessToken(){return t.config.ACCESS_TOKEN},set accessToken(e){t.config.ACCESS_TOKEN=e},get baseApiUrl(){return t.config.API_URL},set baseApiUrl(e){t.config.API_URL=e},get workerCount(){return Ft.workerCount},set workerCount(t){Ft.workerCount=t},get maxParallelImageRequests(){return t.config.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(e){t.config.MAX_PARALLEL_IMAGE_REQUESTS=e},clearStorage(e){t.clearTileCache(e)},workerUrl:"",workerClass:null,setNow:t.exported.setNow,restoreNow:t.exported.restoreNow};return ds}));var r=i;return r}()}(Y);var $=Y.exports,K=Z($);var Q=6371008.8,tt={meters:Q,metres:Q,millimeters:6371008800,millimetres:6371008800,centimeters:637100880,centimetres:637100880,kilometers:6371.0088,kilometres:6371.0088,miles:3958.761333810546,nauticalmiles:Q/1852,inches:39.37*Q,yards:5825721.287490856,feet:20902260.511392,radians:1,degrees:57.22891354143274};function et(t,e,i){if(!ot(i=i||{}))throw new Error("options is invalid");var n=i.bbox,r=i.id;if(void 0===t)throw new Error("geometry is required");if(e&&e.constructor!==Object)throw new Error("properties must be an Object");n&&at(n),r&&lt(r);var s={type:"Feature"};return r&&(s.id=r),n&&(s.bbox=n),s.properties=e||{},s.geometry=t,s}function it(t,e,i){if(!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!st(t[0])||!st(t[1]))throw new Error("coordinates must contain numbers");return et({type:"Point",coordinates:t},e,i)}function nt(t,e){if(!ot(e=e||{}))throw new Error("options is invalid");var i=e.bbox,n=e.id;if(!t)throw new Error("No features passed");if(!Array.isArray(t))throw new Error("features must be an Array");i&&at(i),n&&lt(n);var r={type:"FeatureCollection"};return n&&(r.id=n),i&&(r.bbox=i),r.features=t,r}function rt(t){if(null==t)throw new Error("degrees is required");return t%360*Math.PI/180}function st(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function ot(t){return!!t&&t.constructor===Object}function at(t){if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be an Array");if(4!==t.length&&6!==t.length)throw new Error("bbox must be an Array of 4 or 6 numbers");t.forEach((function(t){if(!st(t))throw new Error("bbox must only contain numbers")}))}function lt(t){if(!t)throw new Error("id is required");if(-1===["string","number"].indexOf(typeof t))throw new Error("id must be a number or a string")}function ct(t,e,i){if(null!==t)for(var n,r,s,o,a,l,c,h,u=0,d=0,p=t.type,f="FeatureCollection"===p,m="Feature"===p,g=f?t.features.length:1,_=0;_<g;_++){a=(h=!!(c=f?t.features[_].geometry:m?t.geometry:t)&&"GeometryCollection"===c.type)?c.geometries.length:1;for(var y=0;y<a;y++){var v=0,x=0;if(null!==(o=h?c.geometries[y]:c)){l=o.coordinates;var b=o.type;switch(u=!i||"Polygon"!==b&&"MultiPolygon"!==b?0:1,b){case null:break;case"Point":if(!1===e(l,d,_,v,x))return!1;d++,v++;break;case"LineString":case"MultiPoint":for(n=0;n<l.length;n++){if(!1===e(l[n],d,_,v,x))return!1;d++,"MultiPoint"===b&&v++}"LineString"===b&&v++;break;case"Polygon":case"MultiLineString":for(n=0;n<l.length;n++){for(r=0;r<l[n].length-u;r++){if(!1===e(l[n][r],d,_,v,x))return!1;d++}"MultiLineString"===b&&v++,"Polygon"===b&&x++}"Polygon"===b&&v++;break;case"MultiPolygon":for(n=0;n<l.length;n++){for("MultiPolygon"===b&&(x=0),r=0;r<l[n].length;r++){for(s=0;s<l[n][r].length-u;s++){if(!1===e(l[n][r][s],d,_,v,x))return!1;d++}x++}v++}break;case"GeometryCollection":for(n=0;n<o.geometries.length;n++)if(!1===ct(o.geometries[n],e,i))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function ht(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var i=0;i<t.features.length&&!1!==e(t.features[i],i);i++);}var ut={exports:{}};
/*!
 * Mapbox GL JS Animated Popup v0.4.0
 * https://nagix.github.io/mapbox-gl-animated-popup
 * (c) 2020-2022 Akihiko Kusanagi
 * Released under the MIT license
 */!function(t,e){t.exports=function(t){const e=t.version.split(".").map((t=>+t)),i={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>-t*(t-2),easeInOutQuad:t=>(t/=.5)<1?.5*t*t:-.5*(--t*(t-2)-1),easeInCubic:t=>t*t*t,easeOutCubic:t=>(t-=1)*t*t+1,easeInOutCubic:t=>(t/=.5)<1?.5*t*t*t:.5*((t-=2)*t*t+2),easeInQuart:t=>t*t*t*t,easeOutQuart:t=>-((t-=1)*t*t*t-1),easeInOutQuart:t=>(t/=.5)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2),easeInQuint:t=>t*t*t*t*t,easeOutQuint:t=>(t-=1)*t*t*t*t+1,easeInOutQuint:t=>(t/=.5)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2),easeInSine:t=>1-Math.cos(t*(Math.PI/2)),easeOutSine:t=>Math.sin(t*(Math.PI/2)),easeInOutSine:t=>-.5*(Math.cos(Math.PI*t)-1),easeInExpo:t=>0===t?0:Math.pow(2,10*(t-1)),easeOutExpo:t=>1===t?1:1-Math.pow(2,-10*t),easeInOutExpo:t=>0===t?0:1===t?1:(t/=.5)<1?.5*Math.pow(2,10*(t-1)):.5*(2-Math.pow(2,-10*--t)),easeInCirc:t=>t>=1?t:-(Math.sqrt(1-t*t)-1),easeOutCirc:t=>Math.sqrt(1-(t-=1)*t),easeInOutCirc:t=>(t/=.5)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1),easeInElastic(t){let e=1.70158,i=0,n=1;return 0===t?0:1===t?1:(i||(i=.3),e=i/(2*Math.PI)*Math.asin(1/n),-n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i))},easeOutElastic(t){let e=1.70158,i=0,n=1;return 0===t?0:1===t?1:(i||(i=.3),e=i/(2*Math.PI)*Math.asin(1/n),n*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/i)+1)},easeInOutElastic(t){let e=1.70158,i=0,n=1;return 0===t?0:2==(t/=.5)?1:(i||(i=.45),e=i/(2*Math.PI)*Math.asin(1/n),t<1?n*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/i)*.5+1)},easeInBack(t){const e=1.70158;return t*t*((e+1)*t-e)},easeOutBack(t){const e=1.70158;return(t-=1)*t*((e+1)*t+e)+1},easeInOutBack(t){let e=1.70158;return(t/=.5)<1?t*t*((1+(e*=1.525))*t-e)*.5:.5*((t-=2)*t*((1+(e*=1.525))*t+e)+2)},easeInBounce:t=>1-i.easeOutBounce(1-t),easeOutBounce:t=>t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375,easeInOutBounce:t=>t<.5?.5*i.easeInBounce(2*t):.5*i.easeOutBounce(2*t-1)+.5},n={scale:(t,e,i)=>{t.transform=`scale(${i?1-e:e})`},opacity:(t,e,i)=>{t.opacity=i?1-e:e}};function r(t,e,r,s,o,a){let l;const c="string"==typeof a?n[a]||n.scale:a,h=performance.now(),u=()=>{if(l)return;const n=performance.now()-h,a=0===r?1:Math.min(n/r,1),d=i[e](a);c(t,d,s),a<1?requestAnimationFrame(u):o&&o()};return u(),()=>{l=!0}}function s(t,...e){for(const i of e)for(const e in i)"object"==typeof i[e]?(t[e]||(t[e]={}),s(t[e],i[e])):t[e]=i[e];return t}function o(t){for(const e of t.values()){const t=e.match(/mapboxgl-popup-anchor-(.+)/);if(t)return t[1].replace("-"," ")}}const a={openingAnimation:{transform:"scale",duration:1e3,easing:"easeOutElastic"},closingAnimation:{transform:"scale",duration:300,easing:"easeInBack"}};class l extends t.Popup{constructor(t){super(t),s(this.options,s({},a,t))}addTo(...t){return this._map&&this._remove(),super.addTo(...t)}_remove(){const t=this._wrapperContainer;this._cancelAnimation&&this._cancelAnimation(),t&&t.parentNode&&(t.parentNode.removeChild(t),delete this._wrapperContainer),super.remove()}remove(){if(this._wrapperContainer){const{easing:t,duration:e,transform:i}=this.options.closingAnimation;this._cancelAnimation&&this._cancelAnimation(),this._cancelAnimation=r(this._container.style,t,e,!0,(()=>{this._remove()}),i)}else super.remove();return this}_update(...t){if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;const i=this._map._requestDomTask;let n,s=this._wrapperContainer,a=this._container;Object.defineProperty(this,"_container",{configurable:!0,get:()=>a,set:t=>{const{easing:e,duration:i,transform:n}=this.options.openingAnimation;s=this._wrapperContainer=document.createElement("div"),s.className="mapboxgl-popup-wrapper",s.style.position="absolute",s.style.willChange="transform",s.style.pointerEvents="none",a=t,a.style.position="relative",this._map.getContainer().appendChild(s),s.appendChild(a),this._cancelAnimation=r(a.style,e,i,!1,null,n)}}),e[0]>=2&&e[1]>=3||e[0]>=3?this._map._requestDomTask=t=>{i.call(this._map,(()=>{n=a?a.style.transform:"scale(0)",t(),s.style.transform=a.style.transform,a.style.transform=n,a.style.transformOrigin=this._anchor?this._anchor.replace("-"," "):o(a.classList)}))}:n=a?a.style.transform:"scale(0)",super._update(...t),delete this._container,this._container=a,e[0]>=2&&e[1]>=3||e[0]>=3?this._map._requestDomTask=i:(s.style.transform=a.style.transform,a.style.transform=n,a.style.transformOrigin=o(a.classList))}}return l}($)}(ut);var dt=Z(ut.exports);const pt={instances:{},count:0,initialized:!1,init(){pt.initialized||(pt.initialized=!0,function t(){const e=pt.instances,i=Object.keys(e),n=i.length,r=performance.now();for(let t=0;t<n;t++){const n=i[t],s=e[n];if(s){const t=s.nextFrame||0;if(t<=r){const{clock:e,duration:i,frameRate:o=1/0}=s,a=e?e.getHighResTime():r,l=a-(s.start=s.start||a);s.callback&&s.callback(Math.min(l,i),i),s.nextFrame=Math.max(t+1e3/o,r),l>=i&&(s.complete&&s.complete(),pt.stop(n))}}}requestAnimationFrame(t)}())},isActive:t=>t in pt.instances,start:t=>(t.duration=N(t.duration,1/0),pt.instances[pt.count]=t,pt.count++),stop(t){const e=pt.instances;e[t]&&delete e[t]},setFrameRate(t,e){const i=pt.instances[t];i&&(e>0?i.frameRate=e:delete i.frameRate)}};var ft={exports:{}};!function(t){(function(){var e,i,n,r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T,M;_=function(t,e,i,n,r,s,o,a){var l;return(l=new Date(2e3,0,1)).setTime(t.getTime()+1e3*(60*(60*(24*(null!=n?n:0)+(null!=r?r:0))+(null!=s?s:0))+(null!=o?o:0))+(null!=a?a:0)),l.setFullYear(l.getFullYear()+(null!=e?e:0)+Math.floor((l.getMonth()+(null!=i?i:0))/12)),l.setMonth(((l.getMonth()+(null!=i?i:0))%12+12)%12),l},T=function(t){return _(t,0,0,0,9)},p=function(t){return _(t,0,0,0,-9)},M=function(t,e,i){return new Date(Date.UTC(t,e,i))},f=function(t,e,i){return p(M(t,e,i))},s=function(t){return T(t).getUTCDay()},r=function(t){return T(t).getUTCDate()},c=function(t){return T(t).getUTCMonth()},o=function(t){return T(t).getUTCFullYear()},a=function(t){return T(t).getUTCHours()},l=function(t){return T(t).getUTCMinutes()},h=function(t,e){return function(i){var n;return 1,n=f(i,t-1,1),_(n,0,0,(7-(s(n)-1))%7+7*(e-1))}},b=function(t){return new Date(31556940400*(t-1949)-6558667e5)},x=function(t){var e;return e=b(t),f(t,c(e),r(e))},v=function(t){var e;return(e={1603:23,2074:23,2355:23,2384:22}[t])?f(t,8,e):new Date(3155691e4*(t-1948)-67131691e4)},y=function(t){var e;return e=v(t),f(t,c(e),r(e))},e=[["元日",(w=function(t,e){return function(i){return f(i,t-1,e)}})(1,1),1949],["成人の日",w(1,15),1949,1999],["成人の日",h(1,2),2e3],["建国記念の日",w(2,11),1967],["天皇誕生日",w(2,23),2020],["昭和天皇の大喪の礼",w(2,24),1989,1989],["春分の日",x,1949],["皇太子明仁親王の結婚の儀",w(4,10),1959,1959],["天皇誕生日",w(4,29),1949,1988],["みどりの日",w(4,29),1989,2006],["昭和の日",w(4,29),2007],["即位の日",w(5,1),2019,2019],["憲法記念日",w(5,3),1949],["みどりの日",w(5,4),2007],["こどもの日",w(5,5),1949],["皇太子徳仁親王の結婚の儀",w(6,9),1993,1993],["海の日",w(7,20),1996,2002],["海の日",h(7,3),2003,2019],["海の日",w(7,23),2020,2020],["海の日",w(7,22),2021,2021],["海の日",h(7,3),2022],["山の日",w(8,11),2016,2019],["山の日",w(8,10),2020,2020],["山の日",w(8,8),2021,2021],["山の日",w(8,11),2022],["敬老の日",w(9,15),1966,2002],["敬老の日",h(9,3),2003],["秋分の日",y,1948],["体育の日",w(10,10),1966,1999],["体育の日",h(10,2),2e3,2019],["スポーツの日",w(7,24),2020,2020],["スポーツの日",w(7,23),2021,2021],["スポーツの日",h(10,2),2022],["即位礼正殿の儀",w(10,22),2019,2019],["文化の日",w(11,3),1948],["即位礼正殿の儀",w(11,12),1990,1990],["勤労感謝の日",w(11,23),1948],["天皇誕生日",w(12,23),1989,2018]],i=function(t){var e;if(0,t<f(1973,3,29)||0!==s(t))return null;if(e=_(t,0,0,1),!d(e,!1))return e;if(t<f(2007,0,1))return null;for(;;)if(e=_(e,0,0,1),!d(e,!1))return e},m=function(t){var e;return o(t)<1988?null:d(_(t,0,0,2),!1)?(0,1,e=_(t,0,0,1),d(e,!1)||0===s(e)||1===s(e)?null:e):null},u={true:{},false:{}},n=function(t,n){var s,o,a,l,h,d,p,g,_,y,v,x,b;if(null!=(s=u[n=!(null!=n&&!n)][t]))return s;for(b={},h=0,g=e.length;h<g;h++)null!=(a=e[h])[2]&&t<a[2]||null!=a[3]&&a[3]<t||null!=(l=a[1](t))&&(b[[y=c(l)+1,o=r(l)]]=a[0]);for(v in u[!1][t]=b,p=[],b)v=v.split(","),null!=(l=m(f(t,v[0]-1,v[1])))&&(y=c(l)+1,o=r(l),p.push([y,o]));for(d=0,_=p.length;d<_;d++)b[l=p[d]]="国民の休日";for(v in x={},b)x[v]=b[v],v=v.split(","),null!=(l=i(f(t,v[0]-1,v[1])))&&(x[[y=c(l)+1,o=r(l)]]="振替休日");return u[!0][t]=x,u[n][t]},(A=null!=(g=null!==t?t.exports:void 0)?g:this.JapaneseHolidays={}).getHolidaysOf=function(t,e){var i,r,s,o;for(i in o=[],s=n(t,e))r=s[i],o.push({month:parseInt(i.split(",")[0]),date:parseInt(i.split(",")[1]),name:r});return o.sort((function(t,e){return t.month-e.month||t.date-e.date})),o},d=function(t,e){return n(o(t),e)[[c(t)+1,r(t)]]},A.isHoliday=function(t,e){return n(t.getFullYear(),e)[[t.getMonth()+1,t.getDate()]]},A.isHolidayAt=d,A.shiftDate=_,A.u2j=T,A.j2u=p,A.jDate=f,A.uDate=M,A.getJDay=s,A.getJDate=r,A.getJMonth=c,A.getJFullYear=o,A.getJHours=a,A.getJMinutes=l,A.__forTest={shunbunWithTime:b,shubunWithTime:v}}).call(X)}(ft);var mt=Z(ft.exports);const gt={standingDuration:6e4,minStandingDuration:3e4,trainRefreshInterval:6e4,refreshTimeout:1e4,realtimeTrainCheckInterval:15e3,maxSpeedKMPH:80,accelerationKMPHPS:3,get maxSpeed(){return gt.maxSpeedKMPH/36e5},get acceleration(){return gt.accelerationKMPHPS/36e8},get maxAccelerationTime(){return gt.maxSpeed/gt.acceleration},get maxAccDistance(){return gt.maxAccelerationTime*gt.maxSpeed/2},maxFlightSpeedKMPH:500,flightAccelerationKMPHPS:12,get maxFlightSpeed(){return gt.maxFlightSpeedKMPH/36e5},get flightAcceleration(){return gt.flightAccelerationKMPHPS/36e8},minDelay:25e3,minFlightInterval:9e4,transitionDuration:300,fadeDuration:1e3,defaultCenter:[139.767,35.6814],defaultZoom:14,defaultBearing:0,defaultPitch:60,defaultEcoFrameRate:1,defaultViewMode:"ground",defaultTrackingMode:"position",defaultClockMode:"realtime",defaultEcoMode:"normal",apiUrl:{odpt:"https://api.odpt.org/api/v4/",challenge2024:"https://api-challenge2024.odpt.org/api/v4/"},tidUrl:"https://mini-tokyo.appspot.com/tid",trainInfoUrl:"https://mini-tokyo.appspot.com/traininfo",atisUrl:"https://mini-tokyo.appspot.com/atisinfo",flightUrl:"https://mini-tokyo.appspot.com/flight",dataUrl:"https://minitokyo3d.com/data",searchUrl:"https://search.minitokyo3d.com/api/v1/routes",lastStaticUpdate:"2024-09-01 03:00:00",customAttribution:'<a href="https://github.com/nagix/mini-tokyo-3d">© Akihiko Kusanagi</a>',copyright:"© 2019-2024 Akihiko Kusanagi",shareUrl:"https://minitokyo3d.com",events:["boxzoomcancel","boxzoomend","boxzoomstart","click","contextmenu","dblclick","drag","dragend","dragstart","error","load","mousedown","mousemove","mouseout","mouseover","mouseup","move","moveend","movestart","pitch","pitchend","pitchstart","resize","rotate","rotateend","rotatestart","touchcancel","touchend","touchmove","touchstart","wheel","zoom","zoomend","zoomstart"]};class _t{constructor(t,e){const i=this;i.reset(),i.setDate(t),i.setSpeed(e)}reset(){const t=this;t.baseTime=0,t.baseHighResTime=0,t.speed=1}setSpeed(t){if(isNaN(t))return;const e=this;e.baseTime=e.getTime()-Date.now()*t,e.baseHighResTime=e.getHighResTime()-performance.now()*t,e.speed=t}setDate(t){if(!(t instanceof Date))return;const e=this,i=e.baseTime,n=-e.getTimezoneOffset(),r=e.baseTime=t.getTime()+n-Date.now()*e.speed;e.baseHighResTime+=r-i}getJSTDate(t){const e=this.getTimezoneOffset();return new Date(N(t,this.getTime())+e)}getTime(t){const e=this;if(!t)return e.baseTime+Date.now()*e.speed;const i=e.getJSTDate(),n=t.split(":"),r=+n[0],s=+n[1],o=-e.getTimezoneOffset()+864e5*((i.getHours()<3?-1:0)+(r<3?1:0));return i.setHours(r,s,0,0)+o+gt.minDelay}getTimeString(t){const e=this.getJSTDate(t);return`${`0${e.getHours()}`.slice(-2)}:${`'0${e.getMinutes()}`.slice(-2)}`}getHighResTime(){return this.baseHighResTime+performance.now()*this.speed}getTimezoneOffset(){return 6e4*((new Date).getTimezoneOffset()+540)}getCalendar(){const t=this.getJSTDate(),e=t.getHours();e<3&&t.setHours(e-24);const i=t.getDay(),n=t.getFullYear(),r=t.getMonth(),s=t.getDate();return 0===i||mt.isHoliday(t)||2022===n&&11===r&&s>=30||2023===n&&0===r&&s<=3?"Holiday":6===i?"Saturday":"Weekday"}}const yt={year:"numeric",month:"short",day:"numeric",weekday:"short"},vt=[{id:"year",fn:"FullYear",digits:4,extra:0},{id:"month",fn:"Month",digits:2,extra:1},{id:"day",fn:"Date",digits:2,extra:0},{id:"hour",fn:"Hours",digits:2,extra:0},{id:"minute",fn:"Minutes",digits:2,extra:0},{id:"second",fn:"Seconds",digits:2,extra:0}];class xt extends $.Evented{constructor(t){super();const e=this;e._lang=t.lang,e._dict=t.dict,e._clock=t.clock,e._mode=t.mode||"realtime"}getDefaultPosition(){return"top-left"}onAdd(t){const e=this;return e._map=t,e._container=W("div",{className:"clock-ctrl"}),e._update(),function t(){const i=e._clock.getTime();Math.floor(i/1e3)!==Math.floor(e._lastRefresh/1e3)&&(e._refresh(),e._lastRefresh=i),e._container&&requestAnimationFrame(t)}(),e._container}onRemove(){const t=this,e=t._container;e.parentNode.removeChild(e),delete t._container,delete t._map}setMode(t){const e=this;e._mode=t,delete e._tempDate,e._editing=!1,e._update()}_onChange(){this.fire({type:"change",clock:this._clock})}_update(){const t=this,e=t._container,i=t._dict,n=t._clock,r=t._mode,s=t._editing;if(e.innerHTML=["realtime"!==r&&s?"":'<span id="date"></span><br><span id="time"></span><br>',"playback"!==r||s?"":['<div class="clock-button">',`<span><button id="edit-time-button">${i["edit-date-time"]}</button></span>`,"</div>"].join(""),"playback"===r&&s?['<div class="clock-controller">',vt.slice(0,3).map((({id:t})=>['<span class="spin-box">',`<div><button id="${t}-increase-button" class="top-button"><span class="increase-icon"></span></button></div>`,`<div id="${t}"></div>`,`<div><button id="${t}-decrease-button" class="bottom-button"><span class="decrease-icon"></span></button></div>`,"</span>"].join(""))).join('<span class="clock-controller-separator">-</span>'),'<span class="clock-controller-separator"></span>',vt.slice(-3).map((({id:t})=>['<span class="spin-box">',`<div><button id="${t}-increase-button" class="top-button"><span class="increase-icon"></span></button></div>`,`<div id="${t}"></div>`,`<div><button id="${t}-decrease-button" class="bottom-button"><span class="decrease-icon"></span></button></div>`,"</span>"].join(""))).join('<span class="clock-controller-separator">:</span>'),"</div>",'<div class="clock-button">',`<span><button id="edit-time-cancel-button">${i.cancel}</button></span>`,'<span class="clock-controller-separator"></span>',`<span><button id="edit-time-ok-button" disabled>${i.ok}</button></span>`,"</div>"].join(""):"","playback"===r?['<div class="speed-controller">','<span><button id="speed-decrease-button" class="left-button"',1===n.speed?" disabled":"",'><span class="decrease-icon"></span></button></span>',`<span id="clock-speed">${n.speed}${i["x-speed"]}</span>`,'<span><button id="speed-increase-button" class="right-button"',600===n.speed?" disabled":"",'><span class="increase-icon"></span></button></span>',"</div>"].join(""):""].join(""),t._refresh(),"playback"===r&&s&&(e.querySelector("#edit-time-cancel-button").addEventListener("click",(()=>{delete t._tempDate,t._editing=!1,t._update()})),e.querySelector("#edit-time-ok-button").addEventListener("click",(()=>{const e=t._tempDate;e&&(n.setDate(e),t._onChange(),delete t._tempDate),t._editing=!1,t._update()}))),"playback"!==r||s||e.querySelector("#edit-time-button").addEventListener("click",(()=>{t._editing=!0,t._update()})),"playback"===r&&s)for(const{id:i,fn:r}of vt)e.querySelector(`#${i}-increase-button`).addEventListener("click",(()=>{const e=t._tempDate=t._tempDate||n.getJSTDate();e[`set${r}`](e[`get${r}`]()+1),t._refresh()})),e.querySelector(`#${i}-decrease-button`).addEventListener("click",(()=>{const e=t._tempDate=t._tempDate||n.getJSTDate();e[`set${r}`](e[`get${r}`]()-1),t._refresh()}));"playback"===r&&(e.querySelector("#speed-increase-button").addEventListener("click",(t=>{let r=n.speed;r+=r<10?1:r<100?10:100,n.setSpeed(r),t.currentTarget.disabled=600===r,e.querySelector("#speed-decrease-button").disabled=!1,e.querySelector("#clock-speed").innerHTML=r+i["x-speed"]})),e.querySelector("#speed-decrease-button").addEventListener("click",(t=>{let r=n.speed;r-=r<=10?1:r<=100?10:100,n.setSpeed(r),t.currentTarget.disabled=1===r,e.querySelector("#speed-increase-button").disabled=!1,e.querySelector("#clock-speed").innerHTML=r+i["x-speed"]})))}_refresh(){const t=this,e=t._container;let i=t._clock.getJSTDate();if(t._editing){const n=t._tempDate;if(n){i=n;for(const{id:t}of vt)e.querySelector(`#${t}`).classList.add("desc-caution");e.querySelector("#edit-time-ok-button").disabled=!1}for(const{id:t,fn:n,digits:r,extra:s}of vt)e.querySelector(`#${t}`).innerHTML=`0${i[`get${n}`]()+s}`.slice(-r)}else{const n=t._lang;let r=i.toLocaleDateString(n,yt);"ja"===n&&mt.isHoliday(i)&&(r=r.replace(/\(.+\)/,"(祝)")),e.querySelector("#date").innerHTML=r,e.querySelector("#time").innerHTML=i.toLocaleTimeString(n)}}}class bt{constructor(t){this._options=t.map((t=>({className:t.className||"",title:t.title||"",eventHandler:t.eventHandler})))}onAdd(t){const e=this;return e._map=t,e._container=W("div",{className:"mapboxgl-ctrl mapboxgl-ctrl-group"}),e._buttons=e._options.map((t=>{const i=t.title,n=W("button",{className:t.className,type:"button",title:i,onclick:t.eventHandler},e._container),r=W("span",{className:"mapboxgl-ctrl-icon"},n);return n.setAttribute("aria-label",i),r.setAttribute("aria-hidden",!0),n})),e._container}onRemove(){const t=this._container;t.parentNode.removeChild(t),delete this._map}}function wt(){const t=["W5i9k8k+","fSozumk7WOWOWOhdMgjwxa1JW7HPt8obW7VcIM/cR34peSoFW6BcOSo9gmoGW7ZcI8opWRZcLg5+k8khWQxcJCkUcGZdRH3dISoGW5tdTSkODmkTW7RdS8oCW4GBjXqxWRn6W7q","W6lcMCkTyZNcGmogtZ/cPSkIWR/dMa","fSovW7DGW5FdRY1kWRddSf7dStFdTmkhWRHliwlcHCkGsCoyW7/cGbBcMhhcK8oQE351E1JdKKBdLsJcICobWQf8FCowqWjafghcPXm0W7/cRmoOW6PhWPf0WQDUWQxcGW","iXlcLSkBee/dMmo3W4ZcMSk1","qx3dLmkjWRj5WPRcOgO5rgxdLCkjW6illcNdRLRdRmoEW7RcLCktwI7cV3HjrmkRxmkoWQv4BIPAbKhdSdVdImo9xSomW5DSz8k3CG7cVCkFW7uJw8kaW71Lj8kGWRumW5FcNtOiW6iDnCo7WQNdGxVdQemMp8ohASkQWQSVW5i","uCozWQDWW5ddQIy"];return(wt=function(){return t})()}function At(t,e){const i=wt();return At=function(e,n){let r=i[e-=0];if(void 0===At.nrYKbJ){At.XVTYZg=function(t,e){let i,n,r=[],s=0,o="";for(t=function(t){let e="",i="";for(let i,n,r=0,s=0;n=t.charAt(s++);~n&&(i=r%4?64*i+n:n,r++%4)?e+=String.fromCharCode(255&i>>(-2*r&6)):0)n="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=".indexOf(n);for(let t=0,n=e.length;t<n;t++)i+="%"+("00"+e.charCodeAt(t).toString(16)).slice(-2);return decodeURIComponent(i)}(t),n=0;n<256;n++)r[n]=n;for(n=0;n<256;n++)s=(s+r[n]+e.charCodeAt(n%e.length))%256,i=r[n],r[n]=r[s],r[s]=i;n=0,s=0;for(let e=0;e<t.length;e++)n=(n+1)%256,s=(s+r[n])%256,i=r[n],r[n]=r[s],r[s]=i,o+=String.fromCharCode(t.charCodeAt(e)^r[(r[n]+r[s])%256]);return o},t=arguments,At.nrYKbJ=!0}const s=e+i[0],o=t[s];return o?r=o:(void 0===At.RGcreR&&(At.RGcreR=!0),r=At.XVTYZg(r,n),t[s]=r),r},At(t,e)}function Tt(t,e,i){const n=t.__deck;if(n.deckPicker){const t=n.pickObject({x:i.x,y:i.y,layerIds:[e]});if(t)return t.object}}function Mt(t){if(!t)throw new Error("coord is required");if("Feature"===t.type&&null!==t.geometry&&"Point"===t.geometry.type)return t.geometry.coordinates;if("Point"===t.type)return t.coordinates;if(Array.isArray(t)&&t.length>=2&&void 0===t[0].length&&void 0===t[1].length)return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function St(t){if(!t)throw new Error("coords is required");if("Feature"===t.type&&null!==t.geometry)return t.geometry.coordinates;if(t.coordinates)return t.coordinates;if(Array.isArray(t))return t;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function Et(t,e,i){if(!ot(i=i||{}))throw new Error("options is invalid");if(!0===i.final)return function(t,e){var i=Et(e,t);return i=(i+180)%360}(t,e);var n=Mt(t),r=Mt(e),s=rt(n[0]),o=rt(r[0]),a=rt(n[1]),l=rt(r[1]),c=Math.sin(o-s)*Math.cos(l),h=Math.cos(a)*Math.sin(l)-Math.sin(a)*Math.cos(l)*Math.cos(o-s);return function(t){if(null==t)throw new Error("radians is required");return t%(2*Math.PI)*180/Math.PI}(Math.atan2(c,h))}var Ct={exports:{}},It={exports:{}};!function(t,e){t.exports=function(){function t(t,n,r,s,o){!function t(i,n,r,s,o){for(;s>r;){if(s-r>600){var a=s-r+1,l=n-r+1,c=Math.log(a),h=.5*Math.exp(2*c/3),u=.5*Math.sqrt(c*h*(a-h)/a)*(l-a/2<0?-1:1);t(i,n,Math.max(r,Math.floor(n-l*h/a+u)),Math.min(s,Math.floor(n+(a-l)*h/a+u)),o)}var d=i[n],p=r,f=s;for(e(i,r,n),o(i[s],d)>0&&e(i,r,s);p<f;){for(e(i,p,f),p++,f--;o(i[p],d)<0;)p++;for(;o(i[f],d)>0;)f--}0===o(i[r],d)?e(i,r,f):e(i,++f,s),f<=n&&(r=f+1),n<=f&&(s=f-1)}}(t,n,r||0,s||t.length-1,o||i)}function e(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function i(t,e){return t<e?-1:t>e?1:0}var n=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function r(t,e,i){if(!i)return e.indexOf(t);for(var n=0;n<e.length;n++)if(i(t,e[n]))return n;return-1}function s(t,e){o(t,0,t.children.length,e,t)}function o(t,e,i,n,r){r||(r=f(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var s=e;s<i;s++){var o=t.children[s];a(r,t.leaf?n(o):o)}return r}function a(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function l(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function h(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function d(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function p(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function f(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(e,i,n,r,s){for(var o=[i,n];o.length;)if(!((n=o.pop())-(i=o.pop())<=r)){var a=i+Math.ceil((n-i)/r/2)*r;t(e,a,i,n,s),o.push(i,a,a,n)}}return n.prototype.all=function(){return this._all(this.data,[])},n.prototype.search=function(t){var e=this.data,i=[];if(!p(t,e))return i;for(var n=this.toBBox,r=[];e;){for(var s=0;s<e.children.length;s++){var o=e.children[s],a=e.leaf?n(o):o;p(t,a)&&(e.leaf?i.push(o):d(t,a)?this._all(o,i):r.push(o))}e=r.pop()}return i},n.prototype.collides=function(t){var e=this.data;if(!p(t,e))return!1;for(var i=[];e;){for(var n=0;n<e.children.length;n++){var r=e.children[n],s=e.leaf?this.toBBox(r):r;if(p(t,s)){if(e.leaf||d(t,s))return!0;i.push(r)}}e=i.pop()}return!1},n.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var n=this.data;this.data=i,i=n}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},n.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},n.prototype.clear=function(){return this.data=f([]),this},n.prototype.remove=function(t,e){if(!t)return this;for(var i,n,s,o=this.data,a=this.toBBox(t),l=[],c=[];o||l.length;){if(o||(o=l.pop(),n=l[l.length-1],i=c.pop(),s=!0),o.leaf){var h=r(t,o.children,e);if(-1!==h)return o.children.splice(h,1),l.push(o),this._condense(l),this}s||o.leaf||!d(o,a)?n?(i++,o=n.children[i],s=!1):o=null:(l.push(o),c.push(i),i=0,n=o,o=o.children[0])}return this},n.prototype.toBBox=function(t){return t},n.prototype.compareMinX=function(t,e){return t.minX-e.minX},n.prototype.compareMinY=function(t,e){return t.minY-e.minY},n.prototype.toJSON=function(){return this.data},n.prototype.fromJSON=function(t){return this.data=t,this},n.prototype._all=function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},n.prototype._build=function(t,e,i,n){var r,o=i-e+1,a=this._maxEntries;if(o<=a)return s(r=f(t.slice(e,i+1)),this.toBBox),r;n||(n=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,n-1))),(r=f([])).leaf=!1,r.height=n;var l=Math.ceil(o/a),c=l*Math.ceil(Math.sqrt(a));m(t,e,i,c,this.compareMinX);for(var h=e;h<=i;h+=c){var u=Math.min(h+c-1,i);m(t,h,u,l,this.compareMinY);for(var d=h;d<=u;d+=l){var p=Math.min(d+l-1,u);r.children.push(this._build(t,d,p,n-1))}}return s(r,this.toBBox),r},n.prototype._chooseSubtree=function(t,e,i,n){for(;n.push(e),!e.leaf&&n.length-1!==i;){for(var r=1/0,s=1/0,o=void 0,a=0;a<e.children.length;a++){var l=e.children[a],c=h(l),u=(d=t,p=l,(Math.max(p.maxX,d.maxX)-Math.min(p.minX,d.minX))*(Math.max(p.maxY,d.maxY)-Math.min(p.minY,d.minY))-c);u<s?(s=u,r=c<r?c:r,o=l):u===s&&c<r&&(r=c,o=l)}e=o||e.children[0]}var d,p;return e},n.prototype._insert=function(t,e,i){var n=i?t:this.toBBox(t),r=[],s=this._chooseSubtree(n,this.data,e,r);for(s.children.push(t),a(s,n);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(n,r,e)},n.prototype._split=function(t,e){var i=t[e],n=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,n);var o=this._chooseSplitIndex(i,r,n),a=f(i.children.splice(o,i.children.length-o));a.height=i.height,a.leaf=i.leaf,s(i,this.toBBox),s(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(i,a)},n.prototype._splitRoot=function(t,e){this.data=f([t,e]),this.data.height=t.height+1,this.data.leaf=!1,s(this.data,this.toBBox)},n.prototype._chooseSplitIndex=function(t,e,i){for(var n,r,s,a,l,c,u,d=1/0,p=1/0,f=e;f<=i-e;f++){var m=o(t,0,f,this.toBBox),g=o(t,f,i,this.toBBox),_=(r=m,s=g,a=void 0,l=void 0,c=void 0,u=void 0,a=Math.max(r.minX,s.minX),l=Math.max(r.minY,s.minY),c=Math.min(r.maxX,s.maxX),u=Math.min(r.maxY,s.maxY),Math.max(0,c-a)*Math.max(0,u-l)),y=h(m)+h(g);_<d?(d=_,n=f,p=y<p?y:p):_===d&&y<p&&(p=y,n=f)}return n||i-e},n.prototype._chooseSplitAxis=function(t,e,i){var n=t.leaf?this.compareMinX:l,r=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,i,n)<this._allDistMargin(t,e,i,r)&&t.children.sort(n)},n.prototype._allDistMargin=function(t,e,i,n){t.children.sort(n);for(var r=this.toBBox,s=o(t,0,e,r),l=o(t,i-e,i,r),c=u(s)+u(l),h=e;h<i-e;h++){var d=t.children[h];a(s,t.leaf?r(d):d),c+=u(s)}for(var p=i-e-1;p>=e;p--){var f=t.children[p];a(l,t.leaf?r(f):f),c+=u(l)}return c},n.prototype._adjustParentBBoxes=function(t,e,i){for(var n=i;n>=0;n--)a(e[n],t)},n.prototype._condense=function(t){for(var e=t.length-1,i=void 0;e>=0;e--)0===t[e].children.length?e>0?(i=t[e-1].children).splice(i.indexOf(t[e]),1):this.clear():s(t[e],this.toBBox)},n}()}(It);var Pt=It.exports;function Lt(t,e){return t<e?-1:t>e?1:0}var Rt=Object.freeze({__proto__:null,default:class{constructor(t=[],e=Lt){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:i}=this,n=e[t];for(;t>0;){const r=t-1>>1,s=e[r];if(i(n,s)>=0)break;e[t]=s,t=r}e[t]=n}_down(t){const{data:e,compare:i}=this,n=this.length>>1,r=e[t];for(;t<n;){let n=1+(t<<1),s=e[n];const o=n+1;if(o<this.length&&i(e[o],s)<0&&(n=o,s=e[o]),i(s,r)>=0)break;e[t]=s,t=n}e[t]=r}}}),Bt=J(Rt),Dt={exports:{}},Ot=function(t,e,i,n){var r=t[0],s=t[1],o=!1;void 0===i&&(i=0),void 0===n&&(n=e.length);for(var a=(n-i)/2,l=0,c=a-1;l<a;c=l++){var h=e[i+2*l+0],u=e[i+2*l+1],d=e[i+2*c+1];u>s!=d>s&&r<(e[i+2*c+0]-h)*(s-u)/(d-u)+h&&(o=!o)}return o},kt=function(t,e,i,n){var r=t[0],s=t[1],o=!1;void 0===i&&(i=0),void 0===n&&(n=e.length);for(var a=n-i,l=0,c=a-1;l<a;c=l++){var h=e[l+i][0],u=e[l+i][1],d=e[c+i][1];u>s!=d>s&&r<(e[c+i][0]-h)*(s-u)/(d-u)+h&&(o=!o)}return o};Dt.exports=function(t,e,i,n){return e.length>0&&Array.isArray(e[0])?kt(t,e,i,n):Ot(t,e,i,n)},Dt.exports.nested=kt,Dt.exports.flat=Ot;var Ft=Dt.exports,zt={exports:{}};!function(t,e){!function(t){const e=134217729,i=33306690738754706e-32;function n(t,e,i,n,r){let s,o,a,l,c=e[0],h=n[0],u=0,d=0;h>c==h>-c?(s=c,c=e[++u]):(s=h,h=n[++d]);let p=0;if(u<t&&d<i)for(h>c==h>-c?(a=s-((o=c+s)-c),c=e[++u]):(a=s-((o=h+s)-h),h=n[++d]),s=o,0!==a&&(r[p++]=a);u<t&&d<i;)h>c==h>-c?(a=s-((o=s+c)-(l=o-s))+(c-l),c=e[++u]):(a=s-((o=s+h)-(l=o-s))+(h-l),h=n[++d]),s=o,0!==a&&(r[p++]=a);for(;u<t;)a=s-((o=s+c)-(l=o-s))+(c-l),c=e[++u],s=o,0!==a&&(r[p++]=a);for(;d<i;)a=s-((o=s+h)-(l=o-s))+(h-l),h=n[++d],s=o,0!==a&&(r[p++]=a);return 0===s&&0!==p||(r[p++]=s),p}function r(t){return new Float64Array(t)}const s=33306690738754716e-32,o=22204460492503146e-32,a=11093356479670487e-47,l=r(4),c=r(8),h=r(12),u=r(16),d=r(4);t.orient2d=function(t,r,p,f,m,g){const _=(r-g)*(p-m),y=(t-m)*(f-g),v=_-y;if(0===_||0===y||_>0!=y>0)return v;const x=Math.abs(_+y);return Math.abs(v)>=s*x?v:-function(t,r,s,p,f,m,g){let _,y,v,x,b,w,A,T,M,S,E,C,I,P,L,R,B,D;const O=t-f,k=s-f,F=r-m,z=p-m;b=(L=(T=O-(A=(w=e*O)-(w-O)))*(S=z-(M=(w=e*z)-(w-z)))-((P=O*z)-A*M-T*M-A*S))-(E=L-(B=(T=F-(A=(w=e*F)-(w-F)))*(S=k-(M=(w=e*k)-(w-k)))-((R=F*k)-A*M-T*M-A*S))),l[0]=L-(E+b)+(b-B),b=(I=P-((C=P+E)-(b=C-P))+(E-b))-(E=I-R),l[1]=I-(E+b)+(b-R),b=(D=C+E)-C,l[2]=C-(D-b)+(E-b),l[3]=D;let N=function(t,e){let i=e[0];for(let n=1;n<t;n++)i+=e[n];return i}(4,l),U=o*g;if(N>=U||-N>=U)return N;if(_=t-(O+(b=t-O))+(b-f),v=s-(k+(b=s-k))+(b-f),y=r-(F+(b=r-F))+(b-m),x=p-(z+(b=p-z))+(b-m),0===_&&0===y&&0===v&&0===x)return N;if(U=a*g+i*Math.abs(N),(N+=O*x+z*_-(F*v+k*y))>=U||-N>=U)return N;b=(L=(T=_-(A=(w=e*_)-(w-_)))*(S=z-(M=(w=e*z)-(w-z)))-((P=_*z)-A*M-T*M-A*S))-(E=L-(B=(T=y-(A=(w=e*y)-(w-y)))*(S=k-(M=(w=e*k)-(w-k)))-((R=y*k)-A*M-T*M-A*S))),d[0]=L-(E+b)+(b-B),b=(I=P-((C=P+E)-(b=C-P))+(E-b))-(E=I-R),d[1]=I-(E+b)+(b-R),b=(D=C+E)-C,d[2]=C-(D-b)+(E-b),d[3]=D;const G=n(4,l,4,d,c);b=(L=(T=O-(A=(w=e*O)-(w-O)))*(S=x-(M=(w=e*x)-(w-x)))-((P=O*x)-A*M-T*M-A*S))-(E=L-(B=(T=F-(A=(w=e*F)-(w-F)))*(S=v-(M=(w=e*v)-(w-v)))-((R=F*v)-A*M-T*M-A*S))),d[0]=L-(E+b)+(b-B),b=(I=P-((C=P+E)-(b=C-P))+(E-b))-(E=I-R),d[1]=I-(E+b)+(b-R),b=(D=C+E)-C,d[2]=C-(D-b)+(E-b),d[3]=D;const V=n(G,c,4,d,h);b=(L=(T=_-(A=(w=e*_)-(w-_)))*(S=x-(M=(w=e*x)-(w-x)))-((P=_*x)-A*M-T*M-A*S))-(E=L-(B=(T=y-(A=(w=e*y)-(w-y)))*(S=v-(M=(w=e*v)-(w-v)))-((R=y*v)-A*M-T*M-A*S))),d[0]=L-(E+b)+(b-B),b=(I=P-((C=P+E)-(b=C-P))+(E-b))-(E=I-R),d[1]=I-(E+b)+(b-R),b=(D=C+E)-C,d[2]=C-(D-b)+(E-b),d[3]=D;const j=n(V,h,4,d,u);return u[j-1]}(t,r,p,f,m,g,x)},t.orient2dfast=function(t,e,i,n,r,s){return(e-s)*(i-r)-(t-r)*(n-s)},Object.defineProperty(t,"__esModule",{value:!0})}(e)}(0,zt.exports);var Nt=Pt,Ut=Bt,Gt=Ft;const Vt=zt.exports.orient2d;function jt(t,e,i){e=Math.max(0,void 0===e?2:e),i=i||0;var n=function(t){for(var e=t[0],i=t[0],n=t[0],r=t[0],s=0;s<t.length;s++){var o=t[s];o[0]<e[0]&&(e=o),o[0]>n[0]&&(n=o),o[1]<i[1]&&(i=o),o[1]>r[1]&&(r=o)}var a=[e,i,n,r],l=a.slice();for(s=0;s<t.length;s++)Gt(t[s],a)||l.push(t[s]);return function(t){t.sort(ee);for(var e=[],i=0;i<t.length;i++){for(;e.length>=2&&Jt(e[e.length-2],e[e.length-1],t[i])<=0;)e.pop();e.push(t[i])}for(var n=[],r=t.length-1;r>=0;r--){for(;n.length>=2&&Jt(n[n.length-2],n[n.length-1],t[r])<=0;)n.pop();n.push(t[r])}return n.pop(),e.pop(),e.concat(n)}(l)}(t),r=new Nt(16);r.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},r.compareMinX=function(t,e){return t[0]-e[0]},r.compareMinY=function(t,e){return t[1]-e[1]},r.load(t);for(var s,o=[],a=0;a<n.length;a++){var l=n[a];r.remove(l),s=$t(l,s),o.push(s)}var c=new Nt(16);for(a=0;a<o.length;a++)c.insert(Yt(o[a]));for(var h=e*e,u=i*i;o.length;){var d=o.shift(),p=d.p,f=d.next.p,m=Kt(p,f);if(!(m<u)){var g=m/h;(l=Ht(r,d.prev.p,p,f,d.next.next.p,g,c))&&Math.min(Kt(l,p),Kt(l,f))<=g&&(o.push(d),o.push($t(l,d)),r.remove(l),c.remove(d),c.insert(Yt(d)),c.insert(Yt(d.next)))}}d=s;var _=[];do{_.push(d.p),d=d.next}while(d!==s);return _.push(d.p),_}function Ht(t,e,i,n,r,s,o){for(var a=new Ut([],Wt),l=t.data;l;){for(var c=0;c<l.children.length;c++){var h=l.children[c],u=l.leaf?Qt(h,i,n):qt(i,n,h);u>s||a.push({node:h,dist:u})}for(;a.length&&!a.peek().node.children;){var d=a.pop(),p=d.node,f=Qt(p,e,i),m=Qt(p,n,r);if(d.dist<f&&d.dist<m&&Zt(i,p,o)&&Zt(n,p,o))return p}(l=a.pop())&&(l=l.node)}return null}function Wt(t,e){return t.dist-e.dist}function qt(t,e,i){if(Xt(t,i)||Xt(e,i))return 0;var n=te(t[0],t[1],e[0],e[1],i.minX,i.minY,i.maxX,i.minY);if(0===n)return 0;var r=te(t[0],t[1],e[0],e[1],i.minX,i.minY,i.minX,i.maxY);if(0===r)return 0;var s=te(t[0],t[1],e[0],e[1],i.maxX,i.minY,i.maxX,i.maxY);if(0===s)return 0;var o=te(t[0],t[1],e[0],e[1],i.minX,i.maxY,i.maxX,i.maxY);return 0===o?0:Math.min(n,r,s,o)}function Xt(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function Zt(t,e,i){for(var n,r,s,o,a=Math.min(t[0],e[0]),l=Math.min(t[1],e[1]),c=Math.max(t[0],e[0]),h=Math.max(t[1],e[1]),u=i.search({minX:a,minY:l,maxX:c,maxY:h}),d=0;d<u.length;d++)if(r=u[d].next.p,s=t,(n=u[d].p)!==(o=e)&&r!==s&&Jt(n,r,s)>0!=Jt(n,r,o)>0&&Jt(s,o,n)>0!=Jt(s,o,r)>0)return!1;return!0}function Jt(t,e,i){return Vt(t[0],t[1],e[0],e[1],i[0],i[1])}function Yt(t){var e=t.p,i=t.next.p;return t.minX=Math.min(e[0],i[0]),t.minY=Math.min(e[1],i[1]),t.maxX=Math.max(e[0],i[0]),t.maxY=Math.max(e[1],i[1]),t}function $t(t,e){var i={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(i.next=e.next,i.prev=e,e.next.prev=i,e.next=i):(i.prev=i,i.next=i),i}function Kt(t,e){var i=t[0]-e[0],n=t[1]-e[1];return i*i+n*n}function Qt(t,e,i){var n=e[0],r=e[1],s=i[0]-n,o=i[1]-r;if(0!==s||0!==o){var a=((t[0]-n)*s+(t[1]-r)*o)/(s*s+o*o);a>1?(n=i[0],r=i[1]):a>0&&(n+=s*a,r+=o*a)}return(s=t[0]-n)*s+(o=t[1]-r)*o}function te(t,e,i,n,r,s,o,a){var l,c,h,u,d=i-t,p=n-e,f=o-r,m=a-s,g=t-r,_=e-s,y=d*d+p*p,v=d*f+p*m,x=f*f+m*m,b=d*g+p*_,w=f*g+m*_,A=y*x-v*v,T=A,M=A;0===A?(c=0,T=1,u=w,M=x):(u=y*w-v*b,(c=v*w-x*b)<0?(c=0,u=w,M=x):c>T&&(c=T,u=w+v,M=x)),u<0?(u=0,-b<0?c=0:-b>y?c=T:(c=-b,T=y)):u>M&&(u=M,-b+v<0?c=0:-b+v>y?c=T:(c=-b+v,T=y));var S=(1-(h=0===u?0:u/M))*r+h*o-((1-(l=0===c?0:c/T))*t+l*i),E=(1-h)*s+h*a-((1-l)*e+l*n);return S*S+E*E}function ee(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}Ct.exports=jt,Ct.exports.default=jt;var ie=Z(Ct.exports);function ne(t,e){if(!ot(e=e||{}))throw new Error("options is invalid");var i=e.concavity||1/0,n=[];if(ct(t,(function(t){n.push([t[0],t[1]])})),!n.length)return null;var r=ie(n,i);return r.length>3?function(t,e,i){if(!t)throw new Error("coordinates is required");for(var n=0;n<t.length;n++){var r=t[n];if(r.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var s=0;s<r[r.length-1].length;s++){if(0===n&&0===s&&!st(r[0][0])||!st(r[0][1]))throw new Error("coordinates must contain numbers");if(r[r.length-1][s]!==r[0][s])throw new Error("First and last Position are not equivalent.")}}return et({type:"Polygon",coordinates:t},e,i)}([r]):null}function re(t,e){var i=0,n=0,r=0;return ct(t,(function(t){i+=t[0],n+=t[1],r++}),!0),it([i/r,n/r],e)}function se(t,e){switch(function(t,e){if(!t)throw new Error((e||"geojson")+" is required");if(t.geometry&&t.geometry.type)return t.geometry.type;if(t.type)return t.type;throw new Error((e||"geojson")+" is invalid")}(t)){case"Point":return t;case"Polygon":var i=[];ct(t,(function(t){i.push(t)}));var n,r,s,o,a,l,c,h,u=re(t,e),d=u.geometry.coordinates,p=0,f=0,m=0,g=i.map((function(t){return[t[0]-d[0],t[1]-d[1]]}));for(n=0;n<i.length-1;n++)m+=h=(o=(r=g[n])[0])*(c=(s=g[n+1])[1])-(a=s[0])*(l=r[1]),p+=(o+a)*h,f+=(l+c)*h;if(0===m)return u;var _=1/(6*(.5*m));return it([d[0]+_*p,d[1]+_*f],e);default:var y=ne(t);return y?se(y,e):re(t,e)}}function oe(t,e,i){if(!ot(i=i||{}))throw new Error("options is invalid");var n=i.units,r=Mt(t),s=Mt(e),o=rt(s[1]-r[1]),a=rt(s[0]-r[0]),l=rt(r[1]),c=rt(s[1]),h=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(a/2),2)*Math.cos(l)*Math.cos(c);return function(t,e){if(null==t)throw new Error("radians is required");if(e&&"string"!=typeof e)throw new Error("units must be a string");var i=tt[e||"kilometers"];if(!i)throw new Error(e+" units is invalid");return t*i}(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)),n)}const ae=2*Math.PI,le=Math.PI/180,ce=6371.0088;function he(t,e,i){const n=Mt(t),r=n[0]*le,s=n[1]*le,o=i*le,a=e/ce,l=Math.sin(s),c=Math.cos(s),h=Math.sin(a),u=Math.cos(a),d=Math.sin(o),p=Math.cos(o),f=Math.asin(l*u+c*h*p);return[(r+Math.atan2(d*h*c,u-l*Math.sin(f)))%ae/le,f%ae/le]}function ue(t,e){const i=[];return ht(t,(t=>{e(t.properties)&&i.push(t)})),nt(i)}function de(t,e,i,n){const r=t.geometry.coordinates,s=t.properties.distances,o=r.length,a=[];let l=0,c=o-1;for(e-=n*(i-1)/2;l!==c-1;){const t=Math.floor((l+c)/2);e<s[t][0]?c=t:l=t}let h=l;for(let t=0;t<i;e+=n,t++){for(;e>s[h+1][0]&&h<o-2;)h++;const[t,i,n,l]=s[h],c=r[h],u=e-t;a.push({coord:he(c,u,i),altitude:(c[2]||0)+n*u,bearing:i,pitch:l})}return a}function pe(t){const e=t.properties.ids;return"string"==typeof e?JSON.parse(e):e}function fe(t){return St(t)[0][0][2]}function me(){return nt([])}var ge,_e={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function ye(t){return(t=Math.round(t))<0?0:t>255?255:t}function ve(t){return t<0?0:t>1?1:t}function xe(t){return ye("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function be(t){return ve("%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))}function we(t,e,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?t+(e-t)*i*6:2*i<1?e:3*i<2?t+(e-t)*(2/3-i)*6:t}try{ge={}.parseCSSColor=function(t){var e,i=t.replace(/ /g,"").toLowerCase();if(i in _e)return _e[i].slice();if("#"===i[0])return 4===i.length?(e=parseInt(i.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===i.length&&(e=parseInt(i.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var n=i.indexOf("("),r=i.indexOf(")");if(-1!==n&&r+1===i.length){var s=i.substr(0,n),o=i.substr(n+1,r-(n+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=be(o.pop());case"rgb":return 3!==o.length?null:[xe(o[0]),xe(o[1]),xe(o[2]),a];case"hsla":if(4!==o.length)return null;a=be(o.pop());case"hsl":if(3!==o.length)return null;var l=(parseFloat(o[0])%360+360)%360/360,c=be(o[1]),h=be(o[2]),u=h<=.5?h*(c+1):h+c-h*c,d=2*h-u;return[ye(255*we(d,u,l+1/3)),ye(255*we(d,u,l)),ye(255*we(d,u,l-1/3)),a];default:return null}}return null}}catch(t){}var Ae={exports:{}};!function(t,e){!function(){var e=Math.PI,i=Math.sin,n=Math.cos,r=Math.tan,s=Math.asin,o=Math.atan2,a=Math.acos,l=e/180,c=864e5,h=2440588,u=2451545;function d(t){return new Date((t+.5-h)*c)}function p(t){return function(t){return t.valueOf()/c-.5+h}(t)-u}var f=23.4397*l;function m(t,e){return o(i(t)*n(f)-r(e)*i(f),n(t))}function g(t,e){return s(i(e)*n(f)+n(e)*i(f)*i(t))}function _(t,e,s){return o(i(t),n(t)*i(e)-r(s)*n(e))}function y(t,e,r){return s(i(e)*i(r)+n(e)*n(r)*n(t))}function v(t,e){return l*(280.16+360.9856235*t)-e}function x(t){return l*(357.5291+.98560028*t)}function b(t){return t+l*(1.9148*i(t)+.02*i(2*t)+3e-4*i(3*t))+102.9372*l+e}function w(t){var e=b(x(t));return{dec:g(e,0),ra:m(e,0)}}var A={getPosition:function(t,e,i){var n=l*-i,r=l*e,s=p(t),o=w(s),a=v(s,n)-o.ra;return{azimuth:_(a,r,o.dec),altitude:y(a,r,o.dec)}}},T=A.times=[[-.833,"sunrise","sunset"],[-.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];A.addTime=function(t,e,i){T.push([t,e,i])};var M=9e-4;function S(t,i,n){return M+(t+i)/(2*e)+n}function E(t,e,n){return u+t+.0053*i(e)-.0069*i(2*n)}function C(t,e,r,s,o,l,c){var h=function(t,e,r){return a((i(t)-i(e)*i(r))/(n(e)*n(r)))}(t,r,s);return E(S(h,e,o),l,c)}function I(t){var e=l*(134.963+13.064993*t),r=l*(93.272+13.22935*t),s=l*(218.316+13.176396*t)+6.289*l*i(e),o=5.128*l*i(r),a=385001-20905*n(e);return{ra:m(s,o),dec:g(s,o),dist:a}}function P(t,e){return new Date(t.valueOf()+e*c/24)}A.getTimes=function(t,i,n,r){var s,o,a,c,h=l*-n,u=l*i,f=function(t){return-2.076*Math.sqrt(t)/60}(r=r||0),m=function(t,i){return Math.round(t-M-i/(2*e))}(p(t),h),_=S(0,h,m),y=x(_),v=b(y),w=g(v,0),A=E(_,y,v),I={solarNoon:d(A),nadir:d(A-.5)};for(s=0,o=T.length;s<o;s+=1)c=C(((a=T[s])[0]+f)*l,h,u,w,m,y,v),I[a[1]]=d(A-(c-A)),I[a[2]]=d(c);return I},A.getMoonPosition=function(t,e,s){var a=l*-s,c=l*e,h=p(t),u=I(h),d=v(h,a)-u.ra,f=y(d,c,u.dec),m=o(i(d),r(c)*n(u.dec)-i(u.dec)*n(d));return f+=function(t){return t<0&&(t=0),2967e-7/Math.tan(t+.00312536/(t+.08901179))}(f),{azimuth:_(d,c,u.dec),altitude:f,distance:u.dist,parallacticAngle:m}},A.getMoonIllumination=function(t){var e=p(t||new Date),r=w(e),s=I(e),l=149598e3,c=a(i(r.dec)*i(s.dec)+n(r.dec)*n(s.dec)*n(r.ra-s.ra)),h=o(l*i(c),s.dist-l*n(c)),u=o(n(r.dec)*i(r.ra-s.ra),i(r.dec)*n(s.dec)-n(r.dec)*i(s.dec)*n(r.ra-s.ra));return{fraction:(1+n(h))/2,phase:.5+.5*h*(u<0?-1:1)/Math.PI,angle:u}},A.getMoonTimes=function(t,e,i,n){var r=new Date(t);n?r.setUTCHours(0,0,0,0):r.setHours(0,0,0,0);for(var s,o,a,c,h,u,d,p,f,m,g,_,y,v=.133*l,x=A.getMoonPosition(r,e,i).altitude-v,b=1;b<=24&&(s=A.getMoonPosition(P(r,b),e,i).altitude-v,p=((h=(x+(o=A.getMoonPosition(P(r,b+1),e,i).altitude-v))/2-s)*(d=-(u=(o-x)/2)/(2*h))+u)*d+s,m=0,(f=u*u-4*h*s)>=0&&(g=d-(y=Math.sqrt(f)/(2*Math.abs(h))),_=d+y,Math.abs(g)<=1&&m++,Math.abs(_)<=1&&m++,g<-1&&(g=_)),1===m?x<0?a=b+g:c=b+g:2===m&&(a=b+(p<0?_:g),c=b+(p<0?g:_)),!a||!c);b+=2)x=o;var w={};return a&&(w.rise=P(r,a)),c&&(w.set=P(r,c)),a||c||(w[p>0?"alwaysUp":"alwaysDown"]=!0),w},t.exports=A}()}(Ae);var Te=Z(Ae.exports);const Me=36e5,Se=180/Math.PI,Ee=["background","background-underground"];function Ce(t){const e=new $.LngLatBounds;for(const i of t)e.extend(i);return e}function Ie(t,e,i){t.getLayer(e).implementation.setProps(i)}function Pe(t,e){const i=t.getCenter(),{sunrise:n,sunset:r}=Te.getTimes(e,i.lat,i.lng),s=n.getTime(),o=r.getTime();let a,l,c,h;return e>=s-Me&&e<s?(a=(e-s)/Me+1,l=O(.4,.8,a),c=O(.4,.9,a),h=O(.5,1,a)):e>=s&&e<s+Me?(a=(e-s)/Me,l=O(.8,1,a),c=O(.9,1,a),h=1):e>=s+Me&&e<o-Me?l=c=h=1:e>=o-Me&&e<o?(a=(e-o)/Me+1,l=1,c=O(1,.9,a),h=O(1,.8,a)):e>=o&&e<o+Me?(a=(e-o)/Me,l=O(1,.4,a),c=O(.9,.4,a),h=O(.8,.5,a)):(l=c=.4,h=.5),{r:l,g:c,b:h}}function Le(t,e){return e?Ee.reduce(((e,i)=>{const n=t.getLayer(i).paint,{r:r,g:s,b:o}=n.get("background-color"),a=n.get("background-opacity");return e+j({r:r*a,g:s*a,b:o*a})}),0)<.5:Ee.reduce(((e,i)=>{const[n,r,s]=ge(t.getPaintProperty(i,"background-color")),o=N(t.getPaintProperty(i,"background-opacity"),1);return e+j({r:n*o,g:r*o,b:s*o})}),0)<127.5}function Re(t,e){return`rgba(${t.r*e.r},${t.g*e.g},${t.b*e.b},${t.a})`}function Be(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const De=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser),Oe="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Oe&&parseFloat(Oe[1]);const ke="3.4.14";function Fe(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const ze={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document},Ne=ze.global||ze.self||ze.window||{},Ue="object"!=typeof process||"[object process]"!==String(process)||process.browser,Ge="function"==typeof importScripts,Ve="undefined"!=typeof window&&void 0!==window.orientation,je="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function He(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}je&&parseFloat(je[1]);class We{constructor(t,e){He(this,"name",void 0),He(this,"workerThread",void 0),He(this,"isRunning",!0),He(this,"result",void 0),He(this,"_resolve",(()=>{})),He(this,"_reject",(()=>{})),this.name=t,this.workerThread=e,this.result=new Promise(((t,e)=>{this._resolve=t,this._reject=e}))}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){Fe(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){Fe(this.isRunning),this.isRunning=!1,this._reject(t)}}let qe=class{terminate(){}};const Xe=new Map;function Ze(t){Fe(t.source&&!t.url||!t.source&&t.url);let e=Xe.get(t.source||t.url);return e||(t.url&&(e=function(t){if(!t.startsWith("http"))return t;return Je((e=t,"try {\n  importScripts('".concat(e,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var e}(t.url),Xe.set(t.url,e)),t.source&&(e=Je(t.source),Xe.set(t.source,e))),Fe(e),e}function Je(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function Ye(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=arguments.length>2?arguments[2]:void 0;const n=i||new Set;if(t){if($e(t))n.add(t);else if($e(t.buffer))n.add(t.buffer);else if(ArrayBuffer.isView(t));else if(e&&"object"==typeof t)for(const i in t)Ye(t[i],e,n)}else;return void 0===i?Array.from(n):[]}function $e(t){return!!t&&(t instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&t instanceof MessagePort||("undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas)))}const Ke=()=>{};class Qe{static isSupported(){return"undefined"!=typeof Worker&&Ue||void 0!==qe&&!Ue}constructor(t){He(this,"name",void 0),He(this,"source",void 0),He(this,"url",void 0),He(this,"terminated",!1),He(this,"worker",void 0),He(this,"onMessage",void 0),He(this,"onError",void 0),He(this,"_loadableURL","");const{name:e,source:i,url:n}=t;Fe(i||n),this.name=e,this.source=i,this.url=n,this.onMessage=Ke,this.onError=t=>{},this.worker=Ue?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=Ke,this.onError=Ke,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(t,e){e=e||Ye(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+="worker ".concat(this.name," from ").concat(this.url,". "),t.message&&(e+="".concat(t.message," in ")),t.lineno&&(e+=":".concat(t.lineno,":").concat(t.colno)),new Error(e)}_createBrowserWorker(){this._loadableURL=Ze({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},t.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},t.onmessageerror=t=>{},t}_createNodeWorker(){let t;if(this.url){const e=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);t=new qe(e,{eval:!1})}else{if(!this.source)throw new Error("no worker");t=new qe(this.source,{eval:!0})}return t.on("message",(t=>{this.onMessage(t)})),t.on("error",(t=>{this.onError(t)})),t.on("exit",(t=>{})),t}}class ti{static isSupported(){return Qe.isSupported()}constructor(t){He(this,"name","unnamed"),He(this,"source",void 0),He(this,"url",void 0),He(this,"maxConcurrency",1),He(this,"maxMobileConcurrency",1),He(this,"onDebug",(()=>{})),He(this,"reuseWorkers",!0),He(this,"props",{}),He(this,"jobQueue",[]),He(this,"idleQueue",[]),He(this,"count",0),He(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach((t=>t.destroy())),this.isDestroyed=!0}setProps(t){this.props={...this.props,...t},void 0!==t.name&&(this.name=t.name),void 0!==t.maxConcurrency&&(this.maxConcurrency=t.maxConcurrency),void 0!==t.maxMobileConcurrency&&(this.maxMobileConcurrency=t.maxMobileConcurrency),void 0!==t.reuseWorkers&&(this.reuseWorkers=t.reuseWorkers),void 0!==t.onDebug&&(this.onDebug=t.onDebug)}async startJob(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(t,e,i)=>t.done(i),i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(t,e)=>t.error(e);const n=new Promise((n=>(this.jobQueue.push({name:t,onMessage:e,onError:i,onStart:n}),this)));return this._startQueuedJob(),await n}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const i=new We(e.name,t);t.onMessage=t=>e.onMessage(i,t.type,t.payload),t.onError=t=>e.onError(i,t),e.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new Qe({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Ve?this.maxMobileConcurrency:this.maxConcurrency}}const ei={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class ii{static isSupported(){return Qe.isSupported()}static getWorkerFarm(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ii._workerFarm=ii._workerFarm||new ii({}),ii._workerFarm.setProps(t),ii._workerFarm}constructor(t){He(this,"props",void 0),He(this,"workerPools",new Map),this.props={...ei},this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy();this.workerPools=new Map}setProps(t){this.props={...this.props,...t};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:i,url:n}=t;let r=this.workerPools.get(e);return r||(r=new ti({name:e,source:i,url:n}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,r)),r}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}He(ii,"_workerFarm",void 0);const ni="latest";const ri=null,si=null;var oi=Object.freeze({__proto__:null,readFileAsArrayBuffer:null,readFileAsText:null,requireFromFile:ri,requireFromString:si});const ai="3.4.14",li={};async function ci(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return e&&(t=function(t,e,i){if(t.startsWith("http"))return t;const n=i.modules||{};if(n[t])return n[t];if(!Ue)return"modules/".concat(e,"/dist/libs/").concat(t);if(i.CDN)return Fe(i.CDN.startsWith("http")),"".concat(i.CDN,"/").concat(e,"@").concat(ai,"/dist/libs/").concat(t);if(Ge)return"../src/libs/".concat(t);return"modules/".concat(e,"/src/libs/").concat(t)}(t,e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:{})),li[t]=li[t]||async function(t){if(t.endsWith("wasm")){const e=await fetch(t);return await e.arrayBuffer()}if(!Ue)try{return oi&&ri&&await ri(t)}catch(t){return null}if(Ge)return importScripts(t);const e=await fetch(t);return function(t,e){if(!Ue)return si;if(Ge)return eval.call(Ne,t),null;const i=document.createElement("script");i.id=e;try{i.appendChild(document.createTextNode(t))}catch(e){i.text=t}return document.body.appendChild(i),null}(await e.text(),t)}(t),await li[t]}async function hi(t,e,i,n,r){const s=t.id,o=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=e[t.id]||{},n="".concat(t.id,"-worker.js");let r=i.workerUrl;if(r||"compression"!==t.id||(r=e.workerUrl),"test"===e._workerType&&(r="modules/".concat(t.module,"/dist/").concat(n)),!r){let e=t.version;"latest"===e&&(e=ni);const i=e?"@".concat(e):"";r="https://unpkg.com/@loaders.gl/".concat(t.module).concat(i,"/dist/").concat(n)}return Fe(r),r}(t,i),a=ii.getWorkerFarm(i).getWorkerPool({name:s,url:o});i=JSON.parse(JSON.stringify(i)),n=JSON.parse(JSON.stringify(n||{}));const l=await a.startJob("process-on-worker",ui.bind(null,r));l.postMessage("process",{input:e,options:i,context:n});const c=await l.result;return await c.result}async function ui(t,e,i,n){switch(i){case"done":e.done(n);break;case"error":e.error(new Error(n.error));break;case"process":const{id:i,input:r,options:s}=n;try{const n=await t(r,s);e.postMessage("done",{id:i,result:n})}catch(t){const n=t instanceof Error?t.message:"unknown error";e.postMessage("error",{id:i,error:n})}}}function di(t,e,i){if(t.byteLength<=e+i)return"";const n=new DataView(t);let r="";for(let t=0;t<i;t++)r+=String.fromCharCode(n.getUint8(e+t));return r}function pi(t){try{return JSON.parse(t)}catch(e){throw new Error('Failed to parse JSON from data starting with "'.concat(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return di(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer)return di(t,0,e);return""}(t),'"'))}}function fi(t,e,i){const n=void 0!==i?new Uint8Array(t).subarray(e,e+i):new Uint8Array(t).subarray(e);return new Uint8Array(n).buffer}function mi(t,e){return Be(t>=0),Be(e>0),t+(e-1)&~(e-1)}function gi(t,e,i){let n;if(t instanceof ArrayBuffer)n=new Uint8Array(t);else{n=new Uint8Array(t.buffer||t.arrayBuffer,t.byteOffset,t.byteLength)}return e.set(n,i),i+mi(n.byteLength,4)}async function _i(t){const e=[];for await(const i of t)e.push(i);return function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=e.map((t=>t instanceof ArrayBuffer?new Uint8Array(t):t)),r=n.reduce(((t,e)=>t+e.byteLength),0),s=new Uint8Array(r);let o=0;for(const t of n)s.set(t,o),o+=t.byteLength;return s.buffer}(...e)}function yi(){let t;if("undefined"!=typeof window&&window.performance)t=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const e=process.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}let vi=class{constructor(t,e){this.name=void 0,this.type=void 0,this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=t,this.type=e,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=yi(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(yi()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}},xi=class{constructor(t){this.id=void 0,this.stats={},this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t){return this._getOrCreate({name:t,type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count"})}get size(){return Object.keys(this.stats).length}reset(){for(const t of Object.values(this.stats))t.reset();return this}forEach(t){for(const e of Object.values(this.stats))t(e)}getTable(){const t={};return this.forEach((e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}})),t}_initializeStats(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((t=>this._getOrCreate(t)))}_getOrCreate(t){const{name:e,type:i}=t;let n=this.stats[e];return n||(n=t instanceof vi?t:new vi(e,i),this.stats[e]=n),n}};const bi={id:"request-scheduler",throttleRequests:!0,maxRequests:6};class wi{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};He(this,"props",void 0),He(this,"stats",void 0),He(this,"activeRequestCount",0),He(this,"requestQueue",[]),He(this,"requestMap",new Map),He(this,"deferredUpdate",null),this.props={...bi,...t},this.stats=new xi({id:this.props.id}),this.stats.get("Queued Requests"),this.stats.get("Active Requests"),this.stats.get("Cancelled Requests"),this.stats.get("Queued Requests Ever"),this.stats.get("Active Requests Ever")}scheduleRequest(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>0;if(!this.props.throttleRequests)return Promise.resolve({done:()=>{}});if(this.requestMap.has(t))return this.requestMap.get(t);const i={handle:t,priority:0,getPriority:e},n=new Promise((t=>(i.resolve=t,i)));return this.requestQueue.push(i),this.requestMap.set(t,n),this._issueNewRequests(),n}_issueRequest(t){const{handle:e,resolve:i}=t;let n=!1;const r=()=>{n||(n=!0,this.requestMap.delete(e),this.activeRequestCount--,this._issueNewRequests())};return this.activeRequestCount++,i?i({done:r}):Promise.resolve({done:r})}_issueNewRequests(){this.deferredUpdate||(this.deferredUpdate=setTimeout((()=>this._issueNewRequestsAsync()),0))}_issueNewRequestsAsync(){this.deferredUpdate=null;const t=Math.max(this.props.maxRequests-this.activeRequestCount,0);if(0!==t){this._updateAllRequests();for(let e=0;e<t;++e){const t=this.requestQueue.shift();t&&this._issueRequest(t)}}}_updateAllRequests(){const t=this.requestQueue;for(let e=0;e<t.length;++e){const i=t[e];this._updateRequest(i)||(t.splice(e,1),this.requestMap.delete(i.handle),e--)}t.sort(((t,e)=>t.priority-e.priority))}_updateRequest(t){return t.priority=t.getPriority(t.handle),!(t.priority<0)||(t.resolve(null),!1)}}let Ai="";const Ti={};function Mi(t){if((e=t)&&"object"==typeof e&&e.isBuffer)return t;var e;if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return 0===t.byteOffset&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if("string"==typeof t){const e=t;return(new TextEncoder).encode(e).buffer}if(t&&"object"==typeof t&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function Si(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}function Ei(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}const Ci=t=>"function"==typeof t,Ii=t=>null!==t&&"object"==typeof t,Pi=t=>Ii(t)&&t.constructor==={}.constructor,Li=t=>t&&"function"==typeof t[Symbol.iterator],Ri=t=>t&&"function"==typeof t[Symbol.asyncIterator],Bi=t=>"undefined"!=typeof Response&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,Di=t=>"undefined"!=typeof Blob&&t instanceof Blob,Oi=t=>t&&"object"==typeof t&&t.isBuffer,ki=t=>(t=>"undefined"!=typeof ReadableStream&&t instanceof ReadableStream||Ii(t)&&Ci(t.tee)&&Ci(t.cancel)&&Ci(t.getReader))(t)||(t=>Ii(t)&&Ci(t.read)&&Ci(t.pipe)&&(t=>"boolean"==typeof t)(t.readable))(t),Fi=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,zi=/^([-\w.]+\/[-\w.+]+)/;function Ni(t){const e=Fi.exec(t);return e?e[1]:""}const Ui=/\?.*/;function Gi(t){return t.replace(Ui,"")}function Vi(t){if(Bi(t)){return t.url}if(Di(t)){return t.name||""}return"string"==typeof t?t:""}function ji(t){if(Bi(t)){const e=t,i=e.headers.get("content-type")||"",n=Gi(e.url);return function(t){const e=zi.exec(t);return e?e[1]:t}(i)||Ni(n)}if(Di(t)){return t.type||""}return"string"==typeof t?Ni(t):""}async function Hi(t){if(Bi(t))return t;const e={},i=function(t){if(Bi(t))return t.headers["content-length"]||-1;if(Di(t))return t.size;return"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}(t);i>=0&&(e["content-length"]=String(i));const n=Vi(t),r=ji(t);r&&(e["content-type"]=r);const s=await async function(t){const e=5;if("string"==typeof t)return"data:,".concat(t.slice(0,e));if(t instanceof Blob){const e=t.slice(0,5);return await new Promise((t=>{const i=new FileReader;i.onload=e=>{var i;return t(null==e||null===(i=e.target)||void 0===i?void 0:i.result)},i.readAsDataURL(e)}))}if(t instanceof ArrayBuffer){const i=function(t){let e="";const i=new Uint8Array(t);for(let t=0;t<i.byteLength;t++)e+=String.fromCharCode(i[t]);return btoa(e)}(t.slice(0,e));return"data:base64,".concat(i)}return null}(t);s&&(e["x-first-bytes"]=s),"string"==typeof t&&(t=(new TextEncoder).encode(t));const o=new Response(t,{headers:e});return Object.defineProperty(o,"url",{value:n}),o}async function Wi(t,e){if("string"==typeof t){t=function(t){for(const e in Ti)t.startsWith(e)&&(t=t.replace(e,Ti[e]));return t.startsWith("http://")||t.startsWith("https://")||(t="".concat(Ai).concat(t)),t}(t);let i=e;return null!=e&&e.fetch&&"function"!=typeof(null==e?void 0:e.fetch)&&(i=e.fetch),await fetch(t,i)}return await Hi(t)}function qi(){return!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(t){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const e="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,i=t||e;return!!(i&&i.indexOf("Electron")>=0)}()}const Xi=globalThis.window||globalThis.self||globalThis.global,Zi=globalThis.process||{},Ji="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";qi();let Yi,$i=class{constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";this.storage=void 0,this.id=void 0,this.config=void 0,this.storage=function(t){try{const e=window[t],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch(t){return null}}(i),this.id=t,this.config=e,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){if(Object.assign(this.config,t),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}};!function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(Yi||(Yi={}));const Ki=10;function Qi(t){return"string"!=typeof t?t:(t=t.toUpperCase(),Yi[t]||Yi.WHITE)}function tn(t,e){if(!t)throw new Error(e||"Assertion failed")}function en(){let t;var e,i;if(qi()&&Xi.performance)t=null==Xi||null===(e=Xi.performance)||void 0===e||null===(i=e.now)||void 0===i?void 0:i.call(e);else if("hrtime"in Zi){var n;const e=null==Zi||null===(n=Zi.hrtime)||void 0===n?void 0:n.call(Zi);t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}const nn={debug:qi()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},rn={enabled:!0,level:0};function sn(){}const on={},an={once:!0};let ln=class{constructor(){let{id:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};this.id=void 0,this.VERSION=Ji,this._startTs=en(),this._deltaTs=en(),this._storage=void 0,this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=t,this.userData={},this._storage=new $i(`__probe-${this.id}__`,rn),this.timeStamp(`${this.id} started`),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const i=Object.getPrototypeOf(t),n=Object.getOwnPropertyNames(i),r=t;for(const i of n){const n=r[i];"function"==typeof n&&(e.find((t=>i===t))||(r[i]=n.bind(t)))}}(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((en()-this._startTs).toPrecision(10))}getDelta(){return Number((en()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(){return this._storage.setConfiguration({enabled:!(arguments.length>0&&void 0!==arguments[0])||arguments[0]}),this}setLevel(t){return this._storage.setConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.setConfiguration({[t]:e})}settings(){}assert(t,e){tn(t,e)}warn(t){return this._getLogFunction(0,t,nn.warn,arguments,an)}error(t){return this._getLogFunction(0,t,nn.error,arguments)}deprecated(t,e){return this.warn(`\`${t}\` is deprecated and will be removed in a later version. Use \`${e}\` instead`)}removed(t,e){return this.error(`\`${t}\` has been removed. Use \`${e}\` instead`)}probe(t,e){return this._getLogFunction(t,e,nn.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,nn.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){return this._getLogFunction(t,e,nn.debug||nn.info,arguments,an)}table(t,e,i){return e?this._getLogFunction(t,e,console.table||sn,i&&[i],{tag:un(e)}):sn}image(t){let{logLevel:e,priority:i,image:n,message:r="",scale:s=1}=t;return this._shouldLog(e||i)&&qi()?function(t){let{image:e,message:i="",scale:n=1}=t;if("string"==typeof e){const t=new Image;return t.onload=()=>{!function(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=t.src.replace(/\(/g,"%28").replace(/\)/g,"%29");t.width>n&&(i=Math.min(i,n/t.width));const s=t.width*i,o=t.height*i;["font-size:1px;",`padding:${Math.floor(o/2)}px ${Math.floor(s/2)}px;`,`line-height:${o}px;`,`background:url(${r});`,`background-size:${s}px ${o}px;`,"color:transparent;"].join("")}(t,i,n)},t.src=e,sn}const r=e.nodeName||"";if("img"===r.toLowerCase())return sn;if("canvas"===r.toLowerCase()){const t=new Image;return t.onload=()=>{},t.src=e.toDataURL(),sn}return sn}({image:n,message:r,scale:s}):sn}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||sn)}group(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const n=hn({logLevel:t,message:e,opts:i}),{collapsed:r}=i;return n.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(t,e){return this.group(t,e,Object.assign({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||sn)}withGroup(t,e,i){this.group(t,e)();try{i()}finally{this.groupEnd(t)()}}trace(){}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=cn(t)}_getLogFunction(t,e,i,n,r){if(this._shouldLog(t)){r=hn({logLevel:t,message:e,args:n,opts:r}),tn(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=en();const s=r.tag||r.message;if(r.once&&s){if(on[s])return sn;on[s]=en()}return e=function(t,e,i){if("string"==typeof e){const n=i.time?function(t){const e=Math.max((arguments.length>1&&void 0!==arguments[1]?arguments[1]:8)-t.length,0);return`${" ".repeat(e)}${t}`}(function(t){let e;return e=t<10?`${t.toFixed(2)}ms`:t<100?`${t.toFixed(1)}ms`:t<1e3?`${t.toFixed(0)}ms`:`${(t/1e3).toFixed(2)}s`,e}(i.total)):"";e=function(t,e,i){qi||"string"!=typeof t||(e&&(t=`[${Qi(e)}m${t}[39m`),i&&(t=`[${Qi(i)+Ki}m${t}[49m`));return t}(e=i.time?`${t}: ${n}  ${e}`:`${t}: ${e}`,i.color,i.background)}return e}(this.id,r.message,r),i.bind(console,e,...r.args)}return sn}};function cn(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return tn(Number.isFinite(e)&&e>=0),e}function hn(t){const{logLevel:e,message:i}=t;t.logLevel=cn(e);const n=t.args?Array.from(t.args):[];for(;n.length&&n.shift()!==i;);switch(typeof e){case"string":case"function":void 0!==i&&n.unshift(i),t.message=e;break;case"object":Object.assign(t,e)}"function"==typeof t.message&&(t.message=t.message());const r=typeof t.message;return tn("string"===r||"object"===r),Object.assign(t,{args:n},t.opts)}function un(t){for(const e in t)for(const i in t[e])return i||"untitled";return"empty"}ln.VERSION=Ji;const dn=new ln({id:"loaders.gl"});class pn{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const fn={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){He(this,"console",void 0),this.console=console}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.console.log.bind(this.console,...e)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.console.info.bind(this.console,...e)}warn(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.console.warn.bind(this.console,...e)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return this.console.error.bind(this.console,...e)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:De,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},mn={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function gn(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state=t._state||{},t._state}const _n=()=>{const t=gn();return t.globalOptions=t.globalOptions||{...fn},t.globalOptions};function yn(t,e,i,n){return i=i||[],function(t,e){vn(t,null,fn,mn,e);for(const i of e){vn(t&&t[i.id]||{},i.id,i.options&&i.options[i.id]||{},i.deprecatedOptions&&i.deprecatedOptions[i.id]||{},e)}}(t,i=Array.isArray(i)?i:[i]),function(t,e,i){const n=t.options||{},r={...n};(function(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)})(r,i),null===r.log&&(r.log=new pn);return bn(r,_n()),bn(r,e),r}(e,t,n)}function vn(t,e,i,n,r){const s=e||"Top level",o=e?"".concat(e,"."):"";for(const a in t){const l=!e&&Ii(t[a]);if(!(a in i)&&!("baseUri"===a&&!e)&&!("workerUrl"===a&&e))if(a in n)dn.warn("".concat(s," loader option '").concat(o).concat(a,"' no longer supported, use '").concat(n[a],"'"))();else if(!l){const t=xn(a,r);dn.warn("".concat(s," loader option '").concat(o).concat(a,"' not recognized. ").concat(t))()}}}function xn(t,e){const i=t.toLowerCase();let n="";for(const r of e)for(const e in r.options){if(t===e)return"Did you mean '".concat(r.id,".").concat(e,"'?");const s=e.toLowerCase();(i.startsWith(s)||s.startsWith(i))&&(n=n||"Did you mean '".concat(r.id,".").concat(e,"'?"))}return n}function bn(t,e){for(const i in e)if(i in e){t[i]=Pi(e[i])&&Pi(t[i])?{...t[i],...e[i]}:e[i]}}function wn(t){var e;if(!t)return!1;Array.isArray(t)&&(t=t[0]);return Array.isArray(null===(e=t)||void 0===e?void 0:e.extensions)}function An(t){var e,i;let n;return Be(t,"null loader"),Be(wn(t),"invalid loader"),Array.isArray(t)&&(n=t[1],t=t[0],t={...t,options:{...t.options,...n}}),(null!==(e=t)&&void 0!==e&&e.parseTextSync||null!==(i=t)&&void 0!==i&&i.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}const Tn=()=>{const t=gn();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry};const Mn=new ln({id:"loaders.gl"}),Sn=/\.([^.]+)$/;function En(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!Cn(t))return null;if(e&&!Array.isArray(e))return An(e);let r=[];e&&(r=r.concat(e)),null!=i&&i.ignoreRegisteredLoaders||r.push(...Tn()),function(t){for(const e of t)An(e)}(r);const s=function(t,e,i,n){const r=Vi(t),s=ji(t),o=Gi(r)||(null==n?void 0:n.url);let a=null,l="";null!=i&&i.mimeType&&(a=Pn(e,null==i?void 0:i.mimeType),l="match forced by supplied MIME type ".concat(null==i?void 0:i.mimeType));var c;a=a||function(t,e){const i=e&&Sn.exec(e),n=i&&i[1];return n?function(t,e){e=e.toLowerCase();for(const i of t)for(const t of i.extensions)if(t.toLowerCase()===e)return i;return null}(t,n):null}(e,o),l=l||(a?"matched url ".concat(o):""),a=a||Pn(e,s),l=l||(a?"matched MIME type ".concat(s):""),a=a||function(t,e){if(!e)return null;for(const i of t)if("string"==typeof e){if(Ln(e,i))return i}else if(ArrayBuffer.isView(e)){if(Rn(e.buffer,e.byteOffset,i))return i}else if(e instanceof ArrayBuffer){if(Rn(e,0,i))return i}return null}(e,t),l=l||(a?"matched initial data ".concat(Bn(t)):""),a=a||Pn(e,null==i?void 0:i.fallbackMimeType),l=l||(a?"matched fallback MIME type ".concat(s):""),l&&Mn.log(1,"selectLoader selected ".concat(null===(c=a)||void 0===c?void 0:c.name,": ").concat(l,"."));return a}(t,r,i,n);if(!(s||null!=i&&i.nothrow))throw new Error(In(t));return s}function Cn(t){return!(t instanceof Response&&204===t.status)}function In(t){const e=Vi(t),i=ji(t);let n="No valid loader found (";n+=e?"".concat(Si(e),", "):"no url provided, ",n+="MIME type: ".concat(i?'"'.concat(i,'"'):"not provided",", ");const r=t?Bn(t):"";return n+=r?' first bytes: "'.concat(r,'"'):"first bytes: not available",n+=")",n}function Pn(t,e){for(const i of t){if(i.mimeTypes&&i.mimeTypes.includes(e))return i;if(e==="application/x.".concat(i.id))return i}return null}function Ln(t,e){if(e.testText)return e.testText(t);return(Array.isArray(e.tests)?e.tests:[e.tests]).some((e=>t.startsWith(e)))}function Rn(t,e,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some((n=>function(t,e,i,n){if(n instanceof ArrayBuffer)return function(t,e,i){if(t.byteLength<(i=i||t.byteLength)||e.byteLength<i)return!1;const n=new Uint8Array(t),r=new Uint8Array(e);for(let t=0;t<n.length;++t)if(n[t]!==r[t])return!1;return!0}(n,t,n.byteLength);switch(typeof n){case"function":return n(t,i);case"string":return n===Dn(t,e,n.length);default:return!1}}(t,e,i,n)))}function Bn(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return Dn(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer){return Dn(t,0,e)}return""}function Dn(t,e,i){if(t.byteLength<e+i)return"";const n=new DataView(t);let r="";for(let t=0;t<i;t++)r+=String.fromCharCode(n.getUint8(e+t));return r}const On=262144;const kn=262144;const Fn=1048576;function zn(t,e){return De?async function*(t,e){const i=t.getReader();let n;try{for(;;){const t=n||i.read();null!=e&&e._streamReadAhead&&(n=i.read());const{done:r,value:s}=await t;if(r)return;yield Mi(s)}}catch(t){i.releaseLock()}}(t,e):async function*(t,e){for await(const e of t)yield Mi(e)}(t)}function Nn(t,e){if("string"==typeof t)return function*(t,e){const i=(null==e?void 0:e.chunkSize)||On;let n=0;const r=new TextEncoder;for(;n<t.length;){const e=Math.min(t.length-n,i),s=t.slice(n,n+e);n+=e,yield r.encode(s)}}(t,e);if(t instanceof ArrayBuffer)return function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const{chunkSize:i=kn}=e;let n=0;for(;n<t.byteLength;){const e=Math.min(t.byteLength-n,i),r=new ArrayBuffer(e),s=new Uint8Array(t,n,e);new Uint8Array(r).set(s),n+=e,yield r}}()}(t,e);if(Di(t))return async function*(t,e){const i=(null==e?void 0:e.chunkSize)||Fn;let n=0;for(;n<t.size;){const e=n+i,r=await t.slice(n,e).arrayBuffer();n=e,yield r}}(t,e);if(ki(t))return zn(t,e);if(Bi(t)){return zn(t.body,e)}throw new Error("makeIterator")}const Un="Cannot convert supplied data type";async function Gn(t,e,i){const n=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if("string"==typeof t||n)return function(t,e,i){if(e.text&&"string"==typeof t)return t;if(Oi(t)&&(t=t.buffer),t instanceof ArrayBuffer){const i=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let i=t.buffer;const n=t.byteLength||t.length;return 0===t.byteOffset&&n===i.byteLength||(i=i.slice(t.byteOffset,t.byteOffset+n)),i}throw new Error(Un)}(t,e);if(Di(t)&&(t=await Hi(t)),Bi(t)){const i=t;return await async function(t){if(!t.ok){const e=await async function(t){let e="Failed to fetch resource ".concat(t.url," (").concat(t.status,"): ");try{const i=t.headers.get("Content-Type");let n=t.statusText;i.includes("application/json")&&(n+=" ".concat(await t.text())),e+=n,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch(t){}return e}(t);throw new Error(e)}}(i),e.binary?await i.arrayBuffer():await i.text()}if(ki(t)&&(t=Nn(t,i)),Li(t)||Ri(t))return _i(t);throw new Error(Un)}function Vn(t,e){const i=_n(),n=t||i;return"function"==typeof n.fetch?n.fetch:Ii(n.fetch)?t=>Wi(t,n):null!=e&&e.fetch?null==e?void 0:e.fetch:Wi}function jn(t,e,i){if(i)return i;const n={fetch:Vn(e,t),...t};if(n.url){const t=Gi(n.url);n.baseUrl=t,n.queryString=function(t){const e=t.match(Ui);return e&&e[0]}(n.url),n.filename=Si(t),n.baseUrl=Ei(t)}return Array.isArray(n.loaders)||(n.loaders=null),n}async function Hn(t,e,i,n){Fe(!n||"object"==typeof n),!e||Array.isArray(e)||wn(e)||(n=void 0,i=e,e=void 0),i=i||{};const r=Vi(t=await t),s=function(t,e){if(!e&&t&&!Array.isArray(t))return t;let i;if(t&&(i=Array.isArray(t)?t:[t]),e&&e.loaders){const t=Array.isArray(e.loaders)?e.loaders:[e.loaders];i=i?[...i,...t]:t}return i&&i.length?i:null}(e,n),o=await async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0;if(!Cn(t))return null;let r=En(t,e,{...i,nothrow:!0},n);if(r)return r;if(Di(t)&&(r=En(t=await t.slice(0,10).arrayBuffer(),e,i,n)),!(r||null!=i&&i.nothrow))throw new Error(In(t));return r}(t,s,i);return o?(n=jn({url:r,parse:Hn,loaders:s},i=yn(i,o,s,r),n||null),await async function(t,e,i,n){if(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ke;Fe(t,"no worker provided")}(t),Bi(e)){const t=e,{ok:i,redirected:r,status:s,statusText:o,type:a,url:l}=t,c=Object.fromEntries(t.headers.entries());n.response={headers:c,ok:i,redirected:r,status:s,statusText:o,type:a,url:l}}if(e=await Gn(e,t,i),t.parseTextSync&&"string"==typeof e)return i.dataType="text",t.parseTextSync(e,i,n,t);if(function(t,e){return!!ii.isSupported()&&!!(Ue||null!=e&&e._nodeWorkers)&&t.worker&&(null==e?void 0:e.worker)}(t,i))return await hi(t,e,i,n,Hn);if(t.parseText&&"string"==typeof e)return await t.parseText(e,i,n,t);if(t.parse)return await t.parse(e,i,n,t);throw Fe(!t.parseSync),new Error("".concat(t.id," loader - no parser found and worker is disabled"))}(o,t,i,n)):null}async function Wn(t,e,i,n){Array.isArray(e)||wn(e)||(i=e,e=void 0);const r=Vn(i);let s=t;return"string"==typeof t&&(s=await r(t)),Di(t)&&(s=await r(t)),await Hn(s,e,i)}const{_parseImageNode:qn}=globalThis,Xn="undefined"!=typeof Image,Zn="undefined"!=typeof ImageBitmap,Jn=Boolean(qn),Yn=!!De||Jn;function $n(t){const e=function(t){if("undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&t instanceof Image)return"image";if(t&&"object"==typeof t&&t.data&&t.width&&t.height)return"data";return null}(t);if(!e)throw new Error("Not an image");return e}const Kn=/^data:image\/svg\+xml/,Qn=/\.svg((\?|#).*)?$/;function tr(t){return t&&(Kn.test(t)||Qn.test(t))}function er(t,e){if(tr(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(t)])}async function ir(t,e,i){const n=function(t,e){if(tr(e)){let e=(new TextDecoder).decode(t);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(e=unescape(encodeURIComponent(e)))}catch(t){throw new Error(t.message)}return"data:image/svg+xml;base64,".concat(btoa(e))}return er(t,e)}(t,i),r=self.URL||self.webkitURL,s="string"!=typeof n&&r.createObjectURL(n);try{return await async function(t,e){const i=new Image;if(i.src=t,e.image&&e.image.decode&&i.decode)return await i.decode(),i;return await new Promise(((e,n)=>{try{i.onload=()=>e(i),i.onerror=e=>n(new Error("Could not load image ".concat(t,": ").concat(e)))}catch(t){n(t)}}))}(s||n,e)}finally{s&&r.revokeObjectURL(s)}}const nr={};let rr=!0;async function sr(t,e,i){let n;if(tr(i)){n=await ir(t,e,i)}else n=er(t,i);const r=e&&e.imagebitmap;return await async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;!function(t){for(const e in t||nr)return!1;return!0}(e)&&rr||(e=null);if(e)try{return await createImageBitmap(t,e)}catch(t){rr=!1}return await createImageBitmap(t)}(n,r)}function or(t){return function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=(r=e,[...r].map((t=>t.charCodeAt(0))));var r;for(let e=0;e<n.length;++e)if(n[e]!==t[e+i])return!1;return!0}(t,"ftyp",4)?0==(96&t[8])?null:function(t){switch((e=t,i=8,n=12,String.fromCharCode(...e.slice(i,n))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var e,i,n}(t):null}const ar=!1,lr=!0;function cr(t){const e=hr(t);return function(t){const e=hr(t),i=e.byteLength>=24&&2303741511===e.getUint32(0,ar);if(!i)return null;return{mimeType:"image/png",width:e.getUint32(16,ar),height:e.getUint32(20,ar)}}(e)||function(t){const e=hr(t),i=e.byteLength>=3&&65496===e.getUint16(0,ar)&&255===e.getUint8(2);if(!i)return null;const{tableMarkers:n,sofMarkers:r}=function(){const t=new Set([65499,65476,65484,65501,65534]);for(let e=65504;e<65520;++e)t.add(e);const e=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:t,sofMarkers:e}}();let s=2;for(;s+9<e.byteLength;){const t=e.getUint16(s,ar);if(r.has(t))return{mimeType:"image/jpeg",height:e.getUint16(s+5,ar),width:e.getUint16(s+7,ar)};if(!n.has(t))return null;s+=2,s+=e.getUint16(s,ar)}return null}(e)||function(t){const e=hr(t),i=e.byteLength>=10&&1195984440===e.getUint32(0,ar);if(!i)return null;return{mimeType:"image/gif",width:e.getUint16(6,lr),height:e.getUint16(8,lr)}}(e)||function(t){const e=hr(t),i=e.byteLength>=14&&16973===e.getUint16(0,ar)&&e.getUint32(2,lr)===e.byteLength;if(!i)return null;return{mimeType:"image/bmp",width:e.getUint32(18,lr),height:e.getUint32(22,lr)}}(e)||function(t){const e=new Uint8Array(t instanceof DataView?t.buffer:t),i=or(e);if(!i)return null;return{mimeType:i.mimeType,width:0,height:0}}(e)}function hr(t){if(t instanceof DataView)return t;if(ArrayBuffer.isView(t))return new DataView(t.buffer);if(t instanceof ArrayBuffer)return new DataView(t);throw new Error("toDataView")}const ur={id:"image",module:"images",name:"Images",version:"3.4.14",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function(t,e,i){const n=((e=e||{}).image||{}).type||"auto",{url:r}=i||{};let s;switch(function(t){switch(t){case"auto":case"data":return function(){if(Zn)return"imagebitmap";if(Xn)return"image";if(Yn)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(t){switch(t){case"auto":return Zn||Xn||Yn;case"imagebitmap":return Zn;case"image":return Xn;case"data":return Yn;default:throw new Error("@loaders.gl/images: image ".concat(t," not supported in this environment"))}}(t),t}}(n)){case"imagebitmap":s=await sr(t,e,r);break;case"image":s=await ir(t,e,r);break;case"data":s=await async function(t,e){const{mimeType:i}=cr(t)||{},n=globalThis._parseImageNode;return Be(n),await n(t,i)}(t);break;default:Be(!1)}return"data"===n&&(s=function(t){switch($n(t)){case"data":return t;case"image":case"imagebitmap":const e=document.createElement("canvas"),i=e.getContext("2d");if(!i)throw new Error("getImageData");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height);default:throw new Error("getImageData")}}(s)),s},tests:[t=>Boolean(cr(new DataView(t)))],options:{image:{type:"auto",decode:!0}}},dr={};function pr(t){if(void 0===dr[t]){const e=De?function(t){switch(t){case"image/avif":case"image/webp":return function(t){try{const e=document.createElement("canvas");return 0===e.toDataURL(t).indexOf("data:".concat(t))}catch(t){return!1}}(t);default:return!0}}(t):function(t){const e=["image/png","image/jpeg","image/gif"],{_parseImageNode:i,_imageFormatsNode:n=e}=globalThis;return Boolean(i)&&n.includes(t)}(t);dr[t]=e}return dr[t]}function fr(t){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const e="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,i=t||e;return!!(i&&i.indexOf("Electron")>=0)}function mr(){return!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||fr()}const gr={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},_r=gr.window||gr.self||gr.global,yr=gr.process||{},vr="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";mr();const xr=globalThis;function br(t){if(!t&&!mr())return"Node";if(fr(t))return"Electron";const e="undefined"!=typeof navigator?navigator:{},i=t||e.userAgent||"";if(i.indexOf("Edge")>-1)return"Edge";const n=-1!==i.indexOf("MSIE "),r=-1!==i.indexOf("Trident/");return n||r?"IE":xr.chrome?"Chrome":xr.safari?"Safari":xr.mozInnerScreenX?"Firefox":"Unknown"}class wr{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";He(this,"storage",void 0),He(this,"id",void 0),He(this,"config",{}),this.storage=function(t){try{const e=window[t],i="__storage_test__";return e.setItem(i,i),e.removeItem(i),e}catch(t){return null}}(i),this.id=t,this.config={},Object.assign(this.config,e),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){return this.config={},this.updateConfiguration(t)}updateConfiguration(t){if(Object.assign(this.config,t),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}return this}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}let Ar;function Tr(t){return"string"==typeof t?Ar[t.toUpperCase()]||Ar.WHITE:t}function Mr(t,e){if(!t)throw new Error(e||"Assertion failed")}function Sr(){let t;var e,i;if(mr&&"performance"in _r)t=null==_r||null===(e=_r.performance)||void 0===e||null===(i=e.now)||void 0===i?void 0:i.call(e);else if("hrtime"in yr){var n;const e=null==yr||null===(n=yr.hrtime)||void 0===n?void 0:n.call(yr);t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}!function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(Ar||(Ar={}));const Er={debug:mr&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Cr={enabled:!0,level:0};function Ir(){}const Pr={},Lr={once:!0};class Rr{constructor(){let{id:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};He(this,"id",void 0),He(this,"VERSION",vr),He(this,"_startTs",Sr()),He(this,"_deltaTs",Sr()),He(this,"_storage",void 0),He(this,"userData",{}),He(this,"LOG_THROTTLE_TIMEOUT",0),this.id=t,this._storage=new wr("__probe-".concat(this.id,"__"),Cr),this.userData={},this.timeStamp("".concat(this.id," started")),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const i=Object.getPrototypeOf(t),n=Object.getOwnPropertyNames(i);for(const i of n)"function"==typeof t[i]&&(e.find((t=>i===t))||(t[i]=t[i].bind(t)))}(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Sr()-this._startTs).toPrecision(10))}getDelta(){return Number((Sr()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(){return this._storage.updateConfiguration({enabled:!(arguments.length>0&&void 0!==arguments[0])||arguments[0]}),this}setLevel(t){return this._storage.updateConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.updateConfiguration({[t]:e})}settings(){}assert(t,e){Mr(t,e)}warn(t){return this._getLogFunction(0,t,Er.warn,arguments,Lr)}error(t){return this._getLogFunction(0,t,Er.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,Er.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,Er.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return this._getLogFunction(t,e,Er.debug||Er.info,arguments,Lr)}table(t,e,i){return e?this._getLogFunction(t,e,console.table||Ir,i&&[i],{tag:Or(e)}):Ir}image(t){let{logLevel:e,priority:i,image:n,message:r="",scale:s=1}=t;return this._shouldLog(e||i)?mr?function(t){let{image:e,message:i="",scale:n=1}=t;if("string"==typeof e){const t=new Image;return t.onload=()=>{!function(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=t.src.replace(/\(/g,"%28").replace(/\)/g,"%29");t.width>n&&(i=Math.min(i,n/t.width));const s=t.width*i,o=t.height*i,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(s/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(r,");"),"background-size:".concat(s,"px ").concat(o,"px;"),"color:transparent;"].join("");"".concat(e," %c+")}(t,i,n)},t.src=e,Ir}const r=e.nodeName||"";if("img"===r.toLowerCase())return Ir;if("canvas"===r.toLowerCase()){const t=new Image;return t.onload=()=>{},t.src=e.toDataURL(),Ir}return Ir}({image:n,message:r,scale:s}):function(t){let{image:e,message:i="",scale:n=1}=t,r=null;try{r=module.require("asciify-image")}catch(t){}if(r)return()=>r(e,{fit:"box",width:"".concat(Math.round(80*n),"%")}).then((t=>{}));return Ir}({image:n,message:r,scale:s}):Ir}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||Ir)}group(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const n=Dr({logLevel:t,message:e,opts:i}),{collapsed:r}=i;return n.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(n)}groupCollapsed(t,e){return this.group(t,e,Object.assign({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||Ir)}withGroup(t,e,i){this.group(t,e)();try{i()}finally{this.groupEnd(t)()}}trace(){}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=Br(t)}_getLogFunction(t,e,i,n,r){if(this._shouldLog(t)){r=Dr({logLevel:t,message:e,args:n,opts:r}),Mr(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=Sr();const s=r.tag||r.message;if(r.once){if(Pr[s])return Ir;Pr[s]=Sr()}return e=function(t,e,i){if("string"==typeof e){const o=i.time?function(t){const e=Math.max((arguments.length>1&&void 0!==arguments[1]?arguments[1]:8)-t.length,0);return"".concat(" ".repeat(e)).concat(t)}(function(t){let e;return e=t<10?"".concat(t.toFixed(2),"ms"):t<100?"".concat(t.toFixed(1),"ms"):t<1e3?"".concat(t.toFixed(0),"ms"):"".concat((t/1e3).toFixed(2),"s"),e}(i.total)):"";e=i.time?"".concat(t,": ").concat(o,"  ").concat(e):"".concat(t,": ").concat(e),n=e,r=i.color,s=i.background,mr||"string"!=typeof n||(r&&(r=Tr(r),n="[".concat(r,"m").concat(n,"[39m")),s&&(r=Tr(s),n="[".concat(s+10,"m").concat(n,"[49m"))),e=n}var n,r,s;return e}(this.id,r.message,r),i.bind(console,e,...r.args)}return Ir}}function Br(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return Mr(Number.isFinite(e)&&e>=0),e}function Dr(t){const{logLevel:e,message:i}=t;t.logLevel=Br(e);const n=t.args?Array.from(t.args):[];for(;n.length&&n.shift()!==i;);switch(typeof e){case"string":case"function":void 0!==i&&n.unshift(i),t.message=e;break;case"object":Object.assign(t,e)}"function"==typeof t.message&&(t.message=t.message());const r=typeof t.message;return Mr("string"===r||"object"===r),Object.assign(t,{args:n},t.opts)}function Or(t){for(const e in t)for(const i in t[e])return i||"untitled";return"empty"}He(Rr,"VERSION",vr);var kr=new Rr({id:"deck"});let Fr={};function zr(t){Fr=t}function Nr(t,e,i,n){kr.level>0&&Fr[t]&&Fr[t].call(null,e,i,n)}var Ur={id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:function(t){const e=t[0],i=t[t.length-1];return"{"===e&&"}"===i||"["===e&&"]"===i},parseTextSync:JSON.parse};const Gr=function(){const t="8.9.34",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==t)throw new Error("deck.gl - multiple versions detected: ".concat(e," vs ").concat(t));return e||(kr.log(1,"deck.gl ".concat(t))(),globalThis.deck={...globalThis.deck,VERSION:t,version:t,log:kr,_registerLoggers:zr},function(t){const e=Tn();t=Array.isArray(t)?t:[t];for(const i of t){const t=An(i);e.find((e=>t===e))||e.unshift(t)}}([Ur,[ur,{imagebitmap:{premultiplyAlpha:"none"}}]])),t}(),Vr={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Vr,"IDENTITY",{get:()=>(kr.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const jr={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Hr={common:0,meters:1,pixels:2},Wr={click:{handler:"onClick"},panstart:{handler:"onDragStart"},panmove:{handler:"onDrag"},panend:{handler:"onDragEnd"}},qr=new Rr({id:"luma.gl"});function Xr(t,e){if(!t)throw new Error(e||"luma.gl: assertion failed.")}const Zr="Requires WebGL2";function Jr(t){return"undefined"!=typeof WebGLRenderingContext&&t instanceof WebGLRenderingContext||("undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&Number.isFinite(t._version)))}function Yr(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&2===t._version)}function $r(t){return Xr(Jr(t),"Invalid WebGLRenderingContext"),t}function Kr(t){return Xr(Yr(t),Zr),t}const Qr={};function ts(t,e){var i;Qr[t]=!0,void 0!==e&&(i=e,globalThis.console&&globalThis.console.error&&globalThis.console.error(i))}const es=function t(e){const i=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let e=0;e<this.attribs.length;e++){const n=new t.VertexAttrib(i);this.attribs[e]=n}this.maxAttrib=0};(es.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const is=function(t){const e=this;this.gl=t,function(t){const e=t.getError;t.getError=function(){let i;do{i=e.apply(t),0!==i&&(Qr[i]=!0)}while(0!==i);for(i in Qr)if(Qr[i])return delete Qr[i],parseInt(i,10);return 0}}(t);const i=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(t){return t===e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject===e.defaultVertexArrayObject?null:e.currentVertexArrayObject:i.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(t){const n=e.currentVertexArrayObject;n.maxAttrib=Math.max(n.maxAttrib,t);return n.attribs[t].enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(t){const n=e.currentVertexArrayObject;n.maxAttrib=Math.max(n.maxAttrib,t);return n.attribs[t].enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(t,n){switch(t){case 34962:e.currentArrayBuffer=n;break;case 34963:e.currentVertexArrayObject.elementArrayBuffer=n}return i.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(t,n){const r=e.currentVertexArrayObject.attribs[t];switch(n){case 34975:return r.buffer;case 34338:return r.enabled;case 34339:return r.size;case 34340:return r.stride;case 34341:return r.type;case 34922:return r.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(t,n,r,s,o,a){const l=e.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,t);const c=l.attribs[t];return c.buffer=e.currentArrayBuffer,c.size=n,c.type=r,c.normalized=s,c.stride=o,c.offset=a,c.recache(),i.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas&&t.canvas.addEventListener("webglcontextrestored",(()=>{var t;t="OESVertexArrayObject emulation library context restored",globalThis.console&&globalThis.console.log&&globalThis.console.log(t),e.reset_()}),!0),this.reset_()};is.prototype.VERTEX_ARRAY_BINDING_OES=34229,is.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(let t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;this.maxVertexAttribs=this.gl.getParameter(34921),this.defaultVertexArrayObject=new es(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},is.prototype.createVertexArrayOES=function(){const t=new es(this);return this.vertexArrayObjects.push(t),t},is.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject===t&&this.bindVertexArrayOES(null)},is.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof es&&t.hasBeenBound&&t.ext===this)},is.prototype.bindVertexArrayOES=function(t){const e=this.gl;if(t&&!t.isAlive)return void ts(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");const i=this.original,n=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const r=this.currentVertexArrayObject;if(n===r)return;n&&r.elementArrayBuffer===n.elementArrayBuffer||i.bindBuffer.call(e,34963,r.elementArrayBuffer);let s=this.currentArrayBuffer;const o=Math.max(n?n.maxAttrib:0,r.maxAttrib);for(let t=0;t<=o;t++){const o=r.attribs[t],a=n?n.attribs[t]:null;if(n&&o.enabled===a.enabled||(o.enabled?i.enableVertexAttribArray.call(e,t):i.disableVertexAttribArray.call(e,t)),o.enabled){let r=!1;n&&o.buffer===a.buffer||(s!==o.buffer&&(i.bindBuffer.call(e,34962,o.buffer),s=o.buffer),r=!0),(r||o.cached!==a.cached)&&i.vertexAttribPointer.call(e,t,o.size,o.type,o.normalized,o.stride,o.offset)}}this.currentArrayBuffer!==s&&i.bindBuffer.call(e,34962,this.currentArrayBuffer)};const ns="OES_element_index",rs="WEBGL_draw_buffers",ss="WEBGL_debug_renderer_info",os=t=>Yr(t)?void 0:0,as={3074:t=>Yr(t)?void 0:36064,35723:t=>Yr(t)?void 0:4352,35977:os,32937:os,36795:(t,e)=>{const i=Yr(t)?t.getExtension("EXT_disjoint_timer_query_webgl2"):t.getExtension("EXT_disjoint_timer_query");return i&&i.GPU_DISJOINT_EXT?e(i.GPU_DISJOINT_EXT):0},37445:(t,e)=>{const i=t.getExtension(ss);return e(i&&i.UNMASKED_VENDOR_WEBGL||7936)},37446:(t,e)=>{const i=t.getExtension(ss);return e(i&&i.UNMASKED_RENDERER_WEBGL||7937)},34047:(t,e)=>{const i=t.luma.extensions.EXT_texture_filter_anisotropic;return i?e(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},32883:os,35071:os,37447:os,36063:(t,e)=>{if(!Yr(t)){const i=t.getExtension(rs);return i?e(i.MAX_COLOR_ATTACHMENTS_WEBGL):0}},35379:os,35374:os,35377:os,34852:t=>{if(!Yr(t)){const e=t.getExtension(rs);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},36203:t=>t.getExtension(ns)?2147483647:65535,33001:t=>t.getExtension(ns)?16777216:65535,33e3:t=>16777216,37157:os,35373:os,35657:os,36183:os,37137:os,34045:os,35978:os,35979:os,35968:os,35376:os,35375:os,35659:os,37154:os,35371:os,35658:os,35076:os,35077:os,35380:os};const ls="ANGLE_instanced_arrays";const cs={OES_vertex_array_object:{meta:{suffix:"OES"},createVertexArray:()=>{Xr(!1,"VertexArray requires WebGL2 or OES_vertex_array_object extension")},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[ls]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(t,e){Xr(0===e,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},WEBGL_draw_buffers:{meta:{suffix:"WEBGL"},drawBuffers:()=>{Xr(!1)}},EXT_disjoint_timer_query:{meta:{suffix:"EXT"},createQuery:()=>{Xr(!1)},deleteQuery:()=>{Xr(!1)},beginQuery:()=>{Xr(!1)},endQuery:()=>{},getQuery(t,e){return this.getQueryObject(t,e)},getQueryParameter(t,e){return this.getQueryObject(t,e)},getQueryObject:()=>{}}},hs={readBuffer:(t,e,i)=>{Yr(t)&&e(i)},getVertexAttrib:(t,e,i,n)=>{const{webgl2:r,ext:s}=function(t,e){return{webgl2:Yr(t),ext:t.getExtension(e)}}(t,ls);let o;switch(n){case 35069:o=!!r&&void 0;break;case 35070:o=r||s?void 0:0}return void 0!==o?o:e(i,n)},getProgramParameter:(t,e,i,n)=>{if(!Yr(t))switch(n){case 35967:return 35981;case 35971:case 35382:return 0}return e(i,n)},getInternalformatParameter:(t,e,i,n,r)=>Yr(t)||32937!==r?t.getInternalformatParameter(i,n,r):new Int32Array([0]),getTexParameter(t,e,i,n){if(34046===n){const{extensions:e}=t.luma,i=e.EXT_texture_filter_anisotropic;n=i&&i.TEXTURE_MAX_ANISOTROPY_EXT||34046}return e(i,n)},getParameter:function(t,e,i){const n=as[i],r="function"==typeof n?n(t,e,i):n;return void 0!==r?r:e(i)},hint:(t,e,i,n)=>e(i,n)};function us(t,e){let{extension:i,target:n,target2:r}=e;const s=cs[i];Xr(s);const{meta:o={}}=s,{suffix:a=""}=o,l=t.getExtension(i);for(const e of Object.keys(s)){const i="".concat(e).concat(a);let o=null;"meta"===e||"function"==typeof t[e]||(l&&"function"==typeof l[i]?o=function(){return l[i](...arguments)}:"function"==typeof s[e]&&(o=s[e].bind(n))),o&&(n[e]=o,r[e]=o)}}globalThis.polyfillContext=function(t){t.luma=t.luma||{};const{luma:e}=t;return e.polyfilled||(!function(t){if("function"==typeof t.createVertexArray)return;const e=t.getSupportedExtensions;t.getSupportedExtensions=function(){const t=e.call(this)||[];return t.indexOf("OES_vertex_array_object")<0&&t.push("OES_vertex_array_object"),t};const i=t.getExtension;t.getExtension=function(e){return i.call(this,e)||("OES_vertex_array_object"!==e?null:(t.__OESVertexArrayObject||(this.__OESVertexArrayObject=new is(this)),this.__OESVertexArrayObject))}}(t),function(t){t.luma.extensions={};const e=t.getSupportedExtensions()||[];for(const i of e)t.luma[i]=t.getExtension(i)}(t),function(t,e){for(const i of Object.getOwnPropertyNames(e))"overrides"!==i&&us(t,{extension:i,target:t.luma,target2:t})}(t,cs),function(t,e){let{target:i,target2:n}=e;Object.keys(hs).forEach((e=>{if("function"==typeof hs[e]){const r=t[e]?t[e].bind(t):()=>{},s=hs[e].bind(null,t,r);i[e]=s,n[e]=s}}))}(t,{target:e,target2:t}),e.polyfilled=!0),t};const ds={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,36006:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],3333:4,3317:4,37440:!1,37441:!1,37443:37444,35723:4352,36010:null,35977:!1,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},ps=(t,e,i)=>e?t.enable(i):t.disable(i),fs=(t,e,i)=>t.hint(i,e),ms=(t,e,i)=>t.pixelStorei(i,e);function gs(t){return Array.isArray(t)||ArrayBuffer.isView(t)}const _s={3042:ps,32773:(t,e)=>t.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(t,e)=>t.clearColor(...e),3107:(t,e)=>t.colorMask(...e),2884:ps,2885:(t,e)=>t.cullFace(e),2929:ps,2931:(t,e)=>t.clearDepth(e),2932:(t,e)=>t.depthFunc(e),2928:(t,e)=>t.depthRange(...e),2930:(t,e)=>t.depthMask(e),3024:ps,35723:fs,36006:(t,e)=>{const i=Yr(t)?36009:36160;return t.bindFramebuffer(i,e)},2886:(t,e)=>t.frontFace(e),33170:fs,2849:(t,e)=>t.lineWidth(e),32823:ps,32824:"polygonOffset",10752:"polygonOffset",35977:ps,32938:"sampleCoverage",32939:"sampleCoverage",3089:ps,3088:(t,e)=>t.scissor(...e),2960:ps,2961:(t,e)=>t.clearStencil(e),2968:(t,e)=>t.stencilMaskSeparate(1028,e),36005:(t,e)=>t.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(t,e)=>t.viewport(...e),3333:ms,3317:ms,37440:ms,37441:ms,37443:ms,3330:ms,3332:ms,3331:ms,36010:(t,e)=>t.bindFramebuffer(36008,e),3314:ms,32878:ms,3316:ms,3315:ms,32877:ms,framebuffer:(t,e)=>t.bindFramebuffer(36160,e&&"handle"in e?e.handle:e),blend:(t,e)=>e?t.enable(3042):t.disable(3042),blendColor:(t,e)=>t.blendColor(...e),blendEquation:(t,e)=>{e=gs(e)?e:[e,e],t.blendEquationSeparate(...e)},blendFunc:(t,e)=>{e=gs(e)&&2===e.length?[...e,...e]:e,t.blendFuncSeparate(...e)},clearColor:(t,e)=>t.clearColor(...e),clearDepth:(t,e)=>t.clearDepth(e),clearStencil:(t,e)=>t.clearStencil(e),colorMask:(t,e)=>t.colorMask(...e),cull:(t,e)=>e?t.enable(2884):t.disable(2884),cullFace:(t,e)=>t.cullFace(e),depthTest:(t,e)=>e?t.enable(2929):t.disable(2929),depthFunc:(t,e)=>t.depthFunc(e),depthMask:(t,e)=>t.depthMask(e),depthRange:(t,e)=>t.depthRange(...e),dither:(t,e)=>e?t.enable(3024):t.disable(3024),derivativeHint:(t,e)=>{t.hint(35723,e)},frontFace:(t,e)=>t.frontFace(e),mipmapHint:(t,e)=>t.hint(33170,e),lineWidth:(t,e)=>t.lineWidth(e),polygonOffsetFill:(t,e)=>e?t.enable(32823):t.disable(32823),polygonOffset:(t,e)=>t.polygonOffset(...e),sampleCoverage:(t,e)=>t.sampleCoverage(...e),scissorTest:(t,e)=>e?t.enable(3089):t.disable(3089),scissor:(t,e)=>t.scissor(...e),stencilTest:(t,e)=>e?t.enable(2960):t.disable(2960),stencilMask:(t,e)=>{e=gs(e)?e:[e,e];const[i,n]=e;t.stencilMaskSeparate(1028,i),t.stencilMaskSeparate(1029,n)},stencilFunc:(t,e)=>{e=gs(e)&&3===e.length?[...e,...e]:e;const[i,n,r,s,o,a]=e;t.stencilFuncSeparate(1028,i,n,r),t.stencilFuncSeparate(1029,s,o,a)},stencilOp:(t,e)=>{e=gs(e)&&3===e.length?[...e,...e]:e;const[i,n,r,s,o,a]=e;t.stencilOpSeparate(1028,i,n,r),t.stencilOpSeparate(1029,s,o,a)},viewport:(t,e)=>t.viewport(...e)};function ys(t,e,i){return void 0!==e[t]?e[t]:i[t]}const vs={blendEquation:(t,e,i)=>t.blendEquationSeparate(ys(32777,e,i),ys(34877,e,i)),blendFunc:(t,e,i)=>t.blendFuncSeparate(ys(32969,e,i),ys(32968,e,i),ys(32971,e,i),ys(32970,e,i)),polygonOffset:(t,e,i)=>t.polygonOffset(ys(32824,e,i),ys(10752,e,i)),sampleCoverage:(t,e,i)=>t.sampleCoverage(ys(32938,e,i),ys(32939,e,i)),stencilFuncFront:(t,e,i)=>t.stencilFuncSeparate(1028,ys(2962,e,i),ys(2967,e,i),ys(2963,e,i)),stencilFuncBack:(t,e,i)=>t.stencilFuncSeparate(1029,ys(34816,e,i),ys(36003,e,i),ys(36004,e,i)),stencilOpFront:(t,e,i)=>t.stencilOpSeparate(1028,ys(2964,e,i),ys(2965,e,i),ys(2966,e,i)),stencilOpBack:(t,e,i)=>t.stencilOpSeparate(1029,ys(34817,e,i),ys(34818,e,i),ys(34819,e,i))},xs={enable:(t,e)=>t({[e]:!0}),disable:(t,e)=>t({[e]:!1}),pixelStorei:(t,e,i)=>t({[e]:i}),hint:(t,e,i)=>t({[e]:i}),bindFramebuffer:(t,e,i)=>{switch(e){case 36160:return t({36006:i,36010:i});case 36009:return t({36006:i});case 36008:return t({36010:i});default:return null}},blendColor:(t,e,i,n,r)=>t({32773:new Float32Array([e,i,n,r])}),blendEquation:(t,e)=>t({32777:e,34877:e}),blendEquationSeparate:(t,e,i)=>t({32777:e,34877:i}),blendFunc:(t,e,i)=>t({32969:e,32968:i,32971:e,32970:i}),blendFuncSeparate:(t,e,i,n,r)=>t({32969:e,32968:i,32971:n,32970:r}),clearColor:(t,e,i,n,r)=>t({3106:new Float32Array([e,i,n,r])}),clearDepth:(t,e)=>t({2931:e}),clearStencil:(t,e)=>t({2961:e}),colorMask:(t,e,i,n,r)=>t({3107:[e,i,n,r]}),cullFace:(t,e)=>t({2885:e}),depthFunc:(t,e)=>t({2932:e}),depthRange:(t,e,i)=>t({2928:new Float32Array([e,i])}),depthMask:(t,e)=>t({2930:e}),frontFace:(t,e)=>t({2886:e}),lineWidth:(t,e)=>t({2849:e}),polygonOffset:(t,e,i)=>t({32824:e,10752:i}),sampleCoverage:(t,e,i)=>t({32938:e,32939:i}),scissor:(t,e,i,n,r)=>t({3088:new Int32Array([e,i,n,r])}),stencilMask:(t,e)=>t({2968:e,36005:e}),stencilMaskSeparate:(t,e,i)=>t({[1028===e?2968:36005]:i}),stencilFunc:(t,e,i,n)=>t({2962:e,2967:i,2963:n,34816:e,36003:i,36004:n}),stencilFuncSeparate:(t,e,i,n,r)=>t({[1028===e?2962:34816]:i,[1028===e?2967:36003]:n,[1028===e?2963:36004]:r}),stencilOp:(t,e,i,n)=>t({2964:e,2965:i,2966:n,34817:e,34818:i,34819:n}),stencilOpSeparate:(t,e,i,n,r)=>t({[1028===e?2964:34817]:i,[1028===e?2965:34818]:n,[1028===e?2966:34819]:r}),viewport:(t,e,i,n,r)=>t({2978:[e,i,n,r]})},bs=(t,e)=>t.isEnabled(e),ws={3042:bs,2884:bs,2929:bs,3024:bs,32823:bs,32926:bs,32928:bs,3089:bs,2960:bs,35977:bs};function As(t){for(const e in t)return!1;return!0}function Ts(t,e){if(t===e)return!0;const i=Array.isArray(t)||ArrayBuffer.isView(t),n=Array.isArray(e)||ArrayBuffer.isView(e);if(i&&n&&t.length===e.length){for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}return!1}function Ms(t,e){const i=t[e].bind(t);t[e]=function(){const e=arguments.length<=0?void 0:arguments[0];return e in t.state.cache&&t.state.enable?t.state.cache[e]:i(...arguments)},Object.defineProperty(t[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function Ss(t,e,i){const n=t[e].bind(t);t[e]=function(){for(var e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];const{valueChanged:o,oldValue:a}=i(t.state._updateCache,...r);return o&&n(...r),a},Object.defineProperty(t[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}class Es{constructor(t){let{copyState:e=!1,log:i=(()=>{})}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.program=null,this.stateStack=[],this.enable=!0,this.cache=e?function(t,e){if("number"==typeof(e=e||ds)){const i=e,n=ws[i];return n?n(t,i):t.getParameter(i)}const i=Array.isArray(e)?e:Object.keys(e),n={};for(const e of i){const i=ws[e];n[e]=i?i(t,Number(e)):t.getParameter(Number(e))}return n}(t):Object.assign({},ds),this.log=i,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){this.stateStack.push({})}pop(){Xr(this.stateStack.length>0);Ps(this.gl,this.stateStack[this.stateStack.length-1]),this.stateStack.pop()}_updateCache(t){let e,i=!1;const n=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const r in t){Xr(void 0!==r);const s=t[r],o=this.cache[r];Ts(s,o)||(i=!0,e=o,n&&!(r in n)&&(n[r]=o),this.cache[r]=s)}return{valueChanged:i,oldValue:e}}}function Cs(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{enable:i=!0,copyState:n}=e;if(Xr(void 0!==n),!t.state){const{polyfillContext:e}=globalThis;e&&e(t),t.state=new Es(t,{copyState:n}),function(t){const e=t.useProgram.bind(t);t.useProgram=function(i){t.state.program!==i&&(e(i),t.state.program=i)}}(t);for(const e in xs){Ss(t,e,xs[e])}Ms(t,"getParameter"),Ms(t,"isEnabled")}return t.state.enable=i,t}function Is(t){Xr(t.state),t.state.pop()}function Ps(t,e){if(Xr(Jr(t),"setParameters requires a WebGL context"),As(e))return;const i={};for(const n in e){const r=Number(n),s=_s[n];s&&("string"==typeof s?i[s]=!0:s(t,e[n],r))}const n=t.state&&t.state.cache;if(n)for(const r in i){(0,vs[r])(t,e,n)}}function Ls(t,e,i){if(As(e))return i(t);const{nocatch:n=!0}=e;let r;if(function(t){t.state||Cs(t,{copyState:!1}),t.state.push()}(t),Ps(t,e),n)r=i(t),Is(t);else try{r=i(t)}finally{Is(t)}return r}function Rs(t){const{luma:e}=t;if(t.canvas&&e){const i=e.canvasSizeInfo,n="clientWidth"in i?i.clientWidth:t.canvas.clientWidth;return n?t.drawingBufferWidth/n:1}return 1}function Bs(t,e){let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function(t,e,i,n,r){const s=Ds(t[0],e,i);let o=Os(t[1],e,n,r),a=Ds(t[0]+1,e,i);const l=a===i-1?a:a-1;let c;a=Os(t[1]+1,e,n,r),r?(a=0===a?a:a+1,c=o,o=a):c=a===n-1?a:a-1;return{x:s,y:o,width:Math.max(l-s+1,1),height:Math.max(c-o+1,1)}}(e,Rs(t),t.drawingBufferWidth,t.drawingBufferHeight,i)}function Ds(t,e,i){return Math.min(Math.round(t*e),i-1)}function Os(t,e,i,n){return n?Math.max(0,i-1-Math.round(t*e)):Math.min(Math.round(t*e),i-1)}const ks=mr(),Fs=ks&&"undefined"!=typeof document,zs={webgl2:!0,webgl1:!0,throwOnError:!0,manageState:!0,canvas:null,debug:!1,width:800,height:600};function Ns(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Xr(ks,"createGLContext only available in the browser.\nCreate your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils"),t=Object.assign({},zs,t);const{width:e,height:i}=t;function n(e){if(t.throwOnError)throw new Error(e);return null}let r;t.onError=n;const{canvas:s}=t,o=function(t){let e,{canvas:i,width:n=800,height:r=600,onError:s}=t;if("string"==typeof i){Fs&&"complete"===document.readyState||s("createGLContext called on canvas '".concat(i,"' before page was loaded")),e=document.getElementById(i)}else i?e=i:(e=document.createElement("canvas"),e.id="lumagl-canvas",e.style.width=Number.isFinite(n)?"".concat(n,"px"):"100%",e.style.height=Number.isFinite(r)?"".concat(r,"px"):"100%",document.body.insertBefore(e,document.body.firstChild));return e}({canvas:s,width:e,height:i,onError:n});return r=function(t,e){const{onError:i}=e;let n=null;const r=t=>n=t.statusMessage||n;t.addEventListener("webglcontextcreationerror",r,!1);const{webgl1:s=!0,webgl2:o=!0}=e;let a=null;o&&(a=a||t.getContext("webgl2",e),a=a||t.getContext("experimental-webgl2",e));s&&(a=a||t.getContext("webgl",e),a=a||t.getContext("experimental-webgl",e));if(t.removeEventListener("webglcontextcreationerror",r,!1),!a)return i("Failed to create ".concat(o&&!s?"WebGL2":"WebGL"," context: ").concat(n||"Unknown error"));e.onContextLost&&t.addEventListener("webglcontextlost",e.onContextLost,!1);e.onContextRestored&&t.addEventListener("webglcontextrestored",e.onContextRestored,!1);return a}(o,t),r?(r=Us(r,t),function(t){const e=Yr(t)?"WebGL2":"WebGL1",i=function(t){const e=t.getParameter(7936),i=t.getParameter(7937),n=t.getExtension("WEBGL_debug_renderer_info"),r=n&&t.getParameter(n.UNMASKED_VENDOR_WEBGL||7936),s=n&&t.getParameter(n.UNMASKED_RENDERER_WEBGL||7937);return{vendor:r||e,renderer:s||i,vendorMasked:e,rendererMasked:i,version:t.getParameter(7938),shadingLanguageVersion:t.getParameter(35724)}}(t),n=i?"(".concat(i.vendor,",").concat(i.renderer,")"):"",r=t.debug?" debug":"";qr.info(1,"".concat(e).concat(r," context ").concat(n))()}(r),r):null}function Us(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t||t._instrumented)return t;t._version=t._version||function(t){if("undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext)return 2;return 1}(t),t.luma=t.luma||{},t.luma.canvasSizeInfo=t.luma.canvasSizeInfo||{},e=Object.assign({},zs,e);const{manageState:i,debug:n}=e;return i&&Cs(t,{copyState:!1,log:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return qr.log(1,...e)()}}),ks&&n&&(globalThis.makeDebugContext?(t=globalThis.makeDebugContext(t,e),qr.level=Math.max(qr.level,1)):qr.warn('WebGL debug mode not activated. import "@luma.gl/debug" to enable.')()),t._instrumented=!0,t}function Gs(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t.canvas){return void function(t,e,i){let n="width"in i?i.width:t.canvas.clientWidth,r="height"in i?i.height:t.canvas.clientHeight;n&&r||(qr.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,n=t.canvas.width||1,r=t.canvas.height||1);t.luma=t.luma||{},t.luma.canvasSizeInfo=t.luma.canvasSizeInfo||{};const s=t.luma.canvasSizeInfo;if(s.clientWidth!==n||s.clientHeight!==r||s.devicePixelRatio!==e){let i=e;const s=Math.floor(n*i),o=Math.floor(r*i);t.canvas.width=s,t.canvas.height=o,t.drawingBufferWidth===s&&t.drawingBufferHeight===o||(qr.warn("Device pixel ratio clamped")(),i=Math.min(t.drawingBufferWidth/n,t.drawingBufferHeight/r),t.canvas.width=Math.floor(n*i),t.canvas.height=Math.floor(r*i)),Object.assign(t.luma.canvasSizeInfo,{clientWidth:n,clientHeight:r,devicePixelRatio:e})}}(t,function(t){const e="undefined"==typeof window?1:window.devicePixelRatio||1;return Number.isFinite(t)?t<=0?1:t:t?e:1}(e.useDevicePixels),e)}const i=t.getExtension("STACKGL_resize_drawingbuffer");i&&"width"in e&&"height"in e&&i.resize(e.width,e.height)}function Vs(){let t;if("undefined"!=typeof window&&window.performance)t=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const e=process.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}let js=class{constructor(t,e){He(this,"name",void 0),He(this,"type",void 0),He(this,"sampleSize",1),He(this,"time",void 0),He(this,"count",void 0),He(this,"samples",void 0),He(this,"lastTiming",void 0),He(this,"lastSampleTime",void 0),He(this,"lastSampleCount",void 0),He(this,"_count",0),He(this,"_time",0),He(this,"_samples",0),He(this,"_startTime",0),He(this,"_timerPending",!1),this.name=t,this.type=e,this.reset()}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=Vs(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(Vs()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}},Hs=class{constructor(t){He(this,"id",void 0),He(this,"stats",{}),this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t){return this._getOrCreate({name:t,type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count"})}get size(){return Object.keys(this.stats).length}reset(){for(const t in this.stats)this.stats[t].reset();return this}forEach(t){for(const e in this.stats)t(this.stats[e])}getTable(){const t={};return this.forEach((e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}})),t}_initializeStats(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((t=>this._getOrCreate(t)))}_getOrCreate(t){if(!t||!t.name)return null;const{name:e,type:i}=t;return this.stats[e]||(this.stats[e]=t instanceof js?t:new js(e,i)),this.stats[e]}};const Ws="8.5.21";const qs=new class{constructor(){this.stats=new Map}get(t){return this.stats.has(t)||this.stats.set(t,new Hs({id:t})),this.stats.get(t)}};if(globalThis.luma&&globalThis.luma.VERSION!==Ws)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(Ws));function Xs(t,e){if(!t)throw new Error(e||"luma.gl: assertion failed.")}function Zs(t,e){if("string"!=typeof e)return e;const i=Number(e);if(!isNaN(i))return i;const n=t[e=e.replace(/^.*\./,"")];return Xs(void 0!==n,"Accessing undefined constant GL.".concat(e)),n}function Js(t,e){e=Number(e);for(const i in t)if(t[i]===e)return"GL.".concat(i);return String(e)}globalThis.luma||(mr()&&qr.log(1,"luma.gl ".concat(Ws," - ").concat("set luma.log.level=1 (or higher) to trace rendering"))(),globalThis.luma=globalThis.luma||{VERSION:Ws,version:Ws,log:qr,stats:qs,globals:{modules:{},nodeIO:{}}});const Ys={};function $s(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";Ys[t]=Ys[t]||1;const e=Ys[t]++;return"".concat(t,"-").concat(e)}function Ks(t){return Xs("number"==typeof t,"Input must be a number"),t&&0==(t&t-1)}function Qs(t){let e=!0;for(const i in t){e=!1;break}return e}function to(t,e,i,n){const r="See luma.gl ".concat(i," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),s=Object.getPrototypeOf(t);n.forEach((t=>{s.methodName||(s[t]=()=>{throw qr.removed("Calling removed method ".concat(e,".").concat(t,": "),r)(),new Error(t)})}))}const eo="Resource subclass must define virtual methods";let io=class{get[Symbol.toStringTag](){return"Resource"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};$r(t);const{id:i,userData:n={}}=e;this.gl=t,this.gl2=t,this.id=i||$s(this[Symbol.toStringTag]),this.userData=n,this._bound=!1,this._handle=e.handle,void 0===this._handle&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,e&&t&&e.filter(Boolean).forEach((t=>t.delete())),this}bind(){let t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.handle;return"function"!=typeof e?(this._bindHandle(e),this):(this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t)}unbind(){this.bind(null)}getParameter(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Xs(t=Zs(this.gl,t));const i=(this.constructor.PARAMETERS||{})[t];if(i){const t=Yr(this.gl);if(!((!("webgl2"in i)||t)&&(!("extension"in i)||this.gl.getExtension(i.extension)))){return t?"webgl2"in i?i.webgl2:i.webgl1:i.webgl1}}return this._getParameter(t,e)}getParameters(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{parameters:e,keys:i}=t,n=this.constructor.PARAMETERS||{},r=Yr(this.gl),s={},o=e||Object.keys(n);for(const e of o){const o=n[e];if(o&&(!("webgl2"in o)||r)&&(!("extension"in o)||this.gl.getExtension(o.extension))){const n=i?Js(this.gl,e):e;s[n]=this.getParameter(e,t),i&&"GLenum"===o.type&&(s[n]=Js(this.gl,s[n]))}}return s}setParameter(t,e){Xs(t=Zs(this.gl,t));const i=(this.constructor.PARAMETERS||{})[t];if(i){const t=Yr(this.gl);if(!((!("webgl2"in i)||t)&&(!("extension"in i)||this.gl.getExtension(i.extension))))throw new Error("Parameter not available on this platform");"GLenum"===i.type&&(e=Zs(e))}return this._setParameter(t,e),this}setParameters(t){for(const e in t)this.setParameter(e,t[e]);return this}stubRemovedMethods(t,e,i){return to(this,t,e,i)}initialize(t){}_createHandle(){throw new Error(eo)}_deleteHandle(){throw new Error(eo)}_bindHandle(t){throw new Error(eo)}_getOptsFromHandle(){throw new Error(eo)}_getParameter(t,e){throw new Error(eo)}_setParameter(t,e){throw new Error(eo)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const t=this[Symbol.toStringTag],e=qs.get("Resource Counts");e.get("Resources Created").incrementCount(),e.get("".concat(t,"s Created")).incrementCount(),e.get("".concat(t,"s Active")).incrementCount()}_removeStats(){const t=this[Symbol.toStringTag];qs.get("Resource Counts").get("".concat(t,"s Active")).decrementCount()}_trackAllocatedMemory(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag];this._trackAllocatedMemoryForContext(t,e),this._trackAllocatedMemoryForContext(t,e,this.gl.canvas&&this.gl.canvas.id),this.byteLength=t}_trackAllocatedMemoryForContext(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag];const i=qs.get("Memory Usage".concat(arguments.length>2&&void 0!==arguments[2]?arguments[2]:""));i.get("GPU Memory").addCount(t),i.get("".concat(e," Memory")).addCount(t)}_trackDeallocatedMemory(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag];this._trackDeallocatedMemoryForContext(t),this._trackDeallocatedMemoryForContext(t,this.gl.canvas&&this.gl.canvas.id),this.byteLength=0}_trackDeallocatedMemoryForContext(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag];const e=qs.get("Memory Usage".concat(arguments.length>1&&void 0!==arguments[1]?arguments[1]:""));e.get("GPU Memory").subtractCount(this.byteLength),e.get("".concat(t," Memory")).subtractCount(this.byteLength)}};const no="Failed to deduce GL constant from typed array";function ro(t){switch(ArrayBuffer.isView(t)?t.constructor:t){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(no)}}function so(t){let{clamped:e=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(t){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function oo(t){let{data:e,width:i,height:n}=t;const r=Math.round(i/2),s=Math.round(n/2),o=new Uint8Array(r*s*4);for(let t=0;t<s;t++)for(let n=0;n<r;n++)for(let s=0;s<4;s++)o[4*(t*r+n)+s]=e[4*(2*t*i+2*n)+s];return{data:o,width:r,height:s}}function ao(t,e,i){const{removedProps:n={},deprecatedProps:r={},replacedProps:s={}}=i;for(const i in n)if(i in e){const e=n[i]?"".concat(t,".").concat(n[i]):"N/A";qr.removed("".concat(t,".").concat(i),e)()}for(const i in r)if(i in e){const e=r[i];qr.deprecated("".concat(t,".").concat(i),"".concat(t,".").concat(e))()}let o=null;for(const i in s)if(i in e){const n=s[i];qr.deprecated("".concat(t,".").concat(i),"".concat(t,".").concat(n))(),o=o||Object.assign({},e),o[n]=e[i],delete o[i]}return o||e}const lo={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},co={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class ho{static getBytesPerElement(t){return so(t.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(t){Xs(t.size);return so(t.type||5126).BYTES_PER_ELEMENT*t.size}static resolve(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return new ho(...[lo,...e])}constructor(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];e.forEach((t=>this._assign(t))),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return ho.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return ho.getBytesPerVertex(this)}_assign(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=ao("Accessor",t,co),void 0!==t.type&&(this.type=t.type,5124!==t.type&&5125!==t.type||(this.integer=!0)),void 0!==t.size&&(this.size=t.size),void 0!==t.offset&&(this.offset=t.offset),void 0!==t.stride&&(this.stride=t.stride),void 0!==t.normalized&&(this.normalized=t.normalized),void 0!==t.integer&&(this.integer=t.integer),void 0!==t.divisor&&(this.divisor=t.divisor),void 0!==t.buffer&&(this.buffer=t.buffer),void 0!==t.index&&(this.index="boolean"==typeof t.index?t.index?1:0:t.index),void 0!==t.instanced&&(this.divisor=t.instanced?1:0),void 0!==t.isInstanced&&(this.divisor=t.isInstanced?1:0),this}}const uo={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},po={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:uo},fo={removedProps:uo};class mo extends io{get[Symbol.toStringTag](){return"Buffer"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=e.target||(this.gl.webgl2?36662:34962),this.initialize(e),Object.seal(this)}getElementCount(){return Math.round(this.byteLength/ho.getBytesPerElement(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor))}getVertexCount(){return Math.round(this.byteLength/ho.getBytesPerVertex(arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor))}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ArrayBuffer.isView(t)&&(t={data:t}),Number.isFinite(t)&&(t={byteLength:t}),t=ao("Buffer",t,po),this.usage=t.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},t,t.accessor)),t.data?this._setData(t.data,t.offset,t.byteLength):this._setByteLength(t.byteLength||0),this}setProps(t){return"accessor"in(t=ao("Buffer",t,fo))&&this.setAccessor(t.accessor),this}setAccessor(t){return delete(t=Object.assign({},t)).buffer,this.accessor=new ho(t),this}reallocate(t){return t>this.byteLength?(this._setByteLength(t),!0):(this.bytesUsed=t,!1)}setData(t){return this.initialize(t)}subData(t){ArrayBuffer.isView(t)&&(t={data:t});const{data:e,offset:i=0,srcOffset:n=0}=t,r=t.byteLength||t.length;Xs(e);const s=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(s,this.handle),0!==n||void 0!==r?(Kr(this.gl),this.gl.bufferSubData(this.target,i,e,n,r)):this.gl.bufferSubData(s,i,e),this.gl.bindBuffer(s,null),this.debugData=null,this._inferType(e),this}copyData(t){let{sourceBuffer:e,readOffset:i=0,writeOffset:n=0,size:r}=t;const{gl:s}=this;return Kr(s),s.bindBuffer(36662,e.handle),s.bindBuffer(36663,this.handle),s.copyBufferSubData(36662,36663,i,n,r),s.bindBuffer(36662,null),s.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:t=null,srcByteOffset:e=0,dstOffset:i=0,length:n=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Kr(this.gl);const r=so(this.accessor.type||5126,{clamped:!1}),s=this._getAvailableElementCount(e),o=i;let a,l;t?(l=t.length,a=l-o):(a=Math.min(s,n||s),l=o+a);const c=Math.min(s,a);return n=n||c,Xs(n<=c),t=t||new r(l),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,t,i,n),this.gl.bindBuffer(36662,null),t}bind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index,offset:i=0,size:n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===t||35982===t?void 0!==n?this.gl.bindBufferRange(t,e,this.handle,i,n):(Xs(0===i),this.gl.bindBufferBase(t,e,this.handle)):this.gl.bindBuffer(t,this.handle),this}unbind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===t||35982===t?this.gl.bindBufferBase(t,e,null):this.gl.bindBuffer(t,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(10,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.byteLength+e;Xs(ArrayBuffer.isView(t)),this._trackDeallocatedMemory();const n=this._getTarget();this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,this.usage),this.gl.bufferSubData(n,e,t),this.gl.bindBuffer(n,null),this.debugData=t.slice(0,10),this.bytesUsed=i,this._trackAllocatedMemory(i);const r=ro(t);return Xs(r),this.setAccessor(new ho(this.accessor,{type:r})),this}_setByteLength(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.usage;Xs(t>=0),this._trackDeallocatedMemory();let i=t;0===t&&(i=new Float32Array(0));const n=this._getTarget();return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,i,e),this.gl.bindBuffer(n,null),this.usage=e,this.debugData=null,this.bytesUsed=t,this._trackAllocatedMemory(t),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(t){const e=t/so(this.accessor.type||5126,{clamped:!1}).BYTES_PER_ELEMENT;return this.getElementCount()-e}_inferType(t){this.accessor.type||this.setAccessor(new ho(this.accessor,{type:ro(t)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(t){this.gl.bindBuffer(this.target,this.handle);const e=this.gl.getBufferParameter(this.target,t);return this.gl.bindBuffer(this.target,null),e}get type(){return qr.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return qr.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(t){return qr.deprecated("setByteLength","reallocate")(),this.reallocate(t)}updateAccessor(t){return qr.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new ho(this.accessor,t),this}}const go={6407:{dataFormat:6407,types:[5121,33635]},6408:{dataFormat:6408,types:[5121,32819,32820]},6406:{dataFormat:6406,types:[5121]},6409:{dataFormat:6409,types:[5121]},6410:{dataFormat:6410,types:[5121]},33326:{dataFormat:6403,types:[5126],gl2:!0},33328:{dataFormat:33319,types:[5126],gl2:!0},34837:{dataFormat:6407,types:[5126],gl2:!0},34836:{dataFormat:6408,types:[5126],gl2:!0}},_o={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},yo={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};const vo=[9729,9728],xo=globalThis.WebGLBuffer||function(){};let bo=class extends io{get[Symbol.toStringTag](){return"Texture"}static isSupported(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{format:i,linearFiltering:n}=e;let r=!0;return i&&(r=r&&function(t,e){const i=go[e];if(!i)return!1;if(void 0===i.gl1&&void 0===i.gl2)return!0;const n=Yr(t)&&i.gl2||i.gl1;return"string"==typeof n?t.getExtension(n):n}(t,i),r=r&&(!n||function(t,e){const i=go[e];switch(i&&i.types[0]){case 5126:return t.getExtension("OES_texture_float_linear");case 5131:return t.getExtension("OES_texture_half_float_linear");default:return!0}}(t,i))),r}constructor(t,e){const{id:i=$s("texture"),handle:n,target:r}=e;super(t,{id:i,handle:n}),this.target=r,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.data;if(e instanceof Promise)return e.then((e=>this.initialize(Object.assign({},t,{pixels:e,data:e})))),this;const i="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement;if(i&&e.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,e.addEventListener("loadeddata",(()=>this.initialize(t))),this;const{pixels:n=null,format:r=6408,border:s=0,recreate:o=!1,parameters:a={},pixelStore:l={},textureUnit:c}=t;e||(e=n);let{width:h,height:u,dataFormat:d,type:p,compressed:f=!1,mipmaps:m=!0}=t;const{depth:g=0}=t;return({width:h,height:u,compressed:f,dataFormat:d,type:p}=this._deduceParameters({format:r,type:p,dataFormat:d,compressed:f,data:e,width:h,height:u})),this.width=h,this.height=u,this.depth=g,this.format=r,this.type=p,this.dataFormat=d,this.border=s,this.textureUnit=c,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),m&&this._isNPOT()&&(qr.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),m=!1,this._updateForNPOT(a)),this.mipmaps=m,this.setImageData({data:e,width:h,height:u,depth:g,format:r,type:p,dataFormat:d,border:s,mipmaps:m,parameters:l,compressed:f}),m&&this.generateMipmap(),this.setParameters(a),o&&(this.data=e),i&&(this._video={video:e,parameters:a,lastTime:e.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?e.currentTime:-1}),this}update(){if(this._video){const{video:t,parameters:e,lastTime:i}=this._video;if(i===t.currentTime||t.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:t,parameters:e}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=t.currentTime}}resize(t){let{height:e,width:i,mipmaps:n=!1}=t;return i!==this.width||e!==this.height?this.initialize({width:i,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:n}):this}generateMipmap(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._isNPOT()?(qr.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),Ls(this.gl,t,(()=>{this.gl.generateMipmap(this.target)})),this.gl.bindTexture(this.target,null),this)}setImageData(t){this._trackDeallocatedMemory("Texture");const{target:e=this.target,pixels:i=null,level:n=0,format:r=this.format,border:s=this.border,offset:o=0,parameters:a={}}=t;let{data:l=null,type:c=this.type,width:h=this.width,height:u=this.height,dataFormat:d=this.dataFormat,compressed:p=!1}=t;l||(l=i),({type:c,dataFormat:d,compressed:p,width:h,height:u}=this._deduceParameters({format:r,type:c,dataFormat:d,compressed:p,data:l,width:h,height:u}));const{gl:f}=this;f.bindTexture(this.target,this.handle);let m,g=null;({data:l,dataType:g}=this._getDataType({data:l,compressed:p}));let _=0;if(Ls(this.gl,a,(()=>{switch(g){case"null":f.texImage2D(e,n,r,h,u,s,d,c,l);break;case"typed-array":f.texImage2D(e,n,r,h,u,s,d,c,l,o);break;case"buffer":m=Kr(f),m.bindBuffer(35052,l.handle||l),m.texImage2D(e,n,r,h,u,s,d,c,o),m.bindBuffer(35052,null);break;case"browser-object":Yr(f)?f.texImage2D(e,n,r,h,u,s,d,c,l):f.texImage2D(e,n,r,d,c,l);break;case"compressed":for(const[t,i]of l.entries())f.compressedTexImage2D(e,t,i.format,i.width,i.height,s,i.data),_+=i.levelSize;break;default:Xs(!1,"Unknown image data type")}})),"compressed"===g)this._trackAllocatedMemory(_,"Texture");else if(l&&l.byteLength)this._trackAllocatedMemory(l.byteLength,"Texture");else{this._trackAllocatedMemory(this.width*this.height*(_o[this.dataFormat]||4)*(yo[this.type]||1),"Texture")}return this.loaded=!0,this}setSubImageData(t){let{target:e=this.target,pixels:i=null,data:n=null,x:r=0,y:s=0,width:o=this.width,height:a=this.height,level:l=0,format:c=this.format,type:h=this.type,dataFormat:u=this.dataFormat,compressed:d=!1,offset:p=0,border:f=this.border,parameters:m={}}=t;if(({type:h,dataFormat:u,compressed:d,width:o,height:a}=this._deduceParameters({format:c,type:h,dataFormat:u,compressed:d,data:n,width:o,height:a})),Xs(0===this.depth,"texSubImage not supported for 3D textures"),n||(n=i),n&&n.data){const t=n;n=t.data,o=t.shape[0],a=t.shape[1]}n instanceof mo&&(n=n.handle),this.gl.bindTexture(this.target,this.handle),Ls(this.gl,m,(()=>{if(d)this.gl.compressedTexSubImage2D(e,l,r,s,o,a,c,n);else if(null===n)this.gl.texSubImage2D(e,l,r,s,o,a,u,h,null);else if(ArrayBuffer.isView(n))this.gl.texSubImage2D(e,l,r,s,o,a,u,h,n,p);else if(n instanceof xo){const t=Kr(this.gl);t.bindBuffer(35052,n),t.texSubImage2D(e,l,r,s,o,a,u,h,p),t.bindBuffer(35052,null)}else if(Yr(this.gl)){Kr(this.gl).texSubImage2D(e,l,r,s,o,a,u,h,n)}else this.gl.texSubImage2D(e,l,r,s,u,h,n)})),this.gl.bindTexture(this.target,null)}copyFramebuffer(){return null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:e}=this;return void 0!==t&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,this.handle),t}unbind(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:e}=this;return void 0!==t&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,null),t}_getDataType(t){let{data:e,compressed:i=!1}=t;return i?{data:e,dataType:"compressed"}:null===e?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof mo?{data:e.handle,dataType:"buffer"}:e instanceof xo?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(t){const{format:e,data:i}=t;let{width:n,height:r,dataFormat:s,type:o,compressed:a}=t;const l=go[e];return s=s||l&&l.dataFormat,o=o||l&&l.types[0],a=a||l&&l.compressed,({width:n,height:r}=this._deduceImageSize(i,n,r)),{dataFormat:s,type:o,compressed:a,width:n,height:r,format:e,data:i}}_deduceImageSize(t,e,i){let n;return n="undefined"!=typeof ImageData&&t instanceof ImageData?{width:t.width,height:t.height}:"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement?{width:t.naturalWidth,height:t.naturalHeight}:"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?{width:t.width,height:t.height}:"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t?{width:e,height:i}:{width:e>=0?e:1,height:i>=0?i:1},Xs(n,"Could not deduced texture size"),Xs(void 0===e||n.width===e,"Deduced texture width does not match supplied width"),Xs(void 0===i||n.height===i,"Deduced texture height does not match supplied height"),n}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(t){switch(t){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const e=this.gl.getTexParameter(this.target,t);return this.gl.bindTexture(this.target,null),e}}_setParameter(t,e){switch(this.gl.bindTexture(this.target,this.handle),e=this._getNPOTParam(t,e),t){case 33082:case 33083:this.gl.texParameterf(this.handle,t,e);break;case 4096:case 4097:Xs(!1);break;default:this.gl.texParameteri(this.target,t,e)}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return!Yr(this.gl)&&(!(!this.width||!this.height)&&(!Ks(this.width)||!Ks(this.height)))}_updateForNPOT(t){void 0===t[this.gl.TEXTURE_MIN_FILTER]&&(t[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),void 0===t[this.gl.TEXTURE_WRAP_S]&&(t[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),void 0===t[this.gl.TEXTURE_WRAP_T]&&(t[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(t,e){if(this._isNPOT())switch(t){case 10241:-1===vo.indexOf(e)&&(e=9729);break;case 10242:case 10243:33071!==e&&(e=33071)}return e}};class wo extends bo{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(t,e){return bo.isSupported(t,e)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var i,n;$r(t),(e instanceof Promise||"string"==typeof e)&&(e={data:e}),"string"==typeof e.data&&(e=Object.assign({},e,{data:(i=e.data,Xs("string"==typeof i),i=""+i,new Promise(((t,e)=>{try{const r=new Image;r.onload=()=>t(r),r.onerror=()=>e(new Error("Could not load image ".concat(i,"."))),r.crossOrigin=n&&n.crossOrigin||"anonymous",r.src=i}catch(t){e(t)}})))})),super(t,Object.assign({},e,{target:3553})),this.initialize(e),Object.seal(this)}}const Ao=[34069,34070,34071,34072,34073,34074];class To extends bo{get[Symbol.toStringTag](){return"TextureCube"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};$r(t),super(t,Object.assign({},e,{target:34067})),this.initialize(e),Object.seal(this)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{mipmaps:e=!0,parameters:i={}}=t;return this.opts=t,this.setCubeMapImageData(t).then((()=>{this.loaded=!0,e&&this.generateMipmap(t),this.setParameters(i)})),this}subImage(t){let{face:e,data:i,x:n=0,y:r=0,mipmapLevel:s=0}=t;return this._subImage({target:e,data:i,x:n,y:r,mipmapLevel:s})}async setCubeMapImageData(t){let{width:e,height:i,pixels:n,data:r,border:s=0,format:o=6408,type:a=5121}=t;const{gl:l}=this,c=n||r,h=await Promise.all(Ao.map((t=>{const e=c[t];return Promise.all(Array.isArray(e)?e:[e])})));this.bind(),Ao.forEach(((t,n)=>{h[n].length>1&&!1!==this.opts.mipmaps&&qr.warn("".concat(this.id," has mipmap and multiple LODs."))(),h[n].forEach(((n,r)=>{e&&i?l.texImage2D(t,r,o,e,i,s,o,a,n):l.texImage2D(t,r,o,o,a,n)}))})),this.unbind()}setImageDataForFace(t){const{face:e,width:i,height:n,pixels:r,data:s,border:o=0,format:a=6408,type:l=5121}=t,{gl:c}=this,h=r||s;return this.bind(),h instanceof Promise?h.then((i=>this.setImageDataForFace(Object.assign({},t,{face:e,data:i,pixels:i})))):this.width||this.height?c.texImage2D(e,0,a,i,n,o,a,l,h):c.texImage2D(e,0,a,a,l,h),this}}To.FACES=Ao;class Mo extends bo{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(t){return Yr(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Kr(t),e=Object.assign({depth:1},e,{target:32879,unpackFlipY:!1}),super(t,e),this.initialize(e),Object.seal(this)}setImageData(t){let{level:e=0,dataFormat:i=6408,width:n,height:r,depth:s=1,border:o=0,format:a,type:l=5121,offset:c=0,data:h,parameters:u={}}=t;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),Ls(this.gl,u,(()=>{ArrayBuffer.isView(h)&&this.gl.texImage3D(this.target,e,i,n,r,s,o,a,l,h),h instanceof mo&&(this.gl.bindBuffer(35052,h.handle),this.gl.texImage3D(this.target,e,i,n,r,s,o,a,l,c))})),h&&h.byteLength)this._trackAllocatedMemory(h.byteLength,"Texture");else{this._trackAllocatedMemory(this.width*this.height*this.depth*(_o[this.dataFormat]||4)*(yo[this.type]||1),"Texture")}return this.loaded=!0,this}}const So="EXT_color_buffer_float";var Eo={33189:{bpp:2},33190:{gl2:!0,bpp:3},36012:{gl2:!0,bpp:4},36168:{bpp:1},34041:{bpp:4},35056:{gl2:!0,bpp:4},36013:{gl2:!0,bpp:5},32854:{bpp:2},36194:{bpp:2},32855:{bpp:2},33321:{gl2:!0,bpp:1},33330:{gl2:!0,bpp:1},33329:{gl2:!0,bpp:1},33332:{gl2:!0,bpp:2},33331:{gl2:!0,bpp:2},33334:{gl2:!0,bpp:4},33333:{gl2:!0,bpp:4},33323:{gl2:!0,bpp:2},33336:{gl2:!0,bpp:2},33335:{gl2:!0,bpp:2},33338:{gl2:!0,bpp:4},33337:{gl2:!0,bpp:4},33340:{gl2:!0,bpp:8},33339:{gl2:!0,bpp:8},32849:{gl2:!0,bpp:3},32856:{gl2:!0,bpp:4},32857:{gl2:!0,bpp:4},36220:{gl2:!0,bpp:4},36238:{gl2:!0,bpp:4},36975:{gl2:!0,bpp:4},36214:{gl2:!0,bpp:8},36232:{gl2:!0,bpp:8},36226:{gl2:!0,bpp:16},36208:{gl2:!0,bpp:16},33325:{gl2:So,bpp:2},33327:{gl2:So,bpp:4},34842:{gl2:So,bpp:8},33326:{gl2:So,bpp:4},33328:{gl2:So,bpp:8},34836:{gl2:So,bpp:16},35898:{gl2:So,bpp:4}};class Co extends io{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(t){let{format:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{format:null};return!e||function(t,e,i){const n=i[e];if(!n)return!1;const r=Yr(t)&&n.gl2||n.gl1;return"string"==typeof r?t.getExtension(r):r}(t,e,Eo)}static getSamplesForFormat(t,e){let{format:i}=e;return t.getInternalformatParameter(36161,i,32937)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.initialize(e),Object.seal(this)}initialize(t){let{format:e,width:i=1,height:n=1,samples:r=0}=t;return Xs(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),0!==r&&Yr(this.gl)?this.gl.renderbufferStorageMultisample(36161,r,e,i,n):this.gl.renderbufferStorage(36161,e,i,n),this.format=e,this.width=i,this.height=n,this.samples=r,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*Eo[this.format].bpp),this}resize(t){let{width:e,height:i}=t;return e!==this.width||i!==this.height?this.initialize({width:e,height:i,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(t){this.gl.bindRenderbuffer(36161,t)}_syncHandle(t){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(t){this.gl.bindRenderbuffer(36161,this.handle);return this.gl.getRenderbufferParameter(36161,t)}}const Io=6144,Po="clear: bad arguments";function Lo(t){let{framebuffer:e=null,color:i=null,depth:n=null,stencil:r=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s={};e&&(s.framebuffer=e);let o=0;i&&(o|=16384,!0!==i&&(s.clearColor=i)),n&&(o|=256,!0!==n&&(s.clearDepth=n)),r&&(o|=1024,!0!==n&&(s.clearStencil=n)),Xs(0!==o,Po),Ls(t,s,(()=>{t.clear(o)}))}function Ro(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{sourceX:i=0,sourceY:n=0,sourceFormat:r=6408}=e;let{sourceAttachment:s=36064,target:o=null,sourceWidth:a,sourceHeight:l,sourceType:c}=e;const{framebuffer:h,deleteFramebuffer:u}=Do(t);Xs(h);const{gl:d,handle:p,attachments:f}=h;a=a||h.width,l=l||h.height,36064===s&&null===p&&(s=1028),Xs(f[s]),c=c||f[s].type,o=function(t,e,i,n,r){if(t)return t;const s=so(e=e||5121,{clamped:!1}),o=function(t){switch(t){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return Xs(!1),0}}(i);return new s(n*r*o)}(o,c,r,a,l),c=c||ro(o);const m=d.bindFramebuffer(36160,p);return d.readPixels(i,n,a,l,r,c,o),d.bindFramebuffer(36160,m||null),u&&h.delete(),o}function Bo(t){let{sourceAttachment:e=36064,targetMaxHeight:i=Number.MAX_SAFE_INTEGER}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Ro(t,{sourceAttachment:e}),{width:r,height:s}=t;for(;s>i;)({data:n,width:r,height:s}=oo({data:n,width:r,height:s}));!function(t){let{data:e,width:i,height:n,bytesPerPixel:r=4,temp:s}=t;const o=i*r;s=s||new Uint8Array(o);for(let t=0;t<n/2;++t){const i=t*o,r=(n-t-1)*o;s.set(e.subarray(i,i+o)),e.copyWithin(i,r,r+o),e.set(s,r)}}({data:n,width:r,height:s});const o=document.createElement("canvas");o.width=r,o.height=s;const a=o.getContext("2d"),l=a.createImageData(r,s);return l.data.set(n),a.putImageData(l,0,0),o.toDataURL()}function Do(t){return t instanceof Wo?{framebuffer:t,deleteFramebuffer:!1}:{framebuffer:qo(t),deleteFramebuffer:!0}}const Oo="TIMER_QUERY",ko="ELEMENT_INDEX_UINT32",Fo="GLSL_DERIVATIVES",zo="GLSL_TEXTURE_LOD";var No={["WEBGL2"]:[!1,!0],["VERTEX_ARRAY_OBJECT"]:["OES_vertex_array_object",!0],[Oo]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],["INSTANCED_RENDERING"]:["ANGLE_instanced_arrays",!0],["MULTIPLE_RENDER_TARGETS"]:["WEBGL_draw_buffers",!0],[ko]:["OES_element_index_uint",!0],["BLEND_EQUATION_MINMAX"]:["EXT_blend_minmax",!0],["FLOAT_BLEND"]:["EXT_float_blend"],["COLOR_ENCODING_SRGB"]:["EXT_sRGB",!0],["TEXTURE_DEPTH"]:["WEBGL_depth_texture",!0],["TEXTURE_FLOAT"]:["OES_texture_float",!0],["TEXTURE_HALF_FLOAT"]:["OES_texture_half_float",!0],["TEXTURE_FILTER_LINEAR_FLOAT"]:["OES_texture_float_linear"],["TEXTURE_FILTER_LINEAR_HALF_FLOAT"]:["OES_texture_half_float_linear"],["TEXTURE_FILTER_ANISOTROPIC"]:["EXT_texture_filter_anisotropic"],["COLOR_ATTACHMENT_RGBA32F"]:[function(t){const e=new wo(t,{format:6408,type:5126,dataFormat:6408}),i=new Wo(t,{id:"test-framebuffer",check:!1,attachments:{36064:e}}),n=i.getStatus();return e.delete(),i.delete(),36053===n},"EXT_color_buffer_float"],["COLOR_ATTACHMENT_FLOAT"]:[!1,"EXT_color_buffer_float"],["COLOR_ATTACHMENT_HALF_FLOAT"]:["EXT_color_buffer_half_float"],["GLSL_FRAG_DATA"]:["WEBGL_draw_buffers",!0],["GLSL_FRAG_DEPTH"]:["EXT_frag_depth",!0],[Fo]:["OES_standard_derivatives",!0],[zo]:["EXT_shader_texture_lod",!0]};const Uo=2;function Go(t,e){return Vo(t,e)}function Vo(t,e){return(e=Array.isArray(e)?e:[e]).every((e=>jo(t,e)))}function jo(t,e){return t.luma=t.luma||{},t.luma.caps=t.luma.caps||{},void 0===t.luma.caps[e]&&(t.luma.caps[e]=function(t,e){const i=No[e];let n;Xs(i,e);const r=Yr(t)&&i[1]||i[0];if("function"==typeof r)n=r(t);else if(Array.isArray(r)){n=!0;for(const e of r)n=n&&Boolean(t.getExtension(e))}else"string"==typeof r?n=Boolean(t.getExtension(r)):"boolean"==typeof r?n=r:Xs(!1);return n}(t,e)),t.luma.caps[e]||qr.log(Uo,"Feature: ".concat(e," not supported"))(),t.luma.caps[e]}const Ho="Multiple render targets not supported";class Wo extends io{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{colorBufferFloat:i,colorBufferHalfFloat:n}=e;let r=!0;return i&&(r=Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("WEBGL_color_buffer_float")||t.getExtension("OES_texture_float"))),n&&(r=r&&Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("EXT_color_buffer_half_float"))),r}static getDefaultFramebuffer(t){return t.luma=t.luma||{},t.luma.defaultFramebuffer=t.luma.defaultFramebuffer||new Wo(t,{id:"default-framebuffer",handle:null,attachments:{}}),t.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const t=Kr(this.gl);return t.getParameter(t.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const t=Kr(this.gl);return t.getParameter(t.MAX_DRAW_BUFFERS)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(e),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(t){let{width:e=1,height:i=1,attachments:n=null,color:r=!0,depth:s=!0,stencil:o=!1,check:a=!0,readBuffer:l,drawBuffers:c}=t;if(Xs(e>=0&&i>=0,"Width and height need to be integers"),this.width=e,this.height=i,n)for(const t in n){const r=n[t];(Array.isArray(r)?r[0]:r).resize({width:e,height:i})}else n=this._createDefaultAttachments(r,s,o,e,i);this.update({clearAttachments:!0,attachments:n,readBuffer:l,drawBuffers:c}),n&&a&&this.checkStatus()}delete(){for(const t of this.ownResources)t.delete();return super.delete(),this}update(t){let{attachments:e={},readBuffer:i,drawBuffers:n,clearAttachments:r=!1,resizeAttachments:s=!0}=t;this.attach(e,{clearAttachments:r,resizeAttachments:s});const{gl:o}=this,a=o.bindFramebuffer(36160,this.handle);return i&&this._setReadBuffer(i),n&&this._setDrawBuffers(n),o.bindFramebuffer(36160,a||null),this}resize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{width:e,height:i}=t;if(null===this.handle)return Xs(void 0===e&&void 0===i),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;void 0===e&&(e=this.gl.drawingBufferWidth),void 0===i&&(i=this.gl.drawingBufferHeight),e!==this.width&&i!==this.height&&qr.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(e,"x").concat(i))();for(const t in this.attachments)this.attachments[t].resize({width:e,height:i});return this.width=e,this.height=i,this}attach(t){let{clearAttachments:e=!1,resizeAttachments:i=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n={};e&&Object.keys(this.attachments).forEach((t=>{n[t]=null})),Object.assign(n,t);const r=this.gl.bindFramebuffer(36160,this.handle);for(const t in n){Xs(void 0!==t,"Misspelled framebuffer binding point?");const e=Number(t),r=n[e];let s=r;if(s)if(s instanceof Co)this._attachRenderbuffer({attachment:e,renderbuffer:s});else if(Array.isArray(r)){const[t,i=0,n=0]=r;s=t,this._attachTexture({attachment:e,texture:t,layer:i,level:n})}else this._attachTexture({attachment:e,texture:s,layer:0,level:0});else this._unattach(e);i&&s&&s.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,r||null),Object.assign(this.attachments,t),Object.keys(this.attachments).filter((t=>!this.attachments[t])).forEach((t=>{delete this.attachments[t]}))}checkStatus(){const t=this.getStatus();if(36053!==t)throw new Error(function(t){const e=Wo.STATUS||{};return e[t]||"Framebuffer error ".concat(t)}(t));return this}getStatus(){const{gl:t}=this,e=t.bindFramebuffer(36160,this.handle),i=t.checkFramebufferStatus(36160);return t.bindFramebuffer(36160,e||null),i}clear(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{color:e,depth:i,stencil:n,drawBuffers:r=[]}=t,s=this.gl.bindFramebuffer(36160,this.handle);return(e||i||n)&&Lo(this.gl,{color:e,depth:i,stencil:n}),r.forEach(((t,e)=>{!function(t){let{framebuffer:e=null,buffer:i=Io,drawBuffer:n=0,value:r=[0,0,0,0]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Kr(t),Ls(t,{framebuffer:e},(()=>{switch(i){case Io:switch(r.constructor){case Int32Array:t.clearBufferiv(i,n,r);break;case Uint32Array:t.clearBufferuiv(i,n,r);break;case Float32Array:default:t.clearBufferfv(i,n,r)}break;case 6145:t.clearBufferfv(6145,0,[r]);break;case 6146:t.clearBufferiv(6146,0,[r]);break;case 34041:const[e,s]=r;t.clearBufferfi(34041,0,e,s);break;default:Xs(!1,Po)}}))}(this.gl,{drawBuffer:e,value:t})})),this.gl.bindFramebuffer(36160,s||null),this}readPixels(){return null}readPixelsToBuffer(){return null}copyToDataUrl(){return null}copyToImage(){return null}copyToTexture(){return null}blit(){return null}invalidate(t){let{attachments:e=[],x:i=0,y:n=0,width:r,height:s}=t;const o=Kr(this.gl),a=o.bindFramebuffer(36008,this.handle);return 0===i&&0===n&&void 0===r&&void 0===s?o.invalidateFramebuffer(36008,e):o.invalidateFramebuffer(36008,e,i,n,r,s),o.bindFramebuffer(36008,a),this}getAttachmentParameter(t,e,i){let n=this._getAttachmentParameterFallback(e);return null===n&&(this.gl.bindFramebuffer(36160,this.handle),n=this.gl.getFramebufferAttachmentParameter(36160,t,e),this.gl.bindFramebuffer(36160,null)),i&&n>1e3&&(n=Js(this.gl,n)),n}getAttachmentParameters(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36064,e=arguments.length>1?arguments[1]:void 0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[];const n={};for(const r of i){n[e?Js(this.gl,r):r]=this.getAttachmentParameter(t,r,e)}return n}getParameters(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const e=Object.keys(this.attachments),i={};for(const n of e){const e=Number(n);i[t?Js(this.gl,e):e]=this.getAttachmentParameters(e,t)}return i}show(){return"undefined"!=typeof window&&window.open(Bo(this),"luma-debug-texture"),this}log(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t>qr.level||"undefined"==typeof window)return this;e=e||"Framebuffer ".concat(this.id);const i=Bo(this,{targetMaxHeight:100});return qr.image({logLevel:t,message:e,image:i},e)(),this}bind(){let{target:t=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(t,this.handle),this}unbind(){let{target:t=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(t,null),this}_createDefaultAttachments(t,e,i,n,r){let s=null;return t&&(s=s||{},s[36064]=new wo(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:n,height:r,mipmaps:!1,parameters:{10241:9729,10240:9729,10242:33071,10243:33071}}),this.ownResources.push(s[36064])),e&&i?(s=s||{},s[33306]=new Co(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:n,height:111}),this.ownResources.push(s[33306])):e?(s=s||{},s[36096]=new Co(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:n,height:r}),this.ownResources.push(s[36096])):i&&Xs(!1),s}_unattach(t){const e=this.attachments[t];e&&(e instanceof Co?this.gl.framebufferRenderbuffer(36160,t,36161,null):this.gl.framebufferTexture2D(36160,t,3553,null,0),delete this.attachments[t])}_attachRenderbuffer(t){let{attachment:e=36064,renderbuffer:i}=t;const{gl:n}=this;n.framebufferRenderbuffer(36160,e,36161,i.handle),this.attachments[e]=i}_attachTexture(t){let{attachment:e=36064,texture:i,layer:n,level:r}=t;const{gl:s}=this;switch(s.bindTexture(i.target,i.handle),i.target){case 35866:case 32879:Kr(s).framebufferTextureLayer(36160,e,i.target,r,n);break;case 34067:const t=function(t){return t<34069?t+34069:t}(n);s.framebufferTexture2D(36160,e,t,i.handle,r);break;case 3553:s.framebufferTexture2D(36160,e,3553,i.handle,r);break;default:Xs(!1,"Illegal texture type")}s.bindTexture(i.target,null),this.attachments[e]=i}_setReadBuffer(t){const e=Yr(i=this.gl)?i:null;var i;e?e.readBuffer(t):Xs(36064===t||1029===t,Ho),this.readBuffer=t}_setDrawBuffers(t){const{gl:e}=this,i=Kr(e);if(i)i.drawBuffers(t);else{const i=e.getExtension("WEBGL_draw_buffers");i?i.drawBuffersWEBGL(t):Xs(1===t.length&&(36064===t[0]||1029===t[0]),Ho)}this.drawBuffers=t}_getAttachmentParameterFallback(t){const e=function(t){t.luma=t.luma||{},t.luma.caps=t.luma.caps||{};for(const e in No)void 0===t.luma.caps[e]&&(t.luma.caps[e]=jo(t,e));return t.luma.caps}(this.gl);switch(t){case 36052:return e.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return e.WEBGL2?null:8;case 33297:return e.WEBGL2?null:5125;case 33296:return e.WEBGL2||e.EXT_sRGB?null:9729;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(t){return this.gl.bindFramebuffer(36160,t)}}function qo(t,e){const{gl:i,width:n,height:r,id:s}=t;return new Wo(i,Object.assign({},e,{id:"framebuffer-for-".concat(s),width:n,height:r,attachments:{36064:t}}))}function Xo(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"unnamed";const i=t.match(/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/);return i?i[1]:e}Wo.ATTACHMENT_PARAMETERS=[36049,36048,33296,33298,33299,33300,33301,33302,33303];const Zo=35632,Jo=35633;function Yo(t,e,i,n){const r=t.split(/\r?\n/),s={},o={},a=n||Xo(e)||"(unnamed)",l="".concat(function(t){switch(t){case Zo:return"fragment";case Jo:return"vertex";default:return"unknown type"}}(i)," shader ").concat(a);for(let e=0;e<r.length;e++){const i=r[e];if(i.length<=1)continue;const n=i.split(":"),a=n[0],c=parseInt(n[2],10);if(isNaN(c))throw new Error("GLSL compilation error in ".concat(l,": ").concat(t));"WARNING"!==a?s[c]=i:o[c]=i}const c=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:": ";const n=t.split(/\r?\n/),r=String(n.length+e-1).length;return n.map(((t,n)=>{const s=String(n+e);return Ko(s,r-s.length)+i+t}))}(e);return{shaderName:l,errors:$o(s,c),warnings:$o(o,c)}}function $o(t,e){let i="";for(let n=0;n<e.length;n++){if((t[n+3]||t[n+2]||t[n+1])&&(i+="".concat(e[n],"\n"),t[n+1])){const e=t[n+1],r=e.split(":",3),s=r[0],o=parseInt(r[1],10)||0,a=e.substring(r.join(":").length+1).trim();i+=Ko("^^^ ".concat(s,": ").concat(a,"\n\n"),o)}}return i}function Ko(t,e){let i="";for(let t=0;t<e;++t)i+=" ";return"".concat(i).concat(t)}function Qo(t){let e=100;const i=t.match(/[^\s]+/g);if(i.length>=2&&"#version"===i[0]){const t=parseInt(i[1],10);Number.isFinite(t)&&(e=t)}return e}class ta extends io{get[Symbol.toStringTag](){return"Shader"}static getTypeName(t){switch(t){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return Xs(!1),"unknown"}}constructor(t,e){$r(t),Xs("string"==typeof e.source,"Shader: GLSL source code must be a JavaScript string");super(t,{id:Xo(e.source,null)||e.id||$s("unnamed ".concat(ta.getTypeName(e.shaderType)))}),this.shaderType=e.shaderType,this.source=e.source,this.initialize(e)}initialize(t){let{source:e}=t;const i=Xo(e,null);i&&(this.id=$s(i)),this._compile(e)}getParameter(t){return this.gl.getShaderParameter(this.handle,t)}toString(){return"".concat(ta.getTypeName(this.shaderType),":").concat(this.id)}getName(){return Xo(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const t=this.gl.getExtension("WEBGL_debug_shaders");return t?t.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.source;t.startsWith("#version ")||(t="#version 100\n".concat(t)),this.source=t,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle);if(!this.getParameter(35713)){const t=this.gl.getShaderInfoLog(this.handle),{shaderName:e,warnings:i}=Yo(t,this.source,this.shaderType,this.id);throw qr.warn("GLSL compilation warnings in ".concat(e,"\n").concat(i))(),new Error("GLSL compilation errors in ".concat(e))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class ea extends ta{get[Symbol.toStringTag](){return"VertexShader"}constructor(t,e){"string"==typeof e&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class ia extends ta{get[Symbol.toStringTag](){return"FragmentShader"}constructor(t,e){"string"==typeof e&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const na={5126:_a.bind(null,"uniform1fv",ca,1,ya),35664:_a.bind(null,"uniform2fv",ca,2,ya),35665:_a.bind(null,"uniform3fv",ca,3,ya),35666:_a.bind(null,"uniform4fv",ca,4,ya),5124:_a.bind(null,"uniform1iv",ha,1,ya),35667:_a.bind(null,"uniform2iv",ha,2,ya),35668:_a.bind(null,"uniform3iv",ha,3,ya),35669:_a.bind(null,"uniform4iv",ha,4,ya),35670:_a.bind(null,"uniform1iv",ha,1,ya),35671:_a.bind(null,"uniform2iv",ha,2,ya),35672:_a.bind(null,"uniform3iv",ha,3,ya),35673:_a.bind(null,"uniform4iv",ha,4,ya),35674:_a.bind(null,"uniformMatrix2fv",ca,4,va),35675:_a.bind(null,"uniformMatrix3fv",ca,9,va),35676:_a.bind(null,"uniformMatrix4fv",ca,16,va),35678:ga,35680:ga,5125:_a.bind(null,"uniform1uiv",ua,1,ya),36294:_a.bind(null,"uniform2uiv",ua,2,ya),36295:_a.bind(null,"uniform3uiv",ua,3,ya),36296:_a.bind(null,"uniform4uiv",ua,4,ya),35685:_a.bind(null,"uniformMatrix2x3fv",ca,6,va),35686:_a.bind(null,"uniformMatrix2x4fv",ca,8,va),35687:_a.bind(null,"uniformMatrix3x2fv",ca,6,va),35688:_a.bind(null,"uniformMatrix3x4fv",ca,12,va),35689:_a.bind(null,"uniformMatrix4x2fv",ca,8,va),35690:_a.bind(null,"uniformMatrix4x3fv",ca,12,va),35678:ga,35680:ga,35679:ga,35682:ga,36289:ga,36292:ga,36293:ga,36298:ga,36299:ga,36300:ga,36303:ga,36306:ga,36307:ga,36308:ga,36311:ga},ra={},sa={},oa={},aa=[0];function la(t,e,i,n){1===e&&"boolean"==typeof t&&(t=t?1:0),Number.isFinite(t)&&(aa[0]=t,t=aa);const r=t.length;if(r%e&&qr.warn("Uniform size should be multiples of ".concat(e),t)(),t instanceof i)return t;let s=n[r];s||(s=new i(r),n[r]=s);for(let e=0;e<r;e++)s[e]=t[e];return s}function ca(t,e){return la(t,e,Float32Array,ra)}function ha(t,e){return la(t,e,Int32Array,sa)}function ua(t,e){return la(t,e,Uint32Array,oa)}function da(t,e,i){const n=na[i.type];if(!n)throw new Error("Unknown GLSL uniform type ".concat(i.type));return n().bind(null,t,e)}function pa(t){if("]"!==t[t.length-1])return{name:t,length:1,isArray:!1};const e=t.match(/([^[]*)(\[[0-9]+\])?/);if(!e||e.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(t));return{name:e[1],length:e[2]||1,isArray:Boolean(e[2])}}function fa(t){return Array.isArray(t)||ArrayBuffer.isView(t)?function(t){if(0===t.length)return!1;const e=Math.min(t.length,16);for(let i=0;i<e;++i)if(!Number.isFinite(t[i]))return!1;return!0}(t):!!isFinite(t)||(!0===t||!1===t||(t instanceof bo||(t instanceof Co||t instanceof Wo&&Boolean(t.texture))))}function ma(t,e,i){if(Array.isArray(i)||ArrayBuffer.isView(i))if(t[e]){const n=t[e];for(let t=0,e=i.length;t<e;++t)n[t]=i[t]}else t[e]=i.slice();else t[e]=i}function ga(){let t=null;return(e,i,n)=>{const r=t!==n;return r&&(e.uniform1i(i,n),t=n),r}}function _a(t,e,i,n){let r=null,s=null;return(o,a,l)=>{const c=e(l,i),h=c.length;let u=!1;if(null===r)r=new Float32Array(h),s=h,u=!0;else{Xs(s===h,"Uniform length cannot change.");for(let t=0;t<h;++t)if(c[t]!==r[t]){u=!0;break}}return u&&(n(o,t,a,c),r.set(c)),u}}function ya(t,e,i,n){t[e](i,n)}function va(t,e,i,n){t[e](i,!1,n)}const xa=5120,ba=5121,wa=5122,Aa=5123,Ta=5126,Ma=5124,Sa=5125,Ea={[Ta]:[Ta,1,"float"],35664:[Ta,2,"vec2"],35665:[Ta,3,"vec3"],35666:[Ta,4,"vec4"],[Ma]:[Ma,1,"int"],35667:[Ma,2,"ivec2"],35668:[Ma,3,"ivec3"],35669:[Ma,4,"ivec4"],[Sa]:[Sa,1,"uint"],36294:[Sa,2,"uvec2"],36295:[Sa,3,"uvec3"],36296:[Sa,4,"uvec4"],35670:[Ta,1,"bool"],35671:[Ta,2,"bvec2"],35672:[Ta,3,"bvec3"],35673:[Ta,4,"bvec4"],35674:[Ta,8,"mat2"],35685:[Ta,8,"mat2x3"],35686:[Ta,8,"mat2x4"],35675:[Ta,12,"mat3"],35687:[Ta,12,"mat3x2"],35688:[Ta,12,"mat3x4"],35676:[Ta,16,"mat4"],35689:[Ta,16,"mat4x2"],35690:[Ta,16,"mat4x3"]};function Ca(t){const e=Ea[t];if(!e)return null;const[i,n]=e;return{type:i,components:n}}function Ia(t,e){switch(t){case xa:case ba:case wa:case Aa:t=Ta}for(const i in Ea){const[n,r,s]=Ea[i];if(n===t&&r===e)return{glType:i,name:s}}return null}class Pa{constructor(t){this.id=t.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(t),this._readVaryingsFromProgram(t)}getAttributeInfo(t){const e=Number(t);return Number.isFinite(e)?this.attributeInfosByLocation[e]:this.attributeInfosByName[t]||null}getAttributeLocation(t){const e=this.getAttributeInfo(t);return e?e.location:-1}getAttributeAccessor(t){const e=this.getAttributeInfo(t);return e?e.accessor:null}getVaryingInfo(t){const e=Number(t);return Number.isFinite(e)?this.varyingInfos[e]:this.varyingInfosByName[t]||null}getVaryingIndex(t){const e=this.getVaryingInfo();return e?e.location:-1}getVaryingAccessor(t){const e=this.getVaryingInfo();return e?e.accessor:null}_readAttributesFromProgram(t){const{gl:e}=t,i=e.getProgramParameter(t.handle,35721);for(let n=0;n<i;n++){const{name:i,type:r,size:s}=e.getActiveAttrib(t.handle,n),o=e.getAttribLocation(t.handle,i);o>=0&&this._addAttribute(o,i,r,s)}this.attributeInfos.sort(((t,e)=>t.location-e.location))}_readVaryingsFromProgram(t){const{gl:e}=t;if(!Yr(e))return;const i=e.getProgramParameter(t.handle,35971);for(let n=0;n<i;n++){const{name:i,type:r,size:s}=e.getTransformFeedbackVarying(t.handle,n);this._addVarying(n,i,r,s)}this.varyingInfos.sort(((t,e)=>t.location-e.location))}_addAttribute(t,e,i,n){const{type:r,components:s}=Ca(i),o={type:r,size:n*s};this._inferProperties(t,e,o);const a={location:t,name:e,accessor:new ho(o)};this.attributeInfos.push(a),this.attributeInfosByLocation[t]=a,this.attributeInfosByName[a.name]=a}_inferProperties(t,e,i){/instance/i.test(e)&&(i.divisor=1)}_addVarying(t,e,i,n){const{type:r,components:s}=Ca(i),o={location:t,name:e,accessor:new ho({type:r,size:n*s})};this.varyingInfos.push(o),this.varyingInfosByName[o.name]=o}}const La=35981,Ra=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class Ba extends io{get[Symbol.toStringTag](){return"Program"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.stubRemovedMethods("Program","v6.0",Ra),this._isCached=!1,this.initialize(e),Object.seal(this),this._setId(e.id)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{hash:e,vs:i,fs:n,varyings:r,bufferMode:s=La}=t;return this.hash=e||"",this.vs="string"==typeof i?new ea(this.gl,{id:"".concat(t.id,"-vs"),source:i}):i,this.fs="string"==typeof n?new ia(this.gl,{id:"".concat(t.id,"-fs"),source:n}):n,Xs(this.vs instanceof ea),Xs(this.fs instanceof ia),this.uniforms={},this._textureUniforms={},r&&r.length>0&&(Kr(this.gl),this.varyings=r,this.gl2.transformFeedbackVaryings(this.handle,r,s)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new Pa(this),this.setProps(t)}delete(){return this._isCached?this:super.delete(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}setProps(t){return"uniforms"in t&&this.setUniforms(t.uniforms),this}draw(t){let{logPriority:e,drawMode:i=4,vertexCount:n,offset:r=0,start:s,end:o,isIndexed:a=!1,indexType:l=5123,instanceCount:c=0,isInstanced:h=c>0,vertexArray:u=null,transformFeedback:d,framebuffer:p,parameters:f={},uniforms:m,samplers:g}=t;if((m||g)&&(qr.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(m||{})),qr.priority>=e){const t=p?p.id:"default",r="mode=".concat(Js(this.gl,i)," verts=").concat(n," ")+"instances=".concat(c," indexType=").concat(Js(this.gl,l)," ")+"isInstanced=".concat(h," isIndexed=").concat(a," ")+"Framebuffer=".concat(t);qr.log(e,r)()}return Xs(u),this.gl.useProgram(this.handle),!(!this._areTexturesRenderable()||0===n||h&&0===c)&&(u.bindForDraw(n,c,(()=>{if(void 0!==p&&(f=Object.assign({},f,{framebuffer:p})),d){const t=function(t){switch(t){case 0:return 0;case 1:case 3:case 2:return 1;case 4:case 5:case 6:return 4;default:return Xs(!1),0}}(i);d.begin(t)}this._bindTextures(),Ls(this.gl,f,(()=>{a&&h?this.gl2.drawElementsInstanced(i,n,l,r,c):a&&Yr(this.gl)&&!isNaN(s)&&!isNaN(o)?this.gl2.drawRangeElements(i,s,o,n,l,r):a?this.gl.drawElements(i,n,l,r):h?this.gl2.drawArraysInstanced(i,r,n,c):this.gl.drawArrays(i,r,n)})),d&&d.end()})),!0)}setUniforms(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};qr.priority>=2&&function(t,e,i){for(const n in t){const r=t[n];if((!i||Boolean(i[n]))&&!fa(r))throw e=e?"".concat(e," "):"",new Error("".concat(e," Bad uniform ").concat(n))}}(t,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const e in t){const i=t[e],n=this._uniformSetters[e];if(n){let t=i,r=!1;if(t instanceof Wo&&(t=t.texture),t instanceof bo)if(r=this.uniforms[e]!==i,r){void 0===n.textureIndex&&(n.textureIndex=this._textureIndexCounter++);const i=t,{textureIndex:r}=n;i.bind(r),t=r,this._textureUniforms[e]=i}else t=n.textureIndex;else this._textureUniforms[e]&&delete this._textureUniforms[e];(n(t)||r)&&ma(this.uniforms,e,i)}}return this}_areTexturesRenderable(){let t=!0;for(const e in this._textureUniforms){const i=this._textureUniforms[e];i.update(),t=t&&i.loaded}return t}_bindTextures(){for(const t in this._textureUniforms){this._textureUniforms[t].bind(this._uniformSetters[t].textureIndex)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(t){const e=this.gl.getAttachedShaders(t),i={};for(const t of e){switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:i.vs=new ea({handle:t});break;case 35632:i.fs=new ia({handle:t})}}return i}_getParameter(t){return this.gl.getProgramParameter(this.handle,t)}_setId(t){if(!t){const t=this._getName();this.id=$s(t)}}_getName(){let t=this.vs.getName()||this.fs.getName();return t=t.replace(/shader/i,""),t=t?"".concat(t,"-program"):"program",t}_compileAndLink(){const{gl:t}=this;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),qr.time(4,"linkProgram for ".concat(this._getName()))(),t.linkProgram(this.handle),qr.timeEnd(4,"linkProgram for ".concat(this._getName()))(),t.debug||qr.level>0){if(!t.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(t.getProgramInfoLog(this.handle)));t.validateProgram(this.handle);if(!t.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(t.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){const{gl:t}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let e=0;e<this._uniformCount;e++){const i=this.gl.getActiveUniform(this.handle,e),{name:n}=pa(i.name);let r=t.getUniformLocation(this.handle,n);if(this._uniformSetters[n]=da(t,r,i),i.size>1)for(let e=0;e<i.size;e++)r=t.getUniformLocation(this.handle,"".concat(n,"[").concat(e,"]")),this._uniformSetters["".concat(n,"[").concat(e,"]")]=da(t,r,i)}this._textureIndexCounter=0}getActiveUniforms(t,e){return this.gl2.getActiveUniforms(this.handle,t,e)}getUniformBlockIndex(t){return this.gl2.getUniformBlockIndex(this.handle,t)}getActiveUniformBlockParameter(t,e){return this.gl2.getActiveUniformBlockParameter(this.handle,t,e)}uniformBlockBinding(t,e){this.gl2.uniformBlockBinding(this.handle,t,e)}}class Da extends io{get[Symbol.toStringTag](){return"Query"}static isSupported(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const i=Yr(t),n=Vo(t,Oo);let r=i||n;for(const t of e)switch(t){case"queries":r=r&&i;break;case"timers":r=r&&n;break;default:Xs(!1)}return r}constructor(t){super(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),this.target=null,this._queryPending=!1,this._pollingPromise=null,Object.seal(this)}beginTimeElapsedQuery(){return this.begin(35007)}beginOcclusionQuery(){let{conservative:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.begin(t?36202:35887)}beginTransformFeedbackQuery(){return this.begin(35976)}begin(t){return this._queryPending||(this.target=t,this.gl2.beginQuery(this.target,this.handle)),this}end(){return this._queryPending||this.target&&(this.gl2.endQuery(this.target),this.target=null,this._queryPending=!0),this}isResultAvailable(){if(!this._queryPending)return!1;const t=this.gl2.getQueryParameter(this.handle,34919);return t&&(this._queryPending=!1),t}isTimerDisjoint(){return this.gl2.getParameter(36795)}getResult(){return this.gl2.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}createPoll(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Number.POSITIVE_INFINITY;if(this._pollingPromise)return this._pollingPromise;let e=0;return this._pollingPromise=new Promise(((i,n)=>{const r=()=>{this.isResultAvailable()?(i(this.getResult()),this._pollingPromise=null):e++>t?(n("Timed out"),this._pollingPromise=null):requestAnimationFrame(r)};requestAnimationFrame(r)})),this._pollingPromise}_createHandle(){return Da.isSupported(this.gl)?this.gl2.createQuery():null}_deleteHandle(){this.gl2.deleteQuery(this.handle)}}class Oa extends io{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(t){return Yr(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Kr(t),super(t,e),this.initialize(e),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,Qs(this.buffers)||this.bind((()=>this._unbindBuffers())),this.setProps(t),this}setProps(t){"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"bindOnUse"in t&&(t=t.bindOnUse),"buffers"in t&&this.setBuffers(t.buffers)}setBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.bind((()=>{for(const e in t)this.setBuffer(e,t[e])})),this}setBuffer(t,e){const i=this._getVaryingIndex(t),{buffer:n,byteSize:r,byteOffset:s}=this._getBufferParams(e);return i<0?(this.unused[t]=n,qr.warn("".concat(this.id," unused varying buffer ").concat(t))(),this):(this.buffers[i]=e,this.bindOnUse||this._bindBuffer(i,n,s,r),this)}begin(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(t),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(t){let e,i,n;return t instanceof mo==!1?(n=t.buffer,i=t.byteSize,e=t.byteOffset):n=t,void 0===e&&void 0===i||(e=e||0,i=i||n.byteLength-e),{buffer:n,byteOffset:e,byteSize:i}}_getVaryingInfo(t){return this.configuration&&this.configuration.getVaryingInfo(t)}_getVaryingIndex(t){if(this.configuration)return this.configuration.getVaryingInfo(t).location;const e=Number(t);return Number.isFinite(e)?e:-1}_bindBuffers(){if(this.bindOnUse)for(const t in this.buffers){const{buffer:e,byteSize:i,byteOffset:n}=this._getBufferParams(this.buffers[t]);this._bindBuffer(t,e,n,i)}}_unbindBuffers(){if(this.bindOnUse)for(const t in this.buffers)this._bindBuffer(t,null)}_bindBuffer(t,e){let i=arguments.length>3?arguments[3]:void 0;const n=e&&e.handle;return n&&void 0!==i?this.gl.bindBufferRange(35982,t,n,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i):this.gl.bindBufferBase(35982,t,n),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(t){this.gl.bindTransformFeedback(36386,this.handle)}}let ka=null;function Fa(t,e){var i;return new t((i=t.BYTES_PER_ELEMENT*e,(!ka||ka.byteLength<i)&&(ka=new ArrayBuffer(i)),ka),0,e)}class za extends io{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(t){return!(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).constantAttributeZero||(Yr(t)||"Chrome"===br())}static getDefaultArray(t){return t.luma=t.luma||{},t.luma.defaultVertexArray||(t.luma.defaultVertexArray=new za(t,{handle:null,isDefaultArray:!0})),t.luma.defaultVertexArray}static getMaxAttributes(t){return za.MAX_ATTRIBUTES=za.MAX_ATTRIBUTES||t.getParameter(34921),za.MAX_ATTRIBUTES}static setConstant(t,e,i){switch(i.constructor){case Float32Array:za._setConstantFloatArray(t,e,i);break;case Int32Array:za._setConstantIntArray(t,e,i);break;case Uint32Array:za._setConstantUintArray(t,e,i);break;default:Xs(!1)}}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,Object.assign({},e,{id:e.id||e.program&&e.program.id})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=e.isDefaultArray||!1,this.gl2=t,this.initialize(e),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return za.getMaxAttributes(this.gl)}initialize(){return this.setProps(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}setProps(t){return this}setElementBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return Xs(!t||34963===t.target,"elements must be GL.ELEMENT_ARRAY_BUFFER"),this.bind((()=>{this.gl.bindBuffer(34963,t?t.handle:null)})),this}setBuffer(t,e,i){if(34963===e.target)return this.setElementBuffer(e,i);const{size:n,type:r,stride:s,offset:o,normalized:a,integer:l,divisor:c}=i,{gl:h,gl2:u}=this;return t=Number(t),this.bind((()=>{h.bindBuffer(34962,e.handle),l?(Xs(Yr(h)),u.vertexAttribIPointer(t,n,r,s,o)):h.vertexAttribPointer(t,n,r,a,s,o),h.enableVertexAttribArray(t),u.vertexAttribDivisor(t,c||0)})),this}enable(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!e&&0===t&&!za.isSupported(this.gl,{constantAttributeZero:!0})||(t=Number(t),this.bind((()=>e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t)))),this}getConstantBuffer(t,e){const i=this._normalizeConstantArrayValue(e),n=i.byteLength*t,r=i.length*t;let s=!this.buffer;if(this.buffer=this.buffer||new mo(this.gl,n),s=s||this.buffer.reallocate(n),s=s||!this._compareConstantArrayValues(i,this.bufferValue),s){const t=Fa(e.constructor,r);!function(t){let{target:e,source:i,start:n=0,count:r=1}=t;const s=i.length,o=r*s;let a=0;for(let t=n;a<s;a++)e[t++]=i[a];for(;a<o;)a<o-a?(e.copyWithin(n+a,n,n+a),a*=2):(e.copyWithin(n+a,n,n+o-a),a=o)}({target:t,source:i,start:0,count:r}),this.buffer.subData(t),this.bufferValue=e}return this.buffer}_normalizeConstantArrayValue(t){return Array.isArray(t)?new Float32Array(t):t}_compareConstantArrayValues(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}static _setConstantFloatArray(t,e,i){switch(i.length){case 1:t.vertexAttrib1fv(e,i);break;case 2:t.vertexAttrib2fv(e,i);break;case 3:t.vertexAttrib3fv(e,i);break;case 4:t.vertexAttrib4fv(e,i);break;default:Xs(!1)}}static _setConstantIntArray(t,e,i){switch(Xs(Yr(t)),i.length){case 1:t.vertexAttribI1iv(e,i);break;case 2:t.vertexAttribI2iv(e,i);break;case 3:t.vertexAttribI3iv(e,i);break;case 4:t.vertexAttribI4iv(e,i);break;default:Xs(!1)}}static _setConstantUintArray(t,e,i){switch(Xs(Yr(t)),i.length){case 1:t.vertexAttribI1uiv(e,i);break;case 2:t.vertexAttribI2uiv(e,i);break;case 3:t.vertexAttribI3uiv(e,i);break;case 4:t.vertexAttribI4uiv(e,i);break;default:Xs(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(t){return this.gl2.deleteVertexArray(t),[this.elements]}_bindHandle(t){this.gl2.bindVertexArray(t)}_getParameter(t,e){let{location:i}=e;return Xs(Number.isFinite(i)),this.bind((()=>34373===t?this.gl.getVertexAttribOffset(i,t):this.gl.getVertexAttrib(i,t)))}}const Na=/^(.+)__LOCATION_([0-9]+)$/,Ua=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class Ga{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.id=e.id||e.program&&e.program.id,this.gl=t,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new za(t),to(this,"VertexArray","v6.0",Ua),this.initialize(e),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(t)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:t}=this.vertexArrayObject;return this.values=new Array(t).fill(null),this.accessors=new Array(t).fill(null),this.unused={},this.drawParams=null,this}setProps(t){return"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"attributes"in t&&this.setAttributes(t.attributes),"elements"in t&&this.setElementBuffer(t.elements),"bindOnUse"in t&&(t=t.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(t){return Object.assign(this.attributes,t),this.vertexArrayObject.bind((()=>{for(const e in t){this._setAttribute(e,t[e])}this.gl.bindBuffer(34962,null)})),this}setElementBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.elements=t,this.elementsAccessor=e,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(t,e),this}setBuffer(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(34963===e.target)return this.setElementBuffer(e,i);const{location:n,accessor:r}=this._resolveLocationAndAccessor(t,e,e.accessor,i);return n>=0&&(this.values[n]=e,this.accessors[n]=r,this.clearDrawParams(),this.vertexArrayObject.setBuffer(n,e,r)),this}setConstant(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{location:n,accessor:r}=this._resolveLocationAndAccessor(t,e,Object.assign({size:e.length},i));return n>=0&&(e=this.vertexArrayObject._normalizeConstantArrayValue(e),this.values[n]=e,this.accessors[n]=r,this.clearDrawParams(),this.vertexArrayObject.enable(n,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind((()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new mo(this.gl,{accessor:{size:4}});for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this.values[t]instanceof mo&&(this.gl.disableVertexAttribArray(t),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(t,1,5126,!1,0,0))})),this}bindBuffers(){return this.vertexArrayObject.bind((()=>{this.elements&&this.setElementBuffer(this.elements);for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++){const e=this.values[t];e instanceof mo&&this.setBuffer(t,e)}})),this}bindForDraw(t,e,i){let n;return this.vertexArrayObject.bind((()=>{this._setConstantAttributes(t,e),n=i()})),n}_resolveLocationAndAccessor(t,e,i,n){const r={location:-1,accessor:null},{location:s,name:o}=this._getAttributeIndex(t);if(!Number.isFinite(s)||s<0)return this.unused[t]=e,qr.once(3,(()=>"unused value ".concat(t," in ").concat(this.id)))(),r;const a=this._getAttributeInfo(o||s);if(!a)return r;const l=ho.resolve(a.accessor,this.accessors[s]||{},i,n),{size:c,type:h}=l;return Xs(Number.isFinite(c)&&Number.isFinite(h)),{location:s,accessor:l}}_getAttributeInfo(t){return this.configuration&&this.configuration.getAttributeInfo(t)}_getAttributeIndex(t){const e=Number(t);if(Number.isFinite(e))return{location:e};const i=Na.exec(t),n=i?i[1]:t,r=i?Number(i[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(n)+r,name:n}:{location:-1}}_setAttribute(t,e){if(e instanceof mo)this.setBuffer(t,e);else if(Array.isArray(e)&&e.length&&e[0]instanceof mo){this.setBuffer(t,e[0],e[1])}else if(ArrayBuffer.isView(e)||Array.isArray(e)){this.setConstant(t,e)}else{if(!(e.buffer instanceof mo))throw new Error("VertexArray: attributes must be Buffers or constants (i.e. typed array)");this.setBuffer(t,e.buffer,e)}}_setConstantAttributes(t,e){const i=Math.max(0|t,0|e);let n=this.values[0];ArrayBuffer.isView(n)&&this._setConstantAttributeZero(n,i);for(let t=1;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)n=this.values[t],ArrayBuffer.isView(n)&&this._setConstantAttribute(t,n)}_setConstantAttributeZero(t,e){if(za.isSupported(this.gl,{constantAttributeZero:!0}))return void this._setConstantAttribute(0,t);const i=this.vertexArrayObject.getConstantBuffer(e,t);this.vertexArrayObject.setBuffer(0,i,this.accessors[0])}_setConstantAttribute(t,e){za.setConstant(this.gl,t,e)}_updateDrawParams(){const t={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this._updateDrawParamsForLocation(t,e);return this.elements&&(t.elementCount=this.elements.getElementCount(this.elements.accessor),t.isIndexed=!0,t.indexType=this.elementsAccessor.type||this.elements.accessor.type,t.indexOffset=this.elementsAccessor.offset||0),t.indexCount===1/0&&(t.indexCount=0),t.vertexCount===1/0&&(t.vertexCount=0),t.instanceCount===1/0&&(t.instanceCount=0),t}_updateDrawParamsForLocation(t,e){const i=this.values[e],n=this.accessors[e];if(!i)return;const{divisor:r}=n,s=r>0;if(t.isInstanced=t.isInstanced||s,i instanceof mo){const e=i;if(s){const i=e.getVertexCount(n);t.instanceCount=Math.min(t.instanceCount,i)}else{const i=e.getVertexCount(n);t.vertexCount=Math.min(t.vertexCount,i)}}}setElements(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return qr.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(t,e)}}function Va(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{isInteger:i=!1}=e;if(Array.isArray(t)||ArrayBuffer.isView(t))return function(t,e){const{maxElts:i=16,size:n=1}=e;let r="[";for(let s=0;s<t.length&&s<i;++s)s>0&&(r+=",".concat(s%n==0?" ":"")),r+=Va(t[s],e);const s=t.length>i?"...":"]";return"".concat(r).concat(s)}(t,e);if(!Number.isFinite(t))return String(t);if(Math.abs(t)<1e-16)return i?"0":"0.";if(i)return t.toFixed(0);if(Math.abs(t)>100&&Math.abs(t)<1e4)return t.toFixed(0);const n=t.toPrecision(2);return n.indexOf(".0")===n.length-2?n.slice(0,-1):n}function ja(t){let{header:e="Uniforms",program:i,uniforms:n,undefinedOnly:r=!1}=t;Xs(i);const s=".*Matrix",o={},a=Object.keys(i._uniformSetters).sort();let l=0;for(const t of a)t.match(".*_.*")||t.match(s)||Ha({table:o,header:e,uniforms:n,uniformName:t,undefinedOnly:r})&&l++;for(const t of a)t.match(s)&&Ha({table:o,header:e,uniforms:n,uniformName:t,undefinedOnly:r})&&l++;for(const t of a)o[t]||Ha({table:o,header:e,uniforms:n,uniformName:t,undefinedOnly:r})&&l++;let c=0;const h={};if(!r)for(const t in n){const i=n[t];o[t]||(c++,h[t]={Type:"NOT USED: ".concat(i),[e]:Va(i)})}return{table:o,count:l,unusedTable:h,unusedCount:c}}function Ha(t){let{table:e,header:i,uniforms:n,uniformName:r,undefinedOnly:s}=t;const o=n[r],a=function(t){return null!=t}(o);return(!s||!a)&&(e[r]={[i]:a?Va(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0)}function Wa(t,e,i,n){const{gl:r}=t;if(!e)return{[n]:"null","Format ":"N/A"};let s,o,a,l="NOT PROVIDED",c=1,h=0,u=0;if(i&&(l=i.type,c=i.size,l=String(l).replace("Array",""),s=-1!==l.indexOf("nt")),e instanceof mo){const t=e,{data:d,changed:p}=t.getDebugData();let f;if(o=p?"*":"",a=d,u=t.byteLength,h=u/d.BYTES_PER_ELEMENT/c,i){f="".concat(i.divisor>0?"I ":"P "," ").concat(h," (x").concat(c,"=").concat(u," bytes ").concat(Js(r,l),")")}else s=!0,f="".concat(u," bytes");return{[n]:"".concat(o).concat(Va(a,{size:c,isInteger:s})),"Format ":f}}return a=e,c=e.length,l=String(e.constructor.name).replace("Array",""),s=-1!==l.indexOf("nt"),{[n]:"".concat(Va(a,{size:c,isInteger:s})," (constant)"),"Format ":"".concat(c,"x").concat(l," (constant)")}}function qa(t,e){const{type:i,size:n}=e,r=Ia(i,n);return r?"".concat(t," (").concat(r.name,")"):t}function Xa(t){const{type:e,size:i}=t.accessor,n=Ia(e,i);return n?"".concat(n.name," ").concat(t.name):t.name}const Za=mr()&&"undefined"!=typeof document;let Ja=0;class Ya{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{onCreateContext:e=(t=>Ns(t)),onAddHTML:i=null,onInitialize:n=(()=>{}),onRender:r=(()=>{}),onFinalize:s=(()=>{}),onError:o,gl:a=null,glOptions:l={},debug:c=!1,createFramebuffer:h=!1,autoResizeViewport:u=!0,autoResizeDrawingBuffer:d=!0,stats:p=qs.get("animation-loop-".concat(Ja++))}=t;let{useDevicePixels:f=!0}=t;"useDevicePixelRatio"in t&&(qr.deprecated("useDevicePixelRatio","useDevicePixels")(),f=t.useDevicePixelRatio),this.props={onCreateContext:e,onAddHTML:i,onInitialize:n,onRender:r,onFinalize:s,onError:o,gl:a,glOptions:l,debug:c,createFramebuffer:h},this.gl=a,this.needsRedraw=null,this.timeline=null,this.stats=p,this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this._initialized=!1,this._running=!1,this._animationFrameId=null,this._nextFramePromise=null,this._resolveNextFrame=null,this._cpuStartTime=0,this.setProps({autoResizeViewport:u,autoResizeDrawingBuffer:d,useDevicePixels:f}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._pageLoadPromise=null,this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}delete(){this.stop(),this._setDisplay(null)}setNeedsRedraw(t){return Xs("string"==typeof t),this.needsRedraw=this.needsRedraw||t,this}setProps(t){return"autoResizeViewport"in t&&(this.autoResizeViewport=t.autoResizeViewport),"autoResizeDrawingBuffer"in t&&(this.autoResizeDrawingBuffer=t.autoResizeDrawingBuffer),"useDevicePixels"in t&&(this.useDevicePixels=t.useDevicePixels),this}start(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._running)return this;this._running=!0;const e=this._getPageLoadPromise().then((()=>!this._running||this._initialized?null:(this._createWebGLContext(t),this._createFramebuffer(),this._startEventHandling(),this._initializeCallbackData(),this._updateCallbackData(),this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._gpuTimeQuery=Da.isSupported(this.gl,["timers"])?new Da(this.gl):null,this._initialized=!0,this.onInitialize(this.animationProps)))).then((t=>{this._running&&(this._addCallbackData(t||{}),!1!==t&&this._startLoop())}));return this.props.onError&&e.catch(this.props.onError),this}redraw(){return this.isContextLost()||(this._beginTimers(),this._setupFrame(),this._updateCallbackData(),this._renderFrame(this.animationProps),this._clearNeedsRedraw(),this.offScreen&&this.gl.commit&&this.gl.commit(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endTimers()),this}stop(){return this._running&&(this._finalizeCallbackData(),this._cancelAnimationFrame(this._animationFrameId),this._nextFramePromise=null,this._resolveNextFrame=null,this._animationFrameId=null,this._running=!1),this}attachTimeline(t){return this.timeline=t,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise((t=>{this._resolveNextFrame=t}))),this._nextFramePromise}async toDataURL(){return this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.gl.canvas.toDataURL()}isContextLost(){return this.gl.isContextLost()}onCreateContext(){return this.props.onCreateContext(...arguments)}onInitialize(){return this.props.onInitialize(...arguments)}onRender(){return this.props.onRender(...arguments)}onFinalize(){return this.props.onFinalize(...arguments)}getHTMLControlValue(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.getElementById(t);return i?Number(i.value):e}setViewParameters(){return qr.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")(),this}_startLoop(){const t=()=>{this._running&&(this.redraw(),this._animationFrameId=this._requestAnimationFrame(t))};this._cancelAnimationFrame(this._animationFrameId),this._animationFrameId=this._requestAnimationFrame(t)}_getPageLoadPromise(){return this._pageLoadPromise||(this._pageLoadPromise=Za?new Promise(((t,e)=>{Za&&"complete"===document.readyState?t(document):window.addEventListener("load",(()=>{t(document)}))})):Promise.resolve({})),this._pageLoadPromise}_setDisplay(t){this.display&&(this.display.delete(),this.display.animationLoop=null),t&&(t.animationLoop=this),this.display=t}_cancelAnimationFrame(t){return this.display&&this.display.cancelAnimationFrame?this.display.cancelAnimationFrame(t):(e=t,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e));var e}_requestAnimationFrame(t){if(this._running)return this.display&&this.display.requestAnimationFrame?this.display.requestAnimationFrame(t):(e=t,"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,1e3/60));var e}_renderFrame(){this.display?this.display._renderFrame(...arguments):this.onRender(...arguments)}_clearNeedsRedraw(){this.needsRedraw=null}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport(),this._resizeFramebuffer()}_initializeCallbackData(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}_updateCallbackData(){const{width:t,height:e,aspect:i}=this._getSizeAndAspect();t===this.animationProps.width&&e===this.animationProps.height||this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=t,this.animationProps.height=e,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime,this.animationProps._offScreen=this.offScreen}_finalizeCallbackData(){this.onFinalize(this.animationProps)}_addCallbackData(t){"object"==typeof t&&null!==t&&(this.animationProps=Object.assign({},this.animationProps,t))}_createWebGLContext(t){if(this.offScreen=t.canvas&&"undefined"!=typeof OffscreenCanvas&&t.canvas instanceof OffscreenCanvas,t=Object.assign({},t,this.props.glOptions),this.gl=this.props.gl?Us(this.props.gl,t):this.onCreateContext(t),!Jr(this.gl))throw new Error("AnimationLoop.onCreateContext - illegal context returned");Ps(this.gl,ds),this._createInfoDiv()}_createInfoDiv(){if(this.gl.canvas&&this.props.onAddHTML){const t=document.createElement("div");document.body.appendChild(t),t.style.position="relative";const e=document.createElement("div");e.style.position="absolute",e.style.left="10px",e.style.bottom="10px",e.style.width="300px",e.style.background="white",t.appendChild(this.gl.canvas),t.appendChild(e);const i=this.props.onAddHTML(e);i&&(e.innerHTML=i)}}_getSizeAndAspect(){const t=this.gl.drawingBufferWidth,e=this.gl.drawingBufferHeight;let i=1;const{canvas:n}=this.gl;return n&&n.clientHeight?i=n.clientWidth/n.clientHeight:t>0&&e>0&&(i=t/e),{width:t,height:e,aspect:i}}_resizeViewport(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.autoResizeDrawingBuffer&&Gs(this.gl,{useDevicePixels:this.useDevicePixels})}_createFramebuffer(){this.props.createFramebuffer&&(this.framebuffer=new Wo(this.gl))}_resizeFramebuffer(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}_beginTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this._gpuTimeQuery&&this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds()),this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery(),this.cpuTime.timeStart()}_endTimers(){this.cpuTime.timeEnd(),this._gpuTimeQuery&&this._gpuTimeQuery.end()}_startEventHandling(){const{canvas:t}=this.gl;t&&(t.addEventListener("mousemove",this._onMousemove),t.addEventListener("mouseleave",this._onMouseleave))}_onMousemove(t){this.animationProps._mousePosition=[t.offsetX,t.offsetY]}_onMouseleave(t){this.animationProps._mousePosition=null}}const $a="vs",Ka="fs";function Qa(t,e){if(!t)throw new Error(e||"shadertools: assertion failed.")}const tl={number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},array:{validate:(t,e)=>Array.isArray(t)||ArrayBuffer.isView(t)}};function el(t){let e=il(t);return"object"===e?t?"type"in t?Object.assign({},t,tl[t.type]):"value"in t?(e=il(t.value),Object.assign({type:e},t,tl[e])):{type:"object",value:t}:{type:"object",value:null}:Object.assign({type:e,value:t},tl[e])}function il(t){return Array.isArray(t)||ArrayBuffer.isView(t)?"array":typeof t}class nl{constructor(t){let{name:e,vs:i,fs:n,dependencies:r=[],uniforms:s,getUniforms:o,deprecations:a=[],defines:l={},inject:c={},vertexShader:h,fragmentShader:u}=t;Qa("string"==typeof e),this.name=e,this.vs=i||h,this.fs=n||u,this.getModuleUniforms=o,this.dependencies=r,this.deprecations=this._parseDeprecationDefinitions(a),this.defines=l,this.injections=function(t){const e={vs:{},fs:{}};for(const i in t){let n=t[i];"string"==typeof n&&(n={order:0,injection:n}),e[i.slice(0,2)][i]=n}return e}(c),s&&(this.uniforms=function(t){const e={};for(const i in t){const n=el(t[i]);e[i]=n}return e}(s))}getModuleSource(t){let e;switch(t){case"vs":e=this.vs||"";break;case"fs":e=this.fs||"";break;default:Qa(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),"\n").concat(e,"// END MODULE_").concat(this.name,"\n\n")}getUniforms(t,e){return this.getModuleUniforms?this.getModuleUniforms(t,e):this.uniforms?this._defaultGetUniforms(t):{}}getDefines(){return this.defines}checkDeprecations(t,e){this.deprecations.forEach((i=>{i.regex.test(t)&&(i.deprecated?e.deprecated(i.old,i.new)():e.removed(i.old,i.new)())}))}_parseDeprecationDefinitions(t){return t.forEach((t=>{if("function"===t.type)t.regex=new RegExp("\\b".concat(t.old,"\\("));else t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))})),t}_defaultGetUniforms(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e={},i=this.uniforms;for(const n in i){const r=i[n];n in t&&!r.private?(r.validate&&Qa(r.validate(t[n],r),"".concat(this.name,": invalid ").concat(n)),e[n]=t[n]):e[n]=r.value}return e}}function rl(t){return function(t){const e={},i={};return sl({modules:t,level:0,moduleMap:e,moduleDepth:i}),Object.keys(i).sort(((t,e)=>i[e]-i[t])).map((t=>e[t]))}(ol(t))}function sl(t){let{modules:e,level:i,moduleMap:n,moduleDepth:r}=t;if(i>=5)throw new Error("Possible loop in shader dependency graph");for(const t of e)n[t.name]=t,(void 0===r[t.name]||r[t.name]<i)&&(r[t.name]=i);for(const t of e)t.dependencies&&sl({modules:t.dependencies,level:i+1,moduleMap:n,moduleDepth:r})}function ol(t,e){return t.map((t=>(t instanceof nl||(Qa("string"!=typeof t,"Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),Qa(t.name,"shader module has no name"),(t=new nl(t)).dependencies=ol(t.dependencies)),t)))}const al=7936,ll=7937,cl=7938,hl=35724,ul={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},dl={};Object.keys(ul).forEach((t=>{dl[t]=t}));const pl={};function fl(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=ul[e];if(Qa(n,e),!function(){const t="undefined"!=typeof window&&window.navigator||{},e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).userAgent||t.userAgent||"",i=-1!==e.indexOf("MSIE "),n=-1!==e.indexOf("Trident/");return i||n}(i))return!0;if(e in pl)return pl[e];const r=i.behavior||"enable",s="#extension GL_".concat(n[0]," : ").concat(r,"\nvoid main(void) {}"),o=t.createShader(35633);t.shaderSource(o,s),t.compileShader(o);const a=t.getShaderParameter(o,35713);return t.deleteShader(o),pl[e]=a,a}function ml(t,e){const i=ul[e];Qa(i,e);const n=function(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&2===t._version)}(t)&&i[1]||i[0],r="string"==typeof n?Boolean(t.getExtension(n)):n;return Qa(!1===r||!0===r),r}function gl(t,e){return(e=Array.isArray(e)?e:[e]).every((e=>ml(t,e)))}function _l(t){const e=function(t){const e=t.getExtension("WEBGL_debug_renderer_info"),i=t.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||al),n=t.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||ll);return{gpuVendor:function(t,e){return t.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":t.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":t.match(/AMD/i)||e.match(/AMD/i)||t.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}(i,n),vendor:i,renderer:n,version:t.getParameter(cl),shadingLanguageVersion:t.getParameter(hl)}}(t);switch(e.gpuVendor.toLowerCase()){case"nvidia":return"#define NVIDIA_GPU\n// Nvidia optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n";case"intel":return"#define INTEL_GPU\n// Intel optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"amd":return"#define AMD_GPU\n";default:return"#define DEFAULT_GPU\n// Prevent driver from optimizing away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n"}}const yl={[$a]:"#ifdef MODULE_LOGDEPTH\n  logdepth_adjustPosition(gl_Position);\n#endif\n",[Ka]:"#ifdef MODULE_MATERIAL\n  gl_FragColor = material_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LIGHTING\n  gl_FragColor = lighting_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_FOG\n  gl_FragColor = fog_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_PICKING\n  gl_FragColor = picking_filterHighlightColor(gl_FragColor);\n  gl_FragColor = picking_filterPickingColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LOGDEPTH\n  logdepth_setFragDepth();\n#endif\n"},vl="__LUMA_INJECT_DECLARATIONS__",xl=/void\s+main\s*\([^)]*\)\s*\{\n?/,bl=/}\n?[^{}]*$/,wl=[];function Al(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=e===$a;for(const e in i){const n=i[e];n.sort(((t,e)=>t.order-e.order)),wl.length=n.length;for(let t=0,e=n.length;t<e;++t)wl[t]=n[t].injection;const s="".concat(wl.join("\n"),"\n");switch(e){case"vs:#decl":r&&(t=t.replace(vl,s));break;case"vs:#main-start":r&&(t=t.replace(xl,(t=>t+s)));break;case"vs:#main-end":r&&(t=t.replace(bl,(t=>s+t)));break;case"fs:#decl":r||(t=t.replace(vl,s));break;case"fs:#main-start":r||(t=t.replace(xl,(t=>t+s)));break;case"fs:#main-end":r||(t=t.replace(bl,(t=>s+t)));break;default:t=t.replace(e,(t=>t+s))}}return t=t.replace(vl,""),n&&(t=t.replace(/\}\s*$/,(t=>t+yl[e]))),t}function Tl(t){const e={};return Qa(Array.isArray(t)&&t.length>1),t.forEach((t=>{for(const i in t)e[i]=e[i]?"".concat(e[i],"\n").concat(t[i]):t[i]})),e}function Ml(t){return new RegExp("\\b".concat(t,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}const Sl=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],El=[...Sl,[Ml("attribute"),"in $1"],[Ml("varying"),"out $1"]],Cl=[...Sl,[Ml("varying"),"in $1"]],Il=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],Pl=[...Il,[Ml("in"),"attribute $1"],[Ml("out"),"varying $1"]],Ll=[...Il,[Ml("in"),"varying $1"]],Rl="gl_FragColor",Bl=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,Dl=/void\s+main\s*\([^)]*\)\s*\{\n?/;function Ol(t,e,i){switch(e){case 300:return i?kl(t,El):function(t){t=kl(t,Cl);const e=t.match(Bl);if(e){const i=e[1];t=t.replace(new RegExp("\\b".concat(Rl,"\\b"),"g"),i)}else{const e="fragmentColor";t=t.replace(Dl,(t=>"out vec4 ".concat(e,";\n").concat(t))).replace(new RegExp("\\b".concat(Rl,"\\b"),"g"),e)}return t}(t);case 100:return i?kl(t,Pl):function(t){t=kl(t,Ll);const e=t.match(Bl);if(e){const i=e[1];t=t.replace(Bl,"").replace(new RegExp("\\b".concat(i,"\\b"),"g"),Rl)}return t}(t);default:throw new Error("unknown GLSL version ".concat(e))}}function kl(t,e){for(const[i,n]of e)t=t.replace(i,n);return t}const Fl="\n\n".concat(vl,"\n\n"),zl={[$a]:"vertex",[Ka]:"fragment"},Nl="precision highp float;\n\n";function Ul(t,e){let{id:i,source:n,type:r,modules:s,defines:o={},hookFunctions:a=[],inject:l={},transpileToGLSL100:c=!1,prologue:h=!0,log:u}=e;Qa("string"==typeof n,"shader source must be a string");const d=r===$a,p=n.split("\n");let f=100,m="",g=n;0===p[0].indexOf("#version ")?(f=300,m=p[0],g=p.slice(1).join("\n")):m="#version ".concat(f);const _={};s.forEach((t=>{Object.assign(_,t.getDefines())})),Object.assign(_,o);let y=h?"".concat(m,"\n").concat(function(t){let{id:e,source:i,type:n}=t;const r=e&&"string"==typeof e&&-1===i.indexOf("SHADER_NAME");return r?"\n#define SHADER_NAME ".concat(e,"_").concat(zl[n],"\n\n"):""}({id:i,source:n,type:r}),"\n").concat(function(t){let{type:e}=t;return"\n#define SHADER_TYPE_".concat(zl[e].toUpperCase(),"\n")}({type:r}),"\n").concat(_l(t),"\n").concat(function(t,e,i){let n="#if (__VERSION__ > 120)\n\n# define FEATURE_GLSL_DERIVATIVES\n# define FEATURE_GLSL_DRAW_BUFFERS\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FEATURE_GLSL_TEXTURE_LOD\n\n// DEPRECATED FLAGS, remove in v9\n# define FRAG_DEPTH\n# define DERIVATIVES\n# define DRAW_BUFFERS\n# define TEXTURE_LOD\n\n#endif // __VERSION\n";return gl(t,dl.GLSL_FRAG_DEPTH)&&(n+="\n// FRAG_DEPTH => gl_FragDepth is available\n#ifdef GL_EXT_frag_depth\n#extension GL_EXT_frag_depth : enable\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FRAG_DEPTH\n# define gl_FragDepth gl_FragDepthEXT\n#endif\n"),gl(t,dl.GLSL_DERIVATIVES)&&fl(t,dl.GLSL_DERIVATIVES)&&(n+="\n// DERIVATIVES => dxdF, dxdY and fwidth are available\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n# define FEATURE_GLSL_DERIVATIVES\n# define DERIVATIVES\n#endif\n"),gl(t,dl.GLSL_FRAG_DATA)&&fl(t,dl.GLSL_FRAG_DATA,{behavior:"require"})&&(n+="\n// DRAW_BUFFERS => gl_FragData[] is available\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers : require\n#define FEATURE_GLSL_DRAW_BUFFERS\n#define DRAW_BUFFERS\n#endif\n"),gl(t,dl.GLSL_TEXTURE_LOD)&&(n+="// TEXTURE_LOD => texture2DLod etc are available\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n\n# define FEATURE_GLSL_TEXTURE_LOD\n# define TEXTURE_LOD\n\n#endif\n"),n}(t),"\n").concat(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=0,i="";for(const n in t){0===e&&(i+="\n// APPLICATION DEFINES\n"),e++;const r=t[n];(r||Number.isFinite(r))&&(i+="#define ".concat(n.toUpperCase()," ").concat(t[n],"\n"))}0===e&&(i+="\n");return i}(_),"\n").concat(d?"":Nl,"\n"):"".concat(m,"\n");const v=function(t){const e={vs:{},fs:{}};return t.forEach((t=>{let i;"string"!=typeof t?(i=t,t=i.hook):i={},t=t.trim();const[n,r]=t.split(":"),s=t.replace(/\(.+/,"");e[n][s]=Object.assign(i,{signature:r})})),e}(a),x={},b={},w={};for(const t in l){const e="string"==typeof l[t]?{injection:l[t],order:0}:l[t],i=t.match(/^(v|f)s:(#)?([\w-]+)$/);if(i){i[2]?"decl"===i[3]?b[t]=[e]:w[t]=[e]:x[t]=[e]}else w[t]=[e]}for(const t of s){u&&t.checkDeprecations(g,u);y+=t.getModuleSource(r,f);const e=t.injections[r];for(const t in e){const i=t.match(/^(v|f)s:#([\w-]+)$/);if(i){const n="decl"===i[2]?b:w;n[t]=n[t]||[],n[t].push(e[t])}else x[t]=x[t]||[],x[t].push(e[t])}}return y+=Fl,y=Al(y,r,b),y+=function(t,e){let i="";for(const n in t){const r=t[n];if(i+="void ".concat(r.signature," {\n"),r.header&&(i+="  ".concat(r.header)),e[n]){const t=e[n];t.sort(((t,e)=>t.order-e.order));for(const e of t)i+="  ".concat(e.injection,"\n")}r.footer&&(i+="  ".concat(r.footer)),i+="}\n"}return i}(v[r],x),y+=g,y=Al(y,r,w),y=Ol(y,c?100:f,d),y}function Gl(t){return function(e){const i={};for(const n of t){const t=n.getUniforms(e,i);Object.assign(i,t)}return i}}const Vl="out vec4 transform_output;\nvoid main() {\n  transform_output = vec4(0);\n}",jl="#version 300 es\n".concat(Vl);function Hl(t,e){e=Array.isArray(e)?e:[e];const i=t.replace(/^\s+/,"").split(/\s+/),[n,r,s]=i;if(!e.includes(n)||!r||!s)return null;return{qualifier:n,type:r,name:s.split(";")[0]}}function Wl(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{version:e=100,input:i,inputType:n,output:r}=t;if(!i)return 300===e?jl:e>300?"#version ".concat(e,"\n").concat(Vl):"void main() {gl_FragColor = vec4(0);}";const s=function(t,e){switch(e){case"float":return"vec4(".concat(t,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(t,", 0.0, 1.0)");case"vec3":return"vec4(".concat(t,", 1.0)");case"vec4":return t;default:return Qa(!1),null}}(i,n);return e>=300?"#version ".concat(e," ").concat(300===e?"es":"","\nin ").concat(n," ").concat(i,";\nout vec4 ").concat(r,";\nvoid main() {\n  ").concat(r," = ").concat(s,";\n}"):"varying ".concat(n," ").concat(i,";\nvoid main() {\n  gl_FragColor = ").concat(s,";\n}")}const ql={name:"fp32",vs:"#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\nconst float TWO_PI = 6.2831854820251465;\nconst float PI_2 = 1.5707963705062866;\nconst float PI_16 = 0.1963495463132858;\n\nconst float SIN_TABLE_0 = 0.19509032368659973;\nconst float SIN_TABLE_1 = 0.3826834261417389;\nconst float SIN_TABLE_2 = 0.5555702447891235;\nconst float SIN_TABLE_3 = 0.7071067690849304;\n\nconst float COS_TABLE_0 = 0.9807852506637573;\nconst float COS_TABLE_1 = 0.9238795042037964;\nconst float COS_TABLE_2 = 0.8314695954322815;\nconst float COS_TABLE_3 = 0.7071067690849304;\n\nconst float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;\nconst float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;\nconst float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;\nconst float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;\n\nfloat sin_taylor_fp32(float a) {\n  float r, s, t, x;\n\n  if (a == 0.0) {\n    return 0.0;\n  }\n\n  x = -a * a;\n  s = a;\n  r = a;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_3;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_5;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_7;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_9;\n  s = s + t;\n\n  return s;\n}\n\nvoid sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {\n  if (a == 0.0) {\n    sin_t = 0.0;\n    cos_t = 1.0;\n  }\n  sin_t = sin_taylor_fp32(a);\n  cos_t = sqrt(1.0 - sin_t * sin_t);\n}\n\nfloat tan_taylor_fp32(float a) {\n    float sin_a;\n    float cos_a;\n\n    if (a == 0.0) {\n        return 0.0;\n    }\n    float z = floor(a / TWO_PI);\n    float r = a - TWO_PI * z;\n\n    float t;\n    float q = floor(r / PI_2 + 0.5);\n    int j = int(q);\n\n    if (j < -2 || j > 2) {\n        return 1.0 / 0.0;\n    }\n\n    t = r - PI_2 * q;\n\n    q = floor(t / PI_16 + 0.5);\n    int k = int(q);\n    int abs_k = int(abs(float(k)));\n\n    if (abs_k > 4) {\n        return 1.0 / 0.0;\n    } else {\n        t = t - PI_16 * q;\n    }\n\n    float u = 0.0;\n    float v = 0.0;\n\n    float sin_t, cos_t;\n    float s, c;\n    sincos_taylor_fp32(t, sin_t, cos_t);\n\n    if (k == 0) {\n        s = sin_t;\n        c = cos_t;\n    } else {\n        if (abs(float(abs_k) - 1.0) < 0.5) {\n            u = COS_TABLE_0;\n            v = SIN_TABLE_0;\n        } else if (abs(float(abs_k) - 2.0) < 0.5) {\n            u = COS_TABLE_1;\n            v = SIN_TABLE_1;\n        } else if (abs(float(abs_k) - 3.0) < 0.5) {\n            u = COS_TABLE_2;\n            v = SIN_TABLE_2;\n        } else if (abs(float(abs_k) - 4.0) < 0.5) {\n            u = COS_TABLE_3;\n            v = SIN_TABLE_3;\n        }\n        if (k > 0) {\n            s = u * sin_t + v * cos_t;\n            c = u * cos_t - v * sin_t;\n        } else {\n            s = u * sin_t - v * cos_t;\n            c = u * cos_t + v * sin_t;\n        }\n    }\n\n    if (j == 0) {\n        sin_a = s;\n        cos_a = c;\n    } else if (j == 1) {\n        sin_a = c;\n        cos_a = -s;\n    } else if (j == -1) {\n        sin_a = -c;\n        cos_a = s;\n    } else {\n        sin_a = -s;\n        cos_a = -c;\n    }\n    return sin_a / cos_a;\n}\n#endif\n\nfloat tan_fp32(float a) {\n#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\n  return tan_taylor_fp32(a);\n#else\n  return tan(a);\n#endif\n}\n",fs:null};function Xl(t,e){if(!t)throw new Error("math.gl assertion ".concat(e))}const Zl=1/Math.PI*180,Jl=1/180*Math.PI,Yl={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function $l(t,{precision:e=Yl.precision}={}){return t=function(t){return Math.round(t/Yl.EPSILON)*Yl.EPSILON}(t),"".concat(parseFloat(t.toPrecision(e)))}function Kl(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function Ql(t){return function(t,e){return sc(t,(t=>t*Jl),e)}(t)}function tc(t){return ec(t)}function ec(t,e){return sc(t,(t=>t*Zl),e)}function ic(t,e,i){return sc(t,(t=>Math.max(e,Math.min(i,t))))}function nc(t,e,i){return Kl(t)?t.map(((t,n)=>nc(t,e[n],i))):i*e+(1-i)*t}function rc(t,e,i){const n=Yl.EPSILON;i&&(Yl.EPSILON=i);try{if(t===e)return!0;if(Kl(t)&&Kl(e)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(!rc(t[i],e[i]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):"number"==typeof t&&"number"==typeof e&&Math.abs(t-e)<=Yl.EPSILON*Math.max(1,Math.abs(t),Math.abs(e))}finally{Yl.EPSILON=n}}function sc(t,e,i){if(Kl(t)){const n=t;i=i||function(t){return t.clone?t.clone():new Array(t.length)}(n);for(let r=0;r<i.length&&r<n.length;++r)i[r]=e(t[r],r,i);return i}return e(t)}class oc extends(function(t){function e(){var e=Reflect.construct(t,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return e.prototype=Object.create(t.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t,e}(Array)){clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=t[i+e];return this.check()}toArray(t=[],e=0){for(let i=0;i<this.ELEMENTS;++i)t[e+i]=this[i];return t}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}to(t){return t===this?this:Kl(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(Yl)}formatString(t){let e="";for(let i=0;i<this.ELEMENTS;++i)e+=(i>0?", ":"")+$l(this[i],t);return"".concat(t.printTypes?this.constructor.name:"","[").concat(e,"]")}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!rc(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,i){if(void 0===i)return this.lerp(this,t,e);for(let n=0;n<this.ELEMENTS;++n){const r=t[n];this[n]=r+i*(e[n]-r)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],t[i]),e[i]);return this.check()}add(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]+=e[t];return this.check()}subtract(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]-=e[t];return this.check()}scale(t){if("number"==typeof t)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;else for(let e=0;e<this.ELEMENTS&&e<t.length;++e)this[e]*=t[e];return this.check()}multiplyByScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}check(){if(Yl.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.multiplyByScalar(1/t)}clampScalar(t,e){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],t),e);return this.check()}get elements(){return this}}function ac(t){if(!Number.isFinite(t))throw new Error("Invalid number ".concat(t));return t}function lc(t,e,i=""){if(Yl.debug&&!function(t,e){if(t.length!==e)return!1;for(let e=0;e<t.length;++e)if(!Number.isFinite(t[e]))return!1;return!0}(t,e))throw new Error("math.gl: ".concat(i," some fields set to invalid numbers'"));return t}class cc extends oc{get x(){return this[0]}set x(t){this[0]=ac(t)}get y(){return this[1]}set y(t){this[1]=ac(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let i=0;i<this.ELEMENTS;++i){const n=this[i]-t[i];e+=n*n}return ac(e)}dot(t){let e=0;for(let i=0;i<this.ELEMENTS;++i)e+=this[i]*t[i];return ac(e)}normalize(){const t=this.magnitude();if(0!==t)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e[t];return this.check()}divide(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e[t];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return Xl(t>=0&&t<this.ELEMENTS,"index is out of range"),ac(this[t])}setComponent(t,e){return Xl(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}var hc,uc=1e-6,dc="undefined"!=typeof Float32Array?Float32Array:Array;function pc(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function fc(t,e,i,n){var r=e[0],s=e[1];return t[0]=r+n*(i[0]-r),t[1]=s+n*(i[1]-s),t}function mc(t,e,i){var n=e[0],r=e[1];return t[0]=i[0]*n+i[3]*r+i[6],t[1]=i[1]*n+i[4]*r+i[7],t}function gc(t,e,i){var n=e[0],r=e[1];return t[0]=i[0]*n+i[4]*r+i[12],t[1]=i[1]*n+i[5]*r+i[13],t}function _c(t,e,i){const n=e[0],r=e[1],s=i[3]*n+i[7]*r||1;return t[0]=(i[0]*n+i[4]*r)/s,t[1]=(i[1]*n+i[5]*r)/s,t}function yc(t,e,i){const n=e[0],r=e[1],s=e[2],o=i[3]*n+i[7]*r+i[11]*s||1;return t[0]=(i[0]*n+i[4]*r+i[8]*s)/o,t[1]=(i[1]*n+i[5]*r+i[9]*s)/o,t[2]=(i[2]*n+i[6]*r+i[10]*s)/o,t}function vc(t,e,i){const n=e[0],r=e[1],s=e[2];return t[0]=i[0]*n+i[3]*r+i[6]*s,t[1]=i[1]*n+i[4]*r+i[7]*s,t[2]=i[2]*n+i[5]*r+i[8]*s,t[3]=e[3],t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),hc=new dc(2),dc!=Float32Array&&(hc[0]=0,hc[1]=0);let xc=class extends cc{constructor(t=0,e=0){super(2),Kl(t)&&1===arguments.length?this.copy(t):(Yl.debug&&(ac(t),ac(e)),this[0]=t,this[1]=e)}set(t,e){return this[0]=t,this[1]=e,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this.check()}fromObject(t){return Yl.debug&&(ac(t.x),ac(t.y)),this[0]=t.x,this[1]=t.y,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t}get ELEMENTS(){return 2}horizontalAngle(){return Math.atan2(this.y,this.x)}verticalAngle(){return Math.atan2(this.x,this.y)}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return gc(this,this,t),this.check()}transformAsVector(t){return _c(this,this,t),this.check()}transformByMatrix3(t){return mc(this,this,t),this.check()}transformByMatrix2x3(t){return function(t,e,i){var n=e[0],r=e[1];t[0]=i[0]*n+i[2]*r+i[4],t[1]=i[1]*n+i[3]*r+i[5]}(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,i){var n=e[0],r=e[1];t[0]=i[0]*n+i[2]*r,t[1]=i[1]*n+i[3]*r}(this,this,t),this.check()}};function bc(){var t=new dc(3);return dc!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function wc(t){return Math.hypot(t[0],t[1],t[2])}function Ac(t,e,i){var n=new dc(3);return n[0]=t,n[1]=e,n[2]=i,n}function Tc(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Mc(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[0],a=i[1],l=i[2];return t[0]=r*l-s*a,t[1]=s*o-n*l,t[2]=n*a-r*o,t}function Sc(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[3]*n+i[7]*r+i[11]*s+i[15];return t[0]=(i[0]*n+i[4]*r+i[8]*s+i[12])/(o=o||1),t[1]=(i[1]*n+i[5]*r+i[9]*s+i[13])/o,t[2]=(i[2]*n+i[6]*r+i[10]*s+i[14])/o,t}function Ec(t,e,i){var n=e[0],r=e[1],s=e[2];return t[0]=n*i[0]+r*i[3]+s*i[6],t[1]=n*i[1]+r*i[4]+s*i[7],t[2]=n*i[2]+r*i[5]+s*i[8],t}function Cc(t,e,i){var n=i[0],r=i[1],s=i[2],o=e[0],a=e[1],l=e[2],c=r*l-s*a,h=s*o-n*l,u=n*a-r*o,d=r*u-s*h,p=s*c-n*u,f=n*h-r*c,m=2*i[3];return h*=m,u*=m,p*=2,f*=2,t[0]=o+(c*=m)+(d*=2),t[1]=a+h+p,t[2]=l+u+f,t}var Ic=function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t},Pc=wc;!function(){var t=bc()}();const Lc=[0,0,0];let Rc,Bc,Dc=class t extends cc{static get ZERO(){return Rc||(Rc=new t(0,0,0),Object.freeze(Rc)),Rc}constructor(t=0,e=0,i=0){super(-0,-0,-0),1===arguments.length&&Kl(t)?this.copy(t):(Yl.debug&&(ac(t),ac(e),ac(i)),this[0]=t,this[1]=e,this[2]=i)}set(t,e,i){return this[0]=t,this[1]=e,this[2]=i,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return Yl.debug&&(ac(t.x),ac(t.y),ac(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=ac(t)}angle(t){return function(t,e){var i=t[0],n=t[1],r=t[2],s=e[0],o=e[1],a=e[2],l=Math.sqrt(i*i+n*n+r*r)*Math.sqrt(s*s+o*o+a*a),c=l&&Tc(t,e)/l;return Math.acos(Math.min(Math.max(c,-1),1))}(this,t)}cross(t){return Mc(this,this,t),this.check()}rotateX({radians:t,origin:e=Lc}){return function(t,e,i,n){var r=[],s=[];r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],s[0]=r[0],s[1]=r[1]*Math.cos(n)-r[2]*Math.sin(n),s[2]=r[1]*Math.sin(n)+r[2]*Math.cos(n),t[0]=s[0]+i[0],t[1]=s[1]+i[1],t[2]=s[2]+i[2]}(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Lc}){return function(t,e,i,n){var r=[],s=[];r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],s[0]=r[2]*Math.sin(n)+r[0]*Math.cos(n),s[1]=r[1],s[2]=r[2]*Math.cos(n)-r[0]*Math.sin(n),t[0]=s[0]+i[0],t[1]=s[1]+i[1],t[2]=s[2]+i[2]}(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Lc}){return function(t,e,i,n){var r=[],s=[];r[0]=e[0]-i[0],r[1]=e[1]-i[1],r[2]=e[2]-i[2],s[0]=r[0]*Math.cos(n)-r[1]*Math.sin(n),s[1]=r[0]*Math.sin(n)+r[1]*Math.cos(n),s[2]=r[2],t[0]=s[0]+i[0],t[1]=s[1]+i[1],t[2]=s[2]+i[2]}(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Sc(this,this,t),this.check()}transformAsVector(t){return yc(this,this,t),this.check()}transformByMatrix3(t){return Ec(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,i){const n=e[0],r=e[1];t[0]=i[0]*n+i[2]*r,t[1]=i[1]*n+i[3]*r,t[2]=e[2]}(this,this,t),this.check()}transformByQuaternion(t){return Cc(this,this,t),this.check()}},Oc=class t extends cc{static get ZERO(){return Bc||(Bc=new t(0,0,0,0),Object.freeze(Bc)),Bc}constructor(t=0,e=0,i=0,n=0){super(-0,-0,-0,-0),Kl(t)&&1===arguments.length?this.copy(t):(Yl.debug&&(ac(t),ac(e),ac(i),ac(n)),this[0]=t,this[1]=e,this[2]=i,this[3]=n)}set(t,e,i,n){return this[0]=t,this[1]=e,this[2]=i,this[3]=n,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this.check()}fromObject(t){return Yl.debug&&(ac(t.x),ac(t.y),ac(t.z),ac(t.w)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this[3]=t.w,this}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t.w=this[3],t}get ELEMENTS(){return 4}get z(){return this[2]}set z(t){this[2]=ac(t)}get w(){return this[3]}set w(t){this[3]=ac(t)}transform(t){return Sc(this,this,t),this.check()}transformByMatrix3(t){return vc(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,i){const n=e[0],r=e[1];t[0]=i[0]*n+i[2]*r,t[1]=i[1]*n+i[3]*r,t[2]=e[2],t[3]=e[3]}(this,this,t),this.check()}transformByQuaternion(t){return Cc(this,this,t),this.check()}applyMatrix4(t){return t.transform(this,this),this}};class kc extends oc{toString(){let t="[";if(Yl.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let i=0;i<this.RANK;++i)t+=" ".concat(this[i*this.RANK+e])}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=" ".concat(this[e])}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,i){return this[e*this.RANK+t]=ac(i),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const i=t*this.RANK;for(let t=0;t<this.RANK;++t)e[t]=this[i+t];return e}setColumn(t,e){const i=t*this.RANK;for(let t=0;t<this.RANK;++t)this[i+t]=e[t];return this}}function Fc(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=i[0],p=i[1],f=i[2],m=i[3],g=i[4],_=i[5],y=i[6],v=i[7],x=i[8];return t[0]=d*n+p*o+f*c,t[1]=d*r+p*a+f*h,t[2]=d*s+p*l+f*u,t[3]=m*n+g*o+_*c,t[4]=m*r+g*a+_*h,t[5]=m*s+g*l+_*u,t[6]=y*n+v*o+x*c,t[7]=y*r+v*a+x*h,t[8]=y*s+v*l+x*u,t}function zc(t,e,i){var n=i[0],r=i[1];return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}var Nc;!function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL1ROW0=3]="COL1ROW0",t[t.COL1ROW1=4]="COL1ROW1",t[t.COL1ROW2=5]="COL1ROW2",t[t.COL2ROW0=6]="COL2ROW0",t[t.COL2ROW1=7]="COL2ROW1",t[t.COL2ROW2=8]="COL2ROW2"}(Nc||(Nc={}));const Uc=Object.freeze([1,0,0,0,1,0,0,0,1]);let Gc,Vc,jc=class extends kc{static get IDENTITY(){return function(){Vc||(Vc=new jc,Object.freeze(Vc));return Vc}()}static get ZERO(){return function(){Gc||(Gc=new jc([0,0,0,0,0,0,0,0,0]),Object.freeze(Gc));return Gc}()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return Nc}constructor(t,...e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):e.length>0?this.copy([t,...e]):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this.check()}identity(){return this.copy(Uc)}fromObject(t){return this.check()}fromQuaternion(t){return function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i+i,a=n+n,l=r+r,c=i*o,h=n*o,u=n*a,d=r*o,p=r*a,f=r*l,m=s*o,g=s*a,_=s*l;t[0]=1-u-f,t[3]=h-_,t[6]=d+g,t[1]=h+_,t[4]=1-c-f,t[7]=p-m,t[2]=d-g,t[5]=p+m,t[8]=1-c-u}(this,t),this.check()}set(t,e,i,n,r,s,o,a,l){return this[0]=t,this[1]=e,this[2]=i,this[3]=n,this[4]=r,this[5]=s,this[6]=o,this[7]=a,this[8]=l,this.check()}setRowMajor(t,e,i,n,r,s,o,a,l){return this[0]=t,this[1]=n,this[2]=o,this[3]=e,this[4]=r,this[5]=a,this[6]=i,this[7]=s,this[8]=l,this.check()}determinant(){return function(t){var e=t[3],i=t[4],n=t[5],r=t[6],s=t[7],o=t[8];return t[0]*(o*i-n*s)+t[1]*(-o*e+n*r)+t[2]*(s*e-i*r)}(this)}transpose(){return function(t,e){if(t===e){var i=e[1],n=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=n,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8]}(this,this),this.check()}invert(){return function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],u=h*o-a*c,d=-h*s+a*l,p=c*s-o*l,f=i*u+n*d+r*p;f&&(t[0]=u*(f=1/f),t[1]=(-h*n+r*c)*f,t[2]=(a*n-r*o)*f,t[3]=d*f,t[4]=(h*i-r*l)*f,t[5]=(-a*i+r*s)*f,t[6]=p*f,t[7]=(-c*i+n*l)*f,t[8]=(o*i-n*s)*f)}(this,this),this.check()}multiplyLeft(t){return Fc(this,t,this),this.check()}multiplyRight(t){return Fc(this,this,t),this.check()}rotate(t){return function(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=Math.sin(i),p=Math.cos(i);t[0]=p*n+d*o,t[1]=p*r+d*a,t[2]=p*s+d*l,t[3]=p*o-d*n,t[4]=p*a-d*r,t[5]=p*l-d*s,t[6]=c,t[7]=h,t[8]=u}(this,this,t),this.check()}scale(t){return Array.isArray(t)?zc(this,this,t):zc(this,this,[t,t]),this.check()}translate(t){return function(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=i[0],p=i[1];t[0]=n,t[1]=r,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=d*n+p*o+c,t[7]=d*r+p*a+h,t[8]=d*s+p*l+u}(this,this,t),this.check()}transform(t,e){let i;switch(t.length){case 2:i=mc(e||[-0,-0],t,this);break;case 3:i=Ec(e||[-0,-0,-0],t,this);break;case 4:i=vc(e||[-0,-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return lc(i,t.length),i}transformVector(t,e){return this.transform(t,e)}transformVector2(t,e){return this.transform(t,e)}transformVector3(t,e){return this.transform(t,e)}};function Hc(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],_=e[15],y=i*a-n*o,v=i*l-r*o,x=i*c-s*o,b=n*l-r*a,w=n*c-s*a,A=r*c-s*l,T=h*m-u*f,M=h*g-d*f,S=h*_-p*f,E=u*g-d*m,C=u*_-p*m,I=d*_-p*g,P=y*I-v*C+x*E+b*S-w*M+A*T;return P?(t[0]=(a*I-l*C+c*E)*(P=1/P),t[1]=(r*C-n*I-s*E)*P,t[2]=(m*A-g*w+_*b)*P,t[3]=(d*w-u*A-p*b)*P,t[4]=(l*S-o*I-c*M)*P,t[5]=(i*I-r*S+s*M)*P,t[6]=(g*x-f*A-_*v)*P,t[7]=(h*A-d*x+p*v)*P,t[8]=(o*C-a*S+c*T)*P,t[9]=(n*S-i*C-s*T)*P,t[10]=(f*w-m*x+_*y)*P,t[11]=(u*x-h*w-p*y)*P,t[12]=(a*M-o*E-l*T)*P,t[13]=(i*E-n*M+r*T)*P,t[14]=(m*v-f*b-g*y)*P,t[15]=(h*b-u*v+d*y)*P,t):null}function Wc(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],m=e[12],g=e[13],_=e[14],y=e[15],v=i[0],x=i[1],b=i[2],w=i[3];return t[0]=v*n+x*a+b*u+w*m,t[1]=v*r+x*l+b*d+w*g,t[2]=v*s+x*c+b*p+w*_,t[3]=v*o+x*h+b*f+w*y,t[4]=(v=i[4])*n+(x=i[5])*a+(b=i[6])*u+(w=i[7])*m,t[5]=v*r+x*l+b*d+w*g,t[6]=v*s+x*c+b*p+w*_,t[7]=v*o+x*h+b*f+w*y,t[8]=(v=i[8])*n+(x=i[9])*a+(b=i[10])*u+(w=i[11])*m,t[9]=v*r+x*l+b*d+w*g,t[10]=v*s+x*c+b*p+w*_,t[11]=v*o+x*h+b*f+w*y,t[12]=(v=i[12])*n+(x=i[13])*a+(b=i[14])*u+(w=i[15])*m,t[13]=v*r+x*l+b*d+w*g,t[14]=v*s+x*c+b*p+w*_,t[15]=v*o+x*h+b*f+w*y,t}function qc(t,e,i){var n,r,s,o,a,l,c,h,u,d,p,f,m=i[0],g=i[1],_=i[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*_+e[12],t[13]=e[1]*m+e[5]*g+e[9]*_+e[13],t[14]=e[2]*m+e[6]*g+e[10]*_+e[14],t[15]=e[3]*m+e[7]*g+e[11]*_+e[15]):(r=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],u=e[8],d=e[9],p=e[10],f=e[11],t[0]=n=e[0],t[1]=r,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=c,t[7]=h,t[8]=u,t[9]=d,t[10]=p,t[11]=f,t[12]=n*m+a*g+u*_+e[12],t[13]=r*m+l*g+d*_+e[13],t[14]=s*m+c*g+p*_+e[14],t[15]=o*m+h*g+f*_+e[15]),t}function Xc(t,e,i){var n=i[0],r=i[1],s=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Zc(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*r+c*n,t[5]=o*r+h*n,t[6]=a*r+u*n,t[7]=l*r+d*n,t[8]=c*r-s*n,t[9]=h*r-o*n,t[10]=u*r-a*n,t[11]=d*r-l*n,t}function Jc(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r+c*n,t[1]=o*r+h*n,t[2]=a*r+u*n,t[3]=l*r+d*n,t[4]=c*r-s*n,t[5]=h*r-o*n,t[6]=u*r-a*n,t[7]=d*r-l*n,t}var Yc=function(t,e,i,n,r){var s,o=1/Math.tan(e/2);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(t[10]=(r+n)*(s=1/(n-r)),t[14]=2*r*n*s):(t[10]=-1,t[14]=-2*n),t};var $c,Kc=function(t,e,i,n,r,s,o){var a=1/(e-i),l=1/(n-r),c=1/(s-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*a,t[13]=(r+n)*l,t[14]=(o+s)*c,t[15]=1,t};function Qc(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function th(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3];return t[0]=i[0]*n+i[4]*r+i[8]*s+i[12]*o,t[1]=i[1]*n+i[5]*r+i[9]*s+i[13]*o,t[2]=i[2]*n+i[6]*r+i[10]*s+i[14]*o,t[3]=i[3]*n+i[7]*r+i[11]*s+i[15]*o,t}!function(){var t=function(){var t=new dc(4);return dc!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}()}(),function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL0ROW3=3]="COL0ROW3",t[t.COL1ROW0=4]="COL1ROW0",t[t.COL1ROW1=5]="COL1ROW1",t[t.COL1ROW2=6]="COL1ROW2",t[t.COL1ROW3=7]="COL1ROW3",t[t.COL2ROW0=8]="COL2ROW0",t[t.COL2ROW1=9]="COL2ROW1",t[t.COL2ROW2=10]="COL2ROW2",t[t.COL2ROW3=11]="COL2ROW3",t[t.COL3ROW0=12]="COL3ROW0",t[t.COL3ROW1=13]="COL3ROW1",t[t.COL3ROW2=14]="COL3ROW2",t[t.COL3ROW3=15]="COL3ROW3"}($c||($c={}));const eh=45*Math.PI/180,ih=1,nh=.1,rh=500,sh=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);let oh,ah,lh=class extends kc{static get IDENTITY(){return function(){ah||(ah=new lh,Object.freeze(ah));return ah}()}static get ZERO(){return function(){oh||(oh=new lh([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(oh));return oh}()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return $c}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){return this[0]=t,this[1]=e,this[2]=i,this[3]=n,this[4]=r,this[5]=s,this[6]=o,this[7]=a,this[8]=l,this[9]=c,this[10]=h,this[11]=u,this[12]=d,this[13]=p,this[14]=f,this[15]=m,this.check()}setRowMajor(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){return this[0]=t,this[1]=r,this[2]=l,this[3]=d,this[4]=e,this[5]=s,this[6]=c,this[7]=p,this[8]=i,this[9]=o,this[10]=h,this[11]=f,this[12]=n,this[13]=a,this[14]=u,this[15]=m,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(sh)}fromObject(t){return this.check()}fromQuaternion(t){return function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i+i,a=n+n,l=r+r,c=i*o,h=n*o,u=n*a,d=r*o,p=r*a,f=r*l,m=s*o,g=s*a,_=s*l;t[0]=1-u-f,t[1]=h+_,t[2]=d-g,t[3]=0,t[4]=h-_,t[5]=1-c-f,t[6]=p+m,t[7]=0,t[8]=d+g,t[9]=p-m,t[10]=1-c-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this,t),this.check()}frustum(t){const{left:e,right:i,bottom:n,top:r,near:s=nh,far:o=rh}=t;return o===1/0?function(t,e,i,n,r,s){const o=2*s/(i-e),a=2*s/(r-n),l=(i+e)/(i-e),c=(r+n)/(r-n),h=-1,u=-1,d=-2*s;t[0]=o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=l,t[9]=c,t[10]=h,t[11]=u,t[12]=0,t[13]=0,t[14]=d,t[15]=0}(this,e,i,n,r,s):function(t,e,i,n,r,s,o){var a=1/(i-e),l=1/(r-n),c=1/(s-o);t[0]=2*s*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*l,t[6]=0,t[7]=0,t[8]=(i+e)*a,t[9]=(r+n)*l,t[10]=(o+s)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*s*2*c,t[15]=0}(this,e,i,n,r,s,o),this.check()}lookAt(t){const{eye:e,center:i=[0,0,0],up:n=[0,1,0]}=t;return function(t,e,i,n){var r,s,o,a,l,c,h,u,d,p,f=e[0],m=e[1],g=e[2],_=n[0],y=n[1],v=n[2],x=i[0],b=i[1],w=i[2];Math.abs(f-x)<uc&&Math.abs(m-b)<uc&&Math.abs(g-w)<uc?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t):(h=f-x,u=m-b,d=g-w,r=y*(d*=p=1/Math.hypot(h,u,d))-v*(u*=p),s=v*(h*=p)-_*d,o=_*u-y*h,(p=Math.hypot(r,s,o))?(r*=p=1/p,s*=p,o*=p):(r=0,s=0,o=0),a=u*o-d*s,l=d*r-h*o,c=h*s-u*r,(p=Math.hypot(a,l,c))?(a*=p=1/p,l*=p,c*=p):(a=0,l=0,c=0),t[0]=r,t[1]=a,t[2]=h,t[3]=0,t[4]=s,t[5]=l,t[6]=u,t[7]=0,t[8]=o,t[9]=c,t[10]=d,t[11]=0,t[12]=-(r*f+s*m+o*g),t[13]=-(a*f+l*m+c*g),t[14]=-(h*f+u*m+d*g),t[15]=1)}(this,e,i,n),this.check()}ortho(t){const{left:e,right:i,bottom:n,top:r,near:s=nh,far:o=rh}=t;return Kc(this,e,i,n,r,s,o),this.check()}orthographic(t){const{fovy:e=eh,aspect:i=ih,focalDistance:n=1,near:r=nh,far:s=rh}=t;ch(e);const o=n*Math.tan(e/2),a=o*i;return this.ortho({left:-a,right:a,bottom:-o,top:o,near:r,far:s})}perspective(t){const{fovy:e=45*Math.PI/180,aspect:i=1,near:n=.1,far:r=500}=t;return ch(e),Yc(this,e,i,n,r),this.check()}determinant(){return function(t){var e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],u=t[10],d=t[11],p=t[12],f=t[13],m=t[14],g=t[15];return(e*o-i*s)*(u*g-d*m)-(e*a-n*s)*(h*g-d*f)+(e*l-r*s)*(h*m-u*f)+(i*a-n*o)*(c*g-d*p)-(i*l-r*o)*(c*m-u*p)+(n*l-r*a)*(c*f-h*p)}(this)}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0];const i=this.getScale(e=e||[-0,-0,-0]),n=1/i[0],r=1/i[1],s=1/i[2];return t[0]=this[0]*n,t[1]=this[1]*r,t[2]=this[2]*s,t[3]=0,t[4]=this[4]*n,t[5]=this[5]*r,t[6]=this[6]*s,t[7]=0,t[8]=this[8]*n,t[9]=this[9]*r,t[10]=this[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0];const i=this.getScale(e=e||[-0,-0,-0]),n=1/i[0],r=1/i[1],s=1/i[2];return t[0]=this[0]*n,t[1]=this[1]*r,t[2]=this[2]*s,t[3]=this[4]*n,t[4]=this[5]*r,t[5]=this[6]*s,t[6]=this[8]*n,t[7]=this[9]*r,t[8]=this[10]*s,t}transpose(){return function(t,e){if(t===e){var i=e[1],n=e[2],r=e[3],s=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=s,t[11]=e[14],t[12]=r,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]}(this,this),this.check()}invert(){return Hc(this,this),this.check()}multiplyLeft(t){return Wc(this,t,this),this.check()}multiplyRight(t){return Wc(this,this,t),this.check()}rotateX(t){return Zc(this,this,t),this.check()}rotateY(t){return function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],u=e[10],d=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r-c*n,t[1]=o*r-h*n,t[2]=a*r-u*n,t[3]=l*r-d*n,t[8]=s*n+c*r,t[9]=o*n+h*r,t[10]=a*n+u*r,t[11]=l*n+d*r}(this,this,t),this.check()}rotateZ(t){return Jc(this,this,t),this.check()}rotateXYZ(t){return this.rotateX(t[0]).rotateY(t[1]).rotateZ(t[2])}rotateAxis(t,e){return function(t,e,i,n){var r,s,o,a,l,c,h,u,d,p,f,m,g,_,y,v,x,b,w,A,T,M,S,E,C=n[0],I=n[1],P=n[2],L=Math.hypot(C,I,P);L<uc||(C*=L=1/L,I*=L,P*=L,r=Math.sin(i),s=Math.cos(i),l=e[1],c=e[2],h=e[3],d=e[5],p=e[6],f=e[7],g=e[9],_=e[10],y=e[11],w=C*I*(o=1-s)-P*r,A=I*I*o+s,T=P*I*o+C*r,M=C*P*o+I*r,S=I*P*o-C*r,E=P*P*o+s,t[0]=(a=e[0])*(v=C*C*o+s)+(u=e[4])*(x=I*C*o+P*r)+(m=e[8])*(b=P*C*o-I*r),t[1]=l*v+d*x+g*b,t[2]=c*v+p*x+_*b,t[3]=h*v+f*x+y*b,t[4]=a*w+u*A+m*T,t[5]=l*w+d*A+g*T,t[6]=c*w+p*A+_*T,t[7]=h*w+f*A+y*T,t[8]=a*M+u*S+m*E,t[9]=l*M+d*S+g*E,t[10]=c*M+p*S+_*E,t[11]=h*M+f*S+y*E,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this,this,t,e),this.check()}scale(t){return Xc(this,this,Array.isArray(t)?t:[t,t,t]),this.check()}translate(t){return qc(this,this,t),this.check()}transform(t,e){return 4===t.length?(lc(e=th(e||[-0,-0,-0,-0],t,this),4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:i}=t;let n;switch(i){case 2:n=gc(e||[-0,-0],t,this);break;case 3:n=Sc(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return lc(n,t.length),n}transformAsVector(t,e){let i;switch(t.length){case 2:i=_c(e||[-0,-0],t,this);break;case 3:i=yc(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return lc(i,t.length),i}transformPoint(t,e){return this.transformAsPoint(t,e)}transformVector(t,e){return this.transformAsPoint(t,e)}transformDirection(t,e){return this.transformAsVector(t,e)}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,i){return this.identity().translate([t,e,i])}};function ch(t){if(t>2*Math.PI)throw Error("expected radians")}function hh(){var t=new dc(4);return dc!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function uh(t,e,i){i*=.5;var n=Math.sin(i);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(i),t}function dh(t,e,i){var n=e[0],r=e[1],s=e[2],o=e[3],a=i[0],l=i[1],c=i[2],h=i[3];return t[0]=n*h+o*a+r*c-s*l,t[1]=r*h+o*l+s*a-n*c,t[2]=s*h+o*c+n*l-r*a,t[3]=o*h-n*a-r*l-s*c,t}function ph(t,e,i,n){var r,s,o,a,l,c=e[0],h=e[1],u=e[2],d=e[3],p=i[0],f=i[1],m=i[2],g=i[3];return(s=c*p+h*f+u*m+d*g)<0&&(s=-s,p=-p,f=-f,m=-m,g=-g),1-s>uc?(r=Math.acos(s),o=Math.sin(r),a=Math.sin((1-n)*r)/o,l=Math.sin(n*r)/o):(a=1-n,l=n),t[0]=a*c+l*p,t[1]=a*h+l*f,t[2]=a*u+l*m,t[3]=a*d+l*g,t}function fh(t,e){var i,n=e[0]+e[4]+e[8];if(n>0)i=Math.sqrt(n+1),t[3]=.5*i,t[0]=(e[5]-e[7])*(i=.5/i),t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var s=(r+1)%3,o=(r+2)%3;i=Math.sqrt(e[3*r+r]-e[3*s+s]-e[3*o+o]+1),t[r]=.5*i,t[3]=(e[3*s+o]-e[3*o+s])*(i=.5/i),t[s]=(e[3*s+r]+e[3*r+s])*i,t[o]=(e[3*o+r]+e[3*r+o])*i}return t}var mh,gh,_h,yh=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},vh=Qc,xh=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},bh=function(t,e,i,n){var r=e[0],s=e[1],o=e[2],a=e[3];return t[0]=r+n*(i[0]-r),t[1]=s+n*(i[1]-s),t[2]=o+n*(i[2]-o),t[3]=a+n*(i[3]-a),t},wh=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},Ah=function(t){var e=t[0],i=t[1],n=t[2],r=t[3];return e*e+i*i+n*n+r*r},Th=function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i*i+n*n+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),t[0]=i*o,t[1]=n*o,t[2]=r*o,t[3]=s*o,t},Mh=(mh=bc(),gh=Ac(1,0,0),_h=Ac(0,1,0),function(t,e,i){var n=Tc(e,i);return n<-.999999?(Mc(mh,gh,e),Pc(mh)<1e-6&&Mc(mh,_h,e),function(t,e){var i=e[0],n=e[1],r=e[2],s=i*i+n*n+r*r;s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s}(mh,mh),uh(t,mh,Math.PI),t):n>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Mc(mh,e,i),t[0]=mh[0],t[1]=mh[1],t[2]=mh[2],t[3]=1+n,Th(t,t))});hh(),hh(),function(){var t=new dc(9);dc!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1}();const Sh=[0,0,0,1];let Eh=class extends oc{constructor(t=0,e=0,i=0,n=1){super(-0,-0,-0,-0),Array.isArray(t)&&1===arguments.length?this.copy(t):this.set(t,e,i,n)}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this.check()}set(t,e,i,n){return this[0]=t,this[1]=e,this[2]=i,this[3]=n,this.check()}fromObject(t){return this[0]=t.x,this[1]=t.y,this[2]=t.z,this[3]=t.w,this.check()}fromMatrix3(t){return fh(this,t),this.check()}fromAxisRotation(t,e){return uh(this,t,e),this.check()}identity(){return function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1}(this),this.check()}setAxisAngle(t,e){return this.fromAxisRotation(t,e)}get ELEMENTS(){return 4}get x(){return this[0]}set x(t){this[0]=ac(t)}get y(){return this[1]}set y(t){this[1]=ac(t)}get z(){return this[2]}set z(t){this[2]=ac(t)}get w(){return this[3]}set w(t){this[3]=ac(t)}len(){return wh(this)}lengthSquared(){return Ah(this)}dot(t){return xh(this,t)}rotationTo(t,e){return Mh(this,t,e),this.check()}add(t){return yh(this,this,t),this.check()}calculateW(){return function(t,e){var i=e[0],n=e[1],r=e[2];t[0]=i,t[1]=n,t[2]=r,t[3]=Math.sqrt(Math.abs(1-i*i-n*n-r*r))}(this,this),this.check()}conjugate(){return function(t,e){t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3]}(this,this),this.check()}invert(){return function(t,e){var i=e[0],n=e[1],r=e[2],s=e[3],o=i*i+n*n+r*r+s*s,a=o?1/o:0;t[0]=-i*a,t[1]=-n*a,t[2]=-r*a,t[3]=s*a}(this,this),this.check()}lerp(t,e,i){return void 0===i?this.lerp(this,t,e):(bh(this,t,e,i),this.check())}multiplyRight(t){return dh(this,this,t),this.check()}multiplyLeft(t){return dh(this,t,this),this.check()}normalize(){const t=this.len(),e=t>0?1/t:0;return this[0]=this[0]*e,this[1]=this[1]*e,this[2]=this[2]*e,this[3]=this[3]*e,0===t&&(this[3]=1),this.check()}rotateX(t){return function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);t[0]=n*l+o*a,t[1]=r*l+s*a,t[2]=s*l-r*a,t[3]=o*l-n*a}(this,this,t),this.check()}rotateY(t){return function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);t[0]=n*l-s*a,t[1]=r*l+o*a,t[2]=s*l+n*a,t[3]=o*l-r*a}(this,this,t),this.check()}rotateZ(t){return function(t,e,i){i*=.5;var n=e[0],r=e[1],s=e[2],o=e[3],a=Math.sin(i),l=Math.cos(i);t[0]=n*l+r*a,t[1]=r*l-n*a,t[2]=s*l+o*a,t[3]=o*l-s*a}(this,this,t),this.check()}scale(t){return vh(this,this,t),this.check()}slerp(t,e,i){let n,r,s;switch(arguments.length){case 1:({start:n=Sh,target:r,ratio:s}=t);break;case 2:n=this,r=t,s=e;break;default:n=t,r=e,s=i}return ph(this,n,r,s),this.check()}transformVector4(t,e=new Oc){return function(t,e,i){var n=e[0],r=e[1],s=e[2],o=i[0],a=i[1],l=i[2],c=i[3],h=c*n+a*s-l*r,u=c*r+l*n-o*s,d=c*s+o*r-a*n,p=-o*n-a*r-l*s;t[0]=h*c+p*-o+u*-l-d*-a,t[1]=u*c+p*-a+d*-o-h*-l,t[2]=d*c+p*-l+h*-a-u*-o,t[3]=e[3]}(e,t,this),lc(e,4)}lengthSq(){return this.lengthSquared()}setFromAxisAngle(t,e){return this.setAxisAngle(t,e)}premultiply(t){return this.multiplyLeft(t)}multiply(t){return this.multiplyRight(t)}};var Ch={EPSILON1:.1,EPSILON2:.01,EPSILON3:.001,EPSILON4:1e-4,EPSILON5:1e-5,EPSILON6:1e-6,EPSILON7:1e-7,EPSILON8:1e-8,EPSILON9:1e-9,EPSILON10:1e-10,EPSILON11:1e-11,EPSILON12:1e-12,EPSILON13:1e-13,EPSILON14:1e-14,EPSILON15:1e-15,EPSILON16:1e-16,EPSILON17:1e-17,EPSILON18:1e-18,EPSILON19:1e-19,EPSILON20:1e-20,PI_OVER_TWO:Math.PI/2,PI_OVER_FOUR:Math.PI/4,PI_OVER_SIX:Math.PI/6,TWO_PI:2*Math.PI},Ih="#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))\n\nstruct AmbientLight {\n vec3 color;\n};\n\nstruct PointLight {\n vec3 color;\n vec3 position;\n vec3 attenuation;\n};\n\nstruct DirectionalLight {\n  vec3 color;\n  vec3 direction;\n};\n\nuniform AmbientLight lighting_uAmbientLight;\nuniform PointLight lighting_uPointLight[MAX_LIGHTS];\nuniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];\nuniform int lighting_uPointLightCount;\nuniform int lighting_uDirectionalLightCount;\n\nuniform bool lighting_uEnabled;\n\nfloat getPointLightAttenuation(PointLight pointLight, float distance) {\n  return pointLight.attenuation.x\n       + pointLight.attenuation.y * distance\n       + pointLight.attenuation.z * distance * distance;\n}\n\n#endif\n";const Ph={lightSources:{}};function Lh(){let{color:t=[0,0,0],intensity:e=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.map((t=>t*e/255))}const Rh={name:"lights",vs:Ih,fs:Ih,getUniforms:function t(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ph;if("lightSources"in e){const{ambientLight:t,pointLights:i,directionalLights:n}=e.lightSources||{};return t||i&&i.length>0||n&&n.length>0?Object.assign({},function(t){let{ambientLight:e,pointLights:i=[],directionalLights:n=[]}=t;const r={};return r["lighting_uAmbientLight.color"]=e?Lh(e):[0,0,0],i.forEach(((t,e)=>{r["lighting_uPointLight[".concat(e,"].color")]=Lh(t),r["lighting_uPointLight[".concat(e,"].position")]=t.position,r["lighting_uPointLight[".concat(e,"].attenuation")]=t.attenuation||[1,0,0]})),r.lighting_uPointLightCount=i.length,n.forEach(((t,e)=>{r["lighting_uDirectionalLight[".concat(e,"].color")]=Lh(t),r["lighting_uDirectionalLight[".concat(e,"].direction")]=t.direction})),r.lighting_uDirectionalLightCount=n.length,r}({ambientLight:t,pointLights:i,directionalLights:n}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in e){const i={pointLights:[],directionalLights:[]};for(const t of e.lights||[])switch(t.type){case"ambient":i.ambientLight=t;break;case"directional":i.directionalLights.push(t);break;case"point":i.pointLights.push(t)}return t({lightSources:i})}return{}},defines:{MAX_LIGHTS:3}},Bh={pickingSelectedColor:null,pickingHighlightColor:new Uint8Array([0,255,255,255]),pickingActive:!1,pickingAttribute:!1};const Dh={name:"picking",vs:"uniform bool picking_uActive;\nuniform bool picking_uAttribute;\nuniform vec3 picking_uSelectedColor;\nuniform bool picking_uSelectedColorValid;\n\nout vec4 picking_vRGBcolor_Avalid;\n\nconst float COLOR_SCALE = 1. / 255.;\n\nbool picking_isColorValid(vec3 color) {\n  return dot(color, vec3(1.0)) > 0.001;\n}\n\nbool isVertexPicked(vec3 vertexColor) {\n  return\n    picking_uSelectedColorValid &&\n    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));\n}\n\nvoid picking_setPickingColor(vec3 pickingColor) {\n  if (picking_uActive) {\n    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));\n\n    if (!picking_uAttribute) {\n      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;\n    }\n  } else {\n    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));\n  }\n}\n\nvoid picking_setPickingAttribute(float value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.r = value;\n  }\n}\nvoid picking_setPickingAttribute(vec2 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rg = value;\n  }\n}\nvoid picking_setPickingAttribute(vec3 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rgb = value;\n  }\n}\n",fs:"uniform bool picking_uActive;\nuniform vec3 picking_uSelectedColor;\nuniform vec4 picking_uHighlightColor;\n\nin vec4 picking_vRGBcolor_Avalid;\nvec4 picking_filterHighlightColor(vec4 color) {\n  if (picking_uActive) {\n    return color;\n  }\n  bool selected = bool(picking_vRGBcolor_Avalid.a);\n\n  if (selected) {\n    float highLightAlpha = picking_uHighlightColor.a;\n    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);\n    float highLightRatio = highLightAlpha / blendedAlpha;\n\n    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);\n    return vec4(blendedRGB, blendedAlpha);\n  } else {\n    return color;\n  }\n}\nvec4 picking_filterPickingColor(vec4 color) {\n  if (picking_uActive) {\n    if (picking_vRGBcolor_Avalid.a == 0.0) {\n      discard;\n    }\n    return picking_vRGBcolor_Avalid;\n  }\n  return color;\n}\nvec4 picking_filterColor(vec4 color) {\n  vec4 highightColor = picking_filterHighlightColor(color);\n  return picking_filterPickingColor(highightColor);\n}\n\n",getUniforms:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Bh;const e={};if(void 0!==t.pickingSelectedColor)if(t.pickingSelectedColor){const i=t.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=i}else e.picking_uSelectedColorValid=0;if(t.pickingHighlightColor){const i=Array.from(t.pickingHighlightColor,(t=>t/255));Number.isFinite(i[3])||(i[3]=1),e.picking_uHighlightColor=i}return void 0!==t.pickingActive&&(e.picking_uActive=Boolean(t.pickingActive),e.picking_uAttribute=Boolean(t.pickingAttribute)),e}};var Oh="\nuniform float lighting_uAmbient;\nuniform float lighting_uDiffuse;\nuniform float lighting_uShininess;\nuniform vec3  lighting_uSpecularColor;\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {\n    vec3 halfway_direction = normalize(light_direction + view_direction);\n    float lambertian = dot(light_direction, normal_worldspace);\n    float specular = 0.0;\n    if (lambertian > 0.0) {\n      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);\n      specular = pow(specular_angle, lighting_uShininess);\n    }\n    lambertian = max(lambertian, 0.0);\n    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;\n}\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = surfaceColor;\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n\nvec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = vec3(0, 0, 0);\n  vec3 surfaceColor = vec3(0, 0, 0);\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n";const kh={};function Fh(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:kh;if(!("material"in t))return{};const{material:e}=t;return e?function(t){const{ambient:e=.35,diffuse:i=.6,shininess:n=32,specularColor:r=[30,30,30]}=t;return{lighting_uAmbient:e,lighting_uDiffuse:i,lighting_uShininess:n,lighting_uSpecularColor:r.map((t=>t/255))}}(e):{lighting_uEnabled:!1}}const zh={name:"gouraud-lighting",dependencies:[Rh],vs:Oh,defines:{LIGHTING_VERTEX:1},getUniforms:Fh},Nh={name:"phong-lighting",dependencies:[Rh],fs:Oh,defines:{LIGHTING_FRAGMENT:1},getUniforms:Fh};const Uh={name:"pbr",vs:"uniform mat4 u_MVPMatrix;\nuniform mat4 u_ModelMatrix;\nuniform mat4 u_NormalMatrix;\n\nvarying vec3 pbr_vPosition;\nvarying vec2 pbr_vUV;\n\n#ifdef HAS_NORMALS\n# ifdef HAS_TANGENTS\nvarying mat3 pbr_vTBN;\n# else\nvarying vec3 pbr_vNormal;\n# endif\n#endif\n\nvoid pbr_setPositionNormalTangentUV(vec4 position, vec4 normal, vec4 tangent, vec2 uv)\n{\n  vec4 pos = u_ModelMatrix * position;\n  pbr_vPosition = vec3(pos.xyz) / pos.w;\n\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\n  vec3 normalW = normalize(vec3(u_NormalMatrix * vec4(normal.xyz, 0.0)));\n  vec3 tangentW = normalize(vec3(u_ModelMatrix * vec4(tangent.xyz, 0.0)));\n  vec3 bitangentW = cross(normalW, tangentW) * tangent.w;\n  pbr_vTBN = mat3(tangentW, bitangentW, normalW);\n#else\n  pbr_vNormal = normalize(vec3(u_ModelMatrix * vec4(normal.xyz, 0.0)));\n#endif\n#endif\n\n#ifdef HAS_UV\n  pbr_vUV = uv;\n#else\n  pbr_vUV = vec2(0.,0.);\n#endif\n}\n",fs:"#if defined(USE_TEX_LOD) && !defined(FEATURE_GLSL_TEXTURE_LOD)\n# error PBR fragment shader: Texture LOD is not available\n#endif\n\n#if !defined(HAS_TANGENTS) && !defined(FEATURE_GLSL_DERIVATIVES)\n# error PBR fragment shader: Derivatives are not available\n#endif\n\n\n#if (__VERSION__ < 300)\n  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL1COND; INCR)\n#else\n  #define SMART_FOR(INIT, WEBGL1COND, WEBGL2COND, INCR) for (INIT; WEBGL2COND; INCR)\n#endif\n\nprecision highp float;\n\nuniform bool pbr_uUnlit;\n\n#ifdef USE_IBL\nuniform samplerCube u_DiffuseEnvSampler;\nuniform samplerCube u_SpecularEnvSampler;\nuniform sampler2D u_brdfLUT;\nuniform vec2 u_ScaleIBLAmbient;\n#endif\n\n#ifdef HAS_BASECOLORMAP\nuniform sampler2D u_BaseColorSampler;\n#endif\n#ifdef HAS_NORMALMAP\nuniform sampler2D u_NormalSampler;\nuniform float u_NormalScale;\n#endif\n#ifdef HAS_EMISSIVEMAP\nuniform sampler2D u_EmissiveSampler;\nuniform vec3 u_EmissiveFactor;\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nuniform sampler2D u_MetallicRoughnessSampler;\n#endif\n#ifdef HAS_OCCLUSIONMAP\nuniform sampler2D u_OcclusionSampler;\nuniform float u_OcclusionStrength;\n#endif\n\n#ifdef ALPHA_CUTOFF\nuniform float u_AlphaCutoff;\n#endif\n\nuniform vec2 u_MetallicRoughnessValues;\nuniform vec4 u_BaseColorFactor;\n\nuniform vec3 u_Camera;\n#ifdef PBR_DEBUG\nuniform vec4 u_ScaleDiffBaseMR;\nuniform vec4 u_ScaleFGDSpec;\n#endif\n\nvarying vec3 pbr_vPosition;\n\nvarying vec2 pbr_vUV;\n\n#ifdef HAS_NORMALS\n#ifdef HAS_TANGENTS\nvarying mat3 pbr_vTBN;\n#else\nvarying vec3 pbr_vNormal;\n#endif\n#endif\n\n\nstruct PBRInfo\n{\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float LdotH;\n  float VdotH;\n  float perceptualRoughness;\n  float metalness;\n  vec3 reflectance0;\n  vec3 reflectance90;\n  float alphaRoughness;\n  vec3 diffuseColor;\n  vec3 specularColor;\n  vec3 n;\n  vec3 v;\n};\n\nconst float M_PI = 3.141592653589793;\nconst float c_MinRoughness = 0.04;\n\nvec4 SRGBtoLINEAR(vec4 srgbIn)\n{\n#ifdef MANUAL_SRGB\n#ifdef SRGB_FAST_APPROXIMATION\n  vec3 linOut = pow(srgbIn.xyz,vec3(2.2));\n#else\n  vec3 bLess = step(vec3(0.04045),srgbIn.xyz);\n  vec3 linOut = mix( srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)), bLess );\n#endif\n  return vec4(linOut,srgbIn.w);;\n#else\n  return srgbIn;\n#endif\n}\n\nvec3 getNormal()\n{\n#ifndef HAS_TANGENTS\n  vec3 pos_dx = dFdx(pbr_vPosition);\n  vec3 pos_dy = dFdy(pbr_vPosition);\n  vec3 tex_dx = dFdx(vec3(pbr_vUV, 0.0));\n  vec3 tex_dy = dFdy(vec3(pbr_vUV, 0.0));\n  vec3 t = (tex_dy.t * pos_dx - tex_dx.t * pos_dy) / (tex_dx.s * tex_dy.t - tex_dy.s * tex_dx.t);\n\n#ifdef HAS_NORMALS\n  vec3 ng = normalize(pbr_vNormal);\n#else\n  vec3 ng = cross(pos_dx, pos_dy);\n#endif\n\n  t = normalize(t - ng * dot(ng, t));\n  vec3 b = normalize(cross(ng, t));\n  mat3 tbn = mat3(t, b, ng);\n#else\n  mat3 tbn = pbr_vTBN;\n#endif\n\n#ifdef HAS_NORMALMAP\n  vec3 n = texture2D(u_NormalSampler, pbr_vUV).rgb;\n  n = normalize(tbn * ((2.0 * n - 1.0) * vec3(u_NormalScale, u_NormalScale, 1.0)));\n#else\n  vec3 n = normalize(tbn[2].xyz);\n#endif\n\n  return n;\n}\n\n\n#ifdef USE_IBL\nvec3 getIBLContribution(PBRInfo pbrInputs, vec3 n, vec3 reflection)\n{\n  float mipCount = 9.0;\n  float lod = (pbrInputs.perceptualRoughness * mipCount);\n  vec3 brdf = SRGBtoLINEAR(texture2D(u_brdfLUT,\n    vec2(pbrInputs.NdotV, 1.0 - pbrInputs.perceptualRoughness))).rgb;\n  vec3 diffuseLight = SRGBtoLINEAR(textureCube(u_DiffuseEnvSampler, n)).rgb;\n\n#ifdef USE_TEX_LOD\n  vec3 specularLight = SRGBtoLINEAR(textureCubeLod(u_SpecularEnvSampler, reflection, lod)).rgb;\n#else\n  vec3 specularLight = SRGBtoLINEAR(textureCube(u_SpecularEnvSampler, reflection)).rgb;\n#endif\n\n  vec3 diffuse = diffuseLight * pbrInputs.diffuseColor;\n  vec3 specular = specularLight * (pbrInputs.specularColor * brdf.x + brdf.y);\n  diffuse *= u_ScaleIBLAmbient.x;\n  specular *= u_ScaleIBLAmbient.y;\n\n  return diffuse + specular;\n}\n#endif\n\n\nvec3 diffuse(PBRInfo pbrInputs)\n{\n  return pbrInputs.diffuseColor / M_PI;\n}\n\nvec3 specularReflection(PBRInfo pbrInputs)\n{\n  return pbrInputs.reflectance0 +\n    (pbrInputs.reflectance90 - pbrInputs.reflectance0) *\n    pow(clamp(1.0 - pbrInputs.VdotH, 0.0, 1.0), 5.0);\n}\n\n\n\nfloat geometricOcclusion(PBRInfo pbrInputs)\n{\n  float NdotL = pbrInputs.NdotL;\n  float NdotV = pbrInputs.NdotV;\n  float r = pbrInputs.alphaRoughness;\n\n  float attenuationL = 2.0 * NdotL / (NdotL + sqrt(r * r + (1.0 - r * r) * (NdotL * NdotL)));\n  float attenuationV = 2.0 * NdotV / (NdotV + sqrt(r * r + (1.0 - r * r) * (NdotV * NdotV)));\n  return attenuationL * attenuationV;\n}\n\n\n\n\n\nfloat microfacetDistribution(PBRInfo pbrInputs)\n{\n  float roughnessSq = pbrInputs.alphaRoughness * pbrInputs.alphaRoughness;\n  float f = (pbrInputs.NdotH * roughnessSq - pbrInputs.NdotH) * pbrInputs.NdotH + 1.0;\n  return roughnessSq / (M_PI * f * f);\n}\n\nvoid PBRInfo_setAmbientLight(inout PBRInfo pbrInputs) {\n  pbrInputs.NdotL = 1.0;\n  pbrInputs.NdotH = 0.0;\n  pbrInputs.LdotH = 0.0;\n  pbrInputs.VdotH = 1.0;\n}\n\nvoid PBRInfo_setDirectionalLight(inout PBRInfo pbrInputs, vec3 lightDirection) {\n  vec3 n = pbrInputs.n;\n  vec3 v = pbrInputs.v;\n  vec3 l = normalize(lightDirection);\n  vec3 h = normalize(l+v);\n\n  pbrInputs.NdotL = clamp(dot(n, l), 0.001, 1.0);\n  pbrInputs.NdotH = clamp(dot(n, h), 0.0, 1.0);\n  pbrInputs.LdotH = clamp(dot(l, h), 0.0, 1.0);\n  pbrInputs.VdotH = clamp(dot(v, h), 0.0, 1.0);\n}\n\nvoid PBRInfo_setPointLight(inout PBRInfo pbrInputs, PointLight pointLight) {\n  vec3 light_direction = normalize(pointLight.position - pbr_vPosition);\n  PBRInfo_setDirectionalLight(pbrInputs, light_direction);\n}\n\nvec3 calculateFinalColor(PBRInfo pbrInputs, vec3 lightColor) {\n  vec3 F = specularReflection(pbrInputs);\n  float G = geometricOcclusion(pbrInputs);\n  float D = microfacetDistribution(pbrInputs);\n  vec3 diffuseContrib = (1.0 - F) * diffuse(pbrInputs);\n  vec3 specContrib = F * G * D / (4.0 * pbrInputs.NdotL * pbrInputs.NdotV);\n  return pbrInputs.NdotL * lightColor * (diffuseContrib + specContrib);\n}\n\nvec4 pbr_filterColor(vec4 colorUnused)\n{\n#ifdef HAS_BASECOLORMAP\n  vec4 baseColor = SRGBtoLINEAR(texture2D(u_BaseColorSampler, pbr_vUV)) * u_BaseColorFactor;\n#else\n  vec4 baseColor = u_BaseColorFactor;\n#endif\n\n#ifdef ALPHA_CUTOFF\n  if (baseColor.a < u_AlphaCutoff) {\n    discard;\n  }\n#endif\n\n  vec3 color = vec3(0, 0, 0);\n\n  if(pbr_uUnlit){\n    color.rgb = baseColor.rgb;\n  }\n  else{\n\n\n    float perceptualRoughness = u_MetallicRoughnessValues.y;\n    float metallic = u_MetallicRoughnessValues.x;\n#ifdef HAS_METALROUGHNESSMAP\n\n    vec4 mrSample = texture2D(u_MetallicRoughnessSampler, pbr_vUV);\n    perceptualRoughness = mrSample.g * perceptualRoughness;\n    metallic = mrSample.b * metallic;\n#endif\n    perceptualRoughness = clamp(perceptualRoughness, c_MinRoughness, 1.0);\n    metallic = clamp(metallic, 0.0, 1.0);\n\n    float alphaRoughness = perceptualRoughness * perceptualRoughness;\n\n    vec3 f0 = vec3(0.04);\n    vec3 diffuseColor = baseColor.rgb * (vec3(1.0) - f0);\n    diffuseColor *= 1.0 - metallic;\n    vec3 specularColor = mix(f0, baseColor.rgb, metallic);\n    float reflectance = max(max(specularColor.r, specularColor.g), specularColor.b);\n\n\n\n    float reflectance90 = clamp(reflectance * 25.0, 0.0, 1.0);\n    vec3 specularEnvironmentR0 = specularColor.rgb;\n    vec3 specularEnvironmentR90 = vec3(1.0, 1.0, 1.0) * reflectance90;\n\n    vec3 n = getNormal();\n    vec3 v = normalize(u_Camera - pbr_vPosition);\n\n    float NdotV = clamp(abs(dot(n, v)), 0.001, 1.0);\n    vec3 reflection = -normalize(reflect(v, n));\n\n    PBRInfo pbrInputs = PBRInfo(\n      0.0,\n      NdotV,\n      0.0,\n      0.0,\n      0.0,\n      perceptualRoughness,\n      metallic,\n      specularEnvironmentR0,\n      specularEnvironmentR90,\n      alphaRoughness,\n      diffuseColor,\n      specularColor,\n      n,\n      v\n    );\n\n#ifdef USE_LIGHTS\n    PBRInfo_setAmbientLight(pbrInputs);\n    color += calculateFinalColor(pbrInputs, lighting_uAmbientLight.color);\n    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uDirectionalLightCount, i++) {\n      if (i < lighting_uDirectionalLightCount) {\n        PBRInfo_setDirectionalLight(pbrInputs, lighting_uDirectionalLight[i].direction);\n        color += calculateFinalColor(pbrInputs, lighting_uDirectionalLight[i].color);\n      }\n    }\n    SMART_FOR(int i = 0, i < MAX_LIGHTS, i < lighting_uPointLightCount, i++) {\n      if (i < lighting_uPointLightCount) {\n        PBRInfo_setPointLight(pbrInputs, lighting_uPointLight[i]);\n        float attenuation = getPointLightAttenuation(lighting_uPointLight[i], distance(lighting_uPointLight[i].position, pbr_vPosition));\n        color += calculateFinalColor(pbrInputs, lighting_uPointLight[i].color / attenuation);\n      }\n    }\n#endif\n#ifdef USE_IBL\n    color += getIBLContribution(pbrInputs, n, reflection);\n#endif\n#ifdef HAS_OCCLUSIONMAP\n    float ao = texture2D(u_OcclusionSampler, pbr_vUV).r;\n    color = mix(color, color * ao, u_OcclusionStrength);\n#endif\n\n#ifdef HAS_EMISSIVEMAP\n    vec3 emissive = SRGBtoLINEAR(texture2D(u_EmissiveSampler, pbr_vUV)).rgb * u_EmissiveFactor;\n    color += emissive;\n#endif\n\n#ifdef PBR_DEBUG\n\n\n\n\n\n    color = mix(color, baseColor.rgb, u_ScaleDiffBaseMR.y);\n    color = mix(color, vec3(metallic), u_ScaleDiffBaseMR.z);\n    color = mix(color, vec3(perceptualRoughness), u_ScaleDiffBaseMR.w);\n#endif\n\n  }\n\n  return vec4(pow(color,vec3(1.0/2.2)), baseColor.a);\n}\n",defines:{LIGHTING_FRAGMENT:1},dependencies:[Rh]},Gh={name:"transform",vs:"attribute float transform_elementID;\nvec2 transform_getPixelSizeHalf(vec2 size) {\n  return vec2(1.) / (2. * size);\n}\n\nvec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {\n  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);\n  float xIndex = transform_elementID - (yIndex * texSize[0]);\n  return vec2(xIndex, yIndex);\n}\nvec2 transform_getTexCoord(vec2 size) {\n  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);\n  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);\n  vec2 coord = indices / size + pixelSizeHalf;\n  return coord;\n}\nvec2 transform_getPos(vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);\n  return pos;\n}\nvec4 transform_getInput(sampler2D texSampler, vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec4 textureColor = texture2D(texSampler, texCoord);\n  return textureColor;\n}\n",fs:null};class Vh{static getDefaultProgramManager(t){return t.luma=t.luma||{},t.luma.defaultProgramManager=t.luma.defaultProgramManager||new Vh(t),t.luma.defaultProgramManager}constructor(t){this.gl=t,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(t){this._defaultModules.find((e=>e.name===t.name))||this._defaultModules.push(t),this.stateHash++}removeDefaultModule(t){const e="string"==typeof t?t:t.name;this._defaultModules=this._defaultModules.filter((t=>t.name!==e)),this.stateHash++}addShaderHook(t,e){e&&(t=Object.assign(e,{hook:t})),this._hookFunctions.push(t),this.stateHash++}get(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{vs:e="",fs:i="",defines:n={},inject:r={},varyings:s=[],bufferMode:o=35981,transpileToGLSL100:a=!1}=t,l=this._getModuleList(t.modules),c=this._getHash(e),h=this._getHash(i),u=l.map((t=>this._getHash(t.name))).sort(),d=s.map((t=>this._getHash(t))),p=Object.keys(n).sort(),f=Object.keys(r).sort(),m=[],g=[];for(const t of p)m.push(this._getHash(t)),m.push(this._getHash(n[t]));for(const t of f)g.push(this._getHash(t)),g.push(this._getHash(r[t]));const _="".concat(c,"/").concat(h,"D").concat(m.join("/"),"M").concat(u.join("/"),"I").concat(g.join("/"),"V").concat(d.join("/"),"H").concat(this.stateHash,"B").concat(o).concat(a?"T":"");if(!this._programCache[_]){const t=function(t,e){const{vs:i,fs:n}=e,r=rl(e.modules||[]);return{gl:t,vs:Ul(t,Object.assign({},e,{source:i,type:$a,modules:r})),fs:Ul(t,Object.assign({},e,{source:n,type:Ka,modules:r})),getUniforms:Gl(r)}}(this.gl,{vs:e,fs:i,modules:l,inject:r,defines:n,hookFunctions:this._hookFunctions,transpileToGLSL100:a});this._programCache[_]=new Ba(this.gl,{hash:_,vs:t.vs,fs:t.fs,varyings:s,bufferMode:o}),this._getUniforms[_]=t.getUniforms||(t=>{}),this._useCounts[_]=0}return this._useCounts[_]++,this._programCache[_]}getUniforms(t){return this._getUniforms[t.hash]||null}release(t){const e=t.hash;this._useCounts[e]--,0===this._useCounts[e]&&(this._programCache[e].delete(),delete this._programCache[e],delete this._getUniforms[e],delete this._useCounts[e])}_getHash(t){return void 0===this._hashes[t]&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}_getModuleList(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const e=new Array(this._defaultModules.length+t.length),i={};let n=0;for(let t=0,r=this._defaultModules.length;t<r;++t){const r=this._defaultModules[t],s=r.name;e[n++]=r,i[s]=!0}for(let r=0,s=t.length;r<s;++r){const s=t[r],o=s.name;i[o]||(e[n++]=s,i[o]=!0)}return e.length=n,e}}const jh={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function Hh(t,e){const{attributeMap:i=jh}=e||{};return i&&i[t]||t}function Wh(t,e){let i;switch(t){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":i="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":i="vectors"}switch(i){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2}Xs(Number.isFinite(e.size),"attribute ".concat(t," needs size"))}const qh=()=>{},Xh={};class Zh{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{id:i=$s("model")}=e;Xs(Jr(t)),this.id=i,this.gl=t,this.id=e.id||$s("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(e)}initialize(t){this.props={},this.programManager=t.programManager||Vh.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:e=null,vs:i,fs:n,modules:r,defines:s,inject:o,varyings:a,bufferMode:l,transpileToGLSL100:c}=t;this.programProps={program:e,vs:i,fs:n,modules:r,defines:s,inject:o,varyings:a,bufferMode:l,transpileToGLSL100:c},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(t.moduleSettings))),this.drawMode=void 0!==t.drawMode?t.drawMode:4,this.vertexCount=t.vertexCount||0,this.geometryBuffers={},this.isInstanced=t.isInstanced||t.instanced||t.instanceCount>0,this._setModelProps(t),this.geometry={},Xs(void 0!==this.drawMode&&Number.isFinite(this.vertexCount),"Model needs drawMode and vertexCount")}setProps(t){this._setModelProps(t)}delete(){for(const t in this._attributes)this._attributes[t]!==this.attributes[t]&&this._attributes[t].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(t){const{program:e,vs:i,fs:n,modules:r,defines:s,inject:o,varyings:a,bufferMode:l,transpileToGLSL100:c}=t;this.programProps={program:e,vs:i,fs:n,modules:r,defines:s,inject:o,varyings:a,bufferMode:l,transpileToGLSL100:c},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(t){return this.drawMode=t,this}setVertexCount(t){return Xs(Number.isFinite(t)),this.vertexCount=t,this}setInstanceCount(t){return Xs(Number.isFinite(t)),this.instanceCount=t,this}setGeometry(t){return this.drawMode=t.drawMode,this.vertexCount=t.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=function(t,e,i){const n={};let r=e.indices;for(const s in e.attributes){const o=e.attributes[s],a=Hh(s,i);if("indices"===s)r=o;else if(o.constant)n[a]=o.value;else{const e=o.value,i={...o};delete i.value,n[a]=[new mo(t,e),i],Wh(s,i)}}if(r){const e=r.value||r;Xs(e instanceof Uint16Array||e instanceof Uint32Array,'attribute array for "indices" must be of integer type');const i={size:1,isIndexed:void 0===r.isIndexed||r.isIndexed};n.indices=[new mo(t,{data:e,target:34963}),i]}return n}(this.gl,t),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(Qs(t))return this;const e={};for(const i in t){const n=t[i];e[i]=n.getValue?n.getValue():n}return this.vertexArray.setAttributes(e),this}setUniforms(){return Object.assign(this.uniforms,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),this}getModuleUniforms(t){this._checkProgram();const e=this.programManager.getUniforms(this.program);return e?e(t):{}}updateModuleSettings(t){const e=this.getModuleUniforms(t||{});return this.setUniforms(e)}clear(t){return Lo(this.program.gl,t),this}draw(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._checkProgram();const{moduleSettings:e=null,framebuffer:i,uniforms:n={},attributes:r={},transformFeedback:s=this.transformFeedback,parameters:o={},vertexArray:a=this.vertexArray}=t;let l;this.setAttributes(r),this.updateModuleSettings(e),this.setUniforms(n),qr.priority>=2&&(l=this._logDrawCallStart(2));const c=this.vertexArray.getDrawParams(),{isIndexed:h=c.isIndexed,indexType:u=c.indexType,indexOffset:d=c.indexOffset,vertexArrayInstanced:p=c.isInstanced}=this.props;p&&!this.isInstanced&&qr.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:f,instanceCount:m}=this,{onBeforeRender:g=qh,onAfterRender:_=qh}=this.props;g(),this.program.setUniforms(this.uniforms);const y=this.program.draw(Object.assign(Xh,t,{logPriority:l,uniforms:null,framebuffer:i,parameters:o,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:a,transformFeedback:s,isIndexed:h,indexType:u,isInstanced:f,instanceCount:m,offset:h?d:0}));return _(),qr.priority>=2&&this._logDrawCallEnd(l,a,i),y}transform(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{discard:e=!0,feedbackBuffers:i,unbindModels:n=[]}=t;let{parameters:r}=t;i&&this._setFeedbackBuffers(i),e&&(r=Object.assign({},r,{35977:e})),n.forEach((t=>t.vertexArray.unbindBuffers()));try{this.draw(Object.assign({},t,{parameters:r}))}finally{n.forEach((t=>t.vertexArray.bindBuffers()))}return this}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return qr.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(t).draw()}_setModelProps(t){Object.assign(this.props,t),"uniforms"in t&&this.setUniforms(t.uniforms),"pickable"in t&&(this.pickable=t.pickable),"instanceCount"in t&&(this.instanceCount=t.instanceCount),"geometry"in t&&this.setGeometry(t.geometry),"attributes"in t&&this.setAttributes(t.attributes),"_feedbackBuffers"in t&&this._setFeedbackBuffers(t._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{const{vs:e,fs:i,modules:n,inject:r,defines:s,varyings:o,bufferMode:a,transpileToGLSL100:l}=this.programProps;t=this.programManager.get({vs:e,fs:i,modules:n,inject:r,defines:s,varyings:o,bufferMode:a,transpileToGLSL100:l}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}Xs(t instanceof Ba,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new Ga(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const t in this.geometryBuffers){const e=this.geometryBuffers[t][0]||this.geometryBuffers[t];e instanceof mo&&e.delete()}}_setAnimationProps(t){this.animated&&Xs(t,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(Qs(t))return this;const{gl:e}=this.program;return this.transformFeedback=this.transformFeedback||new Oa(e,{program:this.program}),this.transformFeedback.setBuffers(t),this}_logDrawCallStart(t){const e=t>3?0:1e4;if(!(Date.now()-this.lastLogTime<e))return this.lastLogTime=Date.now(),qr.group(2,">>> DRAWING MODEL ".concat(this.id),{collapsed:qr.level<=2})(),t}_logDrawCallEnd(t,e,i,n){if(void 0===t)return;const r=function(t){let{vertexArray:e,header:i="Attributes"}=t;if(!e.configuration)return{};const n={};e.elements&&(n.ELEMENT_ARRAY_BUFFER=Wa(e,e.elements,null,i));const r=e.values;for(const t in r){const s=e._getAttributeInfo(t);if(s){let o="".concat(t,": ").concat(s.name);const a=e.accessors[s.location];a&&(o="".concat(t,": ").concat(qa(s.name,a))),n[o]=Wa(e,r[t],a,i)}}return n}({vertexArray:e,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:s,unusedTable:o,unusedCount:a}=ja({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i)}),{table:l,count:c}=ja({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,i),undefinedOnly:!0});c>0&&qr.log("MISSING UNIFORMS",Object.keys(l))(),a>0&&qr.log("UNUSED UNIFORMS",Object.keys(o))();const h=function(t){const e={},i="Accessors for ".concat(t.id);for(const n of t.attributeInfos)if(n){const t=Xa(n);e["in ".concat(t)]={[i]:JSON.stringify(n.accessor)}}for(const n of t.varyingInfos)if(n){const t=Xa(n);e["out ".concat(t)]={[i]:JSON.stringify(n.accessor)}}return e}(this.vertexArray.configuration);qr.table(t,r)(),qr.table(t,s)(),qr.table(t+1,h)(),n&&n.log({logLevel:2,message:"Rendered to ".concat(n.id)}),qr.groupEnd(2)()}}class Jh{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}setupResources(t){for(const e of this.bindings)this._setupTransformFeedback(e,t)}updateModelProps(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyings:e}=this;return e.length>0&&(t=Object.assign({},t,{varyings:e})),t}getDrawOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this.bindings[this.currentIndex],{sourceBuffers:i,transformFeedback:n}=e;return{attributes:Object.assign({},i,t.attributes),transformFeedback:n}}swap(){return!!this.feedbackMap&&(this.currentIndex=this._getNextIndex(),!0)}update(){this._setupBuffers(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}getBuffer(t){const{feedbackBuffers:e}=this.bindings[this.currentIndex],i=t?e[t]:null;return i?i instanceof mo?i:i.buffer:null}getData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyingName:e}=t,i=this.getBuffer(e);return i?i.getData():null}delete(){for(const t in this.resources)this.resources[t].delete()}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setupBuffers(t),this.varyings=t.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&Xs(Yr(this.gl))}_getFeedbackBuffers(t){const{sourceBuffers:e={}}=t,i={};if(this.bindings[this.currentIndex]&&Object.assign(i,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const t in this.feedbackMap){t in e&&(i[this.feedbackMap[t]]=t)}Object.assign(i,t.feedbackBuffers);for(const t in i){const n=i[t];if("string"==typeof n){const r=e[n],{byteLength:s,usage:o,accessor:a}=r;i[t]=this._createNewBuffer(t,{byteLength:s,usage:o,accessor:a})}}return i}_setupBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e=null}=t;Object.assign(this.feedbackMap,t.feedbackMap);const i=this._getFeedbackBuffers(t);this._updateBindings({sourceBuffers:e,feedbackBuffers:i})}_setupTransformFeedback(t,e){let{model:i}=e;const{program:n}=i;t.transformFeedback=new Oa(this.gl,{program:n,buffers:t.feedbackBuffers})}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this.feedbackMap){const{sourceBuffers:t,feedbackBuffers:e}=this._swapBuffers(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceBuffers:t,feedbackBuffers:e})}}_updateBinding(t,e){return t?(Object.assign(t.sourceBuffers,e.sourceBuffers),Object.assign(t.feedbackBuffers,e.feedbackBuffers),t.transformFeedback&&t.transformFeedback.setBuffers(t.feedbackBuffers),t):{sourceBuffers:Object.assign({},e.sourceBuffers),feedbackBuffers:Object.assign({},e.feedbackBuffers)}}_swapBuffers(t){if(!this.feedbackMap)return null;const e=Object.assign({},t.sourceBuffers),i=Object.assign({},t.feedbackBuffers);for(const n in this.feedbackMap){const r=this.feedbackMap[n];e[n]=t.feedbackBuffers[r],i[r]=t.sourceBuffers[n],Xs(i[r]instanceof mo)}return{sourceBuffers:e,feedbackBuffers:i}}_createNewBuffer(t,e){const i=new mo(this.gl,e);return this.resources[t]&&this.resources[t].delete(),this.resources[t]=i,i}_getNextIndex(){return(this.currentIndex+1)%2}}const Yh="transform_uSampler_",$h="transform_uSize_",Kh="transform_position";function Qh(t){let{vs:e,sourceTextureMap:i,targetTextureVarying:n,targetTexture:r}=t;let s=Object.keys(i).length,o=null;const a={};let l=e,c={};if(s>0||n){const t=l.split("\n"),e=t.slice();if(t.forEach(((t,r,l)=>{if(s>0){const n=function(t,e){const i={},n=function(t){return Hl(t,["attribute","in"])}(t);if(!n)return null;const{type:r,name:s}=n;if(s&&e[s]){const e="// ".concat(t," => Replaced by Transform with a sampler"),{samplerName:n,sizeName:o,uniformDeclerations:a}=function(t){const e="".concat(Yh).concat(t),i="".concat($h).concat(t),n="  uniform sampler2D ".concat(e,";\n  uniform vec2 ").concat(i,";");return{samplerName:e,sizeName:i,uniformDeclerations:n}}(s),l=function(t){switch(t){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Qa(!1),null}}(r),c="  ".concat(r," ").concat(s," = transform_getInput(").concat(n,", ").concat(o,").").concat(l,";\n");i[n]=s;return{updatedLine:e,inject:{"vs:#decl":a,"vs:#main-start":c},samplerTextureMap:i}}return null}(t,i);if(n){const{updatedLine:t,inject:i}=n;e[r]=t,c=Tl([c,i]),Object.assign(a,n.samplerTextureMap),s--}}n&&!o&&(o=function(t,e){const i=Hl(t,["varying","out"]);if(!i)return null;return i.name===e?i.type:null}(t,n))})),n){Xs(r);const t="".concat($h).concat(n),e="uniform vec2 ".concat(t,";\n"),i="     vec2 ".concat(Kh," = transform_getPos(").concat(t,");\n     gl_Position = vec4(").concat(Kh,", 0, 1.);\n");c=Tl([c,{"vs:#decl":e,"vs:#main-start":i}])}l=e.join("\n")}return{vs:l,targetTextureType:o,inject:c,samplerTextureMap:a}}const tu={10241:9728,10240:9728,10242:33071,10243:33071};class eu{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}updateModelProps(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._processVertexShader(t);return Object.assign({},t,e)}getDrawOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e,sourceTextures:i,framebuffer:n,targetTexture:r}=this.bindings[this.currentIndex],s=Object.assign({},e,t.attributes),o=Object.assign({},t.uniforms),a=Object.assign({},t.parameters);let l=t.discard;if(this.hasSourceTextures||this.hasTargetTexture){s.transform_elementID=this.elementIDBuffer;for(const t in this.samplerTextureMap){o[t]=i[this.samplerTextureMap[t]]}this._setSourceTextureParameters();const t=function(t){let{sourceTextureMap:e,targetTextureVarying:i,targetTexture:n}=t;const r={};let s,o;i&&(({width:s,height:o}=n),r["".concat($h).concat(i)]=[s,o]);for(const t in e)({width:s,height:o}=e[t]),r["".concat($h).concat(t)]=[s,o];return r}({sourceTextureMap:i,targetTextureVarying:this.targetTextureVarying,targetTexture:r});Object.assign(o,t)}return this.hasTargetTexture&&(l=!1,a.viewport=[0,0,n.width,n.height]),{attributes:s,framebuffer:n,uniforms:o,discard:l,parameters:a}}swap(){return!!this._swapTexture&&(this.currentIndex=this._getNextIndex(),!0)}update(){this._setupTextures(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}getTargetTexture(){const{targetTexture:t}=this.bindings[this.currentIndex];return t}getData(){let{packed:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{framebuffer:e}=this.bindings[this.currentIndex],i=Ro(e);if(!t)return i;const n=i.constructor,r=function(t){switch(t){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Qa(!1),null}}(this.targetTextureType),s=new n(i.length*r/4);let o=0;for(let t=0;t<i.length;t+=4)for(let e=0;e<r;e++)s[o++]=i[t+e];return s}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{_targetTextureVarying:e,_swapTexture:i}=t;this._swapTexture=i,this.targetTextureVarying=e,this.hasTargetTexture=e,this._setupTextures(t)}_createTargetTexture(t){const{sourceTextures:e,textureOrReference:i}=t;if(i instanceof wo)return i;const n=e[i];return n?(this._targetRefTexName=i,this._createNewTexture(n)):null}_setupTextures(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e,_sourceTextures:i={},_targetTexture:n}=t,r=this._createTargetTexture({sourceTextures:i,textureOrReference:n});this.hasSourceTextures=this.hasSourceTextures||i&&Object.keys(i).length>0,this._updateBindings({sourceBuffers:e,sourceTextures:i,targetTexture:r}),"elementCount"in t&&this._updateElementIDBuffer(t.elementCount)}_updateElementIDBuffer(t){if("number"!=typeof t||this.elementCount>=t)return;const e=new Float32Array(t);e.forEach(((t,e,i)=>{i[e]=e})),this.elementIDBuffer?this.elementIDBuffer.setData({data:e}):this.elementIDBuffer=new mo(this.gl,{data:e,accessor:{size:1}}),this.elementCount=t}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this._swapTexture){const{sourceTextures:t,targetTexture:e}=this._swapTextures(this.bindings[this.currentIndex]),i=this._getNextIndex();this.bindings[i]=this._updateBinding(this.bindings[i],{sourceTextures:t,targetTexture:e})}}_updateBinding(t,e){const{sourceBuffers:i,sourceTextures:n,targetTexture:r}=e;if(t||(t={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(t.sourceTextures,n),Object.assign(t.sourceBuffers,i),r){t.targetTexture=r;const{width:e,height:i}=r,{framebuffer:n}=t;n?(n.update({attachments:{36064:r},resizeAttachments:!1}),n.resize({width:e,height:i})):t.framebuffer=new Wo(this.gl,{id:"transform-framebuffer",width:e,height:i,attachments:{36064:r}})}return t}_setSourceTextureParameters(){const t=this.currentIndex,{sourceTextures:e}=this.bindings[t];for(const t in e)e[t].setParameters(tu)}_swapTextures(t){if(!this._swapTexture)return null;const e=Object.assign({},t.sourceTextures);e[this._swapTexture]=t.targetTexture;return{sourceTextures:e,targetTexture:t.sourceTextures[this._swapTexture]}}_createNewTexture(t){const e=function(t,e){Xs(t instanceof wo||t instanceof To||t instanceof Mo);const i=t.constructor,{gl:n,width:r,height:s,format:o,type:a,dataFormat:l,border:c,mipmaps:h}=t;return new i(n,Object.assign({width:r,height:s,format:o,type:a,dataFormat:l,border:c,mipmaps:h},e))}(t,{parameters:{10241:9728,10240:9728,10242:33071,10243:33071},pixelStore:{37440:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=e,e}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceTextures:e,targetTexture:i}=this.bindings[this.currentIndex],{vs:n,uniforms:r,targetTextureType:s,inject:o,samplerTextureMap:a}=Qh({vs:t.vs,sourceTextureMap:e,targetTextureVarying:this.targetTextureVarying,targetTexture:i}),l=Tl([t.inject||{},o]);this.targetTextureType=s,this.samplerTextureMap=a;return{vs:n,fs:t._fs||Wl({version:Qo(n),input:this.targetTextureVarying,inputType:s,output:"transform_output"}),modules:this.hasSourceTextures||this.targetTextureVarying?[Gh].concat(t.modules||[]):t.modules,uniforms:r,inject:l}}}class iu{static isSupported(t){return Yr(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(e),Object.seal(this)}delete(){const{model:t,bufferTransform:e,textureTransform:i}=this;t&&t.delete(),e&&e.delete(),i&&i.delete()}run(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{clearRenderTarget:e=!0}=t,i=this._updateDrawOptions(t);e&&i.framebuffer&&i.framebuffer.clear({color:!0}),this.model.transform(i)}swap(){let t=!1;const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e)t=t||i.swap();Xs(t,"Nothing to swap")}getBuffer(){return this.bufferTransform&&this.bufferTransform.getBuffer(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)}getData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e){const e=i.getData(t);if(e)return e}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"elementCount"in t&&this.model.setVertexCount(t.elementCount);const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const i of e)i.update(t)}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{gl:e}=this;this._buildResourceTransforms(e,t),t=this._updateModelProps(t),this.model=new Zh(e,Object.assign({},t,{fs:t.fs||Wl({version:Qo(t.vs)}),id:t.id||"transform-model",drawMode:t.drawMode||0,vertexCount:t.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(t){let e=Object.assign({},t);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const t of i)e=t.updateModelProps(e);return e}_buildResourceTransforms(t,e){(function(t){if(!Qs(t.feedbackBuffers)||!Qs(t.feedbackMap)||t.varyings&&t.varyings.length>0)return!0;return!1})(e)&&(this.bufferTransform=new Jh(t,e)),function(t){if(!Qs(t._sourceTextures)||t._targetTexture||t._targetTextureVarying)return!0;return!1}(e)&&(this.textureTransform=new eu(t,e)),Xs(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(t){let e=Object.assign({},t);const i=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const t of i)e=Object.assign(e,t.getDrawOptions(e));return e}}const nu={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class ru{static get DRAW_MODE(){return nu}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:e=$s("geometry"),drawMode:i=nu.TRIANGLES,attributes:n={},indices:r=null,vertexCount:s=null}=t;this.id=e,this.drawMode=0|i,this.attributes={},this.userData={},this._setAttributes(n,r),this.vertexCount=s||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(t){return"Geometry ".concat(this.id," attribute ").concat(t)}_setAttributes(t,e){e&&(this.indices=ArrayBuffer.isView(e)?{value:e,size:1}:e);for(const e in t){let i=t[e];i=ArrayBuffer.isView(i)?{value:i}:i,Xs(ArrayBuffer.isView(i.value),"".concat(this._print(e),": must be typed array or object with value as typed array")),"POSITION"!==e&&"positions"!==e||i.size||(i.size=3),"indices"===e?(Xs(!this.indices),this.indices=i):this.attributes[e]=i}return this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(t,e){if(e)return e.value.length;let i=1/0;for(const e in t){const n=t[e],{value:r,size:s,constant:o}=n;!o&&r&&s>=1&&(i=Math.min(i,r.length/s))}return Xs(Number.isFinite(i)),i}}let su=1,ou=1;class au{constructor(){this.time=0,this.channels=new Map,this.animations=new Map,this.playing=!1,this.lastEngineTime=-1}addChannel(t){const{delay:e=0,duration:i=Number.POSITIVE_INFINITY,rate:n=1,repeat:r=1}=t,s=su++,o={time:0,delay:e,duration:i,rate:n,repeat:r};return this._setChannelTime(o,this.time),this.channels.set(s,o),s}removeChannel(t){this.channels.delete(t);for(const[e,i]of this.animations)i.channel===t&&this.detachAnimation(e)}isFinished(t){const e=this.channels.get(t);return void 0!==e&&this.time>=e.delay+e.duration*e.repeat}getTime(t){if(void 0===t)return this.time;const e=this.channels.get(t);return void 0===e?-1:e.time}setTime(t){this.time=Math.max(0,t);const e=this.channels.values();for(const t of e)this._setChannelTime(t,this.time);const i=this.animations.values();for(const t of i){const{animation:e,channel:i}=t;e.setTime(this.getTime(i))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(t,e){const i=ou++;return this.animations.set(i,{animation:t,channel:e}),t.setTime(this.getTime(e)),i}detachAnimation(t){this.animations.delete(t)}update(t){this.playing&&(-1===this.lastEngineTime&&(this.lastEngineTime=t),this.setTime(this.time+(t-this.lastEngineTime)),this.lastEngineTime=t)}_setChannelTime(t,e){const i=e-t.delay;i>=t.duration*t.repeat?t.time=t.duration*t.rate:(t.time=Math.max(0,i)%t.duration,t.time*=t.rate)}}const lu=[255,255,255],cu=1;let hu=0,uu=class{constructor(t={}){He(this,"id",void 0),He(this,"color",void 0),He(this,"intensity",void 0),He(this,"type","ambient");const{color:e=lu}=t,{intensity:i=cu}=t;this.id=t.id||"ambient-".concat(hu++),this.color=e,this.intensity=i}};const du=[255,255,255],pu=1,fu=[0,0,-1];let mu=0,gu=class{constructor(t={}){He(this,"id",void 0),He(this,"color",void 0),He(this,"intensity",void 0),He(this,"type","directional"),He(this,"direction",void 0),He(this,"shadow",void 0);const{color:e=du}=t,{intensity:i=pu}=t,{direction:n=fu}=t,{_shadow:r=!1}=t;this.id=t.id||"directional-".concat(mu++),this.color=e,this.intensity=i,this.type="directional",this.direction=new Dc(n).normalize().toArray(),this.shadow=r}getProjectedLight(t){return this}};class _u{constructor(t,e={id:"pass"}){He(this,"id",void 0),He(this,"gl",void 0),He(this,"props",void 0);const{id:i}=e;this.id=i,this.gl=t,this.props={...e}}setProps(t){Object.assign(this.props,t)}render(t){}cleanup(){}}class yu extends _u{constructor(...t){super(...t),He(this,"_lastRenderIndex",-1)}render(t){return Ps(this.gl,{framebuffer:t.target}),this._drawLayers(t)}_drawLayers(t){const{target:e,moduleParameters:i,viewports:n,views:r,onViewportActive:s,clearStack:o=!0,clearCanvas:a=!0}=t;t.pass=t.pass||"unknown";const l=this.gl;a&&function(t,e){const i=e?e.width:t.drawingBufferWidth,n=e?e.height:t.drawingBufferHeight;Ps(t,{viewport:[0,0,i,n]}),t.clear(16640)}(l,e),o&&(this._lastRenderIndex=-1);const c=[];for(const o of n){const n=r&&r[o.id];null==s||s(o);const a=this._getDrawLayerParams(o,t),h=o.subViewports||[o];for(const r of h){const s=this._drawLayersInViewport(l,{target:e,moduleParameters:i,viewport:r,view:n,pass:t.pass,layers:t.layers},a);c.push(s)}}return c}_getDrawLayerParams(t,{layers:e,pass:i,isPicking:n=!1,layerFilter:r,cullRect:s,effects:o,moduleParameters:a},l=!1){const c=[],h=vu(this._lastRenderIndex+1),u={layer:e[0],viewport:t,isPicking:n,renderPass:i,cullRect:s},d={};for(let n=0;n<e.length;n++){const s=e[n],p=this._shouldDrawLayer(s,u,r,d),f={shouldDrawLayer:p};p&&!l&&(f.layerRenderIndex=h(s,p),f.moduleParameters=this._getModuleParameters(s,o,i,a),f.layerParameters=this.getLayerParameters(s,n,t)),c[n]=f}return c}_drawLayersInViewport(t,{layers:e,moduleParameters:i,pass:n,target:r,viewport:s,view:o},a){const l=function(t,{moduleParameters:e,target:i,viewport:n}){const r=i&&"default-framebuffer"!==i.id,s=e&&e.devicePixelRatio||Rs(t),o=r?i.height:t.drawingBufferHeight,a=n;return[a.x*s,o-(a.y+a.height)*s,a.width*s,a.height*s]}(t,{moduleParameters:i,target:r,viewport:s});if(o&&o.props.clear){const e=!0===o.props.clear?{color:!0,depth:!0}:o.props.clear;Ls(t,{scissorTest:!0,scissor:l},(()=>Lo(t,e)))}const c={totalCount:e.length,visibleCount:0,compositeCount:0,pickableCount:0};Ps(t,{viewport:l});for(let t=0;t<e.length;t++){const i=e[t],{shouldDrawLayer:r,layerRenderIndex:o,moduleParameters:l,layerParameters:h}=a[t];if(r&&i.props.pickable&&c.pickableCount++,i.isComposite)c.compositeCount++;else if(r){c.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,o),l.viewport=s;try{i._drawLayer({moduleParameters:l,uniforms:{layerIndex:o},parameters:h})}catch(t){i.raiseError(t,"drawing ".concat(i," to ").concat(n))}}}return c}shouldDrawLayer(t){return!0}getModuleParameters(t,e){return null}getLayerParameters(t,e,i){return t.props.parameters}_shouldDrawLayer(t,e,i,n){if(!(t.props.visible&&this.shouldDrawLayer(t)))return!1;e.layer=t;let r=t.parent;for(;r;){if(!r.props.visible||!r.filterSubLayer(e))return!1;e.layer=r,r=r.parent}if(i){const t=e.layer.id;if(t in n||(n[t]=i(e)),!n[t])return!1}return t.activateViewport(e.viewport),!0}_getModuleParameters(t,e,i,n){var r;const s=Object.assign(Object.create((null===(r=t.internalState)||void 0===r?void 0:r.propsInTransition)||t.props),{autoWrapLongitude:t.wrapLongitude,viewport:t.context.viewport,mousePosition:t.context.mousePosition,pickingActive:0,devicePixelRatio:Rs(this.gl)});if(e)for(const i of e){var o;Object.assign(s,null===(o=i.getModuleParameters)||void 0===o?void 0:o.call(i,t))}return Object.assign(s,this.getModuleParameters(t,e),n)}}function vu(t=0,e={}){const i={},n=(r,s)=>{const o=r.props._offset,a=r.id,l=r.parent&&r.parent.id;let c;if(l&&!(l in e)&&n(r.parent,!1),l in i){const t=i[l]=i[l]||vu(e[l],e);c=t(r,s),i[a]=t}else Number.isFinite(o)?(c=o+(e[l]||0),i[a]=null):c=t;return s&&c>=t&&(t=c+1),e[a]=c,c};return n}class xu extends yu{constructor(t,e){super(t,e),He(this,"shadowMap",void 0),He(this,"depthBuffer",void 0),He(this,"fbo",void 0),this.shadowMap=new wo(t,{width:1,height:1,parameters:{10241:9729,10240:9729,10242:33071,10243:33071}}),this.depthBuffer=new Co(t,{format:33189,width:1,height:1}),this.fbo=new Wo(t,{id:"shadowmap",width:1,height:1,attachments:{36064:this.shadowMap,36096:this.depthBuffer}})}render(t){const e=this.fbo;Ls(this.gl,{depthRange:[0,1],depthTest:!0,blend:!1,clearColor:[1,1,1,1]},(()=>{const i=t.viewports[0],n=Rs(this.gl),r=i.width*n,s=i.height*n;r===e.width&&s===e.height||e.resize({width:r,height:s}),super.render({...t,target:e,pass:"shadow"})}))}shouldDrawLayer(t){return!1!==t.props.shadowEnabled}getModuleParameters(){return{drawToShadowMap:!0}}delete(){this.fbo&&(this.fbo.delete(),this.fbo=null),this.shadowMap&&(this.shadowMap.delete(),this.shadowMap=null),this.depthBuffer&&(this.depthBuffer.delete(),this.depthBuffer=null)}}const bu="#define SMOOTH_EDGE_RADIUS 0.5";var wu={name:"geometry",vs:"\n".concat(bu,"\n\nstruct VertexGeometry {\n  vec4 position;\n  vec3 worldPosition;\n  vec3 worldPositionAlt;\n  vec3 normal;\n  vec2 uv;\n  vec3 pickingColor;\n} geometry = VertexGeometry(\n  vec4(0.0, 0.0, 1.0, 0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec2(0.0),\n  vec3(0.0)\n);\n"),fs:"\n".concat(bu,"\n\nstruct FragmentGeometry {\n  vec2 uv;\n} geometry;\n\nfloat smoothedge(float edge, float x) {\n  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);\n}\n")};const Au=Object.keys(Vr).map((t=>"const int COORDINATE_SYSTEM_".concat(t," = ").concat(Vr[t],";"))).join(""),Tu=Object.keys(jr).map((t=>"const int PROJECTION_MODE_".concat(t," = ").concat(jr[t],";"))).join(""),Mu=Object.keys(Hr).map((t=>"const int UNIT_".concat(t.toUpperCase()," = ").concat(Hr[t],";"))).join("");var Su="".concat(Au,"\n").concat(Tu,"\n").concat(Mu,"\n\nuniform int project_uCoordinateSystem;\nuniform int project_uProjectionMode;\nuniform float project_uScale;\nuniform bool project_uWrapLongitude;\nuniform vec3 project_uCommonUnitsPerMeter;\nuniform vec3 project_uCommonUnitsPerWorldUnit;\nuniform vec3 project_uCommonUnitsPerWorldUnit2;\nuniform vec4 project_uCenter;\nuniform mat4 project_uModelMatrix;\nuniform mat4 project_uViewProjectionMatrix;\nuniform vec2 project_uViewportSize;\nuniform float project_uDevicePixelRatio;\nuniform float project_uFocalDistance;\nuniform vec3 project_uCameraPosition;\nuniform vec3 project_uCoordinateOrigin;\nuniform vec3 project_uCommonOrigin;\nuniform bool project_uPseudoMeters;\n\nconst float TILE_SIZE = 512.0;\nconst float PI = 3.1415926536;\nconst float WORLD_SCALE = TILE_SIZE / (PI * 2.0);\nconst vec3 ZERO_64_LOW = vec3(0.0);\nconst float EARTH_RADIUS = 6370972.0;\nconst float GLOBE_RADIUS = 256.0;\nfloat project_size_at_latitude(float lat) {\n  float y = clamp(lat, -89.9, 89.9);\n  return 1.0 / cos(radians(y));\n}\n\nfloat project_size() {\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&\n    project_uPseudoMeters == false) {\n    \n    if (geometry.position.w == 0.0) {\n      return project_size_at_latitude(geometry.worldPosition.y);\n    }\n  \n    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;\n    float y2 = y * y;\n    float y4 = y2 * y2;\n    float y6 = y4 * y2;\n    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;\n  }\n  return 1.0;\n}\n\nfloat project_size_at_latitude(float meters, float lat) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);\n}\nfloat project_size(float meters) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size();\n}\n\nvec2 project_size(vec2 meters) {\n  return meters * project_uCommonUnitsPerMeter.xy * project_size();\n}\n\nvec3 project_size(vec3 meters) {\n  return meters * project_uCommonUnitsPerMeter * project_size();\n}\n\nvec4 project_size(vec4 meters) {\n  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);\n}\nmat3 project_get_orientation_matrix(vec3 up) {\n  vec3 uz = normalize(up);\n  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));\n  vec3 uy = cross(uz, ux);\n  return mat3(ux, uy, uz);\n}\n\nbool project_needs_rotation(vec3 commonPosition, out mat3 transform) {\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    transform = project_get_orientation_matrix(commonPosition);\n    return true;\n  }\n  return false;\n}\nvec3 project_normal(vec3 vector) {\n  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);\n  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);\n  mat3 rotation;\n  if (project_needs_rotation(geometry.position.xyz, rotation)) {\n    n = rotation * n;\n  }\n  return n;\n}\n\nvec4 project_offset_(vec4 offset) {\n  float dy = offset.y;\n  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;\n  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);\n}\nvec2 project_mercator_(vec2 lnglat) {\n  float x = lnglat.x;\n  if (project_uWrapLongitude) {\n    x = mod(x + 180., 360.0) - 180.;\n  }\n  float y = clamp(lnglat.y, -89.9, 89.9);\n  return vec2(\n    radians(x) + PI,\n    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))\n  ) * WORLD_SCALE;\n}\n\nvec3 project_globe_(vec3 lnglatz) {\n  float lambda = radians(lnglatz.x);\n  float phi = radians(lnglatz.y);\n  float cosPhi = cos(phi);\n  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;\n\n  return vec3(\n    sin(lambda) * cosPhi,\n    -cos(lambda) * cosPhi,\n    sin(phi)\n  ) * D;\n}\nvec4 project_position(vec4 position, vec3 position64Low) {\n  vec4 position_world = project_uModelMatrix * position;\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_mercator_(position_world.xy),\n        project_size_at_latitude(position_world.z, position_world.y),\n        position_world.w\n      );\n    }\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {\n      position_world.xyz += project_uCoordinateOrigin;\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_globe_(position_world.xyz),\n        position_world.w\n      );\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {\n        return vec4(\n          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,\n          project_size(position_world.z),\n          position_world.w\n        );\n      }\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||\n    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&\n    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {\n    position_world.xyz -= project_uCoordinateOrigin;\n  }\n  return project_offset_(position_world + project_uModelMatrix * vec4(position64Low, 0.0));\n}\n\nvec4 project_position(vec4 position) {\n  return project_position(position, ZERO_64_LOW);\n}\n\nvec3 project_position(vec3 position, vec3 position64Low) {\n  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);\n  return projected_position.xyz;\n}\n\nvec3 project_position(vec3 position) {\n  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);\n  return projected_position.xyz;\n}\n\nvec2 project_position(vec2 position) {\n  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);\n  return projected_position.xy;\n}\n\nvec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {\n  return viewProjectionMatrix * position + center;\n}\nvec4 project_common_position_to_clipspace(vec4 position) {\n  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);\n}\nvec2 project_pixel_size_to_clipspace(vec2 pixels) {\n  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;\n  return offset * project_uFocalDistance;\n}\n\nfloat project_size_to_pixel(float meters) {\n  return project_size(meters) * project_uScale;\n}\nfloat project_size_to_pixel(float size, int unit) {\n  if (unit == UNIT_METERS) return project_size_to_pixel(size);\n  if (unit == UNIT_COMMON) return size * project_uScale;\n  return size;\n}\nfloat project_pixel_size(float pixels) {\n  return pixels / project_uScale;\n}\nvec2 project_pixel_size(vec2 pixels) {\n  return pixels / project_uScale;\n}\n");function Eu(t,e){if(t===e)return!0;if(Array.isArray(t)){const i=t.length;if(!e||e.length!==i)return!1;for(let n=0;n<i;n++)if(t[n]!==e[n])return!1;return!0}return!1}function Cu(t){let e,i={};return n=>{for(const r in n)if(!Eu(n[r],i[r])){e=t(n),i=n;break}return e}}const Iu=[0,0,0,0],Pu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Lu=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ru=[0,0,0],Bu=[0,0,0],Du=Cu((function({viewport:t,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:n}){const{projectionCenter:r,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:c}=function(t,e,i){const{viewMatrixUncentered:n,projectionMatrix:r}=t;let{viewMatrix:s,viewProjectionMatrix:o}=t,a=Iu,l=Iu,c=t.cameraPosition;const{geospatialOrigin:h,shaderCoordinateOrigin:u,offsetMode:d}=Ou(t,e,i);d&&(l=t.projectPosition(h||u),c=[c[0]-l[0],c[1]-l[1],c[2]-l[2]],l[3]=1,a=th([],l,o),s=n||s,o=Wc([],r,s),o=Wc([],o,Pu));return{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:l,cameraPosCommon:c,shaderCoordinateOrigin:u,geospatialOrigin:h}}(t,i,n),h=t.getDistanceScales(),u=[t.width*e,t.height*e],d=th([],[0,0,-t.focalDistance,1],t.projectionMatrix)[3]||1,p={project_uCoordinateSystem:i,project_uProjectionMode:t.projectionMode,project_uCoordinateOrigin:l,project_uCommonOrigin:o.slice(0,3),project_uCenter:r,project_uPseudoMeters:Boolean(t._pseudoMeters),project_uViewportSize:u,project_uDevicePixelRatio:e,project_uFocalDistance:d,project_uCommonUnitsPerMeter:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit:h.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:Ru,project_uScale:t.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:s,project_uModelMatrix:Lu,project_uCameraPosition:a};if(c){const e=t.getDistanceScales(c);switch(i){case Vr.METER_OFFSETS:p.project_uCommonUnitsPerWorldUnit=e.unitsPerMeter,p.project_uCommonUnitsPerWorldUnit2=e.unitsPerMeter2;break;case Vr.LNGLAT:case Vr.LNGLAT_OFFSETS:t._pseudoMeters||(p.project_uCommonUnitsPerMeter=e.unitsPerMeter),p.project_uCommonUnitsPerWorldUnit=e.unitsPerDegree,p.project_uCommonUnitsPerWorldUnit2=e.unitsPerDegree2;break;case Vr.CARTESIAN:p.project_uCommonUnitsPerWorldUnit=[1,1,e.unitsPerMeter[2]],p.project_uCommonUnitsPerWorldUnit2=[0,0,e.unitsPerMeter2[2]]}}return p}));function Ou(t,e,i=Bu){i.length<3&&(i=[i[0],i[1],0]);let n,r=i,s=!0;switch(n=e===Vr.LNGLAT_OFFSETS||e===Vr.METER_OFFSETS?i:t.isGeospatial?[Math.fround(t.longitude),Math.fround(t.latitude),0]:null,t.projectionMode){case jr.WEB_MERCATOR:e!==Vr.LNGLAT&&e!==Vr.CARTESIAN||(n=[0,0,0],s=!1);break;case jr.WEB_MERCATOR_AUTO_OFFSET:e===Vr.LNGLAT?r=n:e===Vr.CARTESIAN&&(r=[Math.fround(t.center[0]),Math.fround(t.center[1]),0],n=t.unprojectPosition(r),r[0]-=i[0],r[1]-=i[1],r[2]-=i[2]);break;case jr.IDENTITY:r=t.position.map(Math.fround),r[2]=r[2]||0;break;case jr.GLOBE:s=!1,n=null;break;default:s=!1}return{geospatialOrigin:n,shaderCoordinateOrigin:r,offsetMode:s}}const ku={};var Fu={name:"project",dependencies:[ql,wu],vs:Su,getUniforms:function(t=ku){return"viewport"in t?function({viewport:t,devicePixelRatio:e=1,modelMatrix:i=null,coordinateSystem:n=Vr.DEFAULT,coordinateOrigin:r=Bu,autoWrapLongitude:s=!1}){n===Vr.DEFAULT&&(n=t.isGeospatial?Vr.LNGLAT:Vr.CARTESIAN);const o=Du({viewport:t,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:r});return o.project_uWrapLongitude=s,o.project_uModelMatrix=i||Lu,o}(t):{}}};function zu(t,e){const i=th([],e,t);return Qc(i,i,1/i[3]),i}function Nu(t,e){const i=t%e;return i<0?e+i:i}function Uu(t,e,i){return t<e?e:t>i?i:t}const Gu=Math.log2||function(t){return Math.log(t)*Math.LOG2E};function Vu(t,e){if(!t)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const ju=Math.PI,Hu=ju/4,Wu=ju/180,qu=180/ju,Xu=512,Zu=4003e4,Ju=85.051129,Yu=1.5;function $u(t){const[e,i]=t;Vu(Number.isFinite(e)),Vu(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");return[Xu*(e*Wu+ju)/(2*ju),Xu*(ju+Math.log(Math.tan(Hu+.5*(i*Wu))))/(2*ju)]}function Ku(t){const[e,i]=t,n=e/Xu*(2*ju)-ju,r=2*(Math.atan(Math.exp(i/Xu*(2*ju)-ju))-Hu);return[n*qu,r*qu]}function Qu(t){const{latitude:e}=t;Vu(Number.isFinite(e));const i=Math.cos(e*Wu);return function(t){return Gu(t)}(Zu*i)-9}function td(t){const e=Math.cos(t*Wu);return Xu/Zu/e}function ed(t){const{latitude:e,longitude:i,highPrecision:n=!1}=t;Vu(Number.isFinite(e)&&Number.isFinite(i));const r=Xu,s=Math.cos(e*Wu),o=r/360,a=o/s,l=r/Zu/s,c={unitsPerMeter:[l,l,l],metersPerUnit:[1/l,1/l,1/l],unitsPerDegree:[o,a,l],degreesPerUnit:[1/o,1/a,1/l]};if(n){const t=Wu*Math.tan(e*Wu)/s,i=r/Zu*t,n=i/a*l;c.unitsPerDegree2=[0,o*t/2,i],c.unitsPerMeter2=[n,0,n]}return c}function id(t,e){const[i,n,r]=t,[s,o,a]=e,{unitsPerMeter:l,unitsPerMeter2:c}=ed({longitude:i,latitude:n,highPrecision:!0}),h=$u(t);h[0]+=s*(l[0]+c[0]*o),h[1]+=o*(l[1]+c[1]*o);const u=Ku(h),d=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[u[0],u[1],d]:u}function nd(t){return 2*Math.atan(.5/t)*qu}function rd(t){return.5/Math.tan(.5*t*Wu)}function sd(t,e){const[i,n,r=0]=t;return Vu(Number.isFinite(i)&&Number.isFinite(n)&&Number.isFinite(r)),zu(e,[i,n,r,1])}function od(t,e,i=0){const[n,r,s]=t;if(Vu(Number.isFinite(n)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(s)){return zu(e,[n,r,s,1])}const o=zu(e,[n,r,0,1]),a=zu(e,[n,r,1,1]),l=o[2],c=a[2];return fc([],o,a,l===c?0:((i||0)-l)/(c-l))}function ad(t){const{width:e,height:i,bounds:n,minExtent:r=0,maxZoom:s=24,offset:o=[0,0]}=t,[[a,l],[c,h]]=n,u=function(t=0){if("number"==typeof t)return{top:t,bottom:t,left:t,right:t};return Vu(Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.left)&&Number.isFinite(t.right)),t}(t.padding),d=$u([a,Uu(h,-85.051129,Ju)]),p=$u([c,Uu(l,-85.051129,Ju)]),f=[Math.max(Math.abs(p[0]-d[0]),r),Math.max(Math.abs(p[1]-d[1]),r)],m=[e-u.left-u.right-2*Math.abs(o[0]),i-u.top-u.bottom-2*Math.abs(o[1])];Vu(m[0]>0&&m[1]>0);const g=m[0]/f[0],_=m[1]/f[1],y=Ku([(p[0]+d[0])/2+(u.right-u.left)/2/g,(p[1]+d[1])/2+(u.top-u.bottom)/2/_]),v=Math.min(s,Gu(Math.abs(Math.min(g,_))));return Vu(Number.isFinite(v)),{longitude:y[0],latitude:y[1],zoom:v}}const ld=Math.PI/180;function cd(t,e,i){const{pixelUnprojectionMatrix:n}=t,r=zu(n,[e,0,1,1]),s=zu(n,[e,t.height,1,1]),o=Ku(fc([],r,s,(i*t.distanceScales.unitsPerMeter[2]-r[2])/(s[2]-r[2])));return o.push(i),o}const hd=Cu((function({viewport:t,center:e}){return new lh(t.viewProjectionMatrix).invert().transform(e)})),ud=Cu((function({viewport:t,shadowMatrices:e}){const i=[],n=t.pixelUnprojectionMatrix,r=t.isGeospatial?void 0:1,s=[[0,0,r],[t.width,0,r],[0,t.height,r],[t.width,t.height,r],[0,0,-1],[t.width,0,-1],[0,t.height,-1],[t.width,t.height,-1]].map((t=>function(t,e){const[i,n,r]=t,s=od([i,n,r],e);if(Number.isFinite(r))return s;return[s[0],s[1],0]}(t,n)));for(const n of e){const e=n.clone().translate(new Dc(t.center).negate()),r=s.map((t=>e.transform(t))),o=(new lh).ortho({left:Math.min(...r.map((t=>t[0]))),right:Math.max(...r.map((t=>t[0]))),bottom:Math.min(...r.map((t=>t[1]))),top:Math.max(...r.map((t=>t[1]))),near:Math.min(...r.map((t=>-t[2]))),far:Math.max(...r.map((t=>-t[2])))});i.push(o.multiplyRight(n))}return i})),dd=[0,0,0,1],pd=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];var fd={name:"shadow",dependencies:[Fu],vs:"\nconst int max_lights = 2;\nuniform mat4 shadow_uViewProjectionMatrices[max_lights];\nuniform vec4 shadow_uProjectCenters[max_lights];\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform int shadow_uLightId;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nvec4 shadow_setVertexPosition(vec4 position_commonspace) {\n  if (shadow_uDrawShadowMap) {\n    return project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[shadow_uLightId], shadow_uProjectCenters[shadow_uLightId]);\n  }\n  if (shadow_uUseShadowMap) {\n    for (int i = 0; i < max_lights; i++) {\n      if(i < int(shadow_uLightCount)) {\n        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, shadow_uViewProjectionMatrices[i], shadow_uProjectCenters[i]);\n        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;\n      }\n    }\n  }\n  return gl_Position;\n}\n",fs:"\nconst int max_lights = 2;\nuniform bool shadow_uDrawShadowMap;\nuniform bool shadow_uUseShadowMap;\nuniform sampler2D shadow_uShadowMap0;\nuniform sampler2D shadow_uShadowMap1;\nuniform vec4 shadow_uColor;\nuniform float shadow_uLightCount;\n\nvarying vec3 shadow_vPosition[max_lights];\n\nconst vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);\nconst vec4 bitUnpackShift = 1.0 / bitPackShift;\nconst vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);\n\nfloat shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {\n  vec4 rgbaDepth = texture2D(shadowMap, position.xy);\n\n  float z = dot(rgbaDepth, bitUnpackShift);\n  return smoothstep(0.001, 0.01, position.z - z);\n}\n\nvec4 shadow_filterShadowColor(vec4 color) {\n  if (shadow_uDrawShadowMap) {\n    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);\n    rgbaDepth -= rgbaDepth.gbaa * bitMask;\n    return rgbaDepth;\n  }\n  if (shadow_uUseShadowMap) {\n    float shadowAlpha = 0.0;\n    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);\n    if(shadow_uLightCount > 1.0) {\n      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);\n    }\n    shadowAlpha *= shadow_uColor.a / shadow_uLightCount;\n    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);\n\n    return vec4(\n      mix(color.rgb, shadow_uColor.rgb, shadowAlpha / blendedAlpha),\n      blendedAlpha\n    );\n  }\n  return color;\n}\n",inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    position = shadow_setVertexPosition(geometry.position);\n    ","fs:DECKGL_FILTER_COLOR":"\n    color = shadow_filterShadowColor(color);\n    "},getUniforms:(t={},e={})=>"viewport"in t&&(t.drawToShadowMap||t.shadowMaps&&t.shadowMaps.length>0)?function(t,e){const{shadowEnabled:i=!0}=t;if(!i||!t.shadowMatrices||!t.shadowMatrices.length)return{shadow_uDrawShadowMap:!1,shadow_uUseShadowMap:!1};const n={shadow_uDrawShadowMap:Boolean(t.drawToShadowMap),shadow_uUseShadowMap:!!t.shadowMaps&&t.shadowMaps.length>0,shadow_uColor:t.shadowColor||dd,shadow_uLightId:t.shadowLightId||0,shadow_uLightCount:t.shadowMatrices.length},r=hd({viewport:t.viewport,center:e.project_uCenter}),s=[],o=ud({shadowMatrices:t.shadowMatrices,viewport:t.viewport}).slice();for(let i=0;i<t.shadowMatrices.length;i++){const n=o[i],a=n.clone().translate(new Dc(t.viewport.center).negate());e.project_uCoordinateSystem===Vr.LNGLAT&&e.project_uProjectionMode===jr.WEB_MERCATOR?(o[i]=a,s[i]=r):(o[i]=n.clone().multiplyRight(pd),s[i]=a.transform(r))}for(let e=0;e<o.length;e++)n["shadow_uViewProjectionMatrices[".concat(e,"]")]=o[e],n["shadow_uProjectCenters[".concat(e,"]")]=s[e],n["shadow_uShadowMap".concat(e)]=t.shadowMaps&&t.shadowMaps.length>0?t.shadowMaps[e]:t.dummyShadowMap;return n}(t,e):{}};const md={color:[255,255,255],intensity:1},gd=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],_d=[0,0,0,200/255];class yd{constructor(t={}){He(this,"id","lighting-effect"),He(this,"props",void 0),He(this,"shadowColor",_d),He(this,"shadow",void 0),He(this,"ambientLight",void 0),He(this,"directionalLights",void 0),He(this,"pointLights",void 0),He(this,"shadowPasses",[]),He(this,"shadowMaps",[]),He(this,"dummyShadowMap",null),He(this,"programManager",void 0),He(this,"shadowMatrices",void 0),this.setProps(t)}setProps(t){this.ambientLight=null,this.directionalLights=[],this.pointLights=[];for(const e in t){const i=t[e];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some((t=>t.shadow)),this.props=t}preRender(t,{layers:e,layerFilter:i,viewports:n,onViewportActive:r,views:s}){if(this.shadow){this.shadowMatrices=this._calculateMatrices(),0===this.shadowPasses.length&&this._createShadowPasses(t),this.programManager||(this.programManager=Vh.getDefaultProgramManager(t),fd&&this.programManager.addDefaultModule(fd)),this.dummyShadowMap||(this.dummyShadowMap=new wo(t,{width:1,height:1}));for(let t=0;t<this.shadowPasses.length;t++){this.shadowPasses[t].render({layers:e,layerFilter:i,viewports:n,onViewportActive:r,views:s,moduleParameters:{shadowLightId:t,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}})}}}getModuleParameters(t){const e=this.shadow?{shadowMaps:this.shadowMaps,dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{};return e.lightSources={ambientLight:this.ambientLight,directionalLights:this.directionalLights.map((e=>e.getProjectedLight({layer:t}))),pointLights:this.pointLights.map((e=>e.getProjectedLight({layer:t})))},e}cleanup(){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.shadowMaps.length=0,this.dummyShadowMap&&(this.dummyShadowMap.delete(),this.dummyShadowMap=null),this.shadow&&this.programManager&&(this.programManager.removeDefaultModule(fd),this.programManager=null)}_calculateMatrices(){const t=[];for(const e of this.directionalLights){const i=(new lh).lookAt({eye:new Dc(e.direction).negate()});t.push(i)}return t}_createShadowPasses(t){for(let e=0;e<this.directionalLights.length;e++){const i=new xu(t);this.shadowPasses[e]=i,this.shadowMaps[e]=i.shadowMap}}_applyDefaultLights(){const{ambientLight:t,pointLights:e,directionalLights:i}=this;t||0!==e.length||0!==i.length||(this.ambientLight=new uu(md),this.directionalLights.push(new gu(gd[0]),new gu(gd[1])))}}var vd=new class{constructor(t={}){He(this,"_pool",[]),He(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:i=1,type:n,padding:r=0,copy:s=!1,initialize:o=!1,maxCount:a}){const l=n||t&&t.constructor||Float32Array,c=e*i+r;if(ArrayBuffer.isView(t)){if(c<=t.length)return t;if(c*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new l(t.buffer,0,c)}let h=1/0;a&&(h=a*i+r);const u=this._allocate(l,c,o,h);return t&&s?u.set(t):o||u.fill(0,0,4),this._release(t),u}release(t){this._release(t)}_allocate(t,e,i,n){let r=Math.max(Math.ceil(e*this.opts.overAlloc),1);r>n&&(r=n);const s=this._pool,o=t.BYTES_PER_ELEMENT*r,a=s.findIndex((t=>t.byteLength>=o));if(a>=0){const e=new t(s.splice(a,1)[0],0,r);return i&&e.fill(0),e}return new t(r)}_release(t){if(!ArrayBuffer.isView(t))return;const e=this._pool,{buffer:i}=t,{byteLength:n}=i,r=e.findIndex((t=>t.byteLength>=n));r<0?e.push(i):(r>0||e.length<this.opts.poolSize)&&e.splice(r,0,i),e.length>this.opts.poolSize&&e.shift()}};const xd=new Dc;function bd(t,e,i,n){xd.set(t,e,i);const r=xd.len();return{distance:n/r,normal:new Dc(-t/r,-e/r,-i/r)}}function wd(t){return t-Math.fround(t)}let Ad;function Td(t,e){const{size:i=1,startIndex:n=0}=e,r=void 0!==e.endIndex?e.endIndex:t.length,s=(r-n)/i;Ad=vd.allocate(Ad,s,{type:Float32Array,size:2*i});let o=n,a=0;for(;o<r;){for(let e=0;e<i;e++){const n=t[o++];Ad[a+e]=n,Ad[a+e+i]=wd(n)}a+=2*i}return Ad.subarray(0,s*i*2)}function Md(t){let e=null,i=!1;for(const n of t)n&&(e?(i||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],i=!0),e[0][0]=Math.min(e[0][0],n[0][0]),e[0][1]=Math.min(e[0][1],n[0][1]),e[1][0]=Math.max(e[1][0],n[1][0]),e[1][1]=Math.max(e[1][1],n[1][1])):e=n);return e}const Sd=Math.PI/180,Ed=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Cd=[0,0,0],Id={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class Pd{constructor(t={}){He(this,"id",void 0),He(this,"x",void 0),He(this,"y",void 0),He(this,"width",void 0),He(this,"height",void 0),He(this,"padding",void 0),He(this,"isGeospatial",void 0),He(this,"zoom",void 0),He(this,"focalDistance",void 0),He(this,"position",void 0),He(this,"modelMatrix",void 0),He(this,"distanceScales",void 0),He(this,"scale",void 0),He(this,"center",void 0),He(this,"cameraPosition",void 0),He(this,"projectionMatrix",void 0),He(this,"viewMatrix",void 0),He(this,"viewMatrixUncentered",void 0),He(this,"viewMatrixInverse",void 0),He(this,"viewProjectionMatrix",void 0),He(this,"pixelProjectionMatrix",void 0),He(this,"pixelUnprojectionMatrix",void 0),He(this,"resolution",void 0),He(this,"_frustumPlanes",{}),this.id=t.id||this.constructor.displayName||"viewport",this.x=t.x||0,this.y=t.y||0,this.width=t.width||1,this.height=t.height||1,this.zoom=t.zoom||0,this.padding=t.padding,this.distanceScales=t.distanceScales||Id,this.focalDistance=t.focalDistance||1,this.position=t.position||Cd,this.modelMatrix=t.modelMatrix||null;const{longitude:e,latitude:i}=t;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(e),this._initProps(t),this._initMatrices(t),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?jr.WEB_MERCATOR:jr.WEB_MERCATOR_AUTO_OFFSET:jr.IDENTITY}equals(t){return t instanceof Pd&&(this===t||t.width===this.width&&t.height===this.height&&t.scale===this.scale&&rc(t.projectionMatrix,this.projectionMatrix)&&rc(t.viewMatrix,this.viewMatrix))}project(t,{topLeft:e=!0}={}){const i=sd(this.projectPosition(t),this.pixelProjectionMatrix),[n,r]=i,s=e?r:this.height-r;return 2===t.length?[n,s]:[n,s,i[2]]}unproject(t,{topLeft:e=!0,targetZ:i}={}){const[n,r,s]=t,o=od([n,e?r:this.height-r,s],this.pixelUnprojectionMatrix,i&&i*this.distanceScales.unitsPerMeter[2]),[a,l,c]=this.unprojectPosition(o);return Number.isFinite(s)?[a,l,c]:Number.isFinite(i)?[a,l,i]:[a,l]}projectPosition(t){const[e,i]=this.projectFlat(t);return[e,i,(t[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(t){const[e,i]=this.unprojectFlat(t);return[e,i,(t[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(t){if(this.isGeospatial){const e=$u(t);return e[1]=ic(e[1],-318,830),e}return t}unprojectFlat(t){return this.isGeospatial?Ku(t):t}getBounds(t={}){const e={targetZ:t.z||0},i=this.unproject([0,0],e),n=this.unproject([this.width,0],e),r=this.unproject([0,this.height],e),s=this.unproject([this.width,this.height],e);return[Math.min(i[0],n[0],r[0],s[0]),Math.min(i[1],n[1],r[1],s[1]),Math.max(i[0],n[0],r[0],s[0]),Math.max(i[1],n[1],r[1],s[1])]}getDistanceScales(t){return t?ed({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:i=1,height:n=1}){return t<this.x+this.width&&this.x<t+i&&e<this.y+this.height&&this.y<e+n}getFrustumPlanes(){return this._frustumPlanes.near||Object.assign(this._frustumPlanes,{left:bd((t=this.viewProjectionMatrix)[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),right:bd(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),bottom:bd(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),top:bd(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),near:bd(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),far:bd(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14])}),this._frustumPlanes;var t}panByPosition(t,e){return null}_initProps(t){const e=t.longitude,i=t.latitude;this.isGeospatial&&(Number.isFinite(t.zoom)||(this.zoom=Qu({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=t.distanceScales||ed({latitude:i,longitude:e}));const n=Math.pow(2,this.zoom);this.scale=n;const{position:r,modelMatrix:s}=t;let o=Cd;if(r&&(o=s?new lh(s).transformAsVector(r,[]):r),this.isGeospatial){const t=this.projectPosition([e,i,0]);this.center=new Dc(o).scale(this.distanceScales.unitsPerMeter).add(t)}else this.center=this.projectPosition(o)}_initMatrices(t){const{viewMatrix:e=Ed,projectionMatrix:i=null,orthographic:n=!1,fovyRadians:r,fovy:s=75,near:o=.1,far:a=1e3,padding:l=null,focalDistance:c=1}=t;this.viewMatrixUncentered=e,this.viewMatrix=(new lh).multiplyRight(e).translate(new Dc(this.center).negate()),this.projectionMatrix=i||function({width:t,height:e,orthographic:i,fovyRadians:n,focalDistance:r,padding:s,near:o,far:a}){const l=t/e,c=i?(new lh).orthographic({fovy:n,aspect:l,focalDistance:r,near:o,far:a}):(new lh).perspective({fovy:n,aspect:l,near:o,far:a});if(s){const{left:i=0,right:n=0,top:r=0,bottom:o=0}=s,a=ic((i+t-n)/2,0,t)-t/2,l=ic((r+e-o)/2,0,e)-e/2;c[8]-=2*a/t,c[9]+=2*l/e}return c}({width:this.width,height:this.height,orthographic:n,fovyRadians:r||s*Sd,focalDistance:c,padding:l,near:o,far:a});const h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var u;Wc(h,h,this.projectionMatrix),Wc(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=Hc([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(u=this.viewMatrixInverse)[12],u[13],u[14]];const d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],p=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Xc(d,d,[this.width/2,-this.height/2,1]),qc(d,d,[1,-1,0]),Wc(p,d,this.viewProjectionMatrix),this.pixelProjectionMatrix=p,this.pixelUnprojectionMatrix=Hc([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||kr.warn("Pixel project matrix not invertible")()}}He(Pd,"displayName","Viewport");class Ld extends Pd{constructor(t={}){const{latitude:e=0,longitude:i=0,zoom:n=0,pitch:r=0,bearing:s=0,nearZMultiplier:o=.1,farZMultiplier:a=1.01,nearZ:l,farZ:c,orthographic:h=!1,projectionMatrix:u,repeat:d=!1,worldOffset:p=0,position:f,padding:m,legacyMeterSizes:g=!1}=t;let{width:_,height:y,altitude:v=1.5}=t;const x=Math.pow(2,n);let b;_=_||1,y=y||1;let w=null;if(u)v=u[5]/2,b=nd(v);else{let i;if(t.fovy?(b=t.fovy,v=rd(b)):b=nd(v),m){const{top:t=0,bottom:e=0}=m;i=[0,ic((t+y-e)/2,0,y)-y/2]}w=function(t){const{width:e,height:i,altitude:n,pitch:r=0,center:s,scale:o,nearZMultiplier:a=1,farZMultiplier:l=1,unitsPerMeter:c}=t;let{fovy:h=nd(Yu)}=t;void 0!==n&&(h=nd(n));const u=h*Wu,d=r*Wu,p=rd(h);let f=p;return s&&(f+=s[2]*o/Math.cos(d)/i),{fov:u,aspect:e/i,focalDistance:p,near:a,far:Math.max(10*f,f+1e3*c/Math.cos(d))}}({width:_,height:y,scale:x,center:f&&[0,0,f[2]*td(e)],offset:i,pitch:r,fovy:b,nearZMultiplier:o,farZMultiplier:a,unitsPerMeter:x*td(e)/y}),Number.isFinite(l)&&(w.near=l),Number.isFinite(c)&&(w.far=c)}let A=function(t){const{height:e,pitch:i,bearing:n,altitude:r,scale:s,center:o}=t,a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];qc(a,a,[0,0,-r]),Zc(a,a,-i*Wu),Jc(a,a,n*Wu);const l=s/e;return Xc(a,a,[l,l,l]),o&&qc(a,a,function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}([],o)),a}({height:y,pitch:r,bearing:s,scale:x,altitude:v});if(p){A=(new lh).translate([512*p,0,0]).multiplyLeft(A)}super({...t,width:_,height:y,viewMatrix:A,longitude:i,latitude:e,zoom:n,...w,fovy:b,focalDistance:v}),He(this,"longitude",void 0),He(this,"latitude",void 0),He(this,"pitch",void 0),He(this,"bearing",void 0),He(this,"altitude",void 0),He(this,"fovy",void 0),He(this,"orthographic",void 0),He(this,"_subViewports",void 0),He(this,"_pseudoMeters",void 0),this.latitude=e,this.longitude=i,this.zoom=n,this.pitch=r,this.bearing=s,this.altitude=v,this.fovy=b,this.orthographic=h,this._subViewports=d?[]:null,this._pseudoMeters=g,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const t=this.getBounds(),e=Math.floor((t[0]+180)/360),i=Math.ceil((t[2]-180)/360);for(let t=e;t<=i;t++){const e=t?new Ld({...this,worldOffset:t}):this;this._subViewports.push(e)}}return this._subViewports}projectPosition(t){if(this._pseudoMeters)return super.projectPosition(t);const[e,i]=this.projectFlat(t);return[e,i,(t[2]||0)*td(t[1])]}unprojectPosition(t){if(this._pseudoMeters)return super.unprojectPosition(t);const[e,i]=this.unprojectFlat(t);return[e,i,(t[2]||0)/td(i)]}addMetersToLngLat(t,e){return id(t,e)}panByPosition(t,e){const i=od(e,this.pixelUnprojectionMatrix),n=pc([],this.projectFlat(t),function(t,e){return t[0]=-e[0],t[1]=-e[1],t}([],i)),r=pc([],this.center,n),[s,o]=this.unprojectFlat(r);return{longitude:s,latitude:o}}getBounds(t={}){const e=function(t,e=0){const{width:i,height:n,unproject:r}=t,s={targetZ:e},o=r([0,n],s),a=r([i,n],s);let l,c;return(t.fovy?.5*t.fovy*ld:Math.atan(.5/t.altitude))>(90-t.pitch)*ld-.01?(l=cd(t,0,e),c=cd(t,i,e)):(l=r([0,0],s),c=r([i,0],s)),[o,a,c,l]}(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){const{width:i,height:n}=this,{longitude:r,latitude:s,zoom:o}=ad({width:i,height:n,bounds:t,...e});return new Ld({width:i,height:n,longitude:r,latitude:s,zoom:o})}}He(Ld,"displayName","WebMercatorViewport");const Rd=[0,0,0];function Bd(t,e,i=!1){const n=e.projectPosition(t);if(i&&e instanceof Ld){const[i,r,s=0]=t,o=e.getDistanceScales([i,r]);n[2]=s*o.unitsPerMeter[2]}return n}function Dd(t,{viewport:e,modelMatrix:i,coordinateSystem:n,coordinateOrigin:r,offsetMode:s}){let[o,a,l=0]=t;switch(i&&([o,a,l]=th([],[o,a,l,1],i)),n){case Vr.LNGLAT:return Bd([o,a,l],e,s);case Vr.LNGLAT_OFFSETS:return Bd([o+r[0],a+r[1],l+(r[2]||0)],e,s);case Vr.METER_OFFSETS:return Bd(id(r,[o,a,l]),e,s);default:return e.isGeospatial?[o+r[0],a+r[1],l+r[2]]:e.projectPosition([o,a,l])}}function Od(t,e){const{viewport:i,coordinateSystem:n,coordinateOrigin:r,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=function(t){const{viewport:e,modelMatrix:i,coordinateOrigin:n}=t;let{coordinateSystem:r,fromCoordinateSystem:s,fromCoordinateOrigin:o}=t;return r===Vr.DEFAULT&&(r=e.isGeospatial?Vr.LNGLAT:Vr.CARTESIAN),void 0===s&&(s=r),void 0===o&&(o=n),{viewport:e,coordinateSystem:r,coordinateOrigin:n,modelMatrix:i,fromCoordinateSystem:s,fromCoordinateOrigin:o}}(e),{autoOffset:l=!0}=e,{geospatialOrigin:c=Rd,shaderCoordinateOrigin:h=Rd,offsetMode:u=!1}=l?Ou(i,n,r):{},d=Dd(t,{viewport:i,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:u});if(u){const t=i.projectPosition(c||h);Ic(d,d,t)}return d}const kd={blendFunc:[1,0,32771,0],blendEquation:32774};class Fd extends yu{constructor(...t){super(...t),He(this,"pickZ",void 0),He(this,"_colorEncoderState",null)}render(t){return"pickingFBO"in t?this._drawPickingBuffer(t):super.render(t)}_drawPickingBuffer({layers:t,layerFilter:e,views:i,viewports:n,onViewportActive:r,pickingFBO:s,deviceRect:{x:o,y:a,width:l,height:c},cullRect:h,effects:u,pass:d="picking",pickZ:p,moduleParameters:f}){const m=this.gl;this.pickZ=p;const g=this._resetColorEncoder(p),_=Ls(m,{scissorTest:!0,scissor:[o,a,l,c],clearColor:[0,0,0,0],depthMask:!0,depthTest:!0,depthRange:[0,1],colorMask:[!0,!0,!0,!0],...kd,blend:!p},(()=>super.render({target:s,layers:t,layerFilter:e,views:i,viewports:n,onViewportActive:r,cullRect:h,effects:null==u?void 0:u.filter((t=>t.useInPicking)),pass:d,isPicking:!0,moduleParameters:f})));this._colorEncoderState=null;return{decodePickingColor:g&&zd.bind(null,g),stats:_}}shouldDrawLayer(t){const{pickable:e,operation:i}=t.props;return e&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getModuleParameters(){return{pickingActive:1,pickingAttribute:this.pickZ,lightSources:{}}}getLayerParameters(t,e,i){const n={...t.props.parameters},{pickable:r,operation:s}=t.props;return this._colorEncoderState?r&&s.includes("draw")&&(Object.assign(n,kd),n.blend=!0,n.blendColor=function(t,e,i){const{byLayer:n,byAlpha:r}=t;let s,o=n.get(e);o?(o.viewports.push(i),s=o.a):(s=n.size+1,s<=255?(o={a:s,layer:e,viewports:[i]},n.set(e,o),r[s]=o):(kr.warn("Too many pickable layers, only picking the first 255")(),s=0));return[0,0,0,s/255]}(this._colorEncoderState,t,i)):n.blend=!1,s.includes("terrain")&&(n.blend=!1),n}_resetColorEncoder(t){return this._colorEncoderState=t?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function zd(t,e){const i=t.byAlpha[e[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(e)}}const Nd="Awaiting state",Ud="Matched. State transferred from previous layer",Gd="Initialized",Vd="Discarded. Awaiting garbage collection",jd="No longer matched. Awaiting garbage collection",Hd="Finalized! Awaiting garbage collection",Wd=Symbol.for("component"),qd=Symbol.for("propTypes"),Xd=Symbol.for("deprecatedProps"),Zd=Symbol.for("asyncPropDefaults"),Jd=Symbol.for("asyncPropOriginal"),Yd=Symbol.for("asyncPropResolved");function $d(t,e=(()=>!0)){return Array.isArray(t)?Kd(t,e,[]):e(t)?[t]:[]}function Kd(t,e,i){let n=-1;for(;++n<t.length;){const r=t[n];Array.isArray(r)?Kd(r,e,i):e(r)&&i.push(r)}return i}function Qd({target:t,source:e,start:i=0,count:n=1}){const r=e.length,s=n*r;let o=0;for(let n=i;o<r;o++)t[n++]=e[o];for(;o<s;)o<s-o?(t.copyWithin(i+o,i,i+o),o*=2):(t.copyWithin(i+o,i,i+s-o),o=s);return t}class tp{constructor(t,e,i){He(this,"id",void 0),He(this,"context",void 0),He(this,"isLoaded",void 0),He(this,"persistent",void 0),He(this,"_loadCount",0),He(this,"_subscribers",new Set),He(this,"_data",void 0),He(this,"_loader",void 0),He(this,"_error",void 0),He(this,"_content",void 0),this.id=t,this.context=i,this.setData(e)}subscribe(t){this._subscribers.add(t)}unsubscribe(t){this._subscribers.delete(t)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then((()=>this.getData()))}setData(t,e){if(t===this._data&&!e)return;this._data=t;const i=++this._loadCount;let n=t;"string"==typeof t&&(n=Wn(t)),n instanceof Promise?(this.isLoaded=!1,this._loader=n.then((t=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=t)})).catch((t=>{this._loadCount===i&&(this.isLoaded=!0,this._error=t||!0)}))):(this.isLoaded=!0,this._error=void 0,this._content=t);for(const t of this._subscribers)t.onChange(this.getData())}}class ep{constructor({gl:t,protocol:e}){He(this,"protocol",void 0),He(this,"_context",void 0),He(this,"_resources",void 0),He(this,"_consumers",void 0),He(this,"_pruneRequest",void 0),this.protocol=e||"resource://",this._context={gl:t,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(t){return!!t.startsWith(this.protocol)||t in this._resources}add({resourceId:t,data:e,forceUpdate:i=!1,persistent:n=!0}){let r=this._resources[t];r?r.setData(e,i):(r=new tp(t,e,this._context),this._resources[t]=r),r.persistent=n}remove(t){const e=this._resources[t];e&&(e.delete(),delete this._resources[t])}unsubscribe({consumerId:t}){const e=this._consumers[t];if(e){for(const t in e){const i=e[t],n=this._resources[i.resourceId];n&&n.unsubscribe(i)}delete this._consumers[t],this.prune()}}subscribe({resourceId:t,onChange:e,consumerId:i,requestId:n="default"}){const{_resources:r,protocol:s}=this;t.startsWith(s)&&(r[t=t.replace(s,"")]||this.add({resourceId:t,data:null,persistent:!1}));const o=r[t];if(this._track(i,n,o,e),o)return o.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout((()=>this._prune()),0))}finalize(){for(const t in this._resources)this._resources[t].delete()}_track(t,e,i,n){const r=this._consumers,s=r[t]=r[t]||{},o=s[e]||{},a=o.resourceId&&this._resources[o.resourceId];a&&(a.unsubscribe(o),this.prune()),i&&(s[e]=o,o.onChange=n,o.resourceId=i.id,i.subscribe(o))}_prune(){this._pruneRequest=null;for(const t of Object.keys(this._resources)){const e=this._resources[t];e.persistent||e.inUse()||(e.delete(),delete this._resources[t])}}}var ip={name:"project32",dependencies:[Fu],vs:"\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition\n) {\n  vec3 projectedPosition = project_position(position, position64Low);\n  mat3 rotation;\n  if (project_needs_rotation(projectedPosition, rotation)) {\n    // offset is specified as ENU\n    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe\n    offset = rotation * offset;\n  }\n  commonPosition = vec4(projectedPosition + offset, 1.0);\n  return project_common_position_to_clipspace(commonPosition);\n}\n\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset\n) {\n  vec4 commonPosition;\n  return project_position_to_clipspace(position, position64Low, offset, commonPosition);\n}\n"},np={inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    // for picking depth values\n    picking_setPickingAttribute(position.z / position.w);\n  ","vs:DECKGL_FILTER_COLOR":"\n  picking_setPickingColor(geometry.pickingColor);\n  ","fs:#decl":"\nuniform bool picking_uAttribute;\n  ","fs:DECKGL_FILTER_COLOR":{order:99,injection:"\n  // use highlight color if this fragment belongs to the selected object.\n  color = picking_filterHighlightColor(color);\n\n  // use picking color if rendering to picking FBO.\n  color = picking_filterPickingColor(color);\n    "}},...Dh};const rp=[Fu],sp=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"];function op(t){const e=Vh.getDefaultProgramManager(t);for(const t of rp)e.addDefaultModule(t);for(const t of sp)e.addShaderHook(t);return e}class ap{constructor(t,{deck:e,stats:i,viewport:n,timeline:r}={}){He(this,"layers",void 0),He(this,"context",void 0),He(this,"resourceManager",void 0),He(this,"_lastRenderedLayers",[]),He(this,"_needsRedraw",!1),He(this,"_needsUpdate",!1),He(this,"_nextLayers",null),He(this,"_debug",!1),He(this,"activateViewport",(t=>{Nr("layerManager.activateViewport",this,t),t&&(this.context.viewport=t)})),this.layers=[],this.resourceManager=new ep({gl:t,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,gl:t,deck:e,programManager:t&&op(t),stats:i||new Hs({id:"deck.gl"}),viewport:n||new Pd({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:r||new au,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const t of this.layers)this._finalizeLayer(t)}needsRedraw(t={clearRedrawFlags:!1}){let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const n=i.getNeedsRedraw(t);e=e||n}return e}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._needsUpdate}setNeedsRedraw(t){this._needsRedraw=this._needsRedraw||t}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t}getLayers({layerIds:t}={}){return t?this.layers.filter((e=>t.find((t=>0===e.id.indexOf(t))))):this.layers}setProps(t){"debug"in t&&(this._debug=t.debug),"userData"in t&&(this.context.userData=t.userData),"layers"in t&&(this._nextLayers=t.layers),"onError"in t&&(this.context.onError=t.onError)}setLayers(t,e){Nr("layerManager.setLayers",this,e,t),this._lastRenderedLayers=t;const i=$d(t,Boolean);for(const t of i)t.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const t=this.needsUpdate();t&&(this.setNeedsRedraw("updating layers: ".concat(t)),this.setLayers(this._nextLayers||this._lastRenderedLayers,t)),this._nextLayers=null}_handleError(t,e,i){i.raiseError(e,"".concat(t," of ").concat(i))}_updateLayers(t,e){const i={};for(const e of t)i[e.id]?kr.warn("Multiple old layers with same id ".concat(e.id))():i[e.id]=e;const n=[];this._updateSublayersRecursively(e,i,n),this._finalizeOldLayers(i);let r=!1;for(const t of n)if(t.hasUniformTransition()){r="Uniform transition in ".concat(t);break}this._needsUpdate=r,this.layers=n}_updateSublayersRecursively(t,e,i){for(const n of t){n.context=this.context;const t=e[n.id];null===t&&kr.warn("Multiple new layers with same id ".concat(n.id))(),e[n.id]=null;let r=null;try{this._debug&&t!==n&&n.validateProps(),t?(this._transferLayerState(t,n),this._updateLayer(n)):this._initializeLayer(n),i.push(n),r=n.isComposite?n.getSubLayers():null}catch(t){this._handleError("matching",t,n)}r&&this._updateSublayersRecursively(r,e,i)}}_finalizeOldLayers(t){for(const e in t){const i=t[e];i&&this._finalizeLayer(i)}}_initializeLayer(t){try{t._initialize(),t.lifecycle=Gd}catch(e){this._handleError("initialization",e,t)}}_transferLayerState(t,e){e._transferState(t),e.lifecycle=Ud,e!==t&&(t.lifecycle=Vd)}_updateLayer(t){try{t._update()}catch(e){this._handleError("update",e,t)}}_finalizeLayer(t){this._needsRedraw=this._needsRedraw||"finalized ".concat(t),t.lifecycle=jd;try{t._finalize(),t.lifecycle=Hd}catch(e){this._handleError("finalization",e,t)}}}function lp(t,e,i){if(t===e)return!0;if(!i||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!lp(t[n],e[n],i-1))return!1;return!0}if(Array.isArray(e))return!1;if("object"==typeof t&&"object"==typeof e){const n=Object.keys(t),r=Object.keys(e);if(n.length!==r.length)return!1;for(const r of n){if(!e.hasOwnProperty(r))return!1;if(!lp(t[r],e[r],i-1))return!1}return!0}return!1}class cp{constructor(t){He(this,"width",void 0),He(this,"height",void 0),He(this,"views",void 0),He(this,"viewState",void 0),He(this,"controllers",void 0),He(this,"timeline",void 0),He(this,"_viewports",void 0),He(this,"_viewportMap",void 0),He(this,"_isUpdating",void 0),He(this,"_needsRedraw",void 0),He(this,"_needsUpdate",void 0),He(this,"_eventManager",void 0),He(this,"_eventCallbacks",void 0),this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=t.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=t.eventManager,this._eventCallbacks={onViewStateChange:t.onViewStateChange,onInteractionStateChange:t.onInteractionStateChange},Object.seal(this),this.setProps(t)}finalize(){for(const t in this.controllers){const e=this.controllers[t];e&&e.finalize()}this.controllers={}}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}setNeedsUpdate(t){this._needsUpdate=this._needsUpdate||t,this._needsRedraw=this._needsRedraw||t}updateViewStates(){for(const t in this.controllers){const e=this.controllers[t];e&&e.updateTransition()}}getViewports(t){return t?this._viewports.filter((e=>e.containsPixel(t))):this._viewports}getViews(){const t={};return this.views.forEach((e=>{t[e.id]=e})),t}getView(t){return this.views.find((e=>e.id===t))}getViewState(t){const e="string"==typeof t?this.getView(t):t,i=e&&this.viewState[e.getViewStateId()]||this.viewState;return e?e.filterViewState(i):i}getViewport(t){return this._viewportMap[t]}unproject(t,e){const i=this.getViewports(),n={x:t[0],y:t[1]};for(let r=i.length-1;r>=0;--r){const s=i[r];if(s.containsPixel(n)){const i=t.slice();return i[0]-=s.x,i[1]-=s.y,s.unproject(i,e)}}return null}setProps(t){t.views&&this._setViews(t.views),t.viewState&&this._setViewState(t.viewState),("width"in t||"height"in t)&&this._setSize(t.width,t.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(t,e){t===this.width&&e===this.height||(this.width=t,this.height=e,this.setNeedsUpdate("Size changed"))}_setViews(t){t=$d(t,Boolean);this._diffViews(t,this.views)&&this.setNeedsUpdate("views changed"),this.views=t}_setViewState(t){if(t){!lp(t,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=t}else kr.warn("missing `viewState` or `initialViewState`")()}_onViewStateChange(t,e){this._eventCallbacks.onViewStateChange&&this._eventCallbacks.onViewStateChange({...e,viewId:t})}_createController(t,e){return new(0,e.type)({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._onViewStateChange.bind(this,e.id),onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:e=>{var i;return null===(i=this.getView(t.id))||void 0===i?void 0:i.makeViewport({viewState:e,width:this.width,height:this.height})}})}_updateController(t,e,i,n){const r=t.controller;if(r&&i){const s={...e,...r,id:t.id,x:i.x,y:i.y,width:i.width,height:i.height};return n&&n.constructor===r.type||(n=this._createController(t,s)),n&&n.setProps(s),n}return null}_rebuildViewports(){const{views:t}=this,e=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let n=t.length;n--;){const r=t[n],s=this.getViewState(r),o=r.makeViewport({viewState:s,width:this.width,height:this.height});let a=e[r.id];const l=Boolean(r.controller);l&&!a&&(i=!0),!i&&l||!a||(a.finalize(),a=null),this.controllers[r.id]=this._updateController(r,s,o,a),o&&this._viewports.unshift(o)}for(const t in e){const i=e[t];i&&!this.controllers[t]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach((t=>{t.id&&(this._viewportMap[t.id]=this._viewportMap[t.id]||t)}))}_diffViews(t,e){return t.length!==e.length||t.some(((i,n)=>!t[n].equals(e[n])))}}const hp=/([0-9]+\.?[0-9]*)(%|px)/;function up(t){switch(typeof t){case"number":return{position:t,relative:!1};case"string":const e=hp.exec(t);if(e&&e.length>=3){const t="%"===e[2],i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error("Could not parse position string ".concat(t))}}function dp(t,e){return t.relative?Math.round(t.position*e):t.position}function pp(t,e){if(!t)throw new Error(e||"deck.gl: assertion failed.")}class fp{constructor(t){He(this,"id",void 0),He(this,"viewportInstance",void 0),He(this,"_x",void 0),He(this,"_y",void 0),He(this,"_width",void 0),He(this,"_height",void 0),He(this,"_padding",void 0),He(this,"props",void 0);const{id:e,x:i=0,y:n=0,width:r="100%",height:s="100%",padding:o=null,viewportInstance:a}=t||{};pp(!a||a instanceof Pd),this.viewportInstance=a,this.id=e||this.constructor.displayName||"view",this.props={...t,id:this.id},this._x=up(i),this._y=up(n),this._width=up(r),this._height=up(s),this._padding=o&&{left:up(o.left||0),right:up(o.right||0),top:up(o.top||0),bottom:up(o.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(t){return this===t||(this.viewportInstance?!!t.viewportInstance&&this.viewportInstance.equals(t.viewportInstance):this.ViewportType===t.ViewportType&&lp(this.props,t.props,2))}makeViewport({width:t,height:e,viewState:i}){if(this.viewportInstance)return this.viewportInstance;i=this.filterViewState(i);const n=this.getDimensions({width:t,height:e});return n.height&&n.width?new this.ViewportType({...i,...this.props,...n}):null}getViewStateId(){const{viewState:t}=this.props;return"string"==typeof t?t:(null==t?void 0:t.id)||this.id}filterViewState(t){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;const e={...t};for(const t in this.props.viewState)"id"!==t&&(e[t]=this.props.viewState[t]);return e}return t}getDimensions({width:t,height:e}){const i={x:dp(this._x,t),y:dp(this._y,e),width:dp(this._width,t),height:dp(this._height,e)};return this._padding&&(i.padding={left:dp(this._padding.left,t),top:dp(this._padding.top,e),right:dp(this._padding.right,t),bottom:dp(this._padding.bottom,e)}),i}get controller(){const t=this.props.controller;return t?!0===t?{type:this.ControllerType}:"function"==typeof t?{type:t}:{type:this.ControllerType,...t}:null}}class mp{constructor(t){He(this,"_inProgress",void 0),He(this,"_handle",void 0),He(this,"_timeline",void 0),He(this,"time",void 0),He(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=t,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(t){var e,i;this.cancel(),this.settings=t,this._inProgress=!0,null===(e=(i=this.settings).onStart)||void 0===e||e.call(i,this)}end(){var t,e;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,null===(t=(e=this.settings).onEnd)||void 0===t||t.call(e,this))}cancel(){var t,e;this._inProgress&&(null===(t=(e=this.settings).onInterrupt)||void 0===t||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var t,e;if(!this._inProgress)return!1;if(null===this._handle){const{_timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),null===(t=(e=this.settings).onUpdate)||void 0===t||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const gp=()=>{},_p=2,yp=3,vp=t=>t,xp=1;class bp{constructor(t){He(this,"getControllerState",void 0),He(this,"props",void 0),He(this,"propsInTransition",void 0),He(this,"transition",void 0),He(this,"onViewStateChange",void 0),He(this,"onStateChange",void 0),He(this,"_onTransitionUpdate",(t=>{const{time:e,settings:{interpolator:i,startProps:n,endProps:r,duration:s,easing:o}}=t,a=o(e/s),l=i.interpolateProps(n,r,a);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})})),this.getControllerState=t.getControllerState,this.propsInTransition=null,this.transition=new mp(t.timeline),this.onViewStateChange=t.onViewStateChange||gp,this.onStateChange=t.onStateChange||gp}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(t){let e=!1;const i=this.props;if(this.props=t,!i||this._shouldIgnoreViewportChange(i,t))return!1;if(this._isTransitionEnabled(t)){let n=i;if(this.transition.inProgress){const{interruption:t,endProps:e}=this.transition.settings;n={...i,...t===_p?e:this.propsInTransition||i}}this._triggerTransition(n,t),e=!0}else this.transition.cancel();return e}updateTransition(){this.transition.update()}_isTransitionEnabled(t){const{transitionDuration:e,transitionInterpolator:i}=t;return(e>0||"auto"===e)&&Boolean(i)}_isUpdateDueToCurrentTransition(t){return!(!this.transition.inProgress||!this.propsInTransition)&&this.transition.settings.interpolator.arePropsEqual(t,this.propsInTransition)}_shouldIgnoreViewportChange(t,e){return this.transition.inProgress?this.transition.settings.interruption===yp||this._isUpdateDueToCurrentTransition(e):!this._isTransitionEnabled(e)||e.transitionInterpolator.arePropsEqual(t,e)}_triggerTransition(t,e){const i=this.getControllerState(t),n=this.getControllerState(e).shortestPathFrom(i),r=e.transitionInterpolator,s=r.getDuration?r.getDuration(t,e):e.transitionDuration;if(0===s)return;const o=r.initializeProps(t,n);this.propsInTransition={};const a={duration:s,easing:e.transitionEasing||vp,interpolator:r,interruption:e.transitionInterruption||xp,startProps:o.start,endProps:o.end,onStart:e.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(e.onTransitionInterrupt),onEnd:this._onTransitionEnd(e.onTransitionEnd)};this.transition.start(a),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(t){return e=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),null==t||t(e)}}}class wp{constructor(t){He(this,"_propsToCompare",void 0),He(this,"_propsToExtract",void 0),He(this,"_requiredProps",void 0);const{compare:e,extract:i,required:n}=t;this._propsToCompare=e,this._propsToExtract=i||e,this._requiredProps=n}arePropsEqual(t,e){for(const i of this._propsToCompare)if(!(i in t)||!(i in e)||!rc(t[i],e[i]))return!1;return!0}initializeProps(t,e){const i={},n={};for(const r of this._propsToExtract)(r in t||r in e)&&(i[r]=t[r],n[r]=e[r]);return this._checkRequiredProps(i),this._checkRequiredProps(n),{start:i,end:n}}getDuration(t,e){return e.transitionDuration}_checkRequiredProps(t){this._requiredProps&&this._requiredProps.forEach((e=>{const i=t[e];pp(Number.isFinite(i)||Array.isArray(i),"".concat(e," is required for transition"))}))}}const Ap=["longitude","latitude","zoom","bearing","pitch"],Tp=["longitude","latitude","zoom"];class Mp extends wp{constructor(t={}){const e=Array.isArray(t)?t:t.transitionProps,i=Array.isArray(t)?{}:t;i.transitionProps=Array.isArray(e)?{compare:e,required:e}:e||{compare:Ap,required:Tp},super(i.transitionProps),He(this,"opts",void 0),this.opts=i}initializeProps(t,e){const i=super.initializeProps(t,e),{makeViewport:n,around:r}=this.opts;if(n&&r){const s=n(t),o=n(e),a=s.unproject(r);i.start.around=r,Object.assign(i.end,{around:o.project(a),aroundPosition:a,width:e.width,height:e.height})}return i}interpolateProps(t,e,i){const n={};for(const r of this._propsToExtract)n[r]=nc(t[r]||0,e[r]||0,i);if(e.aroundPosition&&this.opts.makeViewport){const r=this.opts.makeViewport({...e,...n});Object.assign(n,r.panByPosition(e.aroundPosition,nc(t.around,e.around,i)))}return n}}const Sp={transitionDuration:0},Ep=t=>1-(1-t)*(1-t),Cp=["wheel"],Ip=["panstart","panmove","panend"],Pp=["pinchstart","pinchmove","pinchend"],Lp=["tripanstart","tripanmove","tripanend"],Rp=["doubletap"],Bp=["keydown"],Dp={};class Op{constructor(t){He(this,"props",void 0),He(this,"state",{}),He(this,"transitionManager",void 0),He(this,"eventManager",void 0),He(this,"onViewStateChange",void 0),He(this,"onStateChange",void 0),He(this,"makeViewport",void 0),He(this,"_controllerState",void 0),He(this,"_events",{}),He(this,"_interactionState",{isDragging:!1}),He(this,"_customEvents",[]),He(this,"_eventStartBlocked",null),He(this,"_panMove",!1),He(this,"invertPan",!1),He(this,"dragMode","rotate"),He(this,"inertia",0),He(this,"scrollZoom",!0),He(this,"dragPan",!0),He(this,"dragRotate",!0),He(this,"doubleClickZoom",!0),He(this,"touchZoom",!0),He(this,"touchRotate",!1),He(this,"keyboard",!0),this.transitionManager=new bp({...t,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=t.eventManager,this.onViewStateChange=t.onViewStateChange||(()=>{}),this.onStateChange=t.onStateChange||(()=>{}),this.makeViewport=t.makeViewport}set events(t){this.toggleEvents(this._customEvents,!1),this.toggleEvents(t,!0),this._customEvents=t,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events){var t;if(this._events[e])null===(t=this.eventManager)||void 0===t||t.off(e,this.handleEvent)}this.transitionManager.finalize()}handleEvent(t){this._controllerState=void 0;const e=this._eventStartBlocked;switch(t.type){case"panstart":return!e&&this._onPanStart(t);case"panmove":return this._onPan(t);case"panend":return this._onPanEnd(t);case"pinchstart":return!e&&this._onPinchStart(t);case"pinchmove":return this._onPinch(t);case"pinchend":return this._onPinchEnd(t);case"tripanstart":return!e&&this._onTriplePanStart(t);case"tripanmove":return this._onTriplePan(t);case"tripanend":return this._onTriplePanEnd(t);case"doubletap":return this._onDoubleTap(t);case"wheel":return this._onWheel(t);case"keydown":return this._onKeyDown(t);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(t){const{x:e,y:i}=this.props,{offsetCenter:n}=t;return[n.x-e,n.y-i]}isPointInBounds(t,e){const{width:i,height:n}=this.props;if(e&&e.handled)return!1;const r=t[0]>=0&&t[0]<=i&&t[1]>=0&&t[1]<=n;return r&&e&&e.stopPropagation(),r}isFunctionKeyPressed(t){const{srcEvent:e}=t;return Boolean(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(t){const e=setTimeout((()=>{this._eventStartBlocked===e&&(this._eventStartBlocked=null)}),t);this._eventStartBlocked=e}setProps(t){t.dragMode&&(this.dragMode=t.dragMode),this.props=t,"transitionInterpolator"in t||(t.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(t);const{inertia:e}=t;this.inertia=Number.isFinite(e)?e:!0===e?300:0;const{scrollZoom:i=!0,dragPan:n=!0,dragRotate:r=!0,doubleClickZoom:s=!0,touchZoom:o=!0,touchRotate:a=!1,keyboard:l=!0}=t,c=Boolean(this.onViewStateChange);this.toggleEvents(Cp,c&&i),this.toggleEvents(Ip,c),this.toggleEvents(Pp,c&&(o||a)),this.toggleEvents(Lp,c&&a),this.toggleEvents(Rp,c&&s),this.toggleEvents(Bp,c&&l),this.scrollZoom=i,this.dragPan=n,this.dragRotate=r,this.doubleClickZoom=s,this.touchZoom=o,this.touchRotate=a,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(t,e){this.eventManager&&t.forEach((t=>{this._events[t]!==e&&(this._events[t]=e,e?this.eventManager.on(t,this.handleEvent):this.eventManager.off(t,this.handleEvent))}))}updateViewport(t,e=null,i={}){const n={...t.getViewportProps(),...e},r=this.controllerState!==t;if(this.state=t.getState(),this._setInteractionState(i),r){const t=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:n,interactionState:this._interactionState,oldViewState:t})}}_onTransition(t){this.onViewStateChange({...t,interactionState:this._interactionState})}_setInteractionState(t){Object.assign(this._interactionState,t),this.onStateChange(this._interactionState)}_onPanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;let i=this.isFunctionKeyPressed(t)||t.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(i=!i);const n=this.controllerState[i?"panStart":"rotateStart"]({pos:e});return this._panMove=i,this.updateViewport(n,Sp,{isDragging:!0}),!0}_onPan(t){return!!this.isDragging()&&(this._panMove?this._onPanMove(t):this._onPanRotate(t))}_onPanEnd(t){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(t):this._onPanRotateEnd(t))}_onPanMove(t){if(!this.dragPan)return!1;const e=this.getCenter(t),i=this.controllerState.pan({pos:e});return this.updateViewport(i,Sp,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(t){const{inertia:e}=this;if(this.dragPan&&e&&t.velocity){const i=this.getCenter(t),n=this.controllerState.pan({pos:[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2]}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Ep},{isDragging:!1,isPanning:!0})}else{const t=this.controllerState.panEnd();this.updateViewport(t,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(t){if(!this.dragRotate)return!1;const e=this.getCenter(t),i=this.controllerState.rotate({pos:e});return this.updateViewport(i,Sp,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(t){const{inertia:e}=this;if(this.dragRotate&&e&&t.velocity){const i=this.getCenter(t),n=this.controllerState.rotate({pos:[i[0]+t.velocityX*e/2,i[1]+t.velocityY*e/2]}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Ep},{isDragging:!1,isRotating:!0})}else{const t=this.controllerState.rotateEnd();this.updateViewport(t,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(t){if(!this.scrollZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;t.srcEvent.preventDefault();const{speed:i=.01,smooth:n=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:r}=t;let s=2/(1+Math.exp(-Math.abs(r*i)));r<0&&0!==s&&(s=1/s);const o=this.controllerState.zoom({pos:e,scale:s});return this.updateViewport(o,{...this._getTransitionProps({around:e}),transitionDuration:n?250:1},{isZooming:!0,isPanning:!0}),!0}_onTriplePanStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.rotateStart({pos:e});return this.updateViewport(i,Sp,{isDragging:!0}),!0}_onTriplePan(t){if(!this.touchRotate)return!1;if(!this.isDragging())return!1;const e=this.getCenter(t);e[0]-=t.deltaX;const i=this.controllerState.rotate({pos:e});return this.updateViewport(i,Sp,{isDragging:!0,isRotating:!0}),!0}_onTriplePanEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this;if(this.touchRotate&&e&&t.velocityY){const i=this.getCenter(t),n=[i[0],i[1]+=t.velocityY*e/2],r=this.controllerState.rotate({pos:n});this.updateViewport(r,{...this._getTransitionProps(),transitionDuration:e,transitionEasing:Ep},{isDragging:!1,isRotating:!0}),this.blockEvents(e)}else{const t=this.controllerState.rotateEnd();this.updateViewport(t,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(t){const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.controllerState.zoomStart({pos:e}).rotateStart({pos:e});return Dp._startPinchRotation=t.rotation,Dp._lastPinchEvent=t,this.updateViewport(i,Sp,{isDragging:!0}),!0}_onPinch(t){if(!this.touchZoom&&!this.touchRotate)return!1;if(!this.isDragging())return!1;let e=this.controllerState;if(this.touchZoom){const{scale:i}=t,n=this.getCenter(t);e=e.zoom({pos:n,scale:i})}if(this.touchRotate){const{rotation:i}=t;e=e.rotate({deltaAngleX:Dp._startPinchRotation-i})}return this.updateViewport(e,Sp,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Dp._lastPinchEvent=t,!0}_onPinchEnd(t){if(!this.isDragging())return!1;const{inertia:e}=this,{_lastPinchEvent:i}=Dp;if(this.touchZoom&&e&&i&&t.scale!==i.scale){const n=this.getCenter(t);let r=this.controllerState.rotateEnd();const s=Math.log2(t.scale),o=(s-Math.log2(i.scale))/(t.deltaTime-i.deltaTime),a=Math.pow(2,s+o*e/2);r=r.zoom({pos:n,scale:a}).zoomEnd(),this.updateViewport(r,{...this._getTransitionProps({around:n}),transitionDuration:e,transitionEasing:Ep},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(e)}else{const t=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(t,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Dp._startPinchRotation=null,Dp._lastPinchEvent=null,!0}_onDoubleTap(t){if(!this.doubleClickZoom)return!1;const e=this.getCenter(t);if(!this.isPointInBounds(e,t))return!1;const i=this.isFunctionKeyPressed(t),n=this.controllerState.zoom({pos:e,scale:i?.5:2});return this.updateViewport(n,this._getTransitionProps({around:e}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(t){if(!this.keyboard)return!1;const e=this.isFunctionKeyPressed(t),{zoomSpeed:i,moveSpeed:n,rotateSpeedX:r,rotateSpeedY:s}=!0===this.keyboard?{}:this.keyboard,{controllerState:o}=this;let a;const l={};switch(t.srcEvent.code){case"Minus":a=e?o.zoomOut(i).zoomOut(i):o.zoomOut(i),l.isZooming=!0;break;case"Equal":a=e?o.zoomIn(i).zoomIn(i):o.zoomIn(i),l.isZooming=!0;break;case"ArrowLeft":e?(a=o.rotateLeft(r),l.isRotating=!0):(a=o.moveLeft(n),l.isPanning=!0);break;case"ArrowRight":e?(a=o.rotateRight(r),l.isRotating=!0):(a=o.moveRight(n),l.isPanning=!0);break;case"ArrowUp":e?(a=o.rotateUp(s),l.isRotating=!0):(a=o.moveUp(n),l.isPanning=!0);break;case"ArrowDown":e?(a=o.rotateDown(s),l.isRotating=!0):(a=o.moveDown(n),l.isPanning=!0);break;default:return!1}return this.updateViewport(a,this._getTransitionProps(),l),!0}_getTransitionProps(t){const{transition:e}=this;return e&&e.transitionInterpolator?t?{...e,transitionInterpolator:new Mp({...t,...e.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:e:Sp}}class kp{constructor(t,e){He(this,"_viewportProps",void 0),He(this,"_state",void 0),this._viewportProps=this.applyConstraints(t),this._state=e}getViewportProps(){return this._viewportProps}getState(){return this._state}}class Fp extends kp{constructor(t){const{width:e,height:i,latitude:n,longitude:r,zoom:s,bearing:o=0,pitch:a=0,altitude:l=1.5,position:c=[0,0,0],maxZoom:h=20,minZoom:u=0,maxPitch:d=60,minPitch:p=0,startPanLngLat:f,startZoomLngLat:m,startRotatePos:g,startBearing:_,startPitch:y,startZoom:v,normalize:x=!0}=t;pp(Number.isFinite(r)),pp(Number.isFinite(n)),pp(Number.isFinite(s)),super({width:e,height:i,latitude:n,longitude:r,zoom:s,bearing:o,pitch:a,altitude:l,maxZoom:h,minZoom:u,maxPitch:d,minPitch:p,normalize:x,position:c},{startPanLngLat:f,startZoomLngLat:m,startRotatePos:g,startBearing:_,startPitch:y,startZoom:v}),He(this,"makeViewport",void 0),this.makeViewport=t.makeViewport}panStart({pos:t}){return this._getUpdatedState({startPanLngLat:this._unproject(t)})}pan({pos:t,startPos:e}){const i=this.getState().startPanLngLat||this._unproject(e);if(!i)return this;const n=this.makeViewport(this.getViewportProps()).panByPosition(i,t);return this._getUpdatedState(n)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:t}){return this._getUpdatedState({startRotatePos:t,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:t,deltaAngleX:e=0,deltaAngleY:i=0}){const{startRotatePos:n,startBearing:r,startPitch:s}=this.getState();if(!n||void 0===r||void 0===s)return this;let o;return o=t?this._getNewRotation(t,n,s,r):{bearing:r+e,pitch:s+i},this._getUpdatedState(o)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:t}){return this._getUpdatedState({startZoomLngLat:this._unproject(t),startZoom:this.getViewportProps().zoom})}zoom({pos:t,startPos:e,scale:i}){let{startZoom:n,startZoomLngLat:r}=this.getState();if(r||(n=this.getViewportProps().zoom,r=this._unproject(e)||this._unproject(t)),!r)return this;const{maxZoom:s,minZoom:o}=this.getViewportProps();let a=n+Math.log2(i);a=ic(a,o,s);const l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(r,t)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(t=2){return this._zoomFromCenter(t)}zoomOut(t=2){return this._zoomFromCenter(1/t)}moveLeft(t=100){return this._panFromCenter([t,0])}moveRight(t=100){return this._panFromCenter([-t,0])}moveUp(t=100){return this._panFromCenter([0,t])}moveDown(t=100){return this._panFromCenter([0,-t])}rotateLeft(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-t})}rotateRight(t=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+t})}rotateUp(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+t})}rotateDown(t=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-t})}shortestPathFrom(t){const e=t.getViewportProps(),i={...this.getViewportProps()},{bearing:n,longitude:r}=i;return Math.abs(n-e.bearing)>180&&(i.bearing=n<0?n+360:n-360),Math.abs(r-e.longitude)>180&&(i.longitude=r<0?r+360:r-360),i}applyConstraints(t){const{maxZoom:e,minZoom:i,zoom:n}=t;t.zoom=ic(n,i,e);const{maxPitch:r,minPitch:s,pitch:o}=t;t.pitch=ic(o,s,r);const{normalize:a=!0}=t;return a&&Object.assign(t,function(t){const{width:e,height:i,pitch:n=0}=t;let{longitude:r,latitude:s,zoom:o,bearing:a=0}=t;(r<-180||r>180)&&(r=Nu(r+180,360)-180),(a<-180||a>180)&&(a=Nu(a+180,360)-180);const l=Gu(i/512);if(o<=l)o=l,s=0;else{const t=i/2/Math.pow(2,o),e=Ku([0,t])[1];if(s<e)s=e;else{const e=Ku([0,512-t])[1];s>e&&(s=e)}}return{width:e,height:i,longitude:r,latitude:s,zoom:o,pitch:n,bearing:a}}(t)),t}_zoomFromCenter(t){const{width:e,height:i}=this.getViewportProps();return this.zoom({pos:[e/2,i/2],scale:t})}_panFromCenter(t){const{width:e,height:i}=this.getViewportProps();return this.pan({startPos:[e/2,i/2],pos:[e/2+t[0],i/2+t[1]]})}_getUpdatedState(t){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...t})}_unproject(t){const e=this.makeViewport(this.getViewportProps());return t&&e.unproject(t)}_getNewRotation(t,e,i,n){const r=t[0]-e[0],s=t[1]-e[1],o=t[1],a=e[1],{width:l,height:c}=this.getViewportProps(),h=r/l;let u=0;s>0?Math.abs(c-a)>5&&(u=s/(a-c)*1.2):s<0&&a>5&&(u=1-o/a),u=ic(u,-1,1);const{minPitch:d,maxPitch:p}=this.getViewportProps();let f=i;return u>0?f=i+u*(p-i):u<0&&(f=i-u*(d-i)),{pitch:f,bearing:n+180*h}}}class zp extends Op{constructor(...t){super(...t),He(this,"ControllerState",Fp),He(this,"transition",{transitionDuration:300,transitionInterpolator:new Mp({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})}),He(this,"dragMode","pan")}setProps(t){t.position=t.position||[0,0,0];const e=this.props;super.setProps(t);(!e||e.height!==t.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...t,...this.state}))}}class Np extends fp{get ViewportType(){return Ld}get ControllerType(){return zp}}He(Np,"displayName","MapView");const Up=new yd;class Gp{constructor(){He(this,"effects",void 0),He(this,"_resolvedEffects",[]),He(this,"_defaultEffects",[]),He(this,"_needsRedraw",void 0),this.effects=[],this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(t){const e=this._defaultEffects;if(!e.find((e=>e.id===t.id))){const i=e.findIndex((e=>{return(null!==(i=e.order)&&void 0!==i?i:1/0)-(null!==(n=t.order)&&void 0!==n?n:1/0)>0;var i,n}));i<0?e.push(t):e.splice(i,0,t),this._setEffects(this.effects)}}setProps(t){"effects"in t&&(lp(t.effects,this.effects,1)||this._setEffects(t.effects))}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}getEffects(){return this._resolvedEffects}_setEffects(t){const e={};for(const t of this.effects)e[t.id]=t;const i=[];for(const n of t){const t=e[n.id];t&&t!==n?t.setProps?(t.setProps(n.props),i.push(t)):(t.cleanup(),i.push(n)):i.push(n),delete e[n.id]}for(const t in e)e[t].cleanup();this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),t.some((t=>t instanceof yd))||this._resolvedEffects.push(Up),this._needsRedraw="effects changed"}finalize(){for(const t of this._resolvedEffects)t.cleanup();this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class Vp extends yu{shouldDrawLayer(t){const{operation:e}=t.props;return e.includes("draw")||e.includes("terrain")}}class jp{constructor(t){He(this,"gl",void 0),He(this,"layerFilter",void 0),He(this,"drawPickingColors",void 0),He(this,"drawLayersPass",void 0),He(this,"pickLayersPass",void 0),He(this,"renderCount",void 0),He(this,"_needsRedraw",void 0),He(this,"renderBuffers",void 0),He(this,"lastPostProcessEffect",void 0),this.gl=t,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new Vp(t),this.pickLayersPass=new Fd(t),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(t){this.layerFilter!==t.layerFilter&&(this.layerFilter=t.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==t.drawPickingColors&&(this.drawPickingColors=t.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(t){if(!t.viewports.length)return;const e=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...t,target:t.target||Wo.getDefaultFramebuffer(this.gl)};i.effects&&this._preRender(i.effects,i);const n=this.lastPostProcessEffect?this.renderBuffers[0]:i.target,r=e.render({...i,target:n});i.effects&&this._postRender(i.effects,i),this.renderCount++,Nr("deckRenderer.renderLayers",this,r,t)}needsRedraw(t={clearRedrawFlags:!1}){const e=this._needsRedraw;return t.clearRedrawFlags&&(this._needsRedraw=!1),e}finalize(){const{renderBuffers:t}=this;for(const e of t)e.delete();t.length=0}_preRender(t,e){this.lastPostProcessEffect=null,e.preRenderStats=e.preRenderStats||{};for(const i of t)e.preRenderStats[i.id]=i.preRender(this.gl,e),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:t}=this;0===t.length&&t.push(new Wo(this.gl),new Wo(this.gl));for(const e of t)e.resize()}_postRender(t,e){const{renderBuffers:i}=this,n={...e,inputBuffer:i[0],swapBuffer:i[1],target:null};for(const r of t)if(r.postRender){if(r.id===this.lastPostProcessEffect){n.target=e.target,r.postRender(this.gl,n);break}const t=r.postRender(this.gl,n);n.inputBuffer=t,n.swapBuffer=t===i[0]?i[1]:i[0]}}}const Hp={pickedColor:null,pickedObjectIndex:-1};function Wp({pickedColors:t,decodePickingColor:e,deviceX:i,deviceY:n,deviceRadius:r,deviceRect:s}){const{x:o,y:a,width:l,height:c}=s;let h=r*r,u=-1,d=0;for(let e=0;e<c;e++){const r=e+a-n,s=r*r;if(s>h)d+=4*l;else for(let e=0;e<l;e++){if(t[d+3]-1>=0){const t=e+o-i,n=t*t+s;n<=h&&(h=n,u=d)}d+=4}}if(u>=0){const i=t.slice(u,u+4),n=e(i);if(n){const t=Math.floor(u/4/l),e=u/4-t*l;return{...n,pickedColor:i,pickedX:o+e,pickedY:a+t}}}return Hp}function qp({pickInfo:t,viewports:e,pixelRatio:i,x:n,y:r,z:s}){let o,a=e[0];if(e.length>1&&(a=function(t,e){for(let i=t.length-1;i>=0;i--){const n=t[i];if(n.containsPixel(e))return n}return t[0]}((null==t?void 0:t.pickedViewports)||e,{x:n,y:r})),a){const t=[n-a.x,r-a.y];void 0!==s&&(t[2]=s),o=a.unproject(t)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:n,y:r,pixel:[n,r],coordinate:o,devicePixel:t&&"pickedX"in t?[t.pickedX,t.pickedY]:void 0,pixelRatio:i}}function Xp(t){const{pickInfo:e,lastPickedInfo:i,mode:n,layers:r}=t,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=e,l=o?[o]:[];if("hover"===n){const t=i.layerId,e=o?o.props.id:null;if(e!==t||a!==i.index){if(e!==t){const e=r.find((e=>e.props.id===t));e&&l.unshift(e)}i.layerId=e,i.index=a,i.info=null}}const c=qp(t),h=new Map;return h.set(null,c),l.forEach((t=>{let e={...c};t===o&&(e.color=s,e.index=a,e.picked=!0),e=Zp({layer:t,info:e,mode:n});const r=e.layer;t===o&&"hover"===n&&(i.info=e),h.set(r.id,e),"hover"===n&&r.updateAutoHighlight(e)})),h}function Zp({layer:t,info:e,mode:i}){for(;t&&e;){const n=e.layer||null;e.sourceLayer=n,e.layer=t,e=t.getPickingInfo({info:e,mode:i,sourceLayer:n}),t=t.parent}return e}class Jp{constructor(t){He(this,"gl",void 0),He(this,"pickingFBO",void 0),He(this,"depthFBO",void 0),He(this,"pickLayersPass",void 0),He(this,"layerFilter",void 0),He(this,"lastPickedInfo",void 0),He(this,"_pickable",!0),this.gl=t,this.pickLayersPass=new Fd(t),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(t){"layerFilter"in t&&(this.layerFilter=t.layerFilter),"_pickable"in t&&(this._pickable=t._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.delete(),this.depthFBO&&(this.depthFBO.color.delete(),this.depthFBO.delete())}pickObject(t){return this._pickClosestObject(t)}pickObjects(t){return this._pickVisibleObjects(t)}getLastPickedObject({x:t,y:e,layers:i,viewports:n},r=this.lastPickedInfo.info){const s=r&&r.layer&&r.layer.id,o=r&&r.viewport&&r.viewport.id,a=s?i.find((t=>t.id===s)):null,l=o&&n.find((t=>t.id===o))||n[0],c=l&&l.unproject([t-l.x,e-l.y]),h={x:t,y:e,viewport:l,coordinate:c,layer:a};return{...r,...h}}_resizeBuffer(){var t,e;const{gl:i}=this;if(!this.pickingFBO&&(this.pickingFBO=new Wo(i),Wo.isSupported(i,{colorBufferFloat:!0}))){const t=new Wo(i);t.attach({36064:new wo(i,{format:Yr(i)?34836:6408,type:5126})}),this.depthFBO=t}null===(t=this.pickingFBO)||void 0===t||t.resize({width:i.canvas.width,height:i.canvas.height}),null===(e=this.depthFBO)||void 0===e||e.resize({width:i.canvas.width,height:i.canvas.height})}_getPickable(t){if(!1===this._pickable)return null;const e=t.filter((t=>this.pickLayersPass.shouldDrawLayer(t)&&!t.isComposite));return e.length?e:null}_pickClosestObject({layers:t,views:e,viewports:i,x:n,y:r,radius:s=0,depth:o=1,mode:a="query",unproject3D:l,onViewportActive:c,effects:h}){const u=this._getPickable(t),d=Rs(this.gl);if(!u)return{result:[],emptyInfo:qp({viewports:i,x:n,y:r,pixelRatio:d})};this._resizeBuffer();const p=Bs(this.gl,[n,r],!0),f=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(s*d),{width:g,height:_}=this.pickingFBO,y=this._getPickingRect({deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceWidth:g,deviceHeight:_}),v={x:n-s,y:r-s,width:2*s+1,height:2*s+1};let x;const b=[],w=new Set;for(let t=0;t<o;t++){let s,p;if(y){s=Wp({...this._drawAndSample({layers:u,views:e,viewports:i,onViewportActive:c,deviceRect:y,cullRect:v,effects:h,pass:"picking:".concat(a)}),deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceRect:y})}else s={pickedColor:null,pickedObjectIndex:-1};if(s.pickedLayer&&l&&this.depthFBO){const{pickedColors:t}=this._drawAndSample({layers:[s.pickedLayer],views:e,viewports:i,onViewportActive:c,deviceRect:{x:s.pickedX,y:s.pickedY,width:1,height:1},cullRect:v,effects:h,pass:"picking:".concat(a,":z")},!0);t[3]&&(p=t[0])}s.pickedLayer&&t+1<o&&(w.add(s.pickedLayer),s.pickedLayer.disablePickingIndex(s.pickedObjectIndex)),x=Xp({pickInfo:s,lastPickedInfo:this.lastPickedInfo,mode:a,layers:u,viewports:i,x:n,y:r,z:p,pixelRatio:d});for(const t of x.values())t.layer&&b.push(t);if(!s.pickedColor)break}for(const t of w)t.restorePickingColors();return{result:b,emptyInfo:x.get(null)}}_pickVisibleObjects({layers:t,views:e,viewports:i,x:n,y:r,width:s=1,height:o=1,mode:a="query",maxObjects:l=null,onViewportActive:c,effects:h}){const u=this._getPickable(t);if(!u)return[];this._resizeBuffer();const d=Rs(this.gl),p=Bs(this.gl,[n,r],!0),f=p.x,m=p.y+p.height,g=Bs(this.gl,[n+s,r+o],!0),_=g.y,y=function({pickedColors:t,decodePickingColor:e}){const i=new Map;if(t)for(let n=0;n<t.length;n+=4)if(t[n+3]-1>=0){const r=t.slice(n,n+4),s=r.join(",");if(!i.has(s)){const t=e(r);t&&i.set(s,{...t,color:r})}}return Array.from(i.values())}(this._drawAndSample({layers:u,views:e,viewports:i,onViewportActive:c,deviceRect:{x:f,y:_,width:g.x+g.width-f,height:m-_},cullRect:{x:n,y:r,width:s,height:o},effects:h,pass:"picking:".concat(a)})),v=new Map,x=Number.isFinite(l);for(let t=0;t<y.length;t++){var b;if(x&&l&&v.size>=l)break;const e=y[t];let i={color:e.pickedColor,layer:null,index:e.pickedObjectIndex,picked:!0,x:n,y:r,pixelRatio:d};i=Zp({layer:e.pickedLayer,info:i,mode:a});const s=null!==(b=i.object)&&void 0!==b?b:"".concat(i.layer.id,"[").concat(i.index,"]");v.has(s)||v.set(s,i)}return Array.from(v.values())}_drawAndSample({layers:t,views:e,viewports:i,onViewportActive:n,deviceRect:r,cullRect:s,effects:o,pass:a},l=!1){const c=l?this.depthFBO:this.pickingFBO,h={layers:t,layerFilter:this.layerFilter,views:e,viewports:i,onViewportActive:n,pickingFBO:c,deviceRect:r,cullRect:s,effects:o,pass:a,pickZ:l,preRenderStats:{}};for(const t of o)t.useInPicking&&(h.preRenderStats[t.id]=t.preRender(this.gl,h));const{decodePickingColor:u}=this.pickLayersPass.render(h),{x:d,y:p,width:f,height:m}=r,g=new(l?Float32Array:Uint8Array)(f*m*4);return Ro(c,{sourceX:d,sourceY:p,sourceWidth:f,sourceHeight:m,target:g}),{pickedColors:g,decodePickingColor:u}}_getPickingRect({deviceX:t,deviceY:e,deviceRadius:i,deviceWidth:n,deviceHeight:r}){const s=Math.max(0,t-i),o=Math.max(0,e-i),a=Math.min(n,t+i+1)-s,l=Math.min(r,e+i+1)-o;return a<=0||l<=0?null:{x:s,y:o,width:a,height:l}}}const Yp={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class $p{constructor(t){He(this,"el",null),He(this,"isVisible",!1);const e=t.parentElement;e&&(this.el=document.createElement("div"),this.el.className="deck-tooltip",Object.assign(this.el.style,Yp),e.appendChild(this.el))}setTooltip(t,e,i){const n=this.el;if(n){if("string"==typeof t)n.innerText=t;else{if(!t)return this.isVisible=!1,void(n.style.display="none");t.text&&(n.innerText=t.text),t.html&&(n.innerHTML=t.html),t.className&&(n.className=t.className)}this.isVisible=!0,n.style.display="block",n.style.transform="translate(".concat(e,"px, ").concat(i,"px)"),t&&"object"==typeof t&&"style"in t&&Object.assign(n.style,t.style)}}remove(){this.el&&(this.el.remove(),this.el=null)}}var Kp={exports:{}};
/*! Hammer.JS - v2.0.7 - 2016-04-22
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */!function(t){!function(e,i,n,r){var s,o=["","webkit","Moz","MS","ms","o"],a=i.createElement("div"),l="function",c=Math.round,h=Math.abs,u=Date.now;function d(t,e,i){return setTimeout(v(t,i),e)}function p(t,e,i){return!!Array.isArray(t)&&(f(t,i[e],i),!0)}function f(t,e,i){var n;if(t)if(t.forEach)t.forEach(e,i);else if(t.length!==r)for(n=0;n<t.length;)e.call(i,t[n],n,t),n++;else for(n in t)t.hasOwnProperty(n)&&e.call(i,t[n],n,t)}function m(t,i,n){var r="DEPRECATED METHOD: "+i+"\n"+n+" AT \n";return function(){var i=new Error("get-stack-trace"),n=i&&i.stack?i.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",s=e.console&&(e.console.warn||e.console.log);return s&&s.call(e.console,r,n),t.apply(this,arguments)}}s="function"!=typeof Object.assign?function(t){if(t===r||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var n=arguments[i];if(n!==r&&null!==n)for(var s in n)n.hasOwnProperty(s)&&(e[s]=n[s])}return e}:Object.assign;var g=m((function(t,e,i){for(var n=Object.keys(e),s=0;s<n.length;)(!i||i&&t[n[s]]===r)&&(t[n[s]]=e[n[s]]),s++;return t}),"extend","Use `assign`."),_=m((function(t,e){return g(t,e,!0)}),"merge","Use `assign`.");function y(t,e,i){var n,r=e.prototype;(n=t.prototype=Object.create(r)).constructor=t,n._super=r,i&&s(n,i)}function v(t,e){return function(){return t.apply(e,arguments)}}function x(t,e){return typeof t==l?t.apply(e&&e[0]||r,e):t}function b(t,e){return t===r?e:t}function w(t,e,i){f(S(e),(function(e){t.addEventListener(e,i,!1)}))}function A(t,e,i){f(S(e),(function(e){t.removeEventListener(e,i,!1)}))}function T(t,e){for(;t;){if(t==e)return!0;t=t.parentNode}return!1}function M(t,e){return t.indexOf(e)>-1}function S(t){return t.trim().split(/\s+/g)}function E(t,e,i){if(t.indexOf&&!i)return t.indexOf(e);for(var n=0;n<t.length;){if(i&&t[n][i]==e||!i&&t[n]===e)return n;n++}return-1}function C(t){return Array.prototype.slice.call(t,0)}function I(t,e,i){for(var n=[],r=[],s=0;s<t.length;){var o=e?t[s][e]:t[s];E(r,o)<0&&n.push(t[s]),r[s]=o,s++}return i&&(n=e?n.sort((function(t,i){return t[e]>i[e]})):n.sort()),n}function P(t,e){for(var i,n,s=e[0].toUpperCase()+e.slice(1),a=0;a<o.length;){if((n=(i=o[a])?i+s:e)in t)return n;a++}return r}var L=1;function R(t){var i=t.ownerDocument||t;return i.defaultView||i.parentWindow||e}var B="ontouchstart"in e,D=P(e,"PointerEvent")!==r,O=B&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),k="touch",F="mouse",z=25,N=1,U=4,G=8,V=1,j=2,H=4,W=8,q=16,X=j|H,Z=W|q,J=X|Z,Y=["x","y"],$=["clientX","clientY"];function K(t,e){var i=this;this.manager=t,this.callback=e,this.element=t.element,this.target=t.options.inputTarget,this.domHandler=function(e){x(t.options.enable,[t])&&i.handler(e)},this.init()}function Q(t,e,i){var n=i.pointers.length,s=i.changedPointers.length,o=e&N&&n-s==0,a=e&(U|G)&&n-s==0;i.isFirst=!!o,i.isFinal=!!a,o&&(t.session={}),i.eventType=e,function(t,e){var i=t.session,n=e.pointers,s=n.length;i.firstInput||(i.firstInput=tt(e));s>1&&!i.firstMultiple?i.firstMultiple=tt(e):1===s&&(i.firstMultiple=!1);var o=i.firstInput,a=i.firstMultiple,l=a?a.center:o.center,c=e.center=et(n);e.timeStamp=u(),e.deltaTime=e.timeStamp-o.timeStamp,e.angle=st(l,c),e.distance=rt(l,c),function(t,e){var i=e.center,n=t.offsetDelta||{},r=t.prevDelta||{},s=t.prevInput||{};e.eventType!==N&&s.eventType!==U||(r=t.prevDelta={x:s.deltaX||0,y:s.deltaY||0},n=t.offsetDelta={x:i.x,y:i.y});e.deltaX=r.x+(i.x-n.x),e.deltaY=r.y+(i.y-n.y)}(i,e),e.offsetDirection=nt(e.deltaX,e.deltaY);var d=it(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=d.x,e.overallVelocityY=d.y,e.overallVelocity=h(d.x)>h(d.y)?d.x:d.y,e.scale=a?(p=a.pointers,f=n,rt(f[0],f[1],$)/rt(p[0],p[1],$)):1,e.rotation=a?function(t,e){return st(e[1],e[0],$)+st(t[1],t[0],$)}(a.pointers,n):0,e.maxPointers=i.prevInput?e.pointers.length>i.prevInput.maxPointers?e.pointers.length:i.prevInput.maxPointers:e.pointers.length,function(t,e){var i,n,s,o,a=t.lastInterval||e,l=e.timeStamp-a.timeStamp;if(e.eventType!=G&&(l>z||a.velocity===r)){var c=e.deltaX-a.deltaX,u=e.deltaY-a.deltaY,d=it(l,c,u);n=d.x,s=d.y,i=h(d.x)>h(d.y)?d.x:d.y,o=nt(c,u),t.lastInterval=e}else i=a.velocity,n=a.velocityX,s=a.velocityY,o=a.direction;e.velocity=i,e.velocityX=n,e.velocityY=s,e.direction=o}(i,e);var p,f;var m=t.element;T(e.srcEvent.target,m)&&(m=e.srcEvent.target);e.target=m}(t,i),t.emit("hammer.input",i),t.recognize(i),t.session.prevInput=i}function tt(t){for(var e=[],i=0;i<t.pointers.length;)e[i]={clientX:c(t.pointers[i].clientX),clientY:c(t.pointers[i].clientY)},i++;return{timeStamp:u(),pointers:e,center:et(e),deltaX:t.deltaX,deltaY:t.deltaY}}function et(t){var e=t.length;if(1===e)return{x:c(t[0].clientX),y:c(t[0].clientY)};for(var i=0,n=0,r=0;r<e;)i+=t[r].clientX,n+=t[r].clientY,r++;return{x:c(i/e),y:c(n/e)}}function it(t,e,i){return{x:e/t||0,y:i/t||0}}function nt(t,e){return t===e?V:h(t)>=h(e)?t<0?j:H:e<0?W:q}function rt(t,e,i){i||(i=Y);var n=e[i[0]]-t[i[0]],r=e[i[1]]-t[i[1]];return Math.sqrt(n*n+r*r)}function st(t,e,i){return i||(i=Y),180*Math.atan2(e[i[1]]-t[i[1]],e[i[0]]-t[i[0]])/Math.PI}K.prototype={handler:function(){},init:function(){this.evEl&&w(this.element,this.evEl,this.domHandler),this.evTarget&&w(this.target,this.evTarget,this.domHandler),this.evWin&&w(R(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&A(this.element,this.evEl,this.domHandler),this.evTarget&&A(this.target,this.evTarget,this.domHandler),this.evWin&&A(R(this.element),this.evWin,this.domHandler)}};var ot={mousedown:N,mousemove:2,mouseup:U},at="mousedown",lt="mousemove mouseup";function ct(){this.evEl=at,this.evWin=lt,this.pressed=!1,K.apply(this,arguments)}y(ct,K,{handler:function(t){var e=ot[t.type];e&N&&0===t.button&&(this.pressed=!0),2&e&&1!==t.which&&(e=U),this.pressed&&(e&U&&(this.pressed=!1),this.callback(this.manager,e,{pointers:[t],changedPointers:[t],pointerType:F,srcEvent:t}))}});var ht={pointerdown:N,pointermove:2,pointerup:U,pointercancel:G,pointerout:G},ut={2:k,3:"pen",4:F,5:"kinect"},dt="pointerdown",pt="pointermove pointerup pointercancel";function ft(){this.evEl=dt,this.evWin=pt,K.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}e.MSPointerEvent&&!e.PointerEvent&&(dt="MSPointerDown",pt="MSPointerMove MSPointerUp MSPointerCancel"),y(ft,K,{handler:function(t){var e=this.store,i=!1,n=t.type.toLowerCase().replace("ms",""),r=ht[n],s=ut[t.pointerType]||t.pointerType,o=s==k,a=E(e,t.pointerId,"pointerId");r&N&&(0===t.button||o)?a<0&&(e.push(t),a=e.length-1):r&(U|G)&&(i=!0),a<0||(e[a]=t,this.callback(this.manager,r,{pointers:e,changedPointers:[t],pointerType:s,srcEvent:t}),i&&e.splice(a,1))}});var mt={touchstart:N,touchmove:2,touchend:U,touchcancel:G};function gt(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,K.apply(this,arguments)}function _t(t,e){var i=C(t.touches),n=C(t.changedTouches);return e&(U|G)&&(i=I(i.concat(n),"identifier",!0)),[i,n]}y(gt,K,{handler:function(t){var e=mt[t.type];if(e===N&&(this.started=!0),this.started){var i=_t.call(this,t,e);e&(U|G)&&i[0].length-i[1].length==0&&(this.started=!1),this.callback(this.manager,e,{pointers:i[0],changedPointers:i[1],pointerType:k,srcEvent:t})}}});var yt={touchstart:N,touchmove:2,touchend:U,touchcancel:G},vt="touchstart touchmove touchend touchcancel";function xt(){this.evTarget=vt,this.targetIds={},K.apply(this,arguments)}function bt(t,e){var i=C(t.touches),n=this.targetIds;if(e&(2|N)&&1===i.length)return n[i[0].identifier]=!0,[i,i];var r,s,o=C(t.changedTouches),a=[],l=this.target;if(s=i.filter((function(t){return T(t.target,l)})),e===N)for(r=0;r<s.length;)n[s[r].identifier]=!0,r++;for(r=0;r<o.length;)n[o[r].identifier]&&a.push(o[r]),e&(U|G)&&delete n[o[r].identifier],r++;return a.length?[I(s.concat(a),"identifier",!0),a]:void 0}y(xt,K,{handler:function(t){var e=yt[t.type],i=bt.call(this,t,e);i&&this.callback(this.manager,e,{pointers:i[0],changedPointers:i[1],pointerType:k,srcEvent:t})}});var wt=2500;function At(){K.apply(this,arguments);var t=v(this.handler,this);this.touch=new xt(this.manager,t),this.mouse=new ct(this.manager,t),this.primaryTouch=null,this.lastTouches=[]}function Tt(t,e){t&N?(this.primaryTouch=e.changedPointers[0].identifier,Mt.call(this,e)):t&(U|G)&&Mt.call(this,e)}function Mt(t){var e=t.changedPointers[0];if(e.identifier===this.primaryTouch){var i={x:e.clientX,y:e.clientY};this.lastTouches.push(i);var n=this.lastTouches;setTimeout((function(){var t=n.indexOf(i);t>-1&&n.splice(t,1)}),wt)}}function St(t){for(var e=t.srcEvent.clientX,i=t.srcEvent.clientY,n=0;n<this.lastTouches.length;n++){var r=this.lastTouches[n],s=Math.abs(e-r.x),o=Math.abs(i-r.y);if(s<=25&&o<=25)return!0}return!1}y(At,K,{handler:function(t,e,i){var n=i.pointerType==F;if(!(n&&i.sourceCapabilities&&i.sourceCapabilities.firesTouchEvents)){if(i.pointerType==k)Tt.call(this,e,i);else if(n&&St.call(this,i))return;this.callback(t,e,i)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Et=P(a.style,"touchAction"),Ct=Et!==r,It="compute",Pt="auto",Lt="manipulation",Rt="none",Bt="pan-x",Dt="pan-y",Ot=function(){if(!Ct)return!1;var t={},i=e.CSS&&e.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach((function(n){t[n]=!i||e.CSS.supports("touch-action",n)})),t}();function kt(t,e){this.manager=t,this.set(e)}kt.prototype={set:function(t){t==It&&(t=this.compute()),Ct&&this.manager.element.style&&Ot[t]&&(this.manager.element.style[Et]=t),this.actions=t.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var t=[];return f(this.manager.recognizers,(function(e){x(e.options.enable,[e])&&(t=t.concat(e.getTouchAction()))})),function(t){if(M(t,Rt))return Rt;var e=M(t,Bt),i=M(t,Dt);if(e&&i)return Rt;if(e||i)return e?Bt:Dt;if(M(t,Lt))return Lt;return Pt}(t.join(" "))},preventDefaults:function(t){var e=t.srcEvent,i=t.offsetDirection;if(this.manager.session.prevented)e.preventDefault();else{var n=this.actions,r=M(n,Rt)&&!Ot[Rt],s=M(n,Dt)&&!Ot[Dt],o=M(n,Bt)&&!Ot[Bt];if(r)if(1===t.pointers.length&&t.distance<2&&t.deltaTime<250)return;if(!o||!s)return r||s&&i&X||o&&i&Z?this.preventSrc(e):void 0}},preventSrc:function(t){this.manager.session.prevented=!0,t.preventDefault()}};var Ft=1,zt=32;function Nt(t){this.options=s({},this.defaults,t||{}),this.id=L++,this.manager=null,this.options.enable=b(this.options.enable,!0),this.state=Ft,this.simultaneous={},this.requireFail=[]}function Ut(t){return 16&t?"cancel":8&t?"end":4&t?"move":2&t?"start":""}function Gt(t){return t==q?"down":t==W?"up":t==j?"left":t==H?"right":""}function Vt(t,e){var i=e.manager;return i?i.get(t):t}function jt(){Nt.apply(this,arguments)}function Ht(){jt.apply(this,arguments),this.pX=null,this.pY=null}function Wt(){jt.apply(this,arguments)}function qt(){Nt.apply(this,arguments),this._timer=null,this._input=null}function Xt(){jt.apply(this,arguments)}function Zt(){jt.apply(this,arguments)}function Jt(){Nt.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function Yt(t,e){return(e=e||{}).recognizers=b(e.recognizers,Yt.defaults.preset),new $t(t,e)}Nt.prototype={defaults:{},set:function(t){return s(this.options,t),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(t){if(p(t,"recognizeWith",this))return this;var e=this.simultaneous;return e[(t=Vt(t,this)).id]||(e[t.id]=t,t.recognizeWith(this)),this},dropRecognizeWith:function(t){return p(t,"dropRecognizeWith",this)||(t=Vt(t,this),delete this.simultaneous[t.id]),this},requireFailure:function(t){if(p(t,"requireFailure",this))return this;var e=this.requireFail;return-1===E(e,t=Vt(t,this))&&(e.push(t),t.requireFailure(this)),this},dropRequireFailure:function(t){if(p(t,"dropRequireFailure",this))return this;t=Vt(t,this);var e=E(this.requireFail,t);return e>-1&&this.requireFail.splice(e,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(t){return!!this.simultaneous[t.id]},emit:function(t){var e=this,i=this.state;function n(i){e.manager.emit(i,t)}i<8&&n(e.options.event+Ut(i)),n(e.options.event),t.additionalEvent&&n(t.additionalEvent),i>=8&&n(e.options.event+Ut(i))},tryEmit:function(t){if(this.canEmit())return this.emit(t);this.state=zt},canEmit:function(){for(var t=0;t<this.requireFail.length;){if(!(this.requireFail[t].state&(zt|Ft)))return!1;t++}return!0},recognize:function(t){var e=s({},t);if(!x(this.options.enable,[this,e]))return this.reset(),void(this.state=zt);56&this.state&&(this.state=Ft),this.state=this.process(e),30&this.state&&this.tryEmit(e)},process:function(t){},getTouchAction:function(){},reset:function(){}},y(jt,Nt,{defaults:{pointers:1},attrTest:function(t){var e=this.options.pointers;return 0===e||t.pointers.length===e},process:function(t){var e=this.state,i=t.eventType,n=6&e,r=this.attrTest(t);return n&&(i&G||!r)?16|e:n||r?i&U?8|e:2&e?4|e:2:zt}}),y(Ht,jt,{defaults:{event:"pan",threshold:10,pointers:1,direction:J},getTouchAction:function(){var t=this.options.direction,e=[];return t&X&&e.push(Dt),t&Z&&e.push(Bt),e},directionTest:function(t){var e=this.options,i=!0,n=t.distance,r=t.direction,s=t.deltaX,o=t.deltaY;return r&e.direction||(e.direction&X?(r=0===s?V:s<0?j:H,i=s!=this.pX,n=Math.abs(t.deltaX)):(r=0===o?V:o<0?W:q,i=o!=this.pY,n=Math.abs(t.deltaY))),t.direction=r,i&&n>e.threshold&&r&e.direction},attrTest:function(t){return jt.prototype.attrTest.call(this,t)&&(2&this.state||!(2&this.state)&&this.directionTest(t))},emit:function(t){this.pX=t.deltaX,this.pY=t.deltaY;var e=Gt(t.direction);e&&(t.additionalEvent=this.options.event+e),this._super.emit.call(this,t)}}),y(Wt,jt,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Rt]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.scale-1)>this.options.threshold||2&this.state)},emit:function(t){1!==t.scale&&(t.additionalEvent=this.options.event+(t.scale<1?"in":"out"));this._super.emit.call(this,t)}}),y(qt,Nt,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[Pt]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,r=t.deltaTime>e.time;if(this._input=t,!n||!i||t.eventType&(U|G)&&!r)this.reset();else if(t.eventType&N)this.reset(),this._timer=d((function(){this.state=8,this.tryEmit()}),e.time,this);else if(t.eventType&U)return 8;return zt},reset:function(){clearTimeout(this._timer)},emit:function(t){8===this.state&&(t&&t.eventType&U?this.manager.emit(this.options.event+"up",t):(this._input.timeStamp=u(),this.manager.emit(this.options.event,this._input)))}}),y(Xt,jt,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Rt]},attrTest:function(t){return this._super.attrTest.call(this,t)&&(Math.abs(t.rotation)>this.options.threshold||2&this.state)}}),y(Zt,jt,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:X|Z,pointers:1},getTouchAction:function(){return Ht.prototype.getTouchAction.call(this)},attrTest:function(t){var e,i=this.options.direction;return i&(X|Z)?e=t.overallVelocity:i&X?e=t.overallVelocityX:i&Z&&(e=t.overallVelocityY),this._super.attrTest.call(this,t)&&i&t.offsetDirection&&t.distance>this.options.threshold&&t.maxPointers==this.options.pointers&&h(e)>this.options.velocity&&t.eventType&U},emit:function(t){var e=Gt(t.offsetDirection);e&&this.manager.emit(this.options.event+e,t),this.manager.emit(this.options.event,t)}}),y(Jt,Nt,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[Lt]},process:function(t){var e=this.options,i=t.pointers.length===e.pointers,n=t.distance<e.threshold,r=t.deltaTime<e.time;if(this.reset(),t.eventType&N&&0===this.count)return this.failTimeout();if(n&&r&&i){if(t.eventType!=U)return this.failTimeout();var s=!this.pTime||t.timeStamp-this.pTime<e.interval,o=!this.pCenter||rt(this.pCenter,t.center)<e.posThreshold;if(this.pTime=t.timeStamp,this.pCenter=t.center,o&&s?this.count+=1:this.count=1,this._input=t,0===this.count%e.taps)return this.hasRequireFailures()?(this._timer=d((function(){this.state=8,this.tryEmit()}),e.interval,this),2):8}return zt},failTimeout:function(){return this._timer=d((function(){this.state=zt}),this.options.interval,this),zt},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),Yt.VERSION="2.0.7",Yt.defaults={domEvents:!1,touchAction:It,enable:!0,inputTarget:null,inputClass:null,preset:[[Xt,{enable:!1}],[Wt,{enable:!1},["rotate"]],[Zt,{direction:X}],[Ht,{direction:X},["swipe"]],[Jt],[Jt,{event:"doubletap",taps:2},["tap"]],[qt]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};function $t(t,e){var i;this.options=s({},Yt.defaults,e||{}),this.options.inputTarget=this.options.inputTarget||t,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=t,this.input=new((i=this).options.inputClass||(D?ft:O?xt:B?At:ct))(i,Q),this.touchAction=new kt(this,this.options.touchAction),Kt(this,!0),f(this.options.recognizers,(function(t){var e=this.add(new t[0](t[1]));t[2]&&e.recognizeWith(t[2]),t[3]&&e.requireFailure(t[3])}),this)}function Kt(t,e){var i,n=t.element;n.style&&(f(t.options.cssProps,(function(r,s){i=P(n.style,s),e?(t.oldCssProps[i]=n.style[i],n.style[i]=r):n.style[i]=t.oldCssProps[i]||""})),e||(t.oldCssProps={}))}$t.prototype={set:function(t){return s(this.options,t),t.touchAction&&this.touchAction.update(),t.inputTarget&&(this.input.destroy(),this.input.target=t.inputTarget,this.input.init()),this},stop:function(t){this.session.stopped=t?2:1},recognize:function(t){var e=this.session;if(!e.stopped){var i;this.touchAction.preventDefaults(t);var n=this.recognizers,r=e.curRecognizer;(!r||r&&8&r.state)&&(r=e.curRecognizer=null);for(var s=0;s<n.length;)i=n[s],2===e.stopped||r&&i!=r&&!i.canRecognizeWith(r)?i.reset():i.recognize(t),!r&&14&i.state&&(r=e.curRecognizer=i),s++}},get:function(t){if(t instanceof Nt)return t;for(var e=this.recognizers,i=0;i<e.length;i++)if(e[i].options.event==t)return e[i];return null},add:function(t){if(p(t,"add",this))return this;var e=this.get(t.options.event);return e&&this.remove(e),this.recognizers.push(t),t.manager=this,this.touchAction.update(),t},remove:function(t){if(p(t,"remove",this))return this;if(t=this.get(t)){var e=this.recognizers,i=E(e,t);-1!==i&&(e.splice(i,1),this.touchAction.update())}return this},on:function(t,e){if(t!==r&&e!==r){var i=this.handlers;return f(S(t),(function(t){i[t]=i[t]||[],i[t].push(e)})),this}},off:function(t,e){if(t!==r){var i=this.handlers;return f(S(t),(function(t){e?i[t]&&i[t].splice(E(i[t],e),1):delete i[t]})),this}},emit:function(t,e){this.options.domEvents&&function(t,e){var n=i.createEvent("Event");n.initEvent(t,!0,!0),n.gesture=e,e.target.dispatchEvent(n)}(t,e);var n=this.handlers[t]&&this.handlers[t].slice();if(n&&n.length){e.type=t,e.preventDefault=function(){e.srcEvent.preventDefault()};for(var r=0;r<n.length;)n[r](e),r++}},destroy:function(){this.element&&Kt(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},s(Yt,{INPUT_START:N,INPUT_MOVE:2,INPUT_END:U,INPUT_CANCEL:G,STATE_POSSIBLE:Ft,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:zt,DIRECTION_NONE:V,DIRECTION_LEFT:j,DIRECTION_RIGHT:H,DIRECTION_UP:W,DIRECTION_DOWN:q,DIRECTION_HORIZONTAL:X,DIRECTION_VERTICAL:Z,DIRECTION_ALL:J,Manager:$t,Input:K,TouchAction:kt,TouchInput:xt,MouseInput:ct,PointerEventInput:ft,TouchMouseInput:At,SingleTouchInput:gt,Recognizer:Nt,AttrRecognizer:jt,Tap:Jt,Pan:Ht,Swipe:Zt,Pinch:Wt,Rotate:Xt,Press:qt,on:w,off:A,each:f,merge:_,extend:g,assign:s,inherit:y,bindFn:v,prefixed:P}),(void 0!==e?e:"undefined"!=typeof self?self:{}).Hammer=Yt,"function"==typeof r&&r.amd?r((function(){return Yt})):t.exports?t.exports=Yt:e.Hammer=Yt}(window,document)}(Kp);var Qp=Kp.exports,tf=t({__proto__:null,default:Z(Qp)},[Qp]);const ef={mousedown:1,mousemove:2,mouseup:4};!function(t){const e=t.prototype.handler;t.prototype.handler=function(t){const i=this.store;t.button>0&&"pointerdown"===t.type&&(function(t,e){for(let i=0;i<t.length;i++)if(e(t[i]))return!0;return!1}(i,(e=>e.pointerId===t.pointerId))||i.push(t)),e.call(this,t)}}(Qp.PointerEventInput),Qp.MouseInput.prototype.handler=function(t){let e=ef[t.type];1&e&&t.button>=0&&(this.pressed=!0),2&e&&0===t.which&&(e=4),this.pressed&&(4&e&&(this.pressed=!1),this.callback(this.manager,e,{pointers:[t],changedPointers:[t],pointerType:"mouse",srcEvent:t}))};const nf=Qp.Manager;class rf{constructor(t,e,i){this.element=t,this.callback=e,this.options={enable:!0,...i}}}const sf=tf?[[tf.Pan,{event:"tripan",pointers:3,threshold:0,enable:!1}],[tf.Rotate,{enable:!1}],[tf.Pinch,{enable:!1}],[tf.Swipe,{enable:!1}],[tf.Pan,{threshold:0,enable:!1}],[tf.Press,{enable:!1}],[tf.Tap,{event:"doubletap",taps:2,enable:!1}],[tf.Tap,{event:"anytap",enable:!1}],[tf.Tap,{enable:!1}]]:null,of={tripan:["rotate","pinch","pan"],rotate:["pinch"],pinch:["pan"],pan:["press","doubletap","anytap","tap"],doubletap:["anytap"],anytap:["tap"]},af={doubletap:["tap"]},lf={pointerdown:"pointerdown",pointermove:"pointermove",pointerup:"pointerup",touchstart:"pointerdown",touchmove:"pointermove",touchend:"pointerup",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup"},cf={KEY_EVENTS:["keydown","keyup"],MOUSE_EVENTS:["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"],WHEEL_EVENTS:["wheel","mousewheel"]},hf={tap:"tap",anytap:"anytap",doubletap:"doubletap",press:"press",pinch:"pinch",pinchin:"pinch",pinchout:"pinch",pinchstart:"pinch",pinchmove:"pinch",pinchend:"pinch",pinchcancel:"pinch",rotate:"rotate",rotatestart:"rotate",rotatemove:"rotate",rotateend:"rotate",rotatecancel:"rotate",tripan:"tripan",tripanstart:"tripan",tripanmove:"tripan",tripanup:"tripan",tripandown:"tripan",tripanleft:"tripan",tripanright:"tripan",tripanend:"tripan",tripancancel:"tripan",pan:"pan",panstart:"pan",panmove:"pan",panup:"pan",pandown:"pan",panleft:"pan",panright:"pan",panend:"pan",pancancel:"pan",swipe:"swipe",swipeleft:"swipe",swiperight:"swipe",swipeup:"swipe",swipedown:"swipe"},uf={click:"tap",anyclick:"anytap",dblclick:"doubletap",mousedown:"pointerdown",mousemove:"pointermove",mouseup:"pointerup",mouseover:"pointerover",mouseout:"pointerout",mouseleave:"pointerleave"},df="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",pf="undefined"!=typeof window?window:global;let ff=!1;try{pf.addEventListener("test",null,{get passive(){return ff=!0,!0}}),pf.removeEventListener("test",null)}catch(S){ff=!1}const mf=-1!==df.indexOf("firefox"),{WHEEL_EVENTS:gf}=cf,_f="wheel",yf=4.000244140625;class vf extends rf{constructor(t,e,i){super(t,e,i),this.handleEvent=t=>{if(!this.options.enable)return;let e=t.deltaY;pf.WheelEvent&&(mf&&t.deltaMode===pf.WheelEvent.DOM_DELTA_PIXEL&&(e/=pf.devicePixelRatio),t.deltaMode===pf.WheelEvent.DOM_DELTA_LINE&&(e*=40)),0!==e&&e%yf==0&&(e=Math.floor(e/yf)),t.shiftKey&&e&&(e*=.25),this.callback({type:_f,center:{x:t.clientX,y:t.clientY},delta:-e,srcEvent:t,pointerType:"mouse",target:t.target})},this.events=(this.options.events||[]).concat(gf),this.events.forEach((e=>t.addEventListener(e,this.handleEvent,!!ff&&{passive:!1})))}destroy(){this.events.forEach((t=>this.element.removeEventListener(t,this.handleEvent)))}enableEventType(t,e){t===_f&&(this.options.enable=e)}}const{MOUSE_EVENTS:xf}=cf,bf="pointermove",wf="pointerover",Af="pointerout",Tf="pointerenter",Mf="pointerleave";class Sf extends rf{constructor(t,e,i){super(t,e,i),this.handleEvent=t=>{this.handleOverEvent(t),this.handleOutEvent(t),this.handleEnterEvent(t),this.handleLeaveEvent(t),this.handleMoveEvent(t)},this.pressed=!1;const{enable:n}=this.options;this.enableMoveEvent=n,this.enableLeaveEvent=n,this.enableEnterEvent=n,this.enableOutEvent=n,this.enableOverEvent=n,this.events=(this.options.events||[]).concat(xf),this.events.forEach((e=>t.addEventListener(e,this.handleEvent)))}destroy(){this.events.forEach((t=>this.element.removeEventListener(t,this.handleEvent)))}enableEventType(t,e){t===bf&&(this.enableMoveEvent=e),t===wf&&(this.enableOverEvent=e),t===Af&&(this.enableOutEvent=e),t===Tf&&(this.enableEnterEvent=e),t===Mf&&(this.enableLeaveEvent=e)}handleOverEvent(t){this.enableOverEvent&&"mouseover"===t.type&&this._emit(wf,t)}handleOutEvent(t){this.enableOutEvent&&"mouseout"===t.type&&this._emit(Af,t)}handleEnterEvent(t){this.enableEnterEvent&&"mouseenter"===t.type&&this._emit(Tf,t)}handleLeaveEvent(t){this.enableLeaveEvent&&"mouseleave"===t.type&&this._emit(Mf,t)}handleMoveEvent(t){if(this.enableMoveEvent)switch(t.type){case"mousedown":t.button>=0&&(this.pressed=!0);break;case"mousemove":0===t.which&&(this.pressed=!1),this.pressed||this._emit(bf,t);break;case"mouseup":this.pressed=!1}}_emit(t,e){this.callback({type:t,center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})}}const{KEY_EVENTS:Ef}=cf,Cf="keydown",If="keyup";class Pf extends rf{constructor(t,e,i){super(t,e,i),this.handleEvent=t=>{const e=t.target||t.srcElement;"INPUT"===e.tagName&&"text"===e.type||"TEXTAREA"===e.tagName||(this.enableDownEvent&&"keydown"===t.type&&this.callback({type:Cf,srcEvent:t,key:t.key,target:t.target}),this.enableUpEvent&&"keyup"===t.type&&this.callback({type:If,srcEvent:t,key:t.key,target:t.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,this.events=(this.options.events||[]).concat(Ef),t.tabIndex=this.options.tabIndex||0,t.style.outline="none",this.events.forEach((e=>t.addEventListener(e,this.handleEvent)))}destroy(){this.events.forEach((t=>this.element.removeEventListener(t,this.handleEvent)))}enableEventType(t,e){t===Cf&&(this.enableDownEvent=e),t===If&&(this.enableUpEvent=e)}}const Lf="contextmenu";class Rf extends rf{constructor(t,e,i){super(t,e,i),this.handleEvent=t=>{this.options.enable&&this.callback({type:Lf,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})},t.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(t,e){t===Lf&&(this.options.enable=e)}}const Bf={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4};function Df(t){const e=Bf[t.srcEvent.type];if(!e)return null;const{buttons:i,button:n,which:r}=t.srcEvent;let s=!1,o=!1,a=!1;return 4===e||2===e&&!Number.isFinite(i)?(s=1===r,o=2===r,a=3===r):2===e?(s=Boolean(1&i),o=Boolean(4&i),a=Boolean(2&i)):1===e&&(s=0===n,o=1===n,a=2===n),{leftButton:s,middleButton:o,rightButton:a}}function Of(t,e){const i=t.center;if(!i)return null;const n=e.getBoundingClientRect();return{center:i,offsetCenter:{x:(i.x-n.left-e.clientLeft)/(n.width/e.offsetWidth||1),y:(i.y-n.top-e.clientTop)/(n.height/e.offsetHeight||1)}}}const kf={srcElement:"root",priority:0};class Ff{constructor(t){this.handleEvent=t=>{if(this.isEmpty())return;const e=this._normalizeEvent(t);let i=t.srcEvent.target;for(;i&&i!==e.rootElement;){if(this._emit(e,i),e.handled)return;i=i.parentNode}this._emit(e,"root")},this.eventManager=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(t,e,i,n=!1,r=!1){const{handlers:s,handlersByElement:o}=this;let a=kf;"string"==typeof i||i&&i.addEventListener?a={...kf,srcElement:i}:i&&(a={...kf,...i});let l=o.get(a.srcElement);l||(l=[],o.set(a.srcElement,l));const c={type:t,handler:e,srcElement:a.srcElement,priority:a.priority};n&&(c.once=!0),r&&(c.passive=!0),s.push(c),this._active=this._active||!c.passive;let h=l.length-1;for(;h>=0&&!(l[h].priority>=c.priority);)h--;l.splice(h+1,0,c)}remove(t,e){const{handlers:i,handlersByElement:n}=this;for(let r=i.length-1;r>=0;r--){const s=i[r];if(s.type===t&&s.handler===e){i.splice(r,1);const t=n.get(s.srcElement);t.splice(t.indexOf(s),1),0===t.length&&n.delete(s.srcElement)}}this._active=i.some((t=>!t.passive))}_emit(t,e){const i=this.handlersByElement.get(e);if(i){let e=!1;const n=()=>{t.handled=!0},r=()=>{t.handled=!0,e=!0},s=[];for(let o=0;o<i.length;o++){const{type:a,handler:l,once:c}=i[o];if(l({...t,type:a,stopPropagation:n,stopImmediatePropagation:r}),c&&s.push(i[o]),e)break}for(let t=0;t<s.length;t++){const{type:e,handler:i}=s[t];this.remove(e,i)}}}_normalizeEvent(t){const e=this.eventManager.getElement();return{...t,...Df(t),...Of(t,e),preventDefault:()=>{t.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:e}}}const zf={events:null,recognizers:null,recognizerOptions:{},Manager:nf,touchAction:"none",tabIndex:0};class Nf{constructor(t=null,e){this._onBasicInput=t=>{const{srcEvent:e}=t,i=lf[e.type];i&&this.manager.emit(i,t)},this._onOtherEvent=t=>{this.manager.emit(t.type,t)},this.options={...zf,...e},this.events=new Map,this.setElement(t);const{events:i}=this.options;i&&this.on(i)}getElement(){return this.element}setElement(t){if(this.element&&this.destroy(),this.element=t,!t)return;const{options:e}=this;this.manager=new(0,e.Manager)(t,{touchAction:e.touchAction,recognizers:e.recognizers||sf}).on("hammer.input",this._onBasicInput),e.recognizers||Object.keys(of).forEach((t=>{const e=this.manager.get(t);e&&of[t].forEach((t=>{e.recognizeWith(t)}))}));for(const t in e.recognizerOptions){const i=this.manager.get(t);if(i){const n=e.recognizerOptions[t];delete n.enable,i.set(n)}}this.wheelInput=new vf(t,this._onOtherEvent,{enable:!1}),this.moveInput=new Sf(t,this._onOtherEvent,{enable:!1}),this.keyInput=new Pf(t,this._onOtherEvent,{enable:!1,tabIndex:e.tabIndex}),this.contextmenuInput=new Rf(t,this._onOtherEvent,{enable:!1});for(const[t,e]of this.events)e.isEmpty()||(this._toggleRecognizer(e.recognizerName,!0),this.manager.on(t,e.handleEvent))}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy(),this.wheelInput=null,this.moveInput=null,this.keyInput=null,this.contextmenuInput=null,this.manager=null,this.element=null)}on(t,e,i){this._addEventHandler(t,e,i,!1)}once(t,e,i){this._addEventHandler(t,e,i,!0)}watch(t,e,i){this._addEventHandler(t,e,i,!1,!0)}off(t,e){this._removeEventHandler(t,e)}_toggleRecognizer(t,e){const{manager:i}=this;if(!i)return;const n=i.get(t);if(n&&n.options.enable!==e){n.set({enable:e});const r=af[t];r&&!this.options.recognizers&&r.forEach((r=>{const s=i.get(r);e?(s.requireFailure(t),n.dropRequireFailure(r)):s.dropRequireFailure(t)}))}this.wheelInput.enableEventType(t,e),this.moveInput.enableEventType(t,e),this.keyInput.enableEventType(t,e),this.contextmenuInput.enableEventType(t,e)}_addEventHandler(t,e,i,n,r){if("string"!=typeof t){i=e;for(const e in t)this._addEventHandler(e,t[e],i,n,r);return}const{manager:s,events:o}=this,a=uf[t]||t;let l=o.get(a);l||(l=new Ff(this),o.set(a,l),l.recognizerName=hf[a]||a,s&&s.on(a,l.handleEvent)),l.add(t,e,i,n,r),l.isEmpty()||this._toggleRecognizer(l.recognizerName,!0)}_removeEventHandler(t,e){if("string"!=typeof t){for(const e in t)this._removeEventHandler(e,t[e]);return}const{events:i}=this,n=i.get(uf[t]||t);if(n&&(n.remove(t,e),n.isEmpty())){const{recognizerName:t}=n;let e=!1;for(const n of i.values())if(n.recognizerName===t&&!n.isEmpty()){e=!0;break}e||this._toggleRecognizer(t,!1)}}}function Uf(){}const Gf={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,glOptions:{},parameters:{},parent:null,gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,onWebGLInitialized:Uf,onResize:Uf,onViewStateChange:Uf,onInteractionStateChange:Uf,onBeforeRender:Uf,onAfterRender:Uf,onLoad:Uf,onError:t=>{},onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:({isDragging:t})=>t?"grabbing":"grab",getTooltip:null,debug:!1,drawPickingColors:!1};class Vf{constructor(t){He(this,"props",void 0),He(this,"width",0),He(this,"height",0),He(this,"userData",{}),He(this,"canvas",null),He(this,"viewManager",null),He(this,"layerManager",null),He(this,"effectManager",null),He(this,"deckRenderer",null),He(this,"deckPicker",null),He(this,"eventManager",null),He(this,"tooltip",null),He(this,"metrics",void 0),He(this,"animationLoop",void 0),He(this,"stats",void 0),He(this,"viewState",void 0),He(this,"cursorState",void 0),He(this,"_needsRedraw",void 0),He(this,"_pickRequest",void 0),He(this,"_lastPointerDownInfo",null),He(this,"_metricsCounter",void 0),He(this,"_onPointerMove",(t=>{const{_pickRequest:e}=this;if("pointerleave"===t.type)e.x=-1,e.y=-1,e.radius=0;else{if(t.leftButton||t.rightButton)return;{const i=t.offsetCenter;if(!i)return;e.x=i.x,e.y=i.y,e.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:e.x,y:e.y}),e.event=t})),He(this,"_onEvent",(t=>{const e=Wr[t.type],i=t.offsetCenter;if(!e||!i||!this.layerManager)return;const n=this.layerManager.getLayers(),r=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:n,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:s}=r,o=s&&(s[e.handler]||s.props[e.handler]),a=this.props[e.handler];let l=!1;o&&(l=o.call(s,r,t)),!l&&a&&a(r,t)})),He(this,"_onPointerDown",(t=>{const e=t.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:e.x,y:e.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo})),this.props={...Gf,...t},t=this.props,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this.cursorState={isHovering:!1,isDragging:!1},t.viewState&&t.initialViewState&&kr.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),"IE"===br()&&kr.warn("IE 11 is not supported")(),this.viewState=t.initialViewState,t.gl||"undefined"!=typeof document&&(this.canvas=this._createCanvas(t)),this.animationLoop=this._createAnimationLoop(t),this.stats=new Hs({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this.setProps(t),t._typedArrayManagerProps&&vd.setOptions(t._typedArrayManagerProps),this.animationLoop.start()}finalize(){var t,e,i,n,r,s,o,a,l;(null===(t=this.animationLoop)||void 0===t||t.stop(),this.animationLoop=null,this._lastPointerDownInfo=null,null===(e=this.layerManager)||void 0===e||e.finalize(),this.layerManager=null,null===(i=this.viewManager)||void 0===i||i.finalize(),this.viewManager=null,null===(n=this.effectManager)||void 0===n||n.finalize(),this.effectManager=null,null===(r=this.deckRenderer)||void 0===r||r.finalize(),this.deckRenderer=null,null===(s=this.deckPicker)||void 0===s||s.finalize(),this.deckPicker=null,null===(o=this.eventManager)||void 0===o||o.destroy(),this.eventManager=null,null===(a=this.tooltip)||void 0===a||a.remove(),this.tooltip=null,this.props.canvas||this.props.gl||!this.canvas)||(null===(l=this.canvas.parentElement)||void 0===l||l.removeChild(this.canvas),this.canvas=null)}setProps(t){this.stats.get("setProps Time").timeStart(),"onLayerHover"in t&&kr.removed("onLayerHover","onHover")(),"onLayerClick"in t&&kr.removed("onLayerClick","onClick")(),t.initialViewState&&!lp(this.props.initialViewState,t.initialViewState,3)&&(this.viewState=t.initialViewState),Object.assign(this.props,t),this._setCanvasSize(this.props);const e=Object.create(this.props);Object.assign(e,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop.setProps(e),this.layerManager&&(this.viewManager.setProps(e),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(e),this.effectManager.setProps(e),this.deckRenderer.setProps(e),this.deckPicker.setProps(e)),this.stats.get("setProps Time").timeEnd()}needsRedraw(t={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let e=this._needsRedraw;t.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(t),n=this.layerManager.needsRedraw(t),r=this.effectManager.needsRedraw(t),s=this.deckRenderer.needsRedraw(t);return e=e||i||n||r||s,e}redraw(t){if(!this.layerManager)return;let e=this.needsRedraw({clearRedrawFlags:!0});e=t||e,e&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(e):this._drawLayers(e))}get isInitialized(){return null!==this.viewManager}getViews(){return pp(this.viewManager),this.viewManager.views}getViewports(t){return pp(this.viewManager),this.viewManager.getViewports(t)}getCanvas(){return this.canvas}pickObject(t){const e=this._pick("pickObject","pickObject Time",t).result;return e.length?e[0]:null}pickMultipleObjects(t){return t.depth=t.depth||10,this._pick("pickObject","pickMultipleObjects Time",t).result}pickObjects(t){return this._pick("pickObjects","pickObjects Time",t)}_addResources(t,e=!1){for(const i in t)this.layerManager.resourceManager.add({resourceId:i,data:t[i],forceUpdate:e})}_removeResources(t){for(const e of t)this.layerManager.resourceManager.remove(e)}_addDefaultEffect(t){this.effectManager.addDefaultEffect(t)}_pick(t,e,i){pp(this.deckPicker);const{stats:n}=this;n.get("Pick Count").incrementCount(),n.get(e).timeStart();const r=this.deckPicker[t]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return n.get(e).timeEnd(),r}_createCanvas(t){let e=t.canvas;if("string"==typeof e&&(e=document.getElementById(e),pp(e)),!e){e=document.createElement("canvas"),e.id=t.id||"deckgl-overlay";(t.parent||document.body).appendChild(e)}return Object.assign(e.style,t.style),e}_setCanvasSize(t){if(!this.canvas)return;const{width:e,height:i}=t;if(e||0===e){const t=Number.isFinite(e)?"".concat(e,"px"):e;this.canvas.style.width=t}if(i||0===i){var n;const e=Number.isFinite(i)?"".concat(i,"px"):i;this.canvas.style.position=(null===(n=t.style)||void 0===n?void 0:n.position)||"absolute",this.canvas.style.height=e}}_updateCanvasSize(){var t,e;const{canvas:i}=this;if(!i)return;const n=null!==(t=i.clientWidth)&&void 0!==t?t:i.width,r=null!==(e=i.clientHeight)&&void 0!==e?e:i.height;var s,o;n===this.width&&r===this.height||(this.width=n,this.height=r,null===(s=this.viewManager)||void 0===s||s.setProps({width:n,height:r}),null===(o=this.layerManager)||void 0===o||o.activateViewport(this.getViewports()[0]),this.props.onResize({width:n,height:r}))}_createAnimationLoop(t){const{width:e,height:i,gl:n,glOptions:r,debug:s,onError:o,onBeforeRender:a,onAfterRender:l,useDevicePixels:c}=t;return new Ya({width:e,height:i,useDevicePixels:c,autoResizeDrawingBuffer:!n,autoResizeViewport:!1,gl:n,onCreateContext:t=>Ns({...r,...t,canvas:this.canvas,debug:s,onContextLost:()=>this._onContextLost()}),onInitialize:t=>this._setGLContext(t.gl),onRender:this._onRenderFrame.bind(this),onBeforeRender:a,onAfterRender:l,onError:o})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let t=this.props.views||[new Np({id:"default-view"})];return t=Array.isArray(t)?t:[t],t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:t}=this.props;this.animationLoop&&t&&t(new Error("WebGL context is lost"))}_pickAndCallback(){const{_pickRequest:t}=this;if(t.event){const{result:i,emptyInfo:n}=this._pick("pickObject","pickObject Time",t);this.cursorState.isHovering=i.length>0;let r=n,s=!1;for(const n of i){var e;r=n,s=(null===(e=n.layer)||void 0===e?void 0:e.onHover(n,t.event))||s}if(!s&&this.props.onHover&&this.props.onHover(r,t.event),this.props.getTooltip&&this.tooltip){const t=this.props.getTooltip(r);this.tooltip.setTooltip(t,r.x,r.y)}t.event=null}}_updateCursor(){const t=this.props.parent||this.canvas;t&&(t.style.cursor=this.props.getCursor(this.cursorState))}_setGLContext(t){if(this.layerManager)return;this.canvas||(this.canvas=t.canvas,Us(t,{enable:!0,copyState:!0})),this.tooltip=new $p(this.canvas),Ps(t,{blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onWebGLInitialized(t);const e=new au;e.play(),this.animationLoop.attachTimeline(e),this.eventManager=new Nf(this.props.parent||t.canvas,{touchAction:this.props.touchAction,recognizerOptions:this.props.eventRecognizerOptions,events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const t in Wr)this.eventManager.on(t,this._onEvent);this.viewManager=new cp({timeline:e,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new ap(t,{deck:this,stats:this.stats,viewport:i,timeline:e}),this.effectManager=new Gp,this.deckRenderer=new jp(t),this.deckPicker=new Jp(t),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(t,e){const{gl:i}=this.layerManager.context;Ps(i,this.props.parameters),this.props.onBeforeRender({gl:i}),this.deckRenderer.renderLayers({target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...e}),this.props.onAfterRender({gl:i})}_onRenderFrame(t){this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),kr.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.tooltip.isVisible&&this.viewManager.needsRedraw()&&this.tooltip.setTooltip(null),this.layerManager.updateLayers(),this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(t){const e=this.props.onViewStateChange(t)||t.viewState;this.viewState&&(this.viewState={...this.viewState,[t.viewId]:e},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(t){this.cursorState.isDragging=t.isDragging||!1,this.props.onInteractionStateChange(t)}_getFrameStats(){const{stats:t}=this;t.get("frameRate").timeEnd(),t.get("frameRate").timeStart();const e=this.animationLoop.stats;t.get("GPU Time").addTime(e.get("GPU Time").lastTiming),t.get("CPU Time").addTime(e.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:t,stats:e}=this;t.fps=e.get("frameRate").getHz(),t.setPropsTime=e.get("setProps Time").time,t.updateAttributesTime=e.get("Update Attributes").time,t.framesRedrawn=e.get("Redraw Count").count,t.pickTime=e.get("pickObject Time").time+e.get("pickMultipleObjects Time").time+e.get("pickObjects Time").time,t.pickCount=e.get("Pick Count").count,t.gpuTime=e.get("GPU Time").time,t.cpuTime=e.get("CPU Time").time,t.gpuTimePerFrame=e.get("GPU Time").getAverageTime(),t.cpuTimePerFrame=e.get("CPU Time").getAverageTime();const i=qs.get("Memory Usage");t.bufferMemory=i.get("Buffer Memory").count,t.textureMemory=i.get("Texture Memory").count,t.renderbufferMemory=i.get("Renderbuffer Memory").count,t.gpuMemory=i.get("GPU Memory").count}}He(Vf,"defaultProps",Gf),He(Vf,"VERSION",Gr);class jf{constructor(t,e){He(this,"opts",void 0),He(this,"source",void 0),this.opts=e,this.source=t}get value(){return this.source.value}getValue(){const t=this.source.getBuffer(),e=this.getAccessor();if(t)return[t,e];const{value:i}=this.source,{size:n}=e;let r=i;if(i&&i.length!==n){r=new Float32Array(n);const t=e.elementOffset||0;for(let e=0;e<n;++e)r[e]=i[t+e]}return r}getAccessor(){return{...this.source.getAccessor(),...this.opts}}}function Hf(t){return t.stride||t.size*t.bytesPerElement}function Wf(t,e){e.offset&&kr.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const i=Hf(t),n=(void 0!==e.vertexOffset?e.vertexOffset:t.vertexOffset||0)*i+(e.elementOffset||0)*t.bytesPerElement+(t.offset||0);return{...e,offset:n,stride:i}}class qf{constructor(t,e,i){He(this,"gl",void 0),He(this,"id",void 0),He(this,"size",void 0),He(this,"settings",void 0),He(this,"value",void 0),He(this,"doublePrecision",void 0),He(this,"_buffer",void 0),He(this,"state",void 0),this.gl=t,this.id=e.id||"",this.size=e.size||1;const n=e.logicalType||e.type,r=5130===n;let s,{defaultValue:o}=e;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0),s=r?5126:!n&&e.isIndexed?t&&Go(t,ko)?5125:5123:n||5126;let a=function(t){switch(t){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}(n||s||5126);this.doublePrecision=r,r&&!1===e.fp64&&(a=Float32Array),this.value=null,this.settings={...e,defaultType:a,defaultValue:o,logicalType:n,type:s,size:this.size,bytesPerElement:a.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){const{isIndexed:t,type:e}=this.settings;this._buffer=new mo(this.gl,{id:this.id,target:t?34963:34962,accessor:{type:e}})}return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*Hf(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),vd.release(this.state.allocatedValue)}getShaderAttributes(t,e){if(this.doublePrecision){const i={},n=this.value instanceof Float64Array,r=function(t,e){const i=Wf(t,e);return{high:i,low:{...i,offset:i.offset+4*t.size}}}(this.getAccessor(),e||{});return i[t]=new jf(this,r.high),i["".concat(t,"64Low")]=n?new jf(this,r.low):new Float32Array(this.size),i}if(e){const i=Wf(this.getAccessor(),e);return{[t]:new jf(this,i)}}return{[t]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){const e=Array.from(this.value);t=[e,e]}else{const{value:e,numInstances:i,size:n}=this,r=i*n;if(e&&r&&e.length>=r){const i=new Array(n).fill(1/0),s=new Array(n).fill(-1/0);for(let t=0;t<r;)for(let r=0;r<n;r++){const n=e[t++];n<i[r]&&(i[r]=n),n>s[r]&&(s[r]=n)}t=[i,s]}}return this.state.bounds=t,t}setData(t){const{state:e}=this;let i;i=ArrayBuffer.isView(t)?{value:t}:t instanceof mo?{buffer:t}:t;const n={...this.settings,...i};if(e.bufferAccessor=n,e.bounds=null,i.constant){let t=i.value;t=this._normalizeValue(t,[],0),this.settings.normalized&&(t=this.normalizeConstant(t));if(!(!e.constant||!this._areValuesEqual(t,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=t}else if(i.buffer){const t=i.buffer;e.externalBuffer=t,e.constant=!1,this.value=i.value||null;const r=i.value instanceof Float64Array;n.type=i.type||t.accessor.type,n.bytesPerElement=t.accessor.BYTES_PER_ELEMENT*(r?2:1),n.stride=Hf(n)}else if(i.value){this._checkExternalBuffer(i);let t=i.value;e.externalBuffer=null,e.constant=!1,this.value=t,n.bytesPerElement=t.BYTES_PER_ELEMENT,n.stride=Hf(n);const{buffer:r,byteOffset:s}=this;this.doublePrecision&&t instanceof Float64Array&&(t=Td(t,n));const o=t.byteLength+s+2*n.stride;r.byteLength<o&&r.reallocate(o),r.setAccessor(null),r.subData({data:t,offset:s}),n.type=i.type||r.accessor.type}return!0}updateSubBuffer(t={}){this.state.bounds=null;const e=this.value,{startOffset:i=0,endOffset:n}=t;this.buffer.subData({data:this.doublePrecision&&e instanceof Float64Array?Td(e,{size:this.size,startIndex:i,endIndex:n}):e.subarray(i,n),offset:i*e.BYTES_PER_ELEMENT+this.byteOffset})}allocate(t,e=!1){const{state:i}=this,n=i.allocatedValue,r=vd.allocate(n,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=r;const{buffer:s,byteOffset:o}=this;return s.byteLength<r.byteLength+o&&(s.reallocate(r.byteLength+o),e&&n&&s.subData({data:n instanceof Float64Array?Td(n,this):n,offset:o})),i.allocatedValue=r,i.constant=!1,i.externalBuffer=null,i.bufferAccessor=this.settings,!0}_checkExternalBuffer(t){const{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const i=this.settings.defaultType;let n=!1;if(this.doublePrecision&&(n=e.BYTES_PER_ELEMENT<4),n)throw new Error("Attribute ".concat(this.id," does not support ").concat(e.constructor.name));e instanceof i||!this.settings.normalized||"normalized"in t||kr.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(t){switch(this.settings.type){case 5120:return new Float32Array(t).map((t=>(t+128)/255*2-1));case 5122:return new Float32Array(t).map((t=>(t+32768)/65535*2-1));case 5121:return new Float32Array(t).map((t=>t/255));case 5123:return new Float32Array(t).map((t=>t/65535));default:return t}}_normalizeValue(t,e,i){const{defaultValue:n,size:r}=this.settings;if(Number.isFinite(t))return e[i]=t,e;if(!t){let t=r;for(;--t>=0;)e[i+t]=n[t];return e}switch(r){case 4:e[i+3]=Number.isFinite(t[3])?t[3]:n[3];case 3:e[i+2]=Number.isFinite(t[2])?t[2]:n[2];case 2:e[i+1]=Number.isFinite(t[1])?t[1]:n[1];case 1:e[i+0]=Number.isFinite(t[0])?t[0]:n[0];break;default:let s=r;for(;--s>=0;)e[i+s]=Number.isFinite(t[s])?t[s]:n[s]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:i}=this;for(let n=0;n<i;n++)if(t[n]!==e[n])return!1;return!0}}const Xf=[],Zf=[];function Jf(t,e=0,i=1/0){let n=Xf;const r={index:-1,data:t,target:[]};return t?"function"==typeof t[Symbol.iterator]?n=t:t.length>0&&(Zf.length=t.length,n=Zf):n=Xf,(e>0||Number.isFinite(i))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,i),r.index=e-1),{iterable:n,objectInfo:r}}function Yf(t){return t&&t[Symbol.asyncIterator]}function $f(t,e){const{size:i,stride:n,offset:r,startIndices:s,nested:o}=e,a=t.BYTES_PER_ELEMENT,l=n?n/a:i,c=r?r/a:0,h=Math.floor((t.length-c)/l);return(e,{index:n,target:r})=>{if(!s){const e=n*l+c;for(let n=0;n<i;n++)r[n]=t[e+n];return r}const a=s[n],u=s[n+1]||h;let d;if(o){d=new Array(u-a);for(let e=a;e<u;e++){const n=e*l+c;r=new Array(i);for(let e=0;e<i;e++)r[e]=t[n+e];d[e-a]=r}}else if(l===i)d=t.subarray(a*i+c,u*i+c);else{d=new t.constructor((u-a)*i);let e=0;for(let n=a;n<u;n++){const r=n*l+c;for(let n=0;n<i;n++)d[e++]=t[r+n]}}return d}}const Kf=[],Qf=[[0,1/0]];function tm(t){const{source:e,target:i,start:n=0,size:r,getData:s}=t,o=e.length,a=(t.end||i.length)-n;if(o>a)return void i.set(e.subarray(0,a),n);if(i.set(e,n),!s)return;let l=o;for(;l<a;){const t=s(l,e);for(let e=0;e<r;e++)i[n+l]=t[e]||0,l++}}const em={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function im(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});const i=t.type||"interpolation";return{...em[i],...e,...t,type:i}}function nm(t,e){const i=e.getBuffer();return i?[i,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function rm(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(t,'"'))}}function sm(t){t.push(t.shift())}function om(t,e){const{doublePrecision:i,settings:n,value:r,size:s}=t,o=i&&r instanceof Float64Array?2:1;return(n.noAlloc?r.length:e*s)*o}function am({buffer:t,numInstances:e,attribute:i,fromLength:n,fromStartIndices:r,getData:s=(t=>t)}){const o=i.doublePrecision&&i.value instanceof Float64Array?2:1,a=i.size*o,l=i.byteOffset,c=i.startIndices,h=r&&c,u=om(i,e),d=i.isConstant;if(!h&&n>=u)return;const p=d?i.value:i.getBuffer().getData({srcByteOffset:l});if(i.settings.normalized&&!d){const t=s;s=(e,n)=>i.normalizeConstant(t(e,n))}const f=d?(t,e)=>s(p,e):(t,e)=>s(p.subarray(t,t+a),e),m=t.getData({length:n}),g=new Float32Array(u);!function({source:t,target:e,size:i,getData:n,sourceStartIndices:r,targetStartIndices:s}){if(!Array.isArray(s))return tm({source:t,target:e,size:i,getData:n}),e;let o=0,a=0;const l=n&&((t,e)=>n(t+a,e)),c=Math.min(r.length,s.length);for(let n=1;n<c;n++){const c=r[n]*i,h=s[n]*i;tm({source:t.subarray(o,c),target:e,start:a,end:h,size:i,getData:l}),o=c,a=h}a<e.length&&tm({source:[],target:e,start:a,size:i,getData:l})}({source:m,target:g,sourceStartIndices:r,targetStartIndices:c,size:a,getData:f}),t.byteLength<g.byteLength+l&&t.reallocate(g.byteLength+l),t.subData({data:g,offset:l})}class lm extends qf{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:Qf}),He(this,"constant",!1),this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat("function"!=typeof t&&t||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,i=this.settings.transition,n=Array.isArray(e)?t[e.find((e=>t[e]))]:t[e];return im(n,i)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:t=0,endRow:i=1/0}=e;this.state.updateRanges=function(t,e){if(t===Qf)return t;if(e[0]<0&&(e[0]=0),e[0]>=e[1])return t;const i=[],n=t.length;let r=0;for(let s=0;s<n;s++){const n=t[s];n[1]<e[0]?(i.push(n),r=s+1):n[0]>e[1]?i.push(n):e=[Math.min(n[0],e[0]),Math.max(n[1],e[1])]}return i.splice(r,0,e),i}(this.state.updateRanges,[t,i])}else this.state.updateRanges=Qf}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=Kf}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){const{state:e,settings:i}=this;return!i.noAlloc&&(!!i.update&&(super.allocate(t,e.updateRanges!==Qf),!0))}updateBuffer({numInstances:t,data:e,props:i,context:n}){if(!this.needsUpdate())return!1;const{state:{updateRanges:r},settings:{update:s,noAlloc:o}}=this;let a=!0;if(s){for(const[o,a]of r)s.call(n,this,{data:e,startRow:o,endRow:a,props:i,numInstances:t});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[e,i]of r){const n=Number.isFinite(e)?this.getVertexOffset(e):0,r=Number.isFinite(i)?this.getVertexOffset(i):o||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:n,endOffset:r})}else;this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(t){if(void 0===t||"function"==typeof t)return!1;return this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){const{state:i,settings:n}=this;if(!t)return i.binaryValue=null,i.binaryAccessor=null,!1;if(n.noAlloc)return!1;if(i.binaryValue===t)return this.clearNeedsUpdate(),!0;i.binaryValue=t,this.setNeedsRedraw();if(n.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});const r=t;pp(ArrayBuffer.isView(r.value),"invalid ".concat(n.accessor));const s=Boolean(r.size)&&r.size!==this.size;return i.binaryAccessor=$f(r.value,{size:r.size||this.size,stride:r.stride,offset:r.offset,startIndices:e,nested:s}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getShaderAttributes(){const t=this.settings.shaderAttributes||{[this.id]:null},e={};for(const i in t)Object.assign(e,super.getShaderAttributes(i,t[i]));return e}_autoUpdater(t,{data:e,startRow:i,endRow:n,props:r,numInstances:s}){if(t.constant)return;const{settings:o,state:a,value:l,size:c,startIndices:h}=t,{accessor:u,transform:d}=o,p=a.binaryAccessor||("function"==typeof u?u:r[u]);pp("function"==typeof p,'accessor "'.concat(u,'" is not a function'));let f=t.getVertexOffset(i);const{iterable:m,objectInfo:g}=Jf(e,i,n);for(const e of m){g.index++;let i=p(e,g);if(d&&(i=d.call(this,i)),h){const e=(g.index<h.length-1?h[g.index+1]:s)-h[g.index];if(i&&Array.isArray(i[0])){let e=f;for(const n of i)t._normalizeValue(n,l,e),e+=c}else i&&i.length>c?l.set(i,f):(t._normalizeValue(i,g.target,0),Qd({target:l,source:g.target,start:f,count:e}));f+=e*c}else t._normalizeValue(i,l,f),f+=c}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||"function"==typeof t.update))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let i=!0;switch(e){case 4:i=i&&Number.isFinite(t[3]);case 3:i=i&&Number.isFinite(t[2]);case 2:i=i&&Number.isFinite(t[1]);case 1:i=i&&Number.isFinite(t[0]);break;default:i=!1}if(!i)throw new Error("Illegal attribute generated for ".concat(this.id))}}}const cm="\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nuniform float time;\nattribute ATTRIBUTE_TYPE aFrom;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vCurrent;\n\nvoid main(void) {\n  vCurrent = mix(aFrom, aTo, time);\n  gl_Position = vec4(0.0);\n}\n";const hm={interpolation:class{constructor({gl:t,attribute:e,timeline:i}){He(this,"gl",void 0),He(this,"type","interpolation"),He(this,"attributeInTransition",void 0),He(this,"settings",void 0),He(this,"attribute",void 0),He(this,"transition",void 0),He(this,"currentStartIndices",void 0),He(this,"currentLength",void 0),He(this,"transform",void 0),He(this,"buffers",void 0),this.gl=t,this.transition=new mp(i),this.attribute=e,this.attributeInTransition=new lm(t,e.settings),this.currentStartIndices=e.startIndices,this.currentLength=0,this.transform=function(t,e){const i=rm(e.size);return new iu(t,{vs:cm,defines:{ATTRIBUTE_TYPE:i},varyings:["vCurrent"]})}(t,e);const n={byteLength:0,usage:35050};this.buffers=[new mo(t,n),new mo(t,n)]}get inProgress(){return this.transition.inProgress}start(t,e){if(t.duration<=0)return void this.transition.cancel();this.settings=t;const{gl:i,buffers:n,attribute:r}=this;sm(n);const s={numInstances:e,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const t of n)am({buffer:t,...s});this.currentStartIndices=r.startIndices,this.currentLength=om(r,e),this.attributeInTransition.setData({buffer:n[1],value:r.value}),this.transition.start(t),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aFrom:n[0],aTo:nm(0,r)},feedbackBuffers:{vCurrent:n[1]}})}update(){const t=this.transition.update();if(t){const{duration:t,easing:e}=this.settings,{time:i}=this.transition;let n=i/t;e&&(n=e(n)),this.transform.run({uniforms:{time:n}})}return t}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0}},spring:class{constructor({gl:t,attribute:e,timeline:i}){He(this,"gl",void 0),He(this,"type","spring"),He(this,"attributeInTransition",void 0),He(this,"settings",void 0),He(this,"attribute",void 0),He(this,"transition",void 0),He(this,"currentStartIndices",void 0),He(this,"currentLength",void 0),He(this,"texture",void 0),He(this,"framebuffer",void 0),He(this,"transform",void 0),He(this,"buffers",void 0),this.gl=t,this.type="spring",this.transition=new mp(i),this.attribute=e,this.attributeInTransition=new lm(t,{...e.settings,normalized:!1}),this.currentStartIndices=e.startIndices,this.currentLength=0,this.texture=function(t){return new wo(t,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}(t),this.framebuffer=function(t,e){return new Wo(t,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{36064:e}})}(t,this.texture),this.transform=function(t,e,i){const n=rm(e.size);return new iu(t,{framebuffer:i,vs:"\n#define SHADER_NAME spring-transition-vertex-shader\n\n#define EPSILON 0.00001\n\nuniform float stiffness;\nuniform float damping;\nattribute ATTRIBUTE_TYPE aPrev;\nattribute ATTRIBUTE_TYPE aCur;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vNext;\nvarying float vIsTransitioningFlag;\n\nATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {\n  ATTRIBUTE_TYPE velocity = cur - prev;\n  ATTRIBUTE_TYPE delta = dest - cur;\n  ATTRIBUTE_TYPE spring = delta * stiffness;\n  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;\n  return spring + damper + velocity + cur;\n}\n\nvoid main(void) {\n  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;\n  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;\n\n  vNext = getNextValue(aCur, aPrev, aTo);\n  gl_Position = vec4(0, 0, 0, 1);\n  gl_PointSize = 100.0;\n}\n",fs:"\n#define SHADER_NAME spring-transition-is-transitioning-fragment-shader\n\nvarying float vIsTransitioningFlag;\n\nvoid main(void) {\n  if (vIsTransitioningFlag == 0.0) {\n    discard;\n  }\n  gl_FragColor = vec4(1.0);\n}",defines:{ATTRIBUTE_TYPE:n},varyings:["vNext"]})}(t,e,this.framebuffer);const n={byteLength:0,usage:35050};this.buffers=[new mo(t,n),new mo(t,n),new mo(t,n)]}get inProgress(){return this.transition.inProgress}start(t,e){const{gl:i,buffers:n,attribute:r}=this,s={numInstances:e,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const t of n)am({buffer:t,...s});this.settings=t,this.currentStartIndices=r.startIndices,this.currentLength=om(r,e),this.attributeInTransition.setData({buffer:n[1],value:r.value}),this.transition.start({...t,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aTo:nm(0,r)}})}update(){const{buffers:t,transform:e,framebuffer:i,transition:n}=this;if(!n.update())return!1;const r=this.settings;e.update({sourceBuffers:{aPrev:t[0],aCur:t[1]},feedbackBuffers:{vNext:t[2]}}),e.run({framebuffer:i,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:r.stiffness,damping:r.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),sm(t),this.attributeInTransition.setData({buffer:t[1],value:this.attribute.value});return Ro(i)[0]>0||n.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}}};class um{constructor(t,{id:e,timeline:i}){He(this,"id",void 0),He(this,"isSupported",void 0),He(this,"gl",void 0),He(this,"timeline",void 0),He(this,"transitions",void 0),He(this,"needsRedraw",void 0),He(this,"numInstances",void 0),this.id=e,this.gl=t,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=iu.isSupported(t)}finalize(){for(const t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:i}){this.numInstances=i||1;for(const i in t){const n=t[i],r=n.getTransitionSetting(e);r&&this._updateAttribute(i,n,r)}for(const i in this.transitions){const n=t[i];n&&n.getTransitionSetting(e)||this._removeTransition(i)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const i=this.transitions[e];i.inProgress&&(t[e]=i.attributeInTransition)}return t}run(){if(!this.isSupported||0===this.numInstances)return!1;for(const t in this.transitions){this.transitions[t].update()&&(this.needsRedraw=!0)}const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].cancel(),delete this.transitions[t]}_updateAttribute(t,e,i){const n=this.transitions[t];let r=!n||n.type!==i.type;if(r){if(!this.isSupported)return void kr.warn("WebGL2 not supported by this browser. Transition for ".concat(t," is disabled."))();n&&this._removeTransition(t);const s=hm[i.type];s?this.transitions[t]=new s({attribute:e,timeline:this.timeline,gl:this.gl}):(("unsupported transition type '".concat(i.type,"'"),()=>{})(),r=!1)}(r||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(i,this.numInstances))}}const dm="attributeManager.invalidate";class pm{constructor(t,{id:e="attribute-manager",stats:i,timeline:n}={}){He(this,"id",void 0),He(this,"gl",void 0),He(this,"attributes",void 0),He(this,"updateTriggers",void 0),He(this,"needsRedraw",void 0),He(this,"userData",void 0),He(this,"stats",void 0),He(this,"attributeTransitionManager",void 0),He(this,"mergeBoundsMemoized",Cu(Md)),this.id=e,this.gl=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new um(t,{id:"".concat(e,"-transitions"),timeline:n}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{instanced:1})}remove(t){for(const e of t)void 0!==this.attributes[e]&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){const i=this._invalidateTrigger(t,e);Nr(dm,this,t,i)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);Nr(dm,this,"all")}update({data:t,numInstances:e,startIndices:i=null,transitions:n,props:r={},buffers:s={},context:o={}}){let a=!1;Nr("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const n in this.attributes){const l=this.attributes[n],c=l.settings.accessor;l.startIndices=i,l.numInstances=e,r[n]&&kr.removed("props.".concat(n),"data.attributes.".concat(n))(),l.setExternalBuffer(s[n])||l.setBinaryValue("string"==typeof c?s[c]:void 0,t.startIndices)||"string"==typeof c&&!s[c]&&l.setConstantValue(r[c])||l.needsUpdate()&&(a=!0,this._updateAttribute({attribute:l,numInstances:e,data:t,props:r,context:o})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}a&&Nr("attributeManager.updateEnd",this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:n})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return this.attributes}getBounds(t){const e=t.map((t=>{var e;return null===(e=this.attributes[t])||void 0===e?void 0:e.getBounds()}));return this.mergeBoundsMemoized(e)}getChangedAttributes(t={clearChangedFlags:!1}){const{attributes:e,attributeTransitionManager:i}=this,n={...i.getAttributes()};for(const r in e){const s=e[r];s.needsRedraw(t)&&!i.hasAttribute(r)&&(n[r]=s)}return n}getShaderAttributes(t,e={}){t||(t=this.getAttributes());const i={};for(const n in t)e[n]||Object.assign(i,t[n].getShaderAttributes());return i}_add(t,e={}){for(const i in t){this.attributes[i]=this._createAttribute(i,t[i],e)}this._mapUpdateTriggersToAttributes()}_createAttribute(t,e,i){const n={...e,id:t,size:(e.isIndexed?1:e.size)||1,divisor:i.instanced?1:e.divisor||0};return new lm(this.gl,n)}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes){this.attributes[e].getUpdateTriggers().forEach((i=>{t[i]||(t[i]=[]),t[i].push(e)}))}this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:i,updateTriggers:n}=this,r=n[t];return r&&r.forEach((t=>{const n=i[t];n&&n.setNeedsUpdate(n.id,e)})),r}_updateAttribute(t){const{attribute:e,numInstances:i}=t;if(Nr("attribute.updateStart",e),e.constant)return void e.setConstantValue(e.value);e.allocate(i)&&Nr("attribute.allocate",e,i);e.updateBuffer(t)&&(this.needsRedraw=!0,Nr("attribute.updateEnd",e,i))}}const fm=1e-5;function mm(t,e,i,n,r){const s=e-t;return(i-e)*r+-s*n+s+e}function gm(t,e){if(Array.isArray(t)){let i=0;for(let n=0;n<t.length;n++){const r=t[n]-e[n];i+=r*r}return Math.sqrt(i)}return Math.abs(t-e)}const _m={interpolation:class extends mp{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:i,duration:n,easing:r}}=this,s=r(t/n);this._value=nc(e,i,s)}},spring:class extends mp{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:i,stiffness:n}=this.settings,{_prevValue:r=t,_currValue:s=t}=this;let o=function(t,e,i,n,r){if(Array.isArray(i)){const s=[];for(let o=0;o<i.length;o++)s[o]=mm(t[o],e[o],i[o],n,r);return s}return mm(t,e,i,n,r)}(r,s,e,i,n);const a=gm(o,e),l=gm(o,s);a<fm&&l<fm&&(o=e,this.end()),this._prevValue=s,this._currValue=o}}};class ym{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,i,n){const{transitions:r}=this;if(r.has(t)){const i=r.get(t),{value:n=i.settings.fromValue}=i;e=n,this.remove(t)}if(!(n=im(n)))return;const s=_m[n.type];if(!s)return void("unsupported transition type '".concat(n.type,"'"),()=>{})();const o=new s(this.timeline);o.start({...n,fromValue:e,toValue:i}),r.set(t,o)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,i]of this.transitions)i.update(),t[e]=i.value,i.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}function vm(t,e){const i=bm({newProps:t,oldProps:e,propTypes:t[qd],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=function(t,e){if(null===e)return"oldProps is null, initial diff";let i=!1;const{dataComparator:n,_dataDiff:r}=t;n?n(t.data,e.data)||(i="Data comparator detected a change"):t.data!==e.data&&(i="A new data container was supplied");i&&r&&(i=r(t.data,e.data)||i);return i}(t,e);let r=!1;return n||(r=function(t,e){if(null===e)return{all:!0};if("all"in t.updateTriggers){if(Tm(t,e,"all"))return{all:!0}}const i={};let n=!1;for(const r in t.updateTriggers)if("all"!==r){Tm(t,e,r)&&(i[r]=!0,n=!0)}return!!n&&i}(t,e)),{dataChanged:n,propsChanged:i,updateTriggersChanged:r,extensionsChanged:Am(t,e),transitionsChanged:xm(t,e)}}function xm(t,e){if(!t.transitions)return!1;const i={},n=t[qd];let r=!1;for(const s in t.transitions){const o=n[s],a=o&&o.type;("number"===a||"color"===a||"array"===a)&&wm(t[s],e[s],o)&&(i[s]=!0,r=!0)}return!!r&&i}function bm({newProps:t,oldProps:e,ignoreProps:i={},propTypes:n={},triggerName:r="props"}){if(e===t)return!1;if("object"!=typeof t||null===t)return"".concat(r," changed shallowly");if("object"!=typeof e||null===e)return"".concat(r," changed shallowly");for(const s of Object.keys(t))if(!(s in i)){if(!(s in e))return"".concat(r,".").concat(s," added");const i=wm(t[s],e[s],n[s]);if(i)return"".concat(r,".").concat(s," ").concat(i)}for(const s of Object.keys(e))if(!(s in i)){if(!(s in t))return"".concat(r,".").concat(s," dropped");if(!Object.hasOwnProperty.call(t,s)){const i=wm(t[s],e[s],n[s]);if(i)return"".concat(r,".").concat(s," ").concat(i)}}return!1}function wm(t,e,i){let n=i&&i.equal;return n&&!n(t,e,i)?"changed deeply":n||(n=t&&e&&t.equals,!n||n.call(t,e))?n||e===t?null:"changed shallowly":"changed deeply"}function Am(t,e){if(null===e)return!0;const i=e.extensions,{extensions:n}=t;if(n===i)return!1;if(!i||!n)return!0;if(n.length!==i.length)return!0;for(let t=0;t<n.length;t++)if(!n[t].equals(i[t]))return!0;return!1}function Tm(t,e,i){let n=t.updateTriggers[i];n=null==n?{}:n;let r=e.updateTriggers[i];r=null==r?{}:r;return bm({oldProps:r,newProps:n,triggerName:i})}function Mm(t){if(null===(e=t)||"object"!=typeof e)throw new Error("count(): argument not an object");var e;if("function"==typeof t.count)return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(function(t){return null!==t&&"object"==typeof t&&t.constructor===Object}(t))return Object.keys(t).length;throw new Error("count(): argument not a container")}function Sm(t,e){if(!e)return t;const i={...t,...e};if("defines"in e&&(i.defines={...t.defines,...e.defines}),"modules"in e&&(i.modules=(t.modules||[]).concat(e.modules),e.modules.some((t=>"project64"===t.name)))){const t=i.modules.findIndex((t=>"project32"===t.name));t>=0&&i.modules.splice(t,1)}if("inject"in e)if(t.inject){const n={...t.inject};for(const t in e.inject)n[t]=(n[t]||"")+e.inject[t];i.inject=n}else i.inject=e.inject;return i}const Em={10241:9987,10240:9729,10242:33071,10243:33071},Cm={};const Im={boolean:{validate:(t,e)=>!0,equal:(t,e,i)=>Boolean(t)===Boolean(e)},number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},color:{validate:(t,e)=>e.optional&&!t||Rm(t)&&(3===t.length||4===t.length),equal:(t,e,i)=>lp(t,e,1)},accessor:{validate(t,e){const i=Bm(t);return"function"===i||i===Bm(e.value)},equal:(t,e,i)=>"function"==typeof e||lp(t,e,1)},array:{validate:(t,e)=>e.optional&&!t||Rm(t),equal(t,e,i){const{compare:n}=i,r=Number.isInteger(n)?n:n?1:0;return n?lp(t,e,r):t===e}},object:{equal(t,e,i){if(i.ignore)return!0;const{compare:n}=i,r=Number.isInteger(n)?n:n?1:0;return n?lp(t,e,r):t===e}},function:{validate:(t,e)=>e.optional&&!t||"function"==typeof t,equal:(t,e,i)=>!i.compare&&!1!==i.ignore||t===e},data:{transform:(t,e,i)=>{const{dataTransform:n}=i.props;return n&&t?n(t):t}},image:{transform:(t,e,i)=>{const n=i.context;return n&&n.gl?function(t,e,i,n){if(i instanceof wo)return i;i.constructor&&"Object"!==i.constructor.name&&(i={data:i});let r=null;i.compressed&&(r={10241:i.data.length>1?9985:9729});const s=new wo(e,{...i,parameters:{...Em,...r,...n}});return Cm[s.id]=t,s}(i.id,n.gl,t,{...e.parameters,...i.props.textureParameters}):null},release:(t,e,i)=>{var n,r;n=i.id,(r=t)&&r instanceof wo&&Cm[r.id]===n&&(r.delete(),delete Cm[r.id])}}};function Pm(t,e){switch(Bm(e)){case"object":return Lm(t,e);case"array":return Lm(t,{type:"array",value:e,compare:!1});case"boolean":return Lm(t,{type:"boolean",value:e});case"number":return Lm(t,{type:"number",value:e});case"function":return Lm(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}function Lm(t,e){return"type"in e?{name:t,...Im[e.type],...e}:"value"in e?{name:t,type:Bm(e.value),...e}:{name:t,type:"object",value:e}}function Rm(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function Bm(t){return Rm(t)?"array":null===t?"null":typeof t}const Dm="_mergedDefaultProps";function Om(t,e){let i=Dm;if(e)for(const t of e){const e=t.constructor;e&&(i+=":".concat(e.extensionName||e.name))}const n=zm(t,i);return n||(t[i]=function(t,e){const i=t.prototype;if(!i)return null;const n=Object.getPrototypeOf(t),r=Om(n),s=zm(t,"defaultProps")||{},o=function(t){const e={},i={},n={};for(const[r,s]of Object.entries(t)){const t=null==s?void 0:s.deprecatedFor;if(t)n[r]=Array.isArray(t)?t:[t];else{const t=Pm(r,s);e[r]=t,i[r]=t.value}}return{propTypes:e,defaultProps:i,deprecatedProps:n}}(s),a=Object.assign(Object.create(null),r,o.defaultProps),l=Object.assign(Object.create(null),null==r?void 0:r[qd],o.propTypes),c=Object.assign(Object.create(null),null==r?void 0:r[Xd],o.deprecatedProps);for(const t of e){const e=Om(t.constructor);e&&(Object.assign(a,e),Object.assign(l,e[qd]),Object.assign(c,e[Xd]))}(function(t,e){const i=function(t){const e=t.componentName;e||kr.warn("".concat(t.name,".componentName not specified"))();return e||t.name}(e);Object.defineProperties(t,{id:{writable:!0,value:i}})})(a,t),function(t,e){const i={},n={};for(const t in e){const r=e[t],{name:s,value:o}=r;r.async&&(i[s]=o,n[s]=km(s))}t[Zd]=i,t[Jd]={},Object.defineProperties(t,n)}(a,l),function(t,e){for(const i in e)Object.defineProperty(t,i,{enumerable:!1,set(t){const n="".concat(this.id,": ").concat(i);for(const n of e[i])Fm(this,n)||(this[n]=t);kr.deprecated(n,e[i].join("/"))()}})}(a,c),a[qd]=l,a[Xd]=c,0!==e.length||Fm(t,"_propTypes")||(t._propTypes=l);return a}(t,e||[]))}function km(t){return{enumerable:!0,set(e){"string"==typeof e||e instanceof Promise||Yf(e)?this[Jd][t]=e:this[Yd][t]=e},get(){if(this[Yd]){if(t in this[Yd]){return this[Yd][t]||this[Zd][t]}if(t in this[Jd]){const e=this[Wd]&&this[Wd].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[Zd][t]}}return this[Zd][t]}}}function Fm(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function zm(t,e){return Fm(t,e)&&t[e]}let Nm=0;class Um{constructor(...t){He(this,"id",void 0),He(this,"props",void 0),He(this,"count",void 0),this.props=function(t,e){let i;for(let t=e.length-1;t>=0;t--){const n=e[t];"extensions"in n&&(i=n.extensions)}const n=Om(t.constructor,i),r=Object.create(n);r[Wd]=t,r[Jd]={},r[Yd]={};for(let t=0;t<e.length;++t){const i=e[t];for(const t in i)r[t]=i[t]}return Object.freeze(r),r}(this,t),this.id=this.props.id,this.count=Nm++}clone(t){const{props:e}=this,i={};for(const t in e[Zd])t in e[Yd]?i[t]=e[Yd][t]:t in e[Jd]&&(i[t]=e[Jd][t]);return new this.constructor({...e,...i,...t})}}He(Um,"componentName","Component"),He(Um,"defaultProps",{});const Gm=Object.freeze({});class Vm{constructor(t){He(this,"component",void 0),He(this,"onAsyncPropUpdated",void 0),He(this,"asyncProps",void 0),He(this,"oldProps",void 0),He(this,"oldAsyncProps",void 0),this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||Gm}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return Boolean(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[Wd]||this.component;const e=t[Yd]||{},i=t[Jd]||t,n=t[Zd]||{};for(const t in e){const i=e[t];this._createAsyncPropData(t,n[t]),this._updateAsyncProp(t,i),e[t]=this.getAsyncProp(t)}for(const t in i){const e=i[t];this._createAsyncPropData(t,n[t]),this._updateAsyncProp(t,e)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){this._didAsyncInputValueChange(t,e)&&("string"==typeof e&&(e=this._fetch(t,e)),e instanceof Promise?this._watchPromise(t,e):Yf(e)?this._resolveAsyncIterable(t,e):this._setPropValue(t,e))}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){const i=this.asyncProps[t];return e!==i.resolvedValue&&e!==i.lastValue&&(i.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();const i=this.asyncProps[t];i&&(e=this._postProcessValue(i,e),i.resolvedValue=e,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(t,e,i){const n=this.asyncProps[t];n&&i>=n.resolvedLoadCount&&void 0!==e&&(this._freezeAsyncOldProps(),n.resolvedValue=e,n.resolvedLoadCount=i,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const i=this.asyncProps[t];if(i){i.pendingLoadCount++;const n=i.pendingLoadCount;e.then((e=>{this.component&&(e=this._postProcessValue(i,e),this._setAsyncPropValue(t,e,n),this._onResolve(t,e))})).catch((e=>{this._onError(t,e)}))}}async _resolveAsyncIterable(t,e){if("data"!==t)return void this._setPropValue(t,e);const i=this.asyncProps[t];if(!i)return;i.pendingLoadCount++;const n=i.pendingLoadCount;let r=[],s=0;for await(const i of e){if(!this.component)return;const{dataTransform:e}=this.component.props;r=e?e(i,r):r.concat(i),Object.defineProperty(r,"__diff",{enumerable:!1,value:[{startRow:s,endRow:r.length}]}),s=r.length,this._setAsyncPropValue(t,r,n)}this._onResolve(t,r)}_postProcessValue(t,e){const i=t.type;return i&&this.component&&(i.release&&i.release(t.resolvedValue,i,this.component),i.transform)?i.transform(e,i,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const i=this.component&&this.component.props[qd];this.asyncProps[t]={type:i&&i[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}class jm extends Vm{constructor({attributeManager:t,layer:e}){super(e),He(this,"attributeManager",void 0),He(this,"needsRedraw",void 0),He(this,"needsUpdate",void 0),He(this,"subLayers",void 0),He(this,"usesPickingColorCache",void 0),He(this,"hasPickingBuffer",void 0),He(this,"changeFlags",void 0),He(this,"viewport",void 0),He(this,"uniformTransitions",void 0),He(this,"propsInTransition",void 0),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){const i=this.layer,n=null==i?void 0:i.props.fetch;return n?n(e,{propName:t,layer:i}):super._fetch(t,e)}_onResolve(t,e){const i=this.layer;if(i){const n=i.props.onDataLoad;"data"===t&&n&&n(e,{propName:t,layer:i})}}_onError(t,e){const i=this.layer;i&&i.raiseError(e,"loading ".concat(t," of ").concat(this.layer))}}const Hm=2**24-1,Wm=Object.freeze([]),qm=Cu((({oldViewport:t,viewport:e})=>t.equals(e)));let Xm=new Uint8ClampedArray(0);const Zm={data:{type:"data",value:Wm,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,{propName:e,layer:i,loaders:n,loadOptions:r,signal:s})=>{const{resourceManager:o}=i.context;var a;(r=r||i.getLoadOptions(),n=n||i.props.loaders,s)&&(r={...r,fetch:{...null===(a=r)||void 0===a?void 0:a.fetch,signal:s}});let l=o.contains(t);return l||r||(o.add({resourceId:t,data:Wn(t,n),persistent:!1}),l=!0),l?o.subscribe({resourceId:t,onChange:t=>{var n;return null===(n=i.internalState)||void 0===n?void 0:n.reloadAsyncProp(e,t)},consumerId:i.id,requestId:e}):Wn(t,n,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:Vr.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:t})=>[0,100*-t]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Jm extends Um{constructor(...t){super(...t),He(this,"internalState",null),He(this,"lifecycle",Nd),He(this,"context",void 0),He(this,"state",void 0),He(this,"parent",null)}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){return"".concat(this.constructor.layerName||this.constructor.name,"({id: '").concat(this.props.id,"'})")}project(t){pp(this.internalState);const e=this.internalState.viewport||this.context.viewport,i=Dd(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[n,r,s]=sd(i,e.pixelProjectionMatrix);return 2===t.length?[n,r]:[n,r,s]}unproject(t){pp(this.internalState);return(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){pp(this.internalState);return Od(t,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(t){for(const e of this.getModels())e.updateModuleSettings(t)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===Vr.DEFAULT||t===Vr.LNGLAT||t===Vr.CARTESIAN}onHover(t,e){return this.props.onHover&&this.props.onHover(t,e)||!1}onClick(t,e){return this.props.onClick&&this.props.onClick(t,e)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){pp(t instanceof Uint8Array);const[e,i,n]=t;return e+256*i+65536*n-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:Mm(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["positions","instancePositions"])}getShaders(t){for(const e of this.props.extensions)t=Sm(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){const e=this.getAttributeManager(),{dataChanged:i}=t.changeFlags;if(i&&e)if(Array.isArray(i))for(const t of i)e.invalidateAll(t);else e.invalidateAll();if(e){const{props:i}=t,n=this.internalState.hasPickingBuffer,r=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some((t=>t.getNeedsPickingBuffer.call(this,t)));if(n!==r){this.internalState.hasPickingBuffer=r;const{pickingColors:t,instancePickingColors:i}=e.attributes,n=t||i;n&&(r&&n.constant&&(n.constant=!1,e.invalidate(n.id)),n.value||r||(n.constant=!0,n.value=[0,0,0]))}}}finalizeState(t){for(const t of this.getModels())t.delete();const e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(const e of this.getModels())e.draw(t)}getPickingInfo({info:t}){const{index:e}=t;return e>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[e]),t}raiseError(t,e){var i,n,r,s;(e&&(t=new Error("".concat(e,": ").concat(t.message),{cause:t})),null!==(i=(n=this.props).onError)&&void 0!==i&&i.call(n,t))||(null===(r=this.context)||void 0===r||null===(s=r.onError)||void 0===s||s.call(r,t,this))}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var t;return(null===(t=this.internalState)||void 0===t?void 0:t.uniformTransitions.active)||!1}activateViewport(t){if(!this.internalState)return;const e=this.internalState.viewport;this.internalState.viewport=t,e&&qm({oldViewport:e,viewport:t})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all"){const e=this.getAttributeManager();e&&("all"===t?e.invalidateAll():e.invalidate(t))}updateAttributes(t){for(const e of this.getModels())this._setModelAttributes(e,t)}_updateAttributes(){const t=this.getAttributeManager();if(!t)return;const e=this.props,i=this.getNumInstances(),n=this.getStartIndices();t.update({data:e.data,numInstances:i,startIndices:n,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});const r=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(r)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),i=Object.create(this.props);for(const t in e)Object.defineProperty(i,t,{value:e[t]});return i}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;const i=Math.floor(Xm.length/3);if(this.internalState.usesPickingColorCache=!0,i<e){e>Hm&&kr.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),Xm=vd.allocate(Xm,e,{size:3,copy:!0,maxCount:Math.max(e,Hm)});const t=Math.floor(Xm.length/3),n=[];for(let e=i;e<t;e++)this.encodePickingColor(e,n),Xm[3*e+0]=n[0],Xm[3*e+1]=n[1],Xm[3*e+2]=n[2]}t.value=Xm.subarray(0,3*e)}_setModelAttributes(t,e){const i=this.getAttributeManager().getShaderAttributes(e,t.userData.excludeAttributes||{});t.setAttributes(i)}disablePickingIndex(t){const e=this.props.data;if(!("attributes"in e))return void this._disablePickingIndex(t);const{pickingColors:i,instancePickingColors:n}=this.getAttributeManager().attributes,r=i||n,s=r&&e.attributes&&e.attributes[r.id];if(s&&s.value){const i=s.value,n=this.encodePickingColor(t);for(let t=0;t<e.length;t++){const e=r.getVertexOffset(t);i[e]===n[0]&&i[e+1]===n[1]&&i[e+2]===n[2]&&this._disablePickingIndex(t)}}else this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:i}=this.getAttributeManager().attributes,n=e||i;if(!n)return;const r=n.getVertexOffset(t),s=n.getVertexOffset(t+1);n.buffer.subData({data:new Uint8Array(s-r),offset:r})}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,i=t||e;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==Xm.buffer&&(i.value=Xm.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){pp(!this.internalState),pp(Number.isFinite(this.props.coordinateSystem)),Nr("layer.initialize",this);const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new jm({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(kr.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.uniformTransitions=new ym(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){Nr("layer.matched",this,this===t);const{state:e,internalState:i}=t;this!==t&&(this.internalState=i,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const t=this.needsUpdate();if(Nr("layer.update",this,t),!t)return;const e=this.props,i=this.context,n=this.internalState,r=i.viewport,s=this._updateUniformTransition();n.propsInTransition=s,i.viewport=n.viewport||r,this.props=s;try{const t=this._getUpdateParams(),e=this.getModels();if(i.gl)this.updateState(t);else try{this.updateState(t)}catch(t){}for(const e of this.props.extensions)e.updateState.call(this,t,e);const n=this.getModels()[0]!==e[0];this._postUpdate(t,n)}finally{i.viewport=r,this.props=e,this._clearChangeFlags(),n.needsUpdate=!1,n.resetOldProps()}}_finalize(){Nr("layer.finalize",this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,this.context,t)}_drawLayer({moduleParameters:t=null,uniforms:e={},parameters:i={}}){this._updateAttributeTransition();const n=this.props,r=this.context;this.props=this.internalState.propsInTransition||n;e.opacity=Math.pow(this.props.opacity,1/2.2);try{t&&this.setModuleParameters(t);const{getPolygonOffset:n}=this.props,s=n&&n(e)||[0,0];Ps(r.gl,{polygonOffset:s}),Ls(r.gl,i,(()=>{const n={moduleParameters:t,uniforms:e,parameters:i,context:r};for(const t of this.props.extensions)t.draw.call(this,n,t);this.draw(n)}))}finally{this.props=n}}getChangeFlags(){var t;return null===(t=this.internalState)||void 0===t?void 0:t.changeFlags}setChangeFlags(t){if(!this.internalState)return;const{changeFlags:e}=this.internalState;for(const i in t)if(t[i]){let n=!1;if("dataChanged"===i){const r=t[i],s=e[i];r&&Array.isArray(s)&&(e.dataChanged=Array.isArray(r)?s.concat(r):r,n=!0)}e[i]||(e[i]=t[i],n=!0),n&&Nr("layer.changeFlag",this,i,t)}const i=Boolean(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=i,e.somethingChanged=i||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){const i=vm(t,e);if(i.updateTriggersChanged)for(const t in i.updateTriggersChanged)i.updateTriggersChanged[t]&&this.invalidateAttribute(t);if(i.transitionsChanged)for(const r in i.transitionsChanged){var n;this.internalState.uniformTransitions.add(r,e[r],t[r],null===(n=t.transitions)||void 0===n?void 0:n[r])}return this.setChangeFlags(i)}validateProps(){!function(t){const e=t[qd];for(const i in e){const n=e[i],{validate:r}=n;if(r&&!r(t[i],n))throw new Error("Invalid prop ".concat(i,": ").concat(t[i]))}}(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={pickingSelectedColor:t.picked?t.color:null},{highlightColor:i}=this.props;t.picked&&"function"==typeof i&&(e.pickingHighlightColor=i(t)),this.setModuleParameters(e),this.setNeedsRedraw()}_getAttributeManager(){const t=this.context;return new pm(t.gl,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){const{props:i,oldProps:n}=t;this.setNeedsRedraw(),this._updateAttributes();const{model:r}=this.state;null==r||r.setInstanceCount(this.getNumInstances());const{autoHighlight:s,highlightedObjectIndex:o,highlightColor:a}=i;if(e||n.autoHighlight!==s||n.highlightedObjectIndex!==o||n.highlightColor!==a){const t={};s||(t.pickingSelectedColor=null),Array.isArray(a)&&(t.pickingHighlightColor=a),(e||o!==n.highlightedObjectIndex)&&(t.pickingSelectedColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setModuleParameters(t)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id;const i=this.getAttributeManager(),n=!!i&&i.getNeedsRedraw(t);if(e=e||n,e)for(const t of this.props.extensions)t.onNeedsRedraw.call(this,t);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}He(Jm,"defaultProps",Zm),He(Jm,"layerName","Layer");class Ym extends Jm{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every((t=>t.isLoaded))}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id?(t.object=e.__source.object,t.index=e.__source.index,t):t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:i}=this.props;return i&&i[t]&&i[t].type||e}getSubLayerRow(t,e,i){return t.__source={parent:this,object:e,index:i},t}getSubLayerAccessor(t){if("function"==typeof t){const e={index:-1,data:this.props.data,target:[]};return(i,n)=>i&&i.__source?(e.index=i.__source.index,t(i.__source.object,e)):t(i,n)}return t}getSubLayerProps(t={}){var e;const{opacity:i,pickable:n,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:h,coordinateOrigin:u,wrapLongitude:d,positionFormat:p,modelMatrix:f,extensions:m,fetch:g,operation:_,_subLayerProps:y}=this.props,v={id:"",updateTriggers:{},opacity:i,pickable:n,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:l,highlightColor:c,coordinateSystem:h,coordinateOrigin:u,wrapLongitude:d,positionFormat:p,modelMatrix:f,extensions:m,fetch:g,operation:_},x=y&&t.id&&y[t.id],b=x&&x.updateTriggers,w=t.id||"sublayer";if(x){const e=this.props[qd],i=t.type?t.type._propTypes:{};for(const t in x){const n=i[t]||e[t];n&&"accessor"===n.type&&(x[t]=this.getSubLayerAccessor(x[t]))}}Object.assign(v,t,x),v.id="".concat(this.props.id,"-").concat(w),v.updateTriggers={all:null===(e=this.props.updateTriggers)||void 0===e?void 0:e.all,...t.updateTriggers,...b};for(const t of m){const e=t.getSubLayerProps.call(this,t);e&&Object.assign(v,e,{updateTriggers:Object.assign(v.updateTriggers,e.updateTriggers)})}return v}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let i=this.internalState.subLayers;const n=!i||this.needsUpdate();if(n){i=$d(this.renderLayers(),Boolean),this.internalState.subLayers=i}Nr("compositeLayer.renderLayers",this,n,i);for(const t of i)t.parent=this}}He(Ym,"layerName","CompositeLayer");class $m{static get componentName(){return Object.prototype.hasOwnProperty.call(this,"extensionName")?this.extensionName:""}constructor(t){He(this,"opts",void 0),t&&(this.opts=t)}equals(t){return this===t||this.constructor===t.constructor&&lp(this.opts,t.opts,1)}getShaders(t){return null}getSubLayerProps(t){const{defaultProps:e}=t.constructor,i={updateTriggers:{}};for(const t in e)if(t in this.props){const n=e[t],r=this.props[t];i[t]=r,n&&"accessor"===n.type&&(i.updateTriggers[t]=this.props.updateTriggers[t],"function"==typeof r&&(i[t]=this.getSubLayerAccessor(r)))}return i}initializeState(t,e){}updateState(t,e){}onNeedsRedraw(t){}getNeedsPickingBuffer(t){return!1}draw(t,e){}finalizeState(t,e){}}He($m,"defaultProps",{}),He($m,"extensionName","LayerExtension");class Km{constructor(t){He(this,"opts",void 0),He(this,"typedArrayManager",void 0),He(this,"indexStarts",[0]),He(this,"vertexStarts",[0]),He(this,"vertexCount",0),He(this,"instanceCount",0),He(this,"attributes",void 0),He(this,"_attributeDefs",void 0),He(this,"data",void 0),He(this,"getGeometry",void 0),He(this,"geometryBuffer",void 0),He(this,"buffers",void 0),He(this,"positionSize",void 0),He(this,"normalize",void 0);const{attributes:e={}}=t;this.typedArrayManager=vd,this.attributes={},this._attributeDefs=e,this.opts=t,this.updateGeometry(t)}updateGeometry(t){Object.assign(this.opts,t);const{data:e,buffers:i={},getGeometry:n,geometryBuffer:r,positionFormat:s,dataChanged:o,normalize:a=!0}=this.opts;if(this.data=e,this.getGeometry=n,this.positionSize=r&&r.size||("XY"===s?2:3),this.buffers=i,this.normalize=a,r&&(pp(e.startIndices),this.getGeometry=this.getGeometryFromBuffer(r),a||(i.positions=r)),this.geometryBuffer=i.positions,Array.isArray(o))for(const t of o)this._rebuildGeometry(t);else this._rebuildGeometry()}updatePartialGeometry({startRow:t,endRow:e}){this._rebuildGeometry({startRow:t,endRow:e})}getGeometryFromBuffer(t){const e=t.value||t;return ArrayBuffer.isView(e)?$f(e,{size:this.positionSize,offset:t.offset,stride:t.stride,startIndices:this.data.startIndices}):null}_allocate(t,e){const{attributes:i,buffers:n,_attributeDefs:r,typedArrayManager:s}=this;for(const o in r)if(o in n)s.release(i[o]),i[o]=null;else{const n=r[o];n.copy=e,i[o]=s.allocate(i[o],t,n)}}_forEachGeometry(t,e,i){const{data:n,getGeometry:r}=this,{iterable:s,objectInfo:o}=Jf(n,e,i);for(const e of s){o.index++;t(r?r(e,o):null,o.index)}}_rebuildGeometry(t){if(!this.data)return;let{indexStarts:e,vertexStarts:i,instanceCount:n}=this;const{data:r,geometryBuffer:s}=this,{startRow:o=0,endRow:a=1/0}=t||{},l={};if(t||(e=[0],i=[0]),this.normalize||!s)this._forEachGeometry(((t,e)=>{const n=t&&this.normalizeGeometry(t);l[e]=n,i[e+1]=i[e]+(n?this.getGeometrySize(n):0)}),o,a),n=i[i.length-1];else if(i=r.startIndices,n=i[r.length]||0,ArrayBuffer.isView(s))n=n||s.length/this.positionSize;else if(s instanceof mo){n=n||s.byteLength/(s.accessor.stride||4*this.positionSize)}else if(s.buffer){n=n||s.buffer.byteLength/(s.stride||4*this.positionSize)}else if(s.value){const t=s.value;n=n||t.length/(s.stride/t.BYTES_PER_ELEMENT||this.positionSize)}this._allocate(n,Boolean(t)),this.indexStarts=e,this.vertexStarts=i,this.instanceCount=n;const c={};this._forEachGeometry(((t,r)=>{const s=l[r]||t;c.vertexStart=i[r],c.indexStart=e[r];c.geometrySize=(r<i.length-1?i[r+1]:n)-i[r],c.geometryIndex=r,this.updateGeometryAttributes(s,c)}),o,a),this.vertexCount=e[e.length-1]}}const Qm=()=>{},tg={10241:9987,10240:9729,10242:33071,10243:33071};function eg(t,e,i,n){const r=Math.min(i/e.width,n/e.height),s=Math.floor(e.width*r),o=Math.floor(e.height*r);return 1===r?{data:e,width:s,height:o}:(t.canvas.height=o,t.canvas.width=s,t.clearRect(0,0,s,o),t.drawImage(e,0,0,e.width,e.height,0,0,s,o),{data:t.canvas,width:s,height:o})}function ig(t){return t&&(t.id||t.url)}function ng(t,e,i,n){const r=t.width,s=t.height,o=new wo(t.gl,{width:e,height:i,parameters:n});return function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{sourceX:n=0,sourceY:r=0,targetMipmaplevel:s=0,targetInternalFormat:o=6408}=i;let{targetX:a,targetY:l,targetZ:c,width:h,height:u}=i;const{framebuffer:d,deleteFramebuffer:p}=Do(t);Xs(d);const{gl:f,handle:m}=d,g=void 0!==a||void 0!==l||void 0!==c;a=a||0,l=l||0,c=c||0;const _=f.bindFramebuffer(36160,m);Xs(e);let y=null;if(e instanceof bo&&(y=e,h=Number.isFinite(h)?h:y.width,u=Number.isFinite(u)?u:y.height,y.bind(0),e=y.target),g)switch(e){case 3553:case 34067:f.copyTexSubImage2D(e,s,a,l,n,r,h,u);break;case 35866:case 32879:Kr(f).copyTexSubImage3D(e,s,a,l,c,n,r,h,u)}else f.copyTexImage2D(e,s,o,n,r,h,u,0);y&&y.unbind(),f.bindFramebuffer(36160,_||null),p&&d.delete()}(t,o,{targetY:0,width:r,height:s}),t.delete(),o}function rg(t,e,i){for(let n=0;n<e.length;n++){const{icon:r,xOffset:s}=e[n];t[ig(r)]={...r,x:s,y:i}}}class sg{constructor(t,{onUpdate:e=Qm,onError:i=Qm}){He(this,"gl",void 0),He(this,"onUpdate",void 0),He(this,"onError",void 0),He(this,"_loadOptions",null),He(this,"_texture",null),He(this,"_externalTexture",null),He(this,"_mapping",{}),He(this,"_textureParameters",null),He(this,"_pendingCount",0),He(this,"_autoPacking",!1),He(this,"_xOffset",0),He(this,"_yOffset",0),He(this,"_rowHeight",0),He(this,"_buffer",4),He(this,"_canvasWidth",1024),He(this,"_canvasHeight",0),He(this,"_canvas",null),this.gl=t,this.onUpdate=e,this.onError=i}finalize(){var t;null===(t=this._texture)||void 0===t||t.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(t){const e=this._autoPacking?ig(t):t;return this._mapping[e]||{}}setProps({loadOptions:t,autoPacking:e,iconAtlas:i,iconMapping:n,textureParameters:r}){var s;(t&&(this._loadOptions=t),void 0!==e&&(this._autoPacking=e),n&&(this._mapping=n),i)&&(null===(s=this._texture)||void 0===s||s.delete(),this._texture=null,this._externalTexture=i);r&&(this._textureParameters=r)}get isLoaded(){return 0===this._pendingCount}packIcons(t,e){if(!this._autoPacking||"undefined"==typeof document)return;const i=Object.values(function(t,e,i){if(!t||!e)return null;i=i||{};const n={},{iterable:r,objectInfo:s}=Jf(t);for(const t of r){s.index++;const r=e(t,s),o=ig(r);if(!r)throw new Error("Icon is missing.");if(!r.url)throw new Error("Icon url is missing.");n[o]||i[o]&&r.url===i[o].url||(n[o]={...r,source:t,sourceIndex:s.index})}return n}(t,e,this._mapping)||{});if(i.length>0){const{mapping:t,xOffset:e,yOffset:n,rowHeight:r,canvasHeight:s}=function({icons:t,buffer:e,mapping:i={},xOffset:n=0,yOffset:r=0,rowHeight:s=0,canvasWidth:o}){let a=[];for(let l=0;l<t.length;l++){const c=t[l];if(!i[ig(c)]){const{height:t,width:l}=c;n+l+e>o&&(rg(i,a,r),n=0,r=s+r+e,s=0,a=[]),a.push({icon:c,xOffset:n}),n=n+l+e,s=Math.max(s,t)}}return a.length>0&&rg(i,a,r),{mapping:i,rowHeight:s,xOffset:n,yOffset:r,canvasWidth:o,canvasHeight:(l=s+r+e,Math.pow(2,Math.ceil(Math.log2(l))))};var l}({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=r,this._mapping=t,this._xOffset=e,this._yOffset=n,this._canvasHeight=s,this._texture||(this._texture=new wo(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||tg})),this._texture.height!==this._canvasHeight&&(this._texture=ng(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||tg)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i)}}_loadIcons(t){const e=this._canvas.getContext("2d",{willReadFrequently:!0});for(const i of t)this._pendingCount++,Wn(i.url,this._loadOptions).then((t=>{const n=ig(i),r=this._mapping[n],{x:s,y:o,width:a,height:l}=r,{data:c,width:h,height:u}=eg(e,t,a,l);this._texture.setSubImageData({data:c,x:s+(a-h)/2,y:o+(l-u)/2,width:h,height:u}),r.width=h,r.height=u,this._texture.generateMipmap(),this.onUpdate()})).catch((t=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:t})})).finally((()=>{this._pendingCount--}))}}const og=[0,0,0,255],ag={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:t=>t.position},getIcon:{type:"accessor",value:t=>t.icon},getColor:{type:"accessor",value:og},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0}};class lg extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME icon-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\nattribute vec4 instanceIconFrames;\nattribute float instanceColorModes;\nattribute vec2 instanceOffsets;\nattribute vec2 instancePixelOffset;\n\nuniform float sizeScale;\nuniform vec2 iconsTextureDim;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform bool billboard;\nuniform int sizeUnits;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = angle * PI / 180.0;\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n\n  vec2 iconSize = instanceIconFrames.zw;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), \n    sizeMinPixels, sizeMaxPixels\n  );\n  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;\n  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;\n  pixelOffset += instancePixelOffset;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); \n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n\n  vTextureCoords = mix(\n    instanceIconFrames.xy,\n    instanceIconFrames.xy + iconSize,\n    (positions.xy + 1.0) / 2.0\n  ) / iconsTextureDim;\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n\n  vColorMode = instanceColorModes;\n}\n",fs:"#define SHADER_NAME icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float alphaCutoff;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec4 texColor = texture2D(iconsTexture, vTextureCoords);\n  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);\n  float a = texColor.a * opacity * vColor.a;\n\n  if (a < alphaCutoff) {\n    discard;\n  }\n\n  gl_FragColor = vec4(color, a);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[ip,np]})}initializeState(){this.state={iconManager:new sg(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})};this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:og},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(t){super.updateState(t);const{props:e,oldProps:i,changeFlags:n}=t,r=this.getAttributeManager(),{iconAtlas:s,iconMapping:o,data:a,getIcon:l,textureParameters:c}=e,{iconManager:h}=this.state,u=s||this.internalState.isAsyncPropLoading("iconAtlas");if(h.setProps({loadOptions:e.loadOptions,autoPacking:!u,iconAtlas:s,iconMapping:u?o:null,textureParameters:c}),u?i.iconMapping!==e.iconMapping&&r.invalidate("getIcon"):(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getIcon))&&h.packIcons(a,l),n.extensionsChanged){var d;const{gl:t}=this.context;null===(d=this.state.model)||void 0===d||d.delete(),this.state.model=this._getModel(t),r.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(t){super.finalizeState(t),this.state.iconManager.finalize()}draw({uniforms:t}){const{sizeScale:e,sizeMinPixels:i,sizeMaxPixels:n,sizeUnits:r,billboard:s,alphaCutoff:o}=this.props,{iconManager:a}=this.state,l=a.getTexture();l&&this.state.model.setUniforms(t).setUniforms({iconsTexture:l,iconsTextureDim:[l.width,l.height],sizeUnits:Hr[r],sizeScale:e,sizeMinPixels:i,sizeMaxPixels:n,billboard:s,alphaCutoff:o}).draw()}_getModel(t){return new Zh(t,{...this.getShaders(),id:this.props.id,geometry:new ru({drawMode:6,attributes:{positions:{size:2,value:new Float32Array([-1,-1,-1,1,1,1,1,-1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(t){var e;const i=null===(e=this.getCurrentLayer())||void 0===e?void 0:e.props.onIconError;i&&i(t)}getInstanceOffset(t){const{width:e,height:i,anchorX:n=e/2,anchorY:r=i/2}=this.state.iconManager.getIconMapping(t);return[e/2-n,i/2-r]}getInstanceColorMode(t){return this.state.iconManager.getIconMapping(t).mask?1:0}getInstanceIconFrame(t){const{x:e,y:i,width:n,height:r}=this.state.iconManager.getIconMapping(t);return[e,i,n,r]}}He(lg,"defaultProps",ag),He(lg,"layerName","IconLayer");const cg=[0,0,0,255],hg=[0,0,1],ug={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:t=>t.position},getNormal:{type:"accessor",value:hg},getColor:{type:"accessor",value:cg},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};class dg extends Jm{getShaders(){return super.getShaders({vs:"#define SHADER_NAME point-cloud-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 instanceNormals;\nattribute vec4 instanceColors;\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusPixels;\nuniform int sizeUnits;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.normal = project_normal(instanceNormals);\n  unitPosition = positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n  vec3 offset = vec3(positions.xy * project_size_to_pixel(radiusPixels, sizeUnits), 0.0);\n  DECKGL_FILTER_SIZE(offset, geometry);\n\n  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);\n  vColor = vec4(lightColor, instanceColors.a * opacity);\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME point-cloud-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition);\n\n  if (distToCenter > 1.0) {\n    discard;\n  }\n\n  gl_FragColor = vColor;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[ip,zh,np]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:hg},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:cg}})}updateState(t){const{changeFlags:e,props:i}=t;if(super.updateState(t),e.extensionsChanged){var n;const{gl:t}=this.context;null===(n=this.state.model)||void 0===n||n.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}e.dataChanged&&function(t){const{header:e,attributes:i}=t;e&&i&&(t.length=e.vertexCount,i.POSITION&&(i.instancePositions=i.POSITION),i.NORMAL&&(i.instanceNormals=i.NORMAL),i.COLOR_0&&(i.instanceColors=i.COLOR_0))}(i.data)}draw({uniforms:t}){const{pointSize:e,sizeUnits:i}=this.props;this.state.model.setUniforms(t).setUniforms({sizeUnits:Hr[i],radiusPixels:e}).draw()}_getModel(t){const e=[];for(let t=0;t<3;t++){const i=t/3*Math.PI*2;e.push(2*Math.cos(i),2*Math.sin(i),0)}return new Zh(t,{...this.getShaders(),id:this.props.id,geometry:new ru({drawMode:4,attributes:{positions:new Float32Array(e)}}),isInstanced:!0})}}He(dg,"layerName","PointCloudLayer"),He(dg,"defaultProps",ug);const pg=[0,0,0,255],fg={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:t=>t.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:pg},getLineColor:{type:"accessor",value:pg},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class mg extends Jm{getShaders(){return super.getShaders({vs:"#define SHADER_NAME scatterplot-layer-vertex-shader\n\nattribute vec3 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceRadius;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusScale;\nuniform float radiusMinPixels;\nuniform float radiusMaxPixels;\nuniform float lineWidthScale;\nuniform float lineWidthMinPixels;\nuniform float lineWidthMaxPixels;\nuniform float stroked;\nuniform bool filled;\nuniform bool antialiasing;\nuniform bool billboard;\nuniform int radiusUnits;\nuniform int lineWidthUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  outerRadiusPixels = clamp(\n    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),\n    radiusMinPixels, radiusMaxPixels\n  );\n  float lineWidthPixels = clamp(\n    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),\n    lineWidthMinPixels, lineWidthMaxPixels\n  );\n  outerRadiusPixels += stroked * lineWidthPixels / 2.0;\n  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;\n  unitPosition = edgePadding * positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n\n  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;\n  \n  if (billboard) {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = edgePadding * positions * outerRadiusPixels;\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#define SHADER_NAME scatterplot-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool filled;\nuniform float stroked;\nuniform bool antialiasing;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition) * outerRadiusPixels;\n  float inCircle = antialiasing ? \n    smoothedge(distToCenter, outerRadiusPixels) : \n    step(distToCenter, outerRadiusPixels);\n\n  if (inCircle == 0.0) {\n    discard;\n  }\n\n  if (stroked > 0.5) {\n    float isLine = antialiasing ? \n      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :\n      step(innerUnitRadius * outerRadiusPixels, distToCenter);\n\n    if (filled) {\n      gl_FragColor = mix(vFillColor, vLineColor, isLine);\n    } else {\n      if (isLine == 0.0) {\n        discard;\n      }\n      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);\n    }\n  } else if (!filled) {\n    discard;\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  gl_FragColor.a *= inCircle;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[ip,np]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){if(super.updateState(t),t.changeFlags.extensionsChanged){var e;const{gl:t}=this.context;null===(e=this.state.model)||void 0===e||e.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{radiusUnits:e,radiusScale:i,radiusMinPixels:n,radiusMaxPixels:r,stroked:s,filled:o,billboard:a,antialiasing:l,lineWidthUnits:c,lineWidthScale:h,lineWidthMinPixels:u,lineWidthMaxPixels:d}=this.props;this.state.model.setUniforms(t).setUniforms({stroked:s?1:0,filled:o,billboard:a,antialiasing:l,radiusUnits:Hr[e],radiusScale:i,radiusMinPixels:n,radiusMaxPixels:r,lineWidthUnits:Hr[c],lineWidthScale:h,lineWidthMinPixels:u,lineWidthMaxPixels:d}).draw()}_getModel(t){return new Zh(t,{...this.getShaders(),id:this.props.id,geometry:new ru({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0])}}}),isInstanced:!0})}}He(mg,"defaultProps",fg),He(mg,"layerName","ScatterplotLayer");const gg=1,_g=-1;function yg(t,e,i={}){const n=function(t,e={}){return Math.sign(function(t,e={}){const{start:i=0,end:n=t.length}=e,r=e.size||2;let s=0;for(let e=i,o=n-r;e<n;e+=r)s+=(t[e]-t[o])*(t[e+1]+t[o+1]),o=e;return s/2}(t,e))}(t,i);return n!==e&&(function(t,e){const{start:i=0,end:n=t.length,size:r=2}=e,s=(n-i)/r,o=Math.floor(s/2);for(let e=0;e<o;++e){const n=i+e*r,o=i+(s-1-e)*r;for(let e=0;e<r;++e){const i=t[n+e];t[n+e]=t[o+e],t[o+e]=i}}}(t,i),!0)}function vg(t,e){const i=e.length,n=t.length;if(n>0){let r=!0;for(let s=0;s<i;s++)if(t[n-i+s]!==e[s]){r=!1;break}if(r)return!1}for(let r=0;r<i;r++)t[n+r]=e[r];return!0}function xg(t,e){const i=e.length;for(let n=0;n<i;n++)t[n]=e[n]}function bg(t,e,i,n,r=[]){const s=n+e*i;for(let e=0;e<i;e++)r[e]=t[s+e];return r}function wg(t,e,i,n,r=[]){let s,o;if(8&i)s=(n[3]-t[1])/(e[1]-t[1]),o=3;else if(4&i)s=(n[1]-t[1])/(e[1]-t[1]),o=1;else if(2&i)s=(n[2]-t[0])/(e[0]-t[0]),o=2;else{if(!(1&i))return null;s=(n[0]-t[0])/(e[0]-t[0]),o=0}for(let i=0;i<t.length;i++)r[i]=(1&o)===i?n[o]:s*(e[i]-t[i])+t[i];return r}function Ag(t,e){let i=0;return t[0]<e[0]?i|=1:t[0]>e[2]&&(i|=2),t[1]<e[1]?i|=4:t[1]>e[3]&&(i|=8),i}function Tg(t,e){const{size:i=2,broken:n=!1,gridResolution:r=10,gridOffset:s=[0,0],startIndex:o=0,endIndex:a=t.length}=e||{},l=(a-o)/i;let c=[];const h=[c],u=bg(t,0,i,o);let d,p;const f=Pg(u,r,s,[]),m=[];vg(c,u);for(let e=1;e<l;e++){for(d=bg(t,e,i,o,d),p=Ag(d,f);p;){wg(u,d,p,f,m);const t=Ag(m,f);t&&(wg(u,m,t,f,m),p=t),vg(c,m),xg(u,m),Lg(f,r,p),n&&c.length>i&&(c=[],h.push(c),vg(c,u)),p=Ag(d,f)}vg(c,d),xg(u,d)}return n?h:h[0]}const Mg=0,Sg=1;function Eg(t,e){for(let i=0;i<e.length;i++)t.push(e[i]);return t}function Cg(t,e=null,i){if(!t.length)return[];const{size:n=2,gridResolution:r=10,gridOffset:s=[0,0],edgeTypes:o=!1}=i||{},a=[],l=[{pos:t,types:o?new Array(t.length/n).fill(Sg):null,holes:e||[]}],c=[[],[]];let h=[];for(;l.length;){const{pos:t,types:e,holes:i}=l.shift();Rg(t,n,i[0]||t.length,c),h=Pg(c[0],r,s,h);const u=Ag(c[1],h);if(u){let r=Ig(t,e,n,0,i[0]||t.length,h,u);const s={pos:r[0].pos,types:r[0].types,holes:[]},a={pos:r[1].pos,types:r[1].types,holes:[]};l.push(s,a);for(let l=0;l<i.length;l++)r=Ig(t,e,n,i[l],i[l+1]||t.length,h,u),r[0]&&(s.holes.push(s.pos.length),s.pos=Eg(s.pos,r[0].pos),o&&(s.types=Eg(s.types,r[0].types))),r[1]&&(a.holes.push(a.pos.length),a.pos=Eg(a.pos,r[1].pos),o&&(a.types=Eg(a.types,r[1].types)))}else{const n={positions:t};o&&(n.edgeTypes=e),i.length&&(n.holeIndices=i),a.push(n)}}return a}function Ig(t,e,i,n,r,s,o){const a=(r-n)/i,l=[],c=[],h=[],u=[],d=[];let p,f,m;const g=bg(t,a-1,i,n);let _=Math.sign(8&o?g[1]-s[3]:g[0]-s[2]),y=e&&e[a-1],v=0,x=0;for(let r=0;r<a;r++)p=bg(t,r,i,n,p),f=Math.sign(8&o?p[1]-s[3]:p[0]-s[2]),m=e&&e[n/i+r],f&&_&&_!==f&&(wg(g,p,o,s,d),vg(l,d)&&h.push(y),vg(c,d)&&u.push(y)),f<=0?(vg(l,p)&&h.push(m),v-=f):h.length&&(h[h.length-1]=Mg),f>=0?(vg(c,p)&&u.push(m),x+=f):u.length&&(u[u.length-1]=Mg),xg(g,p),_=f,y=m;return[v?{pos:l,types:e&&h}:null,x?{pos:c,types:e&&u}:null]}function Pg(t,e,i,n){const r=Math.floor((t[0]-i[0])/e)*e+i[0],s=Math.floor((t[1]-i[1])/e)*e+i[1];return n[0]=r,n[1]=s,n[2]=r+e,n[3]=s+e,n}function Lg(t,e,i){8&i?(t[1]+=e,t[3]+=e):4&i?(t[1]-=e,t[3]-=e):2&i?(t[0]+=e,t[2]+=e):1&i&&(t[0]-=e,t[2]-=e)}function Rg(t,e,i,n){let r=1/0,s=-1/0,o=1/0,a=-1/0;for(let n=0;n<i;n+=e){const e=t[n],i=t[n+1];r=e<r?e:r,s=e>s?e:s,o=i<o?i:o,a=i>a?i:a}return n[0][0]=r,n[0][1]=o,n[1][0]=s,n[1][1]=a,n}const Bg=85.051129;function Dg(t,e,i,n){let r=-1,s=-1;for(let o=i+1;o<n;o+=e){const e=Math.abs(t[o]);e>r&&(r=e,s=o-1)}return s}function Og(t,e,i,n,r=Bg){const s=t[i],o=t[n-e];if(Math.abs(s-o)>180){const n=bg(t,0,e,i);n[0]+=360*Math.round((o-s)/360),vg(t,n),n[1]=Math.sign(n[1])*r,vg(t,n),n[0]=s,vg(t,n)}}function kg(t,e,i,n){let r,s=t[0];for(let o=i;o<n;o+=e){r=t[o];const e=r-s;(e>180||e<-180)&&(r-=360*Math.round(e/360)),t[o]=s=r}}function Fg(t,e){let i;const n=t.length/e;for(let r=0;r<n&&(i=t[r*e],(i+180)%360==0);r++);const r=360*-Math.round(i/360);if(0!==r)for(let i=0;i<n;i++)t[i*e]+=r}function zg(t,e,i,n){let r;if(Array.isArray(t[0])){r=new Array(t.length*e);for(let i=0;i<t.length;i++)for(let n=0;n<e;n++)r[i*e+n]=t[i][n]||0}else r=t;return i?Tg(r,{size:e,gridResolution:i}):n?function(t,e){const{size:i=2,startIndex:n=0,endIndex:r=t.length,normalize:s=!0}=e||{},o=t.slice(n,r);kg(o,i,0,r-n);const a=Tg(o,{size:i,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(s)for(const t of a)Fg(t,i);return a}(r,{size:e}):r}class Ng extends Km{constructor(t){super({...t,attributes:{positions:{size:3,padding:18,initialize:!0,type:t.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(t){return this.attributes[t]}getGeometryFromBuffer(t){return this.normalize?super.getGeometryFromBuffer(t):null}normalizeGeometry(t){return this.normalize?zg(t,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):t}getGeometrySize(t){if(Ug(t)){let e=0;for(const i of t)e+=this.getGeometrySize(i);return e}const e=this.getPathLength(t);return e<2?0:this.isClosed(t)?e<3?0:e+2:e}updateGeometryAttributes(t,e){if(0!==e.geometrySize)if(t&&Ug(t))for(const i of t){const t=this.getGeometrySize(i);e.geometrySize=t,this.updateGeometryAttributes(i,e),e.vertexStart+=t}else this._updateSegmentTypes(t,e),this._updatePositions(t,e)}_updateSegmentTypes(t,e){const i=this.attributes.segmentTypes,n=!!t&&this.isClosed(t),{vertexStart:r,geometrySize:s}=e;i.fill(0,r,r+s),n?(i[r]=4,i[r+s-2]=4):(i[r]+=1,i[r+s-2]+=2),i[r+s-1]=4}_updatePositions(t,e){const{positions:i}=this.attributes;if(!i||!t)return;const{vertexStart:n,geometrySize:r}=e,s=new Array(3);for(let e=n,o=0;o<r;e++,o++)this.getPointOnPath(t,o,s),i[3*e]=s[0],i[3*e+1]=s[1],i[3*e+2]=s[2]}getPathLength(t){return t.length/this.positionSize}getPointOnPath(t,e,i=[]){const{positionSize:n}=this;e*n>=t.length&&(e+=1-t.length/n);const r=e*n;return i[0]=t[r],i[1]=t[r+1],i[2]=3===n&&t[r+2]||0,i}isClosed(t){if(!this.normalize)return Boolean(this.opts.loop);const{positionSize:e}=this,i=t.length-e;return t[0]===t[i]&&t[1]===t[i+1]&&(2===e||t[2]===t[i+2])}}function Ug(t){return Array.isArray(t[0])}const Gg=[0,0,0,255],Vg={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:t=>t.path},getColor:{type:"accessor",value:Gg},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},jg={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class Hg extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME path-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute float instanceTypes;\nattribute vec3 instanceStartPositions;\nattribute vec3 instanceEndPositions;\nattribute vec3 instanceLeftPositions;\nattribute vec3 instanceRightPositions;\nattribute vec3 instanceLeftPositions64Low;\nattribute vec3 instanceStartPositions64Low;\nattribute vec3 instanceEndPositions64Low;\nattribute vec3 instanceRightPositions64Low;\nattribute float instanceStrokeWidths;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\n\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform float jointType;\nuniform float capType;\nuniform float miterLimit;\nuniform bool billboard;\nuniform int widthUnits;\n\nuniform float opacity;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nconst float EPSILON = 0.001;\nconst vec3 ZERO_OFFSET = vec3(0.0);\n\nfloat flipIfTrue(bool flag) {\n  return -(float(flag) * 2. - 1.);\n}\nvec3 getLineJoinOffset(\n  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,\n  vec2 width\n) {\n  bool isEnd = positions.x > 0.0;\n  float sideOfPath = positions.y;\n  float isJoint = float(sideOfPath == 0.0);\n\n  vec3 deltaA3 = (currPoint - prevPoint);\n  vec3 deltaB3 = (nextPoint - currPoint);\n\n  mat3 rotationMatrix;\n  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);\n  if (needsRotation) {\n    deltaA3 = deltaA3 * rotationMatrix;\n    deltaB3 = deltaB3 * rotationMatrix;\n  }\n  vec2 deltaA = deltaA3.xy / width;\n  vec2 deltaB = deltaB3.xy / width;\n\n  float lenA = length(deltaA);\n  float lenB = length(deltaB);\n\n  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);\n  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);\n\n  vec2 perpA = vec2(-dirA.y, dirA.x);\n  vec2 perpB = vec2(-dirB.y, dirB.x);\n  vec2 tangent = dirA + dirB;\n  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;\n  vec2 miterVec = vec2(-tangent.y, tangent.x);\n  vec2 dir = isEnd ? dirA : dirB;\n  vec2 perp = isEnd ? perpA : perpB;\n  float L = isEnd ? lenA : lenB;\n  float sinHalfA = abs(dot(miterVec, perp));\n  float cosHalfA = abs(dot(dirA, miterVec));\n  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);\n  float cornerPosition = sideOfPath * turnDirection;\n\n  float miterSize = 1.0 / max(sinHalfA, EPSILON);\n  miterSize = mix(\n    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),\n    miterSize,\n    step(0.0, cornerPosition)\n  );\n\n  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))\n    * (sideOfPath + isJoint * turnDirection);\n  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));\n  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));\n  bool isCap = isStartCap || isEndCap;\n  if (isCap) {\n    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);\n    vJointType = capType;\n  } else {\n    vJointType = jointType;\n  }\n  vPathLength = L;\n  vCornerOffset = offsetVec;\n  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);\n  vMiterLength = isCap ? isJoint : vMiterLength;\n\n  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);\n  vPathPosition = vec2(\n    dot(offsetFromStartOfPath, perp),\n    dot(offsetFromStartOfPath, dir)\n  );\n  geometry.uv = vPathPosition;\n\n  float isValid = step(instanceTypes, 3.5);\n  vec3 offset = vec3(offsetVec * width * isValid, 0.0);\n\n  if (needsRotation) {\n    offset = rotationMatrix * offset;\n  }\n  return offset;\n}\nvoid clipLine(inout vec4 position, vec4 refPosition) {\n  if (position.w < EPSILON) {\n    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);\n    position = refPosition + (position - refPosition) * r;\n  }\n}\n\nvoid main() {\n  geometry.pickingColor = instancePickingColors;\n\n  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);\n\n  float isEnd = positions.x;\n\n  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);\n  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);\n\n  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);\n  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);\n\n  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);\n  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);\n\n  geometry.worldPosition = currPosition;\n  vec2 widthPixels = vec2(clamp(\n    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),\n    widthMinPixels, widthMaxPixels) / 2.0);\n  vec3 width;\n\n  if (billboard) {\n    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);\n    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);\n    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);\n\n    clipLine(prevPositionScreen, currPositionScreen);\n    clipLine(nextPositionScreen, currPositionScreen);\n    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));\n\n    width = vec3(widthPixels, 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(\n      prevPositionScreen.xyz / prevPositionScreen.w,\n      currPositionScreen.xyz / currPositionScreen.w,\n      nextPositionScreen.xyz / nextPositionScreen.w,\n      project_pixel_size_to_clipspace(width.xy)\n    );\n\n    DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);\n    gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);\n  } else {\n    prevPosition = project_position(prevPosition, prevPosition64Low);\n    currPosition = project_position(currPosition, currPosition64Low);\n    nextPosition = project_position(nextPosition, nextPosition64Low);\n\n    width = vec3(project_pixel_size(widthPixels), 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);\n    geometry.position = vec4(currPosition + offset, 1.0);\n    gl_Position = project_common_position_to_clipspace(geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME path-layer-fragment-shader\n\nprecision highp float;\n\nuniform float miterLimit;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nvoid main(void) {\n  geometry.uv = vPathPosition;\n\n  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {\n    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {\n      discard;\n    }\n    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {\n      discard;\n    }\n  }\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[ip,np]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:jg,accessor:"getPath",update:this.calculatePositions,noAlloc:true,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:true},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:jg,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:jg,defaultValue:Gg},instancePickingColors:{size:3,type:5121,accessor:(t,{index:e,target:i})=>this.encodePickingColor(t&&t.__source?t.__source.index:e,i)}}),this.setState({pathTesselator:new Ng({fp64:this.use64bitPositions()})})}updateState(t){super.updateState(t);const{props:e,changeFlags:i}=t,n=this.getAttributeManager();if(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPath)){const{pathTesselator:t}=this.state,r=e.data.attributes||{};t.updateGeometry({data:e.data,geometryBuffer:r.getPath,buffers:r,normalize:!e._pathType,loop:"loop"===e._pathType,getGeometry:e.getPath,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:i.dataChanged}),this.setState({numInstances:t.instanceCount,startIndices:t.vertexStarts}),i.dataChanged||n.invalidateAll()}if(i.extensionsChanged){var r;const{gl:t}=this.context;null===(r=this.state.model)||void 0===r||r.delete(),this.state.model=this._getModel(t),n.invalidateAll()}}getPickingInfo(t){const e=super.getPickingInfo(t),{index:i}=e,{data:n}=this.props;return n[0]&&n[0].__source&&(e.object=n.find((t=>t.__source.index===i))),e}disablePickingIndex(t){const{data:e}=this.props;if(e[0]&&e[0].__source)for(let i=0;i<e.length;i++)e[i].__source.index===t&&this._disablePickingIndex(i);else super.disablePickingIndex(t)}draw({uniforms:t}){const{jointRounded:e,capRounded:i,billboard:n,miterLimit:r,widthUnits:s,widthScale:o,widthMinPixels:a,widthMaxPixels:l}=this.props;this.state.model.setUniforms(t).setUniforms({jointType:Number(e),capType:Number(i),billboard:n,widthUnits:Hr[s],widthScale:o,miterLimit:r,widthMinPixels:a,widthMaxPixels:l}).draw()}_getModel(t){return new Zh(t,{...this.getShaders(),id:this.props.id,geometry:new ru({drawMode:4,attributes:{indices:new Uint16Array([0,1,2,1,4,2,1,3,4,3,5,4]),positions:{value:new Float32Array([0,0,0,-1,0,1,1,-1,1,1,1,0]),size:2}}}),isInstanced:!0})}calculatePositions(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateSegmentTypes(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("segmentTypes")}}He(Hg,"defaultProps",Vg),He(Hg,"layerName","PathLayer");var Wg={exports:{}};function qg(t,e,i){i=i||2;var n,r,s,o,a,l,c,h=e&&e.length,u=h?e[0]*i:t.length,d=Xg(t,0,u,i,!0),p=[];if(!d||d.next===d.prev)return p;if(h&&(d=function(t,e,i,n){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=Xg(t,e[r]*n,r<s-1?e[r+1]*n:t.length,n,!1))===o.next&&(o.steiner=!0),a.push(r_(o));for(a.sort(t_),r=0;r<a.length;r++)i=e_(a[r],i);return i}(t,e,d,i)),t.length>80*i){n=s=t[0],r=o=t[1];for(var f=i;f<u;f+=i)(a=t[f])<n&&(n=a),(l=t[f+1])<r&&(r=l),a>s&&(s=a),l>o&&(o=l);c=0!==(c=Math.max(s-n,o-r))?32767/c:0}return Jg(d,p,i,n,r,c,0),p}function Xg(t,e,i,n,r){var s,o;if(r===__(t,e,i,n)>0)for(s=e;s<i;s+=n)o=f_(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=f_(s,t[s],t[s+1],o);return o&&l_(o,o.next)&&(m_(o),o=o.next),o}function Zg(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!l_(n,n.next)&&0!==a_(n.prev,n,n.next))n=n.next;else{if(m_(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function Jg(t,e,i,n,r,s,o){if(t){!o&&s&&function(t,e,i,n){var r=t;do{0===r.z&&(r.z=n_(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,s,o,a,l,c=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<c&&(a++,n=n.nextZ);e++);for(l=c;a>0||l>0&&n;)0!==a&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,l--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,c*=2}while(o>1)}(r)}(t,n,r,s);for(var a,l,c=t;t.prev!==t.next;)if(a=t.prev,l=t.next,s?$g(t,n,r,s):Yg(t))e.push(a.i/i|0),e.push(t.i/i|0),e.push(l.i/i|0),m_(t),t=l.next,c=l.next;else if((t=l)===c){o?1===o?Jg(t=Kg(Zg(t),e,i),e,i,n,r,s,2):2===o&&Qg(t,e,i,n,r,s):Jg(Zg(t),e,i,n,r,s,1);break}}}function Yg(t){var e=t.prev,i=t,n=t.next;if(a_(e,i,n)>=0)return!1;for(var r=e.x,s=i.x,o=n.x,a=e.y,l=i.y,c=n.y,h=r<s?r<o?r:o:s<o?s:o,u=a<l?a<c?a:c:l<c?l:c,d=r>s?r>o?r:o:s>o?s:o,p=a>l?a>c?a:c:l>c?l:c,f=n.next;f!==e;){if(f.x>=h&&f.x<=d&&f.y>=u&&f.y<=p&&s_(r,a,s,l,o,c,f.x,f.y)&&a_(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function $g(t,e,i,n){var r=t.prev,s=t,o=t.next;if(a_(r,s,o)>=0)return!1;for(var a=r.x,l=s.x,c=o.x,h=r.y,u=s.y,d=o.y,p=a<l?a<c?a:c:l<c?l:c,f=h<u?h<d?h:d:u<d?u:d,m=a>l?a>c?a:c:l>c?l:c,g=h>u?h>d?h:d:u>d?u:d,_=n_(p,f,e,i,n),y=n_(m,g,e,i,n),v=t.prevZ,x=t.nextZ;v&&v.z>=_&&x&&x.z<=y;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&s_(a,h,l,u,c,d,v.x,v.y)&&a_(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&s_(a,h,l,u,c,d,x.x,x.y)&&a_(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=_;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&s_(a,h,l,u,c,d,v.x,v.y)&&a_(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&s_(a,h,l,u,c,d,x.x,x.y)&&a_(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Kg(t,e,i){var n=t;do{var r=n.prev,s=n.next.next;!l_(r,s)&&c_(r,n,n.next,s)&&d_(r,s)&&d_(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),m_(n),m_(n.next),n=t=s),n=n.next}while(n!==t);return Zg(n)}function Qg(t,e,i,n,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&o_(o,a)){var l=p_(o,a);return o=Zg(o,o.next),l=Zg(l,l.next),Jg(o,e,i,n,r,s,0),void Jg(l,e,i,n,r,s,0)}a=a.next}o=o.next}while(o!==t)}function t_(t,e){return t.x-e.x}function e_(t,e){var i=function(t,e){var i,n=e,r=t.x,s=t.y,o=-1/0;do{if(s<=n.y&&s>=n.next.y&&n.next.y!==n.y){var a=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(a<=r&&a>o&&(o=a,i=n.x<n.next.x?n:n.next,a===r))return i}n=n.next}while(n!==e);if(!i)return null;var l,c=i,h=i.x,u=i.y,d=1/0;n=i;do{r>=n.x&&n.x>=h&&r!==n.x&&s_(s<u?r:o,s,h,u,s<u?o:r,s,n.x,n.y)&&(l=Math.abs(s-n.y)/(r-n.x),d_(n,t)&&(l<d||l===d&&(n.x>i.x||n.x===i.x&&i_(i,n)))&&(i=n,d=l)),n=n.next}while(n!==c);return i}(t,e);if(!i)return e;var n=p_(i,t);return Zg(n,n.next),Zg(i,i.next)}function i_(t,e){return a_(t.prev,t,e.prev)<0&&a_(e.next,t,t.next)<0}function n_(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function r_(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function s_(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}function o_(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&c_(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(d_(t,e)&&d_(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(a_(t.prev,t,e.prev)||a_(t,e.prev,e))||l_(t,e)&&a_(t.prev,t,t.next)>0&&a_(e.prev,e,e.next)>0)}function a_(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function l_(t,e){return t.x===e.x&&t.y===e.y}function c_(t,e,i,n){var r=u_(a_(t,e,i)),s=u_(a_(t,e,n)),o=u_(a_(i,n,t)),a=u_(a_(i,n,e));return r!==s&&o!==a||(!(0!==r||!h_(t,i,e))||(!(0!==s||!h_(t,n,e))||(!(0!==o||!h_(i,t,n))||!(0!==a||!h_(i,e,n)))))}function h_(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function u_(t){return t>0?1:t<0?-1:0}function d_(t,e){return a_(t.prev,t,t.next)<0?a_(t,e,t.next)>=0&&a_(t,t.prev,e)>=0:a_(t,e,t.prev)<0||a_(t,t.next,e)<0}function p_(t,e){var i=new g_(t.i,t.x,t.y),n=new g_(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}function f_(t,e,i,n){var r=new g_(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function m_(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function g_(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function __(t,e,i,n){for(var r=0,s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}Wg.exports=qg,Wg.exports.default=qg,qg.deviation=function(t,e,i,n){var r=e&&e.length,s=Math.abs(__(t,0,r?e[0]*i:t.length,i));if(r)for(var o=0,a=e.length;o<a;o++){s-=Math.abs(__(t,e[o]*i,o<a-1?e[o+1]*i:t.length,i))}var l=0;for(o=0;o<n.length;o+=3){var c=n[o]*i,h=n[o+1]*i,u=n[o+2]*i;l+=Math.abs((t[c]-t[u])*(t[h+1]-t[c+1])-(t[c]-t[h])*(t[u+1]-t[c+1]))}return 0===s&&0===l?0:Math.abs((l-s)/s)},qg.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)i.vertices.push(t[r][s][o]);r>0&&i.holes.push(n+=t[r-1].length)}return i};var y_=Z(Wg.exports);const v_=gg,x_=_g,b_={isClosed:!0};function w_(t){return"positions"in t?t.positions:t}function A_(t){return"holeIndices"in t?t.holeIndices:null}function T_(t,e,i,n,r){let s=e;const o=i.length;for(let e=0;e<o;e++)for(let r=0;r<n;r++)t[s++]=i[e][r]||0;if(!function(t){const e=t[0],i=t[t.length-1];return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]}(i))for(let e=0;e<n;e++)t[s++]=i[0][e]||0;return b_.start=e,b_.end=s,b_.size=n,yg(t,r,b_),s}function M_(t,e,i,n,r=0,s,o){const a=(s=s||i.length)-r;if(a<=0)return e;let l=e;for(let e=0;e<a;e++)t[l++]=i[r+e];if(!function(t,e,i,n){for(let r=0;r<e;r++)if(t[i+r]!==t[n-e+r])return!1;return!0}(i,n,r,s))for(let e=0;e<n;e++)t[l++]=i[r+e];return b_.start=e,b_.end=l,b_.size=n,yg(t,o,b_),l}function S_(t,e){!function(t){if(t=t&&t.positions||t,!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error("invalid polygon")}(t);const i=[],n=[];if("positions"in t){const{positions:r,holeIndices:s}=t;if(s){let t=0;for(let o=0;o<=s.length;o++)t=M_(i,t,r,e,s[o-1],s[o],0===o?v_:x_),n.push(t);return n.pop(),{positions:i,holeIndices:n}}t=r}if(!function(t){return Array.isArray(t[0])}(t))return M_(i,0,t,e,0,i.length,v_),i;if(!function(t){return t.length>=1&&t[0].length>=2&&Number.isFinite(t[0][0])}(t)){let r=0;for(const[s,o]of t.entries())r=T_(i,r,o,e,0===s?v_:x_),n.push(r);return n.pop(),{positions:i,holeIndices:n}}return T_(i,0,t,e,v_),i}function E_(t,e,i){const n=t.length/3;let r=0;for(let s=0;s<n;s++){const o=(s+1)%n;r+=t[3*s+e]*t[3*o+i],r-=t[3*o+e]*t[3*s+i]}return Math.abs(r/2)}function C_(t,e,i,n){const r=t.length/3;for(let s=0;s<r;s++){const r=3*s,o=t[r+1],a=t[r+2];t[r+e]=t[r+0],t[r+i]=o,t[r+n]=a}}class I_ extends Km{constructor(t){const{fp64:e,IndexType:i=Uint32Array}=t;super({...t,attributes:{positions:{size:3,type:e?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:i,size:1}}})}get(t){const{attributes:e}=this;return"indices"===t?e.indices&&e.indices.subarray(0,this.vertexCount):e[t]}updateGeometry(t){super.updateGeometry(t);const e=this.buffers.indices;if(e)this.vertexCount=(e.value||e).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(t){if(this.normalize){const e=S_(t,this.positionSize);return this.opts.resolution?Cg(w_(e),A_(e),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?function(t,e=null,i){const{size:n=2,normalize:r=!0,edgeTypes:s=!1}=i||{};e=e||[];const o=[],a=[];let l=0,c=0;for(let r=0;r<=e.length;r++){const s=e[r]||t.length,h=c,u=Dg(t,n,l,s);for(let e=u;e<s;e++)o[c++]=t[e];for(let e=l;e<u;e++)o[c++]=t[e];kg(o,n,h,c),Og(o,n,h,c,null==i?void 0:i.maxLatitude),l=s,a[r]=c}a.pop();const h=Cg(o,a,{size:n,gridResolution:360,gridOffset:[-180,-180],edgeTypes:s});if(r)for(const t of h)Fg(t.positions,n);return h}(w_(e),A_(e),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):e}return t}getGeometrySize(t){if(P_(t)){let e=0;for(const i of t)e+=this.getGeometrySize(i);return e}return w_(t).length/this.positionSize}getGeometryFromBuffer(t){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(t):null}updateGeometryAttributes(t,e){if(t&&P_(t))for(const i of t){const t=this.getGeometrySize(i);e.geometrySize=t,this.updateGeometryAttributes(i,e),e.vertexStart+=t,e.indexStart=this.indexStarts[e.geometryIndex+1]}else this._updateIndices(t,e),this._updatePositions(t,e),this._updateVertexValid(t,e)}_updateIndices(t,{geometryIndex:e,vertexStart:i,indexStart:n}){const{attributes:r,indexStarts:s,typedArrayManager:o}=this;let a=r.indices;if(!a||!t)return;let l=n;const c=function(t,e,i,n){let r=A_(t);r&&(r=r.map((t=>t/e)));let s=w_(t);const o=n&&3===e;if(i){const t=s.length;s=s.slice();const n=[];for(let r=0;r<t;r+=e){n[0]=s[r],n[1]=s[r+1],o&&(n[2]=s[r+2]);const t=i(n);s[r]=t[0],s[r+1]=t[1],o&&(s[r+2]=t[2])}}if(o){const t=E_(s,0,1),e=E_(s,0,2),n=E_(s,1,2);if(!t&&!e&&!n)return[];t>e&&t>n||(e>n?(i||(s=s.slice()),C_(s,0,2,1)):(i||(s=s.slice()),C_(s,2,0,1)))}return y_(s,r,e)}(t,this.positionSize,this.opts.preproject,this.opts.full3d);a=o.allocate(a,n+c.length,{copy:!0});for(let t=0;t<c.length;t++)a[l++]=c[t]+i;s[e+1]=n+c.length,r.indices=a}_updatePositions(t,{vertexStart:e,geometrySize:i}){const{attributes:{positions:n},positionSize:r}=this;if(!n||!t)return;const s=w_(t);for(let t=e,o=0;o<i;t++,o++){const e=s[o*r+1],i=r>2?s[o*r+2]:0;n[3*t]=s[o*r],n[3*t+1]=e,n[3*t+2]=i}}_updateVertexValid(t,{vertexStart:e,geometrySize:i}){const{positionSize:n}=this,r=this.attributes.vertexValid,s=t&&A_(t);if(t&&t.edgeTypes?r.set(t.edgeTypes,e):r.fill(1,e,e+i),s)for(let t=0;t<s.length;t++)r[e+s[t]/n-1]=0;r[e+i-1]=0}}function P_(t){return Array.isArray(t)&&t.length>0&&!Number.isFinite(t[0])}var L_="\nattribute vec2 vertexPositions;\nattribute float vertexValid;\n\nuniform bool extruded;\nuniform bool isWireframe;\nuniform float elevationScale;\nuniform float opacity;\n\nvarying vec4 vColor;\n\nstruct PolygonProps {\n  vec4 fillColors;\n  vec4 lineColors;\n  vec3 positions;\n  vec3 nextPositions;\n  vec3 pickingColors;\n  vec3 positions64Low;\n  vec3 nextPositions64Low;\n  float elevations;\n};\n\nvec3 project_offset_normal(vec3 vector) {\n  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {\n    return normalize(vector * project_uCommonUnitsPerWorldUnit);\n  }\n  return project_normal(vector);\n}\n\nvoid calculatePosition(PolygonProps props) {\n#ifdef IS_SIDE_VERTEX\n  if(vertexValid < 0.5){\n    gl_Position = vec4(0.);\n    return;\n  }\n#endif\n\n  vec3 pos;\n  vec3 pos64Low;\n  vec3 normal;\n  vec4 colors = isWireframe ? props.lineColors : props.fillColors;\n\n  geometry.worldPosition = props.positions;\n  geometry.worldPositionAlt = props.nextPositions;\n  geometry.pickingColor = props.pickingColors;\n\n#ifdef IS_SIDE_VERTEX\n  pos = mix(props.positions, props.nextPositions, vertexPositions.x);\n  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);\n#else\n  pos = props.positions;\n  pos64Low = props.positions64Low;\n#endif\n\n  if (extruded) {\n    pos.z += props.elevations * vertexPositions.y * elevationScale;\n  }\n  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);\n\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  if (extruded) {\n  #ifdef IS_SIDE_VERTEX\n    normal = vec3(\n      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),\n      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),\n      0.0);\n    normal = project_offset_normal(normal);\n  #else\n    normal = project_normal(vec3(0.0, 0.0, 1.0));\n  #endif\n    geometry.normal = normal;\n    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);\n    vColor = vec4(lightColor, colors.a * opacity);\n  } else {\n    vColor = vec4(colors.rgb, colors.a * opacity);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",R_="#define SHADER_NAME solid-polygon-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 positions64Low;\nattribute float elevations;\nattribute vec4 fillColors;\nattribute vec4 lineColors;\nattribute vec3 pickingColors;\n\n".concat(L_,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  props.positions = positions;\n  props.positions64Low = positions64Low;\n  props.elevations = elevations;\n  props.fillColors = fillColors;\n  props.lineColors = lineColors;\n  props.pickingColors = pickingColors;\n\n  calculatePosition(props);\n}\n"),B_="#define SHADER_NAME solid-polygon-layer-vertex-shader-side\n#define IS_SIDE_VERTEX\n\n\nattribute vec3 instancePositions;\nattribute vec3 nextPositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 nextPositions64Low;\nattribute float instanceElevations;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\n".concat(L_,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  #if RING_WINDING_ORDER_CW == 1\n    props.positions = instancePositions;\n    props.positions64Low = instancePositions64Low;\n    props.nextPositions = nextPositions;\n    props.nextPositions64Low = nextPositions64Low;\n  #else\n    props.positions = nextPositions;\n    props.positions64Low = nextPositions64Low;\n    props.nextPositions = instancePositions;\n    props.nextPositions64Low = instancePositions64Low;\n  #endif\n  props.elevations = instanceElevations;\n  props.fillColors = instanceFillColors;\n  props.lineColors = instanceLineColors;\n  props.pickingColors = instancePickingColors;\n\n  calculatePosition(props);\n}\n");const D_=[0,0,0,255],O_={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:t=>t.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:D_},getLineColor:{type:"accessor",value:D_},material:!0},k_={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class F_ extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(t){return super.getShaders({vs:"top"===t?R_:B_,fs:"#define SHADER_NAME solid-polygon-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\n\nvoid main(void) {\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",defines:{RING_WINDING_ORDER_CW:this.props._normalize||"CCW"!==this.props._windingOrder?1:0},modules:[ip,zh,np]})}get wrapLongitude(){return!1}initializeState(){const{gl:t,viewport:e}=this.context;let{coordinateSystem:i}=this.props;const{_full3d:n}=this.props;let r;e.isGeospatial&&i===Vr.DEFAULT&&(i=Vr.LNGLAT),i===Vr.LNGLAT&&(r=n?e.projectPosition.bind(e):e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new I_({preproject:r,fp64:this.use64bitPositions(),IndexType:!t||Vo(t,ko)?Uint32Array:Uint16Array})});const s=this.getAttributeManager(),o=!0;s.remove(["instancePickingColors"]),s.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:k_,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,transition:k_,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:k_,accessor:"getFillColor",defaultValue:D_,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:k_,accessor:"getLineColor",defaultValue:D_,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(t,{index:e,target:i})=>this.encodePickingColor(t&&t.__source?t.__source.index:e,i),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:i}=e,{data:n}=this.props;return n[0]&&n[0].__source&&(e.object=n.find((t=>t.__source.index===i))),e}disablePickingIndex(t){const{data:e}=this.props;if(e[0]&&e[0].__source)for(let i=0;i<e.length;i++)e[i].__source.index===t&&this._disablePickingIndex(i);else super.disablePickingIndex(t)}draw({uniforms:t}){const{extruded:e,filled:i,wireframe:n,elevationScale:r}=this.props,{topModel:s,sideModel:o,polygonTesselator:a}=this.state,l={...t,extruded:Boolean(e),elevationScale:r};o&&(o.setInstanceCount(a.instanceCount-1),o.setUniforms(l),n&&(o.setDrawMode(3),o.setUniforms({isWireframe:!0}).draw()),i&&(o.setDrawMode(6),o.setUniforms({isWireframe:!1}).draw())),s&&(s.setVertexCount(a.vertexCount),s.setUniforms(l).draw())}updateState(t){super.updateState(t),this.updateGeometry(t);const{props:e,oldProps:i,changeFlags:n}=t,r=this.getAttributeManager();var s;(n.extensionsChanged||e.filled!==i.filled||e.extruded!==i.extruded)&&(null===(s=this.state.models)||void 0===s||s.forEach((t=>t.delete())),this.setState(this._getModels(this.context.gl)),r.invalidateAll())}updateGeometry({props:t,changeFlags:e}){if(e.dataChanged||e.updateTriggersChanged&&(e.updateTriggersChanged.all||e.updateTriggersChanged.getPolygon)){const{polygonTesselator:i}=this.state,n=t.data.attributes||{};i.updateGeometry({data:t.data,normalize:t._normalize,geometryBuffer:n.getPolygon,buffers:n,getGeometry:t.getPolygon,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:e.dataChanged,full3d:t._full3d}),this.setState({numInstances:i.instanceCount,startIndices:i.vertexStarts}),e.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(t){const{id:e,filled:i,extruded:n}=this.props;let r,s;if(i){const i=this.getShaders("top");i.defines.NON_INSTANCED_MODEL=1,r=new Zh(t,{...i,id:"".concat(e,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return n&&(s=new Zh(t,{...this.getShaders("side"),id:"".concat(e,"-side"),geometry:new ru({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),s.userData.excludeAttributes={indices:!0}),{models:[s,r].filter(Boolean),topModel:r,sideModel:s}}calculateIndices(t){const{polygonTesselator:e}=this.state;t.startIndices=e.indexStarts,t.value=e.get("indices")}calculatePositions(t){const{polygonTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateVertexValid(t){t.value=this.state.polygonTesselator.get("vertexValid")}}function z_({data:t,getIndex:e,dataRange:i,replace:n}){const{startRow:r=0,endRow:s=1/0}=i,o=t.length;let a=o,l=o;for(let i=0;i<o;i++){const n=e(t[i]);if(a>i&&n>=r&&(a=i),n>=s){l=i;break}}let c=a;const h=l-a!==n.length?t.slice(l):void 0;for(let e=0;e<n.length;e++)t[c++]=n[e];if(h){for(let e=0;e<h.length;e++)t[c++]=h[e];t.length=c}return{startRow:a,endRow:a+n.length}}He(F_,"defaultProps",O_),He(F_,"layerName","SolidPolygonLayer");const N_=.75,U_=[];class G_ extends lg{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:"#define SHADER_NAME multi-icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float gamma;\nuniform bool sdf;\nuniform float alphaCutoff;\nuniform float sdfBuffer;\nuniform float outlineBuffer;\nuniform vec4 outlineColor;\n\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  if (!picking_uActive) {\n    float alpha = texture2D(iconsTexture, vTextureCoords).a;\n    vec4 color = vColor;\n    if (sdf) {\n      float distance = alpha;\n      alpha = smoothstep(sdfBuffer - gamma, sdfBuffer + gamma, distance);\n\n      if (outlineBuffer > 0.0) {\n        float inFill = alpha;\n        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);\n        color = mix(outlineColor, vColor, inFill);\n        alpha = inBorder;\n      }\n    }\n    float a = alpha * color.a;\n    \n    if (a < alphaCutoff) {\n      discard;\n    }\n\n    gl_FragColor = vec4(color.rgb, a * opacity);\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n"}}initializeState(){super.initializeState();this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:e,target:i})=>this.encodePickingColor(e,i)}})}updateState(t){super.updateState(t);const{props:e,oldProps:i}=t;let{outlineColor:n}=e;n!==i.outlineColor&&(n=n.map((t=>t/255)),n[3]=Number.isFinite(n[3])?n[3]:1,this.setState({outlineColor:n})),!e.sdf&&e.outlineWidth&&kr.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(t){const{sdf:e,smoothing:i,outlineWidth:n}=this.props,{outlineColor:r}=this.state,s=n?Math.max(i,N_*(1-n)):-1;if(t.uniforms={...t.uniforms,sdfBuffer:N_,outlineBuffer:s,gamma:i,sdf:Boolean(e),outlineColor:r},super.draw(t),e&&n){const{iconManager:t}=this.state;t.getTexture()&&this.state.model.draw({uniforms:{outlineBuffer:N_}})}}getInstanceOffset(t){return t?Array.from(t).flatMap((t=>super.getInstanceOffset(t))):U_}getInstanceColorMode(t){return 1}getInstanceIconFrame(t){return t?Array.from(t).flatMap((t=>super.getInstanceIconFrame(t))):U_}}He(G_,"defaultProps",{getIconOffsets:{type:"accessor",value:t=>t.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}}),He(G_,"layerName","MultiIconLayer");const V_=1e20;class j_{constructor({fontSize:t=24,buffer:e=3,radius:i=8,cutoff:n=.25,fontFamily:r="sans-serif",fontWeight:s="normal",fontStyle:o="normal"}={}){this.buffer=e,this.cutoff=n,this.radius=i;const a=this.size=t+4*e,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${o} ${s} ${t}px ${r}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,actualBoundingBoxLeft:r,actualBoundingBoxRight:s}=this.ctx.measureText(t),o=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-r))),l=Math.min(this.size-this.buffer,o+Math.ceil(n)),c=a+2*this.buffer,h=l+2*this.buffer,u=Math.max(c*h,0),d=new Uint8ClampedArray(u),p={data:d,width:c,height:h,glyphWidth:a,glyphHeight:l,glyphTop:o,glyphLeft:0,glyphAdvance:e};if(0===a||0===l)return p;const{ctx:f,buffer:m,gridInner:g,gridOuter:_}=this;f.clearRect(m,m,a,l),f.fillText(t,m,m+o);const y=f.getImageData(m,m,a,l);_.fill(V_,0,u),g.fill(0,0,u);for(let t=0;t<l;t++)for(let e=0;e<a;e++){const i=y.data[4*(t*a+e)+3]/255;if(0===i)continue;const n=(t+m)*c+e+m;if(1===i)_[n]=0,g[n]=V_;else{const t=.5-i;_[n]=t>0?t*t:0,g[n]=t<0?t*t:0}}H_(_,0,0,c,h,c,this.f,this.v,this.z),H_(g,m,m,a,l,c,this.f,this.v,this.z);for(let t=0;t<u;t++){const e=Math.sqrt(_[t])-Math.sqrt(g[t]);d[t]=Math.round(255-255*(e/this.radius+this.cutoff))}return p}}function H_(t,e,i,n,r,s,o,a,l){for(let c=e;c<e+n;c++)W_(t,i*s+c,s,r,o,a,l);for(let c=i;c<i+r;c++)W_(t,c*s+e,1,n,o,a,l)}function W_(t,e,i,n,r,s,o){s[0]=0,o[0]=-V_,o[1]=V_,r[0]=t[e];for(let a=1,l=0,c=0;a<n;a++){r[a]=t[e+a*i];const n=a*a;do{const t=s[l];c=(r[a]-r[t]+n-t*t)/(a-t)/2}while(c<=o[l]&&--l>-1);l++,s[l]=a,o[l]=c,o[l+1]=V_}for(let a=0,l=0;a<n;a++){for(;o[l+1]<a;)l++;const n=s[l],c=a-n;t[e+a*i]=r[n]+c*c}}const q_=32,X_=[];function Z_(t,e,i,n){let r=0;for(let o=e;o<i;o++){var s;r+=(null===(s=n[t[o]])||void 0===s?void 0:s.layoutWidth)||0}return r}function J_(t,e,i,n,r,s){let o=e,a=0;for(let l=e;l<i;l++){const e=Z_(t,l,l+1,r);a+e>n&&(o<l&&s.push(l),o=l,a=0),a+=e}return a}function Y_(t,e,i,n,r=0,s){void 0===s&&(s=t.length);const o=[];return"break-all"===e?J_(t,r,s,i,n,o):function(t,e,i,n,r,s){let o=e,a=e,l=e,c=0;for(let h=e;h<i;h++)if(" "===t[h]?l=h+1:" "!==t[h+1]&&h+1!==i||(l=h+1),l>a){let e=Z_(t,a,l,r);c+e>n&&(o<a&&(s.push(a),o=a,c=0),e>n&&(e=J_(t,a,l,n,r,s),o=s[s.length-1])),a=l,c+=e}}(t,r,s,i,n,o),o}function $_(t,e,i,n,r,s){let o=0,a=0;for(let s=e;s<i;s++){const e=t[s],i=n[e];i?(a||(a=i.layoutHeight),r[s]=o+i.layoutWidth/2,o+=i.layoutWidth):(kr.warn("Missing character: ".concat(e," (").concat(e.codePointAt(0),")"))(),r[s]=o,o+=q_)}s[0]=o,s[1]=a}class K_{constructor(t=5){He(this,"limit",void 0),He(this,"_cache",{}),He(this,"_order",[]),this.limit=t}get(t){const e=this._cache[t];return e&&(this._deleteOrder(t),this._appendOrder(t)),e}set(t,e){this._cache[t]?(this.delete(t),this._cache[t]=e,this._appendOrder(t)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[t]=e,this._appendOrder(t))}delete(t){this._cache[t]&&(delete this._cache[t],this._deleteOrder(t))}_deleteOrder(t){const e=this._order.indexOf(t);e>=0&&this._order.splice(e,1)}_appendOrder(t){this._order.push(t)}}const Q_={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:function(){const t=[];for(let e=32;e<128;e++)t.push(String.fromCharCode(e));return t}(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1};let ty=new K_(3);function ey(t,e){for(let i=0;i<t.length;i++)e.data[4*i+3]=t[i]}function iy(t,e,i,n){t.font="".concat(n," ").concat(i,"px ").concat(e),t.fillStyle="#000",t.textBaseline="alphabetic",t.textAlign="left"}class ny{constructor(){He(this,"props",{...Q_}),He(this,"_key",void 0),He(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:t,buffer:e}=this.props;return(1.2*t+2*e)/t}setProps(t={}){Object.assign(this.props,t),this._key=this._getKey();const e=function(t,e){let i;i="string"==typeof e?new Set(Array.from(e)):new Set(e);const n=ty.get(t);if(!n)return i;for(const t in n.mapping)i.has(t)&&i.delete(t);return i}(this._key,this.props.characterSet),i=ty.get(this._key);if(i&&0===e.size)return void(this._atlas!==i&&(this._atlas=i));const n=this._generateFontAtlas(e,i);this._atlas=n,ty.set(this._key,n)}_generateFontAtlas(t,e){const{fontFamily:i,fontWeight:n,fontSize:r,buffer:s,sdf:o,radius:a,cutoff:l}=this.props;let c=e&&e.data;c||(c=document.createElement("canvas"),c.width=1024);const h=c.getContext("2d",{willReadFrequently:!0});iy(h,i,r,n);const{mapping:u,canvasHeight:d,xOffset:p,yOffset:f}=function({characterSet:t,getFontWidth:e,fontHeight:i,buffer:n,maxCanvasWidth:r,mapping:s={},xOffset:o=0,yOffset:a=0}){let l=0,c=o;const h=i+2*n;for(const o of t)if(!s[o]){const t=e(o);c+t+2*n>r&&(c=0,l++),s[o]={x:c+n,y:a+l*h+n,width:t,height:h,layoutWidth:t,layoutHeight:i},c+=t+2*n}return{mapping:s,xOffset:c,yOffset:a+l*h,canvasHeight:(u=a+(l+1)*h,Math.pow(2,Math.ceil(Math.log2(u))))};var u}({getFontWidth:t=>h.measureText(t).width,fontHeight:1.2*r,buffer:s,characterSet:t,maxCanvasWidth:1024,...e&&{mapping:e.mapping,xOffset:e.xOffset,yOffset:e.yOffset}});if(c.height!==d){const t=h.getImageData(0,0,c.width,c.height);c.height=d,h.putImageData(t,0,0)}if(iy(h,i,r,n),o){const e=new j_({fontSize:r,buffer:s,radius:a,cutoff:l,fontFamily:i,fontWeight:"".concat(n)});for(const i of t){const{data:t,width:n,height:s,glyphTop:o}=e.draw(i);u[i].width=n,u[i].layoutOffsetY=.9*r-o;const a=h.createImageData(n,s);ey(t,a),h.putImageData(a,u[i].x,u[i].y)}}else for(const e of t)h.fillText(e,u[e].x,u[e].y+s+.9*r);return{xOffset:p,yOffset:f,mapping:u,data:c,width:c.width,height:c.height}}_getKey(){const{fontFamily:t,fontWeight:e,fontSize:i,buffer:n,sdf:r,radius:s,cutoff:o}=this.props;return r?"".concat(t," ").concat(e," ").concat(i," ").concat(n," ").concat(s," ").concat(o):"".concat(t," ").concat(e," ").concat(i," ").concat(n)}}const ry={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:t=>t.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class sy extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME text-background-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec4 instanceRects;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec2 instancePixelOffsets;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform bool billboard;\nuniform float opacity;\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform vec4 padding;\nuniform int sizeUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = radians(angle);\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n  vLineWidth = instanceLineWidths;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),\n    sizeMinPixels, sizeMaxPixels\n  );\n\n  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;\n\n  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);\n  pixelOffset += instancePixelOffsets;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#define SHADER_NAME text-background-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool stroked;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec2 pixelPosition = uv * dimensions;\n  if (stroked) {\n    float distToEdge = min(\n      min(pixelPosition.x, dimensions.x - pixelPosition.x),\n      min(pixelPosition.y, dimensions.y - pixelPosition.y)\n    );\n    float isBorder = smoothedge(distToEdge, vLineWidth);\n    gl_FragColor = mix(vFillColor, vLineColor, isBorder);\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[ip,np]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){var i;const{gl:t}=this.context;null===(i=this.state.model)||void 0===i||i.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{billboard:e,sizeScale:i,sizeUnits:n,sizeMinPixels:r,sizeMaxPixels:s,getLineWidth:o}=this.props;let{padding:a}=this.props;a.length<4&&(a=[a[0],a[1],a[0],a[1]]),this.state.model.setUniforms(t).setUniforms({billboard:e,stroked:Boolean(o),padding:a,sizeUnits:Hr[n],sizeScale:i,sizeMinPixels:r,sizeMaxPixels:s}).draw()}_getModel(t){return new Zh(t,{...this.getShaders(),id:this.props.id,geometry:new ru({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,1,1,0,1])}}}),isInstanced:!0})}}He(sy,"defaultProps",ry),He(sy,"layerName","TextBackgroundLayer");const oy={start:1,middle:0,end:-1},ay={top:1,center:0,bottom:-1},ly=[0,0,0,255],cy={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:ly},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:Q_.characterSet},fontFamily:Q_.fontFamily,fontWeight:Q_.fontWeight,lineHeight:1,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:ly},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:t=>t.text},getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:ly},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class hy extends Ym{constructor(...t){super(...t),He(this,"state",void 0),He(this,"getBoundingRect",((t,e)=>{let{size:[i,n]}=this.transformParagraph(t,e);const{fontSize:r}=this.state.fontAtlasManager.props;i/=r,n/=r;const{getTextAnchor:s,getAlignmentBaseline:o}=this.props;return[(oy["function"==typeof s?s(t,e):s]-1)*i/2,(ay["function"==typeof o?o(t,e):o]-1)*n/2,i,n]})),He(this,"getIconOffsets",((t,e)=>{const{getTextAnchor:i,getAlignmentBaseline:n}=this.props,{x:r,y:s,rowWidth:o,size:[a,l]}=this.transformParagraph(t,e),c=oy["function"==typeof i?i(t,e):i],h=ay["function"==typeof n?n(t,e):n],u=r.length,d=new Array(2*u);let p=0;for(let t=0;t<u;t++){d[p++]=(c-1)*a/2+(1-c)*(a-o[t])/2+r[t],d[p++]=(h-1)*l/2+s[t]}return d}))}initializeState(){this.state={styleVersion:0,fontAtlasManager:new ny},this.props.maxWidth>0&&kr.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(t){const{props:e,oldProps:i,changeFlags:n}=t;(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getText))&&this._updateText();(this._updateFontAtlas()||e.lineHeight!==i.lineHeight||e.wordBreak!==i.wordBreak||e.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:t}){return t.object=t.index>=0?this.props.data[t.index]:null,t}_updateFontAtlas(){const{fontSettings:t,fontFamily:e,fontWeight:i}=this.props,{fontAtlasManager:n,characterSet:r}=this.state,s={...t,characterSet:r,fontFamily:e,fontWeight:i};if(!n.mapping)return n.setProps(s),!0;for(const t in s)if(s[t]!==n.props[t])return n.setProps(s),!0;return!1}_updateText(){var t;const{data:e,characterSet:i}=this.props,n=null===(t=e.attributes)||void 0===t?void 0:t.getText;let r,{getText:s}=this.props,o=e.startIndices;const a="auto"===i&&new Set;if(n&&o){const{texts:t,characterCount:i}=function({value:t,length:e,stride:i,offset:n,startIndices:r,characterSet:s}){const o=t.BYTES_PER_ELEMENT,a=i?i/o:1,l=n?n/o:0,c=r[e]||Math.ceil((t.length-l)/a),h=s&&new Set,u=new Array(e);let d=t;if(a>1||l>0){d=new(0,t.constructor)(c);for(let e=0;e<c;e++)d[e]=t[e*a+l]}for(let t=0;t<e;t++){const e=d.subarray(r[t],r[t+1]||c);u[t]=String.fromCodePoint.apply(null,e),h&&e.forEach(h.add,h)}if(h)for(const t of h)s.add(String.fromCodePoint(t));return{texts:u,characterCount:c}}({...ArrayBuffer.isView(n)?{value:n}:n,length:e.length,startIndices:o,characterSet:a});r=i,s=(e,{index:i})=>t[i]}else{const{iterable:t,objectInfo:i}=Jf(e);o=[0],r=0;for(const e of t){i.index++;const t=Array.from(s(e,i)||"");a&&t.forEach(a.add,a),r+=t.length,o.push(r)}}this.setState({getText:s,startIndices:o,numInstances:r,characterSet:a||i})}transformParagraph(t,e){const{fontAtlasManager:i}=this.state,n=i.mapping,r=this.state.getText,{wordBreak:s,lineHeight:o,maxWidth:a}=this.props;return function(t,e,i,n,r){const s=Array.from(t),o=s.length,a=new Array(o),l=new Array(o),c=new Array(o),h=("break-word"===i||"break-all"===i)&&isFinite(n)&&n>0,u=[0,0],d=[0,0];let p=0,f=0,m=0;for(let t=0;t<=o;t++){const _=s[t];if("\n"!==_&&t!==o||(m=t),m>f){const t=h?Y_(s,i,n,r,f,m):X_;for(let i=0;i<=t.length;i++){const n=0===i?f:t[i-1],o=i<t.length?t[i]:m;$_(s,n,o,r,a,d);for(let t=n;t<o;t++){var g;const e=(null===(g=r[s[t]])||void 0===g?void 0:g.layoutOffsetY)||0;l[t]=p+d[1]/2+e,c[t]=d[0]}p+=d[1]*e,u[0]=Math.max(u[0],d[0])}f=m}"\n"===_&&(a[f]=0,l[f]=0,c[f]=0,f++)}return u[1]=p,{x:a,y:l,rowWidth:c,size:u}}(r(t,e)||"",o,s,a*i.props.fontSize,n)}renderLayers(){const{startIndices:t,numInstances:e,getText:i,fontAtlasManager:{scale:n,texture:r,mapping:s},styleVersion:o}=this.state,{data:a,_dataDiff:l,getPosition:c,getColor:h,getSize:u,getAngle:d,getPixelOffset:p,getBackgroundColor:f,getBorderColor:m,getBorderWidth:g,backgroundPadding:_,background:y,billboard:v,fontSettings:x,outlineWidth:b,outlineColor:w,sizeScale:A,sizeUnits:T,sizeMinPixels:M,sizeMaxPixels:S,transitions:E,updateTriggers:C}=this.props,I=this.getSubLayerClass("characters",G_),P=this.getSubLayerClass("background",sy);return[y&&new P({getFillColor:f,getLineColor:m,getLineWidth:g,padding:_,getPosition:c,getSize:u,getAngle:d,getPixelOffset:p,billboard:v,sizeScale:A,sizeUnits:T,sizeMinPixels:M,sizeMaxPixels:S,transitions:E&&{getPosition:E.getPosition,getAngle:E.getAngle,getSize:E.getSize,getFillColor:E.getBackgroundColor,getLineColor:E.getBorderColor,getLineWidth:E.getBorderWidth,getPixelOffset:E.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:C.getPosition,getAngle:C.getAngle,getSize:C.getSize,getFillColor:C.getBackgroundColor,getLineColor:C.getBorderColor,getLineWidth:C.getBorderWidth,getPixelOffset:C.getPixelOffset,getBoundingRect:{getText:C.getText,getTextAnchor:C.getTextAnchor,getAlignmentBaseline:C.getAlignmentBaseline,styleVersion:o}}}),{data:a.attributes&&a.attributes.background?{length:a.length,attributes:a.attributes.background}:a,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new I({sdf:x.sdf,smoothing:Number.isFinite(x.smoothing)?x.smoothing:Q_.smoothing,outlineWidth:b/(x.radius||Q_.radius),outlineColor:w,iconAtlas:r,iconMapping:s,getPosition:c,getColor:h,getSize:u,getAngle:d,getPixelOffset:p,billboard:v,sizeScale:A*n,sizeUnits:T,sizeMinPixels:M*n,sizeMaxPixels:S*n,transitions:E&&{getPosition:E.getPosition,getAngle:E.getAngle,getColor:E.getColor,getSize:E.getSize,getPixelOffset:E.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:C.getText,getPosition:C.getPosition,getAngle:C.getAngle,getColor:C.getColor,getSize:C.getSize,getPixelOffset:C.getPixelOffset,getIconOffsets:{getTextAnchor:C.getTextAnchor,getAlignmentBaseline:C.getAlignmentBaseline,styleVersion:o}}}),{data:a,_dataDiff:l,startIndices:t,numInstances:e,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(t){!function(t){kr.assert(Number.isFinite(t)&&t>=3,"Invalid cache limit"),ty=new K_(t)}(t)}}He(hy,"defaultProps",cy),He(hy,"layerName","TextLayer");const uy={circle:{type:mg,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:lg,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:hy,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},dy={type:Hg,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},py={type:F_,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function fy({type:t,props:e}){const i={};for(const n in e)i[n]=t.defaultProps[e[n]];return i}function my(t,e){const{transitions:i,updateTriggers:n}=t.props,r={updateTriggers:{},transitions:i&&{getPosition:i.geometry}};for(const s in e){const o=e[s];let a=t.props[s];s.startsWith("get")&&(a=t.getSubLayerAccessor(a),r.updateTriggers[o]=n[s],i&&(r.transitions[o]=i[s])),r[o]=a}return r}function gy(t,e,i={}){const n={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:r=0,endRow:s=t.length}=i;for(let i=r;i<s;i++){const r=t[i],{geometry:s}=r;if(s)if("GeometryCollection"===s.type){kr.assert(Array.isArray(s.geometries),"GeoJSON does not have geometries array");const{geometries:t}=s;for(let s=0;s<t.length;s++){_y(t[s],n,e,r,i)}}else _y(s,n,e,r,i)}return n}function _y(t,e,i,n,r){const{type:s,coordinates:o}=t,{pointFeatures:a,lineFeatures:l,polygonFeatures:c,polygonOutlineFeatures:h}=e;if(function(t,e){let i=yy[t];kr.assert(i,"Unknown GeoJSON type ".concat(t));for(;e&&--i>0;)e=e[0];return e&&Number.isFinite(e[0])}(s,o))switch(s){case"Point":a.push(i({geometry:t},n,r));break;case"MultiPoint":o.forEach((t=>{a.push(i({geometry:{type:"Point",coordinates:t}},n,r))}));break;case"LineString":l.push(i({geometry:t},n,r));break;case"MultiLineString":o.forEach((t=>{l.push(i({geometry:{type:"LineString",coordinates:t}},n,r))}));break;case"Polygon":c.push(i({geometry:t},n,r)),o.forEach((t=>{h.push(i({geometry:{type:"LineString",coordinates:t}},n,r))}));break;case"MultiPolygon":o.forEach((t=>{c.push(i({geometry:{type:"Polygon",coordinates:t}},n,r)),t.forEach((t=>{h.push(i({geometry:{type:"LineString",coordinates:t}},n,r))}))}))}else kr.warn("".concat(s," coordinates are malformed"))()}const yy={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function vy(t){return t.geometry.coordinates}function xy(t,e){const i={points:{},lines:{},polygons:{},polygonsOutline:{}},{points:n,lines:r,polygons:s}=t,o=function(t,e){const i={points:null,lines:null,polygons:null};for(const n in i){const r=t[n].globalFeatureIds.value;i[n]=new Uint8ClampedArray(3*r.length);const s=[];for(let t=0;t<r.length;t++)e(r[t],s),i[n][3*t+0]=s[0],i[n][3*t+1]=s[1],i[n][3*t+2]=s[2]}return i}(t,e);return i.points.data={length:n.positions.value.length/n.positions.size,attributes:{...n.attributes,getPosition:n.positions,instancePickingColors:{size:3,value:o.points}},properties:n.properties,numericProps:n.numericProps,featureIds:n.featureIds},i.lines.data={length:r.pathIndices.value.length-1,startIndices:r.pathIndices.value,attributes:{...r.attributes,getPath:r.positions,instancePickingColors:{size:3,value:o.lines}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},i.lines._pathType="open",i.polygons.data={length:s.polygonIndices.value.length-1,startIndices:s.polygonIndices.value,attributes:{...s.attributes,getPolygon:s.positions,pickingColors:{size:3,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},i.polygons._normalize=!1,s.triangles&&(i.polygons.data.attributes.indices=s.triangles.value),i.polygonsOutline.data={length:s.primitivePolygonIndices.value.length-1,startIndices:s.primitivePolygonIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:3,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},i.polygonsOutline._pathType="open",i}const by=["points","linestrings","polygons"],wy={...fy(uy.circle),...fy(uy.icon),...fy(uy.text),...fy(dy),...fy(py),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:t=>t.properties.icon},getText:{type:"accessor",value:t=>t.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};let Ay=class extends Ym{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:t,changeFlags:e}){if(!e.dataChanged)return;const{data:i}=this.props,n=i&&"points"in i&&"polygons"in i&&"lines"in i;this.setState({binary:n}),n?this._updateStateBinary({props:t,changeFlags:e}):this._updateStateJSON({props:t,changeFlags:e})}_updateStateBinary({props:t}){const e=xy(t.data,this.encodePickingColor);this.setState({layerProps:e})}_updateStateJSON({props:t,changeFlags:e}){const i=function(t){if(Array.isArray(t))return t;switch(kr.assert(t.type,"GeoJSON does not have type"),t.type){case"Feature":return[t];case"FeatureCollection":return kr.assert(Array.isArray(t.features),"GeoJSON does not have features array"),t.features;default:return[{geometry:t}]}}(t.data),n=this.getSubLayerRow.bind(this);let r={};const s={};if(Array.isArray(e.dataChanged)){const t=this.state.features;for(const e in t)r[e]=t[e].slice(),s[e]=[];for(const o of e.dataChanged){const e=gy(i,n,o);for(const i in t)s[i].push(z_({data:r[i],getIndex:t=>t.__source.index,dataRange:o,replace:e[i]}))}}else r=gy(i,n);const o=function(t,e){const i={points:{},lines:{},polygons:{},polygonsOutline:{}},{pointFeatures:n,lineFeatures:r,polygonFeatures:s,polygonOutlineFeatures:o}=t;return i.points.data=n,i.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),i.points.getPosition=vy,i.lines.data=r,i.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),i.lines.getPath=vy,i.polygons.data=s,i.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),i.polygons.getPolygon=vy,i.polygonsOutline.data=o,i.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),i.polygonsOutline.getPath=vy,i}(r,s);this.setState({features:r,featuresDiff:s,layerProps:o})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:i,sourceLayer:n}=e;return e.featureType=by.find((t=>n.id.startsWith("".concat(this.id,"-").concat(t,"-")))),i>=0&&n.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(e.index=this.props.data.points.globalFeatureIds.value[i]),e}_updateAutoHighlight(t){const e="".concat(this.id,"-points-"),i="points"===t.featureType;for(const n of this.getSubLayers())n.id.startsWith(e)===i&&n.updateAutoHighlight(t)}_renderPolygonLayer(){const{extruded:t,wireframe:e}=this.props,{layerProps:i}=this.state,n="polygons-fill",r=this.shouldRenderSubLayer(n,i.polygons.data)&&this.getSubLayerClass(n,py.type);if(r){const s=my(this,py.props),o=t&&e;return o||delete s.getLineColor,s.updateTriggers.lineColors=o,new r(s,this.getSubLayerProps({id:n,updateTriggers:s.updateTriggers}),i.polygons)}return null}_renderLineLayers(){const{extruded:t,stroked:e}=this.props,{layerProps:i}=this.state,n="polygons-stroke",r="linestrings",s=!t&&e&&this.shouldRenderSubLayer(n,i.polygonsOutline.data)&&this.getSubLayerClass(n,dy.type),o=this.shouldRenderSubLayer(r,i.lines.data)&&this.getSubLayerClass(r,dy.type);if(s||o){const t=my(this,dy.props);return[s&&new s(t,this.getSubLayerProps({id:n,updateTriggers:t.updateTriggers}),i.polygonsOutline),o&&new o(t,this.getSubLayerProps({id:r,updateTriggers:t.updateTriggers}),i.lines)]}return null}_renderPointLayers(){const{pointType:t}=this.props,{layerProps:e,binary:i}=this.state;let{highlightedObjectIndex:n}=this.props;!i&&Number.isFinite(n)&&(n=e.points.data.findIndex((t=>t.__source.index===n)));const r=new Set(t.split("+")),s=[];for(const t of r){const r="points-".concat(t),o=uy[t],a=o&&this.shouldRenderSubLayer(r,e.points.data)&&this.getSubLayerClass(r,o.type);if(a){const l=my(this,o.props);let c=e.points;if("text"===t&&i){const{instancePickingColors:t,...e}=c.data.attributes;c={...c,data:{...c.data,attributes:e}}}s.push(new a(l,this.getSubLayerProps({id:r,updateTriggers:l.updateTriggers,highlightedObjectIndex:n}),c))}}return s}renderLayers(){const{extruded:t}=this.props,e=this._renderPolygonLayer();return[!t&&e,this._renderLineLayers(),this._renderPointLayers(),t&&e]}getSubLayerAccessor(t){const{binary:e}=this.state;return e&&"function"==typeof t?(e,i)=>{const{data:n,index:r}=i,s=function(t,e){if(!t)return null;const i="startIndices"in t?t.startIndices[e]:e;return-1!==i?function(t,e,i){const n={properties:{...t.properties[e]}};for(const e in t.numericProps)n.properties[e]=t.numericProps[e].value[i];return n}(t,t.featureIds.value[i],i):null}(n,r);return t(s,i)}:super.getSubLayerAccessor(t)}};He(Ay,"layerName","GeoJsonLayer"),He(Ay,"defaultProps",wy);const Ty=512,My=Math.PI/180;function Sy({map:t,gl:e,deck:i}){if(t.__deck)return t.__deck;const n=null==i?void 0:i.props._customRender,r=null==i?void 0:i.props.onLoad,s=(o={...null==i?void 0:i.props,_customRender:()=>{t.triggerRepaint(),null==n||n("")}},{...o,parameters:{depthMask:!0,depthTest:!0,blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthFunc:515,blendEquation:32774,...o.parameters},views:o.views||[new Np({id:"mapbox"})]});var o;let a;return i&&i.props.gl!==e||(Object.assign(s,{gl:e,width:null,height:null,touchAction:"unset",viewState:Cy(t)}),null!=i&&i.isInitialized?Ey(i,t):s.onLoad=()=>{null==r||r(),Ey(a,t)}),i?(a=i,i.setProps(s),i.userData.isExternal=!0):(a=new Vf(s),t.on("remove",(()=>{!function(t){var e;null===(e=t.__deck)||void 0===e||e.finalize(),t.__deck=null}(t)}))),a.userData.mapboxLayers=new Set,t.__deck=a,t.on("render",(()=>{a.isInitialized&&function(t,e){const{mapboxLayers:i,isExternal:n}=t.userData;if(n){const n=Array.from(i,(t=>t.id)),r=$d(t.props.layers,Boolean).some((t=>t&&!n.includes(t.id)));let s=t.getViewports();const o=s.findIndex((t=>"mapbox"===t.id));(r||(s.length>1||o<0))&&(o>=0&&(s=s.slice(),s[o]=Iy(t,e,!1)),t._drawLayers("mapbox-repaint",{viewports:s,layerFilter:e=>(!t.props.layerFilter||t.props.layerFilter(e))&&("mapbox"!==e.viewport.id||!n.includes(e.layer.id)),clearCanvas:!1}))}t.userData.currentViewport=null}(a,t)})),a}function Ey(t,e){const i=()=>{t.isInitialized?function(t,e){t.setProps({viewState:Cy(e)}),t.needsRedraw({clearRedrawFlags:!0})}(t,e):e.off("move",i)};e.on("move",i)}function Cy(t){var e;const{lng:i,lat:n}=t.getCenter(),r={longitude:(i+540)%360-180,latitude:n,zoom:t.getZoom(),bearing:t.getBearing(),pitch:t.getPitch(),padding:t.getPadding(),repeat:t.getRenderWorldCopies()};return null!==(e=t.getTerrain)&&void 0!==e&&e.call(t)&&function(t,e){if(t.getFreeCameraOptions){const{position:i}=t.getFreeCameraOptions();if(!i||void 0===i.z)return;const n=t.transform.height,{longitude:r,latitude:s,pitch:o}=e,a=i.x*Ty,l=(1-i.y)*Ty,c=i.z*Ty,h=$u([r,s]),u=a-h[0],d=l-h[1],p=Math.sqrt(u*u+d*d),f=o*My,m=1.5*n,g=f<.001?m*Math.cos(f)/c:m*Math.sin(f)/p;e.zoom=Math.log2(g);const _=m*Math.cos(f)/g;e.position=[0,0,(c-_)/td(s)]}else"number"==typeof t.transform.elevation&&(e.position=[0,0,t.transform.elevation])}(t,r),r}function Iy(t,e,i=!0){return new Ld({id:"mapbox",x:0,y:0,width:t.width,height:t.height,...Cy(e),nearZMultiplier:i?.02:.1,nearZ:e.transform._nearZ/e.transform.height,farZ:e.transform._farZ/e.transform.height})}function Py(t){if(t.userData.isExternal)return;const e=[];t.userData.mapboxLayers.forEach((t=>{const i=new(0,t.props.type)(t.props);e.push(i)})),t.setProps({layers:e})}class Ly{constructor(t){if(He(this,"id",void 0),He(this,"type",void 0),He(this,"renderingMode",void 0),He(this,"map",void 0),He(this,"deck",void 0),He(this,"props",void 0),!t.id)throw new Error("Layer must have an unique id");this.id=t.id,this.type="custom",this.renderingMode=t.renderingMode||"3d",this.map=null,this.deck=null,this.props=t}onAdd(t,e){var i;this.map=t,this.deck=Sy({map:t,gl:e,deck:this.props.deck}),(i=this.deck).userData.mapboxLayers.add(this),Py(i)}onRemove(){var t;this.deck&&((t=this.deck).userData.mapboxLayers.delete(this),Py(t))}setProps(t){Object.assign(this.props,t,{id:this.id}),this.deck&&Py(this.deck)}render(){!function(t,e,i){let{currentViewport:n}=t.userData,r=!1;n||(n=Iy(t,e,!0),t.userData.currentViewport=n,r=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[n],layerFilter:({layer:t})=>i.id===t.id||t.props.operation.includes("terrain"),clearStack:r,clearCanvas:!1})}(this.deck,this.map,this)}}class Ry extends $m{constructor(t){super(t),this.constructor.extensionName="ShaderExtension"}getShaders(t){return Object.assign({},super.getShaders(t),{inject:{"vs:#decl":"invariant gl_Position;"}})}}class By{constructor(t){this.implementation=t}onAdd(t,e){const i=this.implementation,n=i.id,r=Object.assign({},i,{type:Ay,extensions:[new Ry]}),s=t.map;this.map=t,delete r.minzoom,delete r.maxzoom,delete r.metadata,s.addLayer(new Ly(r),e||"poi"),s.setLayerZoomRange(n,i.minzoom,i.maxzoom),s.getLayer(n).metadata=i.metadata}}
/**
 * @license
 * Copyright 2010-2023 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const Dy="161",Oy=1,ky=2,Fy=3,zy=0,Ny=1,Uy=100,Gy=204,Vy=205,jy=0,Hy=1,Wy=2,qy=0,Xy=1,Zy=2,Jy=3,Yy=4,$y=5,Ky=6,Qy="attached",tv="detached",ev=300,iv=301,nv=302,rv=303,sv=304,ov=306,av=1e3,lv=1001,cv=1002,hv=1003,uv=1004,dv=1005,pv=1006,fv=1007,mv=1008,gv=1009,_v=1012,yv=1013,vv=1014,xv=1015,bv=1016,wv=1017,Av=1018,Tv=1020,Mv=1023,Sv=1026,Ev=1027,Cv=1029,Iv=1031,Pv=1033,Lv=33776,Rv=33777,Bv=33778,Dv=33779,Ov=35840,kv=35841,Fv=35842,zv=35843,Nv=36196,Uv=37492,Gv=37496,Vv=37808,jv=37809,Hv=37810,Wv=37811,qv=37812,Xv=37813,Zv=37814,Jv=37815,Yv=37816,$v=37817,Kv=37818,Qv=37819,tx=37820,ex=37821,ix=36492,nx=36494,rx=36495,sx=36284,ox=36285,ax=36286,lx=2300,cx=2301,hx=2302,ux=2400,dx=2401,px=2402,fx=2500,mx=2501,gx=3e3,_x=3001,yx="",vx="srgb",xx="srgb-linear",bx="display-p3",wx="display-p3-linear",Ax="linear",Tx="srgb",Mx="rec709",Sx="p3",Ex=7680,Cx=35044,Ix="300 es",Px=1035,Lx=2e3,Rx=2001;class Bx{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t);t.target=null}}}const Dx=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let Ox=1234567;const kx=Math.PI/180,Fx=180/Math.PI;function zx(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(Dx[255&t]+Dx[t>>8&255]+Dx[t>>16&255]+Dx[t>>24&255]+"-"+Dx[255&e]+Dx[e>>8&255]+"-"+Dx[e>>16&15|64]+Dx[e>>24&255]+"-"+Dx[63&i|128]+Dx[i>>8&255]+"-"+Dx[i>>16&255]+Dx[i>>24&255]+Dx[255&n]+Dx[n>>8&255]+Dx[n>>16&255]+Dx[n>>24&255]).toLowerCase()}function Nx(t,e,i){return Math.max(e,Math.min(i,t))}function Ux(t,e){return(t%e+e)%e}function Gx(t,e,i){return(1-i)*t+i*e}function Vx(t){return 0==(t&t-1)&&0!==t}function jx(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function Hx(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function Wx(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}const qx={DEG2RAD:kx,RAD2DEG:Fx,generateUUID:zx,clamp:Nx,euclideanModulo:Ux,mapLinear:function(t,e,i,n,r){return n+(t-e)*(r-n)/(i-e)},inverseLerp:function(t,e,i){return t!==e?(i-t)/(e-t):0},lerp:Gx,damp:function(t,e,i,n){return Gx(t,e,1-Math.exp(-i*n))},pingpong:function(t,e=1){return e-Math.abs(Ux(t,2*e)-e)},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){void 0!==t&&(Ox=t);let e=Ox+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},degToRad:function(t){return t*kx},radToDeg:function(t){return t*Fx},isPowerOfTwo:Vx,ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:jx,setQuaternionFromProperEuler:function(t,e,i,n,r){const s=Math.cos,o=Math.sin,a=s(i/2),l=o(i/2),c=s((e+n)/2),h=o((e+n)/2),u=s((e-n)/2),d=o((e-n)/2),p=s((n-e)/2),f=o((n-e)/2);switch(r){case"XYX":t.set(a*h,l*u,l*d,a*c);break;case"YZY":t.set(l*d,a*h,l*u,a*c);break;case"ZXZ":t.set(l*u,l*d,a*h,a*c);break;case"XZX":t.set(a*h,l*f,l*p,a*c);break;case"YXY":t.set(l*p,a*h,l*f,a*c);break;case"ZYZ":t.set(l*f,l*p,a*h,a*c)}},normalize:Wx,denormalize:Hx};class Xx{constructor(t=0,e=0){Xx.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(Nx(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*i-s*n+t.x,this.y=r*n+s*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Zx{constructor(t,e,i,n,r,s,o,a,l){Zx.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,i,n,r,s,o,a,l)}set(t,e,i,n,r,s,o,a,l){const c=this.elements;return c[0]=t,c[1]=n,c[2]=o,c[3]=e,c[4]=r,c[5]=a,c[6]=i,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],o=i[3],a=i[6],l=i[1],c=i[4],h=i[7],u=i[2],d=i[5],p=i[8],f=n[0],m=n[3],g=n[6],_=n[1],y=n[4],v=n[7],x=n[2],b=n[5],w=n[8];return r[0]=s*f+o*_+a*x,r[3]=s*m+o*y+a*b,r[6]=s*g+o*v+a*w,r[1]=l*f+c*_+h*x,r[4]=l*m+c*y+h*b,r[7]=l*g+c*v+h*w,r[2]=u*f+d*_+p*x,r[5]=u*m+d*y+p*b,r[8]=u*g+d*v+p*w,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],l=t[7],c=t[8];return e*s*c-e*o*l-i*r*c+i*o*a+n*r*l-n*s*a}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=c*s-o*l,u=o*a-c*r,d=l*r-s*a,p=e*h+i*u+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return t[0]=h*f,t[1]=(n*l-c*i)*f,t[2]=(o*i-n*s)*f,t[3]=u*f,t[4]=(c*e-n*a)*f,t[5]=(n*r-o*e)*f,t[6]=d*f,t[7]=(i*a-l*e)*f,t[8]=(s*e-i*r)*f,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,r,s,o){const a=Math.cos(r),l=Math.sin(r);return this.set(i*a,i*l,-i*(a*s+l*o)+s+t,-n*l,n*a,-n*(-l*s+a*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(Jx.makeScale(t,e)),this}rotate(t){return this.premultiply(Jx.makeRotation(-t)),this}translate(t,e){return this.premultiply(Jx.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,i,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const Jx=new Zx;function Yx(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}const $x={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function Kx(t,e){return new $x[t](e)}function Qx(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}function tb(){const t=Qx("canvas");return t.style.display="block",t}const eb={};function ib(t){t in eb||(eb[t]=!0)}const nb=(new Zx).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),rb=(new Zx).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),sb={[xx]:{transfer:Ax,primaries:Mx,toReference:t=>t,fromReference:t=>t},[vx]:{transfer:Tx,primaries:Mx,toReference:t=>t.convertSRGBToLinear(),fromReference:t=>t.convertLinearToSRGB()},[wx]:{transfer:Ax,primaries:Sx,toReference:t=>t.applyMatrix3(rb),fromReference:t=>t.applyMatrix3(nb)},[bx]:{transfer:Tx,primaries:Sx,toReference:t=>t.convertSRGBToLinear().applyMatrix3(rb),fromReference:t=>t.applyMatrix3(nb).convertLinearToSRGB()}},ob=new Set([xx,wx]),ab={enabled:!0,_workingColorSpace:xx,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(t){if(!ob.has(t))throw new Error(`Unsupported working color space, "${t}".`);this._workingColorSpace=t},convert:function(t,e,i){if(!1===this.enabled||e===i||!e||!i)return t;return(0,sb[i].fromReference)((0,sb[e].toReference)(t))},fromWorkingColorSpace:function(t,e){return this.convert(t,this._workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this._workingColorSpace)},getPrimaries:function(t){return sb[t].primaries},getTransfer:function(t){return t===yx?Ax:sb[t].transfer}};function lb(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function cb(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let hb;class ub{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===hb&&(hb=Qx("canvas")),hb.width=t.width,hb.height=t.height;const i=hb.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=hb}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=Qx("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height);const n=i.getImageData(0,0,t.width,t.height),r=n.data;for(let t=0;t<r.length;t++)r[t]=255*lb(r[t]/255);return i.putImageData(n,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e[t]=e instanceof Uint8Array||e instanceof Uint8ClampedArray?Math.floor(255*lb(e[t]/255)):lb(e[t]);return{data:e,width:t.width,height:t.height}}return t}}let db=0;class pb{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:db++}),this.uuid=zx(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)t.push(fb(n[e].isDataTexture?n[e].image:n[e]))}else t=fb(n);i.url=t}return e||(t.images[this.uuid]=i),i}}function fb(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?ub.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:{}}let mb=0;class gb extends Bx{constructor(t=gb.DEFAULT_IMAGE,e=gb.DEFAULT_MAPPING,i=1001,n=1001,r=1006,s=1008,o=1023,a=1009,l=gb.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:mb++}),this.uuid=zx(),this.name="",this.source=new pb(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=s,this.anisotropy=l,this.format=o,this.internalFormat=null,this.type=a,this.offset=new Xx(0,0),this.repeat=new Xx(1,1),this.center=new Xx(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Zx,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,"string"==typeof c?this.colorSpace=c:(ib("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=c===_x?vx:yx),this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),e||(t.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==ev)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case av:t.x=t.x-Math.floor(t.x);break;case lv:t.x=t.x<0?0:1;break;case cv:t.x=1===Math.abs(Math.floor(t.x)%2)?Math.ceil(t.x)-t.x:t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case av:t.y=t.y-Math.floor(t.y);break;case lv:t.y=t.y<0?0:1;break;case cv:t.y=1===Math.abs(Math.floor(t.y)%2)?Math.ceil(t.y)-t.y:t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}get encoding(){return ib("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace===vx?_x:gx}set encoding(t){ib("THREE.Texture: Property .encoding has been replaced by .colorSpace."),this.colorSpace=t===_x?vx:yx}}gb.DEFAULT_IMAGE=null,gb.DEFAULT_MAPPING=ev,gb.DEFAULT_ANISOTROPY=1;class _b{constructor(t=0,e=0,i=0,n=1){_b.prototype.isVector4=!0,this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*e+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*e+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*e+s[7]*i+s[11]*n+s[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,r;const s=.01,o=.1,a=t.elements,l=a[0],c=a[4],h=a[8],u=a[1],d=a[5],p=a[9],f=a[2],m=a[6],g=a[10];if(Math.abs(c-u)<s&&Math.abs(h-f)<s&&Math.abs(p-m)<s){if(Math.abs(c+u)<o&&Math.abs(h+f)<o&&Math.abs(p+m)<o&&Math.abs(l+d+g-3)<o)return this.set(1,0,0,0),this;e=Math.PI;const t=(l+1)/2,a=(d+1)/2,_=(g+1)/2,y=(c+u)/4,v=(h+f)/4,x=(p+m)/4;return t>a&&t>_?t<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(t),n=y/i,r=v/i):a>_?a<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(a),i=y/n,r=x/n):_<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(_),i=v/r,n=x/r),this.set(i,n,r,e),this}let _=Math.sqrt((m-p)*(m-p)+(h-f)*(h-f)+(u-c)*(u-c));return Math.abs(_)<.001&&(_=1),this.x=(m-p)/_,this.y=(h-f)/_,this.z=(u-c)/_,this.w=Math.acos((l+d+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class yb extends Bx{constructor(t=1,e=1,i={}){super(),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=1,this.scissor=new _b(0,0,t,e),this.scissorTest=!1,this.viewport=new _b(0,0,t,e);const n={width:t,height:e,depth:1};void 0!==i.encoding&&(ib("THREE.WebGLRenderTarget: option.encoding has been replaced by option.colorSpace."),i.colorSpace=i.encoding===_x?vx:yx),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:pv,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0},i),this.texture=new gb(n,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=i.generateMipmaps,this.texture.internalFormat=i.internalFormat,this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.depthTexture=i.depthTexture,this.samples=i.samples}setSize(t,e,i=1){this.width===t&&this.height===e&&this.depth===i||(this.width=t,this.height=e,this.depth=i,this.texture.image.width=t,this.texture.image.height=e,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.texture.isRenderTargetTexture=!0;const e=Object.assign({},t.texture.image);return this.texture.source=new pb(e),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class vb extends yb{constructor(t=1,e=1,i={}){super(t,e,i),this.isWebGLRenderTarget=!0}}class xb extends gb{constructor(t=null,e=1,i=1,n=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=hv,this.minFilter=hv,this.wrapR=lv,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class bb extends gb{constructor(t=null,e=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:i,depth:n},this.magFilter=hv,this.minFilter=hv,this.wrapR=lv,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class wb{constructor(t=0,e=0,i=0,n=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=n}static slerpFlat(t,e,i,n,r,s,o){let a=i[n+0],l=i[n+1],c=i[n+2],h=i[n+3];const u=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(0===o)return t[e+0]=a,t[e+1]=l,t[e+2]=c,void(t[e+3]=h);if(1===o)return t[e+0]=u,t[e+1]=d,t[e+2]=p,void(t[e+3]=f);if(h!==f||a!==u||l!==d||c!==p){let t=1-o;const e=a*u+l*d+c*p+h*f,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,e*i);t=Math.sin(t*s)/r,o=Math.sin(o*s)/r}const r=o*i;if(a=a*t+u*r,l=l*t+d*r,c=c*t+p*r,h=h*t+f*r,t===1-o){const t=1/Math.sqrt(a*a+l*l+c*c+h*h);a*=t,l*=t,c*=t,h*=t}}t[e]=a,t[e+1]=l,t[e+2]=c,t[e+3]=h}static multiplyQuaternionsFlat(t,e,i,n,r,s){const o=i[n],a=i[n+1],l=i[n+2],c=i[n+3],h=r[s],u=r[s+1],d=r[s+2],p=r[s+3];return t[e]=o*p+c*h+a*d-l*u,t[e+1]=a*p+c*u+l*h-o*d,t[e+2]=l*p+c*d+o*u-a*h,t[e+3]=c*p-o*h-a*u-l*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const i=t._x,n=t._y,r=t._z,s=t._order,o=Math.cos,a=Math.sin,l=o(i/2),c=o(n/2),h=o(r/2),u=a(i/2),d=a(n/2),p=a(r/2);switch(s){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],r=e[8],s=e[1],o=e[5],a=e[9],l=e[2],c=e[6],h=e[10],u=i+o+h;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(c-a)*t,this._y=(r-l)*t,this._z=(s-n)*t}else if(i>o&&i>h){const t=2*Math.sqrt(1+i-o-h);this._w=(c-a)/t,this._x=.25*t,this._y=(n+s)/t,this._z=(r+l)/t}else if(o>h){const t=2*Math.sqrt(1+o-i-h);this._w=(r-l)/t,this._x=(n+s)/t,this._y=.25*t,this._z=(a+c)/t}else{const t=2*Math.sqrt(1+h-i-o);this._w=(s-n)/t,this._x=(r+l)/t,this._y=(a+c)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Nx(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,r=t._z,s=t._w,o=e._x,a=e._y,l=e._z,c=e._w;return this._x=i*c+s*o+n*l-r*a,this._y=n*c+s*a+r*o-i*l,this._z=r*c+s*l+i*a-n*o,this._w=s*c-i*o-n*a-r*l,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,r=this._z,s=this._w;let o=s*t._w+i*t._x+n*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const a=1-o*o;if(a<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*r+e*this._z,this.normalize(),this}const l=Math.sqrt(a),c=Math.atan2(l,o),h=Math.sin((1-e)*c)/l,u=Math.sin(e*c)/l;return this._w=s*h+this._w*u,this._x=i*h+this._x*u,this._y=n*h+this._y*u,this._z=r*h+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){const t=Math.random(),e=Math.sqrt(1-t),i=Math.sqrt(t),n=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(e*Math.cos(n),i*Math.sin(r),i*Math.cos(r),e*Math.sin(n))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Ab{constructor(t=0,e=0,i=0){Ab.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Mb.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Mb.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*n,this.y=r[1]*e+r[4]*i+r[7]*n,this.z=r[2]*e+r[5]*i+r[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,r=t.elements,s=1/(r[3]*e+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*e+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*e+r[6]*i+r[10]*n+r[14])*s,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,o=t.z,a=t.w,l=2*(s*n-o*i),c=2*(o*e-r*n),h=2*(r*i-s*e);return this.x=e+a*l+s*h-o*c,this.y=i+a*c+o*l-r*h,this.z=n+a*h+r*c-s*l,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n,this.y=r[1]*e+r[5]*i+r[9]*n,this.z=r[2]*e+r[6]*i+r[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,r=t.z,s=e.x,o=e.y,a=e.z;return this.x=n*a-r*o,this.y=r*s-i*a,this.z=i*o-n*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Tb.copy(this).projectOnVector(t),this.sub(Tb)}reflect(t){return this.sub(Tb.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(Nx(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,i=Math.sqrt(1-t**2);return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this.z=t,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Tb=new Ab,Mb=new wb;class Sb{constructor(t=new Ab(1/0,1/0,1/0),e=new Ab(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e+=3)this.expandByPoint(Cb.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,i=t.count;e<i;e++)this.expandByPoint(Cb.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=Cb.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const i=t.geometry;if(void 0!==i){const n=i.getAttribute("position");if(!0===e&&void 0!==n&&!0!==t.isInstancedMesh)for(let e=0,i=n.count;e<i;e++)!0===t.isMesh?t.getVertexPosition(e,Cb):Cb.fromBufferAttribute(n,e),Cb.applyMatrix4(t.matrixWorld),this.expandByPoint(Cb);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),Ib.copy(t.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),Ib.copy(i.boundingBox)),Ib.applyMatrix4(t.matrixWorld),this.union(Ib)}const n=t.children;for(let t=0,i=n.length;t<i;t++)this.expandByObject(n[t],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,Cb),Cb.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(kb),Fb.subVectors(this.max,kb),Pb.subVectors(t.a,kb),Lb.subVectors(t.b,kb),Rb.subVectors(t.c,kb),Bb.subVectors(Lb,Pb),Db.subVectors(Rb,Lb),Ob.subVectors(Pb,Rb);let e=[0,-Bb.z,Bb.y,0,-Db.z,Db.y,0,-Ob.z,Ob.y,Bb.z,0,-Bb.x,Db.z,0,-Db.x,Ob.z,0,-Ob.x,-Bb.y,Bb.x,0,-Db.y,Db.x,0,-Ob.y,Ob.x,0];return!!Ub(e,Pb,Lb,Rb,Fb)&&(e=[1,0,0,0,1,0,0,0,1],!!Ub(e,Pb,Lb,Rb,Fb)&&(zb.crossVectors(Bb,Db),e=[zb.x,zb.y,zb.z],Ub(e,Pb,Lb,Rb,Fb)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,Cb).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(Cb).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(Eb[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),Eb[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),Eb[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),Eb[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),Eb[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),Eb[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),Eb[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),Eb[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(Eb)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const Eb=[new Ab,new Ab,new Ab,new Ab,new Ab,new Ab,new Ab,new Ab],Cb=new Ab,Ib=new Sb,Pb=new Ab,Lb=new Ab,Rb=new Ab,Bb=new Ab,Db=new Ab,Ob=new Ab,kb=new Ab,Fb=new Ab,zb=new Ab,Nb=new Ab;function Ub(t,e,i,n,r){for(let s=0,o=t.length-3;s<=o;s+=3){Nb.fromArray(t,s);const o=r.x*Math.abs(Nb.x)+r.y*Math.abs(Nb.y)+r.z*Math.abs(Nb.z),a=e.dot(Nb),l=i.dot(Nb),c=n.dot(Nb);if(Math.max(-Math.max(a,l,c),Math.min(a,l,c))>o)return!1}return!0}const Gb=new Sb,Vb=new Ab,jb=new Ab;class Hb{constructor(t=new Ab,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):Gb.setFromPoints(t).getCenter(i);let n=0;for(let e=0,r=t.length;e<r;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;Vb.subVectors(t,this.center);const e=Vb.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),i=.5*(t-this.radius);this.center.addScaledVector(Vb,i/t),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(jb.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Vb.copy(t.center).add(jb)),this.expandByPoint(Vb.copy(t.center).sub(jb))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const Wb=new Ab,qb=new Ab,Xb=new Ab,Zb=new Ab,Jb=new Ab,Yb=new Ab,$b=new Ab;class Kb{constructor(t=new Ab,e=new Ab(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Wb)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=Wb.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Wb.copy(this.origin).addScaledVector(this.direction,e),Wb.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){qb.copy(t).add(e).multiplyScalar(.5),Xb.copy(e).sub(t).normalize(),Zb.copy(this.origin).sub(qb);const r=.5*t.distanceTo(e),s=-this.direction.dot(Xb),o=Zb.dot(this.direction),a=-Zb.dot(Xb),l=Zb.lengthSq(),c=Math.abs(1-s*s);let h,u,d,p;if(c>0)if(h=s*a-o,u=s*o-a,p=r*c,h>=0)if(u>=-p)if(u<=p){const t=1/c;h*=t,u*=t,d=h*(h+s*u+2*o)+u*(s*h+u+2*a)+l}else u=r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+l;else u=-r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+l;else u<=-p?(h=Math.max(0,-(-s*r+o)),u=h>0?-r:Math.min(Math.max(-r,-a),r),d=-h*h+u*(u+2*a)+l):u<=p?(h=0,u=Math.min(Math.max(-r,-a),r),d=u*(u+2*a)+l):(h=Math.max(0,-(s*r+o)),u=h>0?r:Math.min(Math.max(-r,-a),r),d=-h*h+u*(u+2*a)+l);else u=s>0?-r:r,h=Math.max(0,-(s*u+o)),d=-h*h+u*(u+2*a)+l;return i&&i.copy(this.origin).addScaledVector(this.direction,h),n&&n.copy(qb).addScaledVector(Xb,u),d}intersectSphere(t,e){Wb.subVectors(t.center,this.origin);const i=Wb.dot(this.direction),n=Wb.dot(Wb)-i*i,r=t.radius*t.radius;if(n>r)return null;const s=Math.sqrt(r-n),o=i-s,a=i+s;return a<0?null:this.at(o<0?a:o,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);if(0===e)return!0;return t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,r,s,o,a;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(i=(t.min.x-u.x)*l,n=(t.max.x-u.x)*l):(i=(t.max.x-u.x)*l,n=(t.min.x-u.x)*l),c>=0?(r=(t.min.y-u.y)*c,s=(t.max.y-u.y)*c):(r=(t.max.y-u.y)*c,s=(t.min.y-u.y)*c),i>s||r>n?null:((r>i||isNaN(i))&&(i=r),(s<n||isNaN(n))&&(n=s),h>=0?(o=(t.min.z-u.z)*h,a=(t.max.z-u.z)*h):(o=(t.max.z-u.z)*h,a=(t.min.z-u.z)*h),i>a||o>n?null:((o>i||i!=i)&&(i=o),(a<n||n!=n)&&(n=a),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,Wb)}intersectTriangle(t,e,i,n,r){Jb.subVectors(e,t),Yb.subVectors(i,t),$b.crossVectors(Jb,Yb);let s,o=this.direction.dot($b);if(o>0){if(n)return null;s=1}else{if(!(o<0))return null;s=-1,o=-o}Zb.subVectors(this.origin,t);const a=s*this.direction.dot(Yb.crossVectors(Zb,Yb));if(a<0)return null;const l=s*this.direction.dot(Jb.cross(Zb));if(l<0)return null;if(a+l>o)return null;const c=-s*Zb.dot($b);return c<0?null:this.at(c/o,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Qb{constructor(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){Qb.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m)}set(t,e,i,n,r,s,o,a,l,c,h,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=n,g[1]=r,g[5]=s,g[9]=o,g[13]=a,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Qb).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/tw.setFromMatrixColumn(t,0).length(),r=1/tw.setFromMatrixColumn(t,1).length(),s=1/tw.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*s,e[9]=i[9]*s,e[10]=i[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,i=t.x,n=t.y,r=t.z,s=Math.cos(i),o=Math.sin(i),a=Math.cos(n),l=Math.sin(n),c=Math.cos(r),h=Math.sin(r);if("XYZ"===t.order){const t=s*c,i=s*h,n=o*c,r=o*h;e[0]=a*c,e[4]=-a*h,e[8]=l,e[1]=i+n*l,e[5]=t-r*l,e[9]=-o*a,e[2]=r-t*l,e[6]=n+i*l,e[10]=s*a}else if("YXZ"===t.order){const t=a*c,i=a*h,n=l*c,r=l*h;e[0]=t+r*o,e[4]=n*o-i,e[8]=s*l,e[1]=s*h,e[5]=s*c,e[9]=-o,e[2]=i*o-n,e[6]=r+t*o,e[10]=s*a}else if("ZXY"===t.order){const t=a*c,i=a*h,n=l*c,r=l*h;e[0]=t-r*o,e[4]=-s*h,e[8]=n+i*o,e[1]=i+n*o,e[5]=s*c,e[9]=r-t*o,e[2]=-s*l,e[6]=o,e[10]=s*a}else if("ZYX"===t.order){const t=s*c,i=s*h,n=o*c,r=o*h;e[0]=a*c,e[4]=n*l-i,e[8]=t*l+r,e[1]=a*h,e[5]=r*l+t,e[9]=i*l-n,e[2]=-l,e[6]=o*a,e[10]=s*a}else if("YZX"===t.order){const t=s*a,i=s*l,n=o*a,r=o*l;e[0]=a*c,e[4]=r-t*h,e[8]=n*h+i,e[1]=h,e[5]=s*c,e[9]=-o*c,e[2]=-l*c,e[6]=i*h+n,e[10]=t-r*h}else if("XZY"===t.order){const t=s*a,i=s*l,n=o*a,r=o*l;e[0]=a*c,e[4]=-h,e[8]=l*c,e[1]=t*h+r,e[5]=s*c,e[9]=i*h-n,e[2]=n*h-i,e[6]=o*c,e[10]=r*h+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(iw,t,nw)}lookAt(t,e,i){const n=this.elements;return ow.subVectors(t,e),0===ow.lengthSq()&&(ow.z=1),ow.normalize(),rw.crossVectors(i,ow),0===rw.lengthSq()&&(1===Math.abs(i.z)?ow.x+=1e-4:ow.z+=1e-4,ow.normalize(),rw.crossVectors(i,ow)),rw.normalize(),sw.crossVectors(ow,rw),n[0]=rw.x,n[4]=sw.x,n[8]=ow.x,n[1]=rw.y,n[5]=sw.y,n[9]=ow.y,n[2]=rw.z,n[6]=sw.z,n[10]=ow.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,r=this.elements,s=i[0],o=i[4],a=i[8],l=i[12],c=i[1],h=i[5],u=i[9],d=i[13],p=i[2],f=i[6],m=i[10],g=i[14],_=i[3],y=i[7],v=i[11],x=i[15],b=n[0],w=n[4],A=n[8],T=n[12],M=n[1],S=n[5],E=n[9],C=n[13],I=n[2],P=n[6],L=n[10],R=n[14],B=n[3],D=n[7],O=n[11],k=n[15];return r[0]=s*b+o*M+a*I+l*B,r[4]=s*w+o*S+a*P+l*D,r[8]=s*A+o*E+a*L+l*O,r[12]=s*T+o*C+a*R+l*k,r[1]=c*b+h*M+u*I+d*B,r[5]=c*w+h*S+u*P+d*D,r[9]=c*A+h*E+u*L+d*O,r[13]=c*T+h*C+u*R+d*k,r[2]=p*b+f*M+m*I+g*B,r[6]=p*w+f*S+m*P+g*D,r[10]=p*A+f*E+m*L+g*O,r[14]=p*T+f*C+m*R+g*k,r[3]=_*b+y*M+v*I+x*B,r[7]=_*w+y*S+v*P+x*D,r[11]=_*A+y*E+v*L+x*O,r[15]=_*T+y*C+v*R+x*k,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],r=t[12],s=t[1],o=t[5],a=t[9],l=t[13],c=t[2],h=t[6],u=t[10],d=t[14];return t[3]*(+r*a*h-n*l*h-r*o*u+i*l*u+n*o*d-i*a*d)+t[7]*(+e*a*d-e*l*u+r*s*u-n*s*d+n*l*c-r*a*c)+t[11]*(+e*l*h-e*o*d-r*s*h+i*s*d+r*o*c-i*l*c)+t[15]*(-n*o*c-e*a*h+e*o*u+n*s*h-i*s*u+i*a*c)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],u=t[10],d=t[11],p=t[12],f=t[13],m=t[14],g=t[15],_=h*m*l-f*u*l+f*a*d-o*m*d-h*a*g+o*u*g,y=p*u*l-c*m*l-p*a*d+s*m*d+c*a*g-s*u*g,v=c*f*l-p*h*l+p*o*d-s*f*d-c*o*g+s*h*g,x=p*h*a-c*f*a-p*o*u+s*f*u+c*o*m-s*h*m,b=e*_+i*y+n*v+r*x;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return t[0]=_*w,t[1]=(f*u*r-h*m*r-f*n*d+i*m*d+h*n*g-i*u*g)*w,t[2]=(o*m*r-f*a*r+f*n*l-i*m*l-o*n*g+i*a*g)*w,t[3]=(h*a*r-o*u*r-h*n*l+i*u*l+o*n*d-i*a*d)*w,t[4]=y*w,t[5]=(c*m*r-p*u*r+p*n*d-e*m*d-c*n*g+e*u*g)*w,t[6]=(p*a*r-s*m*r-p*n*l+e*m*l+s*n*g-e*a*g)*w,t[7]=(s*u*r-c*a*r+c*n*l-e*u*l-s*n*d+e*a*d)*w,t[8]=v*w,t[9]=(p*h*r-c*f*r-p*i*d+e*f*d+c*i*g-e*h*g)*w,t[10]=(s*f*r-p*o*r+p*i*l-e*f*l-s*i*g+e*o*g)*w,t[11]=(c*o*r-s*h*r-c*i*l+e*h*l+s*i*d-e*o*d)*w,t[12]=x*w,t[13]=(c*f*n-p*h*n+p*i*u-e*f*u-c*i*m+e*h*m)*w,t[14]=(p*o*n-s*f*n-p*i*a+e*f*a+s*i*m-e*o*m)*w,t[15]=(s*h*n-c*o*n+c*i*a-e*h*a-s*i*u+e*o*u)*w,this}scale(t){const e=this.elements,i=t.x,n=t.y,r=t.z;return e[0]*=i,e[4]*=n,e[8]*=r,e[1]*=i,e[5]*=n,e[9]*=r,e[2]*=i,e[6]*=n,e[10]*=r,e[3]*=i,e[7]*=n,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements;return Math.sqrt(Math.max(t[0]*t[0]+t[1]*t[1]+t[2]*t[2],t[4]*t[4]+t[5]*t[5]+t[6]*t[6],t[8]*t[8]+t[9]*t[9]+t[10]*t[10]))}makeTranslation(t,e,i){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),r=1-i,s=t.x,o=t.y,a=t.z,l=r*s,c=r*o;return this.set(l*s+i,l*o-n*a,l*a+n*o,0,l*o+n*a,c*o+i,c*a-n*s,0,l*a-n*o,c*a+n*s,r*a*a+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,n,r,s){return this.set(1,i,r,0,t,1,s,0,e,n,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,r=e._x,s=e._y,o=e._z,a=e._w,l=r+r,c=s+s,h=o+o,u=r*l,d=r*c,p=r*h,f=s*c,m=s*h,g=o*h,_=a*l,y=a*c,v=a*h,x=i.x,b=i.y,w=i.z;return n[0]=(1-(f+g))*x,n[1]=(d+v)*x,n[2]=(p-y)*x,n[3]=0,n[4]=(d-v)*b,n[5]=(1-(u+g))*b,n[6]=(m+_)*b,n[7]=0,n[8]=(p+y)*w,n[9]=(m-_)*w,n[10]=(1-(u+f))*w,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let r=tw.set(n[0],n[1],n[2]).length();const s=tw.set(n[4],n[5],n[6]).length(),o=tw.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),t.x=n[12],t.y=n[13],t.z=n[14],ew.copy(this);const a=1/r,l=1/s,c=1/o;return ew.elements[0]*=a,ew.elements[1]*=a,ew.elements[2]*=a,ew.elements[4]*=l,ew.elements[5]*=l,ew.elements[6]*=l,ew.elements[8]*=c,ew.elements[9]*=c,ew.elements[10]*=c,e.setFromRotationMatrix(ew),i.x=r,i.y=s,i.z=o,this}makePerspective(t,e,i,n,r,s,o=2e3){const a=this.elements,l=2*r/(e-t),c=2*r/(i-n),h=(e+t)/(e-t),u=(i+n)/(i-n);let d,p;if(o===Lx)d=-(s+r)/(s-r),p=-2*s*r/(s-r);else{if(o!==Rx)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);d=-s/(s-r),p=-s*r/(s-r)}return a[0]=l,a[4]=0,a[8]=h,a[12]=0,a[1]=0,a[5]=c,a[9]=u,a[13]=0,a[2]=0,a[6]=0,a[10]=d,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,i,n,r,s,o=2e3){const a=this.elements,l=1/(e-t),c=1/(i-n),h=1/(s-r),u=(e+t)*l,d=(i+n)*c;let p,f;if(o===Lx)p=(s+r)*h,f=-2*h;else{if(o!==Rx)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);p=r*h,f=-1*h}return a[0]=2*l,a[4]=0,a[8]=0,a[12]=-u,a[1]=0,a[5]=2*c,a[9]=0,a[13]=-d,a[2]=0,a[6]=0,a[10]=f,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const tw=new Ab,ew=new Qb,iw=new Ab(0,0,0),nw=new Ab(1,1,1),rw=new Ab,sw=new Ab,ow=new Ab,aw=new Qb,lw=new wb;class cw{constructor(t=0,e=0,i=0,n=cw.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n=this._order){return this._x=t,this._y=e,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){const n=t.elements,r=n[0],s=n[4],o=n[8],a=n[1],l=n[5],c=n[9],h=n[2],u=n[6],d=n[10];switch(e){case"XYZ":this._y=Math.asin(Nx(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Nx(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(o,d),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-h,r),this._z=0);break;case"ZXY":this._x=Math.asin(Nx(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-h,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(a,r));break;case"ZYX":this._y=Math.asin(-Nx(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(a,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(Nx(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-h,r)):(this._x=0,this._y=Math.atan2(o,d));break;case"XZY":this._z=Math.asin(-Nx(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(o,r)):(this._x=Math.atan2(-c,d),this._y=0)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return aw.makeRotationFromQuaternion(t),this.setFromRotationMatrix(aw,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return lw.setFromEuler(this),this.setFromQuaternion(lw,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}cw.DEFAULT_ORDER="XYZ";class hw{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}let uw=0;const dw=new Ab,pw=new wb,fw=new Qb,mw=new Ab,gw=new Ab,_w=new Ab,yw=new wb,vw=new Ab(1,0,0),xw=new Ab(0,1,0),bw=new Ab(0,0,1),ww={type:"added"},Aw={type:"removed"};class Tw extends Bx{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:uw++}),this.uuid=zx(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Tw.DEFAULT_UP.clone();const t=new Ab,e=new cw,i=new wb,n=new Ab(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new Qb},normalMatrix:{value:new Zx}}),this.matrix=new Qb,this.matrixWorld=new Qb,this.matrixAutoUpdate=Tw.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Tw.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new hw,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return pw.setFromAxisAngle(t,e),this.quaternion.multiply(pw),this}rotateOnWorldAxis(t,e){return pw.setFromAxisAngle(t,e),this.quaternion.premultiply(pw),this}rotateX(t){return this.rotateOnAxis(vw,t)}rotateY(t){return this.rotateOnAxis(xw,t)}rotateZ(t){return this.rotateOnAxis(bw,t)}translateOnAxis(t,e){return dw.copy(t).applyQuaternion(this.quaternion),this.position.add(dw.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(vw,t)}translateY(t){return this.translateOnAxis(xw,t)}translateZ(t){return this.translateOnAxis(bw,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(fw.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?mw.copy(t):mw.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),gw.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?fw.lookAt(gw,mw,this.up):fw.lookAt(mw,gw,this.up),this.quaternion.setFromRotationMatrix(fw),n&&(fw.extractRotation(n.matrixWorld),pw.setFromRotationMatrix(fw),this.quaternion.premultiply(pw.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this||t&&t.isObject3D&&(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(ww)),this}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Aw)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),fw.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),fw.multiply(t.parent.matrixWorld)),t.applyMatrix4(fw),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}}getObjectsByProperty(t,e,i=[]){this[t]===e&&i.push(this);const n=this.children;for(let r=0,s=n.length;r<s;r++)n[r].getObjectsByProperty(t,e,i);return i}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(gw,t,_w),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(gw,yw,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++){const n=e[i];!0!==n.matrixWorldAutoUpdate&&!0!==t||n.updateMatrixWorld(t)}}updateWorldMatrix(t,e){const i=this.parent;if(!0===t&&null!==i&&!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];!0===i.matrixWorldAutoUpdate&&i.updateWorldMatrix(!1,!0)}}}toJSON(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const n={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.visibility=this._visibility,n.active=this._active,n.bounds=this._bounds.map((t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()}))),n.maxGeometryCount=this._maxGeometryCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.geometryCount=this._geometryCount,n.matricesTexture=this._matricesTexture.toJSON(t),null!==this.boundingSphere&&(n.boundingSphere={center:n.boundingSphere.center.toArray(),radius:n.boundingSphere.radius}),null!==this.boundingBox&&(n.boundingBox={min:n.boundingBox.min.toArray(),max:n.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){r(t.shapes,i[e])}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(r(t.materials,this.material[i]));n.material=e}else n.material=r(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){n.animations.push(r(t.animations,this.animations[e]))}}if(e){const e=s(t.geometries),n=s(t.materials),r=s(t.textures),o=s(t.images),a=s(t.shapes),l=s(t.skeletons),c=s(t.animations),h=s(t.nodes);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),o.length>0&&(i.images=o),a.length>0&&(i.shapes=a),l.length>0&&(i.skeletons=l),c.length>0&&(i.animations=c),h.length>0&&(i.nodes=h)}return i.object=n,i;function s(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){this.add(t.children[e].clone())}return this}}Tw.DEFAULT_UP=new Ab(0,1,0),Tw.DEFAULT_MATRIX_AUTO_UPDATE=!0,Tw.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Mw=new Ab,Sw=new Ab,Ew=new Ab,Cw=new Ab,Iw=new Ab,Pw=new Ab,Lw=new Ab,Rw=new Ab,Bw=new Ab,Dw=new Ab;class Ow{constructor(t=new Ab,e=new Ab,i=new Ab){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,n){n.subVectors(i,e),Mw.subVectors(t,e),n.cross(Mw);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(t,e,i,n,r){Mw.subVectors(n,e),Sw.subVectors(i,e),Ew.subVectors(t,e);const s=Mw.dot(Mw),o=Mw.dot(Sw),a=Mw.dot(Ew),l=Sw.dot(Sw),c=Sw.dot(Ew),h=s*l-o*o;if(0===h)return r.set(0,0,0),null;const u=1/h,d=(l*a-o*c)*u,p=(s*c-o*a)*u;return r.set(1-d-p,p,d)}static containsPoint(t,e,i,n){return null!==this.getBarycoord(t,e,i,n,Cw)&&(Cw.x>=0&&Cw.y>=0&&Cw.x+Cw.y<=1)}static getInterpolation(t,e,i,n,r,s,o,a){return null===this.getBarycoord(t,e,i,n,Cw)?(a.x=0,a.y=0,"z"in a&&(a.z=0),"w"in a&&(a.w=0),null):(a.setScalar(0),a.addScaledVector(r,Cw.x),a.addScaledVector(s,Cw.y),a.addScaledVector(o,Cw.z),a)}static isFrontFacing(t,e,i,n){return Mw.subVectors(i,e),Sw.subVectors(t,e),Mw.cross(Sw).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}setFromAttributeAndIndices(t,e,i,n){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,i),this.c.fromBufferAttribute(t,n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Mw.subVectors(this.c,this.b),Sw.subVectors(this.a,this.b),.5*Mw.cross(Sw).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return Ow.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return Ow.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,i,n,r){return Ow.getInterpolation(t,this.a,this.b,this.c,e,i,n,r)}containsPoint(t){return Ow.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return Ow.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const i=this.a,n=this.b,r=this.c;let s,o;Iw.subVectors(n,i),Pw.subVectors(r,i),Rw.subVectors(t,i);const a=Iw.dot(Rw),l=Pw.dot(Rw);if(a<=0&&l<=0)return e.copy(i);Bw.subVectors(t,n);const c=Iw.dot(Bw),h=Pw.dot(Bw);if(c>=0&&h<=c)return e.copy(n);const u=a*h-c*l;if(u<=0&&a>=0&&c<=0)return s=a/(a-c),e.copy(i).addScaledVector(Iw,s);Dw.subVectors(t,r);const d=Iw.dot(Dw),p=Pw.dot(Dw);if(p>=0&&d<=p)return e.copy(r);const f=d*l-a*p;if(f<=0&&l>=0&&p<=0)return o=l/(l-p),e.copy(i).addScaledVector(Pw,o);const m=c*p-d*h;if(m<=0&&h-c>=0&&d-p>=0)return Lw.subVectors(r,n),o=(h-c)/(h-c+(d-p)),e.copy(n).addScaledVector(Lw,o);const g=1/(m+f+u);return s=f*g,o=u*g,e.copy(i).addScaledVector(Iw,s).addScaledVector(Pw,o)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const kw={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Fw={h:0,s:0,l:0},zw={h:0,s:0,l:0};function Nw(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}class Uw{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,i)}set(t,e,i){if(void 0===e&&void 0===i){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,i);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=vx){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,ab.toWorkingColorSpace(this,e),this}setRGB(t,e,i,n=ab.workingColorSpace){return this.r=t,this.g=e,this.b=i,ab.toWorkingColorSpace(this,n),this}setHSL(t,e,i,n=ab.workingColorSpace){if(t=Ux(t,1),e=Nx(e,0,1),i=Nx(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,r=2*i-n;this.r=Nw(r,n,t+1/3),this.g=Nw(r,n,t),this.b=Nw(r,n,t-1/3)}return ab.toWorkingColorSpace(this,n),this}setStyle(t,e=vx){let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(t)){let t;const n=i[2];switch(i[1]){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255,e);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100,e);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100,e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],n=t.length;if(3===n)return this.setRGB(parseInt(t.charAt(0),16)/15,parseInt(t.charAt(1),16)/15,parseInt(t.charAt(2),16)/15,e);if(6===n)return this.setHex(parseInt(t,16),e)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=vx){const i=kw[t.toLowerCase()];return void 0!==i&&this.setHex(i,e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=lb(t.r),this.g=lb(t.g),this.b=lb(t.b),this}copyLinearToSRGB(t){return this.r=cb(t.r),this.g=cb(t.g),this.b=cb(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=vx){return ab.fromWorkingColorSpace(Gw.copy(this),t),65536*Math.round(Nx(255*Gw.r,0,255))+256*Math.round(Nx(255*Gw.g,0,255))+Math.round(Nx(255*Gw.b,0,255))}getHexString(t=vx){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=ab.workingColorSpace){ab.fromWorkingColorSpace(Gw.copy(this),e);const i=Gw.r,n=Gw.g,r=Gw.b,s=Math.max(i,n,r),o=Math.min(i,n,r);let a,l;const c=(o+s)/2;if(o===s)a=0,l=0;else{const t=s-o;switch(l=c<=.5?t/(s+o):t/(2-s-o),s){case i:a=(n-r)/t+(n<r?6:0);break;case n:a=(r-i)/t+2;break;case r:a=(i-n)/t+4}a/=6}return t.h=a,t.s=l,t.l=c,t}getRGB(t,e=ab.workingColorSpace){return ab.fromWorkingColorSpace(Gw.copy(this),e),t.r=Gw.r,t.g=Gw.g,t.b=Gw.b,t}getStyle(t=vx){ab.fromWorkingColorSpace(Gw.copy(this),t);const e=Gw.r,i=Gw.g,n=Gw.b;return t!==vx?`color(${t} ${e.toFixed(3)} ${i.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*n)})`}offsetHSL(t,e,i){return this.getHSL(Fw),this.setHSL(Fw.h+t,Fw.s+e,Fw.l+i)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(Fw),t.getHSL(zw);const i=Gx(Fw.h,zw.h,e),n=Gx(Fw.s,zw.s,e),r=Gx(Fw.l,zw.l,e);return this.setHSL(i,n,r),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,i=this.g,n=this.b,r=t.elements;return this.r=r[0]*e+r[3]*i+r[6]*n,this.g=r[1]*e+r[4]*i+r[7]*n,this.b=r[2]*e+r[5]*i+r[8]*n,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Gw=new Uw;Uw.NAMES=kw;let Vw=0;class jw extends Bx{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Vw++}),this.uuid=zx(),this.name="",this.type="Material",this.blending=1,this.side=zy,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=Gy,this.blendDst=Vy,this.blendEquation=Uy,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Uw(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Ex,this.stencilZFail=Ex,this.stencilZPass=Ex,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i)continue;const n=this[e];void 0!==n&&(n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i)}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),this.side!==zy&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),this.blendSrc!==Gy&&(i.blendSrc=this.blendSrc),this.blendDst!==Vy&&(i.blendDst=this.blendDst),this.blendEquation!==Uy&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Ex&&(i.stencilFail=this.stencilFail),this.stencilZFail!==Ex&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==Ex&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),e){const e=n(t.textures),r=n(t.images);e.length>0&&(i.textures=e),r.length>0&&(i.images=r)}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}class Hw extends jw{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Uw(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=jy,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const Ww=qw();function qw(){const t=new ArrayBuffer(4),e=new Float32Array(t),i=new Uint32Array(t),n=new Uint32Array(512),r=new Uint32Array(512);for(let t=0;t<256;++t){const e=t-127;e<-27?(n[t]=0,n[256|t]=32768,r[t]=24,r[256|t]=24):e<-14?(n[t]=1024>>-e-14,n[256|t]=1024>>-e-14|32768,r[t]=-e-1,r[256|t]=-e-1):e<=15?(n[t]=e+15<<10,n[256|t]=e+15<<10|32768,r[t]=13,r[256|t]=13):e<128?(n[t]=31744,n[256|t]=64512,r[t]=24,r[256|t]=24):(n[t]=31744,n[256|t]=64512,r[t]=13,r[256|t]=13)}const s=new Uint32Array(2048),o=new Uint32Array(64),a=new Uint32Array(64);for(let t=1;t<1024;++t){let e=t<<13,i=0;for(;0==(8388608&e);)e<<=1,i-=8388608;e&=-8388609,i+=947912704,s[t]=e|i}for(let t=1024;t<2048;++t)s[t]=939524096+(t-1024<<13);for(let t=1;t<31;++t)o[t]=t<<23;o[31]=1199570944,o[32]=2147483648;for(let t=33;t<63;++t)o[t]=2147483648+(t-32<<23);o[63]=3347054592;for(let t=1;t<64;++t)32!==t&&(a[t]=1024);return{floatView:e,uint32View:i,baseTable:n,shiftTable:r,mantissaTable:s,exponentTable:o,offsetTable:a}}function Xw(t){t=Nx(t,-65504,65504),Ww.floatView[0]=t;const e=Ww.uint32View[0],i=e>>23&511;return Ww.baseTable[i]+((8388607&e)>>Ww.shiftTable[i])}function Zw(t){const e=t>>10;return Ww.uint32View[0]=Ww.mantissaTable[Ww.offsetTable[e]+(1023&t)]+Ww.exponentTable[e],Ww.floatView[0]}const Jw={toHalfFloat:Xw,fromHalfFloat:Zw},Yw=new Ab,$w=new Xx;class Kw{constructor(t,e,i=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=i,this.usage=Cx,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=xv,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return ib("THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[t+n]=e.array[i+n];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)$w.fromBufferAttribute(this,e),$w.applyMatrix3(t),this.setXY(e,$w.x,$w.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)Yw.fromBufferAttribute(this,e),Yw.applyMatrix3(t),this.setXYZ(e,Yw.x,Yw.y,Yw.z);return this}applyMatrix4(t){for(let e=0,i=this.count;e<i;e++)Yw.fromBufferAttribute(this,e),Yw.applyMatrix4(t),this.setXYZ(e,Yw.x,Yw.y,Yw.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)Yw.fromBufferAttribute(this,e),Yw.applyNormalMatrix(t),this.setXYZ(e,Yw.x,Yw.y,Yw.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)Yw.fromBufferAttribute(this,e),Yw.transformDirection(t),this.setXYZ(e,Yw.x,Yw.y,Yw.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let i=this.array[t*this.itemSize+e];return this.normalized&&(i=Hx(i,this.array)),i}setComponent(t,e,i){return this.normalized&&(i=Wx(i,this.array)),this.array[t*this.itemSize+e]=i,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=Hx(e,this.array)),e}setX(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=Hx(e,this.array)),e}setY(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=Hx(e,this.array)),e}setZ(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=Hx(e,this.array)),e}setW(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array)),this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,n){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array),r=Wx(r,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==Cx&&(t.usage=this.usage),t}}class Qw extends Kw{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class tA extends Kw{constructor(t,e,i){super(new Uint32Array(t),e,i)}}class eA extends Kw{constructor(t,e,i){super(new Float32Array(t),e,i)}}let iA=0;const nA=new Qb,rA=new Tw,sA=new Ab,oA=new Sb,aA=new Sb,lA=new Ab;class cA extends Bx{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:iA++}),this.uuid=zx(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return this.index=Array.isArray(t)?new(Yx(t)?tA:Qw)(t,1):t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new Zx).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return nA.makeRotationFromQuaternion(t),this.applyMatrix4(nA),this}rotateX(t){return nA.makeRotationX(t),this.applyMatrix4(nA),this}rotateY(t){return nA.makeRotationY(t),this.applyMatrix4(nA),this}rotateZ(t){return nA.makeRotationZ(t),this.applyMatrix4(nA),this}translate(t,e,i){return nA.makeTranslation(t,e,i),this.applyMatrix4(nA),this}scale(t,e,i){return nA.makeScale(t,e,i),this.applyMatrix4(nA),this}lookAt(t){return rA.lookAt(t),rA.updateMatrix(),this.applyMatrix4(rA.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(sA).negate(),this.translate(sA.x,sA.y,sA.z),this}setFromPoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new eA(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Sb);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingBox.set(new Ab(-1/0,-1/0,-1/0),new Ab(1/0,1/0,1/0));else{if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){oA.setFromBufferAttribute(e[t]),this.morphTargetsRelative?(lA.addVectors(this.boundingBox.min,oA.min),this.boundingBox.expandByPoint(lA),lA.addVectors(this.boundingBox.max,oA.max),this.boundingBox.expandByPoint(lA)):(this.boundingBox.expandByPoint(oA.min),this.boundingBox.expandByPoint(oA.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Hb);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)this.boundingSphere.set(new Ab,1/0);else if(t){const i=this.boundingSphere.center;if(oA.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){aA.setFromBufferAttribute(e[t]),this.morphTargetsRelative?(lA.addVectors(oA.min,aA.min),oA.expandByPoint(lA),lA.addVectors(oA.max,aA.max),oA.expandByPoint(lA)):(oA.expandByPoint(aA.min),oA.expandByPoint(aA.max))}oA.getCenter(i);let n=0;for(let e=0,r=t.count;e<r;e++)lA.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(lA));if(e)for(let r=0,s=e.length;r<s;r++){const s=e[r],o=this.morphTargetsRelative;for(let e=0,r=s.count;e<r;e++)lA.fromBufferAttribute(s,e),o&&(sA.fromBufferAttribute(t,e),lA.add(sA)),n=Math.max(n,i.distanceToSquared(lA))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return;const i=t.array,n=e.position.array,r=e.normal.array,s=e.uv.array,o=n.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Kw(new Float32Array(4*o),4));const a=this.getAttribute("tangent").array,l=[],c=[];for(let t=0;t<o;t++)l[t]=new Ab,c[t]=new Ab;const h=new Ab,u=new Ab,d=new Ab,p=new Xx,f=new Xx,m=new Xx,g=new Ab,_=new Ab;function y(t,e,i){h.fromArray(n,3*t),u.fromArray(n,3*e),d.fromArray(n,3*i),p.fromArray(s,2*t),f.fromArray(s,2*e),m.fromArray(s,2*i),u.sub(h),d.sub(h),f.sub(p),m.sub(p);const r=1/(f.x*m.y-m.x*f.y);isFinite(r)&&(g.copy(u).multiplyScalar(m.y).addScaledVector(d,-f.y).multiplyScalar(r),_.copy(d).multiplyScalar(f.x).addScaledVector(u,-m.x).multiplyScalar(r),l[t].add(g),l[e].add(g),l[i].add(g),c[t].add(_),c[e].add(_),c[i].add(_))}let v=this.groups;0===v.length&&(v=[{start:0,count:i.length}]);for(let t=0,e=v.length;t<e;++t){const e=v[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)y(i[t+0],i[t+1],i[t+2])}const x=new Ab,b=new Ab,w=new Ab,A=new Ab;function T(t){w.fromArray(r,3*t),A.copy(w);const e=l[t];x.copy(e),x.sub(w.multiplyScalar(w.dot(e))).normalize(),b.crossVectors(A,e);const i=b.dot(c[t])<0?-1:1;a[4*t]=x.x,a[4*t+1]=x.y,a[4*t+2]=x.z,a[4*t+3]=i}for(let t=0,e=v.length;t<e;++t){const e=v[t],n=e.start;for(let t=n,r=n+e.count;t<r;t+=3)T(i[t+0]),T(i[t+1]),T(i[t+2])}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new Kw(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new Ab,r=new Ab,s=new Ab,o=new Ab,a=new Ab,l=new Ab,c=new Ab,h=new Ab;if(t)for(let u=0,d=t.count;u<d;u+=3){const d=t.getX(u+0),p=t.getX(u+1),f=t.getX(u+2);n.fromBufferAttribute(e,d),r.fromBufferAttribute(e,p),s.fromBufferAttribute(e,f),c.subVectors(s,r),h.subVectors(n,r),c.cross(h),o.fromBufferAttribute(i,d),a.fromBufferAttribute(i,p),l.fromBufferAttribute(i,f),o.add(c),a.add(c),l.add(c),i.setXYZ(d,o.x,o.y,o.z),i.setXYZ(p,a.x,a.y,a.z),i.setXYZ(f,l.x,l.y,l.z)}else for(let t=0,o=e.count;t<o;t+=3)n.fromBufferAttribute(e,t+0),r.fromBufferAttribute(e,t+1),s.fromBufferAttribute(e,t+2),c.subVectors(s,r),h.subVectors(n,r),c.cross(h),i.setXYZ(t+0,c.x,c.y,c.z),i.setXYZ(t+1,c.x,c.y,c.z),i.setXYZ(t+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)lA.fromBufferAttribute(t,e),lA.normalize(),t.setXYZ(e,lA.x,lA.y,lA.z)}toNonIndexed(){function t(t,e){const i=t.array,n=t.itemSize,r=t.normalized,s=new i.constructor(e.length*n);let o=0,a=0;for(let r=0,l=e.length;r<l;r++){o=t.isInterleavedBufferAttribute?e[r]*t.data.stride+t.offset:e[r]*n;for(let t=0;t<n;t++)s[a++]=i[o++]}return new Kw(s,n,r)}if(null===this.index)return this;const e=new cA,i=this.index.array,n=this.attributes;for(const r in n){const s=t(n[r],i);e.setAttribute(r,s)}const r=this.morphAttributes;for(const n in r){const s=[],o=r[n];for(let e=0,n=o.length;e<n;e++){const n=t(o[e],i);s.push(n)}e.morphAttributes[n]=s}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let t=0,i=s.length;t<i;t++){const i=s[t];e.addGroup(i.start,i.count,i.materialIndex)}return e}toJSON(){const t={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){t.data.attributes[e]=i[e].toJSON(t.data)}const n={};let r=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],s=[];for(let e=0,n=i.length;e<n;e++){s.push(i[e].toJSON(t.data))}s.length>0&&(n[e]=s,r=!0)}r&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const o=this.boundingSphere;return null!==o&&(t.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){this.setAttribute(t,n[t].clone(e))}const r=t.morphAttributes;for(const t in r){const i=[],n=r[t];for(let t=0,r=n.length;t<r;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let t=0,e=s.length;t<e;t++){const e=s[t];this.addGroup(e.start,e.count,e.materialIndex)}const o=t.boundingBox;null!==o&&(this.boundingBox=o.clone());const a=t.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const hA=new Qb,uA=new Kb,dA=new Hb,pA=new Ab,fA=new Ab,mA=new Ab,gA=new Ab,_A=new Ab,yA=new Ab,vA=new Xx,xA=new Xx,bA=new Xx,wA=new Ab,AA=new Ab,TA=new Ab,MA=new Ab,SA=new Ab;class EA extends Tw{constructor(t=new cA,e=new Hw){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const i=this.geometry,n=i.morphAttributes.position,r=i.morphTargetsRelative;e.fromBufferAttribute(i.attributes.position,t);const s=this.morphTargetInfluences;if(n&&s){yA.set(0,0,0);for(let i=0,o=n.length;i<o;i++){const o=s[i];0!==o&&(_A.fromBufferAttribute(n[i],t),yA.addScaledVector(r?_A:_A.sub(e),o))}e.add(yA)}return e}raycast(t,e){const i=this.geometry,n=this.matrixWorld;if(void 0!==this.material){if(null===i.boundingSphere&&i.computeBoundingSphere(),dA.copy(i.boundingSphere),dA.applyMatrix4(n),uA.copy(t.ray).recast(t.near),!1===dA.containsPoint(uA.origin)){if(null===uA.intersectSphere(dA,pA))return;if(uA.origin.distanceToSquared(pA)>(t.far-t.near)**2)return}hA.copy(n).invert(),uA.copy(t.ray).applyMatrix4(hA),null!==i.boundingBox&&!1===uA.intersectsBox(i.boundingBox)||this._computeIntersections(t,e,uA)}}_computeIntersections(t,e,i){let n;const r=this.geometry,s=this.material,o=r.index,a=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,h=r.attributes.normal,u=r.groups,d=r.drawRange;if(null!==o)if(Array.isArray(s))for(let r=0,a=u.length;r<a;r++){const a=u[r],p=s[a.materialIndex];for(let r=Math.max(a.start,d.start),s=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<s;r+=3){n=CA(this,p,t,i,l,c,h,o.getX(r),o.getX(r+1),o.getX(r+2)),n&&(n.faceIndex=Math.floor(r/3),n.face.materialIndex=a.materialIndex,e.push(n))}}else{for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3){n=CA(this,s,t,i,l,c,h,o.getX(r),o.getX(r+1),o.getX(r+2)),n&&(n.faceIndex=Math.floor(r/3),e.push(n))}}else if(void 0!==a)if(Array.isArray(s))for(let r=0,o=u.length;r<o;r++){const o=u[r],p=s[o.materialIndex];for(let r=Math.max(o.start,d.start),s=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<s;r+=3){n=CA(this,p,t,i,l,c,h,r,r+1,r+2),n&&(n.faceIndex=Math.floor(r/3),n.face.materialIndex=o.materialIndex,e.push(n))}}else{for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3){n=CA(this,s,t,i,l,c,h,r,r+1,r+2),n&&(n.faceIndex=Math.floor(r/3),e.push(n))}}}}function CA(t,e,i,n,r,s,o,a,l,c){t.getVertexPosition(a,fA),t.getVertexPosition(l,mA),t.getVertexPosition(c,gA);const h=function(t,e,i,n,r,s,o,a){let l;if(l=e.side===Ny?n.intersectTriangle(o,s,r,!0,a):n.intersectTriangle(r,s,o,e.side===zy,a),null===l)return null;SA.copy(a),SA.applyMatrix4(t.matrixWorld);const c=i.ray.origin.distanceTo(SA);return c<i.near||c>i.far?null:{distance:c,point:SA.clone(),object:t}}(t,e,i,n,fA,mA,gA,MA);if(h){r&&(vA.fromBufferAttribute(r,a),xA.fromBufferAttribute(r,l),bA.fromBufferAttribute(r,c),h.uv=Ow.getInterpolation(MA,fA,mA,gA,vA,xA,bA,new Xx)),s&&(vA.fromBufferAttribute(s,a),xA.fromBufferAttribute(s,l),bA.fromBufferAttribute(s,c),h.uv1=Ow.getInterpolation(MA,fA,mA,gA,vA,xA,bA,new Xx),h.uv2=h.uv1),o&&(wA.fromBufferAttribute(o,a),AA.fromBufferAttribute(o,l),TA.fromBufferAttribute(o,c),h.normal=Ow.getInterpolation(MA,fA,mA,gA,wA,AA,TA,new Ab),h.normal.dot(n.direction)>0&&h.normal.multiplyScalar(-1));const t={a:a,b:l,c:c,normal:new Ab,materialIndex:0};Ow.getNormal(fA,mA,gA,t.normal),h.face=t}return h}class IA extends cA{constructor(t=1,e=1,i=1,n=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const o=this;n=Math.floor(n),r=Math.floor(r),s=Math.floor(s);const a=[],l=[],c=[],h=[];let u=0,d=0;function p(t,e,i,n,r,s,p,f,m,g,_){const y=s/m,v=p/g,x=s/2,b=p/2,w=f/2,A=m+1,T=g+1;let M=0,S=0;const E=new Ab;for(let s=0;s<T;s++){const o=s*v-b;for(let a=0;a<A;a++){E[t]=(a*y-x)*n,E[e]=o*r,E[i]=w,l.push(E.x,E.y,E.z),E[t]=0,E[e]=0,E[i]=f>0?1:-1,c.push(E.x,E.y,E.z),h.push(a/m),h.push(1-s/g),M+=1}}for(let t=0;t<g;t++)for(let e=0;e<m;e++){const i=u+e+A*(t+1),n=u+(e+1)+A*(t+1),r=u+(e+1)+A*t;a.push(u+e+A*t,i,r),a.push(i,n,r),S+=6}o.addGroup(d,S,_),d+=S,u+=M}p("z","y","x",-1,-1,i,e,t,s,r,0),p("z","y","x",1,-1,i,e,-t,s,r,1),p("x","z","y",1,1,t,i,e,n,s,2),p("x","z","y",1,-1,t,i,-e,n,s,3),p("x","y","z",1,-1,t,e,i,n,r,4),p("x","y","z",-1,-1,t,e,-i,n,r,5),this.setIndex(a),this.setAttribute("position",new eA(l,3)),this.setAttribute("normal",new eA(c,3)),this.setAttribute("uv",new eA(h,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new IA(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}function PA(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];e[i][n]=r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?null:r.clone():Array.isArray(r)?r.slice():r}}return e}function LA(t){const e={};for(let i=0;i<t.length;i++){const n=PA(t[i]);for(const t in n)e[t]=n[t]}return e}function RA(t){return null===t.getRenderTarget()?t.outputColorSpace:ab.workingColorSpace}const BA={clone:PA,merge:LA};class DA extends jw{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1,clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=PA(t.uniforms),this.uniformsGroups=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].clone());return e}(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;e.uniforms[i]=n&&n.isTexture?{type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?{type:"c",value:n.getHex()}:n&&n.isVector2?{type:"v2",value:n.toArray()}:n&&n.isVector3?{type:"v3",value:n.toArray()}:n&&n.isVector4?{type:"v4",value:n.toArray()}:n&&n.isMatrix3?{type:"m3",value:n.toArray()}:n&&n.isMatrix4?{type:"m4",value:n.toArray()}:{value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.lights=this.lights,e.clipping=this.clipping;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e}}class OA extends Tw{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Qb,this.projectionMatrix=new Qb,this.projectionMatrixInverse=new Qb,this.coordinateSystem=Lx}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const kA=new Ab,FA=new Xx,zA=new Xx;class NA extends OA{constructor(t=50,e=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*Fx*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*kx*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*Fx*Math.atan(Math.tan(.5*kx*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,i){kA.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(kA.x,kA.y).multiplyScalar(-t/kA.z),kA.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(kA.x,kA.y).multiplyScalar(-t/kA.z)}getViewSize(t,e){return this.getViewBounds(t,FA,zA),e.subVectors(zA,FA)}setViewOffset(t,e,i,n,r,s){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*kx*this.fov)/this.zoom,i=2*e,n=this.aspect*i,r=-.5*n;const s=this.view;if(null!==this.view&&this.view.enabled){const t=s.fullWidth,o=s.fullHeight;r+=s.offsetX*n/t,e-=s.offsetY*i/o,n*=s.width/t,i*=s.height/o}const o=this.filmOffset;0!==o&&(r+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,e,e-i,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const UA=-90;class GA extends Tw{constructor(t,e,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const n=new NA(UA,1,t,e);n.layers=this.layers,this.add(n);const r=new NA(UA,1,t,e);r.layers=this.layers,this.add(r);const s=new NA(UA,1,t,e);s.layers=this.layers,this.add(s);const o=new NA(UA,1,t,e);o.layers=this.layers,this.add(o);const a=new NA(UA,1,t,e);a.layers=this.layers,this.add(a);const l=new NA(UA,1,t,e);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const t=this.coordinateSystem,e=this.children.concat(),[i,n,r,s,o,a]=e;for(const t of e)this.remove(t);if(t===Lx)i.up.set(0,1,0),i.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),a.up.set(0,1,0),a.lookAt(0,0,-1);else{if(t!==Rx)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+t);i.up.set(0,-1,0),i.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),a.up.set(0,-1,0),a.lookAt(0,0,-1)}for(const t of e)this.add(t),t.updateMatrixWorld()}update(t,e){null===this.parent&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:n}=this;this.coordinateSystem!==t.coordinateSystem&&(this.coordinateSystem=t.coordinateSystem,this.updateCoordinateSystem());const[r,s,o,a,l,c]=this.children,h=t.getRenderTarget(),u=t.getActiveCubeFace(),d=t.getActiveMipmapLevel(),p=t.xr.enabled;t.xr.enabled=!1;const f=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,t.setRenderTarget(i,0,n),t.render(e,r),t.setRenderTarget(i,1,n),t.render(e,s),t.setRenderTarget(i,2,n),t.render(e,o),t.setRenderTarget(i,3,n),t.render(e,a),t.setRenderTarget(i,4,n),t.render(e,l),i.texture.generateMipmaps=f,t.setRenderTarget(i,5,n),t.render(e,c),t.setRenderTarget(h,u,d),t.xr.enabled=p,i.texture.needsPMREMUpdate=!0}}class VA extends gb{constructor(t,e,i,n,r,s,o,a,l,c){super(t=void 0!==t?t:[],e=void 0!==e?e:iv,i,n,r,s,o,a,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class jA extends vb{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;const i={width:t,height:t,depth:1},n=[i,i,i,i,i,i];void 0!==e.encoding&&(ib("THREE.WebGLCubeRenderTarget: option.encoding has been replaced by option.colorSpace."),e.colorSpace=e.encoding===_x?vx:yx),this.texture=new VA(n,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:pv}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.colorSpace=e.colorSpace,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},n=new IA(5,5,5),r=new DA({name:"CubemapFromEquirect",uniforms:PA(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:Ny,blending:0});r.uniforms.tEquirect.value=e;const s=new EA(n,r),o=e.minFilter;e.minFilter===mv&&(e.minFilter=pv);return new GA(1,10,this).update(t,s),e.minFilter=o,s.geometry.dispose(),s.material.dispose(),this}clear(t,e,i,n){const r=t.getRenderTarget();for(let r=0;r<6;r++)t.setRenderTarget(this,r),t.clear(e,i,n);t.setRenderTarget(r)}}const HA=new Ab,WA=new Ab,qA=new Zx;let XA=class{constructor(t=new Ab(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=HA.subVectors(i,e).cross(WA.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const i=t.delta(HA),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const r=-(t.start.dot(this.normal)+this.constant)/n;return r<0||r>1?null:e.copy(t.start).addScaledVector(i,r)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||qA.getNormalMatrix(t),n=this.coplanarPoint(HA).applyMatrix4(t),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}};const ZA=new Hb,JA=new Ab;class YA{constructor(t=new XA,e=new XA,i=new XA,n=new XA,r=new XA,s=new XA){this.planes=[t,e,i,n,r,s]}set(t,e,i,n,r,s){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(i),o[3].copy(n),o[4].copy(r),o[5].copy(s),this}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t,e=2e3){const i=this.planes,n=t.elements,r=n[0],s=n[1],o=n[2],a=n[3],l=n[4],c=n[5],h=n[6],u=n[7],d=n[8],p=n[9],f=n[10],m=n[11],g=n[12],_=n[13],y=n[14],v=n[15];if(i[0].setComponents(a-r,u-l,m-d,v-g).normalize(),i[1].setComponents(a+r,u+l,m+d,v+g).normalize(),i[2].setComponents(a+s,u+c,m+p,v+_).normalize(),i[3].setComponents(a-s,u-c,m-p,v-_).normalize(),i[4].setComponents(a-o,u-h,m-f,v-y).normalize(),e===Lx)i[5].setComponents(a+o,u+h,m+f,v+y).normalize();else{if(e!==Rx)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);i[5].setComponents(o,h,f,y).normalize()}return this}intersectsObject(t){if(void 0!==t.boundingSphere)null===t.boundingSphere&&t.computeBoundingSphere(),ZA.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;null===e.boundingSphere&&e.computeBoundingSphere(),ZA.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(ZA)}intersectsSprite(t){return ZA.center.set(0,0,0),ZA.radius=.7071067811865476,ZA.applyMatrix4(t.matrixWorld),this.intersectsSphere(ZA)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(i)<n)return!1}return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(JA.x=n.normal.x>0?t.max.x:t.min.x,JA.y=n.normal.y>0?t.max.y:t.min.y,JA.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(JA)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function $A(){let t=null,e=!1,i=null,n=null;function r(e,s){i(e,s),n=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==i&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function KA(t,e){const i=e.isWebGL2,n=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),n.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const i=n.get(e);i&&(t.deleteBuffer(i.buffer),n.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=n.get(e);return void((!t||t.version<e.version)&&n.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const s=n.get(e);if(void 0===s)n.set(e,function(e,n){const r=e.array,s=e.usage,o=r.byteLength,a=t.createBuffer();let l;if(t.bindBuffer(n,a),t.bufferData(n,r,s),e.onUploadCallback(),r instanceof Float32Array)l=t.FLOAT;else if(r instanceof Uint16Array)if(e.isFloat16BufferAttribute){if(!i)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");l=t.HALF_FLOAT}else l=t.UNSIGNED_SHORT;else if(r instanceof Int16Array)l=t.SHORT;else if(r instanceof Uint32Array)l=t.UNSIGNED_INT;else if(r instanceof Int32Array)l=t.INT;else if(r instanceof Int8Array)l=t.BYTE;else if(r instanceof Uint8Array)l=t.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);l=t.UNSIGNED_BYTE}return{buffer:a,type:l,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version,size:o}}(e,r));else if(s.version<e.version){if(s.size!==e.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(e,n,r){const s=n.array,o=n._updateRange,a=n.updateRanges;if(t.bindBuffer(r,e),-1===o.count&&0===a.length&&t.bufferSubData(r,0,s),0!==a.length){for(let e=0,n=a.length;e<n;e++){const n=a[e];i?t.bufferSubData(r,n.start*s.BYTES_PER_ELEMENT,s,n.start,n.count):t.bufferSubData(r,n.start*s.BYTES_PER_ELEMENT,s.subarray(n.start,n.start+n.count))}n.clearUpdateRanges()}-1!==o.count&&(i?t.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s,o.offset,o.count):t.bufferSubData(r,o.offset*s.BYTES_PER_ELEMENT,s.subarray(o.offset,o.offset+o.count)),o.count=-1),n.onUploadCallback()}(s.buffer,e,r),s.version=e.version}}}}class QA extends cA{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const r=t/2,s=e/2,o=Math.floor(i),a=Math.floor(n),l=o+1,c=a+1,h=t/o,u=e/a,d=[],p=[],f=[],m=[];for(let t=0;t<c;t++){const e=t*u-s;for(let i=0;i<l;i++){p.push(i*h-r,-e,0),f.push(0,0,1),m.push(i/o),m.push(1-t/a)}}for(let t=0;t<a;t++)for(let e=0;e<o;e++){const i=e+l*(t+1),n=e+1+l*(t+1),r=e+1+l*t;d.push(e+l*t,i,r),d.push(i,n,r)}this.setIndex(d),this.setAttribute("position",new eA(p,3)),this.setAttribute("normal",new eA(f,3)),this.setAttribute("uv",new eA(m,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new QA(t.width,t.height,t.widthSegments,t.heightSegments)}}const tT={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\tattribute float batchId;\n\tuniform highp sampler2D batchingTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( batchId );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\tuniform float morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},eT={common:{diffuse:{value:new Uw(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Zx},alphaMap:{value:null},alphaMapTransform:{value:new Zx},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Zx}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Zx}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Zx}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Zx},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Zx},normalScale:{value:new Xx(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Zx},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Zx}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Zx}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Zx}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Uw(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Uw(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Zx},alphaTest:{value:0},uvTransform:{value:new Zx}},sprite:{diffuse:{value:new Uw(16777215)},opacity:{value:1},center:{value:new Xx(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Zx},alphaMap:{value:null},alphaMapTransform:{value:new Zx},alphaTest:{value:0}}},iT={basic:{uniforms:LA([eT.common,eT.specularmap,eT.envmap,eT.aomap,eT.lightmap,eT.fog]),vertexShader:tT.meshbasic_vert,fragmentShader:tT.meshbasic_frag},lambert:{uniforms:LA([eT.common,eT.specularmap,eT.envmap,eT.aomap,eT.lightmap,eT.emissivemap,eT.bumpmap,eT.normalmap,eT.displacementmap,eT.fog,eT.lights,{emissive:{value:new Uw(0)}}]),vertexShader:tT.meshlambert_vert,fragmentShader:tT.meshlambert_frag},phong:{uniforms:LA([eT.common,eT.specularmap,eT.envmap,eT.aomap,eT.lightmap,eT.emissivemap,eT.bumpmap,eT.normalmap,eT.displacementmap,eT.fog,eT.lights,{emissive:{value:new Uw(0)},specular:{value:new Uw(1118481)},shininess:{value:30}}]),vertexShader:tT.meshphong_vert,fragmentShader:tT.meshphong_frag},standard:{uniforms:LA([eT.common,eT.envmap,eT.aomap,eT.lightmap,eT.emissivemap,eT.bumpmap,eT.normalmap,eT.displacementmap,eT.roughnessmap,eT.metalnessmap,eT.fog,eT.lights,{emissive:{value:new Uw(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:tT.meshphysical_vert,fragmentShader:tT.meshphysical_frag},toon:{uniforms:LA([eT.common,eT.aomap,eT.lightmap,eT.emissivemap,eT.bumpmap,eT.normalmap,eT.displacementmap,eT.gradientmap,eT.fog,eT.lights,{emissive:{value:new Uw(0)}}]),vertexShader:tT.meshtoon_vert,fragmentShader:tT.meshtoon_frag},matcap:{uniforms:LA([eT.common,eT.bumpmap,eT.normalmap,eT.displacementmap,eT.fog,{matcap:{value:null}}]),vertexShader:tT.meshmatcap_vert,fragmentShader:tT.meshmatcap_frag},points:{uniforms:LA([eT.points,eT.fog]),vertexShader:tT.points_vert,fragmentShader:tT.points_frag},dashed:{uniforms:LA([eT.common,eT.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:tT.linedashed_vert,fragmentShader:tT.linedashed_frag},depth:{uniforms:LA([eT.common,eT.displacementmap]),vertexShader:tT.depth_vert,fragmentShader:tT.depth_frag},normal:{uniforms:LA([eT.common,eT.bumpmap,eT.normalmap,eT.displacementmap,{opacity:{value:1}}]),vertexShader:tT.meshnormal_vert,fragmentShader:tT.meshnormal_frag},sprite:{uniforms:LA([eT.sprite,eT.fog]),vertexShader:tT.sprite_vert,fragmentShader:tT.sprite_frag},background:{uniforms:{uvTransform:{value:new Zx},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:tT.background_vert,fragmentShader:tT.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1}},vertexShader:tT.backgroundCube_vert,fragmentShader:tT.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:tT.cube_vert,fragmentShader:tT.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:tT.equirect_vert,fragmentShader:tT.equirect_frag},distanceRGBA:{uniforms:LA([eT.common,eT.displacementmap,{referencePosition:{value:new Ab},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:tT.distanceRGBA_vert,fragmentShader:tT.distanceRGBA_frag},shadow:{uniforms:LA([eT.lights,eT.fog,{color:{value:new Uw(0)},opacity:{value:1}}]),vertexShader:tT.shadow_vert,fragmentShader:tT.shadow_frag}};iT.physical={uniforms:LA([iT.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Zx},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Zx},clearcoatNormalScale:{value:new Xx(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Zx},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Zx},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Zx},sheen:{value:0},sheenColor:{value:new Uw(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Zx},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Zx},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Zx},transmissionSamplerSize:{value:new Xx},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Zx},attenuationDistance:{value:0},attenuationColor:{value:new Uw(0)},specularColor:{value:new Uw(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Zx},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Zx},anisotropyVector:{value:new Xx},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Zx}}]),vertexShader:tT.meshphysical_vert,fragmentShader:tT.meshphysical_frag};const nT={r:0,b:0,g:0};function rT(t,e,i,n,r,s,o){const a=new Uw(0);let l,c,h=!0===s?0:1,u=null,d=0,p=null;function f(e,i){e.getRGB(nT,RA(t)),n.buffers.color.setClear(nT.r,nT.g,nT.b,i,o)}return{getClearColor:function(){return a},setClearColor:function(t,e=1){a.set(t),h=e,f(a,h)},getClearAlpha:function(){return h},setClearAlpha:function(t){h=t,f(a,h)},render:function(s,m){let g=!1,_=!0===m.isScene?m.background:null;if(_&&_.isTexture){_=(m.backgroundBlurriness>0?i:e).get(_)}null===_?f(a,h):_&&_.isColor&&(f(_,1),g=!0);const y=t.xr.getEnvironmentBlendMode();"additive"===y?n.buffers.color.setClear(0,0,0,1,o):"alpha-blend"===y&&n.buffers.color.setClear(0,0,0,0,o),(t.autoClear||g)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),_&&(_.isCubeTexture||_.mapping===ov)?(void 0===c&&(c=new EA(new IA(1,1,1),new DA({name:"BackgroundCubeMaterial",uniforms:PA(iT.backgroundCube.uniforms),vertexShader:iT.backgroundCube.vertexShader,fragmentShader:iT.backgroundCube.fragmentShader,side:Ny,depthTest:!1,depthWrite:!1,fog:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(c)),c.material.uniforms.envMap.value=_,c.material.uniforms.flipEnvMap.value=_.isCubeTexture&&!1===_.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=m.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,c.material.toneMapped=ab.getTransfer(_.colorSpace)!==Tx,u===_&&d===_.version&&p===t.toneMapping||(c.material.needsUpdate=!0,u=_,d=_.version,p=t.toneMapping),c.layers.enableAll(),s.unshift(c,c.geometry,c.material,0,0,null)):_&&_.isTexture&&(void 0===l&&(l=new EA(new QA(2,2),new DA({name:"BackgroundMaterial",uniforms:PA(iT.background.uniforms),vertexShader:iT.background.vertexShader,fragmentShader:iT.background.fragmentShader,side:zy,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(l)),l.material.uniforms.t2D.value=_,l.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,l.material.toneMapped=ab.getTransfer(_.colorSpace)!==Tx,!0===_.matrixAutoUpdate&&_.updateMatrix(),l.material.uniforms.uvTransform.value.copy(_.matrix),u===_&&d===_.version&&p===t.toneMapping||(l.material.needsUpdate=!0,u=_,d=_.version,p=t.toneMapping),l.layers.enableAll(),s.unshift(l,l.geometry,l.material,0,0,null))}}}function sT(t,e,i,n){const r=t.getParameter(t.MAX_VERTEX_ATTRIBS),s=n.isWebGL2?null:e.get("OES_vertex_array_object"),o=n.isWebGL2||null!==s,a={},l=p(null);let c=l,h=!1;function u(e){return n.isWebGL2?t.bindVertexArray(e):s.bindVertexArrayOES(e)}function d(e){return n.isWebGL2?t.deleteVertexArray(e):s.deleteVertexArrayOES(e)}function p(t){const e=[],i=[],n=[];for(let t=0;t<r;t++)e[t]=0,i[t]=0,n[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:n,object:t,attributes:{},index:null}}function f(){const t=c.newAttributes;for(let e=0,i=t.length;e<i;e++)t[e]=0}function m(t){g(t,0)}function g(i,r){const s=c.enabledAttributes,o=c.attributeDivisors;if(c.newAttributes[i]=1,0===s[i]&&(t.enableVertexAttribArray(i),s[i]=1),o[i]!==r){(n.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),o[i]=r}}function _(){const e=c.newAttributes,i=c.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==e[n]&&(t.disableVertexAttribArray(n),i[n]=0)}function y(e,i,n,r,s,o,a){!0===a?t.vertexAttribIPointer(e,i,n,s,o):t.vertexAttribPointer(e,i,n,r,s,o)}function v(){x(),h=!0,c!==l&&(c=l,u(c.object))}function x(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,d,v,x){let b=!1;if(o){const e=function(e,i,r){const o=!0===r.wireframe;let l=a[e.id];void 0===l&&(l={},a[e.id]=l);let c=l[i.id];void 0===c&&(c={},l[i.id]=c);let h=c[o];void 0===h&&(h=p(n.isWebGL2?t.createVertexArray():s.createVertexArrayOES()),c[o]=h);return h}(v,d,l);c!==e&&(c=e,u(c.object)),b=function(t,e,i,n){const r=c.attributes,s=e.attributes;let o=0;const a=i.getAttributes();for(const e in a){if(a[e].location>=0){const i=r[e];let n=s[e];if(void 0===n&&("instanceMatrix"===e&&t.instanceMatrix&&(n=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(n=t.instanceColor)),void 0===i)return!0;if(i.attribute!==n)return!0;if(n&&i.data!==n.data)return!0;o++}}return c.attributesNum!==o||c.index!==n}(r,v,d,x),b&&function(t,e,i,n){const r={},s=e.attributes;let o=0;const a=i.getAttributes();for(const e in a){if(a[e].location>=0){let i=s[e];void 0===i&&("instanceMatrix"===e&&t.instanceMatrix&&(i=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(i=t.instanceColor));const n={};n.attribute=i,i&&i.data&&(n.data=i.data),r[e]=n,o++}}c.attributes=r,c.attributesNum=o,c.index=n}(r,v,d,x)}else{const t=!0===l.wireframe;c.geometry===v.id&&c.program===d.id&&c.wireframe===t||(c.geometry=v.id,c.program=d.id,c.wireframe=t,b=!0)}null!==x&&i.update(x,t.ELEMENT_ARRAY_BUFFER),(b||h)&&(h=!1,function(r,s,o,a){if(!1===n.isWebGL2&&(r.isInstancedMesh||a.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;f();const l=a.attributes,c=o.getAttributes(),h=s.defaultAttributeValues;for(const e in c){const s=c[e];if(s.location>=0){let o=l[e];if(void 0===o&&("instanceMatrix"===e&&r.instanceMatrix&&(o=r.instanceMatrix),"instanceColor"===e&&r.instanceColor&&(o=r.instanceColor)),void 0!==o){const e=o.normalized,l=o.itemSize,c=i.get(o);if(void 0===c)continue;const h=c.buffer,u=c.type,d=c.bytesPerElement,p=!0===n.isWebGL2&&(u===t.INT||u===t.UNSIGNED_INT||o.gpuType===yv);if(o.isInterleavedBufferAttribute){const i=o.data,n=i.stride,c=o.offset;if(i.isInstancedInterleavedBuffer){for(let t=0;t<s.locationSize;t++)g(s.location+t,i.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let t=0;t<s.locationSize;t++)m(s.location+t);t.bindBuffer(t.ARRAY_BUFFER,h);for(let t=0;t<s.locationSize;t++)y(s.location+t,l/s.locationSize,u,e,n*d,(c+l/s.locationSize*t)*d,p)}else{if(o.isInstancedBufferAttribute){for(let t=0;t<s.locationSize;t++)g(s.location+t,o.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===a._maxInstanceCount&&(a._maxInstanceCount=o.meshPerAttribute*o.count)}else for(let t=0;t<s.locationSize;t++)m(s.location+t);t.bindBuffer(t.ARRAY_BUFFER,h);for(let t=0;t<s.locationSize;t++)y(s.location+t,l/s.locationSize,u,e,l*d,l/s.locationSize*t*d,p)}}else if(void 0!==h){const i=h[e];if(void 0!==i)switch(i.length){case 2:t.vertexAttrib2fv(s.location,i);break;case 3:t.vertexAttrib3fv(s.location,i);break;case 4:t.vertexAttrib4fv(s.location,i);break;default:t.vertexAttrib1fv(s.location,i)}}}}_()}(r,l,d,v),null!==x&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i.get(x).buffer))},reset:v,resetDefaultState:x,dispose:function(){v();for(const t in a){const e=a[t];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete a[t]}},releaseStatesOfGeometry:function(t){if(void 0===a[t.id])return;const e=a[t.id];for(const t in e){const i=e[t];for(const t in i)d(i[t].object),delete i[t];delete e[t]}delete a[t.id]},releaseStatesOfProgram:function(t){for(const e in a){const i=a[e];if(void 0===i[t.id])continue;const n=i[t.id];for(const t in n)d(n[t].object),delete n[t];delete i[t.id]}},initAttributes:f,enableAttribute:m,disableUnusedAttributes:_}}function oT(t,e,i,n){const r=n.isWebGL2;let s;this.setMode=function(t){s=t},this.render=function(e,n){t.drawArrays(s,e,n),i.update(n,s,1)},this.renderInstances=function(n,o,a){if(0===a)return;let l,c;if(r)l=t,c="drawArraysInstanced";else if(l=e.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return;l[c](s,n,o,a),i.update(o,s,a)},this.renderMultiDraw=function(t,n,r){if(0===r)return;const o=e.get("WEBGL_multi_draw");if(null===o)for(let e=0;e<r;e++)this.render(t[e],n[e]);else{o.multiDrawArraysWEBGL(s,t,0,n,0,r);let e=0;for(let t=0;t<r;t++)e+=n[t];i.update(e,s,1)}}}function aT(t,e,i){let n;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===t.constructor.name;let o=void 0!==i.precision?i.precision:"highp";const a=r(o);a!==o&&(o=a);const l=s||e.has("WEBGL_draw_buffers"),c=!0===i.logarithmicDepthBuffer,h=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),u=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),d=t.getParameter(t.MAX_TEXTURE_SIZE),p=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),f=t.getParameter(t.MAX_VERTEX_ATTRIBS),m=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),g=t.getParameter(t.MAX_VARYING_VECTORS),_=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),y=u>0,v=s||e.has("OES_texture_float");return{isWebGL2:s,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===e.has("EXT_texture_filter_anisotropic")){const i=e.get("EXT_texture_filter_anisotropic");n=t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:r,precision:o,logarithmicDepthBuffer:c,maxTextures:h,maxVertexTextures:u,maxTextureSize:d,maxCubemapSize:p,maxAttributes:f,maxVertexUniforms:m,maxVaryings:g,maxFragmentUniforms:_,vertexTextures:y,floatFragmentTextures:v,floatVertexTextures:y&&v,maxSamples:s?t.getParameter(t.MAX_SAMPLES):0}}function lT(t){const e=this;let i=null,n=0,r=!1,s=!1;const o=new XA,a=new Zx,l={value:null,needsUpdate:!1};function c(t,i,n,r){const s=null!==t?t.length:0;let c=null;if(0!==s){if(c=l.value,!0!==r||null===c){const e=n+4*s,r=i.matrixWorldInverse;a.getNormalMatrix(r),(null===c||c.length<e)&&(c=new Float32Array(e));for(let e=0,i=n;e!==s;++e,i+=4)o.copy(t[e]).applyMatrix4(r,a),o.normal.toArray(c,i),c[i+3]=o.constant}l.value=c,l.needsUpdate=!0}return e.numPlanes=s,e.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e){const i=0!==t.length||e||0!==n||r;return r=e,n=t.length,i},this.beginShadows=function(){s=!0,c(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(t,e){i=c(t,e,0)},this.setState=function(o,a,h){const u=o.clippingPlanes,d=o.clipIntersection,p=o.clipShadows,f=t.get(o);if(!r||null===u||0===u.length||s&&!p)s?c(null):function(){l.value!==i&&(l.value=i,l.needsUpdate=n>0);e.numPlanes=n,e.numIntersection=0}();else{const t=s?0:n,e=4*t;let r=f.clippingState||null;l.value=r,r=c(u,a,e,h);for(let t=0;t!==e;++t)r[t]=i[t];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}function cT(t){let e=new WeakMap;function i(t,e){return e===rv?t.mapping=iv:e===sv&&(t.mapping=nv),t}function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping;if(s===rv||s===sv){if(e.has(r)){return i(e.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const o=new jA(s.height);return o.fromEquirectangularTexture(t,r),e.set(r,o),r.addEventListener("dispose",n),i(o.texture,r.mapping)}return null}}}return r},dispose:function(){e=new WeakMap}}}class hT extends OA{constructor(t=-1,e=1,i=1,n=-1,r=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=n,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-t,s=i+t,o=n+e,a=n-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,s=r+t*this.view.width,o-=e*this.view.offsetY,a=o-e*this.view.height}this.projectionMatrix.makeOrthographic(r,s,o,a,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}const uT=[.125,.215,.35,.446,.526,.582],dT=20,pT=new hT,fT=new Uw;let mT=null,gT=0,_T=0;const yT=(1+Math.sqrt(5))/2,vT=1/yT,xT=[new Ab(1,1,1),new Ab(-1,1,1),new Ab(1,1,-1),new Ab(-1,1,-1),new Ab(0,yT,vT),new Ab(0,yT,-vT),new Ab(vT,0,yT),new Ab(-vT,0,yT),new Ab(yT,vT,0),new Ab(-yT,vT,0)];class bT{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(t,e=0,i=.1,n=100){mT=this._renderer.getRenderTarget(),gT=this._renderer.getActiveCubeFace(),_T=this._renderer.getActiveMipmapLevel(),this._setSize(256);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(t,i,n,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(t,e=null){return this._fromTexture(t,e)}fromCubemap(t,e=null){return this._fromTexture(t,e)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=MT(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=TT(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(mT,gT,_T),t.scissorTest=!1,AT(t,0,0,t.width,t.height)}_fromTexture(t,e){this._setSize(t.mapping===iv||t.mapping===nv?0===t.image.length?16:t.image[0].width||t.image[0].image.width:t.image.width/4),mT=this._renderer.getRenderTarget(),gT=this._renderer.getActiveCubeFace(),_T=this._renderer.getActiveMipmapLevel();const i=e||this._allocateTargets();return this._textureToCubeUV(t,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const t=3*Math.max(this._cubeSize,112),e=4*this._cubeSize,i={magFilter:pv,minFilter:pv,generateMipmaps:!1,type:bv,format:Mv,colorSpace:xx,depthBuffer:!1},n=wT(t,e,i);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t||this._pingPongRenderTarget.height!==e){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=wT(t,e,i);const{_lodMax:n}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(t){const e=[],i=[],n=[];let r=t;const s=t-4+1+uT.length;for(let o=0;o<s;o++){const s=Math.pow(2,r);i.push(s);let a=1/s;o>t-4?a=uT[o-t+4-1]:0===o&&(a=0),n.push(a);const l=1/(s-2),c=-l,h=1+l,u=[c,c,h,c,h,h,c,c,h,h,c,h],d=6,p=6,f=3,m=2,g=1,_=new Float32Array(f*p*d),y=new Float32Array(m*p*d),v=new Float32Array(g*p*d);for(let t=0;t<d;t++){const e=t%3*2/3-1,i=t>2?0:-1;_.set([e,i,0,e+2/3,i,0,e+2/3,i+1,0,e,i,0,e+2/3,i+1,0,e,i+1,0],f*p*t),y.set(u,m*p*t);v.set([t,t,t,t,t,t],g*p*t)}const x=new cA;x.setAttribute("position",new Kw(_,f)),x.setAttribute("uv",new Kw(y,m)),x.setAttribute("faceIndex",new Kw(v,g)),e.push(x),r>4&&r--}return{lodPlanes:e,sizeLods:i,sigmas:n}}(n)),this._blurMaterial=function(t,e,i){const n=new Float32Array(dT),r=new Ab(0,1,0),s=new DA({name:"SphericalGaussianBlur",defines:{n:dT,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${t}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:ST(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return s}(n,t,e)}return n}_compileMaterial(t){const e=new EA(this._lodPlanes[0],t);this._renderer.compile(e,pT)}_sceneToCubeUV(t,e,i,n){const r=new NA(90,1,e,i),s=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],a=this._renderer,l=a.autoClear,c=a.toneMapping;a.getClearColor(fT),a.toneMapping=qy,a.autoClear=!1;const h=new Hw({name:"PMREM.Background",side:Ny,depthWrite:!1,depthTest:!1}),u=new EA(new IA,h);let d=!1;const p=t.background;p?p.isColor&&(h.color.copy(p),t.background=null,d=!0):(h.color.copy(fT),d=!0);for(let e=0;e<6;e++){const i=e%3;0===i?(r.up.set(0,s[e],0),r.lookAt(o[e],0,0)):1===i?(r.up.set(0,0,s[e]),r.lookAt(0,o[e],0)):(r.up.set(0,s[e],0),r.lookAt(0,0,o[e]));const l=this._cubeSize;AT(n,i*l,e>2?l:0,l,l),a.setRenderTarget(n),d&&a.render(u,r),a.render(t,r)}u.geometry.dispose(),u.material.dispose(),a.toneMapping=c,a.autoClear=l,t.background=p}_textureToCubeUV(t,e){const i=this._renderer,n=t.mapping===iv||t.mapping===nv;n?(null===this._cubemapMaterial&&(this._cubemapMaterial=MT()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===t.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=TT());const r=n?this._cubemapMaterial:this._equirectMaterial,s=new EA(this._lodPlanes[0],r);r.uniforms.envMap.value=t;const o=this._cubeSize;AT(e,0,0,3*o,2*o),i.setRenderTarget(e),i.render(s,pT)}_applyPMREM(t){const e=this._renderer,i=e.autoClear;e.autoClear=!1;for(let e=1;e<this._lodPlanes.length;e++){const i=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]);this._blur(t,e-1,e,i,xT[(e-1)%xT.length])}e.autoClear=i}_blur(t,e,i,n,r){const s=this._pingPongRenderTarget;this._halfBlur(t,s,e,i,n,"latitudinal",r),this._halfBlur(s,t,i,i,n,"longitudinal",r)}_halfBlur(t,e,i,n,r,s,o){const a=this._renderer,l=this._blurMaterial,c=new EA(this._lodPlanes[n],l),h=l.uniforms,u=this._sizeLods[i]-1,d=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):dT,m=[];let g=0;for(let t=0;t<dT;++t){const e=t/p,i=Math.exp(-e*e/2);m.push(i),0===t?g+=i:t<f&&(g+=2*i)}for(let t=0;t<m.length;t++)m[t]=m[t]/g;h.envMap.value=t.texture,h.samples.value=f,h.weights.value=m,h.latitudinal.value="latitudinal"===s,o&&(h.poleAxis.value=o);const{_lodMax:_}=this;h.dTheta.value=d,h.mipInt.value=_-i;const y=this._sizeLods[n];AT(e,3*y*(n>_-4?n-_+4:0),4*(this._cubeSize-y),3*y,2*y),a.setRenderTarget(e),a.render(c,pT)}}function wT(t,e,i){const n=new vb(t,e,i);return n.texture.mapping=ov,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function AT(t,e,i,n,r){t.viewport.set(e,i,n,r),t.scissor.set(e,i,n,r)}function TT(){return new DA({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:ST(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function MT(){return new DA({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:ST(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function ST(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function ET(t){let e=new WeakMap,i=null;function n(t){const i=t.target;i.removeEventListener("dispose",n);const r=e.get(i);void 0!==r&&(e.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping,o=s===rv||s===sv,a=s===iv||s===nv;if(o||a){if(r.isRenderTargetTexture&&!0===r.needsPMREMUpdate){r.needsPMREMUpdate=!1;let n=e.get(r);return null===i&&(i=new bT(t)),n=o?i.fromEquirectangular(r,n):i.fromCubemap(r,n),e.set(r,n),n.texture}if(e.has(r))return e.get(r).texture;{const s=r.image;if(o&&s&&s.height>0||a&&s&&function(t){let e=0;const i=6;for(let n=0;n<i;n++)void 0!==t[n]&&e++;return e===i}(s)){null===i&&(i=new bT(t));const s=o?i.fromEquirectangular(r):i.fromCubemap(r);return e.set(r,s),r.addEventListener("dispose",n),s.texture}return null}}}return r},dispose:function(){e=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function CT(t){const e={};function i(i){if(void 0!==e[i])return e[i];let n;switch(i){case"WEBGL_depth_texture":n=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=t.getExtension(i)}return e[i]=n,n}return{has:function(t){return null!==i(t)},init:function(t){t.isWebGL2?(i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance")):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture")},get:function(t){return i(t)}}}function IT(t,e,i,n){const r={},s=new WeakMap;function o(t){const a=t.target;null!==a.index&&e.remove(a.index);for(const t in a.attributes)e.remove(a.attributes[t]);for(const t in a.morphAttributes){const i=a.morphAttributes[t];for(let t=0,n=i.length;t<n;t++)e.remove(i[t])}a.removeEventListener("dispose",o),delete r[a.id];const l=s.get(a);l&&(e.remove(l),s.delete(a)),n.releaseStatesOfGeometry(a),!0===a.isInstancedBufferGeometry&&delete a._maxInstanceCount,i.memory.geometries--}function a(t){const i=[],n=t.index,r=t.attributes.position;let o=0;if(null!==n){const t=n.array;o=n.version;for(let e=0,n=t.length;e<n;e+=3){const n=t[e+0],r=t[e+1],s=t[e+2];i.push(n,r,r,s,s,n)}}else{if(void 0===r)return;o=r.version;for(let t=0,e=r.array.length/3-1;t<e;t+=3){const e=t+0,n=t+1,r=t+2;i.push(e,n,n,r,r,e)}}const a=new(Yx(i)?tA:Qw)(i,1);a.version=o;const l=s.get(t);l&&e.remove(l),s.set(t,a)}return{get:function(t,e){return!0===r[e.id]||(e.addEventListener("dispose",o),r[e.id]=!0,i.memory.geometries++),e},update:function(i){const n=i.attributes;for(const i in n)e.update(n[i],t.ARRAY_BUFFER);const r=i.morphAttributes;for(const i in r){const n=r[i];for(let i=0,r=n.length;i<r;i++)e.update(n[i],t.ARRAY_BUFFER)}},getWireframeAttribute:function(t){const e=s.get(t);if(e){const i=t.index;null!==i&&e.version<i.version&&a(t)}else a(t);return s.get(t)}}}function PT(t,e,i,n){const r=n.isWebGL2;let s,o,a;this.setMode=function(t){s=t},this.setIndex=function(t){o=t.type,a=t.bytesPerElement},this.render=function(e,n){t.drawElements(s,n,o,e*a),i.update(n,s,1)},this.renderInstances=function(n,l,c){if(0===c)return;let h,u;if(r)h=t,u="drawElementsInstanced";else if(h=e.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===h)return;h[u](s,l,o,n*a,c),i.update(l,s,c)},this.renderMultiDraw=function(t,n,r){if(0===r)return;const l=e.get("WEBGL_multi_draw");if(null===l)for(let e=0;e<r;e++)this.render(t[e]/a,n[e]);else{l.multiDrawElementsWEBGL(s,n,0,o,t,0,r);let e=0;for(let t=0;t<r;t++)e+=n[t];i.update(e,s,1)}}}function LT(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(i,n,r){switch(e.calls++,n){case t.TRIANGLES:e.triangles+=r*(i/3);break;case t.LINES:e.lines+=r*(i/2);break;case t.LINE_STRIP:e.lines+=r*(i-1);break;case t.LINE_LOOP:e.lines+=r*i;break;case t.POINTS:e.points+=r*i}}}}function RT(t,e){return t[0]-e[0]}function BT(t,e){return Math.abs(e[1])-Math.abs(t[1])}function DT(t,e,i){const n={},r=new Float32Array(8),s=new WeakMap,o=new _b,a=[];for(let t=0;t<8;t++)a[t]=[t,0];return{update:function(l,c,h){const u=l.morphTargetInfluences;if(!0===e.isWebGL2){const d=c.morphAttributes.position||c.morphAttributes.normal||c.morphAttributes.color,p=void 0!==d?d.length:0;let f=s.get(c);if(void 0===f||f.count!==p){void 0!==f&&f.texture.dispose();const _=void 0!==c.morphAttributes.position,y=void 0!==c.morphAttributes.normal,v=void 0!==c.morphAttributes.color,x=c.morphAttributes.position||[],b=c.morphAttributes.normal||[],w=c.morphAttributes.color||[];let A=0;!0===_&&(A=1),!0===y&&(A=2),!0===v&&(A=3);let T=c.attributes.position.count*A,M=1;T>e.maxTextureSize&&(M=Math.ceil(T/e.maxTextureSize),T=e.maxTextureSize);const S=new Float32Array(T*M*4*p),E=new xb(S,T,M,p);E.type=xv,E.needsUpdate=!0;const C=4*A;for(let P=0;P<p;P++){const L=x[P],R=b[P],B=w[P],D=T*M*4*P;for(let O=0;O<L.count;O++){const k=O*C;!0===_&&(o.fromBufferAttribute(L,O),S[D+k+0]=o.x,S[D+k+1]=o.y,S[D+k+2]=o.z,S[D+k+3]=0),!0===y&&(o.fromBufferAttribute(R,O),S[D+k+4]=o.x,S[D+k+5]=o.y,S[D+k+6]=o.z,S[D+k+7]=0),!0===v&&(o.fromBufferAttribute(B,O),S[D+k+8]=o.x,S[D+k+9]=o.y,S[D+k+10]=o.z,S[D+k+11]=4===B.itemSize?o.w:1)}}function I(){E.dispose(),s.delete(c),c.removeEventListener("dispose",I)}f={count:p,texture:E,size:new Xx(T,M)},s.set(c,f),c.addEventListener("dispose",I)}let m=0;for(let F=0;F<u.length;F++)m+=u[F];const g=c.morphTargetsRelative?1:1-m;h.getUniforms().setValue(t,"morphTargetBaseInfluence",g),h.getUniforms().setValue(t,"morphTargetInfluences",u),h.getUniforms().setValue(t,"morphTargetsTexture",f.texture,i),h.getUniforms().setValue(t,"morphTargetsTextureSize",f.size)}else{const z=void 0===u?0:u.length;let N=n[c.id];if(void 0===N||N.length!==z){N=[];for(let H=0;H<z;H++)N[H]=[H,0];n[c.id]=N}for(let W=0;W<z;W++){const q=N[W];q[0]=W,q[1]=u[W]}N.sort(BT);for(let X=0;X<8;X++)X<z&&N[X][1]?(a[X][0]=N[X][0],a[X][1]=N[X][1]):(a[X][0]=Number.MAX_SAFE_INTEGER,a[X][1]=0);a.sort(RT);const U=c.morphAttributes.position,G=c.morphAttributes.normal;let V=0;for(let Z=0;Z<8;Z++){const J=a[Z],Y=J[0],$=J[1];Y!==Number.MAX_SAFE_INTEGER&&$?(U&&c.getAttribute("morphTarget"+Z)!==U[Y]&&c.setAttribute("morphTarget"+Z,U[Y]),G&&c.getAttribute("morphNormal"+Z)!==G[Y]&&c.setAttribute("morphNormal"+Z,G[Y]),r[Z]=$,V+=$):(U&&!0===c.hasAttribute("morphTarget"+Z)&&c.deleteAttribute("morphTarget"+Z),G&&!0===c.hasAttribute("morphNormal"+Z)&&c.deleteAttribute("morphNormal"+Z),r[Z]=0)}const j=c.morphTargetsRelative?1:1-V;h.getUniforms().setValue(t,"morphTargetBaseInfluence",j),h.getUniforms().setValue(t,"morphTargetInfluences",r)}}}}function OT(t,e,i,n){let r=new WeakMap;function s(t){const e=t.target;e.removeEventListener("dispose",s),i.remove(e.instanceMatrix),null!==e.instanceColor&&i.remove(e.instanceColor)}return{update:function(o){const a=n.render.frame,l=e.get(o,o.geometry);if(r.get(l)!==a&&(e.update(l),r.set(l,a)),o.isInstancedMesh&&(!1===o.hasEventListener("dispose",s)&&o.addEventListener("dispose",s),r.get(o)!==a&&(i.update(o.instanceMatrix,t.ARRAY_BUFFER),null!==o.instanceColor&&i.update(o.instanceColor,t.ARRAY_BUFFER),r.set(o,a))),o.isSkinnedMesh){const t=o.skeleton;r.get(t)!==a&&(t.update(),r.set(t,a))}return l},dispose:function(){r=new WeakMap}}}class kT extends gb{constructor(t,e,i,n,r,s,o,a,l,c){if((c=void 0!==c?c:Sv)!==Sv&&c!==Ev)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&c===Sv&&(i=vv),void 0===i&&c===Ev&&(i=Tv),super(null,n,r,s,o,a,c,i,l),this.isDepthTexture=!0,this.image={width:t,height:e},this.magFilter=void 0!==o?o:hv,this.minFilter=void 0!==a?a:hv,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.compareFunction=t.compareFunction,this}toJSON(t){const e=super.toJSON(t);return null!==this.compareFunction&&(e.compareFunction=this.compareFunction),e}}const FT=new gb,zT=new kT(1,1);zT.compareFunction=515;const NT=new xb,UT=new bb,GT=new VA,VT=[],jT=[],HT=new Float32Array(16),WT=new Float32Array(9),qT=new Float32Array(4);function XT(t,e,i){const n=t[0];if(n<=0||n>0)return t;const r=e*i;let s=VT[r];if(void 0===s&&(s=new Float32Array(r),VT[r]=s),0!==e){n.toArray(s,0);for(let n=1,r=0;n!==e;++n)r+=i,t[n].toArray(s,r)}return s}function ZT(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function JT(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function YT(t,e){let i=jT[e];void 0===i&&(i=new Int32Array(e),jT[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function $T(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function KT(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(ZT(i,e))return;t.uniform2fv(this.addr,e),JT(i,e)}}function QT(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(ZT(i,e))return;t.uniform3fv(this.addr,e),JT(i,e)}}function tM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(ZT(i,e))return;t.uniform4fv(this.addr,e),JT(i,e)}}function eM(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(ZT(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),JT(i,e)}else{if(ZT(i,n))return;qT.set(n),t.uniformMatrix2fv(this.addr,!1,qT),JT(i,n)}}function iM(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(ZT(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),JT(i,e)}else{if(ZT(i,n))return;WT.set(n),t.uniformMatrix3fv(this.addr,!1,WT),JT(i,n)}}function nM(t,e){const i=this.cache,n=e.elements;if(void 0===n){if(ZT(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),JT(i,e)}else{if(ZT(i,n))return;HT.set(n),t.uniformMatrix4fv(this.addr,!1,HT),JT(i,n)}}function rM(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function sM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2i(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(ZT(i,e))return;t.uniform2iv(this.addr,e),JT(i,e)}}function oM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3i(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(ZT(i,e))return;t.uniform3iv(this.addr,e),JT(i,e)}}function aM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4i(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(ZT(i,e))return;t.uniform4iv(this.addr,e),JT(i,e)}}function lM(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function cM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2ui(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(ZT(i,e))return;t.uniform2uiv(this.addr,e),JT(i,e)}}function hM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3ui(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(ZT(i,e))return;t.uniform3uiv(this.addr,e),JT(i,e)}}function uM(t,e){const i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4ui(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(ZT(i,e))return;t.uniform4uiv(this.addr,e),JT(i,e)}}function dM(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r);i.setTexture2D(e||(this.type===t.SAMPLER_2D_SHADOW?zT:FT),r)}function pM(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||UT,r)}function fM(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTextureCube(e||GT,r)}function mM(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||NT,r)}function gM(t,e){t.uniform1fv(this.addr,e)}function _M(t,e){const i=XT(e,this.size,2);t.uniform2fv(this.addr,i)}function yM(t,e){const i=XT(e,this.size,3);t.uniform3fv(this.addr,i)}function vM(t,e){const i=XT(e,this.size,4);t.uniform4fv(this.addr,i)}function xM(t,e){const i=XT(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function bM(t,e){const i=XT(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function wM(t,e){const i=XT(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function AM(t,e){t.uniform1iv(this.addr,e)}function TM(t,e){t.uniform2iv(this.addr,e)}function MM(t,e){t.uniform3iv(this.addr,e)}function SM(t,e){t.uniform4iv(this.addr,e)}function EM(t,e){t.uniform1uiv(this.addr,e)}function CM(t,e){t.uniform2uiv(this.addr,e)}function IM(t,e){t.uniform3uiv(this.addr,e)}function PM(t,e){t.uniform4uiv(this.addr,e)}function LM(t,e,i){const n=this.cache,r=e.length,s=YT(i,r);ZT(n,s)||(t.uniform1iv(this.addr,s),JT(n,s));for(let t=0;t!==r;++t)i.setTexture2D(e[t]||FT,s[t])}function RM(t,e,i){const n=this.cache,r=e.length,s=YT(i,r);ZT(n,s)||(t.uniform1iv(this.addr,s),JT(n,s));for(let t=0;t!==r;++t)i.setTexture3D(e[t]||UT,s[t])}function BM(t,e,i){const n=this.cache,r=e.length,s=YT(i,r);ZT(n,s)||(t.uniform1iv(this.addr,s),JT(n,s));for(let t=0;t!==r;++t)i.setTextureCube(e[t]||GT,s[t])}function DM(t,e,i){const n=this.cache,r=e.length,s=YT(i,r);ZT(n,s)||(t.uniform1iv(this.addr,s),JT(n,s));for(let t=0;t!==r;++t)i.setTexture2DArray(e[t]||NT,s[t])}class OM{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.setValue=function(t){switch(t){case 5126:return $T;case 35664:return KT;case 35665:return QT;case 35666:return tM;case 35674:return eM;case 35675:return iM;case 35676:return nM;case 5124:case 35670:return rM;case 35667:case 35671:return sM;case 35668:case 35672:return oM;case 35669:case 35673:return aM;case 5125:return lM;case 36294:return cM;case 36295:return hM;case 36296:return uM;case 35678:case 36198:case 36298:case 36306:case 35682:return dM;case 35679:case 36299:case 36307:return pM;case 35680:case 36300:case 36308:case 36293:return fM;case 36289:case 36303:case 36311:case 36292:return mM}}(e.type)}}class kM{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.size=e.size,this.setValue=function(t){switch(t){case 5126:return gM;case 35664:return _M;case 35665:return yM;case 35666:return vM;case 35674:return xM;case 35675:return bM;case 35676:return wM;case 5124:case 35670:return AM;case 35667:case 35671:return TM;case 35668:case 35672:return MM;case 35669:case 35673:return SM;case 5125:return EM;case 36294:return CM;case 36295:return IM;case 36296:return PM;case 35678:case 36198:case 36298:case 36306:case 35682:return LM;case 35679:case 36299:case 36307:return RM;case 35680:case 36300:case 36308:case 36293:return BM;case 36289:case 36303:case 36311:case 36292:return DM}}(e.type)}}class FM{constructor(t){this.id=t,this.seq=[],this.map={}}setValue(t,e,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(t,e[s.id],i)}}}const zM=/(\w+)(\])?(\[|\.)?/g;function NM(t,e){t.seq.push(e),t.map[e.id]=e}function UM(t,e,i){const n=t.name,r=n.length;for(zM.lastIndex=0;;){const s=zM.exec(n);let o=s[1];const a=s[3];if("]"===s[2]&&(o|=0),void 0===a||"["===a&&zM.lastIndex+2===r){NM(i,void 0===a?new OM(o,t,e):new kM(o,t,e));break}{let t=i.map[o];void 0===t&&(t=new FM(o),NM(i,t)),i=t}}}class GM{constructor(t,e){this.seq=[],this.map={};const i=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let n=0;n<i;++n){const i=t.getActiveUniform(e,n);UM(i,t.getUniformLocation(e,i.name),this)}}setValue(t,e,i,n){const r=this.map[e];void 0!==r&&r.setValue(t,i,n)}setOptional(t,e,i){const n=e[i];void 0!==n&&this.setValue(t,i,n)}static upload(t,e,i,n){for(let r=0,s=e.length;r!==s;++r){const s=e[r],o=i[s.id];!1!==o.needsUpdate&&s.setValue(t,o.value,n)}}static seqWithValue(t,e){const i=[];for(let n=0,r=t.length;n!==r;++n){const r=t[n];r.id in e&&i.push(r)}return i}}function VM(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}const jM=37297;let HM=0;function WM(t,e,i){const n=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(n&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const n=parseInt(s[1]);return i.toUpperCase()+"\n\n"+r+"\n\n"+function(t,e){const i=t.split("\n"),n=[],r=Math.max(e-6,0),s=Math.min(e+6,i.length);for(let t=r;t<s;t++){const r=t+1;n.push(`${r===e?">":" "} ${r}: ${i[t]}`)}return n.join("\n")}(t.getShaderSource(e),n)}return r}function qM(t,e){const i=function(t){const e=ab.getPrimaries(ab.workingColorSpace),i=ab.getPrimaries(t);let n;switch(e===i?n="":e===Sx&&i===Mx?n="LinearDisplayP3ToLinearSRGB":e===Mx&&i===Sx&&(n="LinearSRGBToLinearDisplayP3"),t){case xx:case wx:return[n,"LinearTransferOETF"];case vx:case bx:return[n,"sRGBTransferOETF"];default:return[n,"LinearTransferOETF"]}}(e);return`vec4 ${t}( vec4 value ) { return ${i[0]}( ${i[1]}( value ) ); }`}function XM(t,e){let i;switch(e){case Xy:i="Linear";break;case Zy:i="Reinhard";break;case Jy:i="OptimizedCineon";break;case Yy:i="ACESFilmic";break;case Ky:i="AgX";break;case $y:i="Custom";break;default:i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function ZM(t){return""!==t}function JM(t,e){const i=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function YM(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const $M=/^[ \t]*#include +<([\w\d./]+)>/gm;function KM(t){return t.replace($M,tS)}const QM=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function tS(t,e){let i=tT[e];if(void 0===i){const t=QM.get(e);if(void 0===t)throw new Error("Can not resolve #include <"+e+">");i=tT[t]}return KM(i)}const eS=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function iS(t){return t.replace(eS,nS)}function nS(t,e,i,n){let r="";for(let t=parseInt(e);t<parseInt(i);t++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function rS(t){let e=`precision ${t.precision} float;\n\tprecision ${t.precision} int;\n\tprecision ${t.precision} sampler2D;\n\tprecision ${t.precision} samplerCube;\n\t`;return t.isWebGL2&&(e+=`precision ${t.precision} sampler3D;\n\t\tprecision ${t.precision} sampler2DArray;\n\t\tprecision ${t.precision} sampler2DShadow;\n\t\tprecision ${t.precision} samplerCubeShadow;\n\t\tprecision ${t.precision} sampler2DArrayShadow;\n\t\tprecision ${t.precision} isampler2D;\n\t\tprecision ${t.precision} isampler3D;\n\t\tprecision ${t.precision} isamplerCube;\n\t\tprecision ${t.precision} isampler2DArray;\n\t\tprecision ${t.precision} usampler2D;\n\t\tprecision ${t.precision} usampler3D;\n\t\tprecision ${t.precision} usamplerCube;\n\t\tprecision ${t.precision} usampler2DArray;\n\t\t`),"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function sS(t,e,i,n){const r=t.getContext(),s=i.defines;let o=i.vertexShader,a=i.fragmentShader;const l=function(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===Oy?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===ky?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===Fy&&(e="SHADOWMAP_TYPE_VSM"),e}(i),c=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case iv:case nv:e="ENVMAP_TYPE_CUBE";break;case ov:e="ENVMAP_TYPE_CUBE_UV"}return e}(i),h=function(t){let e="ENVMAP_MODE_REFLECTION";t.envMap&&t.envMapMode===nv&&(e="ENVMAP_MODE_REFRACTION");return e}(i),u=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case jy:e="ENVMAP_BLENDING_MULTIPLY";break;case Hy:e="ENVMAP_BLENDING_MIX";break;case Wy:e="ENVMAP_BLENDING_ADD"}return e}(i),d=function(t){const e=t.envMapCubeUVHeight;if(null===e)return null;const i=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,i),112)),texelHeight:n,maxMip:i}}(i),p=i.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUVHeight||t.bumpMap||t.normalMapTangentSpace||t.clearcoatNormalMap||t.flatShading||t.alphaToCoverage||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap||t.transmission)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(ZM).join("\n")}(i),f=function(t){return[t.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",t.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(ZM).join("\n")}(i),m=function(t){const e=[];for(const i in t){const n=t[i];!1!==n&&e.push("#define "+i+" "+n)}return e.join("\n")}(s),g=r.createProgram();let _,y,v=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(_=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m].filter(ZM).join("\n"),_.length>0&&(_+="\n"),y=[p,"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m].filter(ZM).join("\n"),y.length>0&&(y+="\n")):(_=[rS(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+h:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphColors&&i.isWebGL2?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0&&i.isWebGL2?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(ZM).join("\n"),y=[p,rS(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,m,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.envMap?"#define "+h:"",i.envMap?"#define "+u:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&!1===i.flatShading?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.useLegacyLights?"#define LEGACY_LIGHTS":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==qy?"#define TONE_MAPPING":"",i.toneMapping!==qy?tT.tonemapping_pars_fragment:"",i.toneMapping!==qy?XM("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",tT.colorspace_pars_fragment,qM("linearToOutputTexel",i.outputColorSpace),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(ZM).join("\n")),o=KM(o),o=JM(o,i),o=YM(o,i),a=KM(a),a=JM(a,i),a=YM(a,i),o=iS(o),a=iS(a),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(v="#version 300 es\n",_=[f,"precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+_,y=["precision mediump sampler2DArray;","#define varying in",i.glslVersion===Ix?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===Ix?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+y);const x=v+y+a,b=VM(r,r.VERTEX_SHADER,v+_+o),w=VM(r,r.FRAGMENT_SHADER,x);function A(e){if(t.debug.checkShaderErrors){const i=r.getProgramInfoLog(g).trim(),n=r.getShaderInfoLog(b).trim(),s=r.getShaderInfoLog(w).trim();let o=!0,a=!0;!1===r.getProgramParameter(g,r.LINK_STATUS)?(o=!1,"function"==typeof t.debug.onShaderError?t.debug.onShaderError(r,g,b,w):(WM(r,b,"vertex"),WM(r,w,"fragment"))):""!==i||""!==n&&""!==s||(a=!1),a&&(e.diagnostics={runnable:o,programLog:i,vertexShader:{log:n,prefix:_},fragmentShader:{log:s,prefix:y}})}r.deleteShader(b),r.deleteShader(w),T=new GM(r,g),M=function(t,e){const i={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const n=t.getActiveAttrib(e,r),s=n.name;let o=1;n.type===t.FLOAT_MAT2&&(o=2),n.type===t.FLOAT_MAT3&&(o=3),n.type===t.FLOAT_MAT4&&(o=4),i[s]={type:n.type,location:t.getAttribLocation(e,s),locationSize:o}}return i}(r,g)}let T,M;r.attachShader(g,b),r.attachShader(g,w),void 0!==i.index0AttributeName?r.bindAttribLocation(g,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(g,0,"position"),r.linkProgram(g),this.getUniforms=function(){return void 0===T&&A(this),T},this.getAttributes=function(){return void 0===M&&A(this),M};let S=!1===i.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===S&&(S=r.getProgramParameter(g,jM)),S},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(g),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=HM++,this.cacheKey=e,this.usedTimes=1,this.program=g,this.vertexShader=b,this.fragmentShader=w,this}let oS=0;class aS{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(t){const e=t.fragmentShader,i=this._getShaderStage(t.vertexShader),n=this._getShaderStage(e),r=this._getShaderCacheForMaterial(t);return!1===r.has(i)&&(r.add(i),i.usedTimes++),!1===r.has(n)&&(r.add(n),n.usedTimes++),this}remove(t){const e=this.materialCache.get(t);for(const t of e)t.usedTimes--,0===t.usedTimes&&this.shaderCache.delete(t.code);return this.materialCache.delete(t),this}getVertexShaderID(t){return this._getShaderStage(t.vertexShader).id}getFragmentShaderID(t){return this._getShaderStage(t.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(t){const e=this.materialCache;let i=e.get(t);return void 0===i&&(i=new Set,e.set(t,i)),i}_getShaderStage(t){const e=this.shaderCache;let i=e.get(t);return void 0===i&&(i=new lS(t),e.set(t,i)),i}}class lS{constructor(t){this.id=oS++,this.code=t,this.usedTimes=0}}function cS(t,e,i,n,r,s,o){const a=new hw,l=new aS,c=new Set,h=[],u=r.isWebGL2,d=r.logarithmicDepthBuffer,p=r.vertexTextures;let f=r.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function g(t){return c.add(t),0===t?"uv":`uv${t}`}return{getParameters:function(s,a,h,_,y){const v=_.fog,x=y.geometry,b=(s.isMeshStandardMaterial?i:e).get(s.envMap||(s.isMeshStandardMaterial?_.environment:null)),w=b&&b.mapping===ov?b.image.height:null,A=m[s.type];null!==s.precision&&(f=r.getMaxPrecision(s.precision));const T=x.morphAttributes.position||x.morphAttributes.normal||x.morphAttributes.color,M=void 0!==T?T.length:0;let S,E,C,I,P=0;if(void 0!==x.morphAttributes.position&&(P=1),void 0!==x.morphAttributes.normal&&(P=2),void 0!==x.morphAttributes.color&&(P=3),A){const t=iT[A];S=t.vertexShader,E=t.fragmentShader}else S=s.vertexShader,E=s.fragmentShader,l.update(s),C=l.getVertexShaderID(s),I=l.getFragmentShaderID(s);const L=t.getRenderTarget(),R=!0===y.isInstancedMesh,B=!!s.map,D=!!b,O=!!s.aoMap,k=!!s.lightMap,F=!!s.bumpMap,z=!!s.normalMap,N=!!s.displacementMap,U=!!s.emissiveMap,G=!!s.metalnessMap,V=!!s.roughnessMap,j=s.anisotropy>0,H=s.clearcoat>0,W=s.iridescence>0,q=s.sheen>0,X=s.transmission>0,Z=j&&!!s.anisotropyMap,J=H&&!!s.clearcoatMap,Y=H&&!!s.clearcoatNormalMap,$=H&&!!s.clearcoatRoughnessMap,K=W&&!!s.iridescenceMap,Q=W&&!!s.iridescenceThicknessMap,tt=q&&!!s.sheenColorMap,et=q&&!!s.sheenRoughnessMap,it=!!s.specularMap,nt=!!s.specularColorMap,rt=!!s.specularIntensityMap,st=X&&!!s.transmissionMap,ot=X&&!!s.thicknessMap,at=!!s.alphaMap,lt=!!s.extensions;let ct=qy;s.toneMapped&&(null!==L&&!0!==L.isXRRenderTarget||(ct=t.toneMapping));const ht={isWebGL2:u,shaderID:A,shaderType:s.type,shaderName:s.name,vertexShader:S,fragmentShader:E,defines:s.defines,customVertexShaderID:C,customFragmentShaderID:I,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:f,batching:!0===y.isBatchedMesh,instancing:R,instancingColor:R&&null!==y.instanceColor,supportsVertexTextures:p,outputColorSpace:null===L?t.outputColorSpace:!0===L.isXRRenderTarget?L.texture.colorSpace:xx,alphaToCoverage:!!s.alphaToCoverage,map:B,matcap:!!s.matcap,envMap:D,envMapMode:D&&b.mapping,envMapCubeUVHeight:w,aoMap:O,lightMap:k,bumpMap:F,normalMap:z,displacementMap:p&&N,emissiveMap:U,normalMapObjectSpace:z&&1===s.normalMapType,normalMapTangentSpace:z&&0===s.normalMapType,metalnessMap:G,roughnessMap:V,anisotropy:j,anisotropyMap:Z,clearcoat:H,clearcoatMap:J,clearcoatNormalMap:Y,clearcoatRoughnessMap:$,iridescence:W,iridescenceMap:K,iridescenceThicknessMap:Q,sheen:q,sheenColorMap:tt,sheenRoughnessMap:et,specularMap:it,specularColorMap:nt,specularIntensityMap:rt,transmission:X,transmissionMap:st,thicknessMap:ot,gradientMap:!!s.gradientMap,opaque:!1===s.transparent&&1===s.blending&&!1===s.alphaToCoverage,alphaMap:at,alphaTest:s.alphaTest>0,alphaHash:!!s.alphaHash,combine:s.combine,mapUv:B&&g(s.map.channel),aoMapUv:O&&g(s.aoMap.channel),lightMapUv:k&&g(s.lightMap.channel),bumpMapUv:F&&g(s.bumpMap.channel),normalMapUv:z&&g(s.normalMap.channel),displacementMapUv:N&&g(s.displacementMap.channel),emissiveMapUv:U&&g(s.emissiveMap.channel),metalnessMapUv:G&&g(s.metalnessMap.channel),roughnessMapUv:V&&g(s.roughnessMap.channel),anisotropyMapUv:Z&&g(s.anisotropyMap.channel),clearcoatMapUv:J&&g(s.clearcoatMap.channel),clearcoatNormalMapUv:Y&&g(s.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:$&&g(s.clearcoatRoughnessMap.channel),iridescenceMapUv:K&&g(s.iridescenceMap.channel),iridescenceThicknessMapUv:Q&&g(s.iridescenceThicknessMap.channel),sheenColorMapUv:tt&&g(s.sheenColorMap.channel),sheenRoughnessMapUv:et&&g(s.sheenRoughnessMap.channel),specularMapUv:it&&g(s.specularMap.channel),specularColorMapUv:nt&&g(s.specularColorMap.channel),specularIntensityMapUv:rt&&g(s.specularIntensityMap.channel),transmissionMapUv:st&&g(s.transmissionMap.channel),thicknessMapUv:ot&&g(s.thicknessMap.channel),alphaMapUv:at&&g(s.alphaMap.channel),vertexTangents:!!x.attributes.tangent&&(z||j),vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!x.attributes.color&&4===x.attributes.color.itemSize,pointsUvs:!0===y.isPoints&&!!x.attributes.uv&&(B||at),fog:!!v,useFog:!0===s.fog,fogExp2:!!v&&v.isFogExp2,flatShading:!0===s.flatShading,sizeAttenuation:!0===s.sizeAttenuation,logarithmicDepthBuffer:d,skinning:!0===y.isSkinnedMesh,morphTargets:void 0!==x.morphAttributes.position,morphNormals:void 0!==x.morphAttributes.normal,morphColors:void 0!==x.morphAttributes.color,morphTargetsCount:M,morphTextureStride:P,numDirLights:a.directional.length,numPointLights:a.point.length,numSpotLights:a.spot.length,numSpotLightMaps:a.spotLightMap.length,numRectAreaLights:a.rectArea.length,numHemiLights:a.hemi.length,numDirLightShadows:a.directionalShadowMap.length,numPointLightShadows:a.pointShadowMap.length,numSpotLightShadows:a.spotShadowMap.length,numSpotLightShadowsWithMaps:a.numSpotLightShadowsWithMaps,numLightProbes:a.numLightProbes,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:s.dithering,shadowMapEnabled:t.shadowMap.enabled&&h.length>0,shadowMapType:t.shadowMap.type,toneMapping:ct,useLegacyLights:t._useLegacyLights,decodeVideoTexture:B&&!0===s.map.isVideoTexture&&ab.getTransfer(s.map.colorSpace)===Tx,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:s.side===Ny,useDepthPacking:s.depthPacking>=0,depthPacking:s.depthPacking||0,index0AttributeName:s.index0AttributeName,extensionDerivatives:lt&&!0===s.extensions.derivatives,extensionFragDepth:lt&&!0===s.extensions.fragDepth,extensionDrawBuffers:lt&&!0===s.extensions.drawBuffers,extensionShaderTextureLOD:lt&&!0===s.extensions.shaderTextureLOD,extensionClipCullDistance:lt&&!0===s.extensions.clipCullDistance&&n.has("WEBGL_clip_cull_distance"),extensionMultiDraw:lt&&!0===s.extensions.multiDraw&&n.has("WEBGL_multi_draw"),rendererExtensionFragDepth:u||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:u||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:u||n.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:n.has("KHR_parallel_shader_compile"),customProgramCacheKey:s.customProgramCacheKey()};return ht.vertexUv1s=c.has(1),ht.vertexUv2s=c.has(2),ht.vertexUv3s=c.has(3),c.clear(),ht},getProgramCacheKey:function(e){const i=[];if(e.shaderID?i.push(e.shaderID):(i.push(e.customVertexShaderID),i.push(e.customFragmentShaderID)),void 0!==e.defines)for(const t in e.defines)i.push(t),i.push(e.defines[t]);return!1===e.isRawShaderMaterial&&(!function(t,e){t.push(e.precision),t.push(e.outputColorSpace),t.push(e.envMapMode),t.push(e.envMapCubeUVHeight),t.push(e.mapUv),t.push(e.alphaMapUv),t.push(e.lightMapUv),t.push(e.aoMapUv),t.push(e.bumpMapUv),t.push(e.normalMapUv),t.push(e.displacementMapUv),t.push(e.emissiveMapUv),t.push(e.metalnessMapUv),t.push(e.roughnessMapUv),t.push(e.anisotropyMapUv),t.push(e.clearcoatMapUv),t.push(e.clearcoatNormalMapUv),t.push(e.clearcoatRoughnessMapUv),t.push(e.iridescenceMapUv),t.push(e.iridescenceThicknessMapUv),t.push(e.sheenColorMapUv),t.push(e.sheenRoughnessMapUv),t.push(e.specularMapUv),t.push(e.specularColorMapUv),t.push(e.specularIntensityMapUv),t.push(e.transmissionMapUv),t.push(e.thicknessMapUv),t.push(e.combine),t.push(e.fogExp2),t.push(e.sizeAttenuation),t.push(e.morphTargetsCount),t.push(e.morphAttributeCount),t.push(e.numDirLights),t.push(e.numPointLights),t.push(e.numSpotLights),t.push(e.numSpotLightMaps),t.push(e.numHemiLights),t.push(e.numRectAreaLights),t.push(e.numDirLightShadows),t.push(e.numPointLightShadows),t.push(e.numSpotLightShadows),t.push(e.numSpotLightShadowsWithMaps),t.push(e.numLightProbes),t.push(e.shadowMapType),t.push(e.toneMapping),t.push(e.numClippingPlanes),t.push(e.numClipIntersection),t.push(e.depthPacking)}(i,e),function(t,e){a.disableAll(),e.isWebGL2&&a.enable(0);e.supportsVertexTextures&&a.enable(1);e.instancing&&a.enable(2);e.instancingColor&&a.enable(3);e.matcap&&a.enable(4);e.envMap&&a.enable(5);e.normalMapObjectSpace&&a.enable(6);e.normalMapTangentSpace&&a.enable(7);e.clearcoat&&a.enable(8);e.iridescence&&a.enable(9);e.alphaTest&&a.enable(10);e.vertexColors&&a.enable(11);e.vertexAlphas&&a.enable(12);e.vertexUv1s&&a.enable(13);e.vertexUv2s&&a.enable(14);e.vertexUv3s&&a.enable(15);e.vertexTangents&&a.enable(16);e.anisotropy&&a.enable(17);e.alphaHash&&a.enable(18);e.batching&&a.enable(19);t.push(a.mask),a.disableAll(),e.fog&&a.enable(0);e.useFog&&a.enable(1);e.flatShading&&a.enable(2);e.logarithmicDepthBuffer&&a.enable(3);e.skinning&&a.enable(4);e.morphTargets&&a.enable(5);e.morphNormals&&a.enable(6);e.morphColors&&a.enable(7);e.premultipliedAlpha&&a.enable(8);e.shadowMapEnabled&&a.enable(9);e.useLegacyLights&&a.enable(10);e.doubleSided&&a.enable(11);e.flipSided&&a.enable(12);e.useDepthPacking&&a.enable(13);e.dithering&&a.enable(14);e.transmission&&a.enable(15);e.sheen&&a.enable(16);e.opaque&&a.enable(17);e.pointsUvs&&a.enable(18);e.decodeVideoTexture&&a.enable(19);e.alphaToCoverage&&a.enable(20);t.push(a.mask)}(i,e),i.push(t.outputColorSpace)),i.push(e.customProgramCacheKey),i.join()},getUniforms:function(t){const e=m[t.type];let i;if(e){i=BA.clone(iT[e].uniforms)}else i=t.uniforms;return i},acquireProgram:function(e,i){let n;for(let t=0,e=h.length;t<e;t++){const e=h[t];if(e.cacheKey===i){n=e,++n.usedTimes;break}}return void 0===n&&(n=new sS(t,i,e,s),h.push(n)),n},releaseProgram:function(t){if(0==--t.usedTimes){const e=h.indexOf(t);h[e]=h[h.length-1],h.pop(),t.destroy()}},releaseShaderCache:function(t){l.remove(t)},programs:h,dispose:function(){l.dispose()}}}function hS(){let t=new WeakMap;return{get:function(e){let i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,n){t.get(e)[i]=n},dispose:function(){t=new WeakMap}}}function uS(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function dS(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function pS(){const t=[];let e=0;const i=[],n=[],r=[];function s(i,n,r,s,o,a){let l=t[e];return void 0===l?(l={id:i.id,object:i,geometry:n,material:r,groupOrder:s,renderOrder:i.renderOrder,z:o,group:a},t[e]=l):(l.id=i.id,l.object=i,l.geometry=n,l.material=r,l.groupOrder=s,l.renderOrder=i.renderOrder,l.z=o,l.group=a),e++,l}return{opaque:i,transmissive:n,transparent:r,init:function(){e=0,i.length=0,n.length=0,r.length=0},push:function(t,e,o,a,l,c){const h=s(t,e,o,a,l,c);o.transmission>0?n.push(h):!0===o.transparent?r.push(h):i.push(h)},unshift:function(t,e,o,a,l,c){const h=s(t,e,o,a,l,c);o.transmission>0?n.unshift(h):!0===o.transparent?r.unshift(h):i.unshift(h)},finish:function(){for(let i=e,n=t.length;i<n;i++){const e=t[i];if(null===e.id)break;e.id=null,e.object=null,e.geometry=null,e.material=null,e.group=null}},sort:function(t,e){i.length>1&&i.sort(t||uS),n.length>1&&n.sort(e||dS),r.length>1&&r.sort(e||dS)}}}function fS(){let t=new WeakMap;return{get:function(e,i){const n=t.get(e);let r;return void 0===n?(r=new pS,t.set(e,[r])):i>=n.length?(r=new pS,n.push(r)):r=n[i],r},dispose:function(){t=new WeakMap}}}function mS(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new Ab,color:new Uw};break;case"SpotLight":i={position:new Ab,direction:new Ab,color:new Uw,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Ab,color:new Uw,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Ab,skyColor:new Uw,groundColor:new Uw};break;case"RectAreaLight":i={color:new Uw,position:new Ab,halfWidth:new Ab,halfHeight:new Ab}}return t[e.id]=i,i}}}let gS=0;function _S(t,e){return(e.castShadow?2:0)-(t.castShadow?2:0)+(e.map?1:0)-(t.map?1:0)}function yS(t,e){const i=new mS,n=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let i;switch(e.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Xx};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Xx,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let t=0;t<9;t++)r.probe.push(new Ab);const s=new Ab,o=new Qb,a=new Qb;return{setup:function(s,o){let a=0,l=0,c=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,y=0,v=0,x=0;s.sort(_S);const b=!0===o?Math.PI:1;for(let t=0,e=s.length;t<e;t++){const e=s[t],o=e.color,w=e.intensity,A=e.distance,T=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)a+=o.r*w*b,l+=o.g*w*b,c+=o.b*w*b;else if(e.isLightProbe){for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],w);x++}else if(e.isDirectionalLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*b),e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,r.directionalShadow[h]=i,r.directionalShadowMap[h]=T,r.directionalShadowMatrix[h]=e.shadow.matrix,m++}r.directional[h]=t,h++}else if(e.isSpotLight){const t=i.get(e);t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(o).multiplyScalar(w*b),t.distance=A,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,r.spot[d]=t;const s=e.shadow;if(e.map&&(r.spotLightMap[y]=e.map,y++,s.updateMatrices(e),e.castShadow&&v++),r.spotLightMatrix[d]=s.matrix,e.castShadow){const t=n.get(e);t.shadowBias=s.bias,t.shadowNormalBias=s.normalBias,t.shadowRadius=s.radius,t.shadowMapSize=s.mapSize,r.spotShadow[d]=t,r.spotShadowMap[d]=T,_++}d++}else if(e.isRectAreaLight){const t=i.get(e);t.color.copy(o).multiplyScalar(w),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[p]=t,p++}else if(e.isPointLight){const t=i.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*b),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,i=n.get(e);i.shadowBias=t.bias,i.shadowNormalBias=t.normalBias,i.shadowRadius=t.radius,i.shadowMapSize=t.mapSize,i.shadowCameraNear=t.camera.near,i.shadowCameraFar=t.camera.far,r.pointShadow[u]=i,r.pointShadowMap[u]=T,r.pointShadowMatrix[u]=e.shadow.matrix,g++}r.point[u]=t,u++}else if(e.isHemisphereLight){const t=i.get(e);t.skyColor.copy(e.color).multiplyScalar(w*b),t.groundColor.copy(e.groundColor).multiplyScalar(w*b),r.hemi[f]=t,f++}}p>0&&(e.isWebGL2?!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=eT.LTC_FLOAT_1,r.rectAreaLTC2=eT.LTC_FLOAT_2):(r.rectAreaLTC1=eT.LTC_HALF_1,r.rectAreaLTC2=eT.LTC_HALF_2):!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=eT.LTC_FLOAT_1,r.rectAreaLTC2=eT.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")&&(r.rectAreaLTC1=eT.LTC_HALF_1,r.rectAreaLTC2=eT.LTC_HALF_2)),r.ambient[0]=a,r.ambient[1]=l,r.ambient[2]=c;const w=r.hash;w.directionalLength===h&&w.pointLength===u&&w.spotLength===d&&w.rectAreaLength===p&&w.hemiLength===f&&w.numDirectionalShadows===m&&w.numPointShadows===g&&w.numSpotShadows===_&&w.numSpotMaps===y&&w.numLightProbes===x||(r.directional.length=h,r.spot.length=d,r.rectArea.length=p,r.point.length=u,r.hemi.length=f,r.directionalShadow.length=m,r.directionalShadowMap.length=m,r.pointShadow.length=g,r.pointShadowMap.length=g,r.spotShadow.length=_,r.spotShadowMap.length=_,r.directionalShadowMatrix.length=m,r.pointShadowMatrix.length=g,r.spotLightMatrix.length=_+y-v,r.spotLightMap.length=y,r.numSpotLightShadowsWithMaps=v,r.numLightProbes=x,w.directionalLength=h,w.pointLength=u,w.spotLength=d,w.rectAreaLength=p,w.hemiLength=f,w.numDirectionalShadows=m,w.numPointShadows=g,w.numSpotShadows=_,w.numSpotMaps=y,w.numLightProbes=x,r.version=gS++)},setupView:function(t,e){let i=0,n=0,l=0,c=0,h=0;const u=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=r.directional[i];t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),i++}else if(d.isSpotLight){const t=r.spot[l];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const t=r.rectArea[c];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),a.identity(),o.copy(d.matrixWorld),o.premultiply(u),a.extractRotation(o),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(a),t.halfHeight.applyMatrix4(a),c++}else if(d.isPointLight){const t=r.point[n];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(u),n++}else if(d.isHemisphereLight){const t=r.hemi[h];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(u),h++}}},state:r}}function vS(t,e){const i=new yS(t,e),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(t){i.setup(n,t)},setupLightsView:function(t){i.setupView(n,t)},pushLight:function(t){n.push(t)},pushShadow:function(t){r.push(t)}}}function xS(t,e){let i=new WeakMap;return{get:function(n,r=0){const s=i.get(n);let o;return void 0===s?(o=new vS(t,e),i.set(n,[o])):r>=s.length?(o=new vS(t,e),s.push(o)):o=s[r],o},dispose:function(){i=new WeakMap}}}class bS extends jw{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class wS extends jw{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}function AS(t,e,i){let n=new YA;const r=new Xx,s=new Xx,o=new _b,a=new bS({depthPacking:3201}),l=new wS,c={},h=i.maxTextureSize,u={[zy]:Ny,[Ny]:zy,2:2},d=new DA({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Xx},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const f=new cA;f.setAttribute("position",new Kw(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const m=new EA(f,d),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=Oy;let _=this.type;function y(i,n){const s=e.update(m);d.defines.VSM_SAMPLES!==i.blurSamples&&(d.defines.VSM_SAMPLES=i.blurSamples,p.defines.VSM_SAMPLES=i.blurSamples,d.needsUpdate=!0,p.needsUpdate=!0),null===i.mapPass&&(i.mapPass=new vb(r.x,r.y)),d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,t.setRenderTarget(i.mapPass),t.clear(),t.renderBufferDirect(n,null,s,d,m,null),p.uniforms.shadow_pass.value=i.mapPass.texture,p.uniforms.resolution.value=i.mapSize,p.uniforms.radius.value=i.radius,t.setRenderTarget(i.map),t.clear(),t.renderBufferDirect(n,null,s,p,m,null)}function v(e,i,n,r){let s=null;const o=!0===n.isPointLight?e.customDistanceMaterial:e.customDepthMaterial;if(void 0!==o)s=o;else if(s=!0===n.isPointLight?l:a,t.localClippingEnabled&&!0===i.clipShadows&&Array.isArray(i.clippingPlanes)&&0!==i.clippingPlanes.length||i.displacementMap&&0!==i.displacementScale||i.alphaMap&&i.alphaTest>0||i.map&&i.alphaTest>0){const t=s.uuid,e=i.uuid;let n=c[t];void 0===n&&(n={},c[t]=n);let r=n[e];void 0===r&&(r=s.clone(),n[e]=r,i.addEventListener("dispose",b)),s=r}if(s.visible=i.visible,s.wireframe=i.wireframe,s.side=r===Fy?null!==i.shadowSide?i.shadowSide:i.side:null!==i.shadowSide?i.shadowSide:u[i.side],s.alphaMap=i.alphaMap,s.alphaTest=i.alphaTest,s.map=i.map,s.clipShadows=i.clipShadows,s.clippingPlanes=i.clippingPlanes,s.clipIntersection=i.clipIntersection,s.displacementMap=i.displacementMap,s.displacementScale=i.displacementScale,s.displacementBias=i.displacementBias,s.wireframeLinewidth=i.wireframeLinewidth,s.linewidth=i.linewidth,!0===n.isPointLight&&!0===s.isMeshDistanceMaterial){t.properties.get(s).light=n}return s}function x(i,r,s,o,a){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&a===Fy)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=e.update(i),l=i.material;if(Array.isArray(l)){const e=n.groups;for(let c=0,h=e.length;c<h;c++){const h=e[c],u=l[h.materialIndex];if(u&&u.visible){const e=v(i,u,o,a);i.onBeforeShadow(t,i,r,s,n,e,h),t.renderBufferDirect(s,null,n,e,i,h),i.onAfterShadow(t,i,r,s,n,e,h)}}}else if(l.visible){const e=v(i,l,o,a);i.onBeforeShadow(t,i,r,s,n,e,null),t.renderBufferDirect(s,null,n,e,i,null),i.onAfterShadow(t,i,r,s,n,e,null)}}const l=i.children;for(let t=0,e=l.length;t<e;t++)x(l[t],r,s,o,a)}function b(t){t.target.removeEventListener("dispose",b);for(const e in c){const i=c[e],n=t.target.uuid;if(n in i){i[n].dispose(),delete i[n]}}}this.render=function(e,i,a){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===e.length)return;const l=t.getRenderTarget(),c=t.getActiveCubeFace(),u=t.getActiveMipmapLevel(),d=t.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=_!==Fy&&this.type===Fy,f=_===Fy&&this.type!==Fy;for(let l=0,c=e.length;l<c;l++){const c=e[l],u=c.shadow;if(void 0===u)continue;if(!1===u.autoUpdate&&!1===u.needsUpdate)continue;r.copy(u.mapSize);const m=u.getFrameExtents();if(r.multiply(m),s.copy(u.mapSize),(r.x>h||r.y>h)&&(r.x>h&&(s.x=Math.floor(h/m.x),r.x=s.x*m.x,u.mapSize.x=s.x),r.y>h&&(s.y=Math.floor(h/m.y),r.y=s.y*m.y,u.mapSize.y=s.y)),null===u.map||!0===p||!0===f){const t=this.type!==Fy?{minFilter:hv,magFilter:hv}:{};null!==u.map&&u.map.dispose(),u.map=new vb(r.x,r.y,t),u.map.texture.name=c.name+".shadowMap",u.camera.updateProjectionMatrix()}t.setRenderTarget(u.map),t.clear();const g=u.getViewportCount();for(let t=0;t<g;t++){const e=u.getViewport(t);o.set(s.x*e.x,s.y*e.y,s.x*e.z,s.y*e.w),d.viewport(o),u.updateMatrices(c,t),n=u.getFrustum(),x(i,a,u.camera,c,this.type)}!0!==u.isPointLightShadow&&this.type===Fy&&y(u,a),u.needsUpdate=!1}_=this.type,g.needsUpdate=!1,t.setRenderTarget(l,c,u)}}function TS(t,e,i){const n=i.isWebGL2;const r=new function(){let e=!1;const i=new _b;let n=null;const r=new _b(0,0,0,0);return{setMask:function(i){n===i||e||(t.colorMask(i,i,i,i),n=i)},setLocked:function(t){e=t},setClear:function(e,n,s,o,a){!0===a&&(e*=o,n*=o,s*=o),i.set(e,n,s,o),!1===r.equals(i)&&(t.clearColor(e,n,s,o),r.copy(i))},reset:function(){e=!1,n=null,r.set(-1,0,0,0)}}},s=new function(){let e=!1,i=null,n=null,r=null;return{setTest:function(e){e?V(t.DEPTH_TEST):j(t.DEPTH_TEST)},setMask:function(n){i===n||e||(t.depthMask(n),i=n)},setFunc:function(e){if(n!==e){switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:default:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL)}n=e}},setLocked:function(t){e=t},setClear:function(e){r!==e&&(t.clearDepth(e),r=e)},reset:function(){e=!1,i=null,n=null,r=null}}},o=new function(){let e=!1,i=null,n=null,r=null,s=null,o=null,a=null,l=null,c=null;return{setTest:function(i){e||(i?V(t.STENCIL_TEST):j(t.STENCIL_TEST))},setMask:function(n){i===n||e||(t.stencilMask(n),i=n)},setFunc:function(e,i,o){n===e&&r===i&&s===o||(t.stencilFunc(e,i,o),n=e,r=i,s=o)},setOp:function(e,i,n){o===e&&a===i&&l===n||(t.stencilOp(e,i,n),o=e,a=i,l=n)},setLocked:function(t){e=t},setClear:function(e){c!==e&&(t.clearStencil(e),c=e)},reset:function(){e=!1,i=null,n=null,r=null,s=null,o=null,a=null,l=null,c=null}}},a=new WeakMap,l=new WeakMap;let c={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,_=null,y=null,v=null,x=null,b=null,w=new Uw(0,0,0),A=0,T=!1,M=null,S=null,E=null,C=null,I=null;const P=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let L=!1,R=0;const B=t.getParameter(t.VERSION);-1!==B.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(B)[1]),L=R>=1):-1!==B.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(B)[1]),L=R>=2);let D=null,O={};const k=t.getParameter(t.SCISSOR_BOX),F=t.getParameter(t.VIEWPORT),z=(new _b).fromArray(k),N=(new _b).fromArray(F);function U(e,i,r,s){const o=new Uint8Array(4),a=t.createTexture();t.bindTexture(e,a),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let a=0;a<r;a++)!n||e!==t.TEXTURE_3D&&e!==t.TEXTURE_2D_ARRAY?t.texImage2D(i+a,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,o):t.texImage3D(i,0,t.RGBA,1,1,s,0,t.RGBA,t.UNSIGNED_BYTE,o);return a}const G={};function V(e){!0!==c[e]&&(t.enable(e),c[e]=!0)}function j(e){!1!==c[e]&&(t.disable(e),c[e]=!1)}G[t.TEXTURE_2D]=U(t.TEXTURE_2D,t.TEXTURE_2D,1),G[t.TEXTURE_CUBE_MAP]=U(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),n&&(G[t.TEXTURE_2D_ARRAY]=U(t.TEXTURE_2D_ARRAY,t.TEXTURE_2D_ARRAY,1,1),G[t.TEXTURE_3D]=U(t.TEXTURE_3D,t.TEXTURE_3D,1,1)),r.setClear(0,0,0,1),s.setClear(1),o.setClear(0),V(t.DEPTH_TEST),s.setFunc(3),X(!1),Z(1),V(t.CULL_FACE),q(0);const H={[Uy]:t.FUNC_ADD,101:t.FUNC_SUBTRACT,102:t.FUNC_REVERSE_SUBTRACT};if(n)H[103]=t.MIN,H[104]=t.MAX;else{const t=e.get("EXT_blend_minmax");null!==t&&(H[103]=t.MIN_EXT,H[104]=t.MAX_EXT)}const W={200:t.ZERO,201:t.ONE,202:t.SRC_COLOR,[Gy]:t.SRC_ALPHA,210:t.SRC_ALPHA_SATURATE,208:t.DST_COLOR,206:t.DST_ALPHA,203:t.ONE_MINUS_SRC_COLOR,[Vy]:t.ONE_MINUS_SRC_ALPHA,209:t.ONE_MINUS_DST_COLOR,207:t.ONE_MINUS_DST_ALPHA,211:t.CONSTANT_COLOR,212:t.ONE_MINUS_CONSTANT_COLOR,213:t.CONSTANT_ALPHA,214:t.ONE_MINUS_CONSTANT_ALPHA};function q(e,i,n,r,s,o,a,l,c,h){if(0!==e){if(!1===f&&(V(t.BLEND),f=!0),5===e)s=s||i,o=o||n,a=a||r,i===g&&s===v||(t.blendEquationSeparate(H[i],H[s]),g=i,v=s),n===_&&r===y&&o===x&&a===b||(t.blendFuncSeparate(W[n],W[r],W[o],W[a]),_=n,y=r,x=o,b=a),!1!==l.equals(w)&&c===A||(t.blendColor(l.r,l.g,l.b,c),w.copy(l),A=c),m=e,T=!1;else if(e!==m||h!==T){if(g===Uy&&v===Uy||(t.blendEquation(t.FUNC_ADD),g=Uy,v=Uy),h)switch(e){case 1:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.ONE,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case 4:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA)}else switch(e){case 1:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case 2:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case 3:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case 4:t.blendFunc(t.ZERO,t.SRC_COLOR)}_=null,y=null,x=null,b=null,w.set(0,0,0),A=0,m=e,T=h}}else!0===f&&(j(t.BLEND),f=!1)}function X(e){M!==e&&(t.frontFace(e?t.CW:t.CCW),M=e)}function Z(e){0!==e?(V(t.CULL_FACE),e!==S&&t.cullFace(1===e?t.BACK:2===e?t.FRONT:t.FRONT_AND_BACK)):j(t.CULL_FACE),S=e}function J(e,i,n){e?(V(t.POLYGON_OFFSET_FILL),C===i&&I===n||(t.polygonOffset(i,n),C=i,I=n)):j(t.POLYGON_OFFSET_FILL)}return{buffers:{color:r,depth:s,stencil:o},enable:V,disable:j,bindFramebuffer:function(e,i){return h[e]!==i&&(t.bindFramebuffer(e,i),h[e]=i,n&&(e===t.DRAW_FRAMEBUFFER&&(h[t.FRAMEBUFFER]=i),e===t.FRAMEBUFFER&&(h[t.DRAW_FRAMEBUFFER]=i)),!0)},drawBuffers:function(n,r){let s=d,o=!1;if(n)if(s=u.get(r),void 0===s&&(s=[],u.set(r,s)),n.isWebGLMultipleRenderTargets){const e=n.texture;if(s.length!==e.length||s[0]!==t.COLOR_ATTACHMENT0){for(let i=0,n=e.length;i<n;i++)s[i]=t.COLOR_ATTACHMENT0+i;s.length=e.length,o=!0}}else s[0]!==t.COLOR_ATTACHMENT0&&(s[0]=t.COLOR_ATTACHMENT0,o=!0);else s[0]!==t.BACK&&(s[0]=t.BACK,o=!0);o&&(i.isWebGL2?t.drawBuffers(s):e.get("WEBGL_draw_buffers").drawBuffersWEBGL(s))},useProgram:function(e){return p!==e&&(t.useProgram(e),p=e,!0)},setBlending:q,setMaterial:function(e,i){2===e.side?j(t.CULL_FACE):V(t.CULL_FACE);let n=e.side===Ny;i&&(n=!n),X(n),1===e.blending&&!1===e.transparent?q(0):q(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.blendColor,e.blendAlpha,e.premultipliedAlpha),s.setFunc(e.depthFunc),s.setTest(e.depthTest),s.setMask(e.depthWrite),r.setMask(e.colorWrite);const a=e.stencilWrite;o.setTest(a),a&&(o.setMask(e.stencilWriteMask),o.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),o.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),J(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?V(t.SAMPLE_ALPHA_TO_COVERAGE):j(t.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:X,setCullFace:Z,setLineWidth:function(e){e!==E&&(L&&t.lineWidth(e),E=e)},setPolygonOffset:J,setScissorTest:function(e){e?V(t.SCISSOR_TEST):j(t.SCISSOR_TEST)},activeTexture:function(e){void 0===e&&(e=t.TEXTURE0+P-1),D!==e&&(t.activeTexture(e),D=e)},bindTexture:function(e,i,n){void 0===n&&(n=null===D?t.TEXTURE0+P-1:D);let r=O[n];void 0===r&&(r={type:void 0,texture:void 0},O[n]=r),r.type===e&&r.texture===i||(D!==n&&(t.activeTexture(n),D=n),t.bindTexture(e,i||G[e]),r.type=e,r.texture=i)},unbindTexture:function(){const e=O[D];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){}},compressedTexImage3D:function(){try{t.compressedTexImage3D.apply(t,arguments)}catch(t){}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){}},updateUBOMapping:function(e,i){let n=l.get(i);void 0===n&&(n=new WeakMap,l.set(i,n));let r=n.get(e);void 0===r&&(r=t.getUniformBlockIndex(i,e.name),n.set(e,r))},uniformBlockBinding:function(e,i){const n=l.get(i).get(e);a.get(i)!==n&&(t.uniformBlockBinding(i,n,e.__bindingPointIndex),a.set(i,n))},texStorage2D:function(){try{t.texStorage2D.apply(t,arguments)}catch(t){}},texStorage3D:function(){try{t.texStorage3D.apply(t,arguments)}catch(t){}},texSubImage2D:function(){try{t.texSubImage2D.apply(t,arguments)}catch(t){}},texSubImage3D:function(){try{t.texSubImage3D.apply(t,arguments)}catch(t){}},compressedTexSubImage2D:function(){try{t.compressedTexSubImage2D.apply(t,arguments)}catch(t){}},compressedTexSubImage3D:function(){try{t.compressedTexSubImage3D.apply(t,arguments)}catch(t){}},scissor:function(e){!1===z.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),z.copy(e))},viewport:function(e){!1===N.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),N.copy(e))},reset:function(){t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.blendColor(0,0,0,0),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.activeTexture(t.TEXTURE0),t.bindFramebuffer(t.FRAMEBUFFER,null),!0===n&&(t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.bindFramebuffer(t.READ_FRAMEBUFFER,null)),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),c={},D=null,O={},h={},u=new WeakMap,d=[],p=null,f=!1,m=null,g=null,_=null,y=null,v=null,x=null,b=null,w=new Uw(0,0,0),A=0,T=!1,M=null,S=null,E=null,C=null,I=null,z.set(0,0,t.canvas.width,t.canvas.height),N.set(0,0,t.canvas.width,t.canvas.height),r.reset(),s.reset(),o.reset()}}}function MS(t,e,i,n,r,s,o){const a=r.isWebGL2,l=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,c="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),h=new WeakMap;let u;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function f(t,e){return p?new OffscreenCanvas(t,e):Qx("canvas")}function m(t,e,i,n){let r=1;if((t.width>n||t.height>n)&&(r=n/Math.max(t.width,t.height)),r<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const n=e?jx:Math.floor,s=n(r*t.width),o=n(r*t.height);void 0===u&&(u=f(s,o));const a=i?f(s,o):u;a.width=s,a.height=o;return a.getContext("2d").drawImage(t,0,0,s,o),a}return t}return t}function g(t){return Vx(t.width)&&Vx(t.height)}function _(t,e){return t.generateMipmaps&&e&&t.minFilter!==hv&&t.minFilter!==pv}function y(e){t.generateMipmap(e)}function v(i,n,r,s,o=!1){if(!1===a)return n;if(null!==i&&void 0!==t[i])return t[i];let l=n;if(n===t.RED&&(r===t.FLOAT&&(l=t.R32F),r===t.HALF_FLOAT&&(l=t.R16F),r===t.UNSIGNED_BYTE&&(l=t.R8)),n===t.RED_INTEGER&&(r===t.UNSIGNED_BYTE&&(l=t.R8UI),r===t.UNSIGNED_SHORT&&(l=t.R16UI),r===t.UNSIGNED_INT&&(l=t.R32UI),r===t.BYTE&&(l=t.R8I),r===t.SHORT&&(l=t.R16I),r===t.INT&&(l=t.R32I)),n===t.RG&&(r===t.FLOAT&&(l=t.RG32F),r===t.HALF_FLOAT&&(l=t.RG16F),r===t.UNSIGNED_BYTE&&(l=t.RG8)),n===t.RGBA){const e=o?Ax:ab.getTransfer(s);r===t.FLOAT&&(l=t.RGBA32F),r===t.HALF_FLOAT&&(l=t.RGBA16F),r===t.UNSIGNED_BYTE&&(l=e===Tx?t.SRGB8_ALPHA8:t.RGBA8),r===t.UNSIGNED_SHORT_4_4_4_4&&(l=t.RGBA4),r===t.UNSIGNED_SHORT_5_5_5_1&&(l=t.RGB5_A1)}return l!==t.R16F&&l!==t.R32F&&l!==t.RG16F&&l!==t.RG32F&&l!==t.RGBA16F&&l!==t.RGBA32F||e.get("EXT_color_buffer_float"),l}function x(t,e,i){return!0===_(t,i)||t.isFramebufferTexture&&t.minFilter!==hv&&t.minFilter!==pv?Math.log2(Math.max(e.width,e.height))+1:void 0!==t.mipmaps&&t.mipmaps.length>0?t.mipmaps.length:t.isCompressedTexture&&Array.isArray(t.image)?e.mipmaps.length:1}function b(e){return e===hv||e===uv||e===dv?t.NEAREST:t.LINEAR}function w(t){const e=t.target;e.removeEventListener("dispose",w),function(t){const e=n.get(t);if(void 0===e.__webglInit)return;const i=t.source,r=d.get(i);if(r){const n=r[e.__cacheKey];n.usedTimes--,0===n.usedTimes&&T(t),0===Object.keys(r).length&&d.delete(i)}n.remove(t)}(e),e.isVideoTexture&&h.delete(e)}function A(e){const i=e.target;i.removeEventListener("dispose",A),function(e){const i=e.texture,r=n.get(e),s=n.get(i);void 0!==s.__webglTexture&&(t.deleteTexture(s.__webglTexture),o.memory.textures--);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++){if(Array.isArray(r.__webglFramebuffer[e]))for(let i=0;i<r.__webglFramebuffer[e].length;i++)t.deleteFramebuffer(r.__webglFramebuffer[e][i]);else t.deleteFramebuffer(r.__webglFramebuffer[e]);r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer[e])}else{if(Array.isArray(r.__webglFramebuffer))for(let e=0;e<r.__webglFramebuffer.length;e++)t.deleteFramebuffer(r.__webglFramebuffer[e]);else t.deleteFramebuffer(r.__webglFramebuffer);if(r.__webglDepthbuffer&&t.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&t.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let e=0;e<r.__webglColorRenderbuffer.length;e++)r.__webglColorRenderbuffer[e]&&t.deleteRenderbuffer(r.__webglColorRenderbuffer[e]);r.__webglDepthRenderbuffer&&t.deleteRenderbuffer(r.__webglDepthRenderbuffer)}if(e.isWebGLMultipleRenderTargets)for(let e=0,r=i.length;e<r;e++){const r=n.get(i[e]);r.__webglTexture&&(t.deleteTexture(r.__webglTexture),o.memory.textures--),n.remove(i[e])}n.remove(i),n.remove(e)}(i)}function T(e){const i=n.get(e);t.deleteTexture(i.__webglTexture);delete d.get(e.source)[i.__cacheKey],o.memory.textures--}let M=0;function S(e,r){const s=n.get(e);if(e.isVideoTexture&&function(t){const e=o.render.frame;h.get(t)!==e&&(h.set(t,e),t.update())}(e),!1===e.isRenderTargetTexture&&e.version>0&&s.__version!==e.version){const t=e.image;if(null===t);else if(!1!==t.complete)return void R(s,e,r)}i.bindTexture(t.TEXTURE_2D,s.__webglTexture,t.TEXTURE0+r)}const E={[av]:t.REPEAT,[lv]:t.CLAMP_TO_EDGE,[cv]:t.MIRRORED_REPEAT},C={[hv]:t.NEAREST,[uv]:t.NEAREST_MIPMAP_NEAREST,[dv]:t.NEAREST_MIPMAP_LINEAR,[pv]:t.LINEAR,[fv]:t.LINEAR_MIPMAP_NEAREST,[mv]:t.LINEAR_MIPMAP_LINEAR},I={512:t.NEVER,519:t.ALWAYS,513:t.LESS,515:t.LEQUAL,514:t.EQUAL,518:t.GEQUAL,516:t.GREATER,517:t.NOTEQUAL};function P(i,s,o){if(s.type===xv&&e.has("OES_texture_float_linear"),o?(t.texParameteri(i,t.TEXTURE_WRAP_S,E[s.wrapS]),t.texParameteri(i,t.TEXTURE_WRAP_T,E[s.wrapT]),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,E[s.wrapR]),t.texParameteri(i,t.TEXTURE_MAG_FILTER,C[s.magFilter]),t.texParameteri(i,t.TEXTURE_MIN_FILTER,C[s.minFilter])):(t.texParameteri(i,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i!==t.TEXTURE_3D&&i!==t.TEXTURE_2D_ARRAY||t.texParameteri(i,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_MAG_FILTER,b(s.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,b(s.minFilter))),s.compareFunction&&(t.texParameteri(i,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(i,t.TEXTURE_COMPARE_FUNC,I[s.compareFunction])),!0===e.has("EXT_texture_filter_anisotropic")){const o=e.get("EXT_texture_filter_anisotropic");if(s.magFilter===hv)return;if(s.minFilter!==dv&&s.minFilter!==mv)return;if(s.type===xv&&!1===e.has("OES_texture_float_linear"))return;if(!1===a&&s.type===bv&&!1===e.has("OES_texture_half_float_linear"))return;(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(t.texParameterf(i,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function L(e,i){let n=!1;void 0===e.__webglInit&&(e.__webglInit=!0,i.addEventListener("dispose",w));const r=i.source;let s=d.get(r);void 0===s&&(s={},d.set(r,s));const a=function(t){const e=[];return e.push(t.wrapS),e.push(t.wrapT),e.push(t.wrapR||0),e.push(t.magFilter),e.push(t.minFilter),e.push(t.anisotropy),e.push(t.internalFormat),e.push(t.format),e.push(t.type),e.push(t.generateMipmaps),e.push(t.premultiplyAlpha),e.push(t.flipY),e.push(t.unpackAlignment),e.push(t.colorSpace),e.join()}(i);if(a!==e.__cacheKey){void 0===s[a]&&(s[a]={texture:t.createTexture(),usedTimes:0},o.memory.textures++,n=!0),s[a].usedTimes++;const r=s[e.__cacheKey];void 0!==r&&(s[e.__cacheKey].usedTimes--,0===r.usedTimes&&T(i)),e.__cacheKey=a,e.__webglTexture=s[a].texture}return n}function R(e,o,l){let c=t.TEXTURE_2D;(o.isDataArrayTexture||o.isCompressedArrayTexture)&&(c=t.TEXTURE_2D_ARRAY),o.isData3DTexture&&(c=t.TEXTURE_3D);const h=L(e,o),u=o.source;i.bindTexture(c,e.__webglTexture,t.TEXTURE0+l);const d=n.get(u);if(u.version!==d.__version||!0===h){i.activeTexture(t.TEXTURE0+l);const e=ab.getPrimaries(ab.workingColorSpace),n=o.colorSpace===yx?null:ab.getPrimaries(o.colorSpace),p=o.colorSpace===yx||e===n?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,o.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,p);const f=function(t){return!a&&(t.wrapS!==lv||t.wrapT!==lv||t.minFilter!==hv&&t.minFilter!==pv)}(o)&&!1===g(o.image);let b=m(o.image,f,!1,r.maxTextureSize);b=z(o,b);const w=g(b)||a,A=s.convert(o.format,o.colorSpace);let T,M=s.convert(o.type),S=v(o.internalFormat,A,M,o.colorSpace,o.isVideoTexture);P(c,o,w);const E=o.mipmaps,C=a&&!0!==o.isVideoTexture&&S!==Nv,I=void 0===d.__version||!0===h,L=u.dataReady,R=x(o,b,w);if(o.isDepthTexture)S=t.DEPTH_COMPONENT,a&&(S=o.type===xv?t.DEPTH_COMPONENT32F:o.type===vv?t.DEPTH_COMPONENT24:o.type===Tv?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT16),o.format===Sv&&S===t.DEPTH_COMPONENT&&o.type!==_v&&o.type!==vv&&(o.type=vv,M=s.convert(o.type)),o.format===Ev&&S===t.DEPTH_COMPONENT&&(S=t.DEPTH_STENCIL,o.type!==Tv&&(o.type=Tv,M=s.convert(o.type))),I&&(C?i.texStorage2D(t.TEXTURE_2D,1,S,b.width,b.height):i.texImage2D(t.TEXTURE_2D,0,S,b.width,b.height,0,A,M,null));else if(o.isDataTexture)if(E.length>0&&w){C&&I&&i.texStorage2D(t.TEXTURE_2D,R,S,E[0].width,E[0].height);for(let e=0,n=E.length;e<n;e++)T=E[e],C?L&&i.texSubImage2D(t.TEXTURE_2D,e,0,0,T.width,T.height,A,M,T.data):i.texImage2D(t.TEXTURE_2D,e,S,T.width,T.height,0,A,M,T.data);o.generateMipmaps=!1}else C?(I&&i.texStorage2D(t.TEXTURE_2D,R,S,b.width,b.height),L&&i.texSubImage2D(t.TEXTURE_2D,0,0,0,b.width,b.height,A,M,b.data)):i.texImage2D(t.TEXTURE_2D,0,S,b.width,b.height,0,A,M,b.data);else if(o.isCompressedTexture)if(o.isCompressedArrayTexture){C&&I&&i.texStorage3D(t.TEXTURE_2D_ARRAY,R,S,E[0].width,E[0].height,b.depth);for(let e=0,n=E.length;e<n;e++)T=E[e],o.format!==Mv?null!==A&&(C?L&&i.compressedTexSubImage3D(t.TEXTURE_2D_ARRAY,e,0,0,0,T.width,T.height,b.depth,A,T.data,0,0):i.compressedTexImage3D(t.TEXTURE_2D_ARRAY,e,S,T.width,T.height,b.depth,0,T.data,0,0)):C?L&&i.texSubImage3D(t.TEXTURE_2D_ARRAY,e,0,0,0,T.width,T.height,b.depth,A,M,T.data):i.texImage3D(t.TEXTURE_2D_ARRAY,e,S,T.width,T.height,b.depth,0,A,M,T.data)}else{C&&I&&i.texStorage2D(t.TEXTURE_2D,R,S,E[0].width,E[0].height);for(let e=0,n=E.length;e<n;e++)T=E[e],o.format!==Mv?null!==A&&(C?L&&i.compressedTexSubImage2D(t.TEXTURE_2D,e,0,0,T.width,T.height,A,T.data):i.compressedTexImage2D(t.TEXTURE_2D,e,S,T.width,T.height,0,T.data)):C?L&&i.texSubImage2D(t.TEXTURE_2D,e,0,0,T.width,T.height,A,M,T.data):i.texImage2D(t.TEXTURE_2D,e,S,T.width,T.height,0,A,M,T.data)}else if(o.isDataArrayTexture)C?(I&&i.texStorage3D(t.TEXTURE_2D_ARRAY,R,S,b.width,b.height,b.depth),L&&i.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,0,b.width,b.height,b.depth,A,M,b.data)):i.texImage3D(t.TEXTURE_2D_ARRAY,0,S,b.width,b.height,b.depth,0,A,M,b.data);else if(o.isData3DTexture)C?(I&&i.texStorage3D(t.TEXTURE_3D,R,S,b.width,b.height,b.depth),L&&i.texSubImage3D(t.TEXTURE_3D,0,0,0,0,b.width,b.height,b.depth,A,M,b.data)):i.texImage3D(t.TEXTURE_3D,0,S,b.width,b.height,b.depth,0,A,M,b.data);else if(o.isFramebufferTexture){if(I)if(C)i.texStorage2D(t.TEXTURE_2D,R,S,b.width,b.height);else{let e=b.width,n=b.height;for(let r=0;r<R;r++)i.texImage2D(t.TEXTURE_2D,r,S,e,n,0,A,M,null),e>>=1,n>>=1}}else if(E.length>0&&w){C&&I&&i.texStorage2D(t.TEXTURE_2D,R,S,E[0].width,E[0].height);for(let e=0,n=E.length;e<n;e++)T=E[e],C?L&&i.texSubImage2D(t.TEXTURE_2D,e,0,0,A,M,T):i.texImage2D(t.TEXTURE_2D,e,S,A,M,T);o.generateMipmaps=!1}else C?(I&&i.texStorage2D(t.TEXTURE_2D,R,S,b.width,b.height),L&&i.texSubImage2D(t.TEXTURE_2D,0,0,0,A,M,b)):i.texImage2D(t.TEXTURE_2D,0,S,A,M,b);_(o,w)&&y(c),d.__version=u.version,o.onUpdate&&o.onUpdate(o)}e.__version=o.version}function B(e,r,o,a,c,h){const u=s.convert(o.format,o.colorSpace),d=s.convert(o.type),p=v(o.internalFormat,u,d,o.colorSpace);if(!n.get(r).__hasExternalTextures){const e=Math.max(1,r.width>>h),n=Math.max(1,r.height>>h);c===t.TEXTURE_3D||c===t.TEXTURE_2D_ARRAY?i.texImage3D(c,h,p,e,n,r.depth,0,u,d,null):i.texImage2D(c,h,p,e,n,0,u,d,null)}i.bindFramebuffer(t.FRAMEBUFFER,e),F(r)?l.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,a,c,n.get(o).__webglTexture,0,k(r)):(c===t.TEXTURE_2D||c>=t.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=t.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&t.framebufferTexture2D(t.FRAMEBUFFER,a,c,n.get(o).__webglTexture,h),i.bindFramebuffer(t.FRAMEBUFFER,null)}function D(e,i,n){if(t.bindRenderbuffer(t.RENDERBUFFER,e),i.depthBuffer&&!i.stencilBuffer){let r=!0===a?t.DEPTH_COMPONENT24:t.DEPTH_COMPONENT16;if(n||F(i)){const e=i.depthTexture;e&&e.isDepthTexture&&(e.type===xv?r=t.DEPTH_COMPONENT32F:e.type===vv&&(r=t.DEPTH_COMPONENT24));const n=k(i);F(i)?l.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,n,r,i.width,i.height):t.renderbufferStorageMultisample(t.RENDERBUFFER,n,r,i.width,i.height)}else t.renderbufferStorage(t.RENDERBUFFER,r,i.width,i.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}else if(i.depthBuffer&&i.stencilBuffer){const r=k(i);n&&!1===F(i)?t.renderbufferStorageMultisample(t.RENDERBUFFER,r,t.DEPTH24_STENCIL8,i.width,i.height):F(i)?l.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,r,t.DEPTH24_STENCIL8,i.width,i.height):t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)}else{const e=!0===i.isWebGLMultipleRenderTargets?i.texture:[i.texture];for(let r=0;r<e.length;r++){const o=e[r],a=s.convert(o.format,o.colorSpace),c=s.convert(o.type),h=v(o.internalFormat,a,c,o.colorSpace),u=k(i);n&&!1===F(i)?t.renderbufferStorageMultisample(t.RENDERBUFFER,u,h,i.width,i.height):F(i)?l.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,u,h,i.width,i.height):t.renderbufferStorage(t.RENDERBUFFER,h,i.width,i.height)}}t.bindRenderbuffer(t.RENDERBUFFER,null)}function O(e){const r=n.get(e),s=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture&&!r.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(t.FRAMEBUFFER,e),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),S(r.depthTexture,0);const s=n.get(r.depthTexture).__webglTexture,o=k(r);if(r.depthTexture.format===Sv)F(r)?l.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,s,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,s,0);else{if(r.depthTexture.format!==Ev)throw new Error("Unknown depthTexture format");F(r)?l.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,s,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,s,0)}}(r.__webglFramebuffer,e)}else if(s){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer[n]),r.__webglDepthbuffer[n]=t.createRenderbuffer(),D(r.__webglDepthbuffer[n],e,!1)}else i.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=t.createRenderbuffer(),D(r.__webglDepthbuffer,e,!1);i.bindFramebuffer(t.FRAMEBUFFER,null)}function k(t){return Math.min(r.maxSamples,t.samples)}function F(t){const i=n.get(t);return a&&t.samples>0&&!0===e.has("WEBGL_multisampled_render_to_texture")&&!1!==i.__useRenderToTexture}function z(t,i){const n=t.colorSpace,r=t.format;return!0===t.isCompressedTexture||!0===t.isVideoTexture||t.format===Px||n!==xx&&n!==yx&&ab.getTransfer(n)===Tx&&!1===a&&(!0===e.has("EXT_sRGB")&&r===Mv?(t.format=Px,t.minFilter=pv,t.generateMipmaps=!1):i=ub.sRGBToLinear(i)),i}this.allocateTextureUnit=function(){const t=M;return M+=1,t},this.resetTextureUnits=function(){M=0},this.setTexture2D=S,this.setTexture2DArray=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?R(s,e,r):i.bindTexture(t.TEXTURE_2D_ARRAY,s.__webglTexture,t.TEXTURE0+r)},this.setTexture3D=function(e,r){const s=n.get(e);e.version>0&&s.__version!==e.version?R(s,e,r):i.bindTexture(t.TEXTURE_3D,s.__webglTexture,t.TEXTURE0+r)},this.setTextureCube=function(e,o){const l=n.get(e);e.version>0&&l.__version!==e.version?function(e,o,l){if(6!==o.image.length)return;const c=L(e,o),h=o.source;i.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture,t.TEXTURE0+l);const u=n.get(h);if(h.version!==u.__version||!0===c){i.activeTexture(t.TEXTURE0+l);const e=ab.getPrimaries(ab.workingColorSpace),n=o.colorSpace===yx?null:ab.getPrimaries(o.colorSpace),d=o.colorSpace===yx||e===n?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,o.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);const p=o.isCompressedTexture||o.image[0].isCompressedTexture,f=o.image[0]&&o.image[0].isDataTexture,b=[];for(let t=0;t<6;t++)b[t]=p||f?f?o.image[t].image:o.image[t]:m(o.image[t],!1,!0,r.maxCubemapSize),b[t]=z(o,b[t]);const w=b[0],A=g(w)||a,T=s.convert(o.format,o.colorSpace),M=s.convert(o.type),S=v(o.internalFormat,T,M,o.colorSpace),E=a&&!0!==o.isVideoTexture,C=void 0===u.__version||!0===c,I=h.dataReady;let L,R=x(o,w,A);if(P(t.TEXTURE_CUBE_MAP,o,A),p){E&&C&&i.texStorage2D(t.TEXTURE_CUBE_MAP,R,S,w.width,w.height);for(let e=0;e<6;e++){L=b[e].mipmaps;for(let n=0;n<L.length;n++){const r=L[n];o.format!==Mv?null!==T&&(E?I&&i.compressedTexSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,0,0,r.width,r.height,T,r.data):i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,S,r.width,r.height,0,r.data)):E?I&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,0,0,r.width,r.height,T,M,r.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n,S,r.width,r.height,0,T,M,r.data)}}}else{L=o.mipmaps,E&&C&&(L.length>0&&R++,i.texStorage2D(t.TEXTURE_CUBE_MAP,R,S,b[0].width,b[0].height));for(let e=0;e<6;e++)if(f){E?I&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,b[e].width,b[e].height,T,M,b[e].data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,S,b[e].width,b[e].height,0,T,M,b[e].data);for(let n=0;n<L.length;n++){const r=L[n].image[e].image;E?I&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,0,0,r.width,r.height,T,M,r.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,S,r.width,r.height,0,T,M,r.data)}}else{E?I&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,T,M,b[e]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,S,T,M,b[e]);for(let n=0;n<L.length;n++){const r=L[n];E?I&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,0,0,T,M,r.image[e]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n+1,S,T,M,r.image[e])}}}_(o,A)&&y(t.TEXTURE_CUBE_MAP),u.__version=h.version,o.onUpdate&&o.onUpdate(o)}e.__version=o.version}(l,e,o):i.bindTexture(t.TEXTURE_CUBE_MAP,l.__webglTexture,t.TEXTURE0+o)},this.rebindTextures=function(e,i,r){const s=n.get(e);void 0!==i&&B(s.__webglFramebuffer,e,e.texture,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,0),void 0!==r&&O(e)},this.setupRenderTarget=function(e){const l=e.texture,c=n.get(e),h=n.get(l);e.addEventListener("dispose",A),!0!==e.isWebGLMultipleRenderTargets&&(void 0===h.__webglTexture&&(h.__webglTexture=t.createTexture()),h.__version=l.version,o.memory.textures++);const u=!0===e.isWebGLCubeRenderTarget,d=!0===e.isWebGLMultipleRenderTargets,p=g(e)||a;if(u){c.__webglFramebuffer=[];for(let e=0;e<6;e++)if(a&&l.mipmaps&&l.mipmaps.length>0){c.__webglFramebuffer[e]=[];for(let i=0;i<l.mipmaps.length;i++)c.__webglFramebuffer[e][i]=t.createFramebuffer()}else c.__webglFramebuffer[e]=t.createFramebuffer()}else{if(a&&l.mipmaps&&l.mipmaps.length>0){c.__webglFramebuffer=[];for(let e=0;e<l.mipmaps.length;e++)c.__webglFramebuffer[e]=t.createFramebuffer()}else c.__webglFramebuffer=t.createFramebuffer();if(d&&r.drawBuffers){const i=e.texture;for(let e=0,r=i.length;e<r;e++){const r=n.get(i[e]);void 0===r.__webglTexture&&(r.__webglTexture=t.createTexture(),o.memory.textures++)}}if(a&&e.samples>0&&!1===F(e)){const n=d?l:[l];c.__webglMultisampledFramebuffer=t.createFramebuffer(),c.__webglColorRenderbuffer=[],i.bindFramebuffer(t.FRAMEBUFFER,c.__webglMultisampledFramebuffer);for(let i=0;i<n.length;i++){const r=n[i];c.__webglColorRenderbuffer[i]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,c.__webglColorRenderbuffer[i]);const o=s.convert(r.format,r.colorSpace),a=s.convert(r.type),l=v(r.internalFormat,o,a,r.colorSpace,!0===e.isXRRenderTarget),h=k(e);t.renderbufferStorageMultisample(t.RENDERBUFFER,h,l,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+i,t.RENDERBUFFER,c.__webglColorRenderbuffer[i])}t.bindRenderbuffer(t.RENDERBUFFER,null),e.depthBuffer&&(c.__webglDepthRenderbuffer=t.createRenderbuffer(),D(c.__webglDepthRenderbuffer,e,!0)),i.bindFramebuffer(t.FRAMEBUFFER,null)}}if(u){i.bindTexture(t.TEXTURE_CUBE_MAP,h.__webglTexture),P(t.TEXTURE_CUBE_MAP,l,p);for(let i=0;i<6;i++)if(a&&l.mipmaps&&l.mipmaps.length>0)for(let n=0;n<l.mipmaps.length;n++)B(c.__webglFramebuffer[i][n],e,l,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,n);else B(c.__webglFramebuffer[i],e,l,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+i,0);_(l,p)&&y(t.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(d){const r=e.texture;for(let s=0,o=r.length;s<o;s++){const o=r[s],a=n.get(o);i.bindTexture(t.TEXTURE_2D,a.__webglTexture),P(t.TEXTURE_2D,o,p),B(c.__webglFramebuffer,e,o,t.COLOR_ATTACHMENT0+s,t.TEXTURE_2D,0),_(o,p)&&y(t.TEXTURE_2D)}i.unbindTexture()}else{let n=t.TEXTURE_2D;if((e.isWebGL3DRenderTarget||e.isWebGLArrayRenderTarget)&&a&&(n=e.isWebGL3DRenderTarget?t.TEXTURE_3D:t.TEXTURE_2D_ARRAY),i.bindTexture(n,h.__webglTexture),P(n,l,p),a&&l.mipmaps&&l.mipmaps.length>0)for(let i=0;i<l.mipmaps.length;i++)B(c.__webglFramebuffer[i],e,l,t.COLOR_ATTACHMENT0,n,i);else B(c.__webglFramebuffer,e,l,t.COLOR_ATTACHMENT0,n,0);_(l,p)&&y(n),i.unbindTexture()}e.depthBuffer&&O(e)},this.updateRenderTargetMipmap=function(e){const r=g(e)||a,s=!0===e.isWebGLMultipleRenderTargets?e.texture:[e.texture];for(let o=0,a=s.length;o<a;o++){const a=s[o];if(_(a,r)){const r=e.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,s=n.get(a).__webglTexture;i.bindTexture(r,s),y(r),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(e){if(a&&e.samples>0&&!1===F(e)){const r=e.isWebGLMultipleRenderTargets?e.texture:[e.texture],s=e.width,o=e.height;let a=t.COLOR_BUFFER_BIT;const l=[],h=e.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,u=n.get(e),d=!0===e.isWebGLMultipleRenderTargets;if(d)for(let e=0;e<r.length;e++)i.bindFramebuffer(t.FRAMEBUFFER,u.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,null),i.bindFramebuffer(t.FRAMEBUFFER,u.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0);i.bindFramebuffer(t.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let i=0;i<r.length;i++){l.push(t.COLOR_ATTACHMENT0+i),e.depthBuffer&&l.push(h);const p=void 0!==u.__ignoreDepthValues&&u.__ignoreDepthValues;if(!1===p&&(e.depthBuffer&&(a|=t.DEPTH_BUFFER_BIT),e.stencilBuffer&&(a|=t.STENCIL_BUFFER_BIT)),d&&t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,u.__webglColorRenderbuffer[i]),!0===p&&(t.invalidateFramebuffer(t.READ_FRAMEBUFFER,[h]),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,[h])),d){const e=n.get(r[i]).__webglTexture;t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)}t.blitFramebuffer(0,0,s,o,0,0,s,o,a,t.NEAREST),c&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,l)}if(i.bindFramebuffer(t.READ_FRAMEBUFFER,null),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),d)for(let e=0;e<r.length;e++){i.bindFramebuffer(t.FRAMEBUFFER,u.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,u.__webglColorRenderbuffer[e]);const s=n.get(r[e]).__webglTexture;i.bindFramebuffer(t.FRAMEBUFFER,u.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,s,0)}i.bindFramebuffer(t.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=O,this.setupFrameBufferTexture=B,this.useMultisampledRTT=F}function SS(t,e,i){const n=i.isWebGL2;return{convert:function(i,r=""){let s;const o=ab.getTransfer(r);if(i===gv)return t.UNSIGNED_BYTE;if(i===wv)return t.UNSIGNED_SHORT_4_4_4_4;if(i===Av)return t.UNSIGNED_SHORT_5_5_5_1;if(1010===i)return t.BYTE;if(1011===i)return t.SHORT;if(i===_v)return t.UNSIGNED_SHORT;if(i===yv)return t.INT;if(i===vv)return t.UNSIGNED_INT;if(i===xv)return t.FLOAT;if(i===bv)return n?t.HALF_FLOAT:(s=e.get("OES_texture_half_float"),null!==s?s.HALF_FLOAT_OES:null);if(1021===i)return t.ALPHA;if(i===Mv)return t.RGBA;if(1024===i)return t.LUMINANCE;if(1025===i)return t.LUMINANCE_ALPHA;if(i===Sv)return t.DEPTH_COMPONENT;if(i===Ev)return t.DEPTH_STENCIL;if(i===Px)return s=e.get("EXT_sRGB"),null!==s?s.SRGB_ALPHA_EXT:null;if(1028===i)return t.RED;if(i===Cv)return t.RED_INTEGER;if(1030===i)return t.RG;if(i===Iv)return t.RG_INTEGER;if(i===Pv)return t.RGBA_INTEGER;if(i===Lv||i===Rv||i===Bv||i===Dv)if(o===Tx){if(s=e.get("WEBGL_compressed_texture_s3tc_srgb"),null===s)return null;if(i===Lv)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===Rv)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===Bv)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===Dv)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=e.get("WEBGL_compressed_texture_s3tc"),null===s)return null;if(i===Lv)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===Rv)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===Bv)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===Dv)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(i===Ov||i===kv||i===Fv||i===zv){if(s=e.get("WEBGL_compressed_texture_pvrtc"),null===s)return null;if(i===Ov)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===kv)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Fv)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===zv)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===Nv)return s=e.get("WEBGL_compressed_texture_etc1"),null!==s?s.COMPRESSED_RGB_ETC1_WEBGL:null;if(i===Uv||i===Gv){if(s=e.get("WEBGL_compressed_texture_etc"),null===s)return null;if(i===Uv)return o===Tx?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(i===Gv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}if(i===Vv||i===jv||i===Hv||i===Wv||i===qv||i===Xv||i===Zv||i===Jv||i===Yv||i===$v||i===Kv||i===Qv||i===tx||i===ex){if(s=e.get("WEBGL_compressed_texture_astc"),null===s)return null;if(i===Vv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===jv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===Hv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===Wv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===qv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===Xv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===Zv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===Jv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===Yv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===$v)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===Kv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===Qv)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===tx)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===ex)return o===Tx?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}if(i===ix||i===nx||i===rx){if(s=e.get("EXT_texture_compression_bptc"),null===s)return null;if(i===ix)return o===Tx?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===nx)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===rx)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===i||i===sx||i===ox||i===ax){if(s=e.get("EXT_texture_compression_rgtc"),null===s)return null;if(i===ix)return s.COMPRESSED_RED_RGTC1_EXT;if(i===sx)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===ox)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===ax)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return i===Tv?n?t.UNSIGNED_INT_24_8:(s=e.get("WEBGL_depth_texture"),null!==s?s.UNSIGNED_INT_24_8_WEBGL:null):void 0!==t[i]?t[i]:null}}}class ES extends NA{constructor(t=[]){super(),this.isArrayCamera=!0,this.cameras=t}}class CS extends Tw{constructor(){super(),this.isGroup=!0,this.type="Group"}}const IS={type:"move"};class PS{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new CS,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new CS,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Ab,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Ab),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new CS,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Ab,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Ab),this._grip}dispatchEvent(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this}connect(t){if(t&&t.hand){const e=this._hand;if(e)for(const i of t.hand.values())this._getHandJoint(e,i)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(t,e,i){let n=null,r=null,s=null;const o=this._targetRay,a=this._grip,l=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState){if(l&&t.hand){s=!0;for(const n of t.hand.values()){const t=e.getJointPose(n,i),r=this._getHandJoint(l,n);null!==t&&(r.matrix.fromArray(t.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,r.jointRadius=t.radius),r.visible=null!==t}const n=l.joints["index-finger-tip"].position.distanceTo(l.joints["thumb-tip"].position),r=.02,o=.005;l.inputState.pinching&&n>r+o?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!l.inputState.pinching&&n<=r-o&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==a&&t.gripSpace&&(r=e.getPose(t.gripSpace,i),null!==r&&(a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,r.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(r.linearVelocity)):a.hasLinearVelocity=!1,r.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(r.angularVelocity)):a.hasAngularVelocity=!1));null!==o&&(n=e.getPose(t.targetRaySpace,i),null===n&&null!==r&&(n=r),null!==n&&(o.matrix.fromArray(n.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,n.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(n.linearVelocity)):o.hasLinearVelocity=!1,n.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(n.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(IS)))}return null!==o&&(o.visible=null!==n),null!==a&&(a.visible=null!==r),null!==l&&(l.visible=null!==s),this}_getHandJoint(t,e){if(void 0===t.joints[e.jointName]){const i=new CS;i.matrixAutoUpdate=!1,i.visible=!1,t.joints[e.jointName]=i,t.add(i)}return t.joints[e.jointName]}}class LS{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(t,e,i){if(null===this.texture){const n=new gb;t.properties.get(n).__webglTexture=e.texture,e.depthNear==i.depthNear&&e.depthFar==i.depthFar||(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=n}}render(t,e){if(null!==this.texture){if(null===this.mesh){const t=e.cameras[0].viewport,i=new DA({extensions:{fragDepth:!0},vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepthEXT = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepthEXT = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new EA(new QA(20,20),i)}t.render(this.mesh,e)}}reset(){this.texture=null,this.mesh=null}}class RS extends Bx{constructor(t,e){super();const i=this;let n=null,r=1,s=null,o="local-floor",a=1,l=null,c=null,h=null,u=null,d=null,p=null;const f=new LS,m=e.getContextAttributes();let g=null,_=null;const y=[],v=[],x=new Xx;let b=null;const w=new NA;w.layers.enable(1),w.viewport=new _b;const A=new NA;A.layers.enable(2),A.viewport=new _b;const T=[w,A],M=new ES;M.layers.enable(1),M.layers.enable(2);let S=null,E=null;function C(t){const e=v.indexOf(t.inputSource);if(-1===e)return;const i=y[e];void 0!==i&&(i.update(t.inputSource,t.frame,l||s),i.dispatchEvent({type:t.type,data:t.inputSource}))}function I(){n.removeEventListener("select",C),n.removeEventListener("selectstart",C),n.removeEventListener("selectend",C),n.removeEventListener("squeeze",C),n.removeEventListener("squeezestart",C),n.removeEventListener("squeezeend",C),n.removeEventListener("end",I),n.removeEventListener("inputsourceschange",P);for(let t=0;t<y.length;t++){const e=v[t];null!==e&&(v[t]=null,y[t].disconnect(e))}S=null,E=null,f.reset(),t.setRenderTarget(g),d=null,u=null,h=null,n=null,_=null,O.stop(),i.isPresenting=!1,t.setPixelRatio(b),t.setSize(x.width,x.height,!1),i.dispatchEvent({type:"sessionend"})}function P(t){for(let e=0;e<t.removed.length;e++){const i=t.removed[e],n=v.indexOf(i);n>=0&&(v[n]=null,y[n].disconnect(i))}for(let e=0;e<t.added.length;e++){const i=t.added[e];let n=v.indexOf(i);if(-1===n){for(let t=0;t<y.length;t++){if(t>=v.length){v.push(i),n=t;break}if(null===v[t]){v[t]=i,n=t;break}}if(-1===n)break}const r=y[n];r&&r.connect(i)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=y[t];return void 0===e&&(e=new PS,y[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=y[t];return void 0===e&&(e=new PS,y[t]=e),e.getGripSpace()},this.getHand=function(t){let e=y[t];return void 0===e&&(e=new PS,y[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){r=t},this.setReferenceSpaceType=function(t){o=t},this.getReferenceSpace=function(){return l||s},this.setReferenceSpace=function(t){l=t},this.getBaseLayer=function(){return null!==u?u:d},this.getBinding=function(){return h},this.getFrame=function(){return p},this.getSession=function(){return n},this.setSession=async function(c){if(n=c,null!==n){if(g=t.getRenderTarget(),n.addEventListener("select",C),n.addEventListener("selectstart",C),n.addEventListener("selectend",C),n.addEventListener("squeeze",C),n.addEventListener("squeezestart",C),n.addEventListener("squeezeend",C),n.addEventListener("end",I),n.addEventListener("inputsourceschange",P),!0!==m.xrCompatible&&await e.makeXRCompatible(),b=t.getPixelRatio(),t.getSize(x),void 0===n.renderState.layers||!1===t.capabilities.isWebGL2){d=new XRWebGLLayer(n,e,{antialias:void 0!==n.renderState.layers||m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:r}),n.updateRenderState({baseLayer:d}),t.setPixelRatio(1),t.setSize(d.framebufferWidth,d.framebufferHeight,!1),_=new vb(d.framebufferWidth,d.framebufferHeight,{format:Mv,type:gv,colorSpace:t.outputColorSpace,stencilBuffer:m.stencil})}else{let i=null,s=null,o=null;m.depth&&(o=m.stencil?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT24,i=m.stencil?Ev:Sv,s=m.stencil?Tv:vv);const a={colorFormat:e.RGBA8,depthFormat:o,scaleFactor:r};h=new XRWebGLBinding(n,e),u=h.createProjectionLayer(a),n.updateRenderState({layers:[u]}),t.setPixelRatio(1),t.setSize(u.textureWidth,u.textureHeight,!1),_=new vb(u.textureWidth,u.textureHeight,{format:Mv,type:gv,depthTexture:new kT(u.textureWidth,u.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,i),stencilBuffer:m.stencil,colorSpace:t.outputColorSpace,samples:m.antialias?4:0});t.properties.get(_).__ignoreDepthValues=u.ignoreDepthValues}_.isXRRenderTarget=!0,this.setFoveation(a),l=null,s=await n.requestReferenceSpace(o),O.setContext(n),O.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==n)return n.environmentBlendMode};const L=new Ab,R=new Ab;function B(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(t){if(null===n)return;null!==f.texture&&(t.near=f.depthNear,t.far=f.depthFar),M.near=A.near=w.near=t.near,M.far=A.far=w.far=t.far,S===M.near&&E===M.far||(n.updateRenderState({depthNear:M.near,depthFar:M.far}),S=M.near,E=M.far,w.near=S,w.far=E,A.near=S,A.far=E,w.updateProjectionMatrix(),A.updateProjectionMatrix(),t.updateProjectionMatrix());const e=t.parent,i=M.cameras;B(M,e);for(let t=0;t<i.length;t++)B(i[t],e);2===i.length?function(t,e,i){L.setFromMatrixPosition(e.matrixWorld),R.setFromMatrixPosition(i.matrixWorld);const n=L.distanceTo(R),r=e.projectionMatrix.elements,s=i.projectionMatrix.elements,o=r[14]/(r[10]-1),a=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],h=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=o*h,p=o*u,f=n/(-h+u),m=f*-h;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(m),t.translateZ(f),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=o+f,_=a+f;t.projectionMatrix.makePerspective(d-m,p+(n-m),l*a/_*g,c*a/_*g,g,_),t.projectionMatrixInverse.copy(t.projectionMatrix).invert()}(M,w,A):M.projectionMatrix.copy(w.projectionMatrix),function(t,e,i){null===i?t.matrix.copy(e.matrixWorld):(t.matrix.copy(i.matrixWorld),t.matrix.invert(),t.matrix.multiply(e.matrixWorld));t.matrix.decompose(t.position,t.quaternion,t.scale),t.updateMatrixWorld(!0),t.projectionMatrix.copy(e.projectionMatrix),t.projectionMatrixInverse.copy(e.projectionMatrixInverse),t.isPerspectiveCamera&&(t.fov=2*Fx*Math.atan(1/t.projectionMatrix.elements[5]),t.zoom=1)}(t,M,e)},this.getCamera=function(){return M},this.getFoveation=function(){if(null!==u||null!==d)return a},this.setFoveation=function(t){a=t,null!==u&&(u.fixedFoveation=t),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=t)},this.hasDepthSensing=function(){return null!==f.texture};let D=null;const O=new $A;O.setAnimationLoop((function(e,r){if(c=r.getViewerPose(l||s),p=r,null!==c){const e=c.views;null!==d&&(t.setRenderTargetFramebuffer(_,d.framebuffer),t.setRenderTarget(_));let i=!1;e.length!==M.cameras.length&&(M.cameras.length=0,i=!0);for(let n=0;n<e.length;n++){const r=e[n];let s=null;if(null!==d)s=d.getViewport(r);else{const e=h.getViewSubImage(u,r);s=e.viewport,0===n&&(t.setRenderTargetTextures(_,e.colorTexture,u.ignoreDepthValues?void 0:e.depthStencilTexture),t.setRenderTarget(_))}let o=T[n];void 0===o&&(o=new NA,o.layers.enable(n),o.viewport=new _b,T[n]=o),o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.quaternion,o.scale),o.projectionMatrix.fromArray(r.projectionMatrix),o.projectionMatrixInverse.copy(o.projectionMatrix).invert(),o.viewport.set(s.x,s.y,s.width,s.height),0===n&&(M.matrix.copy(o.matrix),M.matrix.decompose(M.position,M.quaternion,M.scale)),!0===i&&M.cameras.push(o)}const r=n.enabledFeatures;if(r&&r.includes("depth-sensing")){const i=h.getDepthInformation(e[0]);i&&i.isValid&&i.texture&&f.init(t,i,n.renderState)}}for(let t=0;t<y.length;t++){const e=v[t],i=y[t];null!==e&&void 0!==i&&i.update(e,r,l||s)}f.render(t,M),D&&D(e,r),r.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:r}),p=null})),this.setAnimationLoop=function(t){D=t},this.dispose=function(){}}}function BS(t,e){function i(t,e){!0===t.matrixAutoUpdate&&t.updateMatrix(),e.value.copy(t.matrix)}function n(n,r){n.opacity.value=r.opacity,r.color&&n.diffuse.value.copy(r.color),r.emissive&&n.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(n.map.value=r.map,i(r.map,n.mapTransform)),r.alphaMap&&(n.alphaMap.value=r.alphaMap,i(r.alphaMap,n.alphaMapTransform)),r.bumpMap&&(n.bumpMap.value=r.bumpMap,i(r.bumpMap,n.bumpMapTransform),n.bumpScale.value=r.bumpScale,r.side===Ny&&(n.bumpScale.value*=-1)),r.normalMap&&(n.normalMap.value=r.normalMap,i(r.normalMap,n.normalMapTransform),n.normalScale.value.copy(r.normalScale),r.side===Ny&&n.normalScale.value.negate()),r.displacementMap&&(n.displacementMap.value=r.displacementMap,i(r.displacementMap,n.displacementMapTransform),n.displacementScale.value=r.displacementScale,n.displacementBias.value=r.displacementBias),r.emissiveMap&&(n.emissiveMap.value=r.emissiveMap,i(r.emissiveMap,n.emissiveMapTransform)),r.specularMap&&(n.specularMap.value=r.specularMap,i(r.specularMap,n.specularMapTransform)),r.alphaTest>0&&(n.alphaTest.value=r.alphaTest);const s=e.get(r).envMap;if(s&&(n.envMap.value=s,n.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,n.reflectivity.value=r.reflectivity,n.ior.value=r.ior,n.refractionRatio.value=r.refractionRatio),r.lightMap){n.lightMap.value=r.lightMap;const e=!0===t._useLegacyLights?Math.PI:1;n.lightMapIntensity.value=r.lightMapIntensity*e,i(r.lightMap,n.lightMapTransform)}r.aoMap&&(n.aoMap.value=r.aoMap,n.aoMapIntensity.value=r.aoMapIntensity,i(r.aoMap,n.aoMapTransform))}return{refreshFogUniforms:function(e,i){i.color.getRGB(e.fogColor.value,RA(t)),i.isFog?(e.fogNear.value=i.near,e.fogFar.value=i.far):i.isFogExp2&&(e.fogDensity.value=i.density)},refreshMaterialUniforms:function(t,r,s,o,a){r.isMeshBasicMaterial||r.isMeshLambertMaterial?n(t,r):r.isMeshToonMaterial?(n(t,r),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap)}(t,r)):r.isMeshPhongMaterial?(n(t,r),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4)}(t,r)):r.isMeshStandardMaterial?(n(t,r),function(t,n){t.metalness.value=n.metalness,n.metalnessMap&&(t.metalnessMap.value=n.metalnessMap,i(n.metalnessMap,t.metalnessMapTransform));t.roughness.value=n.roughness,n.roughnessMap&&(t.roughnessMap.value=n.roughnessMap,i(n.roughnessMap,t.roughnessMapTransform));const r=e.get(n).envMap;r&&(t.envMapIntensity.value=n.envMapIntensity)}(t,r),r.isMeshPhysicalMaterial&&function(t,e,n){t.ior.value=e.ior,e.sheen>0&&(t.sheenColor.value.copy(e.sheenColor).multiplyScalar(e.sheen),t.sheenRoughness.value=e.sheenRoughness,e.sheenColorMap&&(t.sheenColorMap.value=e.sheenColorMap,i(e.sheenColorMap,t.sheenColorMapTransform)),e.sheenRoughnessMap&&(t.sheenRoughnessMap.value=e.sheenRoughnessMap,i(e.sheenRoughnessMap,t.sheenRoughnessMapTransform)));e.clearcoat>0&&(t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap,i(e.clearcoatMap,t.clearcoatMapTransform)),e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap,i(e.clearcoatRoughnessMap,t.clearcoatRoughnessMapTransform)),e.clearcoatNormalMap&&(t.clearcoatNormalMap.value=e.clearcoatNormalMap,i(e.clearcoatNormalMap,t.clearcoatNormalMapTransform),t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),e.side===Ny&&t.clearcoatNormalScale.value.negate()));e.iridescence>0&&(t.iridescence.value=e.iridescence,t.iridescenceIOR.value=e.iridescenceIOR,t.iridescenceThicknessMinimum.value=e.iridescenceThicknessRange[0],t.iridescenceThicknessMaximum.value=e.iridescenceThicknessRange[1],e.iridescenceMap&&(t.iridescenceMap.value=e.iridescenceMap,i(e.iridescenceMap,t.iridescenceMapTransform)),e.iridescenceThicknessMap&&(t.iridescenceThicknessMap.value=e.iridescenceThicknessMap,i(e.iridescenceThicknessMap,t.iridescenceThicknessMapTransform)));e.transmission>0&&(t.transmission.value=e.transmission,t.transmissionSamplerMap.value=n.texture,t.transmissionSamplerSize.value.set(n.width,n.height),e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap,i(e.transmissionMap,t.transmissionMapTransform)),t.thickness.value=e.thickness,e.thicknessMap&&(t.thicknessMap.value=e.thicknessMap,i(e.thicknessMap,t.thicknessMapTransform)),t.attenuationDistance.value=e.attenuationDistance,t.attenuationColor.value.copy(e.attenuationColor));e.anisotropy>0&&(t.anisotropyVector.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation)),e.anisotropyMap&&(t.anisotropyMap.value=e.anisotropyMap,i(e.anisotropyMap,t.anisotropyMapTransform)));t.specularIntensity.value=e.specularIntensity,t.specularColor.value.copy(e.specularColor),e.specularColorMap&&(t.specularColorMap.value=e.specularColorMap,i(e.specularColorMap,t.specularColorMapTransform));e.specularIntensityMap&&(t.specularIntensityMap.value=e.specularIntensityMap,i(e.specularIntensityMap,t.specularIntensityMapTransform))}(t,r,a)):r.isMeshMatcapMaterial?(n(t,r),function(t,e){e.matcap&&(t.matcap.value=e.matcap)}(t,r)):r.isMeshDepthMaterial?n(t,r):r.isMeshDistanceMaterial?(n(t,r),function(t,i){const n=e.get(i).light;t.referencePosition.value.setFromMatrixPosition(n.matrixWorld),t.nearDistance.value=n.shadow.camera.near,t.farDistance.value=n.shadow.camera.far}(t,r)):r.isMeshNormalMaterial?n(t,r):r.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,e.map&&(t.map.value=e.map,i(e.map,t.mapTransform))}(t,r),r.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,r)):r.isPointsMaterial?function(t,e,n,r){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*n,t.scale.value=.5*r,e.map&&(t.map.value=e.map,i(e.map,t.uvTransform));e.alphaMap&&(t.alphaMap.value=e.alphaMap,i(e.alphaMap,t.alphaMapTransform));e.alphaTest>0&&(t.alphaTest.value=e.alphaTest)}(t,r,s,o):r.isSpriteMaterial?function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map,i(e.map,t.mapTransform));e.alphaMap&&(t.alphaMap.value=e.alphaMap,i(e.alphaMap,t.alphaMapTransform));e.alphaTest>0&&(t.alphaTest.value=e.alphaTest)}(t,r):r.isShadowMaterial?(t.color.value.copy(r.color),t.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function DS(t,e,i,n){let r={},s={},o=[];const a=i.isWebGL2?t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS):0;function l(t,e,i,n){const r=t.value,s=e+"_"+i;if(void 0===n[s])return n[s]="number"==typeof r||"boolean"==typeof r?r:r.clone(),!0;{const t=n[s];if("number"==typeof r||"boolean"==typeof r){if(t!==r)return n[s]=r,!0}else if(!1===t.equals(r))return t.copy(r),!0}return!1}function c(t){const e={boundary:0,storage:0};return"number"==typeof t||"boolean"==typeof t?(e.boundary=4,e.storage=4):t.isVector2?(e.boundary=8,e.storage=8):t.isVector3||t.isColor?(e.boundary=16,e.storage=12):t.isVector4?(e.boundary=16,e.storage=16):t.isMatrix3?(e.boundary=48,e.storage=48):t.isMatrix4&&(e.boundary=64,e.storage=64),e}function h(e){const i=e.target;i.removeEventListener("dispose",h);const n=o.indexOf(i.__bindingPointIndex);o.splice(n,1),t.deleteBuffer(r[i.id]),delete r[i.id],delete s[i.id]}return{bind:function(t,e){n.uniformBlockBinding(t,e.program)},update:function(i,u){let d=r[i.id];void 0===d&&(!function(t){const e=t.uniforms;let i=0;const n=16;for(let t=0,r=e.length;t<r;t++){const r=Array.isArray(e[t])?e[t]:[e[t]];for(let t=0,e=r.length;t<e;t++){const e=r[t],s=Array.isArray(e.value)?e.value:[e.value];for(let t=0,r=s.length;t<r;t++){const r=c(s[t]),o=i%n;0!==o&&n-o<r.boundary&&(i+=n-o),e.__data=new Float32Array(r.storage/Float32Array.BYTES_PER_ELEMENT),e.__offset=i,i+=r.storage}}}const r=i%n;r>0&&(i+=n-r);t.__size=i,t.__cache={}}(i),d=function(e){const i=function(){for(let t=0;t<a;t++)if(-1===o.indexOf(t))return o.push(t),t;return 0}();e.__bindingPointIndex=i;const n=t.createBuffer(),r=e.__size,s=e.usage;return t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,r,s),t.bindBuffer(t.UNIFORM_BUFFER,null),t.bindBufferBase(t.UNIFORM_BUFFER,i,n),n}(i),r[i.id]=d,i.addEventListener("dispose",h)),n.updateUBOMapping(i,u.program);const p=e.render.frame;s[i.id]!==p&&(!function(e){const i=r[e.id],n=e.uniforms,s=e.__cache;t.bindBuffer(t.UNIFORM_BUFFER,i);for(let e=0,i=n.length;e<i;e++){const i=Array.isArray(n[e])?n[e]:[n[e]];for(let n=0,r=i.length;n<r;n++){const r=i[n];if(!0===l(r,e,n,s)){const e=r.__offset,i=Array.isArray(r.value)?r.value:[r.value];let n=0;for(let s=0;s<i.length;s++){const o=i[s],a=c(o);"number"==typeof o||"boolean"==typeof o?(r.__data[0]=o,t.bufferSubData(t.UNIFORM_BUFFER,e+n,r.__data)):o.isMatrix3?(r.__data[0]=o.elements[0],r.__data[1]=o.elements[1],r.__data[2]=o.elements[2],r.__data[3]=0,r.__data[4]=o.elements[3],r.__data[5]=o.elements[4],r.__data[6]=o.elements[5],r.__data[7]=0,r.__data[8]=o.elements[6],r.__data[9]=o.elements[7],r.__data[10]=o.elements[8],r.__data[11]=0):(o.toArray(r.__data,n),n+=a.storage/Float32Array.BYTES_PER_ELEMENT)}t.bufferSubData(t.UNIFORM_BUFFER,e,r.__data)}}}t.bindBuffer(t.UNIFORM_BUFFER,null)}(i),s[i.id]=p)},dispose:function(){for(const e in r)t.deleteBuffer(r[e]);o=[],r={},s={}}}}class OS{constructor(t={}){const{canvas:e=tb(),context:i=null,depth:n=!0,stencil:r=!0,alpha:s=!1,antialias:o=!1,premultipliedAlpha:a=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:h=!1}=t;let u;this.isWebGLRenderer=!0,u=null!==i?i.getContextAttributes().alpha:s;const d=new Uint32Array(4),p=new Int32Array(4);let f=null,m=null;const g=[],_=[];this.domElement=e,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=vx,this._useLegacyLights=!1,this.toneMapping=qy,this.toneMappingExposure=1;const y=this;let v=!1,x=0,b=0,w=null,A=-1,T=null;const M=new _b,S=new _b;let E=null;const C=new Uw(0);let I=0,P=e.width,L=e.height,R=1,B=null,D=null;const O=new _b(0,0,P,L),k=new _b(0,0,P,L);let F=!1;const z=new YA;let N=!1,U=!1,G=null;const V=new Qb,j=new Xx,H=new Ab,W={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function q(){return null===w?R:1}let X,Z,J,Y,$,K,Q,tt,et,it,nt,rt,st,ot,at,lt,ct,ht,ut,dt,pt,ft,mt,gt,_t=i;function yt(t,i){for(let n=0;n<t.length;n++){const r=e.getContext(t[n],i);if(null!==r)return r}return null}try{const t={alpha:!0,depth:n,stencil:r,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:h};if("setAttribute"in e&&e.setAttribute("data-engine",`three.js r${Dy}`),e.addEventListener("webglcontextlost",bt,!1),e.addEventListener("webglcontextrestored",wt,!1),e.addEventListener("webglcontextcreationerror",At,!1),null===_t){const e=["webgl2","webgl","experimental-webgl"];if(!0===y.isWebGL1Renderer&&e.shift(),_t=yt(e,t),null===_t)throw yt(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&WebGLRenderingContext,void 0===_t.getShaderPrecisionFormat&&(_t.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw t}function vt(){X=new CT(_t),Z=new aT(_t,X,t),X.init(Z),ft=new SS(_t,X,Z),J=new TS(_t,X,Z),Y=new LT(_t),$=new hS,K=new MS(_t,X,J,$,Z,ft,Y),Q=new cT(y),tt=new ET(y),et=new KA(_t,Z),mt=new sT(_t,X,et,Z),it=new IT(_t,et,Y,mt),nt=new OT(_t,it,et,Y),ut=new DT(_t,Z,K),lt=new lT($),rt=new cS(y,Q,tt,X,Z,mt,lt),st=new BS(y,$),ot=new fS,at=new xS(X,Z),ht=new rT(y,Q,tt,J,nt,u,a),ct=new AS(y,nt,Z),gt=new DS(_t,Y,Z,J),dt=new oT(_t,X,Y,Z),pt=new PT(_t,X,Y,Z),Y.programs=rt.programs,y.capabilities=Z,y.extensions=X,y.properties=$,y.renderLists=ot,y.shadowMap=ct,y.state=J,y.info=Y}vt();const xt=new RS(y,_t);function bt(t){t.preventDefault(),v=!0}function wt(){v=!1;const t=Y.autoReset,e=ct.enabled,i=ct.autoUpdate,n=ct.needsUpdate,r=ct.type;vt(),Y.autoReset=t,ct.enabled=e,ct.autoUpdate=i,ct.needsUpdate=n,ct.type=r}function At(t){}function Tt(t){const e=t.target;e.removeEventListener("dispose",Tt),function(t){(function(t){const e=$.get(t).programs;void 0!==e&&(e.forEach((function(t){rt.releaseProgram(t)})),t.isShaderMaterial&&rt.releaseShaderCache(t))})(t),$.remove(t)}(e)}function Mt(t,e,i){!0===t.transparent&&2===t.side&&!1===t.forceSinglePass?(t.side=Ny,t.needsUpdate=!0,Dt(t,e,i),t.side=zy,t.needsUpdate=!0,Dt(t,e,i),t.side=2):Dt(t,e,i)}this.xr=xt,this.getContext=function(){return _t},this.getContextAttributes=function(){return _t.getContextAttributes()},this.forceContextLoss=function(){const t=X.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=X.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return R},this.setPixelRatio=function(t){void 0!==t&&(R=t,this.setSize(P,L,!1))},this.getSize=function(t){return t.set(P,L)},this.setSize=function(t,i,n=!0){xt.isPresenting||(P=t,L=i,e.width=Math.floor(t*R),e.height=Math.floor(i*R),!0===n&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(t){return t.set(P*R,L*R).floor()},this.setDrawingBufferSize=function(t,i,n){P=t,L=i,R=n,e.width=Math.floor(t*n),e.height=Math.floor(i*n),this.setViewport(0,0,t,i)},this.getCurrentViewport=function(t){return t.copy(M)},this.getViewport=function(t){return t.copy(O)},this.setViewport=function(t,e,i,n){t.isVector4?O.set(t.x,t.y,t.z,t.w):O.set(t,e,i,n),J.viewport(M.copy(O).multiplyScalar(R).floor())},this.getScissor=function(t){return t.copy(k)},this.setScissor=function(t,e,i,n){t.isVector4?k.set(t.x,t.y,t.z,t.w):k.set(t,e,i,n),J.scissor(S.copy(k).multiplyScalar(R).floor())},this.getScissorTest=function(){return F},this.setScissorTest=function(t){J.setScissorTest(F=t)},this.setOpaqueSort=function(t){B=t},this.setTransparentSort=function(t){D=t},this.getClearColor=function(t){return t.copy(ht.getClearColor())},this.setClearColor=function(){ht.setClearColor.apply(ht,arguments)},this.getClearAlpha=function(){return ht.getClearAlpha()},this.setClearAlpha=function(){ht.setClearAlpha.apply(ht,arguments)},this.clear=function(t=!0,e=!0,i=!0){let n=0;if(t){let t=!1;if(null!==w){const e=w.texture.format;t=e===Pv||e===Iv||e===Cv}if(t){const t=w.texture.type,e=t===gv||t===vv||t===_v||t===Tv||t===wv||t===Av,i=ht.getClearColor(),n=ht.getClearAlpha(),r=i.r,s=i.g,o=i.b;e?(d[0]=r,d[1]=s,d[2]=o,d[3]=n,_t.clearBufferuiv(_t.COLOR,0,d)):(p[0]=r,p[1]=s,p[2]=o,p[3]=n,_t.clearBufferiv(_t.COLOR,0,p))}else n|=_t.COLOR_BUFFER_BIT}e&&(n|=_t.DEPTH_BUFFER_BIT),i&&(n|=_t.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),_t.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",bt,!1),e.removeEventListener("webglcontextrestored",wt,!1),e.removeEventListener("webglcontextcreationerror",At,!1),ot.dispose(),at.dispose(),$.dispose(),Q.dispose(),tt.dispose(),nt.dispose(),mt.dispose(),gt.dispose(),rt.dispose(),xt.dispose(),xt.removeEventListener("sessionstart",Et),xt.removeEventListener("sessionend",Ct),G&&(G.dispose(),G=null),It.stop()},this.renderBufferDirect=function(t,e,i,n,r,s){null===e&&(e=W);const o=r.isMesh&&r.matrixWorld.determinant()<0,a=function(t,e,i,n,r){!0!==e.isScene&&(e=W);K.resetTextureUnits();const s=e.fog,o=n.isMeshStandardMaterial?e.environment:null,a=null===w?y.outputColorSpace:!0===w.isXRRenderTarget?w.texture.colorSpace:xx,l=(n.isMeshStandardMaterial?tt:Q).get(n.envMap||o),c=!0===n.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,h=!!i.attributes.tangent&&(!!n.normalMap||n.anisotropy>0),u=!!i.morphAttributes.position,d=!!i.morphAttributes.normal,p=!!i.morphAttributes.color;let f=qy;n.toneMapped&&(null!==w&&!0!==w.isXRRenderTarget||(f=y.toneMapping));const g=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color,_=void 0!==g?g.length:0,v=$.get(n),x=m.state.lights;if(!0===N&&(!0===U||t!==T)){lt.setState(n,t,t===T&&n.id===A)}let b=!1;n.version===v.__version?v.needsLights&&v.lightsStateVersion!==x.state.version||v.outputColorSpace!==a||r.isBatchedMesh&&!1===v.batching?b=!0:r.isBatchedMesh||!0!==v.batching?r.isInstancedMesh&&!1===v.instancing?b=!0:r.isInstancedMesh||!0!==v.instancing?r.isSkinnedMesh&&!1===v.skinning?b=!0:r.isSkinnedMesh||!0!==v.skinning?r.isInstancedMesh&&!0===v.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===v.instancingColor&&null!==r.instanceColor||v.envMap!==l||!0===n.fog&&v.fog!==s?b=!0:void 0===v.numClippingPlanes||v.numClippingPlanes===lt.numPlanes&&v.numIntersection===lt.numIntersection?(v.vertexAlphas!==c||v.vertexTangents!==h||v.morphTargets!==u||v.morphNormals!==d||v.morphColors!==p||v.toneMapping!==f||!0===Z.isWebGL2&&v.morphTargetsCount!==_)&&(b=!0):b=!0:b=!0:b=!0:b=!0:(b=!0,v.__version=n.version);let M=v.currentProgram;!0===b&&(M=Dt(n,e,r));let S=!1,E=!1,C=!1;const I=M.getUniforms(),P=v.uniforms;J.useProgram(M.program)&&(S=!0,E=!0,C=!0);n.id!==A&&(A=n.id,E=!0);if(S||T!==t){I.setValue(_t,"projectionMatrix",t.projectionMatrix),I.setValue(_t,"viewMatrix",t.matrixWorldInverse);const e=I.map.cameraPosition;void 0!==e&&e.setValue(_t,H.setFromMatrixPosition(t.matrixWorld)),Z.logarithmicDepthBuffer&&I.setValue(_t,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&I.setValue(_t,"isOrthographic",!0===t.isOrthographicCamera),T!==t&&(T=t,E=!0,C=!0)}if(r.isSkinnedMesh){I.setOptional(_t,r,"bindMatrix"),I.setOptional(_t,r,"bindMatrixInverse");const t=r.skeleton;t&&Z.floatVertexTextures&&(null===t.boneTexture&&t.computeBoneTexture(),I.setValue(_t,"boneTexture",t.boneTexture,K))}r.isBatchedMesh&&(I.setOptional(_t,r,"batchingTexture"),I.setValue(_t,"batchingTexture",r._matricesTexture,K));const B=i.morphAttributes;(void 0!==B.position||void 0!==B.normal||void 0!==B.color&&!0===Z.isWebGL2)&&ut.update(r,i,M);(E||v.receiveShadow!==r.receiveShadow)&&(v.receiveShadow=r.receiveShadow,I.setValue(_t,"receiveShadow",r.receiveShadow));n.isMeshGouraudMaterial&&null!==n.envMap&&(P.envMap.value=l,P.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);E&&(I.setValue(_t,"toneMappingExposure",y.toneMappingExposure),v.needsLights&&((D=P).ambientLightColor.needsUpdate=O=C,D.lightProbe.needsUpdate=O,D.directionalLights.needsUpdate=O,D.directionalLightShadows.needsUpdate=O,D.pointLights.needsUpdate=O,D.pointLightShadows.needsUpdate=O,D.spotLights.needsUpdate=O,D.spotLightShadows.needsUpdate=O,D.rectAreaLights.needsUpdate=O,D.hemisphereLights.needsUpdate=O),s&&!0===n.fog&&st.refreshFogUniforms(P,s),st.refreshMaterialUniforms(P,n,R,L,G),GM.upload(_t,Ot(v),P,K));var D,O;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(GM.upload(_t,Ot(v),P,K),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&I.setValue(_t,"center",r.center);if(I.setValue(_t,"modelViewMatrix",r.modelViewMatrix),I.setValue(_t,"normalMatrix",r.normalMatrix),I.setValue(_t,"modelMatrix",r.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const t=n.uniformsGroups;for(let e=0,i=t.length;e<i;e++)if(Z.isWebGL2){const i=t[e];gt.update(i,M),gt.bind(i,M)}}return M}(t,e,i,n,r);J.setMaterial(n,o);let l=i.index,c=1;if(!0===n.wireframe){if(l=it.getWireframeAttribute(i),void 0===l)return;c=2}const h=i.drawRange,u=i.attributes.position;let d=h.start*c,p=(h.start+h.count)*c;null!==s&&(d=Math.max(d,s.start*c),p=Math.min(p,(s.start+s.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const f=p-d;if(f<0||f===1/0)return;let g;mt.setup(r,n,a,i,l);let _=dt;if(null!==l&&(g=et.get(l),_=pt,_.setIndex(g)),r.isMesh)!0===n.wireframe?(J.setLineWidth(n.wireframeLinewidth*q()),_.setMode(_t.LINES)):_.setMode(_t.TRIANGLES);else if(r.isLine){let t=n.linewidth;void 0===t&&(t=1),J.setLineWidth(t*q()),_.setMode(r.isLineSegments?_t.LINES:r.isLineLoop?_t.LINE_LOOP:_t.LINE_STRIP)}else r.isPoints?_.setMode(_t.POINTS):r.isSprite&&_.setMode(_t.TRIANGLES);if(r.isBatchedMesh)_.renderMultiDraw(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount);else if(r.isInstancedMesh)_.renderInstances(d,f,r.count);else if(i.isInstancedBufferGeometry){const t=Math.min(i.instanceCount,void 0!==i._maxInstanceCount?i._maxInstanceCount:1/0);_.renderInstances(d,f,t)}else _.render(d,f)},this.compile=function(t,e,i=null){null===i&&(i=t),m=at.get(i),m.init(),_.push(m),i.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(m.pushLight(t),t.castShadow&&m.pushShadow(t))})),t!==i&&t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(m.pushLight(t),t.castShadow&&m.pushShadow(t))})),m.setupLights(y._useLegacyLights);const n=new Set;return t.traverse((function(t){const e=t.material;if(e)if(Array.isArray(e))for(let r=0;r<e.length;r++){const s=e[r];Mt(s,i,t),n.add(s)}else Mt(e,i,t),n.add(e)})),_.pop(),m=null,n},this.compileAsync=function(t,e,i=null){const n=this.compile(t,e,i);return new Promise((e=>{function i(){n.forEach((function(t){$.get(t).currentProgram.isReady()&&n.delete(t)})),0!==n.size?setTimeout(i,10):e(t)}null!==X.get("KHR_parallel_shader_compile")?i():setTimeout(i,10)}))};let St=null;function Et(){It.stop()}function Ct(){It.start()}const It=new $A;function Pt(t,e,i,n){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)i=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)m.pushLight(t),t.castShadow&&m.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||z.intersectsSprite(t)){n&&H.setFromMatrixPosition(t.matrixWorld).applyMatrix4(V);const e=nt.update(t),r=t.material;r.visible&&f.push(t,e,r,i,H.z,null)}}else if((t.isMesh||t.isLine||t.isPoints)&&(!t.frustumCulled||z.intersectsObject(t))){const e=nt.update(t),r=t.material;if(n&&(void 0!==t.boundingSphere?(null===t.boundingSphere&&t.computeBoundingSphere(),H.copy(t.boundingSphere.center)):(null===e.boundingSphere&&e.computeBoundingSphere(),H.copy(e.boundingSphere.center)),H.applyMatrix4(t.matrixWorld).applyMatrix4(V)),Array.isArray(r)){const n=e.groups;for(let s=0,o=n.length;s<o;s++){const o=n[s],a=r[o.materialIndex];a&&a.visible&&f.push(t,e,a,i,H.z,o)}}else r.visible&&f.push(t,e,r,i,H.z,null)}const r=t.children;for(let t=0,s=r.length;t<s;t++)Pt(r[t],e,i,n)}function Lt(t,e,i,n){const r=t.opaque,s=t.transmissive,o=t.transparent;m.setupLightsView(i),!0===N&&lt.setGlobalState(y.clippingPlanes,i),s.length>0&&function(t,e,i,n){const r=!0===i.isScene?i.overrideMaterial:null;if(null!==r)return;const s=Z.isWebGL2;null===G&&(G=new vb(1,1,{generateMipmaps:!0,type:X.has("EXT_color_buffer_half_float")?bv:gv,minFilter:mv,samples:s?4:0}));y.getDrawingBufferSize(j),s?G.setSize(j.x,j.y):G.setSize(jx(j.x),jx(j.y));const o=y.getRenderTarget();y.setRenderTarget(G),y.getClearColor(C),I=y.getClearAlpha(),I<1&&y.setClearColor(16777215,.5);y.clear();const a=y.toneMapping;y.toneMapping=qy,Rt(t,i,n),K.updateMultisampleRenderTarget(G),K.updateRenderTargetMipmap(G);let l=!1;for(let t=0,r=e.length;t<r;t++){const r=e[t],s=r.object,o=r.geometry,a=r.material,c=r.group;if(2===a.side&&s.layers.test(n.layers)){const t=a.side;a.side=Ny,a.needsUpdate=!0,Bt(s,i,n,o,a,c),a.side=t,a.needsUpdate=!0,l=!0}}!0===l&&(K.updateMultisampleRenderTarget(G),K.updateRenderTargetMipmap(G));y.setRenderTarget(o),y.setClearColor(C,I),y.toneMapping=a}(r,s,e,i),n&&J.viewport(M.copy(n)),r.length>0&&Rt(r,e,i),s.length>0&&Rt(s,e,i),o.length>0&&Rt(o,e,i),J.buffers.depth.setTest(!0),J.buffers.depth.setMask(!0),J.buffers.color.setMask(!0),J.setPolygonOffset(!1)}function Rt(t,e,i){const n=!0===e.isScene?e.overrideMaterial:null;for(let r=0,s=t.length;r<s;r++){const s=t[r],o=s.object,a=s.geometry,l=null===n?s.material:n,c=s.group;o.layers.test(i.layers)&&Bt(o,e,i,a,l,c)}}function Bt(t,e,i,n,r,s){t.onBeforeRender(y,e,i,n,r,s),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),r.onBeforeRender(y,e,i,n,t,s),!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=Ny,r.needsUpdate=!0,y.renderBufferDirect(i,e,n,r,t,s),r.side=zy,r.needsUpdate=!0,y.renderBufferDirect(i,e,n,r,t,s),r.side=2):y.renderBufferDirect(i,e,n,r,t,s),t.onAfterRender(y,e,i,n,r,s)}function Dt(t,e,i){!0!==e.isScene&&(e=W);const n=$.get(t),r=m.state.lights,s=r.state.version,o=rt.getParameters(t,r.state,m.state.shadowsArray,e,i),a=rt.getProgramCacheKey(o);let l=n.programs;n.environment=t.isMeshStandardMaterial?e.environment:null,n.fog=e.fog,n.envMap=(t.isMeshStandardMaterial?tt:Q).get(t.envMap||n.environment),void 0===l&&(t.addEventListener("dispose",Tt),l=new Map,n.programs=l);let c=l.get(a);if(void 0!==c){if(n.currentProgram===c&&n.lightsStateVersion===s)return kt(t,o),c}else o.uniforms=rt.getUniforms(t),t.onBuild(i,o,y),t.onBeforeCompile(o,y),c=rt.acquireProgram(o,a),l.set(a,c),n.uniforms=o.uniforms;const h=n.uniforms;return(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(h.clippingPlanes=lt.uniform),kt(t,o),n.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),n.lightsStateVersion=s,n.needsLights&&(h.ambientLightColor.value=r.state.ambient,h.lightProbe.value=r.state.probe,h.directionalLights.value=r.state.directional,h.directionalLightShadows.value=r.state.directionalShadow,h.spotLights.value=r.state.spot,h.spotLightShadows.value=r.state.spotShadow,h.rectAreaLights.value=r.state.rectArea,h.ltc_1.value=r.state.rectAreaLTC1,h.ltc_2.value=r.state.rectAreaLTC2,h.pointLights.value=r.state.point,h.pointLightShadows.value=r.state.pointShadow,h.hemisphereLights.value=r.state.hemi,h.directionalShadowMap.value=r.state.directionalShadowMap,h.directionalShadowMatrix.value=r.state.directionalShadowMatrix,h.spotShadowMap.value=r.state.spotShadowMap,h.spotLightMatrix.value=r.state.spotLightMatrix,h.spotLightMap.value=r.state.spotLightMap,h.pointShadowMap.value=r.state.pointShadowMap,h.pointShadowMatrix.value=r.state.pointShadowMatrix),n.currentProgram=c,n.uniformsList=null,c}function Ot(t){if(null===t.uniformsList){const e=t.currentProgram.getUniforms();t.uniformsList=GM.seqWithValue(e.seq,t.uniforms)}return t.uniformsList}function kt(t,e){const i=$.get(t);i.outputColorSpace=e.outputColorSpace,i.batching=e.batching,i.instancing=e.instancing,i.instancingColor=e.instancingColor,i.skinning=e.skinning,i.morphTargets=e.morphTargets,i.morphNormals=e.morphNormals,i.morphColors=e.morphColors,i.morphTargetsCount=e.morphTargetsCount,i.numClippingPlanes=e.numClippingPlanes,i.numIntersection=e.numClipIntersection,i.vertexAlphas=e.vertexAlphas,i.vertexTangents=e.vertexTangents,i.toneMapping=e.toneMapping}It.setAnimationLoop((function(t){St&&St(t)})),"undefined"!=typeof self&&It.setContext(self),this.setAnimationLoop=function(t){St=t,xt.setAnimationLoop(t),null===t?It.stop():It.start()},xt.addEventListener("sessionstart",Et),xt.addEventListener("sessionend",Ct),this.render=function(t,e){if(void 0!==e&&!0!==e.isCamera)return;if(!0===v)return;!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),!0===xt.enabled&&!0===xt.isPresenting&&(!0===xt.cameraAutoUpdate&&xt.updateCamera(e),e=xt.getCamera()),!0===t.isScene&&t.onBeforeRender(y,t,e,w),m=at.get(t,_.length),m.init(),_.push(m),V.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),z.setFromProjectionMatrix(V),U=this.localClippingEnabled,N=lt.init(this.clippingPlanes,U),f=ot.get(t,g.length),f.init(),g.push(f),Pt(t,e,0,y.sortObjects),f.finish(),!0===y.sortObjects&&f.sort(B,D),this.info.render.frame++,!0===N&&lt.beginShadows();if(ct.render(m.state.shadowsArray,t,e),!0===N&&lt.endShadows(),!0===this.info.autoReset&&this.info.reset(),!1!==xt.enabled&&!1!==xt.isPresenting&&!1!==xt.hasDepthSensing()||ht.render(f,t),m.setupLights(y._useLegacyLights),e.isArrayCamera){const i=e.cameras;for(let e=0,n=i.length;e<n;e++){const n=i[e];Lt(f,t,n,n.viewport)}}else Lt(f,t,e);null!==w&&(K.updateMultisampleRenderTarget(w),K.updateRenderTargetMipmap(w)),!0===t.isScene&&t.onAfterRender(y,t,e),mt.resetDefaultState(),A=-1,T=null,_.pop(),m=_.length>0?_[_.length-1]:null,g.pop(),f=g.length>0?g[g.length-1]:null},this.getActiveCubeFace=function(){return x},this.getActiveMipmapLevel=function(){return b},this.getRenderTarget=function(){return w},this.setRenderTargetTextures=function(t,e,i){$.get(t.texture).__webglTexture=e,$.get(t.depthTexture).__webglTexture=i;const n=$.get(t);n.__hasExternalTextures=!0,n.__hasExternalTextures&&(n.__autoAllocateDepthBuffer=void 0===i,n.__autoAllocateDepthBuffer||!0===X.has("WEBGL_multisampled_render_to_texture")&&(n.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(t,e){const i=$.get(t);i.__webglFramebuffer=e,i.__useDefaultFramebuffer=void 0===e},this.setRenderTarget=function(t,e=0,i=0){w=t,x=e,b=i;let n=!0,r=null,s=!1,o=!1;if(t){const a=$.get(t);void 0!==a.__useDefaultFramebuffer?(J.bindFramebuffer(_t.FRAMEBUFFER,null),n=!1):void 0===a.__webglFramebuffer?K.setupRenderTarget(t):a.__hasExternalTextures&&K.rebindTextures(t,$.get(t.texture).__webglTexture,$.get(t.depthTexture).__webglTexture);const l=t.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(o=!0);const c=$.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(r=Array.isArray(c[e])?c[e][i]:c[e],s=!0):r=Z.isWebGL2&&t.samples>0&&!1===K.useMultisampledRTT(t)?$.get(t).__webglMultisampledFramebuffer:Array.isArray(c)?c[i]:c,M.copy(t.viewport),S.copy(t.scissor),E=t.scissorTest}else M.copy(O).multiplyScalar(R).floor(),S.copy(k).multiplyScalar(R).floor(),E=F;if(J.bindFramebuffer(_t.FRAMEBUFFER,r)&&Z.drawBuffers&&n&&J.drawBuffers(t,r),J.viewport(M),J.scissor(S),J.setScissorTest(E),s){const n=$.get(t.texture);_t.framebufferTexture2D(_t.FRAMEBUFFER,_t.COLOR_ATTACHMENT0,_t.TEXTURE_CUBE_MAP_POSITIVE_X+e,n.__webglTexture,i)}else if(o){const n=$.get(t.texture);_t.framebufferTextureLayer(_t.FRAMEBUFFER,_t.COLOR_ATTACHMENT0,n.__webglTexture,i||0,e||0)}A=-1},this.readRenderTargetPixels=function(t,e,i,n,r,s,o){if(!t||!t.isWebGLRenderTarget)return;let a=$.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==o&&(a=a[o]),a){J.bindFramebuffer(_t.FRAMEBUFFER,a);try{const o=t.texture,a=o.format,l=o.type;if(a!==Mv&&ft.convert(a)!==_t.getParameter(_t.IMPLEMENTATION_COLOR_READ_FORMAT))return;const c=l===bv&&(X.has("EXT_color_buffer_half_float")||Z.isWebGL2&&X.has("EXT_color_buffer_float"));if(!(l===gv||ft.convert(l)===_t.getParameter(_t.IMPLEMENTATION_COLOR_READ_TYPE)||l===xv&&(Z.isWebGL2||X.has("OES_texture_float")||X.has("WEBGL_color_buffer_float"))||c))return;e>=0&&e<=t.width-n&&i>=0&&i<=t.height-r&&_t.readPixels(e,i,n,r,ft.convert(a),ft.convert(l),s)}finally{const t=null!==w?$.get(w).__webglFramebuffer:null;J.bindFramebuffer(_t.FRAMEBUFFER,t)}}},this.copyFramebufferToTexture=function(t,e,i=0){const n=Math.pow(2,-i),r=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n);K.setTexture2D(e,0),_t.copyTexSubImage2D(_t.TEXTURE_2D,i,0,0,t.x,t.y,r,s),J.unbindTexture()},this.copyTextureToTexture=function(t,e,i,n=0){const r=e.image.width,s=e.image.height,o=ft.convert(i.format),a=ft.convert(i.type);K.setTexture2D(i,0),_t.pixelStorei(_t.UNPACK_FLIP_Y_WEBGL,i.flipY),_t.pixelStorei(_t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),_t.pixelStorei(_t.UNPACK_ALIGNMENT,i.unpackAlignment),e.isDataTexture?_t.texSubImage2D(_t.TEXTURE_2D,n,t.x,t.y,r,s,o,a,e.image.data):e.isCompressedTexture?_t.compressedTexSubImage2D(_t.TEXTURE_2D,n,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,o,e.mipmaps[0].data):_t.texSubImage2D(_t.TEXTURE_2D,n,t.x,t.y,o,a,e.image),0===n&&i.generateMipmaps&&_t.generateMipmap(_t.TEXTURE_2D),J.unbindTexture()},this.copyTextureToTexture3D=function(t,e,i,n,r=0){if(y.isWebGL1Renderer)return;const s=t.max.x-t.min.x+1,o=t.max.y-t.min.y+1,a=t.max.z-t.min.z+1,l=ft.convert(n.format),c=ft.convert(n.type);let h;if(n.isData3DTexture)K.setTexture3D(n,0),h=_t.TEXTURE_3D;else{if(!n.isDataArrayTexture&&!n.isCompressedArrayTexture)return;K.setTexture2DArray(n,0),h=_t.TEXTURE_2D_ARRAY}_t.pixelStorei(_t.UNPACK_FLIP_Y_WEBGL,n.flipY),_t.pixelStorei(_t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),_t.pixelStorei(_t.UNPACK_ALIGNMENT,n.unpackAlignment);const u=_t.getParameter(_t.UNPACK_ROW_LENGTH),d=_t.getParameter(_t.UNPACK_IMAGE_HEIGHT),p=_t.getParameter(_t.UNPACK_SKIP_PIXELS),f=_t.getParameter(_t.UNPACK_SKIP_ROWS),m=_t.getParameter(_t.UNPACK_SKIP_IMAGES),g=i.isCompressedTexture?i.mipmaps[r]:i.image;_t.pixelStorei(_t.UNPACK_ROW_LENGTH,g.width),_t.pixelStorei(_t.UNPACK_IMAGE_HEIGHT,g.height),_t.pixelStorei(_t.UNPACK_SKIP_PIXELS,t.min.x),_t.pixelStorei(_t.UNPACK_SKIP_ROWS,t.min.y),_t.pixelStorei(_t.UNPACK_SKIP_IMAGES,t.min.z),i.isDataTexture||i.isData3DTexture?_t.texSubImage3D(h,r,e.x,e.y,e.z,s,o,a,l,c,g.data):i.isCompressedArrayTexture?_t.compressedTexSubImage3D(h,r,e.x,e.y,e.z,s,o,a,l,g.data):_t.texSubImage3D(h,r,e.x,e.y,e.z,s,o,a,l,c,g),_t.pixelStorei(_t.UNPACK_ROW_LENGTH,u),_t.pixelStorei(_t.UNPACK_IMAGE_HEIGHT,d),_t.pixelStorei(_t.UNPACK_SKIP_PIXELS,p),_t.pixelStorei(_t.UNPACK_SKIP_ROWS,f),_t.pixelStorei(_t.UNPACK_SKIP_IMAGES,m),0===r&&n.generateMipmaps&&_t.generateMipmap(h),J.unbindTexture()},this.initTexture=function(t){t.isCubeTexture?K.setTextureCube(t,0):t.isData3DTexture?K.setTexture3D(t,0):t.isDataArrayTexture||t.isCompressedArrayTexture?K.setTexture2DArray(t,0):K.setTexture2D(t,0),J.unbindTexture()},this.resetState=function(){x=0,b=0,w=null,J.reset(),mt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Lx}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(t){this._outputColorSpace=t;const e=this.getContext();e.drawingBufferColorSpace=t===bx?"display-p3":"srgb",e.unpackColorSpace=ab.workingColorSpace===wx?"display-p3":"srgb"}get outputEncoding(){return this.outputColorSpace===vx?_x:gx}set outputEncoding(t){this.outputColorSpace=t===_x?vx:xx}get useLegacyLights(){return this._useLegacyLights}set useLegacyLights(t){this._useLegacyLights=t}}class kS extends OS{}kS.prototype.isWebGL1Renderer=!0;class FS{constructor(t,e=25e-5){this.isFogExp2=!0,this.name="",this.color=new Uw(t),this.density=e}clone(){return new FS(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class zS{constructor(t,e=1,i=1e3){this.isFog=!0,this.name="",this.color=new Uw(t),this.near=e,this.far=i}clone(){return new zS(this.color,this.near,this.far)}toJSON(){return{type:"Fog",name:this.name,color:this.color.getHex(),near:this.near,far:this.far}}}class NS extends Tw{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(e.object.backgroundIntensity=this.backgroundIntensity),e}}class US{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=Cx,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.version=0,this.uuid=zx()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return ib("THREE.InterleavedBuffer: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead."),this._updateRange}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(t,e,i){t*=this.stride,i*=e.stride;for(let n=0,r=this.stride;n<r;n++)this.array[t+n]=e.array[i+n];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=zx()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const e=new this.array.constructor(t.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(e,this.stride);return i.setUsage(this.usage),i}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=zx()),void 0===t.arrayBuffers[this.array.buffer._uuid]&&(t.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const GS=new Ab;class VS{constructor(t,e,i,n=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(t){for(let e=0,i=this.data.count;e<i;e++)GS.fromBufferAttribute(this,e),GS.applyMatrix4(t),this.setXYZ(e,GS.x,GS.y,GS.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)GS.fromBufferAttribute(this,e),GS.applyNormalMatrix(t),this.setXYZ(e,GS.x,GS.y,GS.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)GS.fromBufferAttribute(this,e),GS.transformDirection(t),this.setXYZ(e,GS.x,GS.y,GS.z);return this}getComponent(t,e){let i=this.array[t*this.data.stride+this.offset+e];return this.normalized&&(i=Hx(i,this.array)),i}setComponent(t,e,i){return this.normalized&&(i=Wx(i,this.array)),this.data.array[t*this.data.stride+this.offset+e]=i,this}setX(t,e){return this.normalized&&(e=Wx(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=Wx(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=Wx(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=Wx(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return this.normalized&&(e=Hx(e,this.array)),e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return this.normalized&&(e=Hx(e,this.array)),e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return this.normalized&&(e=Hx(e,this.array)),e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return this.normalized&&(e=Hx(e,this.array)),e}setXY(t,e,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this}setXYZ(t,e,i,n){return t=t*this.data.stride+this.offset,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this}setXYZW(t,e,i,n,r){return t=t*this.data.stride+this.offset,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array),r=Wx(r,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=n,this.data.array[t+3]=r,this}clone(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return new Kw(new this.array.constructor(t),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new VS(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(t){if(void 0===t){const t=[];for(let e=0;e<this.count;e++){const i=e*this.data.stride+this.offset;for(let e=0;e<this.itemSize;e++)t.push(this.data.array[i+e])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class jS extends jw{constructor(t){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Uw(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}let HS;const WS=new Ab,qS=new Ab,XS=new Ab,ZS=new Xx,JS=new Xx,YS=new Qb,$S=new Ab,KS=new Ab,QS=new Ab,tE=new Xx,eE=new Xx,iE=new Xx;class nE extends Tw{constructor(t=new jS){if(super(),this.isSprite=!0,this.type="Sprite",void 0===HS){HS=new cA;const t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),e=new US(t,5);HS.setIndex([0,1,2,0,2,3]),HS.setAttribute("position",new VS(e,3,0,!1)),HS.setAttribute("uv",new VS(e,2,3,!1))}this.geometry=HS,this.material=t,this.center=new Xx(.5,.5)}raycast(t,e){qS.setFromMatrixScale(this.matrixWorld),YS.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),XS.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&qS.multiplyScalar(-XS.z);const i=this.material.rotation;let n,r;0!==i&&(r=Math.cos(i),n=Math.sin(i));const s=this.center;rE($S.set(-.5,-.5,0),XS,s,qS,n,r),rE(KS.set(.5,-.5,0),XS,s,qS,n,r),rE(QS.set(.5,.5,0),XS,s,qS,n,r),tE.set(0,0),eE.set(1,0),iE.set(1,1);let o=t.ray.intersectTriangle($S,KS,QS,!1,WS);if(null===o&&(rE(KS.set(-.5,.5,0),XS,s,qS,n,r),eE.set(0,1),o=t.ray.intersectTriangle($S,QS,KS,!1,WS),null===o))return;const a=t.ray.origin.distanceTo(WS);a<t.near||a>t.far||e.push({distance:a,point:WS.clone(),uv:Ow.getInterpolation(WS,$S,KS,QS,tE,eE,iE,new Xx),face:null,object:this})}copy(t,e){return super.copy(t,e),void 0!==t.center&&this.center.copy(t.center),this.material=t.material,this}}function rE(t,e,i,n,r,s){ZS.subVectors(t,i).addScalar(.5).multiply(n),void 0!==r?(JS.x=s*ZS.x-r*ZS.y,JS.y=r*ZS.x+s*ZS.y):JS.copy(ZS),t.copy(e),t.x+=JS.x,t.y+=JS.y,t.applyMatrix4(YS)}const sE=new Ab,oE=new Ab;class aE extends Tw{constructor(){super(),this._currentLevel=0,this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]},isLOD:{value:!0}}),this.autoUpdate=!0}copy(t){super.copy(t,!1);const e=t.levels;for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addLevel(i.object.clone(),i.distance,i.hysteresis)}return this.autoUpdate=t.autoUpdate,this}addLevel(t,e=0,i=0){e=Math.abs(e);const n=this.levels;let r;for(r=0;r<n.length&&!(e<n[r].distance);r++);return n.splice(r,0,{distance:e,hysteresis:i,object:t}),this.add(t),this}getCurrentLevel(){return this._currentLevel}getObjectForDistance(t){const e=this.levels;if(e.length>0){let i,n;for(i=1,n=e.length;i<n;i++){let n=e[i].distance;if(e[i].object.visible&&(n-=n*e[i].hysteresis),t<n)break}return e[i-1].object}return null}raycast(t,e){if(this.levels.length>0){sE.setFromMatrixPosition(this.matrixWorld);const i=t.ray.origin.distanceTo(sE);this.getObjectForDistance(i).raycast(t,e)}}update(t){const e=this.levels;if(e.length>1){sE.setFromMatrixPosition(t.matrixWorld),oE.setFromMatrixPosition(this.matrixWorld);const i=sE.distanceTo(oE)/t.zoom;let n,r;for(e[0].object.visible=!0,n=1,r=e.length;n<r;n++){let t=e[n].distance;if(e[n].object.visible&&(t-=t*e[n].hysteresis),!(i>=t))break;e[n-1].object.visible=!1,e[n].object.visible=!0}for(this._currentLevel=n-1;n<r;n++)e[n].object.visible=!1}}toJSON(t){const e=super.toJSON(t);!1===this.autoUpdate&&(e.object.autoUpdate=!1),e.object.levels=[];const i=this.levels;for(let t=0,n=i.length;t<n;t++){const n=i[t];e.object.levels.push({object:n.object.uuid,distance:n.distance,hysteresis:n.hysteresis})}return e}}const lE=new Ab,cE=new _b,hE=new _b,uE=new Ab,dE=new Qb,pE=new Ab,fE=new Hb,mE=new Qb,gE=new Kb;class _E extends EA{constructor(t,e){super(t,e),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=Qy,this.bindMatrix=new Qb,this.bindMatrixInverse=new Qb,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const t=this.geometry;null===this.boundingBox&&(this.boundingBox=new Sb),this.boundingBox.makeEmpty();const e=t.getAttribute("position");for(let t=0;t<e.count;t++)this.getVertexPosition(t,pE),this.boundingBox.expandByPoint(pE)}computeBoundingSphere(){const t=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new Hb),this.boundingSphere.makeEmpty();const e=t.getAttribute("position");for(let t=0;t<e.count;t++)this.getVertexPosition(t,pE),this.boundingSphere.expandByPoint(pE)}copy(t,e){return super.copy(t,e),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}raycast(t,e){const i=this.matrixWorld;void 0!==this.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),fE.copy(this.boundingSphere),fE.applyMatrix4(i),!1!==t.ray.intersectsSphere(fE)&&(mE.copy(i).invert(),gE.copy(t.ray).applyMatrix4(mE),null!==this.boundingBox&&!1===gE.intersectsBox(this.boundingBox)||this._computeIntersections(t,e,gE)))}getVertexPosition(t,e){return super.getVertexPosition(t,e),this.applyBoneTransform(t,e),e}bind(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const t=new _b,e=this.geometry.attributes.skinWeight;for(let i=0,n=e.count;i<n;i++){t.fromBufferAttribute(e,i);const n=1/t.manhattanLength();n!==1/0?t.multiplyScalar(n):t.set(1,0,0,0),e.setXYZW(i,t.x,t.y,t.z,t.w)}}updateMatrixWorld(t){super.updateMatrixWorld(t),this.bindMode===Qy?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===tv&&this.bindMatrixInverse.copy(this.bindMatrix).invert()}applyBoneTransform(t,e){const i=this.skeleton,n=this.geometry;cE.fromBufferAttribute(n.attributes.skinIndex,t),hE.fromBufferAttribute(n.attributes.skinWeight,t),lE.copy(e).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let t=0;t<4;t++){const n=hE.getComponent(t);if(0!==n){const r=cE.getComponent(t);dE.multiplyMatrices(i.bones[r].matrixWorld,i.boneInverses[r]),e.addScaledVector(uE.copy(lE).applyMatrix4(dE),n)}}return e.applyMatrix4(this.bindMatrixInverse)}}class yE extends Tw{constructor(){super(),this.isBone=!0,this.type="Bone"}}class vE extends gb{constructor(t=null,e=1,i=1,n,r,s,o,a,l=1003,c=1003,h,u){super(null,s,o,a,l,c,n,r,h,u),this.isDataTexture=!0,this.image={data:t,width:e,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const xE=new Qb,bE=new Qb;class wE{constructor(t=[],e=[]){this.uuid=zx(),this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const t=this.bones,e=this.boneInverses;if(this.boneMatrices=new Float32Array(16*t.length),0===e.length)this.calculateInverses();else if(t.length!==e.length){this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new Qb)}}calculateInverses(){this.boneInverses.length=0;for(let t=0,e=this.bones.length;t<e;t++){const e=new Qb;this.bones[t]&&e.copy(this.bones[t].matrixWorld).invert(),this.boneInverses.push(e)}}pose(){for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&e.matrixWorld.copy(this.boneInverses[t]).invert()}for(let t=0,e=this.bones.length;t<e;t++){const e=this.bones[t];e&&(e.parent&&e.parent.isBone?(e.matrix.copy(e.parent.matrixWorld).invert(),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))}}update(){const t=this.bones,e=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let n=0,r=t.length;n<r;n++){xE.multiplyMatrices(t[n]?t[n].matrixWorld:bE,e[n]),xE.toArray(i,16*n)}null!==n&&(n.needsUpdate=!0)}clone(){return new wE(this.bones,this.boneInverses)}computeBoneTexture(){let t=Math.sqrt(4*this.bones.length);t=4*Math.ceil(t/4),t=Math.max(t,4);const e=new Float32Array(t*t*4);e.set(this.boneMatrices);const i=new vE(e,t,t,Mv,xv);return i.needsUpdate=!0,this.boneMatrices=e,this.boneTexture=i,this}getBoneByName(t){for(let e=0,i=this.bones.length;e<i;e++){const i=this.bones[e];if(i.name===t)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(t,e){this.uuid=t.uuid;for(let i=0,n=t.bones.length;i<n;i++){let n=e[t.bones[i]];void 0===n&&(n=new yE),this.bones.push(n),this.boneInverses.push((new Qb).fromArray(t.boneInverses[i]))}return this.init(),this}toJSON(){const t={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};t.uuid=this.uuid;const e=this.bones,i=this.boneInverses;for(let n=0,r=e.length;n<r;n++){t.bones.push(e[n].uuid);t.boneInverses.push(i[n].toArray())}return t}}class AE extends Kw{constructor(t,e,i,n=1){super(t,e,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const TE=new Qb,ME=new Qb,SE=[],EE=new Sb,CE=new Qb,IE=new EA,PE=new Hb;class LE extends EA{constructor(t,e,i){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new AE(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let t=0;t<i;t++)this.setMatrixAt(t,CE)}computeBoundingBox(){const t=this.geometry,e=this.count;null===this.boundingBox&&(this.boundingBox=new Sb),null===t.boundingBox&&t.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,TE),EE.copy(t.boundingBox).applyMatrix4(TE),this.boundingBox.union(EE)}computeBoundingSphere(){const t=this.geometry,e=this.count;null===this.boundingSphere&&(this.boundingSphere=new Hb),null===t.boundingSphere&&t.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,TE),PE.copy(t.boundingSphere).applyMatrix4(TE),this.boundingSphere.union(PE)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,3*t)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,16*t)}raycast(t,e){const i=this.matrixWorld,n=this.count;if(IE.geometry=this.geometry,IE.material=this.material,void 0!==IE.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),PE.copy(this.boundingSphere),PE.applyMatrix4(i),!1!==t.ray.intersectsSphere(PE)))for(let r=0;r<n;r++){this.getMatrixAt(r,TE),ME.multiplyMatrices(i,TE),IE.matrixWorld=ME,IE.raycast(t,SE);for(let t=0,i=SE.length;t<i;t++){const i=SE[t];i.instanceId=r,i.object=this,e.push(i)}SE.length=0}}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new AE(new Float32Array(3*this.instanceMatrix.count),3)),e.toArray(this.instanceColor.array,3*t)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,16*t)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}function RE(t,e){return t.z-e.z}function BE(t,e){return e.z-t.z}class DE{constructor(){this.index=0,this.pool=[],this.list=[]}push(t,e){const i=this.pool,n=this.list;this.index>=i.length&&i.push({start:-1,count:-1,z:-1});const r=i[this.index];n.push(r),this.index++,r.start=t.start,r.count=t.count,r.z=e}reset(){this.list.length=0,this.index=0}}const OE="batchId",kE=new Qb,FE=new Qb,zE=new Qb,NE=new Qb,UE=new YA,GE=new Sb,VE=new Hb,jE=new Ab,HE=new DE,WE=new EA,qE=[];function XE(t,e,i=0){const n=e.itemSize;if(t.isInterleavedBufferAttribute||t.array.constructor!==e.array.constructor){const r=t.count;for(let s=0;s<r;s++)for(let r=0;r<n;r++)e.setComponent(s+i,r,t.getComponent(s,r))}else e.array.set(t.array,i*n);e.needsUpdate=!0}class ZE extends EA{get maxGeometryCount(){return this._maxGeometryCount}constructor(t,e,i=2*e,n){super(new cA,n),this.isBatchedMesh=!0,this.perObjectFrustumCulled=!0,this.sortObjects=!0,this.boundingBox=null,this.boundingSphere=null,this.customSort=null,this._drawRanges=[],this._reservedRanges=[],this._visibility=[],this._active=[],this._bounds=[],this._maxGeometryCount=t,this._maxVertexCount=e,this._maxIndexCount=i,this._geometryInitialized=!1,this._geometryCount=0,this._multiDrawCounts=new Int32Array(t),this._multiDrawStarts=new Int32Array(t),this._multiDrawCount=0,this._visibilityChanged=!0,this._matricesTexture=null,this._initMatricesTexture()}_initMatricesTexture(){let t=Math.sqrt(4*this._maxGeometryCount);t=4*Math.ceil(t/4),t=Math.max(t,4);const e=new Float32Array(t*t*4),i=new vE(e,t,t,Mv,xv);this._matricesTexture=i}_initializeGeometry(t){const e=this.geometry,i=this._maxVertexCount,n=this._maxGeometryCount,r=this._maxIndexCount;if(!1===this._geometryInitialized){for(const n in t.attributes){const r=t.getAttribute(n),{array:s,itemSize:o,normalized:a}=r,l=new s.constructor(i*o),c=new r.constructor(l,o,a);c.setUsage(r.usage),e.setAttribute(n,c)}if(null!==t.getIndex()){const t=i>65536?new Uint32Array(r):new Uint16Array(r);e.setIndex(new Kw(t,1))}const s=n>65536?new Uint32Array(i):new Uint16Array(i);e.setAttribute(OE,new Kw(s,1)),this._geometryInitialized=!0}}_validateGeometry(t){if(t.getAttribute(OE))throw new Error(`BatchedMesh: Geometry cannot use attribute "${OE}"`);const e=this.geometry;if(Boolean(t.getIndex())!==Boolean(e.getIndex()))throw new Error('BatchedMesh: All geometries must consistently have "index".');for(const i in e.attributes){if(i===OE)continue;if(!t.hasAttribute(i))throw new Error(`BatchedMesh: Added geometry missing "${i}". All geometries must have consistent attributes.`);const n=t.getAttribute(i),r=e.getAttribute(i);if(n.itemSize!==r.itemSize||n.normalized!==r.normalized)throw new Error("BatchedMesh: All attributes must have a consistent itemSize and normalized value.")}}setCustomSort(t){return this.customSort=t,this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Sb);const t=this._geometryCount,e=this.boundingBox,i=this._active;e.makeEmpty();for(let n=0;n<t;n++)!1!==i[n]&&(this.getMatrixAt(n,kE),this.getBoundingBoxAt(n,GE).applyMatrix4(kE),e.union(GE))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Hb);const t=this._geometryCount,e=this.boundingSphere,i=this._active;e.makeEmpty();for(let n=0;n<t;n++)!1!==i[n]&&(this.getMatrixAt(n,kE),this.getBoundingSphereAt(n,VE).applyMatrix4(kE),e.union(VE))}addGeometry(t,e=-1,i=-1){if(this._initializeGeometry(t),this._validateGeometry(t),this._geometryCount>=this._maxGeometryCount)throw new Error("BatchedMesh: Maximum geometry count reached.");const n={vertexStart:-1,vertexCount:-1,indexStart:-1,indexCount:-1};let r=null;const s=this._reservedRanges,o=this._drawRanges,a=this._bounds;0!==this._geometryCount&&(r=s[s.length-1]),n.vertexCount=-1===e?t.getAttribute("position").count:e,n.vertexStart=null===r?0:r.vertexStart+r.vertexCount;const l=t.getIndex(),c=null!==l;if(c&&(n.indexCount=-1===i?l.count:i,n.indexStart=null===r?0:r.indexStart+r.indexCount),-1!==n.indexStart&&n.indexStart+n.indexCount>this._maxIndexCount||n.vertexStart+n.vertexCount>this._maxVertexCount)throw new Error("BatchedMesh: Reserved space request exceeds the maximum buffer size.");const h=this._active,u=this._matricesTexture,d=this._matricesTexture.image.data;this._visibility.push(!0),h.push(!0);const p=this._geometryCount;this._geometryCount++,zE.toArray(d,16*p),u.needsUpdate=!0,s.push(n),o.push({start:c?n.indexStart:n.vertexStart,count:-1}),a.push({boxInitialized:!1,box:new Sb,sphereInitialized:!1,sphere:new Hb});const f=this.geometry.getAttribute(OE);for(let t=0;t<n.vertexCount;t++)f.setX(n.vertexStart+t,p);return f.needsUpdate=!0,this.setGeometryAt(p,t),p}setGeometryAt(t,e){if(t>=this._geometryCount)throw new Error("BatchedMesh: Maximum geometry count reached.");this._validateGeometry(e);const i=this.geometry,n=null!==i.getIndex(),r=i.getIndex(),s=e.getIndex(),o=this._reservedRanges[t];if(n&&s.count>o.indexCount||e.attributes.position.count>o.vertexCount)throw new Error("BatchedMesh: Reserved space not large enough for provided geometry.");const a=o.vertexStart,l=o.vertexCount;for(const t in i.attributes){if(t===OE)continue;const n=e.getAttribute(t),r=i.getAttribute(t);XE(n,r,a);const s=n.itemSize;for(let t=n.count,e=l;t<e;t++){const e=a+t;for(let t=0;t<s;t++)r.setComponent(e,t,0)}r.needsUpdate=!0}if(n){const t=o.indexStart;for(let e=0;e<s.count;e++)r.setX(t+e,a+s.getX(e));for(let e=s.count,i=o.indexCount;e<i;e++)r.setX(t+e,a);r.needsUpdate=!0}const c=this._bounds[t];null!==e.boundingBox?(c.box.copy(e.boundingBox),c.boxInitialized=!0):c.boxInitialized=!1,null!==e.boundingSphere?(c.sphere.copy(e.boundingSphere),c.sphereInitialized=!0):c.sphereInitialized=!1;const h=this._drawRanges[t],u=e.getAttribute("position");return h.count=n?s.count:u.count,this._visibilityChanged=!0,t}deleteGeometry(t){const e=this._active;return t>=e.length||!1===e[t]||(e[t]=!1,this._visibilityChanged=!0),this}getBoundingBoxAt(t,e){if(!1===this._active[t])return null;const i=this._bounds[t],n=i.box,r=this.geometry;if(!1===i.boxInitialized){n.makeEmpty();const e=r.index,s=r.attributes.position,o=this._drawRanges[t];for(let t=o.start,i=o.start+o.count;t<i;t++){let i=t;e&&(i=e.getX(i)),n.expandByPoint(jE.fromBufferAttribute(s,i))}i.boxInitialized=!0}return e.copy(n),e}getBoundingSphereAt(t,e){if(!1===this._active[t])return null;const i=this._bounds[t],n=i.sphere,r=this.geometry;if(!1===i.sphereInitialized){n.makeEmpty(),this.getBoundingBoxAt(t,GE),GE.getCenter(n.center);const e=r.index,s=r.attributes.position,o=this._drawRanges[t];let a=0;for(let t=o.start,i=o.start+o.count;t<i;t++){let i=t;e&&(i=e.getX(i)),jE.fromBufferAttribute(s,i),a=Math.max(a,n.center.distanceToSquared(jE))}n.radius=Math.sqrt(a),i.sphereInitialized=!0}return e.copy(n),e}setMatrixAt(t,e){const i=this._matricesTexture;return t>=this._geometryCount||!1===this._active[t]||(e.toArray(this._matricesTexture.image.data,16*t),i.needsUpdate=!0),this}getMatrixAt(t,e){return t>=this._geometryCount||!1===this._active[t]?null:e.fromArray(this._matricesTexture.image.data,16*t)}setVisibleAt(t,e){const i=this._visibility;return t>=this._geometryCount||!1===this._active[t]||i[t]===e||(i[t]=e,this._visibilityChanged=!0),this}getVisibleAt(t){return!(t>=this._geometryCount||!1===this._active[t])&&this._visibility[t]}raycast(t,e){const i=this._visibility,n=this._active,r=this._drawRanges,s=this._geometryCount,o=this.matrixWorld,a=this.geometry;WE.material=this.material,WE.geometry.index=a.index,WE.geometry.attributes=a.attributes,null===WE.geometry.boundingBox&&(WE.geometry.boundingBox=new Sb),null===WE.geometry.boundingSphere&&(WE.geometry.boundingSphere=new Hb);for(let a=0;a<s;a++){if(!i[a]||!n[a])continue;const s=r[a];WE.geometry.setDrawRange(s.start,s.count),this.getMatrixAt(a,WE.matrixWorld).premultiply(o),this.getBoundingBoxAt(a,WE.geometry.boundingBox),this.getBoundingSphereAt(a,WE.geometry.boundingSphere),WE.raycast(t,qE);for(let t=0,i=qE.length;t<i;t++){const i=qE[t];i.object=this,i.batchId=a,e.push(i)}qE.length=0}WE.material=null,WE.geometry.index=null,WE.geometry.attributes={},WE.geometry.setDrawRange(0,1/0)}copy(t){return super.copy(t),this.geometry=t.geometry.clone(),this.perObjectFrustumCulled=t.perObjectFrustumCulled,this.sortObjects=t.sortObjects,this.boundingBox=null!==t.boundingBox?t.boundingBox.clone():null,this.boundingSphere=null!==t.boundingSphere?t.boundingSphere.clone():null,this._drawRanges=t._drawRanges.map((t=>({...t}))),this._reservedRanges=t._reservedRanges.map((t=>({...t}))),this._visibility=t._visibility.slice(),this._active=t._active.slice(),this._bounds=t._bounds.map((t=>({boxInitialized:t.boxInitialized,box:t.box.clone(),sphereInitialized:t.sphereInitialized,sphere:t.sphere.clone()}))),this._maxGeometryCount=t._maxGeometryCount,this._maxVertexCount=t._maxVertexCount,this._maxIndexCount=t._maxIndexCount,this._geometryInitialized=t._geometryInitialized,this._geometryCount=t._geometryCount,this._multiDrawCounts=t._multiDrawCounts.slice(),this._multiDrawStarts=t._multiDrawStarts.slice(),this._matricesTexture=t._matricesTexture.clone(),this._matricesTexture.image.data=this._matricesTexture.image.slice(),this}dispose(){return this.geometry.dispose(),this._matricesTexture.dispose(),this._matricesTexture=null,this}onBeforeRender(t,e,i,n,r){if(!this._visibilityChanged&&!this.perObjectFrustumCulled&&!this.sortObjects)return;const s=n.getIndex(),o=null===s?1:s.array.BYTES_PER_ELEMENT,a=this._active,l=this._visibility,c=this._multiDrawStarts,h=this._multiDrawCounts,u=this._drawRanges,d=this.perObjectFrustumCulled;d&&(NE.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse).multiply(this.matrixWorld),UE.setFromProjectionMatrix(NE,t.coordinateSystem));let p=0;if(this.sortObjects){FE.copy(this.matrixWorld).invert(),jE.setFromMatrixPosition(i.matrixWorld).applyMatrix4(FE);for(let t=0,e=l.length;t<e;t++)if(l[t]&&a[t]){this.getMatrixAt(t,kE),this.getBoundingSphereAt(t,VE).applyMatrix4(kE);let e=!1;if(d&&(e=!UE.intersectsSphere(VE)),!e){const e=jE.distanceTo(VE.center);HE.push(u[t],e)}}const t=HE.list,e=this.customSort;null===e?t.sort(r.transparent?BE:RE):e.call(this,t,i);for(let e=0,i=t.length;e<i;e++){const i=t[e];c[p]=i.start*o,h[p]=i.count,p++}HE.reset()}else for(let t=0,e=l.length;t<e;t++)if(l[t]&&a[t]){let e=!1;if(d&&(this.getMatrixAt(t,kE),this.getBoundingSphereAt(t,VE).applyMatrix4(kE),e=!UE.intersectsSphere(VE)),!e){const e=u[t];c[p]=e.start*o,h[p]=e.count,p++}}this._multiDrawCount=p,this._visibilityChanged=!1}onBeforeShadow(t,e,i,n,r,s){this.onBeforeRender(t,null,n,r,s)}}class JE extends jw{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Uw(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const YE=new Ab,$E=new Ab,KE=new Qb,QE=new Kb,tC=new Hb;class eC extends Tw{constructor(t=new cA,e=new JE){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)YE.fromBufferAttribute(e,t-1),$E.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=YE.distanceTo($E);t.setAttribute("lineDistance",new eA(i,1))}return this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Line.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),tC.copy(i.boundingSphere),tC.applyMatrix4(n),tC.radius+=r,!1===t.ray.intersectsSphere(tC))return;KE.copy(n).invert(),QE.copy(t.ray).applyMatrix4(KE);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,l=new Ab,c=new Ab,h=new Ab,u=new Ab,d=this.isLineSegments?2:1,p=i.index,f=i.attributes.position;if(null!==p){for(let i=Math.max(0,s.start),n=Math.min(p.count,s.start+s.count)-1;i<n;i+=d){const n=p.getX(i),r=p.getX(i+1);l.fromBufferAttribute(f,n),c.fromBufferAttribute(f,r);if(QE.distanceSqToSegment(l,c,u,h)>a)continue;u.applyMatrix4(this.matrixWorld);const s=t.ray.origin.distanceTo(u);s<t.near||s>t.far||e.push({distance:s,point:h.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,s.start),n=Math.min(f.count,s.start+s.count)-1;i<n;i+=d){l.fromBufferAttribute(f,i),c.fromBufferAttribute(f,i+1);if(QE.distanceSqToSegment(l,c,u,h)>a)continue;u.applyMatrix4(this.matrixWorld);const n=t.ray.origin.distanceTo(u);n<t.near||n>t.far||e.push({distance:n,point:h.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}const iC=new Ab,nC=new Ab;class rC extends eC{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)iC.fromBufferAttribute(e,t),nC.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+iC.distanceTo(nC);t.setAttribute("lineDistance",new eA(i,1))}return this}}class sC extends eC{constructor(t,e){super(t,e),this.isLineLoop=!0,this.type="LineLoop"}}class oC extends jw{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Uw(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const aC=new Qb,lC=new Kb,cC=new Hb,hC=new Ab;class uC extends Tw{constructor(t=new cA,e=new oC){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,r=t.params.Points.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),cC.copy(i.boundingSphere),cC.applyMatrix4(n),cC.radius+=r,!1===t.ray.intersectsSphere(cC))return;aC.copy(n).invert(),lC.copy(t.ray).applyMatrix4(aC);const o=r/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,l=i.index,c=i.attributes.position;if(null!==l){for(let i=Math.max(0,s.start),r=Math.min(l.count,s.start+s.count);i<r;i++){const r=l.getX(i);hC.fromBufferAttribute(c,r),dC(hC,r,a,n,t,e,this)}}else{for(let i=Math.max(0,s.start),r=Math.min(c.count,s.start+s.count);i<r;i++)hC.fromBufferAttribute(c,i),dC(hC,i,a,n,t,e,this)}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}function dC(t,e,i,n,r,s,o){const a=lC.distanceSqToPoint(t);if(a<i){const i=new Ab;lC.closestPointToPoint(t,i),i.applyMatrix4(n);const l=r.ray.origin.distanceTo(i);if(l<r.near||l>r.far)return;s.push({distance:l,distanceToRay:Math.sqrt(a),point:i,index:e,face:null,object:o})}}class pC extends gb{constructor(t,e,i,n,r,s,o,a,l,c,h,u){super(null,s,o,a,l,c,n,r,h,u),this.isCompressedTexture=!0,this.image={width:e,height:i},this.mipmaps=t,this.flipY=!1,this.generateMipmaps=!1}}class fC{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return null}getPointAt(t,e){const i=this.getUtoTmapping(t);return this.getPoint(i,e)}getPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return e}getSpacedPoints(t=5){const e=[];for(let i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e}getLength(){const t=this.getLengths();return t[t.length-1]}getLengths(t=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const e=[];let i,n=this.getPoint(0),r=0;e.push(0);for(let s=1;s<=t;s++)i=this.getPoint(s/t),r+=i.distanceTo(n),e.push(r),n=i;return this.cacheArcLengths=e,e}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(t,e){const i=this.getLengths();let n=0;const r=i.length;let s;s=e||t*i[r-1];let o,a=0,l=r-1;for(;a<=l;)if(n=Math.floor(a+(l-a)/2),o=i[n]-s,o<0)a=n+1;else{if(!(o>0)){l=n;break}l=n-1}if(n=l,i[n]===s)return n/(r-1);const c=i[n];return(n+(s-c)/(i[n+1]-c))/(r-1)}getTangent(t,e){const i=1e-4;let n=t-i,r=t+i;n<0&&(n=0),r>1&&(r=1);const s=this.getPoint(n),o=this.getPoint(r),a=e||(s.isVector2?new Xx:new Ab);return a.copy(o).sub(s).normalize(),a}getTangentAt(t,e){const i=this.getUtoTmapping(t);return this.getTangent(i,e)}computeFrenetFrames(t,e){const i=new Ab,n=[],r=[],s=[],o=new Ab,a=new Qb;for(let e=0;e<=t;e++){n[e]=this.getTangentAt(e/t,new Ab)}r[0]=new Ab,s[0]=new Ab;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),h=Math.abs(n[0].y),u=Math.abs(n[0].z);c<=l&&(l=c,i.set(1,0,0)),h<=l&&(l=h,i.set(0,1,0)),u<=l&&i.set(0,0,1),o.crossVectors(n[0],i).normalize(),r[0].crossVectors(n[0],o),s[0].crossVectors(n[0],r[0]);for(let e=1;e<=t;e++){if(r[e]=r[e-1].clone(),s[e]=s[e-1].clone(),o.crossVectors(n[e-1],n[e]),o.length()>Number.EPSILON){o.normalize();const t=Math.acos(Nx(n[e-1].dot(n[e]),-1,1));r[e].applyMatrix4(a.makeRotationAxis(o,t))}s[e].crossVectors(n[e],r[e])}if(!0===e){let e=Math.acos(Nx(r[0].dot(r[t]),-1,1));e/=t,n[0].dot(o.crossVectors(r[0],r[t]))>0&&(e=-e);for(let i=1;i<=t;i++)r[i].applyMatrix4(a.makeRotationAxis(n[i],e*i)),s[i].crossVectors(n[i],r[i])}return{tangents:n,normals:r,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){const t={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class mC extends fC{constructor(t=0,e=0,i=1,n=1,r=0,s=2*Math.PI,o=!1,a=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=i,this.yRadius=n,this.aStartAngle=r,this.aEndAngle=s,this.aClockwise=o,this.aRotation=a}getPoint(t,e){const i=e||new Xx,n=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const s=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=n;for(;r>n;)r-=n;r<Number.EPSILON&&(r=s?0:n),!0!==this.aClockwise||s||(r===n?r=-n:r-=n);const o=this.aStartAngle+t*r;let a=this.aX+this.xRadius*Math.cos(o),l=this.aY+this.yRadius*Math.sin(o);if(0!==this.aRotation){const t=Math.cos(this.aRotation),e=Math.sin(this.aRotation),i=a-this.aX,n=l-this.aY;a=i*t-n*e+this.aX,l=i*e+n*t+this.aY}return i.set(a,l)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){const t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}class gC extends mC{constructor(t,e,i,n,r,s){super(t,e,i,i,n,r,s),this.isArcCurve=!0,this.type="ArcCurve"}}function _C(){let t=0,e=0,i=0,n=0;function r(r,s,o,a){t=r,e=o,i=-3*r+3*s-2*o-a,n=2*r-2*s+o+a}return{initCatmullRom:function(t,e,i,n,s){r(e,i,s*(i-t),s*(n-e))},initNonuniformCatmullRom:function(t,e,i,n,s,o,a){let l=(e-t)/s-(i-t)/(s+o)+(i-e)/o,c=(i-e)/o-(n-e)/(o+a)+(n-i)/a;l*=o,c*=o,r(e,i,l,c)},calc:function(r){const s=r*r;return t+e*r+i*s+n*(s*r)}}}const yC=new Ab,vC=new _C,xC=new _C,bC=new _C;class wC extends fC{constructor(t=[],e=!1,i="centripetal",n=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=n}getPoint(t,e=new Ab){const i=e,n=this.points,r=n.length,s=(r-(this.closed?0:1))*t;let o,a,l=Math.floor(s),c=s-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===c&&l===r-1&&(l=r-2,c=1),this.closed||l>0?o=n[(l-1)%r]:(yC.subVectors(n[0],n[1]).add(n[0]),o=yC);const h=n[l%r],u=n[(l+1)%r];if(this.closed||l+2<r?a=n[(l+2)%r]:(yC.subVectors(n[r-1],n[r-2]).add(n[r-1]),a=yC),"centripetal"===this.curveType||"chordal"===this.curveType){const t="chordal"===this.curveType?.5:.25;let e=Math.pow(o.distanceToSquared(h),t),i=Math.pow(h.distanceToSquared(u),t),n=Math.pow(u.distanceToSquared(a),t);i<1e-4&&(i=1),e<1e-4&&(e=i),n<1e-4&&(n=i),vC.initNonuniformCatmullRom(o.x,h.x,u.x,a.x,e,i,n),xC.initNonuniformCatmullRom(o.y,h.y,u.y,a.y,e,i,n),bC.initNonuniformCatmullRom(o.z,h.z,u.z,a.z,e,i,n)}else"catmullrom"===this.curveType&&(vC.initCatmullRom(o.x,h.x,u.x,a.x,this.tension),xC.initCatmullRom(o.y,h.y,u.y,a.y,this.tension),bC.initCatmullRom(o.z,h.z,u.z,a.z,this.tension));return i.set(vC.calc(c),xC.calc(c),bC.calc(c)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){this.points.push(t.points[e].clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){t.points.push(this.points[e].toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new Ab).fromArray(i))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this}}function AC(t,e,i,n,r){const s=.5*(n-e),o=.5*(r-i),a=t*t;return(2*i-2*n+s+o)*(t*a)+(-3*i+3*n-2*s-o)*a+s*t+i}function TC(t,e,i,n){return function(t,e){const i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,n)}function MC(t,e,i,n,r){return function(t,e){const i=1-t;return i*i*i*e}(t,e)+function(t,e){const i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,n)+function(t,e){return t*t*t*e}(t,r)}class SC extends fC{constructor(t=new Xx,e=new Xx,i=new Xx,n=new Xx){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new Xx){const i=e,n=this.v0,r=this.v1,s=this.v2,o=this.v3;return i.set(MC(t,n.x,r.x,s.x,o.x),MC(t,n.y,r.y,s.y,o.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class EC extends fC{constructor(t=new Ab,e=new Ab,i=new Ab,n=new Ab){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=n}getPoint(t,e=new Ab){const i=e,n=this.v0,r=this.v1,s=this.v2,o=this.v3;return i.set(MC(t,n.x,r.x,s.x,o.x),MC(t,n.y,r.y,s.y,o.y),MC(t,n.z,r.z,s.z,o.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class CC extends fC{constructor(t=new Xx,e=new Xx){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new Xx){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new Xx){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class IC extends fC{constructor(t=new Ab,e=new Ab){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new Ab){const i=e;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new Ab){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class PC extends fC{constructor(t=new Xx,e=new Xx,i=new Xx){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new Xx){const i=e,n=this.v0,r=this.v1,s=this.v2;return i.set(TC(t,n.x,r.x,s.x),TC(t,n.y,r.y,s.y)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class LC extends fC{constructor(t=new Ab,e=new Ab,i=new Ab){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new Ab){const i=e,n=this.v0,r=this.v1,s=this.v2;return i.set(TC(t,n.x,r.x,s.x),TC(t,n.y,r.y,s.y),TC(t,n.z,r.z,s.z)),i}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){const t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class RC extends fC{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new Xx){const i=e,n=this.points,r=(n.length-1)*t,s=Math.floor(r),o=r-s,a=n[0===s?s:s-1],l=n[s],c=n[s>n.length-2?n.length-1:s+1],h=n[s>n.length-3?n.length-1:s+2];return i.set(AC(o,a.x,l.x,c.x,h.x),AC(o,a.y,l.y,c.y,h.y)),i}copy(t){super.copy(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){this.points.push(t.points[e].clone())}return this}toJSON(){const t=super.toJSON();t.points=[];for(let e=0,i=this.points.length;e<i;e++){t.points.push(this.points[e].toArray())}return t}fromJSON(t){super.fromJSON(t),this.points=[];for(let e=0,i=t.points.length;e<i;e++){const i=t.points[e];this.points.push((new Xx).fromArray(i))}return this}}var BC=Object.freeze({__proto__:null,ArcCurve:gC,CatmullRomCurve3:wC,CubicBezierCurve:SC,CubicBezierCurve3:EC,EllipseCurve:mC,LineCurve:CC,LineCurve3:IC,QuadraticBezierCurve:PC,QuadraticBezierCurve3:LC,SplineCurve:RC});class DC extends fC{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(t){this.curves.push(t)}closePath(){const t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);if(!t.equals(e)){this.curves.push(new BC[!0===t.isVector2?"LineCurve":"LineCurve3"](e,t))}return this}getPoint(t,e){const i=t*this.getLength(),n=this.getCurveLengths();let r=0;for(;r<n.length;){if(n[r]>=i){const t=n[r]-i,s=this.curves[r],o=s.getLength();return s.getPointAt(0===o?0:1-t/o,e)}r++}return null}getLength(){const t=this.getCurveLengths();return t[t.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const t=[];let e=0;for(let i=0,n=this.curves.length;i<n;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t}getSpacedPoints(t=40){const e=[];for(let i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e}getPoints(t=12){const e=[];let i;for(let n=0,r=this.curves;n<r.length;n++){const s=r[n],o=s.getPoints(s.isEllipseCurve?2*t:s.isLineCurve||s.isLineCurve3?1:s.isSplineCurve?t*s.points.length:t);for(let t=0;t<o.length;t++){const n=o[t];i&&i.equals(n)||(e.push(n),i=n)}}return this.autoClose&&e.length>1&&!e[e.length-1].equals(e[0])&&e.push(e[0]),e}copy(t){super.copy(t),this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){this.curves.push(t.curves[e].clone())}return this.autoClose=t.autoClose,this}toJSON(){const t=super.toJSON();t.autoClose=this.autoClose,t.curves=[];for(let e=0,i=this.curves.length;e<i;e++){t.curves.push(this.curves[e].toJSON())}return t}fromJSON(t){super.fromJSON(t),this.autoClose=t.autoClose,this.curves=[];for(let e=0,i=t.curves.length;e<i;e++){const i=t.curves[e];this.curves.push((new BC[i.type]).fromJSON(i))}return this}}class OC extends DC{constructor(t){super(),this.type="Path",this.currentPoint=new Xx,t&&this.setFromPoints(t)}setFromPoints(t){this.moveTo(t[0].x,t[0].y);for(let e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y);return this}moveTo(t,e){return this.currentPoint.set(t,e),this}lineTo(t,e){const i=new CC(this.currentPoint.clone(),new Xx(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this}quadraticCurveTo(t,e,i,n){const r=new PC(this.currentPoint.clone(),new Xx(t,e),new Xx(i,n));return this.curves.push(r),this.currentPoint.set(i,n),this}bezierCurveTo(t,e,i,n,r,s){const o=new SC(this.currentPoint.clone(),new Xx(t,e),new Xx(i,n),new Xx(r,s));return this.curves.push(o),this.currentPoint.set(r,s),this}splineThru(t){const e=[this.currentPoint.clone()].concat(t),i=new RC(e);return this.curves.push(i),this.currentPoint.copy(t[t.length-1]),this}arc(t,e,i,n,r,s){return this.absarc(t+this.currentPoint.x,e+this.currentPoint.y,i,n,r,s),this}absarc(t,e,i,n,r,s){return this.absellipse(t,e,i,i,n,r,s),this}ellipse(t,e,i,n,r,s,o,a){return this.absellipse(t+this.currentPoint.x,e+this.currentPoint.y,i,n,r,s,o,a),this}absellipse(t,e,i,n,r,s,o,a){const l=new mC(t,e,i,n,r,s,o,a);if(this.curves.length>0){const t=l.getPoint(0);t.equals(this.currentPoint)||this.lineTo(t.x,t.y)}this.curves.push(l);const c=l.getPoint(1);return this.currentPoint.copy(c),this}copy(t){return super.copy(t),this.currentPoint.copy(t.currentPoint),this}toJSON(){const t=super.toJSON();return t.currentPoint=this.currentPoint.toArray(),t}fromJSON(t){return super.fromJSON(t),this.currentPoint.fromArray(t.currentPoint),this}}class kC extends cA{constructor(t=[new Xx(0,-.5),new Xx(.5,0),new Xx(0,.5)],e=12,i=0,n=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:n},e=Math.floor(e),n=Nx(n,0,2*Math.PI);const r=[],s=[],o=[],a=[],l=[],c=1/e,h=new Ab,u=new Xx,d=new Ab,p=new Ab,f=new Ab;let m=0,g=0;for(let e=0;e<=t.length-1;e++)switch(e){case 0:m=t[e+1].x-t[e].x,g=t[e+1].y-t[e].y,d.x=1*g,d.y=-m,d.z=0*g,f.copy(d),d.normalize(),a.push(d.x,d.y,d.z);break;case t.length-1:a.push(f.x,f.y,f.z);break;default:m=t[e+1].x-t[e].x,g=t[e+1].y-t[e].y,d.x=1*g,d.y=-m,d.z=0*g,p.copy(d),d.x+=f.x,d.y+=f.y,d.z+=f.z,d.normalize(),a.push(d.x,d.y,d.z),f.copy(p)}for(let r=0;r<=e;r++){const d=i+r*c*n,p=Math.sin(d),f=Math.cos(d);for(let i=0;i<=t.length-1;i++){h.x=t[i].x*p,h.y=t[i].y,h.z=t[i].x*f,s.push(h.x,h.y,h.z),u.x=r/e,u.y=i/(t.length-1),o.push(u.x,u.y);l.push(a[3*i+0]*p,a[3*i+1],a[3*i+0]*f)}}for(let i=0;i<e;i++)for(let e=0;e<t.length-1;e++){const n=e+i*t.length,s=n+t.length,o=n+t.length+1,a=n+1;r.push(n,s,a),r.push(o,a,s)}this.setIndex(r),this.setAttribute("position",new eA(s,3)),this.setAttribute("uv",new eA(o,2)),this.setAttribute("normal",new eA(l,3))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new kC(t.points,t.segments,t.phiStart,t.phiLength)}}class FC extends kC{constructor(t=1,e=1,i=4,n=8){const r=new OC;r.absarc(0,-e/2,t,1.5*Math.PI,0),r.absarc(0,e/2,t,0,.5*Math.PI),super(r.getPoints(i),n),this.type="CapsuleGeometry",this.parameters={radius:t,length:e,capSegments:i,radialSegments:n}}static fromJSON(t){return new FC(t.radius,t.length,t.capSegments,t.radialSegments)}}class zC extends cA{constructor(t=1,e=32,i=0,n=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:n},e=Math.max(3,e);const r=[],s=[],o=[],a=[],l=new Ab,c=new Xx;s.push(0,0,0),o.push(0,0,1),a.push(.5,.5);for(let r=0,h=3;r<=e;r++,h+=3){const u=i+r/e*n;l.x=t*Math.cos(u),l.y=t*Math.sin(u),s.push(l.x,l.y,l.z),o.push(0,0,1),c.x=(s[h]/t+1)/2,c.y=(s[h+1]/t+1)/2,a.push(c.x,c.y)}for(let t=1;t<=e;t++)r.push(t,t+1,0);this.setIndex(r),this.setAttribute("position",new eA(s,3)),this.setAttribute("normal",new eA(o,3)),this.setAttribute("uv",new eA(a,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new zC(t.radius,t.segments,t.thetaStart,t.thetaLength)}}class NC extends cA{constructor(t=1,e=1,i=1,n=32,r=1,s=!1,o=0,a=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:r,openEnded:s,thetaStart:o,thetaLength:a};const l=this;n=Math.floor(n),r=Math.floor(r);const c=[],h=[],u=[],d=[];let p=0;const f=[],m=i/2;let g=0;function _(i){const r=p,s=new Xx,f=new Ab;let _=0;const y=!0===i?t:e,v=!0===i?1:-1;for(let t=1;t<=n;t++)h.push(0,m*v,0),u.push(0,v,0),d.push(.5,.5),p++;const x=p;for(let t=0;t<=n;t++){const e=t/n*a+o,i=Math.cos(e),r=Math.sin(e);f.x=y*r,f.y=m*v,f.z=y*i,h.push(f.x,f.y,f.z),u.push(0,v,0),s.x=.5*i+.5,s.y=.5*r*v+.5,d.push(s.x,s.y),p++}for(let t=0;t<n;t++){const e=r+t,n=x+t;!0===i?c.push(n,n+1,e):c.push(n+1,n,e),_+=3}l.addGroup(g,_,!0===i?1:2),g+=_}!function(){const s=new Ab,_=new Ab;let y=0;const v=(e-t)/i;for(let l=0;l<=r;l++){const c=[],g=l/r,y=g*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,r=e*a+o,l=Math.sin(r),f=Math.cos(r);_.x=y*l,_.y=-g*i+m,_.z=y*f,h.push(_.x,_.y,_.z),s.set(l,v,f).normalize(),u.push(s.x,s.y,s.z),d.push(e,1-g),c.push(p++)}f.push(c)}for(let t=0;t<n;t++)for(let e=0;e<r;e++){const i=f[e+1][t],n=f[e+1][t+1],r=f[e][t+1];c.push(f[e][t],i,r),c.push(i,n,r),y+=6}l.addGroup(g,y,0),g+=y}(),!1===s&&(t>0&&_(!0),e>0&&_(!1)),this.setIndex(c),this.setAttribute("position",new eA(h,3)),this.setAttribute("normal",new eA(u,3)),this.setAttribute("uv",new eA(d,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new NC(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}class UC extends NC{constructor(t=1,e=1,i=32,n=1,r=!1,s=0,o=2*Math.PI){super(0,t,e,i,n,r,s,o),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:s,thetaLength:o}}static fromJSON(t){return new UC(t.radius,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}class GC extends cA{constructor(t=[],e=[],i=1,n=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:n};const r=[],s=[];function o(t,e,i,n){const r=n+1,s=[];for(let n=0;n<=r;n++){s[n]=[];const o=t.clone().lerp(i,n/r),a=e.clone().lerp(i,n/r),l=r-n;for(let t=0;t<=l;t++)s[n][t]=0===t&&n===r?o:o.clone().lerp(a,t/l)}for(let t=0;t<r;t++)for(let e=0;e<2*(r-t)-1;e++){const i=Math.floor(e/2);e%2==0?(a(s[t][i+1]),a(s[t+1][i]),a(s[t][i])):(a(s[t][i+1]),a(s[t+1][i+1]),a(s[t+1][i]))}}function a(t){r.push(t.x,t.y,t.z)}function l(e,i){const n=3*e;i.x=t[n+0],i.y=t[n+1],i.z=t[n+2]}function c(t,e,i,n){n<0&&1===t.x&&(s[e]=t.x-1),0===i.x&&0===i.z&&(s[e]=n/2/Math.PI+.5)}function h(t){return Math.atan2(t.z,-t.x)}!function(t){const i=new Ab,n=new Ab,r=new Ab;for(let s=0;s<e.length;s+=3)l(e[s+0],i),l(e[s+1],n),l(e[s+2],r),o(i,n,r,t)}(n),function(t){const e=new Ab;for(let i=0;i<r.length;i+=3)e.x=r[i+0],e.y=r[i+1],e.z=r[i+2],e.normalize().multiplyScalar(t),r[i+0]=e.x,r[i+1]=e.y,r[i+2]=e.z}(i),function(){const t=new Ab;for(let i=0;i<r.length;i+=3){t.x=r[i+0],t.y=r[i+1],t.z=r[i+2];const n=h(t)/2/Math.PI+.5,o=(e=t,Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))/Math.PI+.5);s.push(n,1-o)}var e;(function(){const t=new Ab,e=new Ab,i=new Ab,n=new Ab,o=new Xx,a=new Xx,l=new Xx;for(let u=0,d=0;u<r.length;u+=9,d+=6){t.set(r[u+0],r[u+1],r[u+2]),e.set(r[u+3],r[u+4],r[u+5]),i.set(r[u+6],r[u+7],r[u+8]),o.set(s[d+0],s[d+1]),a.set(s[d+2],s[d+3]),l.set(s[d+4],s[d+5]),n.copy(t).add(e).add(i).divideScalar(3);const p=h(n);c(o,d+0,t,p),c(a,d+2,e,p),c(l,d+4,i,p)}})(),function(){for(let t=0;t<s.length;t+=6){const e=s[t+0],i=s[t+2],n=s[t+4],r=Math.max(e,i,n),o=Math.min(e,i,n);r>.9&&o<.1&&(e<.2&&(s[t+0]+=1),i<.2&&(s[t+2]+=1),n<.2&&(s[t+4]+=1))}}()}(),this.setAttribute("position",new eA(r,3)),this.setAttribute("normal",new eA(r.slice(),3)),this.setAttribute("uv",new eA(s,2)),0===n?this.computeVertexNormals():this.normalizeNormals()}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new GC(t.vertices,t.indices,t.radius,t.details)}}class VC extends GC{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2,n=1/i;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],t,e),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new VC(t.radius,t.detail)}}const jC=new Ab,HC=new Ab,WC=new Ab,qC=new Ow;class XC extends cA{constructor(t=null,e=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:t,thresholdAngle:e},null!==t){const i=Math.pow(10,4),n=Math.cos(kx*e),r=t.getIndex(),s=t.getAttribute("position"),o=r?r.count:s.count,a=[0,0,0],l=["a","b","c"],c=new Array(3),h={},u=[];for(let t=0;t<o;t+=3){r?(a[0]=r.getX(t),a[1]=r.getX(t+1),a[2]=r.getX(t+2)):(a[0]=t,a[1]=t+1,a[2]=t+2);const{a:e,b:o,c:d}=qC;if(e.fromBufferAttribute(s,a[0]),o.fromBufferAttribute(s,a[1]),d.fromBufferAttribute(s,a[2]),qC.getNormal(WC),c[0]=`${Math.round(e.x*i)},${Math.round(e.y*i)},${Math.round(e.z*i)}`,c[1]=`${Math.round(o.x*i)},${Math.round(o.y*i)},${Math.round(o.z*i)}`,c[2]=`${Math.round(d.x*i)},${Math.round(d.y*i)},${Math.round(d.z*i)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let t=0;t<3;t++){const e=(t+1)%3,i=c[t],r=c[e],s=qC[l[t]],o=qC[l[e]],d=`${i}_${r}`,p=`${r}_${i}`;p in h&&h[p]?(WC.dot(h[p].normal)<=n&&(u.push(s.x,s.y,s.z),u.push(o.x,o.y,o.z)),h[p]=null):d in h||(h[d]={index0:a[t],index1:a[e],normal:WC.clone()})}}for(const t in h)if(h[t]){const{index0:e,index1:i}=h[t];jC.fromBufferAttribute(s,e),HC.fromBufferAttribute(s,i),u.push(jC.x,jC.y,jC.z),u.push(HC.x,HC.y,HC.z)}this.setAttribute("position",new eA(u,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}class ZC extends OC{constructor(t){super(t),this.uuid=zx(),this.type="Shape",this.holes=[]}getPointsHoles(t){const e=[];for(let i=0,n=this.holes.length;i<n;i++)e[i]=this.holes[i].getPoints(t);return e}extractPoints(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}}copy(t){super.copy(t),this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){this.holes.push(t.holes[e].clone())}return this}toJSON(){const t=super.toJSON();t.uuid=this.uuid,t.holes=[];for(let e=0,i=this.holes.length;e<i;e++){t.holes.push(this.holes[e].toJSON())}return t}fromJSON(t){super.fromJSON(t),this.uuid=t.uuid,this.holes=[];for(let e=0,i=t.holes.length;e<i;e++){const i=t.holes[e];this.holes.push((new OC).fromJSON(i))}return this}}const JC=function(t,e,i=2){const n=e&&e.length,r=n?e[0]*i:t.length;let s=YC(t,0,r,i,!0);const o=[];if(!s||s.next===s.prev)return o;let a,l,c,h,u,d,p;if(n&&(s=function(t,e,i,n){const r=[];let s,o,a,l,c;for(s=0,o=e.length;s<o;s++)a=e[s]*n,l=s<o-1?e[s+1]*n:t.length,c=YC(t,a,l,n,!1),c===c.next&&(c.steiner=!0),r.push(aI(c));for(r.sort(nI),s=0;s<r.length;s++)i=rI(r[s],i);return i}(t,e,s,i)),t.length>80*i){a=c=t[0],l=h=t[1];for(let e=i;e<r;e+=i)u=t[e],d=t[e+1],u<a&&(a=u),d<l&&(l=d),u>c&&(c=u),d>h&&(h=d);p=Math.max(c-a,h-l),p=0!==p?32767/p:0}return KC(s,o,i,a,l,p,0),o};function YC(t,e,i,n,r){let s,o;if(r===function(t,e,i,n){let r=0;for(let s=e,o=i-n;s<i;s+=n)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}(t,e,i,n)>0)for(s=e;s<i;s+=n)o=_I(s,t[s],t[s+1],o);else for(s=i-n;s>=e;s-=n)o=_I(s,t[s],t[s+1],o);return o&&uI(o,o.next)&&(yI(o),o=o.next),o}function $C(t,e){if(!t)return t;e||(e=t);let i,n=t;do{if(i=!1,n.steiner||!uI(n,n.next)&&0!==hI(n.prev,n,n.next))n=n.next;else{if(yI(n),n=e=n.prev,n===n.next)break;i=!0}}while(i||n!==e);return e}function KC(t,e,i,n,r,s,o){if(!t)return;!o&&s&&function(t,e,i,n){let r=t;do{0===r.z&&(r.z=oI(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,i,n,r,s,o,a,l,c=1;do{for(i=t,t=null,s=null,o=0;i;){for(o++,n=i,a=0,e=0;e<c&&(a++,n=n.nextZ,n);e++);for(l=c;a>0||l>0&&n;)0!==a&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,a--):(r=n,n=n.nextZ,l--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;i=n}s.nextZ=null,c*=2}while(o>1)}(r)}(t,n,r,s);let a,l,c=t;for(;t.prev!==t.next;)if(a=t.prev,l=t.next,s?tI(t,n,r,s):QC(t))e.push(a.i/i|0),e.push(t.i/i|0),e.push(l.i/i|0),yI(t),t=l.next,c=l.next;else if((t=l)===c){o?1===o?KC(t=eI($C(t),e,i),e,i,n,r,s,2):2===o&&iI(t,e,i,n,r,s):KC($C(t),e,i,n,r,s,1);break}}function QC(t){const e=t.prev,i=t,n=t.next;if(hI(e,i,n)>=0)return!1;const r=e.x,s=i.x,o=n.x,a=e.y,l=i.y,c=n.y,h=r<s?r<o?r:o:s<o?s:o,u=a<l?a<c?a:c:l<c?l:c,d=r>s?r>o?r:o:s>o?s:o,p=a>l?a>c?a:c:l>c?l:c;let f=n.next;for(;f!==e;){if(f.x>=h&&f.x<=d&&f.y>=u&&f.y<=p&&lI(r,a,s,l,o,c,f.x,f.y)&&hI(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function tI(t,e,i,n){const r=t.prev,s=t,o=t.next;if(hI(r,s,o)>=0)return!1;const a=r.x,l=s.x,c=o.x,h=r.y,u=s.y,d=o.y,p=a<l?a<c?a:c:l<c?l:c,f=h<u?h<d?h:d:u<d?u:d,m=a>l?a>c?a:c:l>c?l:c,g=h>u?h>d?h:d:u>d?u:d,_=oI(p,f,e,i,n),y=oI(m,g,e,i,n);let v=t.prevZ,x=t.nextZ;for(;v&&v.z>=_&&x&&x.z<=y;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&lI(a,h,l,u,c,d,v.x,v.y)&&hI(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&lI(a,h,l,u,c,d,x.x,x.y)&&hI(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=_;){if(v.x>=p&&v.x<=m&&v.y>=f&&v.y<=g&&v!==r&&v!==o&&lI(a,h,l,u,c,d,v.x,v.y)&&hI(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=p&&x.x<=m&&x.y>=f&&x.y<=g&&x!==r&&x!==o&&lI(a,h,l,u,c,d,x.x,x.y)&&hI(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function eI(t,e,i){let n=t;do{const r=n.prev,s=n.next.next;!uI(r,s)&&dI(r,n,n.next,s)&&mI(r,s)&&mI(s,r)&&(e.push(r.i/i|0),e.push(n.i/i|0),e.push(s.i/i|0),yI(n),yI(n.next),n=t=s),n=n.next}while(n!==t);return $C(n)}function iI(t,e,i,n,r,s){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&cI(o,t)){let a=gI(o,t);return o=$C(o,o.next),a=$C(a,a.next),KC(o,e,i,n,r,s,0),void KC(a,e,i,n,r,s,0)}t=t.next}o=o.next}while(o!==t)}function nI(t,e){return t.x-e.x}function rI(t,e){const i=function(t,e){let i,n=e,r=-1/0;const s=t.x,o=t.y;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){const t=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=s&&t>r&&(r=t,i=n.x<n.next.x?n:n.next,t===s))return i}n=n.next}while(n!==e);if(!i)return null;const a=i,l=i.x,c=i.y;let h,u=1/0;n=i;do{s>=n.x&&n.x>=l&&s!==n.x&&lI(o<c?s:r,o,l,c,o<c?r:s,o,n.x,n.y)&&(h=Math.abs(o-n.y)/(s-n.x),mI(n,t)&&(h<u||h===u&&(n.x>i.x||n.x===i.x&&sI(i,n)))&&(i=n,u=h)),n=n.next}while(n!==a);return i}(t,e);if(!i)return e;const n=gI(i,t);return $C(n,n.next),$C(i,i.next)}function sI(t,e){return hI(t.prev,t,e.prev)<0&&hI(e.next,t,t.next)<0}function oI(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function aI(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function lI(t,e,i,n,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(n-a)>=(i-o)*(e-a)&&(i-o)*(s-a)>=(r-o)*(n-a)}function cI(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&dI(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(mI(t,e)&&mI(e,t)&&function(t,e){let i=t,n=!1;const r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&r<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(hI(t.prev,t,e.prev)||hI(t,e.prev,e))||uI(t,e)&&hI(t.prev,t,t.next)>0&&hI(e.prev,e,e.next)>0)}function hI(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function uI(t,e){return t.x===e.x&&t.y===e.y}function dI(t,e,i,n){const r=fI(hI(t,e,i)),s=fI(hI(t,e,n)),o=fI(hI(i,n,t)),a=fI(hI(i,n,e));return r!==s&&o!==a||(!(0!==r||!pI(t,i,e))||(!(0!==s||!pI(t,n,e))||(!(0!==o||!pI(i,t,n))||!(0!==a||!pI(i,e,n)))))}function pI(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function fI(t){return t>0?1:t<0?-1:0}function mI(t,e){return hI(t.prev,t,t.next)<0?hI(t,e,t.next)>=0&&hI(t,t.prev,e)>=0:hI(t,e,t.prev)<0||hI(t,t.next,e)<0}function gI(t,e){const i=new vI(t.i,t.x,t.y),n=new vI(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,s.next=n,n.prev=s,n}function _I(t,e,i,n){const r=new vI(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function yI(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function vI(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}class xI{static area(t){const e=t.length;let i=0;for(let n=e-1,r=0;r<e;n=r++)i+=t[n].x*t[r].y-t[r].x*t[n].y;return.5*i}static isClockWise(t){return xI.area(t)<0}static triangulateShape(t,e){const i=[],n=[],r=[];bI(t),wI(i,t);let s=t.length;e.forEach(bI);for(let t=0;t<e.length;t++)n.push(s),s+=e[t].length,wI(i,e[t]);const o=JC(i,n);for(let t=0;t<o.length;t+=3)r.push(o.slice(t,t+3));return r}}function bI(t){const e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function wI(t,e){for(let i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}class AI extends cA{constructor(t=new ZC([new Xx(.5,.5),new Xx(-.5,.5),new Xx(-.5,-.5),new Xx(.5,-.5)]),e={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},t=Array.isArray(t)?t:[t];const i=this,n=[],r=[];for(let e=0,i=t.length;e<i;e++){s(t[e])}function s(t){const s=[],o=void 0!==e.curveSegments?e.curveSegments:12,a=void 0!==e.steps?e.steps:1,l=void 0!==e.depth?e.depth:1;let c=void 0===e.bevelEnabled||e.bevelEnabled,h=void 0!==e.bevelThickness?e.bevelThickness:.2,u=void 0!==e.bevelSize?e.bevelSize:h-.1,d=void 0!==e.bevelOffset?e.bevelOffset:0,p=void 0!==e.bevelSegments?e.bevelSegments:3;const f=e.extrudePath,m=void 0!==e.UVGenerator?e.UVGenerator:TI;let g,_,y,v,x,b=!1;f&&(g=f.getSpacedPoints(a),b=!0,c=!1,_=f.computeFrenetFrames(a,!1),y=new Ab,v=new Ab,x=new Ab),c||(p=0,h=0,u=0,d=0);const w=t.extractPoints(o);let A=w.shape;const T=w.holes;if(!xI.isClockWise(A)){A=A.reverse();for(let t=0,e=T.length;t<e;t++){const e=T[t];xI.isClockWise(e)&&(T[t]=e.reverse())}}const M=xI.triangulateShape(A,T),S=A;for(let t=0,e=T.length;t<e;t++){A=A.concat(T[t])}function E(t,e,i){return t.clone().addScaledVector(e,i)}const C=A.length,I=M.length;function P(t,e,i){let n,r,s;const o=t.x-e.x,a=t.y-e.y,l=i.x-t.x,c=i.y-t.y,h=o*o+a*a;if(Math.abs(o*c-a*l)>Number.EPSILON){const u=Math.sqrt(h),d=Math.sqrt(l*l+c*c),p=e.x-a/u,f=e.y+o/u,m=((i.x-c/d-p)*c-(i.y+l/d-f)*l)/(o*c-a*l);n=p+o*m-t.x,r=f+a*m-t.y;const g=n*n+r*r;if(g<=2)return new Xx(n,r);s=Math.sqrt(g/2)}else{let t=!1;o>Number.EPSILON?l>Number.EPSILON&&(t=!0):o<-Number.EPSILON?l<-Number.EPSILON&&(t=!0):Math.sign(a)===Math.sign(c)&&(t=!0),t?(n=-a,r=o,s=Math.sqrt(h)):(n=o,r=a,s=Math.sqrt(h/2))}return new Xx(n/s,r/s)}const L=[];for(let t=0,e=S.length,i=e-1,n=t+1;t<e;t++,i++,n++)i===e&&(i=0),n===e&&(n=0),L[t]=P(S[t],S[i],S[n]);const R=[];let B,D=L.concat();for(let t=0,e=T.length;t<e;t++){const e=T[t];B=[];for(let t=0,i=e.length,n=i-1,r=t+1;t<i;t++,n++,r++)n===i&&(n=0),r===i&&(r=0),B[t]=P(e[t],e[n],e[r]);R.push(B),D=D.concat(B)}for(let t=0;t<p;t++){const e=t/p,i=h*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=S.length;t<e;t++){const e=E(S[t],L[t],n);F(e.x,e.y,-i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];B=R[t];for(let t=0,r=e.length;t<r;t++){const r=E(e[t],B[t],n);F(r.x,r.y,-i)}}}const O=u+d;for(let t=0;t<C;t++){const e=c?E(A[t],D[t],O):A[t];b?(v.copy(_.normals[0]).multiplyScalar(e.x),y.copy(_.binormals[0]).multiplyScalar(e.y),x.copy(g[0]).add(v).add(y),F(x.x,x.y,x.z)):F(e.x,e.y,0)}for(let t=1;t<=a;t++)for(let e=0;e<C;e++){const i=c?E(A[e],D[e],O):A[e];b?(v.copy(_.normals[t]).multiplyScalar(i.x),y.copy(_.binormals[t]).multiplyScalar(i.y),x.copy(g[t]).add(v).add(y),F(x.x,x.y,x.z)):F(i.x,i.y,l/a*t)}for(let t=p-1;t>=0;t--){const e=t/p,i=h*Math.cos(e*Math.PI/2),n=u*Math.sin(e*Math.PI/2)+d;for(let t=0,e=S.length;t<e;t++){const e=E(S[t],L[t],n);F(e.x,e.y,l+i)}for(let t=0,e=T.length;t<e;t++){const e=T[t];B=R[t];for(let t=0,r=e.length;t<r;t++){const r=E(e[t],B[t],n);b?F(r.x,r.y+g[a-1].y,g[a-1].x+i):F(r.x,r.y,l+i)}}}function k(t,e){let i=t.length;for(;--i>=0;){const n=i;let r=i-1;r<0&&(r=t.length-1);for(let t=0,i=a+2*p;t<i;t++){const i=C*t,s=C*(t+1);N(e+n+i,e+r+i,e+r+s,e+n+s)}}}function F(t,e,i){s.push(t),s.push(e),s.push(i)}function z(t,e,r){U(t),U(e),U(r);const s=n.length/3,o=m.generateTopUV(i,n,s-3,s-2,s-1);G(o[0]),G(o[1]),G(o[2])}function N(t,e,r,s){U(t),U(e),U(s),U(e),U(r),U(s);const o=n.length/3,a=m.generateSideWallUV(i,n,o-6,o-3,o-2,o-1);G(a[0]),G(a[1]),G(a[3]),G(a[1]),G(a[2]),G(a[3])}function U(t){n.push(s[3*t+0]),n.push(s[3*t+1]),n.push(s[3*t+2])}function G(t){r.push(t.x),r.push(t.y)}!function(){const t=n.length/3;if(c){let t=0,e=C*t;for(let t=0;t<I;t++){const i=M[t];z(i[2]+e,i[1]+e,i[0]+e)}t=a+2*p,e=C*t;for(let t=0;t<I;t++){const i=M[t];z(i[0]+e,i[1]+e,i[2]+e)}}else{for(let t=0;t<I;t++){const e=M[t];z(e[2],e[1],e[0])}for(let t=0;t<I;t++){const e=M[t];z(e[0]+C*a,e[1]+C*a,e[2]+C*a)}}i.addGroup(t,n.length/3-t,0)}(),function(){const t=n.length/3;let e=0;k(S,e),e+=S.length;for(let t=0,i=T.length;t<i;t++){const i=T[t];k(i,e),e+=i.length}i.addGroup(t,n.length/3-t,1)}()}this.setAttribute("position",new eA(n,3)),this.setAttribute("uv",new eA(r,2)),this.computeVertexNormals()}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return function(t,e,i){if(i.shapes=[],Array.isArray(t))for(let e=0,n=t.length;e<n;e++){i.shapes.push(t[e].uuid)}else i.shapes.push(t.uuid);i.options=Object.assign({},e),void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON());return i}(this.parameters.shapes,this.parameters.options,t)}static fromJSON(t,e){const i=[];for(let n=0,r=t.shapes.length;n<r;n++){i.push(e[t.shapes[n]])}const n=t.options.extrudePath;return void 0!==n&&(t.options.extrudePath=(new BC[n.type]).fromJSON(n)),new AI(i,t.options)}}const TI={generateTopUV:function(t,e,i,n,r){const s=e[3*n],o=e[3*n+1],a=e[3*r],l=e[3*r+1];return[new Xx(e[3*i],e[3*i+1]),new Xx(s,o),new Xx(a,l)]},generateSideWallUV:function(t,e,i,n,r,s){const o=e[3*i],a=e[3*i+1],l=e[3*i+2],c=e[3*n],h=e[3*n+1],u=e[3*n+2],d=e[3*r],p=e[3*r+1],f=e[3*r+2],m=e[3*s],g=e[3*s+1],_=e[3*s+2];return Math.abs(a-h)<Math.abs(o-c)?[new Xx(o,1-l),new Xx(c,1-u),new Xx(d,1-f),new Xx(m,1-_)]:[new Xx(a,1-l),new Xx(h,1-u),new Xx(p,1-f),new Xx(g,1-_)]}};class MI extends GC{constructor(t=1,e=0){const i=(1+Math.sqrt(5))/2;super([-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],t,e),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new MI(t.radius,t.detail)}}class SI extends GC{constructor(t=1,e=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],t,e),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new SI(t.radius,t.detail)}}class EI extends cA{constructor(t=.5,e=1,i=32,n=1,r=0,s=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:s},i=Math.max(3,i);const o=[],a=[],l=[],c=[];let h=t;const u=(e-t)/(n=Math.max(1,n)),d=new Ab,p=new Xx;for(let t=0;t<=n;t++){for(let t=0;t<=i;t++){const n=r+t/i*s;d.x=h*Math.cos(n),d.y=h*Math.sin(n),a.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/e+1)/2,p.y=(d.y/e+1)/2,c.push(p.x,p.y)}h+=u}for(let t=0;t<n;t++){const e=t*(i+1);for(let t=0;t<i;t++){const n=t+e,r=n+i+1,s=n+i+2,a=n+1;o.push(n,r,a),o.push(r,s,a)}}this.setIndex(o),this.setAttribute("position",new eA(a,3)),this.setAttribute("normal",new eA(l,3)),this.setAttribute("uv",new eA(c,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new EI(t.innerRadius,t.outerRadius,t.thetaSegments,t.phiSegments,t.thetaStart,t.thetaLength)}}class CI extends cA{constructor(t=new ZC([new Xx(0,.5),new Xx(-.5,-.5),new Xx(.5,-.5)]),e=12){super(),this.type="ShapeGeometry",this.parameters={shapes:t,curveSegments:e};const i=[],n=[],r=[],s=[];let o=0,a=0;if(!1===Array.isArray(t))l(t);else for(let e=0;e<t.length;e++)l(t[e]),this.addGroup(o,a,e),o+=a,a=0;function l(t){const o=n.length/3,l=t.extractPoints(e);let c=l.shape;const h=l.holes;!1===xI.isClockWise(c)&&(c=c.reverse());for(let t=0,e=h.length;t<e;t++){const e=h[t];!0===xI.isClockWise(e)&&(h[t]=e.reverse())}const u=xI.triangulateShape(c,h);for(let t=0,e=h.length;t<e;t++){c=c.concat(h[t])}for(let t=0,e=c.length;t<e;t++){const e=c[t];n.push(e.x,e.y,0),r.push(0,0,1),s.push(e.x,e.y)}for(let t=0,e=u.length;t<e;t++){const e=u[t];i.push(e[0]+o,e[1]+o,e[2]+o),a+=3}}this.setIndex(i),this.setAttribute("position",new eA(n,3)),this.setAttribute("normal",new eA(r,3)),this.setAttribute("uv",new eA(s,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return function(t,e){if(e.shapes=[],Array.isArray(t))for(let i=0,n=t.length;i<n;i++){e.shapes.push(t[i].uuid)}else e.shapes.push(t.uuid);return e}(this.parameters.shapes,t)}static fromJSON(t,e){const i=[];for(let n=0,r=t.shapes.length;n<r;n++){i.push(e[t.shapes[n]])}return new CI(i,t.curveSegments)}}class II extends cA{constructor(t=1,e=32,i=16,n=0,r=2*Math.PI,s=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:r,thetaStart:s,thetaLength:o},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const a=Math.min(s+o,Math.PI);let l=0;const c=[],h=new Ab,u=new Ab,d=[],p=[],f=[],m=[];for(let d=0;d<=i;d++){const g=[],_=d/i;let y=0;0===d&&0===s?y=.5/e:d===i&&a===Math.PI&&(y=-.5/e);for(let i=0;i<=e;i++){const a=i/e;h.x=-t*Math.cos(n+a*r)*Math.sin(s+_*o),h.y=t*Math.cos(s+_*o),h.z=t*Math.sin(n+a*r)*Math.sin(s+_*o),p.push(h.x,h.y,h.z),u.copy(h).normalize(),f.push(u.x,u.y,u.z),m.push(a+y,1-_),g.push(l++)}c.push(g)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=c[t][n],r=c[t+1][n],o=c[t+1][n+1];(0!==t||s>0)&&d.push(c[t][n+1],e,o),(t!==i-1||a<Math.PI)&&d.push(e,r,o)}this.setIndex(d),this.setAttribute("position",new eA(p,3)),this.setAttribute("normal",new eA(f,3)),this.setAttribute("uv",new eA(m,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new II(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class PI extends GC{constructor(t=1,e=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],t,e),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e}}static fromJSON(t){return new PI(t.radius,t.detail)}}class LI extends cA{constructor(t=1,e=.4,i=12,n=48,r=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:n,arc:r},i=Math.floor(i),n=Math.floor(n);const s=[],o=[],a=[],l=[],c=new Ab,h=new Ab,u=new Ab;for(let s=0;s<=i;s++)for(let d=0;d<=n;d++){const p=d/n*r,f=s/i*Math.PI*2;h.x=(t+e*Math.cos(f))*Math.cos(p),h.y=(t+e*Math.cos(f))*Math.sin(p),h.z=e*Math.sin(f),o.push(h.x,h.y,h.z),c.x=t*Math.cos(p),c.y=t*Math.sin(p),u.subVectors(h,c).normalize(),a.push(u.x,u.y,u.z),l.push(d/n),l.push(s/i)}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*(t-1)+e-1,r=(n+1)*(t-1)+e,o=(n+1)*t+e;s.push((n+1)*t+e-1,i,o),s.push(i,r,o)}this.setIndex(s),this.setAttribute("position",new eA(o,3)),this.setAttribute("normal",new eA(a,3)),this.setAttribute("uv",new eA(l,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new LI(t.radius,t.tube,t.radialSegments,t.tubularSegments,t.arc)}}class RI extends cA{constructor(t=1,e=.4,i=64,n=8,r=2,s=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:n,p:r,q:s},i=Math.floor(i),n=Math.floor(n);const o=[],a=[],l=[],c=[],h=new Ab,u=new Ab,d=new Ab,p=new Ab,f=new Ab,m=new Ab,g=new Ab;for(let o=0;o<=i;++o){const y=o/i*r*Math.PI*2;_(y,r,s,t,d),_(y+.01,r,s,t,p),m.subVectors(p,d),g.addVectors(p,d),f.crossVectors(m,g),g.crossVectors(f,m),f.normalize(),g.normalize();for(let t=0;t<=n;++t){const r=t/n*Math.PI*2,s=-e*Math.cos(r),p=e*Math.sin(r);h.x=d.x+(s*g.x+p*f.x),h.y=d.y+(s*g.y+p*f.y),h.z=d.z+(s*g.z+p*f.z),a.push(h.x,h.y,h.z),u.subVectors(h,d).normalize(),l.push(u.x,u.y,u.z),c.push(o/i),c.push(t/n)}}for(let t=1;t<=i;t++)for(let e=1;e<=n;e++){const i=(n+1)*t+(e-1),r=(n+1)*t+e,s=(n+1)*(t-1)+e;o.push((n+1)*(t-1)+(e-1),i,s),o.push(i,r,s)}function _(t,e,i,n,r){const s=Math.cos(t),o=Math.sin(t),a=i/e*t,l=Math.cos(a);r.x=n*(2+l)*.5*s,r.y=n*(2+l)*o*.5,r.z=n*Math.sin(a)*.5}this.setIndex(o),this.setAttribute("position",new eA(a,3)),this.setAttribute("normal",new eA(l,3)),this.setAttribute("uv",new eA(c,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new RI(t.radius,t.tube,t.tubularSegments,t.radialSegments,t.p,t.q)}}class BI extends cA{constructor(t=new LC(new Ab(-1,-1,0),new Ab(-1,1,0),new Ab(1,1,0)),e=64,i=1,n=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:n,closed:r};const s=t.computeFrenetFrames(e,r);this.tangents=s.tangents,this.normals=s.normals,this.binormals=s.binormals;const o=new Ab,a=new Ab,l=new Xx;let c=new Ab;const h=[],u=[],d=[],p=[];function f(r){c=t.getPointAt(r/e,c);const l=s.normals[r],d=s.binormals[r];for(let t=0;t<=n;t++){const e=t/n*Math.PI*2,r=Math.sin(e),s=-Math.cos(e);a.x=s*l.x+r*d.x,a.y=s*l.y+r*d.y,a.z=s*l.z+r*d.z,a.normalize(),u.push(a.x,a.y,a.z),o.x=c.x+i*a.x,o.y=c.y+i*a.y,o.z=c.z+i*a.z,h.push(o.x,o.y,o.z)}}!function(){for(let t=0;t<e;t++)f(t);f(!1===r?e:0),function(){for(let t=0;t<=e;t++)for(let i=0;i<=n;i++)l.x=t/e,l.y=i/n,d.push(l.x,l.y)}(),function(){for(let t=1;t<=e;t++)for(let e=1;e<=n;e++){const i=(n+1)*t+(e-1),r=(n+1)*t+e,s=(n+1)*(t-1)+e;p.push((n+1)*(t-1)+(e-1),i,s),p.push(i,r,s)}}()}(),this.setIndex(p),this.setAttribute("position",new eA(h,3)),this.setAttribute("normal",new eA(u,3)),this.setAttribute("uv",new eA(d,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){const t=super.toJSON();return t.path=this.parameters.path.toJSON(),t}static fromJSON(t){return new BI((new BC[t.path.type]).fromJSON(t.path),t.tubularSegments,t.radius,t.radialSegments,t.closed)}}class DI extends cA{constructor(t=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:t},null!==t){const e=[],i=new Set,n=new Ab,r=new Ab;if(null!==t.index){const s=t.attributes.position,o=t.index;let a=t.groups;0===a.length&&(a=[{start:0,count:o.count,materialIndex:0}]);for(let t=0,l=a.length;t<l;++t){const l=a[t],c=l.start;for(let t=c,a=c+l.count;t<a;t+=3)for(let a=0;a<3;a++){const l=o.getX(t+a),c=o.getX(t+(a+1)%3);n.fromBufferAttribute(s,l),r.fromBufferAttribute(s,c),!0===OI(n,r,i)&&(e.push(n.x,n.y,n.z),e.push(r.x,r.y,r.z))}}}else{const s=t.attributes.position;for(let t=0,o=s.count/3;t<o;t++)for(let o=0;o<3;o++){const a=3*t+(o+1)%3;n.fromBufferAttribute(s,3*t+o),r.fromBufferAttribute(s,a),!0===OI(n,r,i)&&(e.push(n.x,n.y,n.z),e.push(r.x,r.y,r.z))}}this.setAttribute("position",new eA(e,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}function OI(t,e,i){const n=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`,r=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`;return!0!==i.has(n)&&!0!==i.has(r)&&(i.add(n),i.add(r),!0)}var kI=Object.freeze({__proto__:null,BoxGeometry:IA,CapsuleGeometry:FC,CircleGeometry:zC,ConeGeometry:UC,CylinderGeometry:NC,DodecahedronGeometry:VC,EdgesGeometry:XC,ExtrudeGeometry:AI,IcosahedronGeometry:MI,LatheGeometry:kC,OctahedronGeometry:SI,PlaneGeometry:QA,PolyhedronGeometry:GC,RingGeometry:EI,ShapeGeometry:CI,SphereGeometry:II,TetrahedronGeometry:PI,TorusGeometry:LI,TorusKnotGeometry:RI,TubeGeometry:BI,WireframeGeometry:DI});class FI extends jw{constructor(t){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new Uw(0),this.transparent=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.fog=t.fog,this}}class zI extends DA{constructor(t){super(t),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class NI extends jw{constructor(t){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Uw(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Uw(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class UI extends NI{constructor(t){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Xx(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Nx(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Uw(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Uw(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Uw(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(t)}get anisotropy(){return this._anisotropy}set anisotropy(t){this._anisotropy>0!=t>0&&this.version++,this._anisotropy=t}get clearcoat(){return this._clearcoat}set clearcoat(t){this._clearcoat>0!=t>0&&this.version++,this._clearcoat=t}get iridescence(){return this._iridescence}set iridescence(t){this._iridescence>0!=t>0&&this.version++,this._iridescence=t}get sheen(){return this._sheen}set sheen(t){this._sheen>0!=t>0&&this.version++,this._sheen=t}get transmission(){return this._transmission}set transmission(t){this._transmission>0!=t>0&&this.version++,this._transmission=t}copy(t){return super.copy(t),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=t.anisotropy,this.anisotropyRotation=t.anisotropyRotation,this.anisotropyMap=t.anisotropyMap,this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.ior=t.ior,this.iridescence=t.iridescence,this.iridescenceMap=t.iridescenceMap,this.iridescenceIOR=t.iridescenceIOR,this.iridescenceThicknessRange=[...t.iridescenceThicknessRange],this.iridescenceThicknessMap=t.iridescenceThicknessMap,this.sheen=t.sheen,this.sheenColor.copy(t.sheenColor),this.sheenColorMap=t.sheenColorMap,this.sheenRoughness=t.sheenRoughness,this.sheenRoughnessMap=t.sheenRoughnessMap,this.transmission=t.transmission,this.transmissionMap=t.transmissionMap,this.thickness=t.thickness,this.thicknessMap=t.thicknessMap,this.attenuationDistance=t.attenuationDistance,this.attenuationColor.copy(t.attenuationColor),this.specularIntensity=t.specularIntensity,this.specularIntensityMap=t.specularIntensityMap,this.specularColor.copy(t.specularColor),this.specularColorMap=t.specularColorMap,this}}class GI extends jw{constructor(t){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Uw(16777215),this.specular=new Uw(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Uw(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=jy,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class VI extends jw{constructor(t){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new Uw(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Uw(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.gradientMap=t.gradientMap,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}class jI extends jw{constructor(t){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(t)}copy(t){return super.copy(t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.flatShading=t.flatShading,this}}class HI extends jw{constructor(t){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Uw(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Uw(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=jy,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class WI extends jw{constructor(t){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new Uw(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Xx(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={MATCAP:""},this.color.copy(t.color),this.matcap=t.matcap,this.map=t.map,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.alphaMap=t.alphaMap,this.flatShading=t.flatShading,this.fog=t.fog,this}}class qI extends JE{constructor(t){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}copy(t){return super.copy(t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this}}function XI(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}function ZI(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function JI(t){const e=t.length,i=new Array(e);for(let t=0;t!==e;++t)i[t]=t;return i.sort((function(e,i){return t[e]-t[i]})),i}function YI(t,e,i){const n=t.length,r=new t.constructor(n);for(let s=0,o=0;o!==n;++s){const n=i[s]*e;for(let i=0;i!==e;++i)r[o++]=t[n+i]}return r}function $I(t,e,i,n){let r=1,s=t[0];for(;void 0!==s&&void 0===s[n];)s=t[r++];if(void 0===s)return;let o=s[n];if(void 0!==o)if(Array.isArray(o))do{o=s[n],void 0!==o&&(e.push(s.time),i.push.apply(i,o)),s=t[r++]}while(void 0!==s);else if(void 0!==o.toArray)do{o=s[n],void 0!==o&&(e.push(s.time),o.toArray(i,i.length)),s=t[r++]}while(void 0!==s);else do{o=s[n],void 0!==o&&(e.push(s.time),i.push(o)),s=t[r++]}while(void 0!==s)}const KI={convertArray:XI,isTypedArray:ZI,getKeyframeOrder:JI,sortedArray:YI,flattenJSON:$I,subclip:function(t,e,i,n,r=30){const s=t.clone();s.name=e;const o=[];for(let t=0;t<s.tracks.length;++t){const e=s.tracks[t],a=e.getValueSize(),l=[],c=[];for(let t=0;t<e.times.length;++t){const s=e.times[t]*r;if(!(s<i||s>=n)){l.push(e.times[t]);for(let i=0;i<a;++i)c.push(e.values[t*a+i])}}0!==l.length&&(e.times=XI(l,e.times.constructor),e.values=XI(c,e.values.constructor),o.push(e))}s.tracks=o;let a=1/0;for(let t=0;t<s.tracks.length;++t)a>s.tracks[t].times[0]&&(a=s.tracks[t].times[0]);for(let t=0;t<s.tracks.length;++t)s.tracks[t].shift(-1*a);return s.resetDuration(),s},makeClipAdditive:function(t,e=0,i=t,n=30){n<=0&&(n=30);const r=i.tracks.length,s=e/n;for(let e=0;e<r;++e){const n=i.tracks[e],r=n.ValueTypeName;if("bool"===r||"string"===r)continue;const o=t.tracks.find((function(t){return t.name===n.name&&t.ValueTypeName===r}));if(void 0===o)continue;let a=0;const l=n.getValueSize();n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(a=l/3);let c=0;const h=o.getValueSize();o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=h/3);const u=n.times.length-1;let d;if(s<=n.times[0]){d=n.values.slice(a,l-a)}else if(s>=n.times[u]){const t=u*l+a;d=n.values.slice(t,t+l-a)}else{const t=n.createInterpolant(),e=a,i=l-a;t.evaluate(s),d=t.resultBuffer.slice(e,i)}if("quaternion"===r){(new wb).fromArray(d).normalize().conjugate().toArray(d)}const p=o.times.length;for(let t=0;t<p;++t){const e=t*h+c;if("quaternion"===r)wb.multiplyQuaternionsFlat(o.values,e,d,0,o.values,e);else{const t=h-2*c;for(let i=0;i<t;++i)o.values[e+i]-=d[i]}}}return t.blendMode=mx,t}};class QI{constructor(t,e,i,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(i),this.sampleValues=e,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let i=this._cachedIndex,n=e[i],r=e[i-1];t:{e:{let s;i:{n:if(!(t<n)){for(let s=i+2;;){if(void 0===n){if(t<r)break n;return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===s)break;if(r=n,n=e[++i],t<n)break e}s=e.length;break i}if(t>=r)break t;{const o=e[1];t<o&&(i=2,r=o);for(let s=i-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(i===s)break;if(n=r,r=e[--i-1],t>=r)break e}s=i,i=0}}for(;i<s;){const n=i+s>>>1;t<e[n]?s=n:i=n+1}if(n=e[i],r=e[i-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,r,n)}return this.interpolate_(i,r,t,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=t*n;for(let t=0;t!==n;++t)e[t]=i[r+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class tP extends QI{constructor(t,e,i,n){super(t,e,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:ux,endingEnd:ux}}intervalChanged_(t,e,i){const n=this.parameterPositions;let r=t-2,s=t+1,o=n[r],a=n[s];if(void 0===o)switch(this.getSettings_().endingStart){case dx:r=t,o=2*e-i;break;case px:r=n.length-2,o=e+n[r]-n[r+1];break;default:r=t,o=i}if(void 0===a)switch(this.getSettings_().endingEnd){case dx:s=t,a=2*i-e;break;case px:s=1,a=i+n[1]-n[0];break;default:s=t-1,a=e}const l=.5*(i-e),c=this.valueSize;this._weightPrev=l/(e-o),this._weightNext=l/(a-i),this._offsetPrev=r*c,this._offsetNext=s*c}interpolate_(t,e,i,n){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=t*o,l=a-o,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(i-e)/(n-e),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,_=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,v=d*m-d*f;for(let t=0;t!==o;++t)r[t]=g*s[c+t]+_*s[l+t]+y*s[a+t]+v*s[h+t];return r}}class eP extends QI{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=t*o,l=a-o,c=(i-e)/(n-e),h=1-c;for(let t=0;t!==o;++t)r[t]=s[l+t]*h+s[a+t]*c;return r}}class iP extends QI{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t){return this.copySampleValue_(t-1)}}class nP{constructor(t,e,i,n){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=XI(e,this.TimeBufferType),this.values=XI(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let i;if(e.toJSON!==this.toJSON)i=e.toJSON(t);else{i={name:t.name,times:XI(t.times,Array),values:XI(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(i.interpolation=e)}return i.type=t.ValueTypeName,i}InterpolantFactoryMethodDiscrete(t){return new iP(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new eP(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new tP(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case lx:e=this.InterpolantFactoryMethodDiscrete;break;case cx:e=this.InterpolantFactoryMethodLinear;break;case hx:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error("unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=e,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return lx;case this.InterpolantFactoryMethodLinear:return cx;case this.InterpolantFactoryMethodSmooth:return hx}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]*=t}return this}trim(t,e){const i=this.times,n=i.length;let r=0,s=n-1;for(;r!==n&&i[r]<t;)++r;for(;-1!==s&&i[s]>e;)--s;if(++s,0!==r||s!==n){r>=s&&(s=Math.max(s,1),r=s-1);const t=this.getValueSize();this.times=i.slice(r,s),this.values=this.values.slice(r*t,s*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(t=!1);const i=this.times,n=this.values,r=i.length;0===r&&(t=!1);let s=null;for(let e=0;e!==r;e++){const n=i[e];if("number"==typeof n&&isNaN(n)){t=!1;break}if(null!==s&&s>n){t=!1;break}s=n}if(void 0!==n&&ZI(n))for(let e=0,i=n.length;e!==i;++e){if(isNaN(n[e])){t=!1;break}}return t}optimize(){const t=this.times.slice(),e=this.values.slice(),i=this.getValueSize(),n=this.getInterpolation()===hx,r=t.length-1;let s=1;for(let o=1;o<r;++o){let r=!1;const a=t[o];if(a!==t[o+1]&&(1!==o||a!==t[0]))if(n)r=!0;else{const t=o*i,n=t-i,s=t+i;for(let o=0;o!==i;++o){const i=e[t+o];if(i!==e[n+o]||i!==e[s+o]){r=!0;break}}}if(r){if(o!==s){t[s]=t[o];const n=o*i,r=s*i;for(let t=0;t!==i;++t)e[r+t]=e[n+t]}++s}}if(r>0){t[s]=t[r];for(let t=r*i,n=s*i,o=0;o!==i;++o)e[n+o]=e[t+o];++s}return s!==t.length?(this.times=t.slice(0,s),this.values=e.slice(0,s*i)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),i=new(0,this.constructor)(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}}nP.prototype.TimeBufferType=Float32Array,nP.prototype.ValueBufferType=Float32Array,nP.prototype.DefaultInterpolation=cx;class rP extends nP{}rP.prototype.ValueTypeName="bool",rP.prototype.ValueBufferType=Array,rP.prototype.DefaultInterpolation=lx,rP.prototype.InterpolantFactoryMethodLinear=void 0,rP.prototype.InterpolantFactoryMethodSmooth=void 0;class sP extends nP{}sP.prototype.ValueTypeName="color";class oP extends nP{}oP.prototype.ValueTypeName="number";class aP extends QI{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=(i-e)/(n-e);let l=t*o;for(let t=l+o;l!==t;l+=4)wb.slerpFlat(r,0,s,l-o,s,l,a);return r}}class lP extends nP{InterpolantFactoryMethodLinear(t){return new aP(this.times,this.values,this.getValueSize(),t)}}lP.prototype.ValueTypeName="quaternion",lP.prototype.DefaultInterpolation=cx,lP.prototype.InterpolantFactoryMethodSmooth=void 0;class cP extends nP{}cP.prototype.ValueTypeName="string",cP.prototype.ValueBufferType=Array,cP.prototype.DefaultInterpolation=lx,cP.prototype.InterpolantFactoryMethodLinear=void 0,cP.prototype.InterpolantFactoryMethodSmooth=void 0;class hP extends nP{}hP.prototype.ValueTypeName="vector";class uP{constructor(t,e=-1,i,n=2500){this.name=t,this.tracks=i,this.duration=e,this.blendMode=n,this.uuid=zx(),this.duration<0&&this.resetDuration()}static parse(t){const e=[],i=t.tracks,n=1/(t.fps||1);for(let t=0,r=i.length;t!==r;++t)e.push(dP(i[t]).scale(n));const r=new this(t.name,t.duration,e,t.blendMode);return r.uuid=t.uuid,r}static toJSON(t){const e=[],i=t.tracks,n={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid,blendMode:t.blendMode};for(let t=0,n=i.length;t!==n;++t)e.push(nP.toJSON(i[t]));return n}static CreateFromMorphTargetSequence(t,e,i,n){const r=e.length,s=[];for(let t=0;t<r;t++){let o=[],a=[];o.push((t+r-1)%r,t,(t+1)%r),a.push(0,1,0);const l=JI(o);o=YI(o,1,l),a=YI(a,1,l),n||0!==o[0]||(o.push(r),a.push(a[0])),s.push(new oP(".morphTargetInfluences["+e[t].name+"]",o,a).scale(1/i))}return new this(t,-1,s)}static findByName(t,e){let i=t;if(!Array.isArray(t)){i=t.geometry&&t.geometry.animations||t.animations}for(let t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null}static CreateClipsFromMorphTargetSequences(t,e,i){const n={},r=/^([\w-]*?)([\d]+)$/;for(let e=0,i=t.length;e<i;e++){const i=t[e],s=i.name.match(r);if(s&&s.length>1){const t=s[1];let e=n[t];e||(n[t]=e=[]),e.push(i)}}const s=[];for(const t in n)s.push(this.CreateFromMorphTargetSequence(t,n[t],e,i));return s}static parseAnimation(t,e){if(!t)return null;const i=function(t,e,i,n,r){if(0!==i.length){const s=[],o=[];$I(i,s,o,n),0!==s.length&&r.push(new t(e,s,o))}},n=[],r=t.name||"default",s=t.fps||30,o=t.blendMode;let a=t.length||-1;const l=t.hierarchy||[];for(let t=0;t<l.length;t++){const r=l[t].keys;if(r&&0!==r.length)if(r[0].morphTargets){const t={};let e;for(e=0;e<r.length;e++)if(r[e].morphTargets)for(let i=0;i<r[e].morphTargets.length;i++)t[r[e].morphTargets[i]]=-1;for(const i in t){const t=[],s=[];for(let n=0;n!==r[e].morphTargets.length;++n){const n=r[e];t.push(n.time),s.push(n.morphTarget===i?1:0)}n.push(new oP(".morphTargetInfluence["+i+"]",t,s))}a=t.length*s}else{const s=".bones["+e[t].name+"]";i(hP,s+".position",r,"pos",n),i(lP,s+".quaternion",r,"rot",n),i(hP,s+".scale",r,"scl",n)}}if(0===n.length)return null;return new this(r,a,n,o)}resetDuration(){let t=0;for(let e=0,i=this.tracks.length;e!==i;++e){const i=this.tracks[e];t=Math.max(t,i.times[i.times.length-1])}return this.duration=t,this}trim(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this}validate(){let t=!0;for(let e=0;e<this.tracks.length;e++)t=t&&this.tracks[e].validate();return t}optimize(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this}clone(){const t=[];for(let e=0;e<this.tracks.length;e++)t.push(this.tracks[e].clone());return new this.constructor(this.name,this.duration,t,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function dP(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return oP;case"vector":case"vector2":case"vector3":case"vector4":return hP;case"color":return sP;case"quaternion":return lP;case"bool":case"boolean":return rP;case"string":return cP}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}(t.type);if(void 0===t.times){const e=[],i=[];$I(t.keys,e,i,"value"),t.times=e,t.values=i}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)}const pP={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};class fP{constructor(t,e,i){const n=this;let r,s=!1,o=0,a=0;const l=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===s&&void 0!==n.onStart&&n.onStart(t,o,a),s=!0},this.itemEnd=function(t){o++,void 0!==n.onProgress&&n.onProgress(t,o,a),o===a&&(s=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(t){void 0!==n.onError&&n.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return l.push(t,e),this},this.removeHandler=function(t){const e=l.indexOf(t);return-1!==e&&l.splice(e,2),this},this.getHandler=function(t){for(let e=0,i=l.length;e<i;e+=2){const i=l[e],n=l[e+1];if(i.global&&(i.lastIndex=0),i.test(t))return n}return null}}}const mP=new fP;class gP{constructor(t){this.manager=void 0!==t?t:mP,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const i=this;return new Promise((function(n,r){i.load(t,n,e,r)}))}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}gP.DEFAULT_MATERIAL_NAME="__DEFAULT";const _P={};class yP extends Error{constructor(t,e){super(t),this.response=e}}class vP extends gP{constructor(t){super(t)}load(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=pP.get(t);if(void 0!==r)return this.manager.itemStart(t),setTimeout((()=>{e&&e(r),this.manager.itemEnd(t)}),0),r;if(void 0!==_P[t])return void _P[t].push({onLoad:e,onProgress:i,onError:n});_P[t]=[],_P[t].push({onLoad:e,onProgress:i,onError:n});const s=new Request(t,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),o=this.mimeType,a=this.responseType;fetch(s).then((e=>{if(200===e.status||0===e.status){if("undefined"==typeof ReadableStream||void 0===e.body||void 0===e.body.getReader)return e;const i=_P[t],n=e.body.getReader(),r=e.headers.get("Content-Length")||e.headers.get("X-File-Size"),s=r?parseInt(r):0,o=0!==s;let a=0;const l=new ReadableStream({start(t){!function e(){n.read().then((({done:n,value:r})=>{if(n)t.close();else{a+=r.byteLength;const n=new ProgressEvent("progress",{lengthComputable:o,loaded:a,total:s});for(let t=0,e=i.length;t<e;t++){const e=i[t];e.onProgress&&e.onProgress(n)}t.enqueue(r),e()}}))}()}});return new Response(l)}throw new yP(`fetch for "${e.url}" responded with ${e.status}: ${e.statusText}`,e)})).then((t=>{switch(a){case"arraybuffer":return t.arrayBuffer();case"blob":return t.blob();case"document":return t.text().then((t=>(new DOMParser).parseFromString(t,o)));case"json":return t.json();default:if(void 0===o)return t.text();{const e=/charset="?([^;"\s]*)"?/i.exec(o),i=e&&e[1]?e[1].toLowerCase():void 0,n=new TextDecoder(i);return t.arrayBuffer().then((t=>n.decode(t)))}}})).then((e=>{pP.add(t,e);const i=_P[t];delete _P[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onLoad&&n.onLoad(e)}})).catch((e=>{const i=_P[t];if(void 0===i)throw this.manager.itemError(t),e;delete _P[t];for(let t=0,n=i.length;t<n;t++){const n=i[t];n.onError&&n.onError(e)}this.manager.itemError(t)})).finally((()=>{this.manager.itemEnd(t)})),this.manager.itemStart(t)}setResponseType(t){return this.responseType=t,this}setMimeType(t){return this.mimeType=t,this}}class xP extends gP{constructor(t){super(t)}load(t,e,i,n){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=pP.get(t);if(void 0!==s)return r.manager.itemStart(t),setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s;const o=Qx("img");function a(){c(),pP.add(t,this),e&&e(this),r.manager.itemEnd(t)}function l(e){c(),n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)}function c(){o.removeEventListener("load",a,!1),o.removeEventListener("error",l,!1)}return o.addEventListener("load",a,!1),o.addEventListener("error",l,!1),"data:"!==t.slice(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(t),o.src=t,o}}class bP extends gP{constructor(t){super(t)}load(t,e,i,n){const r=new gb,s=new xP(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(t,(function(t){r.image=t,r.needsUpdate=!0,void 0!==e&&e(r)}),i,n),r}}class wP extends Tw{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new Uw(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}class AP extends wP{constructor(t,e,i){super(t,i),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Tw.DEFAULT_UP),this.updateMatrix(),this.groundColor=new Uw(e)}copy(t,e){return super.copy(t,e),this.groundColor.copy(t.groundColor),this}}const TP=new Qb,MP=new Ab,SP=new Ab;class EP{constructor(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Xx(512,512),this.map=null,this.mapPass=null,this.matrix=new Qb,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new YA,this._frameExtents=new Xx(1,1),this._viewportCount=1,this._viewports=[new _b(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,i=this.matrix;MP.setFromMatrixPosition(t.matrixWorld),e.position.copy(MP),SP.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(SP),e.updateMatrixWorld(),TP.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(TP),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(TP)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}class CP extends EP{constructor(){super(new NA(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(t){const e=this.camera,i=2*Fx*t.angle*this.focus,n=this.mapSize.width/this.mapSize.height,r=t.distance||e.far;i===e.fov&&n===e.aspect&&r===e.far||(e.fov=i,e.aspect=n,e.far=r,e.updateProjectionMatrix()),super.updateMatrices(t)}copy(t){return super.copy(t),this.focus=t.focus,this}}class IP extends wP{constructor(t,e,i=0,n=Math.PI/3,r=0,s=2){super(t,e),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Tw.DEFAULT_UP),this.updateMatrix(),this.target=new Tw,this.distance=i,this.angle=n,this.penumbra=r,this.decay=s,this.map=null,this.shadow=new CP}get power(){return this.intensity*Math.PI}set power(t){this.intensity=t/Math.PI}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}const PP=new Qb,LP=new Ab,RP=new Ab;class BP extends EP{constructor(){super(new NA(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new Xx(4,2),this._viewportCount=6,this._viewports=[new _b(2,1,1,1),new _b(0,1,1,1),new _b(3,1,1,1),new _b(1,1,1,1),new _b(3,0,1,1),new _b(1,0,1,1)],this._cubeDirections=[new Ab(1,0,0),new Ab(-1,0,0),new Ab(0,0,1),new Ab(0,0,-1),new Ab(0,1,0),new Ab(0,-1,0)],this._cubeUps=[new Ab(0,1,0),new Ab(0,1,0),new Ab(0,1,0),new Ab(0,1,0),new Ab(0,0,1),new Ab(0,0,-1)]}updateMatrices(t,e=0){const i=this.camera,n=this.matrix,r=t.distance||i.far;r!==i.far&&(i.far=r,i.updateProjectionMatrix()),LP.setFromMatrixPosition(t.matrixWorld),i.position.copy(LP),RP.copy(i.position),RP.add(this._cubeDirections[e]),i.up.copy(this._cubeUps[e]),i.lookAt(RP),i.updateMatrixWorld(),n.makeTranslation(-LP.x,-LP.y,-LP.z),PP.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(PP)}}class DP extends wP{constructor(t,e,i=0,n=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new BP}get power(){return 4*this.intensity*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class OP extends EP{constructor(){super(new hT(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class kP extends wP{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Tw.DEFAULT_UP),this.updateMatrix(),this.target=new Tw,this.shadow=new OP}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class FP extends wP{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class zP extends wP{constructor(t,e,i=10,n=10){super(t,e),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=i,this.height=n}get power(){return this.intensity*this.width*this.height*Math.PI}set power(t){this.intensity=t/(this.width*this.height*Math.PI)}copy(t){return super.copy(t),this.width=t.width,this.height=t.height,this}toJSON(t){const e=super.toJSON(t);return e.object.width=this.width,e.object.height=this.height,e}}class NP{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let t=0;t<9;t++)this.coefficients.push(new Ab)}set(t){for(let e=0;e<9;e++)this.coefficients[e].copy(t[e]);return this}zero(){for(let t=0;t<9;t++)this.coefficients[t].set(0,0,0);return this}getAt(t,e){const i=t.x,n=t.y,r=t.z,s=this.coefficients;return e.copy(s[0]).multiplyScalar(.282095),e.addScaledVector(s[1],.488603*n),e.addScaledVector(s[2],.488603*r),e.addScaledVector(s[3],.488603*i),e.addScaledVector(s[4],i*n*1.092548),e.addScaledVector(s[5],n*r*1.092548),e.addScaledVector(s[6],.315392*(3*r*r-1)),e.addScaledVector(s[7],i*r*1.092548),e.addScaledVector(s[8],.546274*(i*i-n*n)),e}getIrradianceAt(t,e){const i=t.x,n=t.y,r=t.z,s=this.coefficients;return e.copy(s[0]).multiplyScalar(.886227),e.addScaledVector(s[1],1.023328*n),e.addScaledVector(s[2],1.023328*r),e.addScaledVector(s[3],1.023328*i),e.addScaledVector(s[4],.858086*i*n),e.addScaledVector(s[5],.858086*n*r),e.addScaledVector(s[6],.743125*r*r-.247708),e.addScaledVector(s[7],.858086*i*r),e.addScaledVector(s[8],.429043*(i*i-n*n)),e}add(t){for(let e=0;e<9;e++)this.coefficients[e].add(t.coefficients[e]);return this}addScaledSH(t,e){for(let i=0;i<9;i++)this.coefficients[i].addScaledVector(t.coefficients[i],e);return this}scale(t){for(let e=0;e<9;e++)this.coefficients[e].multiplyScalar(t);return this}lerp(t,e){for(let i=0;i<9;i++)this.coefficients[i].lerp(t.coefficients[i],e);return this}equals(t){for(let e=0;e<9;e++)if(!this.coefficients[e].equals(t.coefficients[e]))return!1;return!0}copy(t){return this.set(t.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].fromArray(t,e+3*n);return this}toArray(t=[],e=0){const i=this.coefficients;for(let n=0;n<9;n++)i[n].toArray(t,e+3*n);return t}static getBasisAt(t,e){const i=t.x,n=t.y,r=t.z;e[0]=.282095,e[1]=.488603*n,e[2]=.488603*r,e[3]=.488603*i,e[4]=1.092548*i*n,e[5]=1.092548*n*r,e[6]=.315392*(3*r*r-1),e[7]=1.092548*i*r,e[8]=.546274*(i*i-n*n)}}class UP extends wP{constructor(t=new NP,e=1){super(void 0,e),this.isLightProbe=!0,this.sh=t}copy(t){return super.copy(t),this.sh.copy(t.sh),this}fromJSON(t){return this.intensity=t.intensity,this.sh.fromArray(t.sh),this}toJSON(t){const e=super.toJSON(t);return e.object.sh=this.sh.toArray(),e}}class GP extends gP{constructor(t){super(t),this.textures={}}load(t,e,i,n){const r=this,s=new vP(r.manager);s.setPath(r.path),s.setRequestHeader(r.requestHeader),s.setWithCredentials(r.withCredentials),s.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n&&n(e),r.manager.itemError(t)}}),i,n)}parse(t){const e=this.textures;function i(t){return e[t]}const n=GP.createMaterialFromType(t.type);if(void 0!==t.uuid&&(n.uuid=t.uuid),void 0!==t.name&&(n.name=t.name),void 0!==t.color&&void 0!==n.color&&n.color.setHex(t.color),void 0!==t.roughness&&(n.roughness=t.roughness),void 0!==t.metalness&&(n.metalness=t.metalness),void 0!==t.sheen&&(n.sheen=t.sheen),void 0!==t.sheenColor&&(n.sheenColor=(new Uw).setHex(t.sheenColor)),void 0!==t.sheenRoughness&&(n.sheenRoughness=t.sheenRoughness),void 0!==t.emissive&&void 0!==n.emissive&&n.emissive.setHex(t.emissive),void 0!==t.specular&&void 0!==n.specular&&n.specular.setHex(t.specular),void 0!==t.specularIntensity&&(n.specularIntensity=t.specularIntensity),void 0!==t.specularColor&&void 0!==n.specularColor&&n.specularColor.setHex(t.specularColor),void 0!==t.shininess&&(n.shininess=t.shininess),void 0!==t.clearcoat&&(n.clearcoat=t.clearcoat),void 0!==t.clearcoatRoughness&&(n.clearcoatRoughness=t.clearcoatRoughness),void 0!==t.iridescence&&(n.iridescence=t.iridescence),void 0!==t.iridescenceIOR&&(n.iridescenceIOR=t.iridescenceIOR),void 0!==t.iridescenceThicknessRange&&(n.iridescenceThicknessRange=t.iridescenceThicknessRange),void 0!==t.transmission&&(n.transmission=t.transmission),void 0!==t.thickness&&(n.thickness=t.thickness),void 0!==t.attenuationDistance&&(n.attenuationDistance=t.attenuationDistance),void 0!==t.attenuationColor&&void 0!==n.attenuationColor&&n.attenuationColor.setHex(t.attenuationColor),void 0!==t.anisotropy&&(n.anisotropy=t.anisotropy),void 0!==t.anisotropyRotation&&(n.anisotropyRotation=t.anisotropyRotation),void 0!==t.fog&&(n.fog=t.fog),void 0!==t.flatShading&&(n.flatShading=t.flatShading),void 0!==t.blending&&(n.blending=t.blending),void 0!==t.combine&&(n.combine=t.combine),void 0!==t.side&&(n.side=t.side),void 0!==t.shadowSide&&(n.shadowSide=t.shadowSide),void 0!==t.opacity&&(n.opacity=t.opacity),void 0!==t.transparent&&(n.transparent=t.transparent),void 0!==t.alphaTest&&(n.alphaTest=t.alphaTest),void 0!==t.alphaHash&&(n.alphaHash=t.alphaHash),void 0!==t.depthFunc&&(n.depthFunc=t.depthFunc),void 0!==t.depthTest&&(n.depthTest=t.depthTest),void 0!==t.depthWrite&&(n.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(n.colorWrite=t.colorWrite),void 0!==t.blendSrc&&(n.blendSrc=t.blendSrc),void 0!==t.blendDst&&(n.blendDst=t.blendDst),void 0!==t.blendEquation&&(n.blendEquation=t.blendEquation),void 0!==t.blendSrcAlpha&&(n.blendSrcAlpha=t.blendSrcAlpha),void 0!==t.blendDstAlpha&&(n.blendDstAlpha=t.blendDstAlpha),void 0!==t.blendEquationAlpha&&(n.blendEquationAlpha=t.blendEquationAlpha),void 0!==t.blendColor&&void 0!==n.blendColor&&n.blendColor.setHex(t.blendColor),void 0!==t.blendAlpha&&(n.blendAlpha=t.blendAlpha),void 0!==t.stencilWriteMask&&(n.stencilWriteMask=t.stencilWriteMask),void 0!==t.stencilFunc&&(n.stencilFunc=t.stencilFunc),void 0!==t.stencilRef&&(n.stencilRef=t.stencilRef),void 0!==t.stencilFuncMask&&(n.stencilFuncMask=t.stencilFuncMask),void 0!==t.stencilFail&&(n.stencilFail=t.stencilFail),void 0!==t.stencilZFail&&(n.stencilZFail=t.stencilZFail),void 0!==t.stencilZPass&&(n.stencilZPass=t.stencilZPass),void 0!==t.stencilWrite&&(n.stencilWrite=t.stencilWrite),void 0!==t.wireframe&&(n.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(n.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(n.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(n.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(n.rotation=t.rotation),void 0!==t.linewidth&&(n.linewidth=t.linewidth),void 0!==t.dashSize&&(n.dashSize=t.dashSize),void 0!==t.gapSize&&(n.gapSize=t.gapSize),void 0!==t.scale&&(n.scale=t.scale),void 0!==t.polygonOffset&&(n.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(n.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(n.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.dithering&&(n.dithering=t.dithering),void 0!==t.alphaToCoverage&&(n.alphaToCoverage=t.alphaToCoverage),void 0!==t.premultipliedAlpha&&(n.premultipliedAlpha=t.premultipliedAlpha),void 0!==t.forceSinglePass&&(n.forceSinglePass=t.forceSinglePass),void 0!==t.visible&&(n.visible=t.visible),void 0!==t.toneMapped&&(n.toneMapped=t.toneMapped),void 0!==t.userData&&(n.userData=t.userData),void 0!==t.vertexColors&&(n.vertexColors="number"==typeof t.vertexColors?t.vertexColors>0:t.vertexColors),void 0!==t.uniforms)for(const e in t.uniforms){const r=t.uniforms[e];switch(n.uniforms[e]={},r.type){case"t":n.uniforms[e].value=i(r.value);break;case"c":n.uniforms[e].value=(new Uw).setHex(r.value);break;case"v2":n.uniforms[e].value=(new Xx).fromArray(r.value);break;case"v3":n.uniforms[e].value=(new Ab).fromArray(r.value);break;case"v4":n.uniforms[e].value=(new _b).fromArray(r.value);break;case"m3":n.uniforms[e].value=(new Zx).fromArray(r.value);break;case"m4":n.uniforms[e].value=(new Qb).fromArray(r.value);break;default:n.uniforms[e].value=r.value}}if(void 0!==t.defines&&(n.defines=t.defines),void 0!==t.vertexShader&&(n.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(n.fragmentShader=t.fragmentShader),void 0!==t.glslVersion&&(n.glslVersion=t.glslVersion),void 0!==t.extensions)for(const e in t.extensions)n.extensions[e]=t.extensions[e];if(void 0!==t.lights&&(n.lights=t.lights),void 0!==t.clipping&&(n.clipping=t.clipping),void 0!==t.size&&(n.size=t.size),void 0!==t.sizeAttenuation&&(n.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(n.map=i(t.map)),void 0!==t.matcap&&(n.matcap=i(t.matcap)),void 0!==t.alphaMap&&(n.alphaMap=i(t.alphaMap)),void 0!==t.bumpMap&&(n.bumpMap=i(t.bumpMap)),void 0!==t.bumpScale&&(n.bumpScale=t.bumpScale),void 0!==t.normalMap&&(n.normalMap=i(t.normalMap)),void 0!==t.normalMapType&&(n.normalMapType=t.normalMapType),void 0!==t.normalScale){let e=t.normalScale;!1===Array.isArray(e)&&(e=[e,e]),n.normalScale=(new Xx).fromArray(e)}return void 0!==t.displacementMap&&(n.displacementMap=i(t.displacementMap)),void 0!==t.displacementScale&&(n.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(n.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(n.roughnessMap=i(t.roughnessMap)),void 0!==t.metalnessMap&&(n.metalnessMap=i(t.metalnessMap)),void 0!==t.emissiveMap&&(n.emissiveMap=i(t.emissiveMap)),void 0!==t.emissiveIntensity&&(n.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(n.specularMap=i(t.specularMap)),void 0!==t.specularIntensityMap&&(n.specularIntensityMap=i(t.specularIntensityMap)),void 0!==t.specularColorMap&&(n.specularColorMap=i(t.specularColorMap)),void 0!==t.envMap&&(n.envMap=i(t.envMap)),void 0!==t.envMapIntensity&&(n.envMapIntensity=t.envMapIntensity),void 0!==t.reflectivity&&(n.reflectivity=t.reflectivity),void 0!==t.refractionRatio&&(n.refractionRatio=t.refractionRatio),void 0!==t.lightMap&&(n.lightMap=i(t.lightMap)),void 0!==t.lightMapIntensity&&(n.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(n.aoMap=i(t.aoMap)),void 0!==t.aoMapIntensity&&(n.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(n.gradientMap=i(t.gradientMap)),void 0!==t.clearcoatMap&&(n.clearcoatMap=i(t.clearcoatMap)),void 0!==t.clearcoatRoughnessMap&&(n.clearcoatRoughnessMap=i(t.clearcoatRoughnessMap)),void 0!==t.clearcoatNormalMap&&(n.clearcoatNormalMap=i(t.clearcoatNormalMap)),void 0!==t.clearcoatNormalScale&&(n.clearcoatNormalScale=(new Xx).fromArray(t.clearcoatNormalScale)),void 0!==t.iridescenceMap&&(n.iridescenceMap=i(t.iridescenceMap)),void 0!==t.iridescenceThicknessMap&&(n.iridescenceThicknessMap=i(t.iridescenceThicknessMap)),void 0!==t.transmissionMap&&(n.transmissionMap=i(t.transmissionMap)),void 0!==t.thicknessMap&&(n.thicknessMap=i(t.thicknessMap)),void 0!==t.anisotropyMap&&(n.anisotropyMap=i(t.anisotropyMap)),void 0!==t.sheenColorMap&&(n.sheenColorMap=i(t.sheenColorMap)),void 0!==t.sheenRoughnessMap&&(n.sheenRoughnessMap=i(t.sheenRoughnessMap)),n}setTextures(t){return this.textures=t,this}static createMaterialFromType(t){return new{ShadowMaterial:FI,SpriteMaterial:jS,RawShaderMaterial:zI,ShaderMaterial:DA,PointsMaterial:oC,MeshPhysicalMaterial:UI,MeshStandardMaterial:NI,MeshPhongMaterial:GI,MeshToonMaterial:VI,MeshNormalMaterial:jI,MeshLambertMaterial:HI,MeshDepthMaterial:bS,MeshDistanceMaterial:wS,MeshBasicMaterial:Hw,MeshMatcapMaterial:WI,LineDashedMaterial:qI,LineBasicMaterial:JE,Material:jw}[t]}}class VP{static decodeText(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);let e="";for(let i=0,n=t.length;i<n;i++)e+=String.fromCharCode(t[i]);try{return decodeURIComponent(escape(e))}catch(t){return e}}static extractUrlBase(t){const e=t.lastIndexOf("/");return-1===e?"./":t.slice(0,e+1)}static resolveURL(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}}class jP extends cA{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(t){return super.copy(t),this.instanceCount=t.instanceCount,this}toJSON(){const t=super.toJSON();return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}class HP extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=new vP(r.manager);s.setPath(r.path),s.setRequestHeader(r.requestHeader),s.setWithCredentials(r.withCredentials),s.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n&&n(e),r.manager.itemError(t)}}),i,n)}parse(t){const e={},i={};function n(t,n){if(void 0!==e[n])return e[n];const r=t.interleavedBuffers[n],s=function(t,e){if(void 0!==i[e])return i[e];const n=t.arrayBuffers,r=n[e],s=new Uint32Array(r).buffer;return i[e]=s,s}(t,r.buffer),o=Kx(r.type,s),a=new US(o,r.stride);return a.uuid=r.uuid,e[n]=a,a}const r=t.isInstancedBufferGeometry?new jP:new cA,s=t.data.index;if(void 0!==s){const t=Kx(s.type,s.array);r.setIndex(new Kw(t,1))}const o=t.data.attributes;for(const e in o){const i=o[e];let s;if(i.isInterleavedBufferAttribute){const e=n(t.data,i.data);s=new VS(e,i.itemSize,i.offset,i.normalized)}else{const t=Kx(i.type,i.array);s=new(i.isInstancedBufferAttribute?AE:Kw)(t,i.itemSize,i.normalized)}void 0!==i.name&&(s.name=i.name),void 0!==i.usage&&s.setUsage(i.usage),r.setAttribute(e,s)}const a=t.data.morphAttributes;if(a)for(const e in a){const i=a[e],s=[];for(let e=0,r=i.length;e<r;e++){const r=i[e];let o;if(r.isInterleavedBufferAttribute){const e=n(t.data,r.data);o=new VS(e,r.itemSize,r.offset,r.normalized)}else{const t=Kx(r.type,r.array);o=new Kw(t,r.itemSize,r.normalized)}void 0!==r.name&&(o.name=r.name),s.push(o)}r.morphAttributes[e]=s}t.data.morphTargetsRelative&&(r.morphTargetsRelative=!0);const l=t.data.groups||t.data.drawcalls||t.data.offsets;if(void 0!==l)for(let t=0,e=l.length;t!==e;++t){const e=l[t];r.addGroup(e.start,e.count,e.materialIndex)}const c=t.data.boundingSphere;if(void 0!==c){const t=new Ab;void 0!==c.center&&t.fromArray(c.center),r.boundingSphere=new Hb(t,c.radius)}return t.name&&(r.name=t.name),t.userData&&(r.userData=t.userData),r}}const WP={UVMapping:ev,CubeReflectionMapping:iv,CubeRefractionMapping:nv,EquirectangularReflectionMapping:rv,EquirectangularRefractionMapping:sv,CubeUVReflectionMapping:ov},qP={RepeatWrapping:av,ClampToEdgeWrapping:lv,MirroredRepeatWrapping:cv},XP={NearestFilter:hv,NearestMipmapNearestFilter:uv,NearestMipmapLinearFilter:dv,LinearFilter:pv,LinearMipmapNearestFilter:fv,LinearMipmapLinearFilter:mv};class ZP extends gP{constructor(t){super(t),this.isImageBitmapLoader=!0,this.options={premultiplyAlpha:"none"}}setOptions(t){return this.options=t,this}load(t,e,i,n){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const r=this,s=pP.get(t);if(void 0!==s)return r.manager.itemStart(t),s.then?void s.then((i=>{e&&e(i),r.manager.itemEnd(t)})).catch((t=>{n&&n(t)})):(setTimeout((function(){e&&e(s),r.manager.itemEnd(t)}),0),s);const o={};o.credentials="anonymous"===this.crossOrigin?"same-origin":"include",o.headers=this.requestHeader;const a=fetch(t,o).then((function(t){return t.blob()})).then((function(t){return createImageBitmap(t,Object.assign(r.options,{colorSpaceConversion:"none"}))})).then((function(i){return pP.add(t,i),e&&e(i),r.manager.itemEnd(t),i})).catch((function(e){n&&n(e),pP.remove(t),r.manager.itemError(t),r.manager.itemEnd(t)}));pP.add(t,a),r.manager.itemStart(t)}}let JP;class YP{static getContext(){return void 0===JP&&(JP=new(window.AudioContext||window.webkitAudioContext)),JP}static setContext(t){JP=t}}const $P=new Qb,KP=new Qb,QP=new Qb;class tL{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=eL(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=eL();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}function eL(){return("undefined"==typeof performance?Date:performance).now()}const iL=new Ab,nL=new wb,rL=new Ab,sL=new Ab;class oL extends Tw{constructor(t){super(),this.type="Audio",this.listener=t,this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.detune=0,this.loop=!1,this.loopStart=0,this.loopEnd=0,this.offset=0,this.duration=void 0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.source=null,this.sourceType="empty",this._startedAt=0,this._progress=0,this._connected=!1,this.filters=[]}getOutput(){return this.gain}setNodeSource(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this}setMediaElementSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this}setMediaStreamSource(t){return this.hasPlaybackControl=!1,this.sourceType="mediaStreamNode",this.source=this.context.createMediaStreamSource(t),this.connect(),this}setBuffer(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this}play(t=0){if(!0===this.isPlaying)return;if(!1===this.hasPlaybackControl)return;this._startedAt=this.context.currentTime+t;const e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.onended=this.onEnded.bind(this),e.start(this._startedAt,this._progress+this.offset,this.duration),this.isPlaying=!0,this.source=e,this.setDetune(this.detune),this.setPlaybackRate(this.playbackRate),this.connect()}pause(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this._progress+=Math.max(this.context.currentTime-this._startedAt,0)*this.playbackRate,!0===this.loop&&(this._progress=this._progress%(this.duration||this.buffer.duration)),this.source.stop(),this.source.onended=null,this.isPlaying=!1),this}stop(){if(!1!==this.hasPlaybackControl)return this._progress=0,null!==this.source&&(this.source.stop(),this.source.onended=null),this.isPlaying=!1,this}connect(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this._connected=!0,this}disconnect(){if(!1!==this._connected){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(let t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this._connected=!1,this}}getFilters(){return this.filters}setFilters(t){return t||(t=[]),!0===this._connected?(this.disconnect(),this.filters=t.slice(),this.connect()):this.filters=t.slice(),this}setDetune(t){return this.detune=t,!0===this.isPlaying&&void 0!==this.source.detune&&this.source.detune.setTargetAtTime(this.detune,this.context.currentTime,.01),this}getDetune(){return this.detune}getFilter(){return this.getFilters()[0]}setFilter(t){return this.setFilters(t?[t]:[])}setPlaybackRate(t){if(!1!==this.hasPlaybackControl)return this.playbackRate=t,!0===this.isPlaying&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01),this}getPlaybackRate(){return this.playbackRate}onEnded(){this.isPlaying=!1}getLoop(){return!1!==this.hasPlaybackControl&&this.loop}setLoop(t){if(!1!==this.hasPlaybackControl)return this.loop=t,!0===this.isPlaying&&(this.source.loop=this.loop),this}setLoopStart(t){return this.loopStart=t,this}setLoopEnd(t){return this.loopEnd=t,this}getVolume(){return this.gain.gain.value}setVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}}const aL=new Ab,lL=new wb,cL=new Ab,hL=new Ab;class uL{constructor(t,e,i){let n,r,s;switch(this.binding=t,this.valueSize=i,e){case"quaternion":n=this._slerp,r=this._slerpAdditive,s=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(6*i),this._workIndex=5;break;case"string":case"bool":n=this._select,r=this._select,s=this._setAdditiveIdentityOther,this.buffer=new Array(5*i);break;default:n=this._lerp,r=this._lerpAdditive,s=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(5*i)}this._mixBufferRegion=n,this._mixBufferRegionAdditive=r,this._setIdentity=s,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(t,e){const i=this.buffer,n=this.valueSize,r=t*n+n;let s=this.cumulativeWeight;if(0===s){for(let t=0;t!==n;++t)i[r+t]=i[t];s=e}else{s+=e;this._mixBufferRegion(i,r,0,e/s,n)}this.cumulativeWeight=s}accumulateAdditive(t){const e=this.buffer,i=this.valueSize,n=i*this._addIndex;0===this.cumulativeWeightAdditive&&this._setIdentity(),this._mixBufferRegionAdditive(e,n,0,t,i),this.cumulativeWeightAdditive+=t}apply(t){const e=this.valueSize,i=this.buffer,n=t*e+e,r=this.cumulativeWeight,s=this.cumulativeWeightAdditive,o=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,r<1){this._mixBufferRegion(i,n,e*this._origIndex,1-r,e)}s>0&&this._mixBufferRegionAdditive(i,n,this._addIndex*e,1,e);for(let t=e,r=e+e;t!==r;++t)if(i[t]!==i[t+e]){o.setValue(i,n);break}}saveOriginalState(){const t=this.buffer,e=this.valueSize,i=e*this._origIndex;this.binding.getValue(t,i);for(let n=e,r=i;n!==r;++n)t[n]=t[i+n%e];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){this.binding.setValue(this.buffer,3*this.valueSize)}_setAdditiveIdentityNumeric(){const t=this._addIndex*this.valueSize,e=t+this.valueSize;for(let i=t;i<e;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const t=this._origIndex*this.valueSize,e=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[e+i]=this.buffer[t+i]}_select(t,e,i,n,r){if(n>=.5)for(let n=0;n!==r;++n)t[e+n]=t[i+n]}_slerp(t,e,i,n){wb.slerpFlat(t,e,t,e,t,i,n)}_slerpAdditive(t,e,i,n,r){const s=this._workIndex*r;wb.multiplyQuaternionsFlat(t,s,t,e,t,i),wb.slerpFlat(t,e,t,e,t,s,n)}_lerp(t,e,i,n,r){const s=1-n;for(let o=0;o!==r;++o){const r=e+o;t[r]=t[r]*s+t[i+o]*n}}_lerpAdditive(t,e,i,n,r){for(let s=0;s!==r;++s){const r=e+s;t[r]=t[r]+t[i+s]*n}}}const dL="\\[\\]\\.:\\/",pL=new RegExp("["+dL+"]","g"),fL="[^"+dL+"]",mL="[^"+dL.replace("\\.","")+"]",gL=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",fL)+/(WCOD+)?/.source.replace("WCOD",mL)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",fL)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",fL)+"$"),_L=["material","materials","bones","map"];class yL{constructor(t,e,i){this.path=e,this.parsedPath=i||yL.parseTrackName(e),this.node=yL.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,e,i){return t&&t.isAnimationObjectGroup?new yL.Composite(t,e,i):new yL(t,e,i)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(pL,"")}static parseTrackName(t){const e=gL.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const t=i.nodeName.substring(n+1);-1!==_L.indexOf(t)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=t)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i}static findNode(t,e){if(void 0===e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){const i=function(t){for(let n=0;n<t.length;n++){const r=t[n];if(r.name===e||r.uuid===e)return r;const s=i(r.children);if(s)return s}return null},n=i(t.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(t,e){t[e]=this.targetObject[this.propertyName]}_getValue_array(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)t[e++]=i[n]}_getValue_arrayElement(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(t,e){this.resolvedProperty.toArray(t,e)}_setValue_direct(t,e){this.targetObject[this.propertyName]=t[e]}_setValue_direct_setNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++]}_setValue_array_setNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}_setValue_arrayElement_setNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(t,e){this.resolvedProperty.fromArray(t,e)}_setValue_fromArray_setNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(t,e){this.bind(),this.getValue(t,e)}_setValue_unbound(t,e){this.bind(),this.setValue(t,e)}bind(){let t=this.node;const e=this.parsedPath,i=e.objectName,n=e.propertyName;let r=e.propertyIndex;if(t||(t=yL.findNode(this.rootNode,e.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return;if(i){let n=e.objectIndex;switch(i){case"materials":if(!t.material)return;if(!t.material.materials)return;t=t.material.materials;break;case"bones":if(!t.skeleton)return;t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===n){n=e;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return;if(!t.material.map)return;t=t.material.map;break;default:if(void 0===t[i])return;t=t[i]}if(void 0!==n){if(void 0===t[n])return;t=t[n]}}const s=t[n];if(void 0===s)return;let o=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?o=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(o=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===n){if(!t.geometry)return;if(!t.geometry.morphAttributes)return;void 0!==t.morphTargetDictionary[r]&&(r=t.morphTargetDictionary[r])}a=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(a=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}yL.Composite=class{constructor(t,e,i){const n=i||yL.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,n)}getValue(t,e){this.bind();const i=this._bindings[this._targetGroup.nCachedObjects_];void 0!==i&&i.getValue(t,e)}setValue(t,e){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,r=i.length;n!==r;++n)i[n].setValue(t,e)}bind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()}unbind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}},yL.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},yL.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},yL.prototype.GetterByBindingType=[yL.prototype._getValue_direct,yL.prototype._getValue_array,yL.prototype._getValue_arrayElement,yL.prototype._getValue_toArray],yL.prototype.SetterByBindingTypeAndVersioning=[[yL.prototype._setValue_direct,yL.prototype._setValue_direct_setNeedsUpdate,yL.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[yL.prototype._setValue_array,yL.prototype._setValue_array_setNeedsUpdate,yL.prototype._setValue_array_setMatrixWorldNeedsUpdate],[yL.prototype._setValue_arrayElement,yL.prototype._setValue_arrayElement_setNeedsUpdate,yL.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[yL.prototype._setValue_fromArray,yL.prototype._setValue_fromArray_setNeedsUpdate,yL.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class vL{constructor(t,e,i=null,n=e.blendMode){this._mixer=t,this._clip=e,this._localRoot=i,this.blendMode=n;const r=e.tracks,s=r.length,o=new Array(s),a={endingStart:ux,endingEnd:ux};for(let t=0;t!==s;++t){const e=r[t].createInterpolant(null);o[t]=e,e.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(s),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=2201,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(t){return this._startTime=t,this}setLoop(t,e){return this.loop=t,this.repetitions=e,this}setEffectiveWeight(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(t){return this._scheduleFading(t,0,1)}fadeOut(t){return this._scheduleFading(t,1,0)}crossFadeFrom(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){const i=this._clip.duration,n=t._clip.duration,r=i/n;t.warp(1,n/i,e),this.warp(r,1,e)}return this}crossFadeTo(t,e,i){return t.crossFadeFrom(this,e,i)}stopFading(){const t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}setEffectiveTimeScale(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(t){return this.timeScale=this._clip.duration/t,this.stopWarping()}syncWith(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()}halt(t){return this.warp(this._effectiveTimeScale,0,t)}warp(t,e,i){const n=this._mixer,r=n.time,s=this.timeScale;let o=this._timeScaleInterpolant;null===o&&(o=n._lendControlInterpolant(),this._timeScaleInterpolant=o);const a=o.parameterPositions,l=o.sampleValues;return a[0]=r,a[1]=r+i,l[0]=t/s,l[1]=e/s,this}stopWarping(){const t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(t,e,i,n){if(!this.enabled)return void this._updateWeight(t);const r=this._startTime;if(null!==r){const n=(t-r)*i;n<0||0===i?e=0:(this._startTime=null,e=i*n)}e*=this._updateTimeScale(t);const s=this._updateTime(e),o=this._updateWeight(t);if(o>0){const t=this._interpolants,e=this._propertyBindings;if(this.blendMode===mx)for(let i=0,n=t.length;i!==n;++i)t[i].evaluate(s),e[i].accumulateAdditive(o);else for(let i=0,r=t.length;i!==r;++i)t[i].evaluate(s),e[i].accumulate(n,o)}}_updateWeight(t){let e=0;if(this.enabled){e=this.weight;const i=this._weightInterpolant;if(null!==i){const n=i.evaluate(t)[0];e*=n,t>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=e,e}_updateTimeScale(t){let e=0;if(!this.paused){e=this.timeScale;const i=this._timeScaleInterpolant;if(null!==i){e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}}return this._effectiveTimeScale=e,e}_updateTime(t){const e=this._clip.duration,i=this.loop;let n=this.time+t,r=this._loopCount;const s=2202===i;if(0===t)return-1===r?n:s&&1==(1&r)?e-n:n;if(2200===i){-1===r&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(n>=e)n=e;else{if(!(n<0)){this.time=n;break t}n=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{if(-1===r&&(t>=0?(r=0,this._setEndings(!0,0===this.repetitions,s)):this._setEndings(0===this.repetitions,!0,s)),n>=e||n<0){const i=Math.floor(n/e);n-=e*i,r+=Math.abs(i);const o=this.repetitions-r;if(o<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,n=t>0?e:0,this.time=n,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===o){const e=t<0;this._setEndings(e,!e,s)}else this._setEndings(!1,!1,s);this._loopCount=r,this.time=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:i})}}else this.time=n;if(s&&1==(1&r))return e-n}return n}_setEndings(t,e,i){const n=this._interpolantSettings;i?(n.endingStart=dx,n.endingEnd=dx):(n.endingStart=t?this.zeroSlopeAtStart?dx:ux:px,n.endingEnd=e?this.zeroSlopeAtEnd?dx:ux:px)}_scheduleFading(t,e,i){const n=this._mixer,r=n.time;let s=this._weightInterpolant;null===s&&(s=n._lendControlInterpolant(),this._weightInterpolant=s);const o=s.parameterPositions,a=s.sampleValues;return o[0]=r,a[0]=e,o[1]=r+t,a[1]=i,this}}const xL=new Float32Array(1);class bL{constructor(t){this.value=t}clone(){return new bL(void 0===this.value.clone?this.value:this.value.clone())}}let wL=0;class AL extends US{constructor(t,e,i=1){super(t,e),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){const e=super.clone(t);return e.meshPerAttribute=this.meshPerAttribute,e}toJSON(t){const e=super.toJSON(t);return e.isInstancedInterleavedBuffer=!0,e.meshPerAttribute=this.meshPerAttribute,e}}function TL(t,e){return t.distance-e.distance}function ML(t,e,i,n){if(t.layers.test(e.layers)&&t.raycast(e,i),!0===n){const n=t.children;for(let t=0,r=n.length;t<r;t++)ML(n[t],e,i,!0)}}const SL=new Xx;const EL=new Ab,CL=new Ab;const IL=new Ab;const PL=new Ab,LL=new Qb,RL=new Qb;function BL(t){const e=[];!0===t.isBone&&e.push(t);for(let i=0;i<t.children.length;i++)e.push.apply(e,BL(t.children[i]));return e}const DL=new Ab,OL=new Uw,kL=new Uw;const FL=new Ab,zL=new Ab,NL=new Ab;const UL=new Ab,VL=new OA;function jL(t,e,i,n,r,s,o){UL.set(r,s,o).unproject(n);const a=e[t];if(void 0!==a){const t=i.getAttribute("position");for(let e=0,i=a.length;e<i;e++)t.setXYZ(a[e],UL.x,UL.y,UL.z)}}const HL=new Sb;const WL=new Ab;let qL,XL;"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Dy}})),"undefined"!=typeof window&&(window.__THREE__||(window.__THREE__=Dy));var ZL=Object.freeze({__proto__:null,ACESFilmicToneMapping:Yy,AddEquation:Uy,AddOperation:Wy,AdditiveAnimationBlendMode:mx,AdditiveBlending:2,AgXToneMapping:Ky,AlphaFormat:1021,AlwaysCompare:519,AlwaysDepth:1,AlwaysStencilFunc:519,AmbientLight:FP,AnimationAction:vL,AnimationClip:uP,AnimationLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=new vP(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(t,(function(i){try{e(r.parse(JSON.parse(i)))}catch(e){n&&n(e),r.manager.itemError(t)}}),i,n)}parse(t){const e=[];for(let i=0;i<t.length;i++){const n=uP.parse(t[i]);e.push(n)}return e}},AnimationMixer:class extends Bx{constructor(t){super(),this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(t,e){const i=t._localRoot||this._root,n=t._clip.tracks,r=n.length,s=t._propertyBindings,o=t._interpolants,a=i.uuid,l=this._bindingsByRootAndName;let c=l[a];void 0===c&&(c={},l[a]=c);for(let t=0;t!==r;++t){const r=n[t],l=r.name;let h=c[l];if(void 0!==h)++h.referenceCount,s[t]=h;else{if(h=s[t],void 0!==h){null===h._cacheIndex&&(++h.referenceCount,this._addInactiveBinding(h,a,l));continue}h=new uL(yL.create(i,l,e&&e._propertyBindings[t].binding.parsedPath),r.ValueTypeName,r.getValueSize()),++h.referenceCount,this._addInactiveBinding(h,a,l),s[t]=h}o[t].resultBuffer=h.buffer}}_activateAction(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){const e=(t._localRoot||this._root).uuid,i=t._clip.uuid,n=this._actionsByClip[i];this._bindAction(t,n&&n.knownActions[0]),this._addInactiveAction(t,i,e)}const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==i.useCount++&&(this._lendBinding(i),i.saveOriginalState())}this._lendAction(t)}}_deactivateAction(t){if(this._isActiveAction(t)){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.useCount&&(i.restoreOriginalState(),this._takeBackBinding(i))}this._takeBackAction(t)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}}_isActiveAction(t){const e=t._cacheIndex;return null!==e&&e<this._nActiveActions}_addInactiveAction(t,e,i){const n=this._actions,r=this._actionsByClip;let s=r[e];if(void 0===s)s={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,r[e]=s;else{const e=s.knownActions;t._byClipCacheIndex=e.length,e.push(t)}t._cacheIndex=n.length,n.push(t),s.actionByRoot[i]=t}_removeInactiveAction(t){const e=this._actions,i=e[e.length-1],n=t._cacheIndex;i._cacheIndex=n,e[n]=i,e.pop(),t._cacheIndex=null;const r=t._clip.uuid,s=this._actionsByClip,o=s[r],a=o.knownActions,l=a[a.length-1],c=t._byClipCacheIndex;l._byClipCacheIndex=c,a[c]=l,a.pop(),t._byClipCacheIndex=null;delete o.actionByRoot[(t._localRoot||this._root).uuid],0===a.length&&delete s[r],this._removeInactiveBindingsForAction(t)}_removeInactiveBindingsForAction(t){const e=t._propertyBindings;for(let t=0,i=e.length;t!==i;++t){const i=e[t];0==--i.referenceCount&&this._removeInactiveBinding(i)}}_lendAction(t){const e=this._actions,i=t._cacheIndex,n=this._nActiveActions++,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r}_takeBackAction(t){const e=this._actions,i=t._cacheIndex,n=--this._nActiveActions,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r}_addInactiveBinding(t,e,i){const n=this._bindingsByRootAndName,r=this._bindings;let s=n[e];void 0===s&&(s={},n[e]=s),s[i]=t,t._cacheIndex=r.length,r.push(t)}_removeInactiveBinding(t){const e=this._bindings,i=t.binding,n=i.rootNode.uuid,r=i.path,s=this._bindingsByRootAndName,o=s[n],a=e[e.length-1],l=t._cacheIndex;a._cacheIndex=l,e[l]=a,e.pop(),delete o[r],0===Object.keys(o).length&&delete s[n]}_lendBinding(t){const e=this._bindings,i=t._cacheIndex,n=this._nActiveBindings++,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r}_takeBackBinding(t){const e=this._bindings,i=t._cacheIndex,n=--this._nActiveBindings,r=e[n];t._cacheIndex=n,e[n]=t,r._cacheIndex=i,e[i]=r}_lendControlInterpolant(){const t=this._controlInterpolants,e=this._nActiveControlInterpolants++;let i=t[e];return void 0===i&&(i=new eP(new Float32Array(2),new Float32Array(2),1,xL),i.__cacheIndex=e,t[e]=i),i}_takeBackControlInterpolant(t){const e=this._controlInterpolants,i=t.__cacheIndex,n=--this._nActiveControlInterpolants,r=e[n];t.__cacheIndex=n,e[n]=t,r.__cacheIndex=i,e[i]=r}clipAction(t,e,i){const n=e||this._root,r=n.uuid;let s="string"==typeof t?uP.findByName(n,t):t;const o=null!==s?s.uuid:t,a=this._actionsByClip[o];let l=null;if(void 0===i&&(i=null!==s?s.blendMode:fx),void 0!==a){const t=a.actionByRoot[r];if(void 0!==t&&t.blendMode===i)return t;l=a.knownActions[0],null===s&&(s=l._clip)}if(null===s)return null;const c=new vL(this,s,e,i);return this._bindAction(c,l),this._addInactiveAction(c,o,r),c}existingAction(t,e){const i=e||this._root,n=i.uuid,r="string"==typeof t?uP.findByName(i,t):t,s=this._actionsByClip[r?r.uuid:t];return void 0!==s&&s.actionByRoot[n]||null}stopAllAction(){const t=this._actions;for(let e=this._nActiveActions-1;e>=0;--e)t[e].stop();return this}update(t){const e=this._actions,i=this._nActiveActions,n=this.time+=t*=this.timeScale,r=Math.sign(t),s=this._accuIndex^=1;for(let o=0;o!==i;++o){e[o]._update(n,t,r,s)}const o=this._bindings,a=this._nActiveBindings;for(let t=0;t!==a;++t)o[t].apply(s);return this}setTime(t){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(t)}getRoot(){return this._root}uncacheClip(t){const e=this._actions,i=t.uuid,n=this._actionsByClip,r=n[i];if(void 0!==r){const t=r.knownActions;for(let i=0,n=t.length;i!==n;++i){const n=t[i];this._deactivateAction(n);const r=n._cacheIndex,s=e[e.length-1];n._cacheIndex=null,n._byClipCacheIndex=null,s._cacheIndex=r,e[r]=s,e.pop(),this._removeInactiveBindingsForAction(n)}delete n[i]}}uncacheRoot(t){const e=t.uuid,i=this._actionsByClip;for(const t in i){const n=i[t].actionByRoot[e];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}const n=this._bindingsByRootAndName[e];if(void 0!==n)for(const t in n){const e=n[t];e.restoreOriginalState(),this._removeInactiveBinding(e)}}uncacheAction(t,e){const i=this.existingAction(t,e);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}},AnimationObjectGroup:class{constructor(){this.isAnimationObjectGroup=!0,this.uuid=zx(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;const t={};this._indicesByUUID=t;for(let e=0,i=arguments.length;e!==i;++e)t[arguments[e].uuid]=e;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};const e=this;this.stats={objects:{get total(){return e._objects.length},get inUse(){return this.total-e.nCachedObjects_}},get bindingsPerObject(){return e._bindings.length}}}add(){const t=this._objects,e=this._indicesByUUID,i=this._paths,n=this._parsedPaths,r=this._bindings,s=r.length;let o,a=t.length,l=this.nCachedObjects_;for(let c=0,h=arguments.length;c!==h;++c){const h=arguments[c],u=h.uuid;let d=e[u];if(void 0===d){d=a++,e[u]=d,t.push(h);for(let t=0,e=s;t!==e;++t)r[t].push(new yL(h,i[t],n[t]))}else if(d<l){o=t[d];const a=--l,c=t[a];e[c.uuid]=d,t[d]=c,e[u]=a,t[a]=h;for(let t=0,e=s;t!==e;++t){const e=r[t];let s=e[d];e[d]=e[a],void 0===s&&(s=new yL(h,i[t],n[t])),e[a]=s}}}this.nCachedObjects_=l}remove(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_;for(let s=0,o=arguments.length;s!==o;++s){const o=arguments[s],a=o.uuid,l=e[a];if(void 0!==l&&l>=r){const s=r++,c=t[s];e[c.uuid]=l,t[l]=c,e[a]=s,t[s]=o;for(let t=0,e=n;t!==e;++t){const e=i[t],n=e[l];e[l]=e[s],e[s]=n}}}this.nCachedObjects_=r}uncache(){const t=this._objects,e=this._indicesByUUID,i=this._bindings,n=i.length;let r=this.nCachedObjects_,s=t.length;for(let o=0,a=arguments.length;o!==a;++o){const a=arguments[o].uuid,l=e[a];if(void 0!==l)if(delete e[a],l<r){const o=--r,a=t[o],c=--s,h=t[c];e[a.uuid]=l,t[l]=a,e[h.uuid]=o,t[o]=h,t.pop();for(let t=0,e=n;t!==e;++t){const e=i[t],n=e[c];e[l]=e[o],e[o]=n,e.pop()}}else{const r=--s,o=t[r];r>0&&(e[o.uuid]=l),t[l]=o,t.pop();for(let t=0,e=n;t!==e;++t){const e=i[t];e[l]=e[r],e.pop()}}}this.nCachedObjects_=r}subscribe_(t,e){const i=this._bindingsIndicesByPath;let n=i[t];const r=this._bindings;if(void 0!==n)return r[n];const s=this._paths,o=this._parsedPaths,a=this._objects,l=this.nCachedObjects_,c=new Array(a.length);n=r.length,i[t]=n,s.push(t),o.push(e),r.push(c);for(let i=l,n=a.length;i!==n;++i){c[i]=new yL(a[i],t,e)}return c}unsubscribe_(t){const e=this._bindingsIndicesByPath,i=e[t];if(void 0!==i){const n=this._paths,r=this._parsedPaths,s=this._bindings,o=s.length-1,a=s[o];e[t[o]]=i,s[i]=a,s.pop(),r[i]=r[o],r.pop(),n[i]=n[o],n.pop()}}},AnimationUtils:KI,ArcCurve:gC,ArrayCamera:ES,ArrowHelper:class extends Tw{constructor(t=new Ab(0,0,1),e=new Ab(0,0,0),i=1,n=16776960,r=.2*i,s=.2*r){super(),this.type="ArrowHelper",void 0===qL&&(qL=new cA,qL.setAttribute("position",new eA([0,0,0,0,1,0],3)),XL=new NC(0,.5,1,5,1),XL.translate(0,-.5,0)),this.position.copy(e),this.line=new eC(qL,new JE({color:n,toneMapped:!1})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new EA(XL,new Hw({color:n,toneMapped:!1})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i,r,s)}setDirection(t){if(t.y>.99999)this.quaternion.set(0,0,0,1);else if(t.y<-.99999)this.quaternion.set(1,0,0,0);else{WL.set(t.z,0,-t.x).normalize();const e=Math.acos(t.y);this.quaternion.setFromAxisAngle(WL,e)}}setLength(t,e=.2*t,i=.2*e){this.line.scale.set(1,Math.max(1e-4,t-e),1),this.line.updateMatrix(),this.cone.scale.set(i,e,i),this.cone.position.y=t,this.cone.updateMatrix()}setColor(t){this.line.material.color.set(t),this.cone.material.color.set(t)}copy(t){return super.copy(t,!1),this.line.copy(t.line),this.cone.copy(t.cone),this}dispose(){this.line.geometry.dispose(),this.line.material.dispose(),this.cone.geometry.dispose(),this.cone.material.dispose()}},AttachedBindMode:Qy,Audio:oL,AudioAnalyser:class{constructor(t,e=2048){this.analyser=t.context.createAnalyser(),this.analyser.fftSize=e,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.getOutput().connect(this.analyser)}getFrequencyData(){return this.analyser.getByteFrequencyData(this.data),this.data}getAverageFrequency(){let t=0;const e=this.getFrequencyData();for(let i=0;i<e.length;i++)t+=e[i];return t/e.length}},AudioContext:YP,AudioListener:class extends Tw{constructor(){super(),this.type="AudioListener",this.context=YP.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null,this.timeDelta=0,this._clock=new tL}getInput(){return this.gain}removeFilter(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this}getFilter(){return this.filter}setFilter(t){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this}getMasterVolume(){return this.gain.gain.value}setMasterVolume(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}updateMatrixWorld(t){super.updateMatrixWorld(t);const e=this.context.listener,i=this.up;if(this.timeDelta=this._clock.getDelta(),this.matrixWorld.decompose(iL,nL,rL),sL.set(0,0,-1).applyQuaternion(nL),e.positionX){const t=this.context.currentTime+this.timeDelta;e.positionX.linearRampToValueAtTime(iL.x,t),e.positionY.linearRampToValueAtTime(iL.y,t),e.positionZ.linearRampToValueAtTime(iL.z,t),e.forwardX.linearRampToValueAtTime(sL.x,t),e.forwardY.linearRampToValueAtTime(sL.y,t),e.forwardZ.linearRampToValueAtTime(sL.z,t),e.upX.linearRampToValueAtTime(i.x,t),e.upY.linearRampToValueAtTime(i.y,t),e.upZ.linearRampToValueAtTime(i.z,t)}else e.setPosition(iL.x,iL.y,iL.z),e.setOrientation(sL.x,sL.y,sL.z,i.x,i.y,i.z)}},AudioLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=new vP(this.manager);function o(e){n&&n(e),r.manager.itemError(t)}s.setResponseType("arraybuffer"),s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(t,(function(t){try{const i=t.slice(0);YP.getContext().decodeAudioData(i,(function(t){e(t)})).catch(o)}catch(t){o(t)}}),i,n)}},AxesHelper:class extends rC{constructor(t=1){const e=[0,0,0,t,0,0,0,0,0,0,t,0,0,0,0,0,0,t],i=new cA;i.setAttribute("position",new eA(e,3)),i.setAttribute("color",new eA([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));super(i,new JE({vertexColors:!0,toneMapped:!1})),this.type="AxesHelper"}setColors(t,e,i){const n=new Uw,r=this.geometry.attributes.color.array;return n.set(t),n.toArray(r,0),n.toArray(r,3),n.set(e),n.toArray(r,6),n.toArray(r,9),n.set(i),n.toArray(r,12),n.toArray(r,15),this.geometry.attributes.color.needsUpdate=!0,this}dispose(){this.geometry.dispose(),this.material.dispose()}},BackSide:Ny,BasicDepthPacking:3200,BasicShadowMap:0,BatchedMesh:ZE,Bone:yE,BooleanKeyframeTrack:rP,Box2:class{constructor(t=new Xx(1/0,1/0),e=new Xx(-1/0,-1/0)){this.isBox2=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=SL.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,SL).distanceTo(t)}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}},Box3:Sb,Box3Helper:class extends rC{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new cA;n.setIndex(new Kw(i,1)),n.setAttribute("position",new eA([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),super(n,new JE({color:e,toneMapped:!1})),this.box=t,this.type="Box3Helper",this.geometry.computeBoundingSphere()}updateMatrixWorld(t){const e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(t))}dispose(){this.geometry.dispose(),this.material.dispose()}},BoxGeometry:IA,BoxHelper:class extends rC{constructor(t,e=16776960){const i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),r=new cA;r.setIndex(new Kw(i,1)),r.setAttribute("position",new Kw(n,3)),super(r,new JE({color:e,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){if(void 0!==this.object&&HL.setFromObject(this.object),HL.isEmpty())return;const e=HL.min,i=HL.max,n=this.geometry.attributes.position,r=n.array;r[0]=i.x,r[1]=i.y,r[2]=i.z,r[3]=e.x,r[4]=i.y,r[5]=i.z,r[6]=e.x,r[7]=e.y,r[8]=i.z,r[9]=i.x,r[10]=e.y,r[11]=i.z,r[12]=i.x,r[13]=i.y,r[14]=e.z,r[15]=e.x,r[16]=i.y,r[17]=e.z,r[18]=e.x,r[19]=e.y,r[20]=e.z,r[21]=i.x,r[22]=e.y,r[23]=e.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}},BufferAttribute:Kw,BufferGeometry:cA,BufferGeometryLoader:HP,ByteType:1010,Cache:pP,Camera:OA,CameraHelper:class extends rC{constructor(t){const e=new cA,i=new JE({color:16777215,vertexColors:!0,toneMapped:!1}),n=[],r=[],s={};function o(t,e){a(t),a(e)}function a(t){n.push(0,0,0),r.push(0,0,0),void 0===s[t]&&(s[t]=[]),s[t].push(n.length/3-1)}o("n1","n2"),o("n2","n4"),o("n4","n3"),o("n3","n1"),o("f1","f2"),o("f2","f4"),o("f4","f3"),o("f3","f1"),o("n1","f1"),o("n2","f2"),o("n3","f3"),o("n4","f4"),o("p","n1"),o("p","n2"),o("p","n3"),o("p","n4"),o("u1","u2"),o("u2","u3"),o("u3","u1"),o("c","t"),o("p","c"),o("cn1","cn2"),o("cn3","cn4"),o("cf1","cf2"),o("cf3","cf4"),e.setAttribute("position",new eA(n,3)),e.setAttribute("color",new eA(r,3)),super(e,i),this.type="CameraHelper",this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update();const l=new Uw(16755200),c=new Uw(16711680),h=new Uw(43775),u=new Uw(16777215),d=new Uw(3355443);this.setColors(l,c,h,u,d)}setColors(t,e,i,n,r){const s=this.geometry.getAttribute("color");s.setXYZ(0,t.r,t.g,t.b),s.setXYZ(1,t.r,t.g,t.b),s.setXYZ(2,t.r,t.g,t.b),s.setXYZ(3,t.r,t.g,t.b),s.setXYZ(4,t.r,t.g,t.b),s.setXYZ(5,t.r,t.g,t.b),s.setXYZ(6,t.r,t.g,t.b),s.setXYZ(7,t.r,t.g,t.b),s.setXYZ(8,t.r,t.g,t.b),s.setXYZ(9,t.r,t.g,t.b),s.setXYZ(10,t.r,t.g,t.b),s.setXYZ(11,t.r,t.g,t.b),s.setXYZ(12,t.r,t.g,t.b),s.setXYZ(13,t.r,t.g,t.b),s.setXYZ(14,t.r,t.g,t.b),s.setXYZ(15,t.r,t.g,t.b),s.setXYZ(16,t.r,t.g,t.b),s.setXYZ(17,t.r,t.g,t.b),s.setXYZ(18,t.r,t.g,t.b),s.setXYZ(19,t.r,t.g,t.b),s.setXYZ(20,t.r,t.g,t.b),s.setXYZ(21,t.r,t.g,t.b),s.setXYZ(22,t.r,t.g,t.b),s.setXYZ(23,t.r,t.g,t.b),s.setXYZ(24,e.r,e.g,e.b),s.setXYZ(25,e.r,e.g,e.b),s.setXYZ(26,e.r,e.g,e.b),s.setXYZ(27,e.r,e.g,e.b),s.setXYZ(28,e.r,e.g,e.b),s.setXYZ(29,e.r,e.g,e.b),s.setXYZ(30,e.r,e.g,e.b),s.setXYZ(31,e.r,e.g,e.b),s.setXYZ(32,i.r,i.g,i.b),s.setXYZ(33,i.r,i.g,i.b),s.setXYZ(34,i.r,i.g,i.b),s.setXYZ(35,i.r,i.g,i.b),s.setXYZ(36,i.r,i.g,i.b),s.setXYZ(37,i.r,i.g,i.b),s.setXYZ(38,n.r,n.g,n.b),s.setXYZ(39,n.r,n.g,n.b),s.setXYZ(40,r.r,r.g,r.b),s.setXYZ(41,r.r,r.g,r.b),s.setXYZ(42,r.r,r.g,r.b),s.setXYZ(43,r.r,r.g,r.b),s.setXYZ(44,r.r,r.g,r.b),s.setXYZ(45,r.r,r.g,r.b),s.setXYZ(46,r.r,r.g,r.b),s.setXYZ(47,r.r,r.g,r.b),s.setXYZ(48,r.r,r.g,r.b),s.setXYZ(49,r.r,r.g,r.b),s.needsUpdate=!0}update(){const t=this.geometry,e=this.pointMap;VL.projectionMatrixInverse.copy(this.camera.projectionMatrixInverse),jL("c",e,t,VL,0,0,-1),jL("t",e,t,VL,0,0,1),jL("n1",e,t,VL,-1,-1,-1),jL("n2",e,t,VL,1,-1,-1),jL("n3",e,t,VL,-1,1,-1),jL("n4",e,t,VL,1,1,-1),jL("f1",e,t,VL,-1,-1,1),jL("f2",e,t,VL,1,-1,1),jL("f3",e,t,VL,-1,1,1),jL("f4",e,t,VL,1,1,1),jL("u1",e,t,VL,.7,1.1,-1),jL("u2",e,t,VL,-.7,1.1,-1),jL("u3",e,t,VL,0,2,-1),jL("cf1",e,t,VL,-1,0,1),jL("cf2",e,t,VL,1,0,1),jL("cf3",e,t,VL,0,-1,1),jL("cf4",e,t,VL,0,1,1),jL("cn1",e,t,VL,-1,0,-1),jL("cn2",e,t,VL,1,0,-1),jL("cn3",e,t,VL,0,-1,-1),jL("cn4",e,t,VL,0,1,-1),t.getAttribute("position").needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},CanvasTexture:class extends gb{constructor(t,e,i,n,r,s,o,a,l){super(t,e,i,n,r,s,o,a,l),this.isCanvasTexture=!0,this.needsUpdate=!0}},CapsuleGeometry:FC,CatmullRomCurve3:wC,CineonToneMapping:Jy,CircleGeometry:zC,ClampToEdgeWrapping:lv,Clock:tL,Color:Uw,ColorKeyframeTrack:sP,ColorManagement:ab,CompressedArrayTexture:class extends pC{constructor(t,e,i,n,r,s){super(t,e,i,r,s),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=lv}},CompressedCubeTexture:class extends pC{constructor(t,e,i){super(void 0,t[0].width,t[0].height,e,i,iv),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=t}},CompressedTexture:pC,CompressedTextureLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=[],o=new pC,a=new vP(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(r.withCredentials);let l=0;function c(c){a.load(t[c],(function(t){const i=r.parse(t,!0);s[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},l+=1,6===l&&(1===i.mipmapCount&&(o.minFilter=pv),o.image=s,o.format=i.format,o.needsUpdate=!0,e&&e(o))}),i,n)}if(Array.isArray(t))for(let e=0,i=t.length;e<i;++e)c(e);else a.load(t,(function(t){const i=r.parse(t,!0);if(i.isCubemap){const t=i.mipmaps.length/i.mipmapCount;for(let e=0;e<t;e++){s[e]={mipmaps:[]};for(let t=0;t<i.mipmapCount;t++)s[e].mipmaps.push(i.mipmaps[e*i.mipmapCount+t]),s[e].format=i.format,s[e].width=i.width,s[e].height=i.height}o.image=s}else o.image.width=i.width,o.image.height=i.height,o.mipmaps=i.mipmaps;1===i.mipmapCount&&(o.minFilter=pv),o.format=i.format,o.needsUpdate=!0,e&&e(o)}),i,n);return o}},ConeGeometry:UC,ConstantAlphaFactor:213,ConstantColorFactor:211,CubeCamera:GA,CubeReflectionMapping:iv,CubeRefractionMapping:nv,CubeTexture:VA,CubeTextureLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=new VA;r.colorSpace=vx;const s=new xP(this.manager);s.setCrossOrigin(this.crossOrigin),s.setPath(this.path);let o=0;function a(i){s.load(t[i],(function(t){r.images[i]=t,o++,6===o&&(r.needsUpdate=!0,e&&e(r))}),void 0,n)}for(let e=0;e<t.length;++e)a(e);return r}},CubeUVReflectionMapping:ov,CubicBezierCurve:SC,CubicBezierCurve3:EC,CubicInterpolant:tP,CullFaceBack:1,CullFaceFront:2,CullFaceFrontBack:3,CullFaceNone:0,Curve:fC,CurvePath:DC,CustomBlending:5,CustomToneMapping:$y,CylinderGeometry:NC,Cylindrical:class{constructor(t=1,e=0,i=0){return this.radius=t,this.theta=e,this.y=i,this}set(t,e,i){return this.radius=t,this.theta=e,this.y=i,this}copy(t){return this.radius=t.radius,this.theta=t.theta,this.y=t.y,this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+i*i),this.theta=Math.atan2(t,i),this.y=e,this}clone(){return(new this.constructor).copy(this)}},Data3DTexture:bb,DataArrayTexture:xb,DataTexture:vE,DataTextureLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=new vE,o=new vP(this.manager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(r.withCredentials),o.load(t,(function(t){let i;try{i=r.parse(t)}catch(t){if(void 0===n)return;n(t)}void 0!==i.image?s.image=i.image:void 0!==i.data&&(s.image.width=i.width,s.image.height=i.height,s.image.data=i.data),s.wrapS=void 0!==i.wrapS?i.wrapS:lv,s.wrapT=void 0!==i.wrapT?i.wrapT:lv,s.magFilter=void 0!==i.magFilter?i.magFilter:pv,s.minFilter=void 0!==i.minFilter?i.minFilter:pv,s.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.colorSpace?s.colorSpace=i.colorSpace:void 0!==i.encoding&&(s.encoding=i.encoding),void 0!==i.flipY&&(s.flipY=i.flipY),void 0!==i.format&&(s.format=i.format),void 0!==i.type&&(s.type=i.type),void 0!==i.mipmaps&&(s.mipmaps=i.mipmaps,s.minFilter=mv),1===i.mipmapCount&&(s.minFilter=pv),void 0!==i.generateMipmaps&&(s.generateMipmaps=i.generateMipmaps),s.needsUpdate=!0,e&&e(s,i)}),i,n),s}},DataUtils:Jw,DecrementStencilOp:7683,DecrementWrapStencilOp:34056,DefaultLoadingManager:mP,DepthFormat:Sv,DepthStencilFormat:Ev,DepthTexture:kT,DetachedBindMode:tv,DirectionalLight:kP,DirectionalLightHelper:class extends Tw{constructor(t,e,i){super(),this.light=t,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,this.type="DirectionalLightHelper",void 0===e&&(e=1);let n=new cA;n.setAttribute("position",new eA([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));const r=new JE({fog:!1,toneMapped:!1});this.lightPlane=new eC(n,r),this.add(this.lightPlane),n=new cA,n.setAttribute("position",new eA([0,0,0,0,0,1],3)),this.targetLine=new eC(n,r),this.add(this.targetLine),this.update()}dispose(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1),FL.setFromMatrixPosition(this.light.matrixWorld),zL.setFromMatrixPosition(this.light.target.matrixWorld),NL.subVectors(zL,FL),this.lightPlane.lookAt(zL),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(zL),this.targetLine.scale.z=NL.length()}},DiscreteInterpolant:iP,DisplayP3ColorSpace:bx,DodecahedronGeometry:VC,DoubleSide:2,DstAlphaFactor:206,DstColorFactor:208,DynamicCopyUsage:35050,DynamicDrawUsage:35048,DynamicReadUsage:35049,EdgesGeometry:XC,EllipseCurve:mC,EqualCompare:514,EqualDepth:4,EqualStencilFunc:514,EquirectangularReflectionMapping:rv,EquirectangularRefractionMapping:sv,Euler:cw,EventDispatcher:Bx,ExtrudeGeometry:AI,FileLoader:vP,Float16BufferAttribute:class extends Kw{constructor(t,e,i){super(new Uint16Array(t),e,i),this.isFloat16BufferAttribute=!0}getX(t){let e=Zw(this.array[t*this.itemSize]);return this.normalized&&(e=Hx(e,this.array)),e}setX(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize]=Xw(e),this}getY(t){let e=Zw(this.array[t*this.itemSize+1]);return this.normalized&&(e=Hx(e,this.array)),e}setY(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+1]=Xw(e),this}getZ(t){let e=Zw(this.array[t*this.itemSize+2]);return this.normalized&&(e=Hx(e,this.array)),e}setZ(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+2]=Xw(e),this}getW(t){let e=Zw(this.array[t*this.itemSize+3]);return this.normalized&&(e=Hx(e,this.array)),e}setW(t,e){return this.normalized&&(e=Wx(e,this.array)),this.array[t*this.itemSize+3]=Xw(e),this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array)),this.array[t+0]=Xw(e),this.array[t+1]=Xw(i),this}setXYZ(t,e,i,n){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array)),this.array[t+0]=Xw(e),this.array[t+1]=Xw(i),this.array[t+2]=Xw(n),this}setXYZW(t,e,i,n,r){return t*=this.itemSize,this.normalized&&(e=Wx(e,this.array),i=Wx(i,this.array),n=Wx(n,this.array),r=Wx(r,this.array)),this.array[t+0]=Xw(e),this.array[t+1]=Xw(i),this.array[t+2]=Xw(n),this.array[t+3]=Xw(r),this}},Float32BufferAttribute:eA,Float64BufferAttribute:class extends Kw{constructor(t,e,i){super(new Float64Array(t),e,i)}},FloatType:xv,Fog:zS,FogExp2:FS,FramebufferTexture:class extends gb{constructor(t,e){super({width:t,height:e}),this.isFramebufferTexture=!0,this.magFilter=hv,this.minFilter=hv,this.generateMipmaps=!1,this.needsUpdate=!0}},FrontSide:zy,Frustum:YA,GLBufferAttribute:class{constructor(t,e,i,n,r){this.isGLBufferAttribute=!0,this.name="",this.buffer=t,this.type=e,this.itemSize=i,this.elementSize=n,this.count=r,this.version=0}set needsUpdate(t){!0===t&&this.version++}setBuffer(t){return this.buffer=t,this}setType(t,e){return this.type=t,this.elementSize=e,this}setItemSize(t){return this.itemSize=t,this}setCount(t){return this.count=t,this}},GLSL1:"100",GLSL3:Ix,GreaterCompare:516,GreaterDepth:6,GreaterEqualCompare:518,GreaterEqualDepth:5,GreaterEqualStencilFunc:518,GreaterStencilFunc:516,GridHelper:class extends rC{constructor(t=10,e=10,i=4473924,n=8947848){i=new Uw(i),n=new Uw(n);const r=e/2,s=t/e,o=t/2,a=[],l=[];for(let t=0,c=0,h=-o;t<=e;t++,h+=s){a.push(-o,0,h,o,0,h),a.push(h,0,-o,h,0,o);const e=t===r?i:n;e.toArray(l,c),c+=3,e.toArray(l,c),c+=3,e.toArray(l,c),c+=3,e.toArray(l,c),c+=3}const c=new cA;c.setAttribute("position",new eA(a,3)),c.setAttribute("color",new eA(l,3));super(c,new JE({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}},Group:CS,HalfFloatType:bv,HemisphereLight:AP,HemisphereLightHelper:class extends Tw{constructor(t,e,i){super(),this.light=t,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,this.type="HemisphereLightHelper";const n=new SI(e);n.rotateY(.5*Math.PI),this.material=new Hw({wireframe:!0,fog:!1,toneMapped:!1}),void 0===this.color&&(this.material.vertexColors=!0);const r=n.getAttribute("position"),s=new Float32Array(3*r.count);n.setAttribute("color",new Kw(s,3)),this.add(new EA(n,this.material)),this.update()}dispose(){this.children[0].geometry.dispose(),this.children[0].material.dispose()}update(){const t=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{const e=t.geometry.getAttribute("color");OL.copy(this.light.color),kL.copy(this.light.groundColor);for(let t=0,i=e.count;t<i;t++){const n=t<i/2?OL:kL;e.setXYZ(t,n.r,n.g,n.b)}e.needsUpdate=!0}this.light.updateWorldMatrix(!0,!1),t.lookAt(DL.setFromMatrixPosition(this.light.matrixWorld).negate())}},IcosahedronGeometry:MI,ImageBitmapLoader:ZP,ImageLoader:xP,ImageUtils:ub,IncrementStencilOp:7682,IncrementWrapStencilOp:34055,InstancedBufferAttribute:AE,InstancedBufferGeometry:jP,InstancedInterleavedBuffer:AL,InstancedMesh:LE,Int16BufferAttribute:class extends Kw{constructor(t,e,i){super(new Int16Array(t),e,i)}},Int32BufferAttribute:class extends Kw{constructor(t,e,i){super(new Int32Array(t),e,i)}},Int8BufferAttribute:class extends Kw{constructor(t,e,i){super(new Int8Array(t),e,i)}},IntType:yv,InterleavedBuffer:US,InterleavedBufferAttribute:VS,Interpolant:QI,InterpolateDiscrete:lx,InterpolateLinear:cx,InterpolateSmooth:hx,InvertStencilOp:5386,KeepStencilOp:Ex,KeyframeTrack:nP,LOD:aE,LatheGeometry:kC,Layers:hw,LessCompare:513,LessDepth:2,LessEqualCompare:515,LessEqualDepth:3,LessEqualStencilFunc:515,LessStencilFunc:513,Light:wP,LightProbe:UP,Line:eC,Line3:class{constructor(t=new Ab,e=new Ab){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){EL.subVectors(t,this.start),CL.subVectors(this.end,this.start);const i=CL.dot(CL);let n=CL.dot(EL)/i;return e&&(n=Nx(n,0,1)),n}closestPointToPoint(t,e,i){const n=this.closestPointToPointParameter(t,e);return this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}},LineBasicMaterial:JE,LineCurve:CC,LineCurve3:IC,LineDashedMaterial:qI,LineLoop:sC,LineSegments:rC,LinearDisplayP3ColorSpace:wx,LinearEncoding:gx,LinearFilter:pv,LinearInterpolant:eP,LinearMipMapLinearFilter:1008,LinearMipMapNearestFilter:1007,LinearMipmapLinearFilter:mv,LinearMipmapNearestFilter:fv,LinearSRGBColorSpace:xx,LinearToneMapping:Xy,LinearTransfer:Ax,Loader:gP,LoaderUtils:VP,LoadingManager:fP,LoopOnce:2200,LoopPingPong:2202,LoopRepeat:2201,LuminanceAlphaFormat:1025,LuminanceFormat:1024,MOUSE:{LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},Material:jw,MaterialLoader:GP,MathUtils:qx,Matrix3:Zx,Matrix4:Qb,MaxEquation:104,Mesh:EA,MeshBasicMaterial:Hw,MeshDepthMaterial:bS,MeshDistanceMaterial:wS,MeshLambertMaterial:HI,MeshMatcapMaterial:WI,MeshNormalMaterial:jI,MeshPhongMaterial:GI,MeshPhysicalMaterial:UI,MeshStandardMaterial:NI,MeshToonMaterial:VI,MinEquation:103,MirroredRepeatWrapping:cv,MixOperation:Hy,MultiplyBlending:4,MultiplyOperation:jy,NearestFilter:hv,NearestMipMapLinearFilter:1005,NearestMipMapNearestFilter:1004,NearestMipmapLinearFilter:dv,NearestMipmapNearestFilter:uv,NeverCompare:512,NeverDepth:0,NeverStencilFunc:512,NoBlending:0,NoColorSpace:yx,NoToneMapping:qy,NormalAnimationBlendMode:fx,NormalBlending:1,NotEqualCompare:517,NotEqualDepth:7,NotEqualStencilFunc:517,NumberKeyframeTrack:oP,Object3D:Tw,ObjectLoader:class extends gP{constructor(t){super(t)}load(t,e,i,n){const r=this,s=""===this.path?VP.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||s;const o=new vP(this.manager);o.setPath(this.path),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(t,(function(i){let s=null;try{s=JSON.parse(i)}catch(t){return void(void 0!==n&&n(t))}const o=s.metadata;void 0!==o&&void 0!==o.type&&"geometry"!==o.type.toLowerCase()?r.parse(s,e):void 0!==n&&n(new Error("THREE.ObjectLoader: Can't load "+t))}),i,n)}async loadAsync(t,e){const i=""===this.path?VP.extractUrlBase(t):this.path;this.resourcePath=this.resourcePath||i;const n=new vP(this.manager);n.setPath(this.path),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials);const r=await n.loadAsync(t,e),s=JSON.parse(r),o=s.metadata;if(void 0===o||void 0===o.type||"geometry"===o.type.toLowerCase())throw new Error("THREE.ObjectLoader: Can't load "+t);return await this.parseAsync(s)}parse(t,e){const i=this.parseAnimations(t.animations),n=this.parseShapes(t.shapes),r=this.parseGeometries(t.geometries,n),s=this.parseImages(t.images,(function(){void 0!==e&&e(l)})),o=this.parseTextures(t.textures,s),a=this.parseMaterials(t.materials,o),l=this.parseObject(t.object,r,a,o,i),c=this.parseSkeletons(t.skeletons,l);if(this.bindSkeletons(l,c),void 0!==e){let t=!1;for(const e in s)if(s[e].data instanceof HTMLImageElement){t=!0;break}!1===t&&e(l)}return l}async parseAsync(t){const e=this.parseAnimations(t.animations),i=this.parseShapes(t.shapes),n=this.parseGeometries(t.geometries,i),r=await this.parseImagesAsync(t.images),s=this.parseTextures(t.textures,r),o=this.parseMaterials(t.materials,s),a=this.parseObject(t.object,n,o,s,e),l=this.parseSkeletons(t.skeletons,a);return this.bindSkeletons(a,l),a}parseShapes(t){const e={};if(void 0!==t)for(let i=0,n=t.length;i<n;i++){const n=(new ZC).fromJSON(t[i]);e[n.uuid]=n}return e}parseSkeletons(t,e){const i={},n={};if(e.traverse((function(t){t.isBone&&(n[t.uuid]=t)})),void 0!==t)for(let e=0,r=t.length;e<r;e++){const r=(new wE).fromJSON(t[e],n);i[r.uuid]=r}return i}parseGeometries(t,e){const i={};if(void 0!==t){const n=new HP;for(let r=0,s=t.length;r<s;r++){let s;const o=t[r];switch(o.type){case"BufferGeometry":case"InstancedBufferGeometry":s=n.parse(o);break;default:o.type in kI&&(s=kI[o.type].fromJSON(o,e))}s.uuid=o.uuid,void 0!==o.name&&(s.name=o.name),void 0!==o.userData&&(s.userData=o.userData),i[o.uuid]=s}}return i}parseMaterials(t,e){const i={},n={};if(void 0!==t){const r=new GP;r.setTextures(e);for(let e=0,s=t.length;e<s;e++){const s=t[e];void 0===i[s.uuid]&&(i[s.uuid]=r.parse(s)),n[s.uuid]=i[s.uuid]}}return n}parseAnimations(t){const e={};if(void 0!==t)for(let i=0;i<t.length;i++){const n=uP.parse(t[i]);e[n.uuid]=n}return e}parseImages(t,e){const i=this,n={};let r;function s(t){if("string"==typeof t){const e=t;return function(t){return i.manager.itemStart(t),r.load(t,(function(){i.manager.itemEnd(t)}),void 0,(function(){i.manager.itemError(t),i.manager.itemEnd(t)}))}(/^(\/\/)|([a-z]+:(\/\/)?)/i.test(e)?e:i.resourcePath+e)}return t.data?{data:Kx(t.type,t.data),width:t.width,height:t.height}:null}if(void 0!==t&&t.length>0){const i=new fP(e);r=new xP(i),r.setCrossOrigin(this.crossOrigin);for(let e=0,i=t.length;e<i;e++){const i=t[e],r=i.url;if(Array.isArray(r)){const t=[];for(let e=0,i=r.length;e<i;e++){const i=s(r[e]);null!==i&&(i instanceof HTMLImageElement?t.push(i):t.push(new vE(i.data,i.width,i.height)))}n[i.uuid]=new pb(t)}else{const t=s(i.url);n[i.uuid]=new pb(t)}}}return n}async parseImagesAsync(t){const e=this,i={};let n;async function r(t){if("string"==typeof t){const i=t,r=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(i)?i:e.resourcePath+i;return await n.loadAsync(r)}return t.data?{data:Kx(t.type,t.data),width:t.width,height:t.height}:null}if(void 0!==t&&t.length>0){n=new xP(this.manager),n.setCrossOrigin(this.crossOrigin);for(let e=0,n=t.length;e<n;e++){const n=t[e],s=n.url;if(Array.isArray(s)){const t=[];for(let e=0,i=s.length;e<i;e++){const i=s[e],n=await r(i);null!==n&&(n instanceof HTMLImageElement?t.push(n):t.push(new vE(n.data,n.width,n.height)))}i[n.uuid]=new pb(t)}else{const t=await r(n.url);i[n.uuid]=new pb(t)}}}return i}parseTextures(t,e){function i(t,e){return"number"==typeof t?t:e[t]}const n={};if(void 0!==t)for(let r=0,s=t.length;r<s;r++){const s=t[r],o=e[s.image],a=o.data;let l;Array.isArray(a)?(l=new VA,6===a.length&&(l.needsUpdate=!0)):(l=a&&a.data?new vE:new gb,a&&(l.needsUpdate=!0)),l.source=o,l.uuid=s.uuid,void 0!==s.name&&(l.name=s.name),void 0!==s.mapping&&(l.mapping=i(s.mapping,WP)),void 0!==s.channel&&(l.channel=s.channel),void 0!==s.offset&&l.offset.fromArray(s.offset),void 0!==s.repeat&&l.repeat.fromArray(s.repeat),void 0!==s.center&&l.center.fromArray(s.center),void 0!==s.rotation&&(l.rotation=s.rotation),void 0!==s.wrap&&(l.wrapS=i(s.wrap[0],qP),l.wrapT=i(s.wrap[1],qP)),void 0!==s.format&&(l.format=s.format),void 0!==s.internalFormat&&(l.internalFormat=s.internalFormat),void 0!==s.type&&(l.type=s.type),void 0!==s.colorSpace&&(l.colorSpace=s.colorSpace),void 0!==s.encoding&&(l.encoding=s.encoding),void 0!==s.minFilter&&(l.minFilter=i(s.minFilter,XP)),void 0!==s.magFilter&&(l.magFilter=i(s.magFilter,XP)),void 0!==s.anisotropy&&(l.anisotropy=s.anisotropy),void 0!==s.flipY&&(l.flipY=s.flipY),void 0!==s.generateMipmaps&&(l.generateMipmaps=s.generateMipmaps),void 0!==s.premultiplyAlpha&&(l.premultiplyAlpha=s.premultiplyAlpha),void 0!==s.unpackAlignment&&(l.unpackAlignment=s.unpackAlignment),void 0!==s.compareFunction&&(l.compareFunction=s.compareFunction),void 0!==s.userData&&(l.userData=s.userData),n[s.uuid]=l}return n}parseObject(t,e,i,n,r){let s,o,a;function l(t){return e[t]}function c(t){if(void 0!==t){if(Array.isArray(t)){const e=[];for(let n=0,r=t.length;n<r;n++){const r=t[n];e.push(i[r])}return e}return i[t]}}function h(t){return n[t]}switch(t.type){case"Scene":s=new NS,void 0!==t.background&&(s.background=Number.isInteger(t.background)?new Uw(t.background):h(t.background)),void 0!==t.environment&&(s.environment=h(t.environment)),void 0!==t.fog&&("Fog"===t.fog.type?s.fog=new zS(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(s.fog=new FS(t.fog.color,t.fog.density)),""!==t.fog.name&&(s.fog.name=t.fog.name)),void 0!==t.backgroundBlurriness&&(s.backgroundBlurriness=t.backgroundBlurriness),void 0!==t.backgroundIntensity&&(s.backgroundIntensity=t.backgroundIntensity);break;case"PerspectiveCamera":s=new NA(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(s.focus=t.focus),void 0!==t.zoom&&(s.zoom=t.zoom),void 0!==t.filmGauge&&(s.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(s.filmOffset=t.filmOffset),void 0!==t.view&&(s.view=Object.assign({},t.view));break;case"OrthographicCamera":s=new hT(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(s.zoom=t.zoom),void 0!==t.view&&(s.view=Object.assign({},t.view));break;case"AmbientLight":s=new FP(t.color,t.intensity);break;case"DirectionalLight":s=new kP(t.color,t.intensity);break;case"PointLight":s=new DP(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":s=new zP(t.color,t.intensity,t.width,t.height);break;case"SpotLight":s=new IP(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":s=new AP(t.color,t.groundColor,t.intensity);break;case"LightProbe":s=(new UP).fromJSON(t);break;case"SkinnedMesh":o=l(t.geometry),a=c(t.material),s=new _E(o,a),void 0!==t.bindMode&&(s.bindMode=t.bindMode),void 0!==t.bindMatrix&&s.bindMatrix.fromArray(t.bindMatrix),void 0!==t.skeleton&&(s.skeleton=t.skeleton);break;case"Mesh":o=l(t.geometry),a=c(t.material),s=new EA(o,a);break;case"InstancedMesh":o=l(t.geometry),a=c(t.material);const e=t.instanceMatrix,i=t.instanceColor;s=new LE(o,a,t.count),s.instanceMatrix=new AE(new Float32Array(e.array),16),void 0!==i&&(s.instanceColor=new AE(new Float32Array(i.array),i.itemSize));break;case"BatchedMesh":o=l(t.geometry),a=c(t.material),s=new ZE(t.maxGeometryCount,t.maxVertexCount,t.maxIndexCount,a),s.geometry=o,s.perObjectFrustumCulled=t.perObjectFrustumCulled,s.sortObjects=t.sortObjects,s._drawRanges=t.drawRanges,s._reservedRanges=t.reservedRanges,s._visibility=t.visibility,s._active=t.active,s._bounds=t.bounds.map((t=>{const e=new Sb;e.min.fromArray(t.boxMin),e.max.fromArray(t.boxMax);const i=new Hb;return i.radius=t.sphereRadius,i.center.fromArray(t.sphereCenter),{boxInitialized:t.boxInitialized,box:e,sphereInitialized:t.sphereInitialized,sphere:i}})),s._maxGeometryCount=t.maxGeometryCount,s._maxVertexCount=t.maxVertexCount,s._maxIndexCount=t.maxIndexCount,s._geometryInitialized=t.geometryInitialized,s._geometryCount=t.geometryCount,s._matricesTexture=h(t.matricesTexture.uuid);break;case"LOD":s=new aE;break;case"Line":s=new eC(l(t.geometry),c(t.material));break;case"LineLoop":s=new sC(l(t.geometry),c(t.material));break;case"LineSegments":s=new rC(l(t.geometry),c(t.material));break;case"PointCloud":case"Points":s=new uC(l(t.geometry),c(t.material));break;case"Sprite":s=new nE(c(t.material));break;case"Group":s=new CS;break;case"Bone":s=new yE;break;default:s=new Tw}if(s.uuid=t.uuid,void 0!==t.name&&(s.name=t.name),void 0!==t.matrix?(s.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(s.matrixAutoUpdate=t.matrixAutoUpdate),s.matrixAutoUpdate&&s.matrix.decompose(s.position,s.quaternion,s.scale)):(void 0!==t.position&&s.position.fromArray(t.position),void 0!==t.rotation&&s.rotation.fromArray(t.rotation),void 0!==t.quaternion&&s.quaternion.fromArray(t.quaternion),void 0!==t.scale&&s.scale.fromArray(t.scale)),void 0!==t.up&&s.up.fromArray(t.up),void 0!==t.castShadow&&(s.castShadow=t.castShadow),void 0!==t.receiveShadow&&(s.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(s.shadow.bias=t.shadow.bias),void 0!==t.shadow.normalBias&&(s.shadow.normalBias=t.shadow.normalBias),void 0!==t.shadow.radius&&(s.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&s.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(s.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(s.visible=t.visible),void 0!==t.frustumCulled&&(s.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(s.renderOrder=t.renderOrder),void 0!==t.userData&&(s.userData=t.userData),void 0!==t.layers&&(s.layers.mask=t.layers),void 0!==t.children){const o=t.children;for(let t=0;t<o.length;t++)s.add(this.parseObject(o[t],e,i,n,r))}if(void 0!==t.animations){const e=t.animations;for(let t=0;t<e.length;t++){s.animations.push(r[e[t]])}}if("LOD"===t.type){void 0!==t.autoUpdate&&(s.autoUpdate=t.autoUpdate);const e=t.levels;for(let t=0;t<e.length;t++){const i=e[t],n=s.getObjectByProperty("uuid",i.object);void 0!==n&&s.addLevel(n,i.distance,i.hysteresis)}}return s}bindSkeletons(t,e){0!==Object.keys(e).length&&t.traverse((function(t){if(!0===t.isSkinnedMesh&&void 0!==t.skeleton){const i=e[t.skeleton];void 0===i||t.bind(i,t.bindMatrix)}}))}},ObjectSpaceNormalMap:1,OctahedronGeometry:SI,OneFactor:201,OneMinusConstantAlphaFactor:214,OneMinusConstantColorFactor:212,OneMinusDstAlphaFactor:207,OneMinusDstColorFactor:209,OneMinusSrcAlphaFactor:Vy,OneMinusSrcColorFactor:203,OrthographicCamera:hT,P3Primaries:Sx,PCFShadowMap:Oy,PCFSoftShadowMap:ky,PMREMGenerator:bT,Path:OC,PerspectiveCamera:NA,Plane:XA,PlaneGeometry:QA,PlaneHelper:class extends eC{constructor(t,e=1,i=16776960){const n=i,r=new cA;r.setAttribute("position",new eA([1,-1,0,-1,1,0,-1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,-1,0,1,1,0],3)),r.computeBoundingSphere(),super(r,new JE({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=t,this.size=e;const s=new cA;s.setAttribute("position",new eA([1,1,0,-1,1,0,-1,-1,0,1,1,0,-1,-1,0,1,-1,0],3)),s.computeBoundingSphere(),this.add(new EA(s,new Hw({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(t){this.position.set(0,0,0),this.scale.set(.5*this.size,.5*this.size,1),this.lookAt(this.plane.normal),this.translateZ(-this.plane.constant),super.updateMatrixWorld(t)}dispose(){this.geometry.dispose(),this.material.dispose(),this.children[0].geometry.dispose(),this.children[0].material.dispose()}},PointLight:DP,PointLightHelper:class extends EA{constructor(t,e,i){super(new II(e,4,2),new Hw({wireframe:!0,fog:!1,toneMapped:!1})),this.light=t,this.color=i,this.type="PointLightHelper",this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}dispose(){this.geometry.dispose(),this.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)}},Points:uC,PointsMaterial:oC,PolarGridHelper:class extends rC{constructor(t=10,e=16,i=8,n=64,r=4473924,s=8947848){r=new Uw(r),s=new Uw(s);const o=[],a=[];if(e>1)for(let i=0;i<e;i++){const n=i/e*(2*Math.PI),l=Math.sin(n)*t,c=Math.cos(n)*t;o.push(0,0,0),o.push(l,0,c);const h=1&i?r:s;a.push(h.r,h.g,h.b),a.push(h.r,h.g,h.b)}for(let e=0;e<i;e++){const l=1&e?r:s,c=t-t/i*e;for(let t=0;t<n;t++){let e=t/n*(2*Math.PI),i=Math.sin(e)*c,r=Math.cos(e)*c;o.push(i,0,r),a.push(l.r,l.g,l.b),e=(t+1)/n*(2*Math.PI),i=Math.sin(e)*c,r=Math.cos(e)*c,o.push(i,0,r),a.push(l.r,l.g,l.b)}}const l=new cA;l.setAttribute("position",new eA(o,3)),l.setAttribute("color",new eA(a,3));super(l,new JE({vertexColors:!0,toneMapped:!1})),this.type="PolarGridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}},PolyhedronGeometry:GC,PositionalAudio:class extends oL{constructor(t){super(t),this.panner=this.context.createPanner(),this.panner.panningModel="HRTF",this.panner.connect(this.gain)}connect(){super.connect(),this.panner.connect(this.gain)}disconnect(){super.disconnect(),this.panner.disconnect(this.gain)}getOutput(){return this.panner}getRefDistance(){return this.panner.refDistance}setRefDistance(t){return this.panner.refDistance=t,this}getRolloffFactor(){return this.panner.rolloffFactor}setRolloffFactor(t){return this.panner.rolloffFactor=t,this}getDistanceModel(){return this.panner.distanceModel}setDistanceModel(t){return this.panner.distanceModel=t,this}getMaxDistance(){return this.panner.maxDistance}setMaxDistance(t){return this.panner.maxDistance=t,this}setDirectionalCone(t,e,i){return this.panner.coneInnerAngle=t,this.panner.coneOuterAngle=e,this.panner.coneOuterGain=i,this}updateMatrixWorld(t){if(super.updateMatrixWorld(t),!0===this.hasPlaybackControl&&!1===this.isPlaying)return;this.matrixWorld.decompose(aL,lL,cL),hL.set(0,0,1).applyQuaternion(lL);const e=this.panner;if(e.positionX){const t=this.context.currentTime+this.listener.timeDelta;e.positionX.linearRampToValueAtTime(aL.x,t),e.positionY.linearRampToValueAtTime(aL.y,t),e.positionZ.linearRampToValueAtTime(aL.z,t),e.orientationX.linearRampToValueAtTime(hL.x,t),e.orientationY.linearRampToValueAtTime(hL.y,t),e.orientationZ.linearRampToValueAtTime(hL.z,t)}else e.setPosition(aL.x,aL.y,aL.z),e.setOrientation(hL.x,hL.y,hL.z)}},PropertyBinding:yL,PropertyMixer:uL,QuadraticBezierCurve:PC,QuadraticBezierCurve3:LC,Quaternion:wb,QuaternionKeyframeTrack:lP,QuaternionLinearInterpolant:aP,RED_GREEN_RGTC2_Format:ox,RED_RGTC1_Format:36283,REVISION:Dy,RGBADepthPacking:3201,RGBAFormat:Mv,RGBAIntegerFormat:Pv,RGBA_ASTC_10x10_Format:Qv,RGBA_ASTC_10x5_Format:Yv,RGBA_ASTC_10x6_Format:$v,RGBA_ASTC_10x8_Format:Kv,RGBA_ASTC_12x10_Format:tx,RGBA_ASTC_12x12_Format:ex,RGBA_ASTC_4x4_Format:Vv,RGBA_ASTC_5x4_Format:jv,RGBA_ASTC_5x5_Format:Hv,RGBA_ASTC_6x5_Format:Wv,RGBA_ASTC_6x6_Format:qv,RGBA_ASTC_8x5_Format:Xv,RGBA_ASTC_8x6_Format:Zv,RGBA_ASTC_8x8_Format:Jv,RGBA_BPTC_Format:ix,RGBA_ETC2_EAC_Format:Gv,RGBA_PVRTC_2BPPV1_Format:zv,RGBA_PVRTC_4BPPV1_Format:Fv,RGBA_S3TC_DXT1_Format:Rv,RGBA_S3TC_DXT3_Format:Bv,RGBA_S3TC_DXT5_Format:Dv,RGB_BPTC_SIGNED_Format:nx,RGB_BPTC_UNSIGNED_Format:rx,RGB_ETC1_Format:Nv,RGB_ETC2_Format:Uv,RGB_PVRTC_2BPPV1_Format:kv,RGB_PVRTC_4BPPV1_Format:Ov,RGB_S3TC_DXT1_Format:Lv,RGFormat:1030,RGIntegerFormat:Iv,RawShaderMaterial:zI,Ray:Kb,Raycaster:class{constructor(t,e,i=0,n=1/0){this.ray=new Kb(t,e),this.near=i,this.far=n,this.camera=null,this.layers=new hw,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){this.ray.set(t,e)}setFromCamera(t,e){e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e.isOrthographicCamera&&(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e)}intersectObject(t,e=!0,i=[]){return ML(t,this,i,e),i.sort(TL),i}intersectObjects(t,e=!0,i=[]){for(let n=0,r=t.length;n<r;n++)ML(t[n],this,i,e);return i.sort(TL),i}},Rec709Primaries:Mx,RectAreaLight:zP,RedFormat:1028,RedIntegerFormat:Cv,ReinhardToneMapping:Zy,RenderTarget:yb,RepeatWrapping:av,ReplaceStencilOp:7681,ReverseSubtractEquation:102,RingGeometry:EI,SIGNED_RED_GREEN_RGTC2_Format:ax,SIGNED_RED_RGTC1_Format:sx,SRGBColorSpace:vx,SRGBTransfer:Tx,Scene:NS,ShaderChunk:tT,ShaderLib:iT,ShaderMaterial:DA,ShadowMaterial:FI,Shape:ZC,ShapeGeometry:CI,ShapePath:class{constructor(){this.type="ShapePath",this.color=new Uw,this.subPaths=[],this.currentPath=null}moveTo(t,e){return this.currentPath=new OC,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e),this}lineTo(t,e){return this.currentPath.lineTo(t,e),this}quadraticCurveTo(t,e,i,n){return this.currentPath.quadraticCurveTo(t,e,i,n),this}bezierCurveTo(t,e,i,n,r,s){return this.currentPath.bezierCurveTo(t,e,i,n,r,s),this}splineThru(t){return this.currentPath.splineThru(t),this}toShapes(t){function e(t,e){const i=e.length;let n=!1;for(let r=i-1,s=0;s<i;r=s++){let i=e[r],o=e[s],a=o.x-i.x,l=o.y-i.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(i=e[s],a=-a,o=e[r],l=-l),t.y<i.y||t.y>o.y)continue;if(t.y===i.y){if(t.x===i.x)return!0}else{const e=l*(t.x-i.x)-a*(t.y-i.y);if(0===e)return!0;if(e<0)continue;n=!n}}else{if(t.y!==i.y)continue;if(o.x<=t.x&&t.x<=i.x||i.x<=t.x&&t.x<=o.x)return!0}}return n}const i=xI.isClockWise,n=this.subPaths;if(0===n.length)return[];let r,s,o;const a=[];if(1===n.length)return s=n[0],o=new ZC,o.curves=s.curves,a.push(o),a;let l=!i(n[0].getPoints());l=t?!l:l;const c=[],h=[];let u,d,p=[],f=0;h[f]=void 0,p[f]=[];for(let e=0,o=n.length;e<o;e++)s=n[e],u=s.getPoints(),r=i(u),r=t?!r:r,r?(!l&&h[f]&&f++,h[f]={s:new ZC,p:u},h[f].s.curves=s.curves,l&&f++,p[f]=[]):p[f].push({h:s,p:u[0]});if(!h[0])return function(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i],r=new ZC;r.curves=n.curves,e.push(r)}return e}(n);if(h.length>1){let t=!1,i=0;for(let t=0,e=h.length;t<e;t++)c[t]=[];for(let n=0,r=h.length;n<r;n++){const r=p[n];for(let s=0;s<r.length;s++){const o=r[s];let a=!0;for(let r=0;r<h.length;r++)e(o.p,h[r].p)&&(n!==r&&i++,a?(a=!1,c[r].push(o)):t=!0);a&&c[n].push(o)}}i>0&&!1===t&&(p=c)}for(let t=0,e=h.length;t<e;t++){o=h[t].s,a.push(o),d=p[t];for(let t=0,e=d.length;t<e;t++)o.holes.push(d[t].h)}return a}},ShapeUtils:xI,ShortType:1011,Skeleton:wE,SkeletonHelper:class extends rC{constructor(t){const e=BL(t),i=new cA,n=[],r=[],s=new Uw(0,0,1),o=new Uw(0,1,0);for(let t=0;t<e.length;t++){const i=e[t];i.parent&&i.parent.isBone&&(n.push(0,0,0),n.push(0,0,0),r.push(s.r,s.g,s.b),r.push(o.r,o.g,o.b))}i.setAttribute("position",new eA(n,3)),i.setAttribute("color",new eA(r,3));super(i,new JE({vertexColors:!0,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.isSkeletonHelper=!0,this.type="SkeletonHelper",this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(t){const e=this.bones,i=this.geometry,n=i.getAttribute("position");RL.copy(this.root.matrixWorld).invert();for(let t=0,i=0;t<e.length;t++){const r=e[t];r.parent&&r.parent.isBone&&(LL.multiplyMatrices(RL,r.matrixWorld),PL.setFromMatrixPosition(LL),n.setXYZ(i,PL.x,PL.y,PL.z),LL.multiplyMatrices(RL,r.parent.matrixWorld),PL.setFromMatrixPosition(LL),n.setXYZ(i+1,PL.x,PL.y,PL.z),i+=2)}i.getAttribute("position").needsUpdate=!0,super.updateMatrixWorld(t)}dispose(){this.geometry.dispose(),this.material.dispose()}},SkinnedMesh:_E,Source:pb,Sphere:Hb,SphereGeometry:II,Spherical:class{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){const t=1e-6;return this.phi=Math.max(t,Math.min(Math.PI-t,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(Nx(e/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}},SphericalHarmonics3:NP,SplineCurve:RC,SpotLight:IP,SpotLightHelper:class extends Tw{constructor(t,e){super(),this.light=t,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e,this.type="SpotLightHelper";const i=new cA,n=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1];for(let t=0,e=1,i=32;t<i;t++,e++){const r=t/i*Math.PI*2,s=e/i*Math.PI*2;n.push(Math.cos(r),Math.sin(r),1,Math.cos(s),Math.sin(s),1)}i.setAttribute("position",new eA(n,3));const r=new JE({fog:!1,toneMapped:!1});this.cone=new rC(i,r),this.add(this.cone),this.update()}dispose(){this.cone.geometry.dispose(),this.cone.material.dispose()}update(){this.light.updateWorldMatrix(!0,!1),this.light.target.updateWorldMatrix(!0,!1);const t=this.light.distance?this.light.distance:1e3,e=t*Math.tan(this.light.angle);this.cone.scale.set(e,e,t),IL.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(IL),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}},Sprite:nE,SpriteMaterial:jS,SrcAlphaFactor:Gy,SrcAlphaSaturateFactor:210,SrcColorFactor:202,StaticCopyUsage:35046,StaticDrawUsage:Cx,StaticReadUsage:35045,StereoCamera:class{constructor(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new NA,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new NA,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1,this._cache={focus:null,fov:null,aspect:null,near:null,far:null,zoom:null,eyeSep:null}}update(t){const e=this._cache;if(e.focus!==t.focus||e.fov!==t.fov||e.aspect!==t.aspect*this.aspect||e.near!==t.near||e.far!==t.far||e.zoom!==t.zoom||e.eyeSep!==this.eyeSep){e.focus=t.focus,e.fov=t.fov,e.aspect=t.aspect*this.aspect,e.near=t.near,e.far=t.far,e.zoom=t.zoom,e.eyeSep=this.eyeSep,QP.copy(t.projectionMatrix);const i=e.eyeSep/2,n=i*e.near/e.focus,r=e.near*Math.tan(kx*e.fov*.5)/e.zoom;let s,o;KP.elements[12]=-i,$P.elements[12]=i,s=-r*e.aspect+n,o=r*e.aspect+n,QP.elements[0]=2*e.near/(o-s),QP.elements[8]=(o+s)/(o-s),this.cameraL.projectionMatrix.copy(QP),s=-r*e.aspect-n,o=r*e.aspect-n,QP.elements[0]=2*e.near/(o-s),QP.elements[8]=(o+s)/(o-s),this.cameraR.projectionMatrix.copy(QP)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(KP),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply($P)}},StreamCopyUsage:35042,StreamDrawUsage:35040,StreamReadUsage:35041,StringKeyframeTrack:cP,SubtractEquation:101,SubtractiveBlending:3,TOUCH:{ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},TangentSpaceNormalMap:0,TetrahedronGeometry:PI,Texture:gb,TextureLoader:bP,TorusGeometry:LI,TorusKnotGeometry:RI,Triangle:Ow,TriangleFanDrawMode:2,TriangleStripDrawMode:1,TrianglesDrawMode:0,TubeGeometry:BI,UVMapping:ev,Uint16BufferAttribute:Qw,Uint32BufferAttribute:tA,Uint8BufferAttribute:class extends Kw{constructor(t,e,i){super(new Uint8Array(t),e,i)}},Uint8ClampedBufferAttribute:class extends Kw{constructor(t,e,i){super(new Uint8ClampedArray(t),e,i)}},Uniform:bL,UniformsGroup:class extends Bx{constructor(){super(),this.isUniformsGroup=!0,Object.defineProperty(this,"id",{value:wL++}),this.name="",this.usage=Cx,this.uniforms=[]}add(t){return this.uniforms.push(t),this}remove(t){const e=this.uniforms.indexOf(t);return-1!==e&&this.uniforms.splice(e,1),this}setName(t){return this.name=t,this}setUsage(t){return this.usage=t,this}dispose(){return this.dispatchEvent({type:"dispose"}),this}copy(t){this.name=t.name,this.usage=t.usage;const e=t.uniforms;this.uniforms.length=0;for(let t=0,i=e.length;t<i;t++){const i=Array.isArray(e[t])?e[t]:[e[t]];for(let t=0;t<i.length;t++)this.uniforms.push(i[t].clone())}return this}clone(){return(new this.constructor).copy(this)}},UniformsLib:eT,UniformsUtils:BA,UnsignedByteType:gv,UnsignedInt248Type:Tv,UnsignedIntType:vv,UnsignedShort4444Type:wv,UnsignedShort5551Type:Av,UnsignedShortType:_v,VSMShadowMap:Fy,Vector2:Xx,Vector3:Ab,Vector4:_b,VectorKeyframeTrack:hP,VideoTexture:class extends gb{constructor(t,e,i,n,r,s,o,a,l){super(t,e,i,n,r,s,o,a,l),this.isVideoTexture=!0,this.minFilter=void 0!==s?s:pv,this.magFilter=void 0!==r?r:pv,this.generateMipmaps=!1;const c=this;"requestVideoFrameCallback"in t&&t.requestVideoFrameCallback((function e(){c.needsUpdate=!0,t.requestVideoFrameCallback(e)}))}clone(){return new this.constructor(this.image).copy(this)}update(){const t=this.image;!1==="requestVideoFrameCallback"in t&&t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}},WebGL1Renderer:kS,WebGL3DRenderTarget:class extends vb{constructor(t=1,e=1,i=1,n={}){super(t,e,n),this.isWebGL3DRenderTarget=!0,this.depth=i,this.texture=new bb(null,t,e,i),this.texture.isRenderTargetTexture=!0}},WebGLArrayRenderTarget:class extends vb{constructor(t=1,e=1,i=1,n={}){super(t,e,n),this.isWebGLArrayRenderTarget=!0,this.depth=i,this.texture=new xb(null,t,e,i),this.texture.isRenderTargetTexture=!0}},WebGLCoordinateSystem:Lx,WebGLCubeRenderTarget:jA,WebGLMultipleRenderTargets:class extends vb{constructor(t=1,e=1,i=1,n={}){super(t,e,n),this.isWebGLMultipleRenderTargets=!0;const r=this.texture;this.texture=[];for(let t=0;t<i;t++)this.texture[t]=r.clone(),this.texture[t].isRenderTargetTexture=!0}setSize(t,e,i=1){if(this.width!==t||this.height!==e||this.depth!==i){this.width=t,this.height=e,this.depth=i;for(let n=0,r=this.texture.length;n<r;n++)this.texture[n].image.width=t,this.texture[n].image.height=e,this.texture[n].image.depth=i;this.dispose()}this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}copy(t){this.dispose(),this.width=t.width,this.height=t.height,this.depth=t.depth,this.scissor.copy(t.scissor),this.scissorTest=t.scissorTest,this.viewport.copy(t.viewport),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.texture.length=0;for(let e=0,i=t.texture.length;e<i;e++)this.texture[e]=t.texture[e].clone(),this.texture[e].isRenderTargetTexture=!0;return this}},WebGLRenderTarget:vb,WebGLRenderer:OS,WebGLUtils:SS,WebGPUCoordinateSystem:Rx,WireframeGeometry:DI,WrapAroundEnding:px,ZeroCurvatureEnding:ux,ZeroFactor:200,ZeroSlopeEnding:dx,ZeroStencilOp:0,_SRGBAFormat:Px,createCanvasElement:tb,sRGBEncoding:_x});const JL=Math.sqrt(3);class YL{constructor(t){const e=this;e.implementation=t,e._tick=e._tick.bind(e),e._onResize=e._onResize.bind(e)}onAdd(t,e){const i=this,n=i.implementation,r=n.id,s=t.map;i.map=t,i.modelOrigin=t.getModelOrigin(),s.addLayer({id:r,type:"custom",renderingMode:"3d",onAdd:(e,r)=>{i._onAdd(e,r),n.onAdd&&n.onAdd(t,{renderer:i.renderer,scene:i.scene,camera:i.camera})},onRemove:(e,r)=>{i._onRemove(e,r),n.onRemove&&n.onRemove(t,{renderer:i.renderer,scene:i.scene,camera:i.camera})},render:i._render.bind(i)},e||"poi"),s.setLayerZoomRange(r,n.minzoom,n.maxzoom)}_onAdd(t,e){const i=this,{_fov:n,width:r,height:s}=t.transform,o=i.renderer=new OS({canvas:t.getCanvas(),context:e}),a=i.scene=new NS,l=N(i.implementation.lightColor,(new Uw).copy(i.map.getLightColor())),c=i.light=new kP(l,.8*Math.PI),h=i.ambientLight=new FP(l,.4*Math.PI);o.outputColorSpace=xx,o.autoClear=!1,a.add(c),a.add(h),a.add(new EA),i.mbox=t,i.camera=new NA(qx.radToDeg(n),r/s),t.on("resize",i._onResize),void 0===i.implementation.lightColor&&i._tick()}_tick(){const t=this,e=t.map,i=e.clock.getTime();if(Math.floor(i/6e4)!==Math.floor(t.lastRefresh/6e4)){const n=e.getLightColor();t.light.color.copy(n),t.ambientLight.color.copy(n),t.lastRefresh=i}t.mbox&&requestAnimationFrame(t._tick)}_onRemove(t){t.off("resize",this._onResize),delete this.mbox}_render(t,e){const{modelOrigin:i,mbox:n,renderer:r,camera:s,light:o,scene:a}=this,{_fov:l,_camera:c,_horizonShift:h,pixelsPerMeter:u,worldSize:d,_pitch:p,width:f,height:m}=n.transform,g=l/2,_=c.position[2]*d/Math.cos(p),y=_/h,v=1e3*u/Math.cos(p),x=s.far=Math.max(y,_+v),b=s.near=m/50,w=Math.tan(g)*b,A=w*f/m,T=(new Qb).fromArray(e),M=(new Qb).makeTranslation(i.x,i.y,0).scale(new Ab(1,-1,1));s.projectionMatrix.makePerspective(-A,A,w,-w,b,x).clone().invert().multiply(T).multiply(M).invert().decompose(s.position,s.quaternion,s.scale);const S=qx.degToRad(n.getBearing()+30);o.position.set(-Math.sin(S),-Math.cos(S),JL).normalize(),r.resetState(),r.render(a,s)}_onResize(t){const e=this.camera,i=t.target.transform;e.aspect=i.width/i.height,e.updateProjectionMatrix()}}const $L=-1,KL=0,QL=1;new Dc,new Dc;const tR=new Dc,eR=new Dc;class iR{constructor(t=[0,0,0],e=0){He(this,"center",void 0),He(this,"radius",void 0),this.radius=-0,this.center=new Dc,this.fromCenterRadius(t,e)}fromCenterRadius(t,e){return this.center.from(t),this.radius=e,this}fromCornerPoints(t,e){return e=tR.from(e),this.center=(new Dc).from(t).add(e).scale(.5),this.radius=this.center.distance(e),this}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.radius===t.radius}clone(){return new iR(this.center,this.radius)}union(t){const e=this.center,i=this.radius,n=t.radius,r=tR.copy(t.center).subtract(e),s=r.magnitude();if(i>=s+n)return this.clone();if(n>=s+i)return t.clone();const o=.5*(i+s+n);return eR.copy(r).scale((-i+o)/s).add(e),this.center.copy(eR),this.radius=o,this}expand(t){const e=tR.from(t).subtract(this.center).magnitude();return e>this.radius&&(this.radius=e),this}transform(t){this.center.transform(t);const e=function(t,e){var i=e[4],n=e[5],r=e[6],s=e[8],o=e[9],a=e[10];return t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(i,n,r),t[2]=Math.hypot(s,o,a),t}(tR,t);return this.radius=Math.max(e[0],Math.max(e[1],e[2]))*this.radius,this}distanceSquaredTo(t){const e=this.distanceTo(t);return e*e}distanceTo(t){const e=tR.from(t).subtract(this.center);return Math.max(0,e.len()-this.radius)}intersectPlane(t){const e=this.radius,i=t.normal.dot(this.center)+t.distance;return i<-e?$L:i<e?KL:QL}}const nR=new Dc,rR=new Dc,sR=new Dc,oR=new Dc,aR=new Dc,lR=new Dc,cR=new Dc,hR=0,uR=1,dR=2,pR=3,fR=4,mR=5,gR=6,_R=7,yR=8;class vR{constructor(t=[0,0,0],e=[0,0,0,0,0,0,0,0,0]){He(this,"center",void 0),He(this,"halfAxes",void 0),this.center=(new Dc).from(t),this.halfAxes=new jc(e)}get halfSize(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2);return[new Dc(t).len(),new Dc(e).len(),new Dc(i).len()]}get quaternion(){const t=this.halfAxes.getColumn(0),e=this.halfAxes.getColumn(1),i=this.halfAxes.getColumn(2),n=new Dc(t).normalize(),r=new Dc(e).normalize(),s=new Dc(i).normalize();return(new Eh).fromMatrix3(new jc([...n,...r,...s]))}fromCenterHalfSizeQuaternion(t,e,i){const n=new Eh(i),r=(new jc).fromQuaternion(n);return r[0]=r[0]*e[0],r[1]=r[1]*e[0],r[2]=r[2]*e[0],r[3]=r[3]*e[1],r[4]=r[4]*e[1],r[5]=r[5]*e[1],r[6]=r[6]*e[2],r[7]=r[7]*e[2],r[8]=r[8]*e[2],this.center=(new Dc).from(t),this.halfAxes=r,this}clone(){return new vR(this.center,this.halfAxes)}equals(t){return this===t||Boolean(t)&&this.center.equals(t.center)&&this.halfAxes.equals(t.halfAxes)}getBoundingSphere(t=new iR){const e=this.halfAxes,i=e.getColumn(0,sR),n=e.getColumn(1,oR),r=e.getColumn(2,aR),s=nR.copy(i).add(n).add(r);return t.center.copy(this.center),t.radius=s.magnitude(),t}intersectPlane(t){const e=this.center,i=t.normal,n=this.halfAxes,r=i.x,s=i.y,o=i.z,a=Math.abs(r*n[hR]+s*n[uR]+o*n[dR])+Math.abs(r*n[pR]+s*n[fR]+o*n[mR])+Math.abs(r*n[gR]+s*n[_R]+o*n[yR]),l=i.dot(e)+t.distance;return l<=-a?$L:l>=a?QL:KL}distanceTo(t){return Math.sqrt(this.distanceSquaredTo(t))}distanceSquaredTo(t){const e=rR.from(t).subtract(this.center),i=this.halfAxes,n=i.getColumn(0,sR),r=i.getColumn(1,oR),s=i.getColumn(2,aR),o=n.magnitude(),a=r.magnitude(),l=s.magnitude();n.normalize(),r.normalize(),s.normalize();let c,h=0;return c=Math.abs(e.dot(n))-o,c>0&&(h+=c*c),c=Math.abs(e.dot(r))-a,c>0&&(h+=c*c),c=Math.abs(e.dot(s))-l,c>0&&(h+=c*c),h}computePlaneDistances(t,e,i=[-0,-0]){let n=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;const s=this.center,o=this.halfAxes,a=o.getColumn(0,sR),l=o.getColumn(1,oR),c=o.getColumn(2,aR),h=lR.copy(a).add(l).add(c).add(s),u=cR.copy(h).subtract(t);let d=e.dot(u);return n=Math.min(d,n),r=Math.max(d,r),h.copy(s).add(a).add(l).subtract(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),h.copy(s).add(a).subtract(l).add(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),h.copy(s).add(a).subtract(l).subtract(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),s.copy(h).subtract(a).add(l).add(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),s.copy(h).subtract(a).add(l).subtract(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),s.copy(h).subtract(a).subtract(l).add(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),s.copy(h).subtract(a).subtract(l).subtract(c),u.copy(h).subtract(t),d=e.dot(u),n=Math.min(d,n),r=Math.max(d,r),i[0]=n,i[1]=r,i}transform(t){this.center.transformAsPoint(t);const e=this.halfAxes.getColumn(0,sR);e.transformAsPoint(t);const i=this.halfAxes.getColumn(1,oR);i.transformAsPoint(t);const n=this.halfAxes.getColumn(2,aR);return n.transformAsPoint(t),this.halfAxes=new jc([...e,...i,...n]),this}getTransform(){throw new Error("not implemented")}}const xR=new Dc,bR=new Dc;class wR{constructor(t=[0,0,1],e=0){He(this,"normal",void 0),He(this,"distance",void 0),this.normal=new Dc,this.distance=-0,this.fromNormalDistance(t,e)}fromNormalDistance(t,e){return Xl(Number.isFinite(e)),this.normal.from(t).normalize(),this.distance=e,this}fromPointNormal(t,e){t=xR.from(t),this.normal.from(e).normalize();const i=-this.normal.dot(t);return this.distance=i,this}fromCoefficients(t,e,i,n){return this.normal.set(t,e,i),Xl(rc(this.normal.len(),1)),this.distance=n,this}clone(){return new wR(this.normal,this.distance)}equals(t){return rc(this.distance,t.distance)&&rc(this.normal,t.normal)}getPointDistance(t){return this.normal.dot(t)+this.distance}transform(t){const e=bR.copy(this.normal).transformAsVector(t).normalize(),i=this.normal.scale(-this.distance).transform(t);return this.fromPointNormal(i,e)}projectPointOntoPlane(t,e=[0,0,0]){t=xR.from(t);const i=this.getPointDistance(t),n=bR.copy(this.normal).scale(i);return t.subtract(n).to(e)}}const AR=[new Dc([1,0,0]),new Dc([0,1,0]),new Dc([0,0,1])],TR=new Dc,MR=new Dc;new wR(new Dc(1,0,0),0);class SR{constructor(t=[]){He(this,"planes",void 0),this.planes=t}fromBoundingSphere(t){this.planes.length=2*AR.length;const e=t.center,i=t.radius;let n=0;for(const t of AR){let r=this.planes[n],s=this.planes[n+1];r||(r=this.planes[n]=new wR),s||(s=this.planes[n+1]=new wR);const o=TR.copy(t).scale(-i).add(e);t.dot(o),r.fromPointNormal(o,t);const a=TR.copy(t).scale(i).add(e),l=MR.copy(t).negate();l.dot(a),s.fromPointNormal(a,l),n+=2}return this}computeVisibility(t){let e=QL;for(const i of this.planes){switch(t.intersectPlane(i)){case $L:return $L;case KL:e=KL}}return e}computeVisibilityWithPlaneMask(t,e){if(Xl(Number.isFinite(e),"parentPlaneMask is required."),e===SR.MASK_OUTSIDE||e===SR.MASK_INSIDE)return e;let i=SR.MASK_INSIDE;const n=this.planes;for(let r=0;r<this.planes.length;++r){const s=r<31?1<<r:0;if(r<31&&0==(e&s))continue;const o=t.intersectPlane(n[r]);if(o===$L)return SR.MASK_OUTSIDE;o===KL&&(i|=s)}return i}}He(SR,"MASK_OUTSIDE",4294967295),He(SR,"MASK_INSIDE",0),He(SR,"MASK_INDETERMINATE",2147483647),new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc,new Dc;const ER=new jc,CR=new jc,IR=new jc,PR=new jc,LR=new jc;function RR(t,e={}){const i=Ch.EPSILON20;let n=0,r=0;const s=CR,o=IR;s.identity(),o.copy(t);const a=i*function(t){let e=0;for(let i=0;i<9;++i){const n=t[i];e+=n*n}return Math.sqrt(e)}(o);for(;r<10&&OR(o)>a;)kR(o,PR),LR.copy(PR).transpose(),o.multiplyRight(PR),o.multiplyLeft(LR),s.multiplyRight(PR),++n>2&&(++r,n=0);return e.unitary=s.toTarget(e.unitary),e.diagonal=o.toTarget(e.diagonal),e}const BR=[1,0,0],DR=[2,2,1];function OR(t){let e=0;for(let i=0;i<3;++i){const n=t[ER.getElementIndex(DR[i],BR[i])];e+=2*n*n}return Math.sqrt(e)}function kR(t,e){const i=Ch.EPSILON15;let n=0,r=1;for(let e=0;e<3;++e){const i=Math.abs(t[ER.getElementIndex(DR[e],BR[e])]);i>n&&(r=e,n=i)}const s=BR[r],o=DR[r];let a=1,l=0;if(Math.abs(t[ER.getElementIndex(o,s)])>i){const e=(t[ER.getElementIndex(o,o)]-t[ER.getElementIndex(s,s)])/2/t[ER.getElementIndex(o,s)];let i;i=e<0?-1/(-e+Math.sqrt(1+e*e)):1/(e+Math.sqrt(1+e*e)),a=1/Math.sqrt(1+i*i),l=i*a}return jc.IDENTITY.to(e),e[ER.getElementIndex(s,s)]=e[ER.getElementIndex(o,o)]=a,e[ER.getElementIndex(o,s)]=l,e[ER.getElementIndex(s,o)]=-l,e}const FR=new Dc,zR=new Dc,NR=new Dc,UR=new Dc,GR=new Dc,VR=new jc,jR={diagonal:new jc,unitary:new jc};const HR=Math.PI/180,WR=new Float32Array(16),qR=new Float32Array(12);function XR(t,e,i){const n=e[0]*HR,r=e[1]*HR,s=e[2]*HR,o=Math.sin(s),a=Math.sin(n),l=Math.sin(r),c=Math.cos(s),h=Math.cos(n),u=Math.cos(r),d=i[0],p=i[1],f=i[2];t[0]=d*u*h,t[1]=d*l*h,t[2]=d*-a,t[3]=p*(-l*c+u*a*o),t[4]=p*(u*c+l*a*o),t[5]=p*h*o,t[6]=f*(l*o+u*a*c),t[7]=f*(-u*o+l*a*c),t[8]=f*h*c}function ZR(t){return t[0]=t[0],t[1]=t[1],t[2]=t[2],t[3]=t[4],t[4]=t[5],t[5]=t[6],t[6]=t[8],t[7]=t[9],t[8]=t[10],t[9]=t[12],t[10]=t[13],t[11]=t[14],t.subarray(0,12)}const JR={size:12,accessor:["getOrientation","getScale","getTranslation","getTransformMatrix"],shaderAttributes:{instanceModelMatrix__LOCATION_0:{size:3,elementOffset:0},instanceModelMatrix__LOCATION_1:{size:3,elementOffset:3},instanceModelMatrix__LOCATION_2:{size:3,elementOffset:6},instanceTranslation:{size:3,elementOffset:9}},update(t,{startRow:e,endRow:i}){const{data:n,getOrientation:r,getScale:s,getTranslation:o,getTransformMatrix:a}=this.props,l=Array.isArray(a),c=l&&16===a.length,h=Array.isArray(s),u=Array.isArray(r),d=Array.isArray(o),p=c||!l&&Boolean(a(n[0]));t.constant=p?c:u&&h&&d;const f=t.value;if(t.constant){let e;if(p)WR.set(a),e=ZR(WR);else{e=qR;XR(e,r,s),e.set(o,9)}t.value=new Float32Array(e)}else{let l=e*t.size;const{iterable:m,objectInfo:g}=Jf(n,e,i);for(const t of m){let e;if(g.index++,p)WR.set(c?a:a(t,g)),e=ZR(WR);else{e=qR;XR(e,u?r:r(t,g),h?s:s(t,g)),e.set(d?o:o(t,g),9)}f[l++]=e[0],f[l++]=e[1],f[l++]=e[2],f[l++]=e[3],f[l++]=e[4],f[l++]=e[5],f[l++]=e[6],f[l++]=e[7],f[l++]=e[8],f[l++]=e[9],f[l++]=e[10],f[l++]=e[11]}}}};function YR(t,e){return e===Vr.CARTESIAN||e===Vr.METER_OFFSETS||e===Vr.DEFAULT&&!t.isGeospatial}function $R(t,e){(t.COLOR_0||t.colors)&&e||(t.colors={constant:!0,value:new Float32Array([1,1,1])}),kr.assert(t.positions||t.POSITION,'no "postions" or "POSITION" attribute in mesh')}function KR(t,e){if(t.attributes)return $R(t.attributes,e),t instanceof ru?t:new ru(t);if(t.positions||t.POSITION)return $R(t,e),new ru({attributes:t});throw Error("Invalid mesh")}const QR={mesh:{type:"object",value:null,async:!0},texture:{type:"image",value:null,async:!0},sizeScale:{type:"number",value:1,min:0},_useMeshColors:{type:"boolean",value:!1},_instanced:!0,wireframe:!1,material:!0,getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:[0,0,0,255]},getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]}};class tB extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){const t=!Yr(this.context.gl),e={};return Go(this.context.gl,Fo)&&(e.DERIVATIVES_AVAILABLE=1),super.getShaders({vs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-vs\n\n// Scale the model\nuniform float sizeScale;\nuniform bool composeModelMatrix;\n\n// Primitive attributes\nin vec3 positions;\nin vec3 normals;\nin vec3 colors;\nin vec2 texCoords;\n\n// Instance attributes\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nin vec3 instanceTranslation;\n\n// Outputs to fragment shader\nout vec2 vTexCoord;\nout vec3 cameraPosition;\nout vec3 normals_commonspace;\nout vec4 position_commonspace;\nout vec4 vColor;\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = texCoords;\n  geometry.pickingColor = instancePickingColors;\n\n  vTexCoord = texCoords;\n  cameraPosition = project_uCameraPosition;\n  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);\n\n  vec3 pos = (instanceModelMatrix * positions) * sizeScale + instanceTranslation;\n\n  if (composeModelMatrix) {\n    DECKGL_FILTER_SIZE(pos, geometry);\n    // using instancePositions as world coordinates\n    // when using globe mode, this branch does not re-orient the model to align with the surface of the earth\n    // call project_normal before setting position to avoid rotation\n    normals_commonspace = project_normal(instanceModelMatrix * normals);\n    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), position_commonspace);\n    geometry.position = position_commonspace;\n  }\n  else {\n    pos = project_size(pos);\n    DECKGL_FILTER_SIZE(pos, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, position_commonspace);\n    geometry.position = position_commonspace;\n    normals_commonspace = project_normal(instanceModelMatrix * normals);\n  }\n\n  geometry.normal = normals_commonspace;\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-fs\n\nprecision highp float;\n\nuniform bool hasTexture;\nuniform sampler2D sampler;\nuniform bool flatShading;\nuniform float opacity;\n\nin vec2 vTexCoord;\nin vec3 cameraPosition;\nin vec3 normals_commonspace;\nin vec4 position_commonspace;\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  geometry.uv = vTexCoord;\n\n  vec3 normal;\n  if (flatShading) {\n\n// NOTE(Tarek): This is necessary because\n// headless.gl reports the extension as\n// available but does not support it in\n// the shader.\n#ifdef DERIVATIVES_AVAILABLE\n    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n#else\n    normal = vec3(0.0, 0.0, 1.0);\n#endif\n  } else {\n    normal = normals_commonspace;\n  }\n\n  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;\n  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);\n  fragColor = vec4(lightColor, color.a * opacity);\n\n  DECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",modules:[ip,Nh,np],transpileToGLSL100:t,defines:e})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{transition:!0,type:5130,fp64:this.use64bitPositions(),size:3,accessor:"getPosition"},instanceColors:{type:5121,transition:!0,size:this.props.colorFormat.length,normalized:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceModelMatrix:JR}),this.setState({emptyTexture:new wo(this.context.gl,{data:new Uint8Array(4),width:1,height:1})})}updateState(t){super.updateState(t);const{props:e,oldProps:i,changeFlags:n}=t;if(e.mesh!==i.mesh||n.extensionsChanged){var r;if(null===(r=this.state.model)||void 0===r||r.delete(),e.mesh){this.state.model=this.getModel(e.mesh);const t=e.mesh.attributes||e.mesh;this.setState({hasNormals:Boolean(t.NORMAL||t.normals)})}this.getAttributeManager().invalidateAll()}e.texture!==i.texture&&this.setTexture(e.texture),this.state.model&&this.state.model.setDrawMode(this.props.wireframe?3:4)}finalizeState(t){super.finalizeState(t),this.state.emptyTexture.delete()}draw({uniforms:t}){if(!this.state.model)return;const{viewport:e}=this.context,{sizeScale:i,coordinateSystem:n,_instanced:r}=this.props;this.state.model.setUniforms(t).setUniforms({sizeScale:i,composeModelMatrix:!r||YR(e,n),flatShading:!this.state.hasNormals}).draw()}getModel(t){const e=new Zh(this.context.gl,{...this.getShaders(),id:this.props.id,geometry:KR(t,this.props._useMeshColors),isInstanced:!0}),{texture:i}=this.props,{emptyTexture:n}=this.state;return e.setUniforms({sampler:i||n,hasTexture:Boolean(i)}),e}setTexture(t){const{emptyTexture:e,model:i}=this.state;i&&i.setUniforms({sampler:t||e,hasTexture:Boolean(t)})}}He(tB,"defaultProps",QR),He(tB,"layerName","SimpleMeshLayer");class eB{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:e}=t;this.id=e||$s(this.constructor.name),this.display=!0,this.position=new Dc,this.rotation=new Dc,this.scale=new Dc(1,1,1),this.matrix=new lh,this.userData={},this.props={},this._setScenegraphNodeProps(t)}delete(){}setProps(t){return this._setScenegraphNodeProps(t),this}toString(){return"{type: ScenegraphNode, id: ".concat(this.id,")}")}getBounds(){return null}setPosition(t){return Xs(3===t.length,"setPosition requires vector argument"),this.position=t,this}setRotation(t){return Xs(3===t.length,"setRotation requires vector argument"),this.rotation=t,this}setScale(t){return Xs(3===t.length,"setScale requires vector argument"),this.scale=t,this}setMatrix(t){!(arguments.length>1&&void 0!==arguments[1])||arguments[1]?this.matrix.copy(t):this.matrix=t}setMatrixComponents(t){let{position:e,rotation:i,scale:n,update:r=!0}=t;return e&&this.setPosition(e),i&&this.setRotation(i),n&&this.setScale(n),r&&this.updateMatrix(),this}updateMatrix(){const t=this.position,e=this.rotation,i=this.scale;return this.matrix.identity(),this.matrix.translate(t),this.matrix.rotateXYZ(e),this.matrix.scale(i),this}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{position:e,rotation:i,scale:n}=t;return e&&this.setPosition(e),i&&this.setRotation(i),n&&this.setScale(n),this.updateMatrix(),this}getCoordinateUniforms(t,e){Xs(t),e=e||this.matrix;const i=new lh(t).multiplyRight(e),n=i.invert(),r=n.transpose();return{viewMatrix:t,modelMatrix:e,objectMatrix:e,worldMatrix:i,worldInverseMatrix:n,worldInverseTransposeMatrix:r}}_setScenegraphNodeProps(t){"display"in t&&(this.display=t.display),"position"in t&&this.setPosition(t.position),"rotation"in t&&this.setRotation(t.rotation),"scale"in t&&this.setScale(t.scale),"matrix"in t&&this.setMatrix(t.matrix),Object.assign(this.props,t)}}class iB extends eB{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t=Array.isArray(t)?{children:t}:t;const{children:e=[]}=t;qr.assert(e.every((t=>t instanceof eB)),"every child must an instance of ScenegraphNode"),super(t),this.children=e}add(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];for(const t of e)Array.isArray(t)?this.add(...t):this.children.push(t);return this}remove(t){const e=this.children,i=e.indexOf(t);return i>-1&&e.splice(i,1),this}removeAll(){return this.children=[],this}delete(){this.children.forEach((t=>t.delete())),this.removeAll(),super.delete()}getBounds(){const t=[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]];return this.traverse(((e,i)=>{let{worldMatrix:n}=i;const r=e.getBounds();if(!r)return;const[s,o]=r,a=new Dc(s).add(o).divide([2,2,2]);n.transformAsPoint(a,a);const l=new Dc(o).subtract(s).divide([2,2,2]);n.transformAsVector(l,l);for(let e=0;e<8;e++){const i=new Dc(1&e?-1:1,2&e?-1:1,4&e?-1:1).multiply(l).add(a);for(let e=0;e<3;e++)t[0][e]=Math.min(t[0][e],i[e]),t[1][e]=Math.max(t[1][e],i[e])}})),Number.isFinite(t[0][0])?t:null}traverse(t){let{worldMatrix:e=new lh}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new lh(e).multiplyRight(this.matrix);for(const e of this.children)e instanceof iB?e.traverse(t,{worldMatrix:i}):t(e,{worldMatrix:i})}}const nB={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},rB={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function sB(t){if(!t._animation){const e=rB[t.componentType],i=nB[t.type],n=i*t.count,{buffer:r,byteOffset:s}=t.bufferView.data,o=new e(r,s+(t.byteOffset||0),n);if(1===i)t._animation=Array.from(o);else{const e=[];for(let t=0;t<o.length;t+=i)e.push(Array.from(o.slice(t,t+i)));t._animation=e}}return t._animation}const oB=new lh;const aB=new Eh;function lB(t,e,i,n){let{input:r,interpolation:s,output:o}=e;const a=t%r[r.length-1],l=r.findIndex((t=>t>=a)),c=Math.max(0,l-1);if(!Array.isArray(i[n]))switch(n){case"translation":i[n]=[0,0,0];break;case"rotation":i[n]=[0,0,0,1];break;case"scale":i[n]=[1,1,1];break;default:qr.warn("Bad animation path ".concat(n))()}Xs(i[n].length===o[c].length);const h=r[c],u=r[l];switch(s){case"STEP":!function(t,e,i){for(let n=0;n<i.length;n++)t[e][n]=i[n]}(i,n,o[c]);break;case"LINEAR":if(u>h){!function(t,e,i,n,r){if("rotation"===e){aB.slerp({start:i,target:n,ratio:r});for(let i=0;i<aB.length;i++)t[e][i]=aB[i]}else for(let s=0;s<i.length;s++)t[e][s]=r*n[s]+(1-r)*i[s]}(i,n,o[c],o[l],(a-h)/(u-h))}break;case"CUBICSPLINE":if(u>h){!function(t,e,i){let{p0:n,outTangent0:r,inTangent1:s,p1:o,tDiff:a,ratio:l}=i;for(let i=0;i<t[e].length;i++){const c=r[i]*a,h=s[i]*a;t[e][i]=(2*Math.pow(l,3)-3*Math.pow(l,2)+1)*n[i]+(Math.pow(l,3)-2*Math.pow(l,2)+l)*c+(-2*Math.pow(l,3)+3*Math.pow(l,2))*o[i]+(Math.pow(l,3)-Math.pow(l,2))*h}}(i,n,{p0:o[3*c+1],outTangent0:o[3*c+2],inTangent1:o[3*l+0],p1:o[3*l+1],tDiff:u-h,ratio:(a-h)/(u-h)})}break;default:qr.warn("Interpolation ".concat(s," not supported"))()}}class cB{constructor(t){this.startTime=0,this.playing=!0,this.speed=1,this.channels=[],Object.assign(this,t)}animate(t){if(!this.playing)return;const e=(t/1e3-this.startTime)*this.speed;this.channels.forEach((t=>{let{sampler:i,target:n,path:r}=t;lB(e,i,n,r),function(t,e){if(e.matrix.identity(),t.translation&&e.matrix.translate(t.translation),t.rotation){const i=oB.fromQuaternion(t.rotation);e.matrix.multiplyRight(i)}t.scale&&e.matrix.scale(t.scale)}(n,n._node)}))}}class hB{constructor(t){this.animations=t.animations.map(((e,i)=>{const n=e.name||"Animation-".concat(i),r=e.samplers.map((e=>{let{input:i,interpolation:n="LINEAR",output:r}=e;return{input:sB(t.accessors[i]),interpolation:n,output:sB(t.accessors[r])}})),s=e.channels.map((e=>{let{sampler:i,target:n}=e;return{sampler:r[i],target:t.nodes[n.node],path:n.path}}));return new cB({name:n,channels:s})}))}animate(t){this.setTime(t)}setTime(t){this.animations.forEach((e=>e.animate(t)))}getAnimations(){return this.animations}}class uB extends eB{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e),this.onBeforeRender=null,this.AfterRender=null,t instanceof Zh?(this.model=t,this._setModelNodeProps(e)):this.model=new Zh(t,e),this.bounds=null,this.managedResources=e.managedResources||[]}setProps(t){return super.setProps(t),this._setModelNodeProps(t),this}getBounds(){return this.bounds}delete(){this.model&&(this.model.delete(),this.model=null),this.managedResources.forEach((t=>t.delete())),this.managedResources=[]}draw(){return this.model.draw(...arguments)}setUniforms(){return this.model.setUniforms(...arguments),this}setAttributes(){return this.model.setAttributes(...arguments),this}updateModuleSettings(){return this.model.updateModuleSettings(...arguments),this}_setModelNodeProps(t){this.model.setProps(t)}}class dB{constructor(t,e){let{attributes:i,material:n,pbrDebug:r,imageBasedLightingEnvironment:s,lights:o,useTangents:a}=e;this.gl=t,this.defines={MANUAL_SRGB:1,SRGB_FAST_APPROXIMATION:1},Go(t,zo)&&(this.defines.USE_TEX_LOD=1),this.uniforms={u_Camera:[0,0,0],u_MetallicRoughnessValues:[1,1]},this.parameters={},this.generatedTextures=[],s&&(this.uniforms.u_DiffuseEnvSampler=s.getDiffuseEnvSampler(),this.uniforms.u_SpecularEnvSampler=s.getSpecularEnvSampler(),this.uniforms.u_brdfLUT=s.getBrdfTexture(),this.uniforms.u_ScaleIBLAmbient=[1,1]),r&&(this.uniforms.u_ScaleDiffBaseMR=[0,0,0,0],this.uniforms.u_ScaleFGDSpec=[0,0,0,0]),this.defineIfPresent(i.NORMAL,"HAS_NORMALS"),this.defineIfPresent(i.TANGENT&&a,"HAS_TANGENTS"),this.defineIfPresent(i.TEXCOORD_0,"HAS_UV"),this.defineIfPresent(s,"USE_IBL"),this.defineIfPresent(o,"USE_LIGHTS"),this.defineIfPresent(r,"PBR_DEBUG"),n&&this.parseMaterial(n)}defineIfPresent(t,e){t&&(this.defines[e]=1)}parseTexture(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const n=t.texture.source.image;let r,s={};n.compressed?(r=n,s={[this.gl.TEXTURE_MIN_FILTER]:n.data.length>1?this.gl.LINEAR_MIPMAP_NEAREST:this.gl.LINEAR}):r={data:n};const o=new wo(this.gl,{id:t.name||t.id,parameters:{...t.texture&&t.texture.sampler&&t.texture.sampler.parameters||{},...s},pixelStore:{[this.gl.UNPACK_FLIP_Y_WEBGL]:!1},...r});this.uniforms[e]=o,this.defineIfPresent(i,i),this.generatedTextures.push(o)}parsePbrMetallicRoughness(t){t.baseColorTexture&&this.parseTexture(t.baseColorTexture,"u_BaseColorSampler","HAS_BASECOLORMAP"),this.uniforms.u_BaseColorFactor=t.baseColorFactor||[1,1,1,1],t.metallicRoughnessTexture&&this.parseTexture(t.metallicRoughnessTexture,"u_MetallicRoughnessSampler","HAS_METALROUGHNESSMAP");const{metallicFactor:e=1,roughnessFactor:i=1}=t;this.uniforms.u_MetallicRoughnessValues=[e,i]}parseMaterial(t){if(this.uniforms.pbr_uUnlit=Boolean(t.unlit),t.pbrMetallicRoughness&&this.parsePbrMetallicRoughness(t.pbrMetallicRoughness),t.normalTexture){this.parseTexture(t.normalTexture,"u_NormalSampler","HAS_NORMALMAP");const{scale:e=1}=t.normalTexture;this.uniforms.u_NormalScale=e}if(t.occlusionTexture){this.parseTexture(t.occlusionTexture,"u_OcclusionSampler","HAS_OCCLUSIONMAP");const{strength:e=1}=t.occlusionTexture;this.uniforms.u_OcclusionStrength=e}if(t.emissiveTexture&&(this.parseTexture(t.emissiveTexture,"u_EmissiveSampler","HAS_EMISSIVEMAP"),this.uniforms.u_EmissiveFactor=t.emissiveFactor||[0,0,0]),"MASK"===t.alphaMode){const{alphaCutoff:e=.5}=t;this.defines.ALPHA_CUTOFF=1,this.uniforms.u_AlphaCutoff=e}else"BLEND"===t.alphaMode&&(qr.warn("BLEND alphaMode might not work well because it requires mesh sorting")(),Object.assign(this.parameters,{blend:!0,blendEquation:this.gl.FUNC_ADD,blendFunc:[this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA]}))}delete(){this.generatedTextures.forEach((t=>t.delete()))}}function pB(t,e){return Yr(t)?"#version 300 es\n".concat(e):e}const fB={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},mB={modelOptions:{},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1};class gB{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.options=Object.assign({},mB,e)}instantiate(t){this.gltf=t;return(t.scenes||[]).map((t=>this.createScene(t)))}createAnimator(){return Array.isArray(this.gltf.animations)?new hB(this.gltf):null}createScene(t){const e=(t.nodes||[]).map((t=>this.createNode(t)));return new iB({id:t.name||t.id,children:e})}createNode(t){if(!t._node){const e=(t.children||[]).map((t=>this.createNode(t)));t.mesh&&e.push(this.createMesh(t.mesh));const i=new iB({id:t.name||t.id,children:e});if(t.matrix)i.setMatrix(t.matrix);else{if(i.matrix.identity(),t.translation&&i.matrix.translate(t.translation),t.rotation){const e=(new lh).fromQuaternion(t.rotation);i.matrix.multiplyRight(e)}t.scale&&i.matrix.scale(t.scale)}t._node=i}return t._node}createMesh(t){if(!t._mesh){const e=(t.primitives||[]).map(((e,i)=>this.createPrimitive(e,i,t))),i=new iB({id:t.name||t.id,children:e});t._mesh=i}return t._mesh}getVertexCount(t){qr.warn("getVertexCount() not found")()}createPrimitive(t,e,i){const n=function(t,e){const{id:i,drawMode:n,vertexCount:r,attributes:s,modelOptions:o}=e,a=new dB(t,e);qr.info(4,"createGLTFModel defines: ",a.defines)();const l=[];l.push(...a.generatedTextures),l.push(...Object.values(s).map((t=>t.buffer)));const c=new uB(t,{id:i,drawMode:n,vertexCount:r,modules:[Uh],parameters:a.parameters,vs:pB(t,"\n#if (__VERSION__ < 300)\n  #define _attr attribute\n#else\n  #define _attr in\n#endif\n\n  _attr vec4 POSITION;\n\n  #ifdef HAS_NORMALS\n    _attr vec4 NORMAL;\n  #endif\n\n  #ifdef HAS_TANGENTS\n    _attr vec4 TANGENT;\n  #endif\n\n  #ifdef HAS_UV\n    _attr vec2 TEXCOORD_0;\n  #endif\n\n  void main(void) {\n    vec4 _NORMAL = vec4(0.);\n    vec4 _TANGENT = vec4(0.);\n    vec2 _TEXCOORD_0 = vec2(0.);\n\n    #ifdef HAS_NORMALS\n      _NORMAL = NORMAL;\n    #endif\n\n    #ifdef HAS_TANGENTS\n      _TANGENT = TANGENT;\n    #endif\n\n    #ifdef HAS_UV\n      _TEXCOORD_0 = TEXCOORD_0;\n    #endif\n\n    pbr_setPositionNormalTangentUV(POSITION, _NORMAL, _TANGENT, _TEXCOORD_0);\n    gl_Position = u_MVPMatrix * POSITION;\n  }\n"),fs:pB(t,"\n#if (__VERSION__ < 300)\n  #define fragmentColor gl_FragColor\n#else\n  out vec4 fragmentColor;\n#endif\n\n  void main(void) {\n    fragmentColor = pbr_filterColor(vec4(0));\n  }\n"),managedResources:l,...o,defines:{...a.defines,...o.defines}});return c.setProps({attributes:s}),c.setUniforms(a.uniforms),c}(this.gl,Object.assign({id:t.name||"".concat(i.name||i.id,"-primitive-").concat(e),drawMode:t.mode||4,vertexCount:t.indices?t.indices.count:this.getVertexCount(t.attributes),attributes:this.createAttributes(t.attributes,t.indices),material:t.material},this.options));return n.bounds=[t.attributes.POSITION.min,t.attributes.POSITION.max],n}createAttributes(t,e){const i={};return Object.keys(t).forEach((e=>{i[e]=this.createAccessor(t[e],this.createBuffer(t[e],this.gl.ARRAY_BUFFER))})),e&&(i.indices=this.createAccessor(e,this.createBuffer(e,this.gl.ELEMENT_ARRAY_BUFFER))),qr.info(4,"glTF Attributes",{attributes:t,indices:e,generated:i})(),i}createBuffer(t,e){t.bufferView||(t.bufferView={});const{bufferView:i}=t;return i.lumaBuffers||(i.lumaBuffers={}),i.lumaBuffers[e]||(i.lumaBuffers[e]=new mo(this.gl,{id:"from-".concat(i.id),data:i.data||t.value,target:e})),i.lumaBuffers[e]}createAccessor(t,e){return new ho({buffer:e,offset:t.byteOffset||0,stride:t.bufferView.byteStride||0,type:t.componentType,size:fB[t.type]})}createSampler(t){return t}needsPOT(){return!1}}const _B="3.4.14",yB="https://unpkg.com/@loaders.gl/textures@".concat(_B,"/dist/libs/basis_encoder.wasm"),vB="https://unpkg.com/@loaders.gl/textures@".concat(_B,"/dist/libs/basis_encoder.js");let xB,bB;async function wB(t){const e=t.modules||{};return e.basis?e.basis:(xB=xB||async function(t){let e=null,i=null;return[e,i]=await Promise.all([await ci("basis_transcoder.js","textures",t),await ci("basis_transcoder.wasm","textures",t)]),e=e||globalThis.BASIS,await function(t,e){const i={};e&&(i.wasmBinary=e);return new Promise((e=>{t(i).then((t=>{const{BasisFile:i,initializeBasis:n}=t;n(),e({BasisFile:i})}))}))}(e,i)}(t),await xB)}async function AB(t){const e=t.modules||{};return e.basisEncoder?e.basisEncoder:(bB=bB||async function(t){let e=null,i=null;return[e,i]=await Promise.all([await ci(vB,"textures",t),await ci(yB,"textures",t)]),e=e||globalThis.BASIS,await function(t,e){const i={};e&&(i.wasmBinary=e);return new Promise((e=>{t(i).then((t=>{const{BasisFile:i,KTX2File:n,initializeBasis:r,BasisEncoder:s}=t;r(),e({BasisFile:i,KTX2File:n,BasisEncoder:s})}))}))}(e,i)}(t),await bB)}const TB=33776,MB=33779,SB=35840,EB=35842,CB=36196,IB=37808,PB=["","WEBKIT_","MOZ_"],LB={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let RB=null;function BB(t){if(!RB){t=t||function(){try{return document.createElement("canvas").getContext("webgl")}catch(t){return null}}()||void 0,RB=new Set;for(const e of PB)for(const i in LB)if(t&&t.getExtension("".concat(e).concat(i))){RB.add(LB[i])}}return RB}var DB,OB,kB,FB,zB,NB,UB,GB,VB;(VB=DB||(DB={}))[VB.NONE=0]="NONE",VB[VB.BASISLZ=1]="BASISLZ",VB[VB.ZSTD=2]="ZSTD",VB[VB.ZLIB=3]="ZLIB",function(t){t[t.BASICFORMAT=0]="BASICFORMAT"}(OB||(OB={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.ETC1S=163]="ETC1S",t[t.UASTC=166]="UASTC"}(kB||(kB={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.SRGB=1]="SRGB"}(FB||(FB={})),function(t){t[t.UNSPECIFIED=0]="UNSPECIFIED",t[t.LINEAR=1]="LINEAR",t[t.SRGB=2]="SRGB",t[t.ITU=3]="ITU",t[t.NTSC=4]="NTSC",t[t.SLOG=5]="SLOG",t[t.SLOG2=6]="SLOG2"}(zB||(zB={})),function(t){t[t.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",t[t.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(NB||(NB={})),function(t){t[t.RGB=0]="RGB",t[t.RRR=3]="RRR",t[t.GGG=4]="GGG",t[t.AAA=15]="AAA"}(UB||(UB={})),function(t){t[t.RGB=0]="RGB",t[t.RGBA=3]="RGBA",t[t.RRR=4]="RRR",t[t.RRRG=5]="RRRG"}(GB||(GB={}));const jB=[171,75,84,88,32,50,48,187,13,10,26,10];const HB={etc1:{basisFormat:0,compressed:!0,format:CB},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:TB},bc3:{basisFormat:3,compressed:!0,format:MB},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:SB},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:EB},"astc-4x4":{basisFormat:10,compressed:!0,format:IB},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};function WB(t,e,i){const n=new t(new Uint8Array(e));try{if(!n.startTranscoding())throw new Error("Failed to start basis transcoding");const t=n.getNumImages(),e=[];for(let r=0;r<t;r++){const t=n.getNumLevels(r),s=[];for(let e=0;e<t;e++)s.push(qB(n,r,e,i));e.push(s)}return e}finally{n.close(),n.delete()}}function qB(t,e,i,n){const r=t.getImageWidth(e,i),s=t.getImageHeight(e,i),o=t.getHasAlpha(),{compressed:a,format:l,basisFormat:c}=JB(n,o),h=t.getImageTranscodedSizeInBytes(e,i,c),u=new Uint8Array(h);if(!t.transcodeImage(u,e,i,c,0,0))throw new Error("failed to start Basis transcoding");return{width:r,height:s,data:u,compressed:a,format:l,hasAlpha:o}}function XB(t,e,i){const n=new t(new Uint8Array(e));try{if(!n.startTranscoding())throw new Error("failed to start KTX2 transcoding");const t=n.getLevels(),e=[];for(let r=0;r<t;r++){e.push(ZB(n,r,i));break}return[e]}finally{n.close(),n.delete()}}function ZB(t,e,i){const{alphaFlag:n,height:r,width:s}=t.getImageLevelInfo(e,0,0),{compressed:o,format:a,basisFormat:l}=JB(i,n),c=t.getImageTranscodedSizeInBytes(e,0,0,l),h=new Uint8Array(c);if(!t.transcodeImage(h,e,0,0,l,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:s,height:r,data:h,compressed:o,levelSize:c,hasAlpha:n,format:a}}function JB(t,e){let i=t&&t.basis&&t.basis.format;return"auto"===i&&(i=YB()),"object"==typeof i&&(i=e?i.alpha:i.noAlpha),i=i.toLowerCase(),HB[i]}function YB(){const t=BB();return t.has("astc")?"astc-4x4":t.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:t.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:t.has("etc1")?"etc1":t.has("etc2")?"etc2":"rgb565"}const $B={...{name:"Basis",id:Ue?"basis":"basis-nodejs",module:"textures",version:"3.4.14",worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},parse:async function(t,e){if("auto"===e.basis.containerFormat){if(function(t){const e=new Uint8Array(t);return!(e.byteLength<jB.length||e[0]!==jB[0]||e[1]!==jB[1]||e[2]!==jB[2]||e[3]!==jB[3]||e[4]!==jB[4]||e[5]!==jB[5]||e[6]!==jB[6]||e[7]!==jB[7]||e[8]!==jB[8]||e[9]!==jB[9]||e[10]!==jB[10]||e[11]!==jB[11])}(t)){return XB((await AB(e)).KTX2File,t,e)}const{BasisFile:i}=await wB(e);return WB(i,t,e)}if("encoder"===e.basis.module){const i=await AB(e);return"ktx2"===e.basis.containerFormat?XB(i.KTX2File,t,e):WB(i.BasisFile,t,e)}{const{BasisFile:i}=await wB(e);return WB(i,t,e)}}};function KB(t,e){if(!t)throw new Error(e||"assert failed: gltf")}function QB(t,e){if(t.startsWith("data:")||t.startsWith("http:")||t.startsWith("https:"))return t;const i=e.baseUri||e.uri;if(!i)throw new Error("'baseUri' must be provided to resolve relative url ".concat(t));return i.substr(0,i.lastIndexOf("/")+1)+t}const tD=["SCALAR","VEC2","VEC3","VEC4"],eD=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],iD=new Map(eD),nD={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},rD={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},sD={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function oD(t){return tD[t-1]||tD[0]}function aD(t){const e=iD.get(t.constructor);if(!e)throw new Error("Illegal typed array");return e}function lD(t,e){const i=sD[t.componentType],n=nD[t.type],r=t.count*n,s=t.count*n*rD[t.componentType];return KB(s>=0&&s<=e.byteLength),{ArrayType:i,length:r,byteLength:s}}function cD(t){let{images:e,bufferViews:i}=t;e=e||[],i=i||[];const n=e.map((t=>t.bufferView));i=i.filter((t=>!n.includes(t)));const r=i.reduce(((t,e)=>t+e.byteLength),0),s=e.reduce(((t,e)=>{const{width:i,height:n}=e.image;return t+i*n}),0);return r+Math.ceil(4*s*1.33)}const hD={asset:{version:"2.0",generator:"loaders.gl"},buffers:[]};class uD{constructor(t){He(this,"gltf",void 0),He(this,"sourceBuffers",void 0),He(this,"byteLength",void 0),this.gltf=t||{json:{...hD},buffers:[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(t){return this.json[t]}getExtraData(t){return(this.json.extras||{})[t]}getExtension(t){const e=this.getUsedExtensions().find((e=>e===t));return e?(this.json.extensions||{})[t]||!0:null}getRequiredExtension(t){const e=this.getRequiredExtensions().find((e=>e===t));return e?this.getExtension(t):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(t,e){return(t.extensions||{})[e]}getScene(t){return this.getObject("scenes",t)}getNode(t){return this.getObject("nodes",t)}getSkin(t){return this.getObject("skins",t)}getMesh(t){return this.getObject("meshes",t)}getMaterial(t){return this.getObject("materials",t)}getAccessor(t){return this.getObject("accessors",t)}getTexture(t){return this.getObject("textures",t)}getSampler(t){return this.getObject("samplers",t)}getImage(t){return this.getObject("images",t)}getBufferView(t){return this.getObject("bufferViews",t)}getBuffer(t){return this.getObject("buffers",t)}getObject(t,e){if("object"==typeof e)return e;const i=this.json[t]&&this.json[t][e];if(!i)throw new Error("glTF file error: Could not find ".concat(t,"[").concat(e,"]"));return i}getTypedArrayForBufferView(t){t=this.getBufferView(t);const e=this.gltf.buffers[t.buffer];KB(e);return new Uint8Array(e.arrayBuffer,(t.byteOffset||0)+e.byteOffset,t.byteLength)}getTypedArrayForAccessor(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),i=this.getBuffer(e.buffer).data,{ArrayType:n,length:r}=lD(t,e);return new n(i,e.byteOffset+t.byteOffset,r)}getTypedArrayForImageData(t){t=this.getAccessor(t);const e=this.getBufferView(t.bufferView),i=this.getBuffer(e.buffer);return new Uint8Array(i.data,e.byteOffset||0,e.byteLength)}addApplicationData(t,e){return this.json[t]=e,this}addExtraData(t,e){return this.json.extras=this.json.extras||{},this.json.extras[t]=e,this}addObjectExtension(t,e,i){return t.extensions=t.extensions||{},t.extensions[e]=i,this.registerUsedExtension(e),this}setObjectExtension(t,e,i){(t.extensions||{})[e]=i}removeObjectExtension(t,e){const i=t.extensions||{},n=i[e];return delete i[e],n}addExtension(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return KB(e),this.json.extensions=this.json.extensions||{},this.json.extensions[t]=e,this.registerUsedExtension(t),e}addRequiredExtension(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return KB(e),this.addExtension(t,e),this.registerRequiredExtension(t),e}registerUsedExtension(t){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((e=>e===t))||this.json.extensionsUsed.push(t)}registerRequiredExtension(t){this.registerUsedExtension(t),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((e=>e===t))||this.json.extensionsRequired.push(t)}removeExtension(t){if(!this.getExtension(t))return;this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,t),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,t),this.json.extensions&&delete this.json.extensions[t],Array.isArray(this.json.extensionsRemoved)||(this.json.extensionsRemoved=[]);const e=this.json.extensionsRemoved;e.includes(t)||e.push(t)}setDefaultScene(t){this.json.scene=t}addScene(t){const{nodeIndices:e}=t;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:e}),this.json.scenes.length-1}addNode(t){const{meshIndex:e,matrix:i}=t;this.json.nodes=this.json.nodes||[];const n={mesh:e};return i&&(n.matrix=i),this.json.nodes.push(n),this.json.nodes.length-1}addMesh(t){const{attributes:e,indices:i,material:n,mode:r=4}=t,s={primitives:[{attributes:this._addAttributes(e),mode:r}]};if(i){const t=this._addIndices(i);s.primitives[0].indices=t}return Number.isFinite(n)&&(s.primitives[0].material=n),this.json.meshes=this.json.meshes||[],this.json.meshes.push(s),this.json.meshes.length-1}addPointCloud(t){const e={primitives:[{attributes:this._addAttributes(t),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(e),this.json.meshes.length-1}addImage(t,e){const i=cr(t),n=e||(null==i?void 0:i.mimeType),r={bufferView:this.addBufferView(t),mimeType:n};return this.json.images=this.json.images||[],this.json.images.push(r),this.json.images.length-1}addBufferView(t){const e=t.byteLength;KB(Number.isFinite(e)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(t);const i={buffer:0,byteOffset:this.byteLength,byteLength:e};return this.byteLength+=mi(e,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(i),this.json.bufferViews.length-1}addAccessor(t,e){const i={bufferView:t,type:oD(e.size),componentType:e.componentType,count:e.count,max:e.max,min:e.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}addBinaryBuffer(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{size:3};const i=this.addBufferView(t);let n={min:e.min,max:e.max};n.min&&n.max||(n=this._getAccessorMinMax(t,e.size));const r={size:e.size,componentType:aD(t),count:Math.round(t.length/e.size),min:n.min,max:n.max};return this.addAccessor(i,Object.assign(r,e))}addTexture(t){const{imageIndex:e}=t,i={source:e};return this.json.textures=this.json.textures||[],this.json.textures.push(i),this.json.textures.length-1}addMaterial(t){return this.json.materials=this.json.materials||[],this.json.materials.push(t),this.json.materials.length-1}createBinaryChunk(){var t,e;this.gltf.buffers=[];const i=this.byteLength,n=new ArrayBuffer(i),r=new Uint8Array(n);let s=0;for(const t of this.sourceBuffers||[])s=gi(t,r,s);null!==(t=this.json)&&void 0!==t&&null!==(e=t.buffers)&&void 0!==e&&e[0]?this.json.buffers[0].byteLength=i:this.json.buffers=[{byteLength:i}],this.gltf.binary=n,this.sourceBuffers=[n]}_removeStringFromArray(t,e){let i=!0;for(;i;){const n=t.indexOf(e);n>-1?t.splice(n,1):i=!1}}_addAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e={};for(const i in t){const n=t[i],r=this._getGltfAttributeName(i),s=this.addBinaryBuffer(n.value,n);e[r]=s}return e}_addIndices(t){return this.addBinaryBuffer(t,{size:1})}_getGltfAttributeName(t){switch(t.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return t}}_getAccessorMinMax(t,e){const i={min:null,max:null};if(t.length<e)return i;i.min=[],i.max=[];const n=t.subarray(0,e);for(const t of n)i.min.push(t),i.max.push(t);for(let n=e;n<t.length;n+=e)for(let r=0;r<e;r++)i.min[0+r]=Math.min(i.min[0+r],t[n+r]),i.max[0+r]=Math.max(i.max[0+r],t[n+r]);return i}}const dD="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",pD="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",fD=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),mD=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),gD={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},_D={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function yD(t,e,i,n,r){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"NONE";const o=await async function(){vD||(vD=async function(){let t=dD;WebAssembly.validate(fD)&&(t=pD);const e=await WebAssembly.instantiate(function(t){const e=new Uint8Array(t.length);for(let i=0;i<t.length;++i){const n=t.charCodeAt(i);e[i]=n>96?n-71:n>64?n-65:n>47?n+4:n>46?63:62}let i=0;for(let n=0;n<t.length;++n)e[i++]=e[n]<60?mD[e[n]]:64*(e[n]-60)+e[++n];return e.buffer.slice(0,i)}(t),{});return await e.instance.exports.__wasm_call_ctors(),e.instance}());return vD}();!function(t,e,i,n,r,s,o){const a=t.exports.sbrk,l=n+3&-4,c=a(l*r),h=a(s.length),u=new Uint8Array(t.exports.memory.buffer);u.set(s,h);const d=e(c,n,r,h,s.length);0===d&&o&&o(c,l,r);if(i.set(u.subarray(c,c+n*r)),a(c-a(0)),0!==d)throw new Error("Malformed buffer data: ".concat(d))}(o,o.exports[_D[r]],t,e,i,n,o.exports[gD[s||"NONE"]])}let vD;const xD="EXT_meshopt_compression";async function bD(t,e){const i=t.getObjectExtension(e,xD);if(i){const{byteOffset:n=0,byteLength:r=0,byteStride:s,count:o,mode:a,filter:l="NONE",buffer:c}=i,h=t.gltf.buffers[c],u=new Uint8Array(h.arrayBuffer,h.byteOffset+n,r),d=new Uint8Array(t.gltf.buffers[e.buffer].arrayBuffer,e.byteOffset,e.byteLength);return await yD(d,o,s,u,a,l),d}return null}var wD=Object.freeze({__proto__:null,decode:async function(t,e){var i;const n=new uD(t);if(null==e||null===(i=e.gltf)||void 0===i||!i.decompressMeshes)return;const r=[];for(const e of t.json.bufferViews||[])r.push(bD(n,e));await Promise.all(r),n.removeExtension(xD)},name:xD});const AD="EXT_texture_webp";var TD=Object.freeze({__proto__:null,name:AD,preprocess:function(t,e){const i=new uD(t);if(!pr("image/webp")){if(i.getRequiredExtensions().includes(AD))throw new Error("gltf: Required extension ".concat(AD," not supported by browser"));return}const{json:n}=i;for(const t of n.textures||[]){const e=i.getObjectExtension(t,AD);e&&(t.source=e.source),i.removeObjectExtension(t,AD)}i.removeExtension(AD)}});const MD="KHR_texture_basisu";var SD=Object.freeze({__proto__:null,name:MD,preprocess:function(t,e){const i=new uD(t),{json:n}=i;for(const t of n.textures||[]){const e=i.getObjectExtension(t,MD);e&&(t.source=e.source),i.removeObjectExtension(t,MD)}i.removeExtension(MD)}});const ED={draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}},CD={name:"Draco",id:Ue?"draco":"draco-nodejs",module:"draco",shapes:["mesh"],version:"3.4.14",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:ED};class ID{constructor(t,e){He(this,"fields",void 0),He(this,"metadata",void 0),function(t,e){if(!t)throw new Error(e||"loader assertion failed.")}(Array.isArray(t)),function(t){const e={};for(const i of t)e[i.name]=!0}(t),this.fields=t,this.metadata=e||new Map}compareTo(t){if(this.metadata!==t.metadata)return!1;if(this.fields.length!==t.fields.length)return!1;for(let e=0;e<this.fields.length;++e)if(!this.fields[e].compareTo(t.fields[e]))return!1;return!0}select(){const t=Object.create(null);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];for(const e of i)t[e]=!0;const r=this.fields.filter((e=>t[e.name]));return new ID(r,this.metadata)}selectAt(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];const n=e.map((t=>this.fields[t])).filter(Boolean);return new ID(n,this.metadata)}assign(t){let e,i=this.metadata;if(t instanceof ID){const n=t;e=n.fields,i=PD(PD(new Map,this.metadata),n.metadata)}else e=t;const n=Object.create(null);for(const t of this.fields)n[t.name]=t;for(const t of e)n[t.name]=t;const r=Object.values(n);return new ID(r,i)}}function PD(t,e){return new Map([...t||new Map,...e||new Map])}class LD{constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Map;He(this,"name",void 0),He(this,"type",void 0),He(this,"nullable",void 0),He(this,"metadata",void 0),this.name=t,this.type=e,this.nullable=i,this.metadata=n}get typeId(){return this.type&&this.type.typeId}clone(){return new LD(this.name,this.type,this.nullable,this.metadata)}compareTo(t){return this.name===t.name&&this.type===t.type&&this.nullable===t.nullable&&this.metadata===t.metadata}toString(){return"".concat(this.type).concat(this.nullable?", nullable":"").concat(this.metadata?", metadata: ".concat(this.metadata):"")}}let RD,BD,DD,OD=function(t){return t[t.NONE=0]="NONE",t[t.Null=1]="Null",t[t.Int=2]="Int",t[t.Float=3]="Float",t[t.Binary=4]="Binary",t[t.Utf8=5]="Utf8",t[t.Bool=6]="Bool",t[t.Decimal=7]="Decimal",t[t.Date=8]="Date",t[t.Time=9]="Time",t[t.Timestamp=10]="Timestamp",t[t.Interval=11]="Interval",t[t.List=12]="List",t[t.Struct=13]="Struct",t[t.Union=14]="Union",t[t.FixedSizeBinary=15]="FixedSizeBinary",t[t.FixedSizeList=16]="FixedSizeList",t[t.Map=17]="Map",t[t.Dictionary=-1]="Dictionary",t[t.Int8=-2]="Int8",t[t.Int16=-3]="Int16",t[t.Int32=-4]="Int32",t[t.Int64=-5]="Int64",t[t.Uint8=-6]="Uint8",t[t.Uint16=-7]="Uint16",t[t.Uint32=-8]="Uint32",t[t.Uint64=-9]="Uint64",t[t.Float16=-10]="Float16",t[t.Float32=-11]="Float32",t[t.Float64=-12]="Float64",t[t.DateDay=-13]="DateDay",t[t.DateMillisecond=-14]="DateMillisecond",t[t.TimestampSecond=-15]="TimestampSecond",t[t.TimestampMillisecond=-16]="TimestampMillisecond",t[t.TimestampMicrosecond=-17]="TimestampMicrosecond",t[t.TimestampNanosecond=-18]="TimestampNanosecond",t[t.TimeSecond=-19]="TimeSecond",t[t.TimeMillisecond=-20]="TimeMillisecond",t[t.TimeMicrosecond=-21]="TimeMicrosecond",t[t.TimeNanosecond=-22]="TimeNanosecond",t[t.DenseUnion=-23]="DenseUnion",t[t.SparseUnion=-24]="SparseUnion",t[t.IntervalDayTime=-25]="IntervalDayTime",t[t.IntervalYearMonth=-26]="IntervalYearMonth",t}({});class kD{static isNull(t){return t&&t.typeId===OD.Null}static isInt(t){return t&&t.typeId===OD.Int}static isFloat(t){return t&&t.typeId===OD.Float}static isBinary(t){return t&&t.typeId===OD.Binary}static isUtf8(t){return t&&t.typeId===OD.Utf8}static isBool(t){return t&&t.typeId===OD.Bool}static isDecimal(t){return t&&t.typeId===OD.Decimal}static isDate(t){return t&&t.typeId===OD.Date}static isTime(t){return t&&t.typeId===OD.Time}static isTimestamp(t){return t&&t.typeId===OD.Timestamp}static isInterval(t){return t&&t.typeId===OD.Interval}static isList(t){return t&&t.typeId===OD.List}static isStruct(t){return t&&t.typeId===OD.Struct}static isUnion(t){return t&&t.typeId===OD.Union}static isFixedSizeBinary(t){return t&&t.typeId===OD.FixedSizeBinary}static isFixedSizeList(t){return t&&t.typeId===OD.FixedSizeList}static isMap(t){return t&&t.typeId===OD.Map}static isDictionary(t){return t&&t.typeId===OD.Dictionary}get typeId(){return OD.NONE}compareTo(t){return this===t}}RD=Symbol.toStringTag;class FD extends kD{constructor(t,e){super(),He(this,"isSigned",void 0),He(this,"bitWidth",void 0),this.isSigned=t,this.bitWidth=e}get typeId(){return OD.Int}get[RD](){return"Int"}toString(){return"".concat(this.isSigned?"I":"Ui","nt").concat(this.bitWidth)}}class zD extends FD{constructor(){super(!0,8)}}class ND extends FD{constructor(){super(!0,16)}}class UD extends FD{constructor(){super(!0,32)}}class GD extends FD{constructor(){super(!1,8)}}class VD extends FD{constructor(){super(!1,16)}}class jD extends FD{constructor(){super(!1,32)}}const HD=32,WD=64;BD=Symbol.toStringTag;class qD extends kD{constructor(t){super(),He(this,"precision",void 0),this.precision=t}get typeId(){return OD.Float}get[BD](){return"Float"}toString(){return"Float".concat(this.precision)}}class XD extends qD{constructor(){super(HD)}}class ZD extends qD{constructor(){super(WD)}}DD=Symbol.toStringTag;class JD extends kD{constructor(t,e){super(),He(this,"listSize",void 0),He(this,"children",void 0),this.listSize=t,this.children=[e]}get typeId(){return OD.FixedSizeList}get valueType(){return this.children[0].type}get valueField(){return this.children[0]}get[DD](){return"FixedSizeList"}toString(){return"FixedSizeList[".concat(this.listSize,"]<").concat(this.valueType,">")}}function YD(t,e,i){const n=function(t){switch(t.constructor){case Int8Array:return new zD;case Uint8Array:return new GD;case Int16Array:return new ND;case Uint16Array:return new VD;case Int32Array:return new UD;case Uint32Array:return new jD;case Float32Array:return new XD;case Float64Array:return new ZD;default:throw new Error("array type not supported")}}(e.value),r=i||function(t){const e=new Map;"byteOffset"in t&&e.set("byteOffset",t.byteOffset.toString(10));"byteStride"in t&&e.set("byteStride",t.byteStride.toString(10));"normalized"in t&&e.set("normalized",t.normalized.toString());return e}(e);return new LD(t,new JD(e.size,new LD("value",n)),!1,r)}function $D(t,e,i){return YD(t,e,i?KD(i.metadata):void 0)}function KD(t){const e=new Map;for(const i in t)e.set("".concat(i,".string"),JSON.stringify(t[i]));return e}const QD={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},tO={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class eO{constructor(t){He(this,"draco",void 0),He(this,"decoder",void 0),He(this,"metadataQuerier",void 0),this.draco=t,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new this.draco.DecoderBuffer;i.Init(new Int8Array(t),t.byteLength),this._disableAttributeTransforms(e);const n=this.decoder.GetEncodedGeometryType(i),r=n===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let t;switch(n){case this.draco.TRIANGULAR_MESH:t=this.decoder.DecodeBufferToMesh(i,r);break;case this.draco.POINT_CLOUD:t=this.decoder.DecodeBufferToPointCloud(i,r);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!t.ok()||!r.ptr){const e="DRACO decompression failed: ".concat(t.error_msg());throw new Error(e)}const s=this._getDracoLoaderData(r,n,e),o=this._getMeshData(r,s,e),a=function(t){let e=1/0,i=1/0,n=1/0,r=-1/0,s=-1/0,o=-1/0;const a=t.POSITION?t.POSITION.value:[],l=a&&a.length;for(let t=0;t<l;t+=3){const l=a[t],c=a[t+1],h=a[t+2];e=l<e?l:e,i=c<i?c:i,n=h<n?h:n,r=l>r?l:r,s=c>s?c:s,o=h>o?h:o}return[[e,i,n],[r,s,o]]}(o.attributes),l=function(t,e,i){const n=KD(e.metadata),r=[],s=function(t){const e={};for(const i in t){const n=t[i];e[n.name||"undefined"]=n}return e}(e.attributes);for(const e in t){const i=$D(e,t[e],s[e]);r.push(i)}if(i){const t=$D("indices",i);r.push(t)}return new ID(r,n)}(o.attributes,s,o.indices);return{loader:"draco",loaderData:s,header:{vertexCount:r.num_points(),boundingBox:a},...o,schema:l}}finally{this.draco.destroy(i),r&&this.draco.destroy(r)}}_getDracoLoaderData(t,e,i){const n=this._getTopLevelMetadata(t),r=this._getDracoAttributes(t,i);return{geometry_type:e,num_attributes:t.num_attributes(),num_points:t.num_points(),num_faces:t instanceof this.draco.Mesh?t.num_faces():0,metadata:n,attributes:r}}_getDracoAttributes(t,e){const i={};for(let n=0;n<t.num_attributes();n++){const r=this.decoder.GetAttribute(t,n),s=this._getAttributeMetadata(t,n);i[r.unique_id()]={unique_id:r.unique_id(),attribute_type:r.attribute_type(),data_type:r.data_type(),num_components:r.num_components(),byte_offset:r.byte_offset(),byte_stride:r.byte_stride(),normalized:r.normalized(),attribute_index:n,metadata:s};const o=this._getQuantizationTransform(r,e);o&&(i[r.unique_id()].quantization_transform=o);const a=this._getOctahedronTransform(r,e);a&&(i[r.unique_id()].octahedron_transform=a)}return i}_getMeshData(t,e,i){const n=this._getMeshAttributes(e,t,i);if(!n.POSITION)throw new Error("DRACO: No position attribute found.");return t instanceof this.draco.Mesh?"triangle-strip"===i.topology?{topology:"triangle-strip",mode:4,attributes:n,indices:{value:this._getTriangleStripIndices(t),size:1}}:{topology:"triangle-list",mode:5,attributes:n,indices:{value:this._getTriangleListIndices(t),size:1}}:{topology:"point-list",mode:0,attributes:n}}_getMeshAttributes(t,e,i){const n={};for(const r of Object.values(t.attributes)){const t=this._deduceAttributeName(r,i);r.name=t;const{value:s,size:o}=this._getAttributeValues(e,r);n[t]={value:s,size:o,byteOffset:r.byte_offset,byteStride:r.byte_stride,normalized:r.normalized}}return n}_getTriangleListIndices(t){const e=3*t.num_faces(),i=4*e,n=this.draco._malloc(i);try{return this.decoder.GetTrianglesUInt32Array(t,i,n),new Uint32Array(this.draco.HEAPF32.buffer,n,e).slice()}finally{this.draco._free(n)}}_getTriangleStripIndices(t){const e=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(t,e),function(t){const e=t.size(),i=new Int32Array(e);for(let n=0;n<e;n++)i[n]=t.GetValue(n);return i}(e)}finally{this.draco.destroy(e)}}_getAttributeValues(t,e){const i=tO[e.data_type],n=e.num_components,r=t.num_points()*n,s=r*i.BYTES_PER_ELEMENT,o=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32;default:return t.DT_INVALID}}(this.draco,i);let a;const l=this.draco._malloc(s);try{const n=this.decoder.GetAttribute(t,e.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(t,n,o,s,l),a=new i(this.draco.HEAPF32.buffer,l,r).slice()}finally{this.draco._free(l)}return{value:a,size:n}}_deduceAttributeName(t,e){const i=t.unique_id;for(const[t,n]of Object.entries(e.extraAttributes||{}))if(n===i)return t;const n=t.attribute_type;for(const t in QD){if(this.draco[t]===n)return QD[t]}const r=e.attributeNameEntry||"name";return t.metadata[r]?t.metadata[r].string:"CUSTOM_ATTRIBUTE_".concat(i)}_getTopLevelMetadata(t){const e=this.decoder.GetMetadata(t);return this._getDracoMetadata(e)}_getAttributeMetadata(t,e){const i=this.decoder.GetAttributeMetadata(t,e);return this._getDracoMetadata(i)}_getDracoMetadata(t){if(!t||!t.ptr)return{};const e={},i=this.metadataQuerier.NumEntries(t);for(let n=0;n<i;n++){const i=this.metadataQuerier.GetEntryName(t,n);e[i]=this._getDracoMetadataField(t,i)}return e}_getDracoMetadataField(t,e){const i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(t,e,i);const n=function(t){const e=t.size(),i=new Int32Array(e);for(let n=0;n<e;n++)i[n]=t.GetValue(n);return i}(i);return{int:this.metadataQuerier.GetIntEntry(t,e),string:this.metadataQuerier.GetStringEntry(t,e),double:this.metadataQuerier.GetDoubleEntry(t,e),intArray:n}}finally{this.draco.destroy(i)}}_disableAttributeTransforms(t){const{quantizedAttributes:e=[],octahedronAttributes:i=[]}=t,n=[...e,...i];for(const t of n)this.decoder.SkipAttributeTransform(this.draco[t])}_getQuantizationTransform(t,e){const{quantizedAttributes:i=[]}=e,n=t.attribute_type();if(i.map((t=>this.decoder[t])).includes(n)){const e=new this.draco.AttributeQuantizationTransform;try{if(e.InitFromAttribute(t))return{quantization_bits:e.quantization_bits(),range:e.range(),min_values:new Float32Array([1,2,3]).map((t=>e.min_value(t)))}}finally{this.draco.destroy(e)}}return null}_getOctahedronTransform(t,e){const{octahedronAttributes:i=[]}=e,n=t.attribute_type();if(i.map((t=>this.decoder[t])).includes(n)){const e=new this.draco.AttributeQuantizationTransform;try{if(e.InitFromAttribute(t))return{quantization_bits:e.quantization_bits()}}finally{this.draco.destroy(e)}}return null}}const iO="https://www.gstatic.com/draco/versioned/decoders/".concat("1.5.5"),nO="".concat(iO,"/draco_decoder.js"),rO="".concat(iO,"/draco_wasm_wrapper.js"),sO="".concat(iO,"/draco_decoder.wasm");let oO;async function aO(t){const e=t.modules||{};return oO=e.draco3d?oO||e.draco3d.createDecoderModule({}).then((t=>({draco:t}))):oO||async function(t){let e,i;if("js"===(t.draco&&t.draco.decoderType))e=await ci(nO,"draco",t);else[e,i]=await Promise.all([await ci(rO,"draco",t),await ci(sO,"draco",t)]);return e=e||globalThis.DracoDecoderModule,await function(t,e){const i={};e&&(i.wasmBinary=e);return new Promise((e=>{t({...i,onModuleLoaded:t=>e({draco:t})})}))}(e,i)}(t),await oO}const lO={...CD,parse:async function(t,e){const{draco:i}=await aO(e),n=new eO(i);try{return n.parseSync(t,null==e?void 0:e.draco)}finally{n.destroy()}}};function cO(t){const{buffer:e,size:i,count:n}=function(t){let e=t,i=1,n=0;t&&t.value&&(e=t.value,i=t.size||1);e&&(ArrayBuffer.isView(e)||(e=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t)return null;if(Array.isArray(t))return new e(t);if(i&&!(t instanceof e))return new e(t);return t}(e,Float32Array)),n=e.length/i);return{buffer:e,size:i,count:n}}(t);return{value:e,size:i,byteOffset:0,count:n,type:oD(i),componentType:aD(e)}}const hO="KHR_draco_mesh_compression";async function uO(t,e,i,n){const r=t.getObjectExtension(e,hO);if(!r)return;const s=t.getTypedArrayForBufferView(r.bufferView),o=fi(s.buffer,s.byteOffset),{parse:a}=n,l={...i};delete l["3d-tiles"];const c=await a(o,lO,l,n),h=function(t){const e={};for(const i in t)if("indices"!==i){const n=cO(t[i]);e[i]=n}return e}(c.attributes);for(const[i,n]of Object.entries(h))if(i in e.attributes){const r=t.getAccessor(e.attributes[i]);null!=r&&r.min&&null!=r&&r.max&&(n.min=r.min,n.max=r.max)}e.attributes=h,c.indices&&(e.indices=cO(c.indices)),function(t){if(!t.attributes&&Object.keys(t.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(e)}function dO(t,e){var i;let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;if(!r.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const o=r.DracoWriter.encodeSync({attributes:t}),a=null==s||null===(i=s.parseSync)||void 0===i?void 0:i.call(s,{attributes:t}),l=r._addFauxAttributes(a.attributes),c=r.addBufferView(o);return{primitives:[{attributes:l,mode:n,extensions:{[hO]:{bufferView:c,attributes:l}}}]}}function*pO(t){for(const e of t.json.meshes||[])for(const t of e.primitives)yield t}var fO=Object.freeze({__proto__:null,decode:async function(t,e,i){var n;if(null==e||null===(n=e.gltf)||void 0===n||!n.decompressMeshes)return;const r=new uD(t),s=[];for(const t of pO(r))r.getObjectExtension(t,hO)&&s.push(uO(r,t,e,i));await Promise.all(s),r.removeExtension(hO)},encode:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new uD(t);for(const t of i.json.meshes||[])dO(t,e),i.addRequiredExtension(hO)},name:hO,preprocess:function(t,e,i){const n=new uD(t);for(const t of pO(n))n.getObjectExtension(t,hO)}});const mO={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},gO={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},_O="KHR_texture_transform",yO=_O,vO=new Dc,xO=new jc,bO=new jc;function wO(t,e){var i,n,r;const s=[],o=null===(i=e.json.materials)||void 0===i?void 0:i[t],a=null==o||null===(n=o.pbrMetallicRoughness)||void 0===n?void 0:n.baseColorTexture;a&&AO(e,t,a,s);const l=null==o?void 0:o.emissiveTexture;l&&AO(e,t,l,s);const c=null==o?void 0:o.normalTexture;c&&AO(e,t,c,s);const h=null==o?void 0:o.occlusionTexture;h&&AO(e,t,h,s);const u=null==o||null===(r=o.pbrMetallicRoughness)||void 0===r?void 0:r.metallicRoughnessTexture;u&&AO(e,t,u,s)}function AO(t,e,i,n){const r=function(t,e){var i;const n=null===(i=t.extensions)||void 0===i?void 0:i[_O],{texCoord:r=0}=t,{texCoord:s=r}=n,o=-1!==e.findIndex((t=>{let[e,i]=t;return e===r&&i===s}));if(!o){const i=function(t){const{offset:e=[0,0],rotation:i=0,scale:n=[1,1]}=t,r=(new jc).set(1,0,0,0,1,0,e[0],e[1],1),s=xO.set(Math.cos(i),Math.sin(i),0,-Math.sin(i),Math.cos(i),0,0,0,1),o=bO.set(n[0],0,0,0,n[1],0,0,0,1);return r.multiplyRight(s).multiplyRight(o)}(n);return r!==s&&(t.texCoord=s),e.push([r,s]),{originalTexCoord:r,texCoord:s,matrix:i}}return null}(i,n);if(!r)return;const s=t.json.meshes||[];for(const i of s)for(const n of i.primitives){const i=n.material;Number.isFinite(i)&&e===i&&TO(t,n,r)}}function TO(t,e,i){const{originalTexCoord:n,texCoord:r,matrix:s}=i,o=e.attributes["TEXCOORD_".concat(n)];if(Number.isFinite(o)){var a;const i=null===(a=t.json.accessors)||void 0===a?void 0:a[o];if(i&&i.bufferView){var l;const o=null===(l=t.json.bufferViews)||void 0===l?void 0:l[i.bufferView];if(o){const{arrayBuffer:a,byteOffset:l}=t.buffers[o.buffer],c=(l||0)+(i.byteOffset||0)+(o.byteOffset||0),{ArrayType:h,length:u}=lD(i,o),d=mO[i.type],p=o.byteStride||gO[i.componentType]*d,f=new Float32Array(u);for(let t=0;t<i.count;t++){const e=new h(a,c+t*p,2);vO.set(e[0],e[1],1),vO.transformByMatrix3(s),f.set([vO[0],vO[1]],t*d)}n===r?function(t,e,i,n){t.componentType=5126,i.push({arrayBuffer:n.buffer,byteOffset:0,byteLength:n.buffer.byteLength}),e.buffer=i.length-1,e.byteLength=n.buffer.byteLength,e.byteOffset=0,delete e.byteStride}(i,o,t.buffers,f):function(t,e,i,n,r){n.buffers.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength});const s=n.json.bufferViews;if(!s)return;s.push({buffer:n.buffers.length-1,byteLength:r.buffer.byteLength,byteOffset:0});const o=n.json.accessors;if(!o)return;o.push({bufferView:(null==s?void 0:s.length)-1,byteOffset:0,componentType:5126,count:e.count,type:"VEC2"}),i.attributes["TEXCOORD_".concat(t)]=o.length-1}(r,i,e,t,f)}}}}var MO=Object.freeze({__proto__:null,decode:async function(t,e){if(!new uD(t).getExtension(_O))return;const i=t.json.materials||[];for(let e=0;e<i.length;e++)wO(e,t)},name:yO});const SO="KHR_lights_punctual";var EO=Object.freeze({__proto__:null,decode:async function(t){const e=new uD(t),{json:i}=e,n=e.getExtension(SO);n&&(e.json.lights=n.lights,e.removeExtension(SO));for(const t of i.nodes||[]){const i=e.getObjectExtension(t,SO);i&&(t.light=i.light),e.removeObjectExtension(t,SO)}},encode:async function(t){const e=new uD(t),{json:i}=e;if(i.lights){const t=e.addExtension(SO);KB(!t.lights),t.lights=i.lights,delete i.lights}if(e.json.lights){for(const t of e.json.lights){e.addObjectExtension(t.node,SO,t)}delete e.json.lights}},name:SO});const CO="KHR_materials_unlit";const IO="KHR_techniques_webgl";function PO(t,e){const i=Object.assign({},t.values);return Object.keys(t.uniforms||{}).forEach((e=>{t.uniforms[e].value&&!(e in i)&&(i[e]=t.uniforms[e].value)})),Object.keys(i).forEach((t=>{"object"==typeof i[t]&&void 0!==i[t].index&&(i[t].texture=e.getTexture(i[t].index))})),i}const LO="EXT_feature_metadata";function RO(t,e,i){for(const r in i.properties){var n;const s=null==e||null===(n=e.properties)||void 0===n?void 0:n[r];if(s){const n=BO(t,i.properties[r],e.count,s);s.data=n}}}function BO(t,e,i,n){let r=t.getTypedArrayForBufferView(n.bufferView);switch(e.type){case"STRING":r=function(t,e,i){const n=[],r=new TextDecoder("utf8");let s=0;const o=4;for(let a=0;a<i;a++){const i=e[(a+1)*o]-e[a*o],l=t.subarray(s,i+s),c=r.decode(l);n.push(c),s+=i}return n}(r,t.getTypedArrayForBufferView(n.stringOffsetBufferView),i);break}return r}function DO(t,e){for(const i in t){const n=t[i];if(n.class===e)return n}return null}const OO=[wD,TD,SD,fO,EO,Object.freeze({__proto__:null,decode:async function(t){const e=new uD(t),{json:i}=e;for(const t of i.materials||[]){t.extensions&&t.extensions.KHR_materials_unlit&&(t.unlit=!0),e.removeObjectExtension(t,CO)}e.removeExtension(CO)},encode:function(t){const e=new uD(t),{json:i}=e;if(e.materials)for(const t of i.materials||[])t.unlit&&(delete t.unlit,e.addObjectExtension(t,CO,{}),e.addExtension(CO))},name:CO}),Object.freeze({__proto__:null,decode:async function(t){const e=new uD(t),{json:i}=e,n=e.getExtension(IO);if(n){const t=function(t,e){const{programs:i=[],shaders:n=[],techniques:r=[]}=t,s=new TextDecoder;return n.forEach((t=>{if(!Number.isFinite(t.bufferView))throw new Error("KHR_techniques_webgl: no shader code");t.code=s.decode(e.getTypedArrayForBufferView(t.bufferView))})),i.forEach((t=>{t.fragmentShader=n[t.fragmentShader],t.vertexShader=n[t.vertexShader]})),r.forEach((t=>{t.program=i[t.program]})),r}(n,e);for(const n of i.materials||[]){const i=e.getObjectExtension(n,IO);i&&(n.technique=Object.assign({},i,t[i.technique]),n.technique.values=PO(n.technique,e)),e.removeObjectExtension(n,IO)}e.removeExtension(IO)}},encode:async function(t,e){},name:IO}),MO,Object.freeze({__proto__:null,decode:async function(t){!function(t){var e;const i=t.getExtension(LO),n=null==i||null===(e=i.schema)||void 0===e?void 0:e.classes,r=null==i?void 0:i.featureTables;if(n&&r)for(const e in n){const i=n[e],s=DO(r,e);s&&RO(t,s,i)}}(new uD(t))},name:LO})];function kO(t,e){var i;const n=(null==e||null===(i=e.gltf)||void 0===i?void 0:i.excludeExtensions)||{};return!(t in n&&!n[t])}const FO="KHR_binary_glTF";const zO={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},NO={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class UO{constructor(){He(this,"idToIndexMap",{animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}}),He(this,"json",void 0)}normalize(t,e){this.json=t.json;const i=t.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return}if(!e.normalize)throw new Error("glTF v1 is not supported.");this._addAsset(i),this._convertTopLevelObjectsToArrays(i),function(t){const e=new uD(t),{json:i}=e;for(const t of i.images||[]){const i=e.getObjectExtension(t,FO);i&&Object.assign(t,i),e.removeObjectExtension(t,FO)}i.buffers&&i.buffers[0]&&delete i.buffers[0].uri,e.removeExtension(FO)}(t),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}_addAsset(t){t.asset=t.asset||{},t.asset.version="2.0",t.asset.generator=t.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(t){for(const e in zO)this._convertTopLevelObjectToArray(t,e)}_convertTopLevelObjectToArray(t,e){const i=t[e];if(i&&!Array.isArray(i)){t[e]=[];for(const n in i){const r=i[n];r.id=r.id||n;const s=t[e].length;t[e].push(r),this.idToIndexMap[e][n]=s}}}_convertObjectIdsToArrayIndices(t){for(const e in zO)this._convertIdsToIndices(t,e);"scene"in t&&(t.scene=this._convertIdToIndex(t.scene,"scene"));for(const e of t.textures)this._convertTextureIds(e);for(const e of t.meshes)this._convertMeshIds(e);for(const e of t.nodes)this._convertNodeIds(e);for(const e of t.scenes)this._convertSceneIds(e)}_convertTextureIds(t){t.source&&(t.source=this._convertIdToIndex(t.source,"image"))}_convertMeshIds(t){for(const e of t.primitives){const{attributes:t,indices:i,material:n}=e;for(const e in t)t[e]=this._convertIdToIndex(t[e],"accessor");i&&(e.indices=this._convertIdToIndex(i,"accessor")),n&&(e.material=this._convertIdToIndex(n,"material"))}}_convertNodeIds(t){t.children&&(t.children=t.children.map((t=>this._convertIdToIndex(t,"node")))),t.meshes&&(t.meshes=t.meshes.map((t=>this._convertIdToIndex(t,"mesh"))))}_convertSceneIds(t){t.nodes&&(t.nodes=t.nodes.map((t=>this._convertIdToIndex(t,"node"))))}_convertIdsToIndices(t,e){t[e]||(t[e]=[]);for(const i of t[e])for(const t in i){const e=this._convertIdToIndex(i[t],t);i[t]=e}}_convertIdToIndex(t,e){const i=NO[e];if(i in this.idToIndexMap){const n=this.idToIndexMap[i][t];if(!Number.isFinite(n))throw new Error("gltf v1: failed to resolve ".concat(e," with id ").concat(t));return n}return t}_updateObjects(t){for(const t of this.json.buffers)delete t.type}_updateMaterial(t){for(const r of t.materials){var e,i,n;r.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const s=(null===(e=r.values)||void 0===e?void 0:e.tex)||(null===(i=r.values)||void 0===i?void 0:i.texture2d_0)||(null===(n=r.values)||void 0===n?void 0:n.diffuseTex),o=t.textures.findIndex((t=>t.id===s));-1!==o&&(r.pbrMetallicRoughness.baseColorTexture={index:o})}}}const GO={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},VO={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},jO=10240,HO=10241,WO=10242,qO=10243,XO=10497,ZO={magFilter:jO,minFilter:HO,wrapS:WO,wrapT:qO},JO={[jO]:9729,[HO]:9986,[WO]:XO,[qO]:XO};class YO{constructor(){He(this,"baseUri",""),He(this,"json",{}),He(this,"buffers",[]),He(this,"images",[])}postProcess(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{json:i,buffers:n=[],images:r=[],baseUri:s=""}=t;return KB(i),this.baseUri=s,this.json=i,this.buffers=n,this.images=r,this._resolveTree(this.json,e),this.json}_resolveTree(t){t.bufferViews&&(t.bufferViews=t.bufferViews.map(((t,e)=>this._resolveBufferView(t,e)))),t.images&&(t.images=t.images.map(((t,e)=>this._resolveImage(t,e)))),t.samplers&&(t.samplers=t.samplers.map(((t,e)=>this._resolveSampler(t,e)))),t.textures&&(t.textures=t.textures.map(((t,e)=>this._resolveTexture(t,e)))),t.accessors&&(t.accessors=t.accessors.map(((t,e)=>this._resolveAccessor(t,e)))),t.materials&&(t.materials=t.materials.map(((t,e)=>this._resolveMaterial(t,e)))),t.meshes&&(t.meshes=t.meshes.map(((t,e)=>this._resolveMesh(t,e)))),t.nodes&&(t.nodes=t.nodes.map(((t,e)=>this._resolveNode(t,e)))),t.skins&&(t.skins=t.skins.map(((t,e)=>this._resolveSkin(t,e)))),t.scenes&&(t.scenes=t.scenes.map(((t,e)=>this._resolveScene(t,e)))),void 0!==t.scene&&(t.scene=t.scenes[this.json.scene])}getScene(t){return this._get("scenes",t)}getNode(t){return this._get("nodes",t)}getSkin(t){return this._get("skins",t)}getMesh(t){return this._get("meshes",t)}getMaterial(t){return this._get("materials",t)}getAccessor(t){return this._get("accessors",t)}getCamera(t){return null}getTexture(t){return this._get("textures",t)}getSampler(t){return this._get("samplers",t)}getImage(t){return this._get("images",t)}getBufferView(t){return this._get("bufferViews",t)}getBuffer(t){return this._get("buffers",t)}_get(t,e){if("object"==typeof e)return e;return this.json[t]&&this.json[t][e]}_resolveScene(t,e){return t.id=t.id||"scene-".concat(e),t.nodes=(t.nodes||[]).map((t=>this.getNode(t))),t}_resolveNode(t,e){return t.id=t.id||"node-".concat(e),t.children&&(t.children=t.children.map((t=>this.getNode(t)))),void 0!==t.mesh?t.mesh=this.getMesh(t.mesh):void 0!==t.meshes&&t.meshes.length&&(t.mesh=t.meshes.reduce(((t,e)=>{const i=this.getMesh(e);return t.id=i.id,t.primitives=t.primitives.concat(i.primitives),t}),{primitives:[]})),void 0!==t.camera&&(t.camera=this.getCamera(t.camera)),void 0!==t.skin&&(t.skin=this.getSkin(t.skin)),t}_resolveSkin(t,e){return t.id=t.id||"skin-".concat(e),t.inverseBindMatrices=this.getAccessor(t.inverseBindMatrices),t}_resolveMesh(t,e){return t.id=t.id||"mesh-".concat(e),t.primitives&&(t.primitives=t.primitives.map((t=>{const e=(t={...t}).attributes;t.attributes={};for(const i in e)t.attributes[i]=this.getAccessor(e[i]);return void 0!==t.indices&&(t.indices=this.getAccessor(t.indices)),void 0!==t.material&&(t.material=this.getMaterial(t.material)),t}))),t}_resolveMaterial(t,e){if(t.id=t.id||"material-".concat(e),t.normalTexture&&(t.normalTexture={...t.normalTexture},t.normalTexture.texture=this.getTexture(t.normalTexture.index)),t.occlusionTexture&&(t.occlustionTexture={...t.occlustionTexture},t.occlusionTexture.texture=this.getTexture(t.occlusionTexture.index)),t.emissiveTexture&&(t.emmisiveTexture={...t.emmisiveTexture},t.emissiveTexture.texture=this.getTexture(t.emissiveTexture.index)),t.emissiveFactor||(t.emissiveFactor=t.emmisiveTexture?[1,1,1]:[0,0,0]),t.pbrMetallicRoughness){t.pbrMetallicRoughness={...t.pbrMetallicRoughness};const e=t.pbrMetallicRoughness;e.baseColorTexture&&(e.baseColorTexture={...e.baseColorTexture},e.baseColorTexture.texture=this.getTexture(e.baseColorTexture.index)),e.metallicRoughnessTexture&&(e.metallicRoughnessTexture={...e.metallicRoughnessTexture},e.metallicRoughnessTexture.texture=this.getTexture(e.metallicRoughnessTexture.index))}return t}_resolveAccessor(t,e){if(t.id=t.id||"accessor-".concat(e),void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView)),t.bytesPerComponent=VO[t.componentType],t.components=GO[t.type],t.bytesPerElement=t.bytesPerComponent*t.components,t.bufferView){const e=t.bufferView.buffer,{ArrayType:i,byteLength:n}=lD(t,t.bufferView),r=(t.bufferView.byteOffset||0)+(t.byteOffset||0)+e.byteOffset;let s=e.arrayBuffer.slice(r,r+n);t.bufferView.byteStride&&(s=this._getValueFromInterleavedBuffer(e,r,t.bufferView.byteStride,t.bytesPerElement,t.count)),t.value=new i(s)}return t}_getValueFromInterleavedBuffer(t,e,i,n,r){const s=new Uint8Array(r*n);for(let o=0;o<r;o++){const r=e+o*i;s.set(new Uint8Array(t.arrayBuffer.slice(r,r+n)),o*n)}return s.buffer}_resolveTexture(t,e){return t.id=t.id||"texture-".concat(e),t.sampler="sampler"in t?this.getSampler(t.sampler):JO,t.source=this.getImage(t.source),t}_resolveSampler(t,e){t.id=t.id||"sampler-".concat(e),t.parameters={};for(const e in t){const i=this._enumSamplerParameter(e);void 0!==i&&(t.parameters[i]=t[e])}return t}_enumSamplerParameter(t){return ZO[t]}_resolveImage(t,e){t.id=t.id||"image-".concat(e),void 0!==t.bufferView&&(t.bufferView=this.getBufferView(t.bufferView));const i=this.images[e];return i&&(t.image=i),t}_resolveBufferView(t,e){const i=t.buffer,n={id:"bufferView-".concat(e),...t,buffer:this.buffers[i]};let r=this.buffers[i].byteOffset||0;return"byteOffset"in t&&(r+=t.byteOffset),n.data=new Uint8Array(this.buffers[i].arrayBuffer,r,t.byteLength),n}_resolveCamera(t,e){return t.id=t.id||"camera-".concat(e),t}}const $O=1735152710,KO=12,QO=8,tk=1313821514,ek=5130562,ik=0,nk=1,rk=0,sk=!0;function ok(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=new DataView(e),r=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"".concat(String.fromCharCode(t.getUint8(e+0))).concat(String.fromCharCode(t.getUint8(e+1))).concat(String.fromCharCode(t.getUint8(e+2))).concat(String.fromCharCode(t.getUint8(e+3)))}(n,i+0),s=n.getUint32(i+4,sk),o=n.getUint32(i+8,sk);switch(Object.assign(t,{header:{byteOffset:i,byteLength:o,hasBinChunk:!1},type:r,version:s,json:{},binChunks:[]}),i+=KO,t.version){case 1:return function(t,e,i){Be(t.header.byteLength>KO+QO);const n=e.getUint32(i+0,sk),r=e.getUint32(i+4,sk);return i+=QO,Be(r===rk),ak(t,e,i,n),i+=n,i+=lk(t,e,i,t.header.byteLength),i}(t,n,i);case 2:return function(t,e,i,n){return Be(t.header.byteLength>KO+QO),function(t,e,i,n){for(;i+8<=t.header.byteLength;){const r=e.getUint32(i+0,sk),s=e.getUint32(i+4,sk);switch(i+=QO,s){case tk:ak(t,e,i,r);break;case ek:lk(t,e,i,r);break;case ik:n.strict||ak(t,e,i,r);break;case nk:n.strict||lk(t,e,i,r)}i+=mi(r,4)}}(t,e,i,n),i+t.header.byteLength}(t,n,i,{});default:throw new Error("Invalid GLB version ".concat(t.version,". Only supports v1 and v2."))}}function ak(t,e,i,n){const r=new Uint8Array(e.buffer,i,n),s=new TextDecoder("utf8").decode(r);return t.json=JSON.parse(s),mi(n,4)}function lk(t,e,i,n){return t.header.hasBinChunk=!0,t.binChunks.push({byteOffset:i,byteLength:n,arrayBuffer:e.buffer}),mi(n,4)}async function ck(t,e){var i,n,r,s;let o=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;!function(t,e,i,n){n.uri&&(t.baseUri=n.uri);if(e instanceof ArrayBuffer&&!function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=new DataView(t),{magic:r=$O}=i,s=n.getUint32(e,!1);return s===r||s===$O}(e,i,n)){e=(new TextDecoder).decode(e)}if("string"==typeof e)t.json=pi(e);else if(e instanceof ArrayBuffer){const r={};i=ok(r,e,i,n.glb),KB("glTF"===r.type,"Invalid GLB magic string ".concat(r.type)),t._glb=r,t.json=r.json}else KB(!1,"GLTF: must be ArrayBuffer or string");const r=t.json.buffers||[];if(t.buffers=new Array(r.length).fill(null),t._glb&&t._glb.header.hasBinChunk){const{binChunks:e}=t._glb;t.buffers[0]={arrayBuffer:e[0].arrayBuffer,byteOffset:e[0].byteOffset,byteLength:e[0].byteLength}}const s=t.json.images||[];t.images=new Array(s.length).fill({})}(t,e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(new UO).normalize(t,e)}(t,{normalize:null==o||null===(i=o.gltf)||void 0===i?void 0:i.normalize}),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=OO.filter((t=>kO(t.name,e)));for(const s of n){var r;null===(r=s.preprocess)||void 0===r||r.call(s,t,e,i)}}(t,o,a);const l=[];if(null!=o&&null!==(n=o.gltf)&&void 0!==n&&n.loadBuffers&&t.json.buffers&&await async function(t,e,i){const n=t.json.buffers||[];for(let o=0;o<n.length;++o){const a=n[o];if(a.uri){var r,s;const{fetch:n}=i;KB(n);const l=QB(a.uri,e),c=await(null==i||null===(r=i.fetch)||void 0===r?void 0:r.call(i,l)),h=await(null==c||null===(s=c.arrayBuffer)||void 0===s?void 0:s.call(c));t.buffers[o]={arrayBuffer:h,byteOffset:0,byteLength:h.byteLength},delete a.uri}else null===t.buffers[o]&&(t.buffers[o]={arrayBuffer:new ArrayBuffer(a.byteLength),byteOffset:0,byteLength:a.byteLength})}}(t,o,a),null!=o&&null!==(r=o.gltf)&&void 0!==r&&r.loadImages){const e=async function(t,e,i){const n=function(t){const e=new Set,i=t.json.textures||[];for(const t of i)void 0!==t.source&&e.add(t.source);return Array.from(e).sort()}(t),r=t.json.images||[],s=[];for(const o of n)s.push(hk(t,r[o],o,e,i));return await Promise.all(s)}(t,o,a);l.push(e)}const c=async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=OO.filter((t=>kO(t.name,e)));for(const s of n){var r;await(null===(r=s.decode)||void 0===r?void 0:r.call(s,t,e,i))}}(t,o,a);return l.push(c),await Promise.all(l),null!=o&&null!==(s=o.gltf)&&void 0!==s&&s.postProcess?function(t,e){return(new YO).postProcess(t,e)}(t,o):t}async function hk(t,e,i,n,r){const{fetch:s,parse:o}=r;let a;if(e.uri&&!e.hasOwnProperty("bufferView")){const t=QB(e.uri,n),i=await s(t);a=await i.arrayBuffer(),e.bufferView={data:a}}if(Number.isFinite(e.bufferView)){const i=function(t,e,i){const n=t.bufferViews[i];KB(n);const r=e[n.buffer];return KB(r),new Uint8Array(r.arrayBuffer,(n.byteOffset||0)+r.byteOffset,n.byteLength)}(t.json,t.buffers,e.bufferView);a=fi(i.buffer,i.byteOffset,i.byteLength)}KB(a,"glTF image has no data");let l=await o(a,[ur,$B],{mimeType:e.mimeType,basis:n.basis||{format:YB()}},r);l&&l[0]&&(l={compressed:!0,mipmaps:!1,width:l[0].width,height:l[0].height,data:l[0]}),t.images=t.images||[],t.images[i]=l}const uk={name:"glTF",id:"gltf",module:"gltf",version:"3.4.14",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;e={...uk.options,...e},e.gltf={...uk.options.gltf,...e.gltf};const{byteOffset:n=0}=e;return await ck({},t,n,e,i)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0,postProcess:!0},log:console},deprecatedOptions:{fetchImages:"gltf.loadImages",createImages:"gltf.loadImages",decompress:"gltf.decompressMeshes",postProcess:"gltf.postProcess",gltf:{decompress:"gltf.decompressMeshes"}}};async function dk(t){const e=[];return t.scenes.forEach((t=>{t.traverse((t=>{Object.values(t.model.getUniforms()).forEach((t=>{!1===t.loaded&&e.push(t)}))}))})),await async function(t){for(;t();)await new Promise((t=>requestAnimationFrame(t)))}((()=>e.some((t=>!t.loaded))))}const pk=[255,255,255,255],fk={scenegraph:{type:"object",value:null,async:!0},getScene:t=>t&&t.scenes?"object"==typeof t.scene?t.scene:t.scenes[t.scene||0]:t,getAnimator:t=>t&&t.animator,_animations:null,sizeScale:{type:"number",value:1,min:0},sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:pk},_lighting:"flat",_imageBasedLightingEnvironment:null,getOrientation:{type:"accessor",value:[0,0,0]},getScale:{type:"accessor",value:[1,1,1]},getTranslation:{type:"accessor",value:[0,0,0]},getTransformMatrix:{type:"accessor",value:[]},loaders:[uk]};class mk extends Jm{constructor(...t){super(...t),He(this,"state",void 0)}getShaders(){const t=[ip,np];return"pbr"===this.props._lighting&&t.push(Uh),{vs:"#version 300 es\n\n// Instance attributes\nin vec3 instancePositions;\nin vec3 instancePositions64Low;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nin vec3 instanceTranslation;\n\n// Uniforms\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform mat4 sceneModelMatrix;\nuniform bool composeModelMatrix;\n\n// Attributes\nin vec4 POSITION;\n\n#ifdef HAS_UV\n  in vec2 TEXCOORD_0;\n#endif\n\n#ifdef MODULE_PBR\n  #ifdef HAS_NORMALS\n    in vec4 NORMAL;\n  #endif\n#endif\n\n// Varying\nout vec4 vColor;\n\n// MODULE_PBR contains all the varying definitions needed\n#ifndef MODULE_PBR\n  #ifdef HAS_UV\n    out vec2 vTEXCOORD_0;\n  #endif\n#endif\n\n// Main\nvoid main(void) {\n  #if defined(HAS_UV) && !defined(MODULE_PBR)\n    vTEXCOORD_0 = TEXCOORD_0;\n    geometry.uv = vTEXCOORD_0;\n  #endif\n\n  geometry.worldPosition = instancePositions;\n  geometry.pickingColor = instancePickingColors;\n\n  vec3 normal = vec3(0.0, 0.0, 1.0);\n  #ifdef MODULE_PBR\n    #ifdef HAS_NORMALS\n      normal = instanceModelMatrix * (sceneModelMatrix * vec4(NORMAL.xyz, 0.0)).xyz;\n    #endif\n  #endif\n\n  float originalSize = project_size_to_pixel(sizeScale);\n  float clampedSize = clamp(originalSize, sizeMinPixels, sizeMaxPixels);\n\n  vec3 pos = (instanceModelMatrix * (sceneModelMatrix * POSITION).xyz) * sizeScale * (clampedSize / originalSize) + instanceTranslation;\n  if(composeModelMatrix) {\n    DECKGL_FILTER_SIZE(pos, geometry);\n    // using instancePositions as world coordinates\n    // when using globe mode, this branch does not re-orient the model to align with the surface of the earth\n    // call project_normal before setting position to avoid rotation\n    geometry.normal = project_normal(normal);\n    gl_Position = project_position_to_clipspace(pos + instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n  }\n  else {\n    pos = project_size(pos);\n    DECKGL_FILTER_SIZE(pos, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, pos, geometry.position);\n    geometry.normal = project_normal(normal);\n  }\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  #ifdef MODULE_PBR\n    // set PBR data\n    pbr_vPosition = geometry.position.xyz;\n    #ifdef HAS_NORMALS\n      pbr_vNormal = geometry.normal;\n    #endif\n\n    #ifdef HAS_UV\n      pbr_vUV = TEXCOORD_0;\n    #else\n      pbr_vUV = vec2(0., 0.);\n    #endif\n    geometry.uv = pbr_vUV;\n  #endif\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n\n// Uniforms\nuniform float opacity;\n\n// Varying\nin vec4 vColor;\n\nout vec4 fragmentColor;\n\n// MODULE_PBR contains all the varying definitions needed\n#ifndef MODULE_PBR\n  #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n    in vec2 vTEXCOORD_0;\n    uniform sampler2D u_BaseColorSampler;\n  #endif\n#endif\n\nvoid main(void) {\n  #ifdef MODULE_PBR\n    fragmentColor = vColor * pbr_filterColor(vec4(0));\n    geometry.uv = pbr_vUV;\n  #else\n    #if defined(HAS_UV) && defined(HAS_BASECOLORMAP)\n      fragmentColor = vColor * texture2D(u_BaseColorSampler, vTEXCOORD_0);\n      geometry.uv = vTEXCOORD_0;\n    #else\n      fragmentColor = vColor;\n    #endif\n  #endif\n\n  fragmentColor.a *= opacity;\n  DECKGL_FILTER_COLOR(fragmentColor, geometry);\n}\n",modules:t}}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),accessor:"getPosition",transition:!0},instanceColors:{type:5121,size:this.props.colorFormat.length,accessor:"getColor",normalized:!0,defaultValue:pk,transition:!0},instanceModelMatrix:JR})}updateState(t){super.updateState(t);const{props:e,oldProps:i}=t;e.scenegraph!==i.scenegraph?this._updateScenegraph():e._animations!==i._animations&&this._applyAnimationsProp(this.state.scenegraph,this.state.animator,e._animations)}finalizeState(t){super.finalizeState(t),this._deleteScenegraph()}_updateScenegraph(){const t=this.props,{gl:e}=this.context;let i=null;if(t.scenegraph instanceof eB)i={scenes:[t.scenegraph]};else if(t.scenegraph&&!t.scenegraph.gltf){const n=t.scenegraph,r=function(t,e,i){const n=new gB(t,i);return{scenes:n.instantiate(e),animator:n.createAnimator()}}(e,n,this._getModelOptions());i={gltf:n,...r},dk(r).then((()=>this.setNeedsRedraw()))}else t.scenegraph&&(kr.deprecated("ScenegraphLayer.props.scenegraph","Use GLTFLoader instead of GLTFScenegraphLoader")(),i=t.scenegraph);const n={layer:this,gl:e},r=t.getScene(i,n),s=t.getAnimator(i,n);r instanceof eB?(this._deleteScenegraph(),this._applyAllAttributes(r),this._applyAnimationsProp(r,s,t._animations),this.setState({scenegraph:r,animator:s})):null!==r&&kr.warn("invalid scenegraph:",r)()}_applyAllAttributes(t){if(this.state.attributesAvailable){const e=this.getAttributeManager().getAttributes();t.traverse((t=>{this._setModelAttributes(t.model,e)}))}}_applyAnimationsProp(t,e,i){if(!t||!e||!i)return;const n=e.getAnimations();Object.keys(i).sort().forEach((t=>{const e=i[t];if("*"===t)n.forEach((t=>{Object.assign(t,e)}));else if(Number.isFinite(Number(t))){const i=Number(t);i>=0&&i<n.length?Object.assign(n[i],e):kr.warn("animation ".concat(t," not found"))()}else{const i=n.find((({name:e})=>e===t));i?Object.assign(i,e):kr.warn("animation ".concat(t," not found"))()}}))}_deleteScenegraph(){const{scenegraph:t}=this.state;t instanceof eB&&t.delete()}_getModelOptions(){const{_imageBasedLightingEnvironment:t}=this.props;let e=null;return t&&(e="function"==typeof t?t({gl:this.context.gl,layer:this}):t),{gl:this.context.gl,waitForFullLoad:!0,imageBasedLightingEnvironment:e,modelOptions:{isInstanced:!0,transpileToGLSL100:!Yr(this.context.gl),...this.getShaders()},useTangents:!1}}updateAttributes(t){this.setState({attributesAvailable:!0}),this.state.scenegraph&&this.state.scenegraph.traverse((e=>{this._setModelAttributes(e.model,t)}))}draw({moduleParameters:t=null,parameters:e={},context:i}){if(!this.state.scenegraph)return;this.props._animations&&this.state.animator&&(this.state.animator.animate(i.timeline.getTime()),this.setNeedsRedraw());const{viewport:n}=this.context,{sizeScale:r,sizeMinPixels:s,sizeMaxPixels:o,opacity:a,coordinateSystem:l}=this.props,c=this.getNumInstances();this.state.scenegraph.traverse(((i,{worldMatrix:h})=>{i.model.setInstanceCount(c),i.updateModuleSettings(t),i.draw({parameters:e,uniforms:{sizeScale:r,opacity:a,sizeMinPixels:s,sizeMaxPixels:o,composeModelMatrix:YR(n,l),sceneModelMatrix:h,u_Camera:i.model.getUniforms().project_uCameraPosition}})}))}}He(mk,"defaultProps",fk),He(mk,"layerName","ScenegraphLayer");class gk extends tB{getShaders(){const t=super.getShaders();return t.modules.push(Uh),{...t,vs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-vs\nuniform float sizeScale;\nuniform bool composeModelMatrix;\nuniform bool pickFeatureIds;\nin vec3 positions;\nin vec3 normals;\nin vec3 colors;\nin vec2 texCoords;\nin vec4 uvRegions;\nin vec3 featureIdsPickingColors;\nin vec4 instanceColors;\nin vec3 instancePickingColors;\nin mat3 instanceModelMatrix;\nout vec2 vTexCoord;\nout vec3 cameraPosition;\nout vec3 normals_commonspace;\nout vec4 position_commonspace;\nout vec4 vColor;\n\nvec2 applyUVRegion(vec2 uv) {\n  #ifdef HAS_UV_REGIONS\n    return fract(uv) * (uvRegions.zw - uvRegions.xy) + uvRegions.xy;\n  #else\n    return uv;\n  #endif\n}\n\nvoid main(void) {\n  vec2 uv = applyUVRegion(texCoords);\n  geometry.uv = uv;\n\n  if (pickFeatureIds) {\n    geometry.pickingColor = featureIdsPickingColors;\n  } else {\n    geometry.pickingColor = instancePickingColors;\n  }\n\n  vTexCoord = uv;\n  cameraPosition = project_uCameraPosition;\n  vColor = vec4(colors * instanceColors.rgb, instanceColors.a);\n\n  vec3 pos = (instanceModelMatrix * positions) * sizeScale;\n  vec3 projectedPosition = project_position(positions);\n  position_commonspace = vec4(projectedPosition, 1.0);\n  gl_Position = project_common_position_to_clipspace(position_commonspace);\n\n  geometry.position = position_commonspace;\n  normals_commonspace = project_normal(instanceModelMatrix * normals);\n  geometry.normal = normals_commonspace;\n\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  #ifdef MODULE_PBR\n    pbr_vPosition = geometry.position.xyz;\n    #ifdef HAS_NORMALS\n      pbr_vNormal = geometry.normal;\n    #endif\n\n    #ifdef HAS_UV\n      pbr_vUV = uv;\n    #else\n      pbr_vUV = vec2(0., 0.);\n    #endif\n    geometry.uv = pbr_vUV;\n  #endif\n\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME simple-mesh-layer-fs\n\nprecision highp float;\n\nuniform bool hasTexture;\nuniform sampler2D sampler;\nuniform bool flatShading;\nuniform float opacity;\n\nin vec2 vTexCoord;\nin vec3 cameraPosition;\nin vec3 normals_commonspace;\nin vec4 position_commonspace;\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  \n#ifdef MODULE_PBR\n\n  fragColor = vColor * pbr_filterColor(vec4(0));\n  geometry.uv = pbr_vUV;\n  fragColor.a *= opacity;\n\n#else\n\n  geometry.uv = vTexCoord;\n\n  vec3 normal;\n  if (flatShading) {\n#ifdef DERIVATIVES_AVAILABLE\n    normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n#else\n    normal = vec3(0.0, 0.0, 1.0);\n#endif\n  } else {\n    normal = normals_commonspace;\n  }\n\n  vec4 color = hasTexture ? texture(sampler, vTexCoord) : vColor;\n  vec3 lightColor = lighting_getLightColor(color.rgb, cameraPosition, position_commonspace.xyz, normal);\n  fragColor = vec4(lightColor, color.a * opacity);\n\n#endif\n\n  DECKGL_FILTER_COLOR(fragColor, geometry);\n}\n"}}initializeState(){const{featureIds:t}=this.props;super.initializeState();const e=this.getAttributeManager();t&&e.add({featureIdsPickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateFeatureIdsPickingColors}})}updateState(t){super.updateState(t);const{props:e,oldProps:i}=t;e.pbrMaterial!==i.pbrMaterial&&this.updatePbrMaterialUniforms(e.pbrMaterial)}draw(t){const{featureIds:e}=this.props;this.state.model&&(this.state.model.setUniforms({u_Camera:this.state.model.getUniforms().project_uCameraPosition,pickFeatureIds:Boolean(e)}),super.draw(t))}getModel(t){const{id:e,pbrMaterial:i}=this.props,n=this.parseMaterial(i,t);this.setState({materialParser:n});const r=this.getShaders();var s;(s=t.attributes).COLOR_0||s.colors||(s.colors={constant:!0,value:new Float32Array([1,1,1])});return new Zh(this.context.gl,{...this.getShaders(),id:e,geometry:t,defines:{...r.defines,...null==n?void 0:n.defines,HAS_UV_REGIONS:t.attributes.uvRegions},parameters:null==n?void 0:n.parameters,isInstanced:!0})}updatePbrMaterialUniforms(t){const{model:e}=this.state;if(e){const{mesh:i}=this.props,n=this.parseMaterial(t,i);this.setState({materialParser:n}),e.setUniforms(n.uniforms)}}parseMaterial(t,e){var i;const n=Boolean(t.pbrMetallicRoughness&&t.pbrMetallicRoughness.baseColorTexture);return null===(i=this.state.materialParser)||void 0===i||i.delete(),new dB(this.context.gl,{attributes:{NORMAL:e.attributes.normals,TEXCOORD_0:e.attributes.texCoords},material:{unlit:n,...t},pbrDebug:!1,imageBasedLightingEnvironment:null,lights:!0,useTangents:!1})}calculateFeatureIdsPickingColors(t){const e=this.props.featureIds,i=new Uint8ClampedArray(e.length*t.size),n=[];for(let t=0;t<e.length;t++)this.encodePickingColor(e[t],n),i[3*t]=n[0],i[3*t+1]=n[1],i[3*t+2]=n[2];t.value=i}finalizeState(t){var e;super.finalizeState(t),null===(e=this.state.materialParser)||void 0===e||e.delete(),this.setState({materialParser:null})}}He(gk,"layerName","MeshLayer"),He(gk,"defaultProps",{pbrMaterial:{type:"object",value:null},featureIds:{type:"array",value:null,optional:!0}});function _k(t){return t}function yk(t,e=[]){return function(t,e=[],i=_k){return"longitude"in t?(e[0]=i(t.longitude),e[1]=i(t.latitude),e[2]=t.height):"x"in t?(e[0]=i(t.x),e[1]=i(t.y),e[2]=t.z):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}(t,e,Yl._cartographicRadians?_k:Ql)}function vk(t,e){return function(t,e,i=_k){return"longitude"in e?(e.longitude=i(t[0]),e.latitude=i(t[1]),e.height=t[2]):"x"in e?(e.x=i(t[0]),e.y=i(t[1]),e.z=t[2]):(e[0]=i(t[0]),e[1]=i(t[1]),e[2]=t[2]),e}(t,e,Yl._cartographicRadians?_k:tc)}new Dc;const xk=new Dc,bk=new Dc,wk=new Dc;const Ak=new Dc,Tk={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},Mk={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},Sk={east:new Dc,north:new Dc,up:new Dc,west:new Dc,south:new Dc,down:new Dc},Ek=new Dc,Ck=new Dc,Ik=new Dc;function Pk(t,e,i,n,r,s){const o=Tk[e]&&Tk[e][i];let a,l,c;Xl(o&&(!n||n===o));const h=Ak.copy(r);if(rc(h.x,0,1e-14)&&rc(h.y,0,1e-14)){const t=Math.sign(h.z);a=Ek.fromArray(Mk[e]),"east"!==e&&"west"!==e&&a.scale(t),l=Ck.fromArray(Mk[i]),"east"!==i&&"west"!==i&&l.scale(t),c=Ik.fromArray(Mk[n]),"east"!==n&&"west"!==n&&c.scale(t)}else{const{up:r,east:s,north:o}=Sk;s.set(-h.y,h.x,0).normalize(),t.geodeticSurfaceNormal(h,r),o.copy(r).cross(s);const{down:u,west:d,south:p}=Sk;u.copy(r).scale(-1),d.copy(s).scale(-1),p.copy(o).scale(-1),a=Sk[e],l=Sk[i],c=Sk[n]}return s[0]=a.x,s[1]=a.y,s[2]=a.z,s[3]=0,s[4]=l.x,s[5]=l.y,s[6]=l.z,s[7]=0,s[8]=c.x,s[9]=c.y,s[10]=c.z,s[11]=0,s[12]=h.x,s[13]=h.y,s[14]=h.z,s[15]=1,s}const Lk=new Dc,Rk=new Dc,Bk=new Dc,Dk=new Dc,Ok=new Dc,kk=new Dc;class Fk{constructor(t=0,e=0,i=0){He(this,"radii",void 0),He(this,"radiiSquared",void 0),He(this,"radiiToTheFourth",void 0),He(this,"oneOverRadii",void 0),He(this,"oneOverRadiiSquared",void 0),He(this,"minimumRadius",void 0),He(this,"maximumRadius",void 0),He(this,"centerToleranceSquared",Ch.EPSILON1),He(this,"squaredXOverSquaredZ",void 0),Xl(t>=0),Xl(e>=0),Xl(i>=0),this.radii=new Dc(t,e,i),this.radiiSquared=new Dc(t*t,e*e,i*i),this.radiiToTheFourth=new Dc(t*t*t*t,e*e*e*e,i*i*i*i),this.oneOverRadii=new Dc(0===t?0:1/t,0===e?0:1/e,0===i?0:1/i),this.oneOverRadiiSquared=new Dc(0===t?0:1/(t*t),0===e?0:1/(e*e),0===i?0:1/(i*i)),this.minimumRadius=Math.min(t,e,i),this.maximumRadius=Math.max(t,e,i),0!==this.radiiSquared.z&&(this.squaredXOverSquaredZ=this.radiiSquared.x/this.radiiSquared.z),Object.freeze(this)}equals(t){return this===t||Boolean(t&&this.radii.equals(t.radii))}toString(){return this.radii.toString()}cartographicToCartesian(t,e=[0,0,0]){const i=Rk,n=Bk,[,,r]=t;this.geodeticSurfaceNormalCartographic(t,i),n.copy(this.radiiSquared).scale(i);const s=Math.sqrt(i.dot(n));return n.scale(1/s),i.scale(r),n.add(i),n.to(e)}cartesianToCartographic(t,e=[0,0,0]){kk.from(t);const i=this.scaleToGeodeticSurface(kk,Dk);if(!i)return;const n=this.geodeticSurfaceNormal(i,Rk),r=Ok;r.copy(kk).subtract(i);return vk([Math.atan2(n.y,n.x),Math.asin(n.z),Math.sign(Tc(r,kk))*wc(r)],e)}eastNorthUpToFixedFrame(t,e=new lh){return Pk(this,"east","north","up",t,e)}localFrameToFixedFrame(t,e,i,n,r=new lh){return Pk(this,t,e,i,n,r)}geocentricSurfaceNormal(t,e=[0,0,0]){return Lk.from(t).normalize().to(e)}geodeticSurfaceNormalCartographic(t,e=[0,0,0]){const i=yk(t),n=i[0],r=i[1],s=Math.cos(r);return Lk.set(s*Math.cos(n),s*Math.sin(n),Math.sin(r)).normalize(),Lk.to(e)}geodeticSurfaceNormal(t,e=[0,0,0]){return Lk.from(t).scale(this.oneOverRadiiSquared).normalize().to(e)}scaleToGeodeticSurface(t,e){return function(t,e,i=[]){const{oneOverRadii:n,oneOverRadiiSquared:r,centerToleranceSquared:s}=e;xk.from(t);const o=xk.x,a=xk.y,l=xk.z,c=n.x,h=n.y,u=n.z,d=o*o*c*c,p=a*a*h*h,f=l*l*u*u,m=d+p+f,g=Math.sqrt(1/m);if(!Number.isFinite(g))return;const _=bk;if(_.copy(t).scale(g),m<s)return _.to(i);const y=r.x,v=r.y,x=r.z,b=wk;b.set(_.x*y*2,_.y*v*2,_.z*x*2);let w,A,T,M,S=(1-g)*xk.len()/(.5*b.len()),E=0;do{S-=E,w=1/(1+S*y),A=1/(1+S*v),T=1/(1+S*x);const t=w*w,e=A*A,i=T*T;M=d*t+p*e+f*i-1,E=M/(-2*(d*(t*w)*y+p*(e*A)*v+f*(i*T)*x))}while(Math.abs(M)>Ch.EPSILON12);return xk.scale([w,A,T]).to(i)}(t,this,e)}scaleToGeocentricSurface(t,e=[0,0,0]){Dk.from(t);const i=Dk.x,n=Dk.y,r=Dk.z,s=this.oneOverRadiiSquared,o=1/Math.sqrt(i*i*s.x+n*n*s.y+r*r*s.z);return Dk.multiplyScalar(o).to(e)}transformPositionToScaledSpace(t,e=[0,0,0]){return Dk.from(t).scale(this.oneOverRadii).to(e)}transformPositionFromScaledSpace(t,e=[0,0,0]){return Dk.from(t).scale(this.radii).to(e)}getSurfaceNormalIntersectionWithZAxis(t,e=0,i=[0,0,0]){Xl(rc(this.radii.x,this.radii.y,Ch.EPSILON15)),Xl(this.radii.z>0),Dk.from(t);const n=Dk.z*(1-this.squaredXOverSquaredZ);if(!(Math.abs(n)>=this.radii.z-e))return Dk.set(0,0,n).to(i)}}function zk(){let t;if("undefined"!=typeof window&&window.performance)t=window.performance.now();else if("undefined"!=typeof process&&process.hrtime){const e=process.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}He(Fk,"WGS84",new Fk(6378137,6378137,6356752.314245179));class Nk{constructor(t,e){this.name=void 0,this.type=void 0,this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=t,this.type=e,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=zk(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(zk()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class Uk{constructor(t){this.id=void 0,this.stats={},this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t){return this._getOrCreate({name:t,type:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count"})}get size(){return Object.keys(this.stats).length}reset(){for(const t of Object.values(this.stats))t.reset();return this}forEach(t){for(const e of Object.values(this.stats))t(e)}getTable(){const t={};return this.forEach((e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}})),t}_initializeStats(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((t=>this._getOrCreate(t)))}_getOrCreate(t){const{name:e,type:i}=t;let n=this.stats[e];return n||(n=t instanceof Nk?t:new Nk(e,i),this.stats[e]=n),n}}class Gk{constructor(t,e,i){He(this,"item",void 0),He(this,"previous",void 0),He(this,"next",void 0),this.item=t,this.previous=e,this.next=i}}class Vk{constructor(){He(this,"head",null),He(this,"tail",null),He(this,"_length",0)}get length(){return this._length}add(t){const e=new Gk(t,this.tail,null);return this.tail?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),++this._length,e}remove(t){t&&(t.previous&&t.next?(t.previous.next=t.next,t.next.previous=t.previous):t.previous?(t.previous.next=null,this.tail=t.previous):t.next?(t.next.previous=null,this.head=t.next):(this.head=null,this.tail=null),t.next=null,t.previous=null,--this._length)}splice(t,e){t!==e&&(this.remove(e),this._insert(t,e))}_insert(t,e){const i=t.next;t.next=e,this.tail===t?this.tail=e:i.previous=e,e.next=i,e.previous=t,++this._length}}class jk{constructor(){He(this,"_list",void 0),He(this,"_sentinel",void 0),He(this,"_trimTiles",void 0),this._list=new Vk,this._sentinel=this._list.add("sentinel"),this._trimTiles=!1}reset(){this._list.splice(this._list.tail,this._sentinel)}touch(t){const e=t._cacheNode;e&&this._list.splice(this._sentinel,e)}add(t,e,i){e._cacheNode||(e._cacheNode=this._list.add(e),i&&i(t,e))}unloadTile(t,e,i){const n=e._cacheNode;n&&(this._list.remove(n),e._cacheNode=null,i&&i(t,e))}unloadTiles(t,e){const i=this._trimTiles;this._trimTiles=!1;const n=1024*t.maximumMemoryUsage*1024,r=this._sentinel;let s=this._list.head;for(;s!==r&&(t.gpuMemoryUsageInBytes>n||i);){const i=s.item;s=s.next,this.unloadTile(t,i,e)}}trim(){this._trimTiles=!0}}const Hk=new Dc,Wk=new Dc,qk=new SR([new wR,new wR,new wR,new wR,new wR,new wR]);function Xk(t,e){const{cameraDirection:i,cameraUp:n,height:r}=t,{metersPerUnit:s}=t.distanceScales,o=Jk(t,t.center),a=Fk.WGS84.eastNorthUpToFixedFrame(o),l=t.unprojectPosition(t.cameraPosition),c=Fk.WGS84.cartographicToCartesian(l,new Dc),h=new Dc(a.transformAsVector(new Dc(i).scale(s))).normalize(),u=new Dc(a.transformAsVector(new Dc(n).scale(s))).normalize();!function(t){const e=t.getFrustumPlanes(),i=Zk(e.near,t.cameraPosition),n=Jk(t,i),r=Jk(t,t.cameraPosition,Wk);let s=0;qk.planes[s++].fromPointNormal(n,Hk.copy(n).subtract(r));for(const r in e){if("near"===r)continue;const o=Jk(t,Zk(e[r],i,Wk),Wk);qk.planes[s++].fromPointNormal(o,Hk.copy(n).subtract(o))}}(t);const d=t.constructor,{longitude:p,latitude:f,width:m,bearing:g,zoom:_}=t;return{camera:{position:c,direction:h,up:u},viewport:t,topDownViewport:new d({longitude:p,latitude:f,height:r,width:m,bearing:g,zoom:_,pitch:0}),height:r,cullingVolume:qk,frameNumber:e,sseDenominator:1.15}}function Zk(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Dc;const n=t.normal.dot(e);return i.copy(t.normal).scale(t.distance-n).add(e),i}function Jk(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Dc;const n=t.unprojectPosition(e);return Fk.WGS84.cartographicToCartesian(n,i)}const Yk=6356752.314245179,$k=new Dc;function Kk(t,e){if(t instanceof vR){const{halfAxes:i}=t,n=function(t){t.getColumn(0,$k);const e=t.getColumn(1),i=t.getColumn(2),n=$k.add(e).add(i);return n.len()}(i);return Math.log2(Yk/(n+e[2]))}if(t instanceof iR){const{radius:i}=t;return Math.log2(Yk/(i+e[2]))}if(t.width&&t.height){const{width:e,height:i}=t;return(Math.log2(6378137/e)+Math.log2(6378137/i))/2}return 1}function Qk(t,e,i){const n=Fk.WGS84.cartographicToCartesian([t.xmax,t.ymax,t.zmax],new Dc),r=Math.sqrt(Math.pow(n[0]-i[0],2)+Math.pow(n[1]-i[1],2)+Math.pow(n[2]-i[2],2));return Math.log2(Yk/(r+e[2]))}const tF=0,eF=1,iF=3,nF=4,rF=5,sF={ADD:1,REPLACE:2},oF={EMPTY:"empty",SCENEGRAPH:"scenegraph",POINTCLOUD:"pointcloud",MESH:"mesh"},aF={I3S:"I3S",TILES3D:"TILES3D"},lF={GEOMETRIC_ERROR:"geometricError",MAX_SCREEN_THRESHOLD:"maxScreenThreshold"},cF=1;function hF(t){return null!=t}const uF=new Dc,dF=new Dc,pF=new Dc,fF=new Dc;function mF(t,e,i){if(Be(t,"3D Tile: boundingVolume must be defined"),t.box)return function(t,e,i){const n=new Dc(t[0],t[1],t[2]);e.transform(n,n);let r=[];if(10===t.length){const e=t.slice(3,6),i=new Eh;i.fromArray(t,6);const n=new Dc([1,0,0]),s=new Dc([0,1,0]),o=new Dc([0,0,1]);n.transformByQuaternion(i),n.scale(e[0]),s.transformByQuaternion(i),s.scale(e[1]),o.transformByQuaternion(i),o.scale(e[2]),r=[...n.toArray(),...s.toArray(),...o.toArray()]}else r=[...t.slice(3,6),...t.slice(6,9),...t.slice(9,12)];const s=e.transformAsVector(r.slice(0,3)),o=e.transformAsVector(r.slice(3,6)),a=e.transformAsVector(r.slice(6,9)),l=new jc([s[0],s[1],s[2],o[0],o[1],o[2],a[0],a[1],a[2]]);if(hF(i))return i.center=n,i.halfAxes=l,i;return new vR(n,l)}(t.box,e,i);if(t.region){const[e,i,n,r,s,o]=t.region,a=Fk.WGS84.cartographicToCartesian([ec(e),ec(r),s],pF),l=Fk.WGS84.cartographicToCartesian([ec(n),ec(i),o],fF),c=(new Dc).addVectors(a,l).multiplyScalar(.5),h=(new Dc).subVectors(a,l).len()/2;return _F([c[0],c[1],c[2],h],new lh)}if(t.sphere)return _F(t.sphere,e,i);throw new Error("3D Tile: boundingVolume must contain a sphere, region, or box")}function gF(t,e){if(t.box)return function(t){const e=yF(),{halfAxes:i}=t,n=new Dc(i.getColumn(0)),r=new Dc(i.getColumn(1)),s=new Dc(i.getColumn(2));for(let i=0;i<2;i++){for(let i=0;i<2;i++){for(let i=0;i<2;i++)uF.copy(t.center),uF.add(n),uF.add(r),uF.add(s),vF(e,uF),s.negate();r.negate()}n.negate()}return e}(e);if(t.region){const[e,i,n,r,s,o]=t.region;return[[ec(e),ec(i),s],[ec(n),ec(r),o]]}if(t.sphere)return function(t){const e=yF(),{center:i,radius:n}=t,r=Fk.WGS84.scaleToGeodeticSurface(i,uF);let s;s=r?Fk.WGS84.geodeticSurfaceNormal(r):new Dc(0,0,1);let o=new Dc(s[2],-s[1],0);o.len()>0?o.normalize():o=new Dc(0,1,0);const a=o.clone().cross(s);for(const t of[o,a,s]){dF.copy(t).scale(n);for(let t=0;t<2;t++)uF.copy(i),uF.add(dF),vF(e,uF),dF.negate()}return e}(e);throw new Error("Unkown boundingVolume type")}function _F(t,e,i){const n=new Dc(t[0],t[1],t[2]);e.transform(n,n);const r=e.getScale(dF),s=Math.max(Math.max(r[0],r[1]),r[2]),o=t[3]*s;return hF(i)?(i.center=n,i.radius=o,i):new iR(n,o)}function yF(){return[[1/0,1/0,1/0],[-1/0,-1/0,-1/0]]}function vF(t,e){Fk.WGS84.cartesianToCartographic(e,uF),t[0][0]=Math.min(t[0][0],uF[0]),t[0][1]=Math.min(t[0][1],uF[1]),t[0][2]=Math.min(t[0][2],uF[2]),t[1][0]=Math.max(t[1][0],uF[0]),t[1][1]=Math.max(t[1][1],uF[1]),t[1][2]=Math.max(t[1][2],uF[2])}function xF(t,e){if(t.dynamicScreenSpaceError&&t.dynamicScreenSpaceErrorComputedDensity){const i=t.dynamicScreenSpaceErrorFactor,n=function(t,e){const i=t*e;return 1-Math.exp(-i*i)}(e,t.dynamicScreenSpaceErrorComputedDensity)*i;return n}return 0}new Dc,new Dc,new lh,new Dc,new Dc,new Dc;const bF=new Dc,wF=new Dc,AF=new Dc,TF=new Dc,MF=new Dc,SF=new lh,EF=new lh;function CF(t,e){const{topDownViewport:i}=e,n=t.header.mbs[1],r=t.header.mbs[0],s=t.header.mbs[2],o=t.header.mbs[3],a=[...t.boundingVolume.center],l=i.unprojectPosition(i.cameraPosition);Fk.WGS84.cartographicToCartesian(l,bF),wF.copy(bF).subtract(a).normalize(),Fk.WGS84.eastNorthUpToFixedFrame(a,SF),EF.copy(SF).invert(),AF.copy(bF).transform(EF);const c=Math.sqrt(AF[0]*AF[0]+AF[1]*AF[1]);TF.copy([AF[0],AF[1],c*c/AF[2]]);const h=TF.transform(SF).subtract(a).normalize(),u=wF.cross(h).normalize().scale(o).add(a),d=Fk.WGS84.cartesianToCartographic(u),p=i.project([r,n,s]),f=i.project(d);return MF.copy(p).subtract(f).magnitude()}class IF{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;He(this,"_map",new Map),He(this,"_array",void 0),He(this,"_length",void 0),this._array=new Array(t),this._length=t}get length(){return this._length}set length(t){this._length=t,t>this._array.length&&(this._array.length=t)}get values(){return this._array}get(t){return Be(t<this._array.length),this._array[t]}set(t,e){Be(t>=0),t>=this.length&&(this.length=t+1),this._map.has(this._array[t])&&this._map.delete(this._array[t]),this._array[t]=e,this._map.set(e,t)}delete(t){const e=this._map.get(t);e>=0&&(this._array.splice(e,1),this._map.delete(t),this.length--)}peek(){return this._array[this._length-1]}push(t){if(!this._map.has(t)){const e=this.length++;this._array[e]=t,this._map.set(t,e)}}pop(){const t=this._array[--this.length];return this._map.delete(t),t}reserve(t){Be(t>=0),t>this._array.length&&(this._array.length=t)}resize(t){Be(t>=0),this.length=t}trim(t){null==t&&(t=this.length),this._array.length=t}reset(){this._array=[],this._map=new Map,this._length=0}find(t){return this._map.has(t)}}const PF={loadSiblings:!1,skipLevelOfDetail:!1,maximumScreenSpaceError:2,updateTransforms:!0,onTraversalEnd:()=>{},viewportTraversersMap:{},basePath:""};class LF{traversalFinished(t){return!0}constructor(t){He(this,"options",void 0),He(this,"root",null),He(this,"selectedTiles",{}),He(this,"requestedTiles",{}),He(this,"emptyTiles",{}),He(this,"lastUpdate",(new Date).getTime()),He(this,"updateDebounceTime",1e3),He(this,"_traversalStack",new IF),He(this,"_emptyTraversalStack",new IF),He(this,"_frameNumber",null),this.options={...PF,...t}}traverse(t,e,i){this.root=t,this.options={...this.options,...i},this.reset(),this.updateTile(t,e),this._frameNumber=e.frameNumber,this.executeTraversal(t,e)}reset(){this.requestedTiles={},this.selectedTiles={},this.emptyTiles={},this._traversalStack.reset(),this._emptyTraversalStack.reset()}executeTraversal(t,e){const i=this._traversalStack;for(t._selectionDepth=1,i.push(t);i.length>0;){const t=i.pop();let n=!1;this.canTraverse(t,e)&&(this.updateChildTiles(t,e),n=this.updateAndPushChildren(t,e,i,t.hasRenderContent?t._selectionDepth+1:t._selectionDepth));const r=t.parent,s=Boolean(!r||r._shouldRefine),o=!n;t.hasRenderContent?t.refine===sF.ADD?(this.loadTile(t,e),this.selectTile(t,e)):t.refine===sF.REPLACE&&(this.loadTile(t,e),o&&this.selectTile(t,e)):(this.emptyTiles[t.id]=t,this.loadTile(t,e),o&&this.selectTile(t,e)),this.touchTile(t,e),t._shouldRefine=n&&s}const n=(new Date).getTime();(this.traversalFinished(e)||n-this.lastUpdate>this.updateDebounceTime)&&(this.lastUpdate=n,this.options.onTraversalEnd(e))}updateChildTiles(t,e){const i=t.children;for(const t of i)this.updateTile(t,e)}updateAndPushChildren(t,e,i,n){const{loadSiblings:r,skipLevelOfDetail:s}=this.options,o=t.children;o.sort(this.compareDistanceToCamera.bind(this));const a=t.refine===sF.REPLACE&&t.hasRenderContent&&!s;let l=!1,c=!0;for(const t of o)if(t._selectionDepth=n,t.isVisibleAndInRequestVolume?(i.find(t)&&i.delete(t),i.push(t),l=!0):(a||r)&&(this.loadTile(t,e),this.touchTile(t,e)),a){let i;if(i=!!t._inRequestVolume&&(t.hasRenderContent?t.contentAvailable:this.executeEmptyTraversal(t,e)),c=c&&i,!c)return!1}return l||(c=!1),c}updateTile(t,e){this.updateTileVisibility(t,e)}selectTile(t,e){this.shouldSelectTile(t)&&(t._selectedFrame=e.frameNumber,this.selectedTiles[t.id]=t)}loadTile(t,e){this.shouldLoadTile(t)&&(t._requestedFrame=e.frameNumber,t._priority=t._getPriority(),this.requestedTiles[t.id]=t)}touchTile(t,e){t.tileset._cache.touch(t),t._touchedFrame=e.frameNumber}canTraverse(t,e){return!!t.hasChildren&&(t.hasTilesetContent?!t.contentExpired:!(!(arguments.length>3&&void 0!==arguments[3]&&arguments[3])&&!t.isVisibleAndInRequestVolume)&&this.shouldRefine(t,e,arguments.length>2&&void 0!==arguments[2]&&arguments[2]))}shouldLoadTile(t){return t.hasUnloadedContent||t.contentExpired}shouldSelectTile(t){return t.contentAvailable&&!this.options.skipLevelOfDetail}shouldRefine(t,e){let i=t._screenSpaceError;return arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&(i=t.getScreenSpaceError(e,!0)),i>this.options.maximumScreenSpaceError}updateTileVisibility(t,e){const i=[];if(this.options.viewportTraversersMap)for(const t in this.options.viewportTraversersMap){this.options.viewportTraversersMap[t]===e.viewport.id&&i.push(t)}else i.push(e.viewport.id);t.updateVisibility(e,i)}compareDistanceToCamera(t,e){return t._distanceToCamera-e._distanceToCamera}anyChildrenVisible(t,e){let i=!1;for(const n of t.children)n.updateVisibility(e),i=i||n.isVisibleAndInRequestVolume;return i}executeEmptyTraversal(t,e){let i=!0;const n=this._emptyTraversalStack;for(n.push(t);n.length>0&&i;){const t=n.pop();this.updateTile(t,e),t.isVisibleAndInRequestVolume||this.loadTile(t,e),this.touchTile(t,e);if(!t.hasRenderContent&&this.canTraverse(t,e,!1,!0)){const e=t.children;for(const t of e)n.find(t)&&n.delete(t),n.push(t)}else t.contentAvailable||t.hasEmptyContent||(i=!1)}return i}}const RF=new Dc;class BF{constructor(t,e,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";He(this,"tileset",void 0),He(this,"header",void 0),He(this,"id",void 0),He(this,"url",void 0),He(this,"parent",void 0),He(this,"refine",void 0),He(this,"type",void 0),He(this,"contentUrl",void 0),He(this,"lodMetricType","geometricError"),He(this,"lodMetricValue",0),He(this,"boundingVolume",null),He(this,"content",null),He(this,"contentState",tF),He(this,"gpuMemoryUsageInBytes",0),He(this,"children",[]),He(this,"depth",0),He(this,"viewportIds",[]),He(this,"transform",new lh),He(this,"extensions",null),He(this,"implicitTiling",null),He(this,"userData",{}),He(this,"computedTransform",void 0),He(this,"hasEmptyContent",!1),He(this,"hasTilesetContent",!1),He(this,"traverser",new LF({})),He(this,"_cacheNode",null),He(this,"_frameNumber",null),He(this,"_expireDate",null),He(this,"_expiredContent",null),He(this,"_boundingBox",void 0),He(this,"_distanceToCamera",0),He(this,"_screenSpaceError",0),He(this,"_visibilityPlaneMask",void 0),He(this,"_visible",void 0),He(this,"_contentBoundingVolume",void 0),He(this,"_viewerRequestVolume",void 0),He(this,"_initialTransform",new lh),He(this,"_priority",0),He(this,"_selectedFrame",0),He(this,"_requestedFrame",0),He(this,"_selectionDepth",0),He(this,"_touchedFrame",0),He(this,"_centerZDepth",0),He(this,"_shouldRefine",!1),He(this,"_stackLength",0),He(this,"_visitedFrame",0),He(this,"_inRequestVolume",!1),He(this,"_lodJudge",null),this.header=e,this.tileset=t,this.id=n||e.id,this.url=e.url,this.parent=i,this.refine=this._getRefine(e.refine),this.type=e.type,this.contentUrl=e.contentUrl,this._initializeLodMetric(e),this._initializeTransforms(e),this._initializeBoundingVolumes(e),this._initializeContent(e),this._initializeRenderingState(e),Object.seal(this)}destroy(){this.header=null}isDestroyed(){return null===this.header}get selected(){return this._selectedFrame===this.tileset._frameNumber}get isVisible(){return this._visible}get isVisibleAndInRequestVolume(){return this._visible&&this._inRequestVolume}get hasRenderContent(){return!this.hasEmptyContent&&!this.hasTilesetContent}get hasChildren(){return this.children.length>0||this.header.children&&this.header.children.length>0}get contentReady(){return this.contentState===iF||this.hasEmptyContent}get contentAvailable(){return Boolean(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}get hasUnloadedContent(){return this.hasRenderContent&&this.contentUnloaded}get contentUnloaded(){return this.contentState===tF}get contentExpired(){return this.contentState===nF}get contentFailed(){return this.contentState===rF}get distanceToCamera(){return this._distanceToCamera}get screenSpaceError(){return this._screenSpaceError}get boundingBox(){return this._boundingBox||(this._boundingBox=gF(this.header.boundingVolume,this.boundingVolume)),this._boundingBox}getScreenSpaceError(t,e){switch(this.tileset.type){case aF.I3S:return CF(this,t);case aF.TILES3D:return function(t,e,i){const n=t.tileset,r=i&&t.parent&&t.parent.lodMetricValue||t.lodMetricValue;if(0===r)return 0;const s=Math.max(t._distanceToCamera,1e-7),{height:o,sseDenominator:a}=e,{viewDistanceScale:l}=n.options;let c=r*o*(l||1)/(s*a);return c-=xF(n,s),c}(this,t,e);default:throw new Error("Unsupported tileset type")}}unselect(){this._selectedFrame=0}_getGpuMemoryUsageInBytes(){return this.content.gpuMemoryUsageInBytes||this.content.byteLength||0}_getPriority(){const t=this.tileset._traverser,{skipLevelOfDetail:e}=t.options,i=this.refine===sF.ADD||e;if(i&&!this.isVisible&&void 0!==this._visible)return-1;if(this.tileset._frameNumber-this._touchedFrame>=1)return-1;if(this.contentState===tF)return-1;const n=this.parent;return Math.max((t.root?t.root._screenSpaceError:0)-(n&&(!i||0===this._screenSpaceError||n.hasTilesetContent)?n._screenSpaceError:this._screenSpaceError),0)}async loadContent(){if(this.hasEmptyContent)return!1;if(this.content)return!0;this.contentExpired&&(this._expireDate=null),this.contentState=eF;const t=await this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority.bind(this));if(!t)return this.contentState=tF,!1;try{const t=this.tileset.getTileUrl(this.contentUrl),e=this.tileset.loader,i={...this.tileset.loadOptions,[e.id]:{...this.tileset.loadOptions[e.id],isTileset:"json"===this.type,...this._getLoaderSpecificOptions(e.id)}};return this.content=await Wn(t,e,i),this.tileset.options.contentLoader&&await this.tileset.options.contentLoader(this),this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this),this.contentState=iF,this._onContentLoaded(),!0}catch(t){throw this.contentState=rF,t}finally{t.done()}}unloadContent(){return this.content&&this.content.destroy&&this.content.destroy(),this.content=null,this.header.content&&this.header.content.destroy&&this.header.content.destroy(),this.header.content=null,this.contentState=tF,!0}updateVisibility(t,e){if(this._frameNumber===t.frameNumber)return;const i=this.parent,n=i?i._visibilityPlaneMask:SR.MASK_INDETERMINATE;if(this.tileset._traverser.options.updateTransforms){this._updateTransform(i?i.computedTransform:this.tileset.modelMatrix)}this._distanceToCamera=this.distanceToTile(t),this._screenSpaceError=this.getScreenSpaceError(t,!1),this._visibilityPlaneMask=this.visibility(t,n),this._visible=this._visibilityPlaneMask!==SR.MASK_OUTSIDE,this._inRequestVolume=this.insideViewerRequestVolume(t),this._frameNumber=t.frameNumber,this.viewportIds=e}visibility(t,e){const{cullingVolume:i}=t,{boundingVolume:n}=this;return i.computeVisibilityWithPlaneMask(n,e)}contentVisibility(){return!0}distanceToTile(t){return Math.sqrt(Math.max(this.boundingVolume.distanceSquaredTo(t.camera.position),0))}cameraSpaceZDepth(t){let{camera:e}=t;return RF.subVectors(this.boundingVolume.center,e.position),e.direction.dot(RF)}insideViewerRequestVolume(t){const e=this._viewerRequestVolume;return!e||e.distanceSquaredTo(t.camera.position)<=0}updateExpiration(){if(function(t){return null!=t}(this._expireDate)&&this.contentReady&&!this.hasEmptyContent){const t=Date.now();Date.lessThan(this._expireDate,t)&&(this.contentState=nF,this._expiredContent=this.content)}}get extras(){return this.header.extras}_initializeLodMetric(t){this.lodMetricType="lodMetricType"in t?t.lodMetricType:this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,this.lodMetricValue="lodMetricValue"in t?t.lodMetricValue:this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue}_initializeTransforms(t){this.transform=t.transform?new lh(t.transform):new lh;const e=this.parent,i=this.tileset,n=e&&e.computedTransform?e.computedTransform.clone():i.modelMatrix.clone();this.computedTransform=new lh(n).multiplyRight(this.transform);const r=e&&e._initialTransform?e._initialTransform.clone():new lh;this._initialTransform=new lh(r).multiplyRight(this.transform)}_initializeBoundingVolumes(t){this._contentBoundingVolume=null,this._viewerRequestVolume=null,this._updateBoundingVolume(t)}_initializeContent(t){this.content={_tileset:this.tileset,_tile:this},this.hasEmptyContent=!0,this.contentState=tF,this.hasTilesetContent=!1,t.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}_initializeRenderingState(t){this.depth=t.level||(this.parent?this.parent.depth+1:0),this._shouldRefine=!1,this._distanceToCamera=0,this._centerZDepth=0,this._screenSpaceError=0,this._visibilityPlaneMask=SR.MASK_INDETERMINATE,this._visible=void 0,this._inRequestVolume=!1,this._stackLength=0,this._selectionDepth=0,this._frameNumber=0,this._touchedFrame=0,this._visitedFrame=0,this._selectedFrame=0,this._requestedFrame=0,this._priority=0}_getRefine(t){return t||this.parent&&this.parent.refine||sF.REPLACE}_isTileset(){return-1!==this.contentUrl.indexOf(".json")}_onContentLoaded(){switch(this.content&&this.content.type){case"vctr":case"geom":this.tileset._traverser.disableSkipLevelOfDetail=!0}this._isTileset()?this.hasTilesetContent=!0:this.gpuMemoryUsageInBytes=this._getGpuMemoryUsageInBytes()}_updateBoundingVolume(t){this.boundingVolume=mF(t.boundingVolume,this.computedTransform,this.boundingVolume);const e=t.content;e&&(e.boundingVolume&&(this._contentBoundingVolume=mF(e.boundingVolume,this.computedTransform,this._contentBoundingVolume)),t.viewerRequestVolume&&(this._viewerRequestVolume=mF(t.viewerRequestVolume,this.computedTransform,this._viewerRequestVolume)))}_updateTransform(){const t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new lh).clone().multiplyRight(this.transform);!t.equals(this.computedTransform)&&(this.computedTransform=t,this._updateBoundingVolume(this.header))}_getLoaderSpecificOptions(t){return"i3s"===t?{...this.tileset.options.i3s,_tileOptions:{attributeUrls:this.header.attributeUrls,textureUrl:this.header.textureUrl,textureFormat:this.header.textureFormat,textureLoaderOptions:this.header.textureLoaderOptions,materialDefinition:this.header.materialDefinition,isDracoGeometry:this.header.isDracoGeometry,mbs:this.header.mbs},_tilesetOptions:{store:this.tileset.tileset.store,attributeStorageInfo:this.tileset.tileset.attributeStorageInfo,fields:this.tileset.tileset.fields},isTileHeader:!1}:{assetGltfUpAxis:(e=this.tileset.tileset).asset&&e.asset.gltfUpAxis||"Y"};var e}}class DF extends LF{compareDistanceToCamera(t,e){return 0===e._distanceToCamera&&0===t._distanceToCamera?e._centerZDepth-t._centerZDepth:e._distanceToCamera-t._distanceToCamera}updateTileVisibility(t,e){if(super.updateTileVisibility(t,e),!t.isVisibleAndInRequestVolume)return;const i=t.children.length>0;if(t.hasTilesetContent&&i){const i=t.children[0];return this.updateTileVisibility(i,e),void(t._visible=i._visible)}if(this.meetsScreenSpaceErrorEarly(t,e))return void(t._visible=!1);t.refine===sF.REPLACE&&t._optimChildrenWithinParent===cF&&i&&!this.anyChildrenVisible(t,e)&&(t._visible=!1)}meetsScreenSpaceErrorEarly(t,e){const{parent:i}=t;return!(!i||i.hasTilesetContent||i.refine!==sF.ADD)&&!this.shouldRefine(t,e,!0)}}class OF{constructor(){He(this,"frameNumberMap",new Map)}register(t,e){const i=this.frameNumberMap.get(t)||new Map,n=i.get(e)||0;i.set(e,n+1),this.frameNumberMap.set(t,i)}deregister(t,e){const i=this.frameNumberMap.get(t);if(!i)return;const n=i.get(e)||1;i.set(e,n-1)}isZero(t,e){var i;return 0===((null===(i=this.frameNumberMap.get(t))||void 0===i?void 0:i.get(e))||0)}}const kF="REQUESTED",FF="COMPLETED",zF="ERROR";class NF{constructor(){He(this,"_statusMap",void 0),He(this,"pendingTilesRegister",new OF),this._statusMap={}}add(t,e,i,n){if(!this._statusMap[e]){const{frameNumber:r,viewport:{id:s}}=n;this._statusMap[e]={request:t,callback:i,key:e,frameState:n,status:kF},this.pendingTilesRegister.register(s,r),t().then((t=>{this._statusMap[e].status=FF;const{frameNumber:i,viewport:{id:r}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(r,i),this._statusMap[e].callback(t,n)})).catch((t=>{this._statusMap[e].status=zF;const{frameNumber:n,viewport:{id:r}}=this._statusMap[e].frameState;this.pendingTilesRegister.deregister(r,n),i(t)}))}}update(t,e){if(this._statusMap[t]){const{frameNumber:i,viewport:{id:n}}=this._statusMap[t].frameState;this.pendingTilesRegister.deregister(n,i);const{frameNumber:r,viewport:{id:s}}=e;this.pendingTilesRegister.register(s,r),this._statusMap[t].frameState=e}}find(t){return this._statusMap[t]}hasPendingTiles(t,e){return!this.pendingTilesRegister.isZero(t,e)}}class UF extends LF{constructor(t){super(t),He(this,"_tileManager",void 0),this._tileManager=new NF}traversalFinished(t){return!this._tileManager.hasPendingTiles(t.viewport.id,this._frameNumber||0)}shouldRefine(t,e){return t._lodJudge=function(t,e){if(0===t.lodMetricValue||isNaN(t.lodMetricValue))return"DIG";const i=2*CF(t,e);return i<2?"OUT":!t.header.children||i<=t.lodMetricValue?"DRAW":t.header.children?"DIG":"OUT"}(t,e),"DIG"===t._lodJudge}updateChildTiles(t,e){const i=t.header.children||[],n=t.children,r=t.tileset;for(const s of i){const i="".concat(s.id,"-").concat(e.viewport.id),o=n&&n.find((t=>t.id===i));if(o)o&&this.updateTile(o,e);else{let n=()=>this._loadTile(s.id,r);this._tileManager.find(i)?this._tileManager.update(i,e):(r.tileset.nodePages&&(n=()=>r.tileset.nodePagesTile.formTileFromNodePages(s.id)),this._tileManager.add(n,i,(e=>this._onTileLoad(e,t,i)),e))}}return!1}async _loadTile(t,e){const{loader:i}=e,n=e.getTileUrl("".concat(e.url,"/nodes/").concat(t)),r={...e.loadOptions,i3s:{...e.loadOptions.i3s,isTileHeader:!0}};return await Wn(n,i,r)}_onTileLoad(t,e,i){const n=new BF(e.tileset,t,e,i);e.children.push(n);const r=this._tileManager.find(n.id).frameState;this.updateTile(n,r),this._frameNumber===r.frameNumber&&(this.traversalFinished(r)||(new Date).getTime()-this.lastUpdate>this.updateDebounceTime)&&this.executeTraversal(n,r)}}const GF={description:"",ellipsoid:Fk.WGS84,modelMatrix:new lh,throttleRequests:!0,maxRequests:64,maximumMemoryUsage:32,maximumTilesSelected:0,debounceTime:0,onTileLoad:()=>{},onTileUnload:()=>{},onTileError:()=>{},onTraversalComplete:t=>t,contentLoader:void 0,viewDistanceScale:1,maximumScreenSpaceError:8,loadTiles:!0,updateTransforms:!0,viewportTraversersMap:null,loadOptions:{fetch:{}},attributions:[],basePath:"",i3s:{}},VF="Tiles In Tileset(s)",jF="Tiles In Memory",HF="Tiles In View",WF="Tiles To Render",qF="Tiles Loaded",XF="Tiles Loading",ZF="Tiles Unloaded",JF="Failed Tile Loads",YF="Points/Vertices",$F="Tile Memory Use";class KF{constructor(t,e){He(this,"options",void 0),He(this,"loadOptions",void 0),He(this,"type",void 0),He(this,"tileset",void 0),He(this,"loader",void 0),He(this,"url",void 0),He(this,"basePath",void 0),He(this,"modelMatrix",void 0),He(this,"ellipsoid",void 0),He(this,"lodMetricType",void 0),He(this,"lodMetricValue",void 0),He(this,"refine",void 0),He(this,"root",null),He(this,"roots",{}),He(this,"asset",{}),He(this,"description",""),He(this,"properties",void 0),He(this,"extras",null),He(this,"attributions",{}),He(this,"credits",{}),He(this,"stats",void 0),He(this,"contentFormats",{draco:!1,meshopt:!1,dds:!1,ktx2:!1}),He(this,"cartographicCenter",null),He(this,"cartesianCenter",null),He(this,"zoom",1),He(this,"boundingVolume",null),He(this,"dynamicScreenSpaceErrorComputedDensity",0),He(this,"maximumMemoryUsage",32),He(this,"gpuMemoryUsageInBytes",0),He(this,"_frameNumber",0),He(this,"_queryParams",{}),He(this,"_extensionsUsed",[]),He(this,"_tiles",{}),He(this,"_pendingCount",0),He(this,"selectedTiles",[]),He(this,"traverseCounter",0),He(this,"geometricError",0),He(this,"lastUpdatedVieports",null),He(this,"_requestedTiles",[]),He(this,"_emptyTiles",[]),He(this,"frameStateData",{}),He(this,"_traverser",void 0),He(this,"_cache",new jk),He(this,"_requestScheduler",void 0),He(this,"updatePromise",null),He(this,"tilesetInitializationPromise",void 0),this.options={...GF,...e},this.tileset=t,this.loader=t.loader,this.type=t.type,this.url=t.url,this.basePath=t.basePath||Ei(this.url),this.modelMatrix=this.options.modelMatrix,this.ellipsoid=this.options.ellipsoid,this.lodMetricType=t.lodMetricType,this.lodMetricValue=t.lodMetricValue,this.refine=t.root.refine,this.loadOptions=this.options.loadOptions||{},this._traverser=this._initializeTraverser(),this._requestScheduler=new wi({throttleRequests:this.options.throttleRequests,maxRequests:this.options.maxRequests}),this.stats=new Uk({id:this.url}),this._initializeStats(),this.tilesetInitializationPromise=this._initializeTileSet(t)}destroy(){this._destroy()}isLoaded(){return 0===this._pendingCount&&0!==this._frameNumber&&0===this._requestedTiles.length}get tiles(){return Object.values(this._tiles)}get frameNumber(){return this._frameNumber}get queryParams(){return new URLSearchParams(this._queryParams).toString()}setProps(t){this.options={...this.options,...t}}setOptions(t){this.options={...this.options,...t}}getTileUrl(t){return t.startsWith("data:")?t:"".concat(t).concat(t.includes("?")?"&":"?").concat(this.queryParams)}hasExtension(t){return Boolean(this._extensionsUsed.indexOf(t)>-1)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.tilesetInitializationPromise.then((()=>{!t&&this.lastUpdatedVieports?t=this.lastUpdatedVieports:this.lastUpdatedVieports=t,t&&this.doUpdate(t)}))}async selectTiles(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return await this.tilesetInitializationPromise,t&&(this.lastUpdatedVieports=t),this.updatePromise||(this.updatePromise=new Promise((t=>{setTimeout((()=>{this.lastUpdatedVieports&&this.doUpdate(this.lastUpdatedVieports),t(this._frameNumber),this.updatePromise=null}),this.options.debounceTime)}))),this.updatePromise}doUpdate(t){if("loadTiles"in this.options&&!this.options.loadTiles)return;if(this.traverseCounter>0)return;const e=t instanceof Array?t:[t];this._cache.reset(),this._frameNumber++,this.traverseCounter=e.length;const i=[];for(const t of e){const e=t.id;this._needTraverse(e)?i.push(e):this.traverseCounter--}for(const t of e){const e=t.id;if(this.roots[e]||(this.roots[e]=this._initializeTileHeaders(this.tileset,null)),!i.includes(e))continue;const n=Xk(t,this._frameNumber);this._traverser.traverse(this.roots[e],n,this.options)}}_needTraverse(t){let e=t;return this.options.viewportTraversersMap&&(e=this.options.viewportTraversersMap[t]),e===t}_onTraversalEnd(t){const e=t.viewport.id;this.frameStateData[e]||(this.frameStateData[e]={selectedTiles:[],_requestedTiles:[],_emptyTiles:[]});const i=this.frameStateData[e],n=Object.values(this._traverser.selectedTiles),[r,s]=function(t,e,i){if(0===i||t.length<=i)return[t,[]];const n=[],{longitude:r,latitude:s}=e.viewport;for(const[e,i]of t.entries()){const[t,o]=i.header.mbs,a=Math.abs(r-t),l=Math.abs(s-o),c=Math.sqrt(l*l+a*a);n.push([e,c])}const o=n.sort(((t,e)=>t[1]-e[1])),a=[];for(let e=0;e<i;e++)a.push(t[o[e][0]]);const l=[];for(let e=i;e<o.length;e++)l.push(t[o[e][0]]);return[a,l]}(n,t,this.options.maximumTilesSelected);i.selectedTiles=r;for(const t of s)t.unselect();i._requestedTiles=Object.values(this._traverser.requestedTiles),i._emptyTiles=Object.values(this._traverser.emptyTiles),this.traverseCounter--,this.traverseCounter>0||this._updateTiles()}_updateTiles(){this.selectedTiles=[],this._requestedTiles=[],this._emptyTiles=[];for(const t in this.frameStateData){const e=this.frameStateData[t];this.selectedTiles=this.selectedTiles.concat(e.selectedTiles),this._requestedTiles=this._requestedTiles.concat(e._requestedTiles),this._emptyTiles=this._emptyTiles.concat(e._emptyTiles)}this.selectedTiles=this.options.onTraversalComplete(this.selectedTiles);for(const t of this.selectedTiles)this._tiles[t.id]=t;this._loadTiles(),this._unloadTiles(),this._updateStats()}_tilesChanged(t,e){if(t.length!==e.length)return!0;const i=new Set(t.map((t=>t.id))),n=new Set(e.map((t=>t.id)));let r=t.filter((t=>!n.has(t.id))).length>0;return r=r||e.filter((t=>!i.has(t.id))).length>0,r}_loadTiles(){for(const t of this._requestedTiles)t.contentUnloaded&&this._loadTile(t)}_unloadTiles(){this._cache.unloadTiles(this,((t,e)=>t._unloadTile(e)))}_updateStats(){let t=0,e=0;for(const i of this.selectedTiles)i.contentAvailable&&i.content&&(t++,e+=i.content.pointCount?i.content.pointCount:i.content.vertexCount);this.stats.get(HF).count=this.selectedTiles.length,this.stats.get(WF).count=t,this.stats.get(YF).count=e}async _initializeTileSet(t){this.type===aF.I3S&&(this.calculateViewPropsI3S(),t.root=await t.root),this.root=this._initializeTileHeaders(t,null),this.type===aF.TILES3D&&(this._initializeTiles3DTileset(t),this.calculateViewPropsTiles3D()),this.type===aF.I3S&&this._initializeI3STileset()}calculateViewPropsI3S(){var t;const e=this.tileset.fullExtent;if(e){const{xmin:t,xmax:i,ymin:n,ymax:r,zmin:s,zmax:o}=e;return this.cartographicCenter=new Dc(t+(i-t)/2,n+(r-n)/2,s+(o-s)/2),this.cartesianCenter=Fk.WGS84.cartographicToCartesian(this.cartographicCenter,new Dc),void(this.zoom=Qk(e,this.cartographicCenter,this.cartesianCenter))}const i=null===(t=this.tileset.store)||void 0===t?void 0:t.extent;if(i){const[t,e,n,r]=i;return this.cartographicCenter=new Dc(t+(n-t)/2,e+(r-e)/2,0),this.cartesianCenter=Fk.WGS84.cartographicToCartesian(this.cartographicCenter,new Dc),void(this.zoom=function(t,e,i){const[n,r,s,o]=t;return Qk({xmin:n,xmax:s,ymin:r,ymax:o,zmin:0,zmax:0},e,i)}(i,this.cartographicCenter,this.cartesianCenter))}this.cartographicCenter=new Dc,this.zoom=1}calculateViewPropsTiles3D(){const t=this.root,{center:e}=t.boundingVolume;if(!e)return this.cartographicCenter=new Dc,void(this.zoom=1);this.cartographicCenter=0!==e[0]||0!==e[1]||0!==e[2]?Fk.WGS84.cartesianToCartographic(e,new Dc):new Dc(0,0,-Fk.WGS84.radii[0]),this.cartesianCenter=e,this.zoom=Kk(t.boundingVolume,this.cartographicCenter)}_initializeStats(){this.stats.get(VF),this.stats.get(XF),this.stats.get(jF),this.stats.get(HF),this.stats.get(WF),this.stats.get(qF),this.stats.get(ZF),this.stats.get(JF),this.stats.get(YF),this.stats.get($F,"memory")}_initializeTileHeaders(t,e){const i=new BF(this,t.root,e);if(e&&(e.children.push(i),i.depth=e.depth+1),this.type===aF.TILES3D){const t=[];for(t.push(i);t.length>0;){const e=t.pop();this.stats.get(VF).incrementCount();const i=e.header.children||[];for(const r of i){var n;const i=new BF(this,r,e);if(null!==(n=i.contentUrl)&&void 0!==n&&n.includes("?session=")){const t=new URL(i.contentUrl).searchParams.get("session");t&&(this._queryParams.session=t)}e.children.push(i),i.depth=e.depth+1,t.push(i)}}}return i}_initializeTraverser(){let t;switch(this.type){case aF.TILES3D:t=DF;break;case aF.I3S:t=UF;break;default:t=LF}return new t({basePath:this.basePath,onTraversalEnd:this._onTraversalEnd.bind(this)})}_destroyTileHeaders(t){this._destroySubtree(t)}async _loadTile(t){let e;try{this._onStartTileLoading(),e=await t.loadContent()}catch(e){this._onTileLoadError(t,e instanceof Error?e:new Error("load failed"))}finally{this._onEndTileLoading(),this._onTileLoad(t,e)}}_onTileLoadError(t,e){this.stats.get(JF).incrementCount();const i=e.message||e.toString();this.options.onTileError(t,i,t.url)}_onTileLoad(t,e){if(e){if(this.type===aF.I3S){var i,n;const t=(null===(i=this.tileset)||void 0===i||null===(n=i.nodePagesTile)||void 0===n?void 0:n.nodesInNodePages)||0;this.stats.get(VF).reset(),this.stats.get(VF).addCount(t)}t&&t.content&&function(t,e){Be(t),Be(e);const{rtcCenter:i,gltfUpAxis:n}=e,{computedTransform:r,boundingVolume:{center:s}}=t;let o=new lh(r);switch(i&&o.translate(i),n){case"Z":break;case"Y":const t=(new lh).rotateX(Math.PI/2);o=o.multiplyRight(t);break;case"X":const e=(new lh).rotateY(-Math.PI/2);o=o.multiplyRight(e)}e.isQuantized&&o.translate(e.quantizedVolumeOffset).scale(e.quantizedVolumeScale);const a=new Dc(s);e.cartesianModelMatrix=o,e.cartesianOrigin=a;const l=Fk.WGS84.cartesianToCartographic(a,new Dc),c=Fk.WGS84.eastNorthUpToFixedFrame(a).invert();e.cartographicModelMatrix=c.multiplyRight(o),e.cartographicOrigin=l,e.coordinateSystem||(e.modelMatrix=e.cartographicModelMatrix)}(t,t.content),this.updateContentTypes(t),this._addTileToCache(t),this.options.onTileLoad(t)}}updateContentTypes(t){if(this.type===aF.I3S)switch(t.header.isDracoGeometry&&(this.contentFormats.draco=!0),t.header.textureFormat){case"dds":this.contentFormats.dds=!0;break;case"ktx2":this.contentFormats.ktx2=!0}else if(this.type===aF.TILES3D){var e;const{extensionsRemoved:i=[]}=(null===(e=t.content)||void 0===e?void 0:e.gltf)||{};i.includes("KHR_draco_mesh_compression")&&(this.contentFormats.draco=!0),i.includes("EXT_meshopt_compression")&&(this.contentFormats.meshopt=!0),i.includes("KHR_texture_basisu")&&(this.contentFormats.ktx2=!0)}}_onStartTileLoading(){this._pendingCount++,this.stats.get(XF).incrementCount()}_onEndTileLoading(){this._pendingCount--,this.stats.get(XF).decrementCount()}_addTileToCache(t){this._cache.add(this,t,(e=>e._updateCacheStats(t)))}_updateCacheStats(t){this.stats.get(qF).incrementCount(),this.stats.get(jF).incrementCount(),this.gpuMemoryUsageInBytes+=t.gpuMemoryUsageInBytes||0,this.stats.get($F).count=this.gpuMemoryUsageInBytes}_unloadTile(t){this.gpuMemoryUsageInBytes-=t.gpuMemoryUsageInBytes||0,this.stats.get(jF).decrementCount(),this.stats.get(ZF).incrementCount(),this.stats.get($F).count=this.gpuMemoryUsageInBytes,this.options.onTileUnload(t),t.unloadContent()}_destroy(){const t=[];for(this.root&&t.push(this.root);t.length>0;){const e=t.pop();for(const i of e.children)t.push(i);this._destroyTile(e)}this.root=null}_destroySubtree(t){const e=t,i=[];for(i.push(e);i.length>0;){t=i.pop();for(const e of t.children)i.push(e);t!==e&&this._destroyTile(t)}e.children=[]}_destroyTile(t){this._cache.unloadTile(this,t),this._unloadTile(t),t.destroy()}_initializeTiles3DTileset(t){if(t.queryString){const e=new URLSearchParams(t.queryString),i=Object.fromEntries(e.entries());this._queryParams={...this._queryParams,...i}}if(this.asset=t.asset,!this.asset)throw new Error("Tileset must have an asset property.");if("0.0"!==this.asset.version&&"1.0"!==this.asset.version)throw new Error("The tileset must be 3D Tiles version 0.0 or 1.0.");"tilesetVersion"in this.asset&&(this._queryParams.v=this.asset.tilesetVersion),this.credits={attributions:this.options.attributions||[]},this.description=this.options.description||"",this.properties=t.properties,this.geometricError=t.geometricError,this._extensionsUsed=t.extensionsUsed||[],this.extras=t.extras}_initializeI3STileset(){this.loadOptions.i3s&&"token"in this.loadOptions.i3s&&(this._queryParams.token=this.loadOptions.i3s.token)}}const QF="3.4.14",tz={COMPOSITE:"cmpt",POINT_CLOUD:"pnts",BATCHED_3D_MODEL:"b3dm",INSTANCED_3D_MODEL:"i3dm",GEOMETRY:"geom",VECTOR:"vect",GLTF:"glTF"};function ez(t,e,i){Be(t instanceof ArrayBuffer);const n=new TextDecoder("utf8"),r=new Uint8Array(t,e,i);return n.decode(r)}const iz={BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DOUBLE:5130},nz={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,...iz},rz={[iz.DOUBLE]:Float64Array,[iz.FLOAT]:Float32Array,[iz.UNSIGNED_SHORT]:Uint16Array,[iz.UNSIGNED_INT]:Uint32Array,[iz.UNSIGNED_BYTE]:Uint8Array,[iz.BYTE]:Int8Array,[iz.SHORT]:Int16Array,[iz.INT]:Int32Array},sz={DOUBLE:iz.DOUBLE,FLOAT:iz.FLOAT,UNSIGNED_SHORT:iz.UNSIGNED_SHORT,UNSIGNED_INT:iz.UNSIGNED_INT,UNSIGNED_BYTE:iz.UNSIGNED_BYTE,BYTE:iz.BYTE,SHORT:iz.SHORT,INT:iz.INT},oz="Failed to convert GL type";class az{static fromTypedArray(t){t=ArrayBuffer.isView(t)?t.constructor:t;for(const e in rz){if(rz[e]===t)return e}throw new Error(oz)}static fromName(t){const e=sz[t];if(!e)throw new Error(oz);return e}static getArrayType(t){switch(t){case iz.UNSIGNED_SHORT_5_6_5:case iz.UNSIGNED_SHORT_4_4_4_4:case iz.UNSIGNED_SHORT_5_5_5_1:return Uint16Array;default:const e=rz[t];if(!e)throw new Error(oz);return e}}static getByteSize(t){return az.getArrayType(t).BYTES_PER_ELEMENT}static validate(t){return Boolean(az.getArrayType(t))}static createTypedArray(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0;void 0===n&&(n=(e.byteLength-i)/az.getByteSize(t));return new(az.getArrayType(t))(e,i,n)}}function lz(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0,0];const i=t>>5&63,n=31&t;return e[0]=(t>>11&31)<<3,e[1]=i<<2,e[2]=n<<3,e}function cz(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255;return ic(t,0,e)/e*2-1}function hz(t){return t<0?-1:1}function uz(t,e,i,n){if(function(t,e){if(!t)throw new Error("math.gl assertion failed. ".concat(e))}(n),t<0||t>i||e<0||e>i)throw new Error("x and y must be unsigned normalized integers between 0 and ".concat(i));if(n.x=cz(t,i),n.y=cz(e,i),n.z=1-(Math.abs(n.x)+Math.abs(n.y)),n.z<0){const t=n.x;n.x=(1-Math.abs(n.y))*hz(t),n.y=(1-Math.abs(t))*hz(n.y)}return n.normalize()}function dz(t,e,i){return uz(t,e,255,i)}new xc,new Dc,new xc,new xc;class pz{constructor(t,e){He(this,"json",void 0),He(this,"buffer",void 0),He(this,"featuresLength",0),He(this,"_cachedTypedArrays",{}),this.json=t,this.buffer=e}getExtension(t){return this.json.extensions&&this.json.extensions[t]}hasProperty(t){return Boolean(this.json[t])}getGlobalProperty(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:nz.UNSIGNED_INT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const n=this.json[t];return n&&Number.isFinite(n.byteOffset)?this._getTypedArrayFromBinary(t,e,i,1,n.byteOffset):n}getPropertyArray(t,e,i){const n=this.json[t];return n&&Number.isFinite(n.byteOffset)?("componentType"in n&&(e=az.fromName(n.componentType)),this._getTypedArrayFromBinary(t,e,i,this.featuresLength,n.byteOffset)):this._getTypedArrayFromArray(t,e,n)}getProperty(t,e,i,n,r){const s=this.json[t];if(!s)return s;const o=this.getPropertyArray(t,e,i);if(1===i)return o[n];for(let t=0;t<i;++t)r[t]=o[i*n+t];return r}_getTypedArrayFromBinary(t,e,i,n,r){const s=this._cachedTypedArrays;let o=s[t];return o||(o=az.createTypedArray(e,this.buffer.buffer,this.buffer.byteOffset+r,n*i),s[t]=o),o}_getTypedArrayFromArray(t,e,i){const n=this._cachedTypedArrays;let r=n[t];return r||(r=az.createTypedArray(e,i),n[t]=r),r}}const fz={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},mz={SCALAR:(t,e)=>t[e],VEC2:(t,e)=>[t[2*e+0],t[2*e+1]],VEC3:(t,e)=>[t[3*e+0],t[3*e+1],t[3*e+2]],VEC4:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT2:(t,e)=>[t[4*e+0],t[4*e+1],t[4*e+2],t[4*e+3]],MAT3:(t,e)=>[t[9*e+0],t[9*e+1],t[9*e+2],t[9*e+3],t[9*e+4],t[9*e+5],t[9*e+6],t[9*e+7],t[9*e+8]],MAT4:(t,e)=>[t[16*e+0],t[16*e+1],t[16*e+2],t[16*e+3],t[16*e+4],t[16*e+5],t[16*e+6],t[16*e+7],t[16*e+8],t[16*e+9],t[16*e+10],t[16*e+11],t[16*e+12],t[16*e+13],t[16*e+14],t[16*e+15]]},gz={SCALAR:(t,e,i)=>{e[i]=t},VEC2:(t,e,i)=>{e[2*i+0]=t[0],e[2*i+1]=t[1]},VEC3:(t,e,i)=>{e[3*i+0]=t[0],e[3*i+1]=t[1],e[3*i+2]=t[2]},VEC4:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT2:(t,e,i)=>{e[4*i+0]=t[0],e[4*i+1]=t[1],e[4*i+2]=t[2],e[4*i+3]=t[3]},MAT3:(t,e,i)=>{e[9*i+0]=t[0],e[9*i+1]=t[1],e[9*i+2]=t[2],e[9*i+3]=t[3],e[9*i+4]=t[4],e[9*i+5]=t[5],e[9*i+6]=t[6],e[9*i+7]=t[7],e[9*i+8]=t[8],e[9*i+9]=t[9]},MAT4:(t,e,i)=>{e[16*i+0]=t[0],e[16*i+1]=t[1],e[16*i+2]=t[2],e[16*i+3]=t[3],e[16*i+4]=t[4],e[16*i+5]=t[5],e[16*i+6]=t[6],e[16*i+7]=t[7],e[16*i+8]=t[8],e[16*i+9]=t[9],e[16*i+10]=t[10],e[16*i+11]=t[11],e[16*i+12]=t[12],e[16*i+13]=t[13],e[16*i+14]=t[14],e[16*i+15]=t[15]}};const _z=t=>void 0!==t;function yz(t,e,i){if(!e)return null;let n=t.getExtension("3DTILES_batch_table_hierarchy");const r=e.HIERARCHY;return r&&(e.extensions=e.extensions||{},e.extensions["3DTILES_batch_table_hierarchy"]=r,n=r),n?function(t,e){let i,n,r;const s=t.instancesLength,o=t.classes;let a,l=t.classIds,c=t.parentCounts,h=t.parentIds,u=s;_z(l.byteOffset)&&(l.componentType=defaultValue(l.componentType,GL.UNSIGNED_SHORT),l.type=AttributeType.SCALAR,r=getBinaryAccessor(l),l=r.createArrayBufferView(e.buffer,e.byteOffset+l.byteOffset,s));if(_z(c))for(_z(c.byteOffset)&&(c.componentType=defaultValue(c.componentType,GL.UNSIGNED_SHORT),c.type=AttributeType.SCALAR,r=getBinaryAccessor(c),c=r.createArrayBufferView(e.buffer,e.byteOffset+c.byteOffset,s)),a=new Uint16Array(s),u=0,i=0;i<s;++i)a[i]=u,u+=c[i];_z(h)&&_z(h.byteOffset)&&(h.componentType=defaultValue(h.componentType,GL.UNSIGNED_SHORT),h.type=AttributeType.SCALAR,r=getBinaryAccessor(h),h=r.createArrayBufferView(e.buffer,e.byteOffset+h.byteOffset,u));const d=o.length;for(i=0;i<d;++i){const t=o[i].instances,n=getBinaryProperties(o[i].length,t,e);o[i].instances=combine(n,t)}const p=new Array(d).fill(0),f=new Uint16Array(s);for(i=0;i<s;++i)n=l[i],f[i]=p[n],++p[n];const m={classes:o,classIds:l,classIndexes:f,parentCounts:c,parentIndexes:a,parentIds:h};return function(t){const e=t.classIds,i=e.length;for(let e=0;e<i;++e)xz(t,e,stack)}(m),m}(n,i):null}function vz(t,e,i){if(!t)return;const n=t.parentCounts;return t.parentIds?i(t,e):n>0?function(t,e,i){const n=t.classIds,r=t.parentCounts,s=t.parentIds,o=t.parentIndexes,a=scratchVisited;a.length=Math.max(a.length,n.length);const l=++marker,c=scratchStack;c.length=0,c.push(e);for(;c.length>0;){if(a[e=c.pop()]===l)continue;a[e]=l;const n=i(t,e);if(_z(n))return n;const h=r[e],u=o[e];for(let t=0;t<h;++t){const i=s[u+t];i!==e&&c.push(i)}}return null}(t,e,i):function(t,e,i){let n=!0;for(;n;){const r=i(t,e);if(_z(r))return r;const s=t.parentIds[e];n=s!==e,e=s}throw new Error("traverseHierarchySingleParent")}(t,e,i)}function xz(t,e,i){const n=t.parentCounts,r=t.parentIds,s=t.parentIndexes,o=t.classIds.length;if(!_z(r))return;assert(e<o,"Parent index ".concat(e," exceeds the total number of instances: ").concat(o)),assert(-1===i.indexOf(e),"Circular dependency detected in the batch table hierarchy."),i.push(e);const a=_z(n)?n[e]:1,l=_z(n)?s[e]:e;for(let n=0;n<a;++n){const s=r[l+n];s!==e&&xz(t,s,i)}i.pop(e)}function bz(t){return null!=t}const wz=(t,e)=>t,Az={HIERARCHY:!0,extensions:!0,extras:!0};class Tz{constructor(t,e,i){var n;let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};He(this,"json",void 0),He(this,"binary",void 0),He(this,"featureCount",void 0),He(this,"_extensions",void 0),He(this,"_properties",void 0),He(this,"_binaryProperties",void 0),He(this,"_hierarchy",void 0),Be(i>=0),this.json=t||{},this.binary=e,this.featureCount=i,this._extensions=(null===(n=this.json)||void 0===n?void 0:n.extensions)||{},this._properties={};for(const t in this.json)Az[t]||(this._properties[t]=this.json[t]);this._binaryProperties=this._initializeBinaryProperties(),r["3DTILES_batch_table_hierarchy"]&&(this._hierarchy=yz(this,this.json,this.binary))}getExtension(t){return this.json&&this.json.extensions&&this.json.extensions[t]}memorySizeInBytes(){return 0}isClass(t,e){if(this._checkBatchId(t),Be("string"==typeof e,e),this._hierarchy){return bz(vz(this._hierarchy,t,((t,i)=>t.classes[t.classIds[i]].name===e)))}return!1}isExactClass(t,e){return Be("string"==typeof e,e),this.getExactClassName(t)===e}getExactClassName(t){if(this._checkBatchId(t),this._hierarchy){return this._hierarchy.classes[this._hierarchy.classIds[t]].name}}hasProperty(t,e){return this._checkBatchId(t),Be("string"==typeof e,e),bz(this._properties[e])||this._hasPropertyInHierarchy(t,e)}getPropertyNames(t,e){this._checkBatchId(t),(e=bz(e)?e:[]).length=0;const i=Object.keys(this._properties);return e.push(...i),this._hierarchy&&this._getPropertyNamesInHierarchy(t,e),e}getProperty(t,e){if(this._checkBatchId(t),Be("string"==typeof e,e),this._binaryProperties){const i=this._binaryProperties[e];if(bz(i))return this._getBinaryProperty(i,t)}const i=this._properties[e];if(bz(i))return wz(i[t]);if(this._hierarchy){const i=this._getHierarchyProperty(t,e);if(bz(i))return i}}setProperty(t,e,i){const n=this.featureCount;if(this._checkBatchId(t),Be("string"==typeof e,e),this._binaryProperties){const n=this._binaryProperties[e];if(n)return void this._setBinaryProperty(n,t,i)}if(this._hierarchy&&this._setHierarchyProperty(this,t,e,i))return;let r=this._properties[e];bz(r)||(this._properties[e]=new Array(n),r=this._properties[e]),r[t]=wz(i)}_checkBatchId(t){if(!(t>=0&&t<this.featureCount))throw new Error("batchId not in range [0, featureCount - 1].")}_getBinaryProperty(t,e){return t.unpack(t.typedArray,e)}_setBinaryProperty(t,e,i){t.pack(i,t.typedArray,e)}_initializeBinaryProperties(){let t=null;for(const e in this._properties){const i=this._initializeBinaryProperty(e,this._properties[e]);i&&(t=t||{},t[e]=i)}return t}_initializeBinaryProperty(t,e){if("byteOffset"in e){const i=e;Be(this.binary,"Property ".concat(t," requires a batch table binary.")),Be(i.type,"Property ".concat(t," requires a type."));const n=function(t,e,i,n){const{componentType:r}=t;Be(t.componentType);const s="string"==typeof r?az.fromName(r):r,o=fz[t.type],a=mz[t.type],l=gz[t.type];return{values:az.createTypedArray(s,e,i+=t.byteOffset,o*n),type:s,size:o,unpacker:a,packer:l}}(i,this.binary.buffer,0|this.binary.byteOffset,this.featureCount);return{typedArray:n.values,componentCount:n.size,unpack:n.unpacker,pack:n.packer}}return null}_hasPropertyInHierarchy(t,e){if(!this._hierarchy)return!1;const i=vz(this._hierarchy,t,((t,i)=>bz(t.classes[t.classIds[i]].instances[e])));return bz(i)}_getPropertyNamesInHierarchy(t,e){vz(this._hierarchy,t,((t,i)=>{const n=t.classes[t.classIds[i]].instances;for(const t in n)n.hasOwnProperty(t)&&-1===e.indexOf(t)&&e.push(t)}))}_getHierarchyProperty(t,e){return vz(this._hierarchy,t,((t,i)=>{const n=t.classIndexes[i],r=t.classes[t.classIds[i]].instances[e];return bz(r)?bz(r.typedArray)?this._getBinaryProperty(r,n):wz(r[n]):null}))}_setHierarchyProperty(t,e,i,n){const r=vz(this._hierarchy,e,((t,r)=>{const s=t.classIndexes[r],o=t.classes[t.classIds[r]].instances[i];return!!bz(o)&&(Be(r===e,'Inherited property "'.concat(i,'" is read-only.')),bz(o.typedArray)?this._setBinaryProperty(o,s,n):o[s]=wz(n),!0)}));return bz(r)}}const Mz=4;function Sz(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=new DataView(e);if(t.magic=n.getUint32(i,!0),i+=Mz,t.version=n.getUint32(i,!0),i+=Mz,t.byteLength=n.getUint32(i,!0),i+=Mz,1!==t.version)throw new Error("3D Tile Version ".concat(t.version," not supported"));return i}const Ez=4;function Cz(t,e,i){const n=new DataView(e);let r;t.header=t.header||{};let s=n.getUint32(i,!0),o=n.getUint32(i+=Ez,!0),a=n.getUint32(i+=Ez,!0),l=n.getUint32(i+=Ez,!0);return i+=Ez,a>=570425344?(i-=2*Ez,r=s,a=o,l=0,s=0,o=0):l>=570425344&&(i-=Ez,r=a,a=s,l=o,s=0,o=0),t.header.featureTableJsonByteLength=s,t.header.featureTableBinaryByteLength=o,t.header.batchTableJsonByteLength=a,t.header.batchTableBinaryByteLength=l,t.header.batchLength=r,i}function Iz(t,e,i,n){return i=function(t,e,i,n){const{featureTableJsonByteLength:r,featureTableBinaryByteLength:s,batchLength:o}=t.header;if(t.featureTableJson={BATCH_LENGTH:o||0},r>0){const n=ez(e,i,r);t.featureTableJson=JSON.parse(n)}return i+=r,t.featureTableBinary=new Uint8Array(e,i,s),i+=s,i}(t,e,i),i=function(t,e,i,n){const{batchTableJsonByteLength:r,batchTableBinaryByteLength:s}=t.header;if(r>0){const n=ez(e,i,r);t.batchTableJson=JSON.parse(n),i+=r,s>0&&(t.batchTableBinary=new Uint8Array(e,i,s),t.batchTableBinary=new Uint8Array(t.batchTableBinary),i+=s)}return i}(t,e,i),i}function Pz(t,e,i){if(!(e||t&&t.batchIds&&i))return null;const{batchIds:n,isRGB565:r,pointCount:s}=t;if(n&&i){const t=new Uint8ClampedArray(3*s);for(let e=0;e<s;e++){const r=i.getProperty(n[e],"dimensions").map((t=>255*t));t[3*e]=r[0],t[3*e+1]=r[1],t[3*e+2]=r[2]}return{type:nz.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}if(r){const t=new Uint8ClampedArray(3*s);for(let i=0;i<s;i++){const n=lz(e[i]);t[3*i]=n[0],t[3*i+1]=n[1],t[3*i+2]=n[2]}return{type:nz.UNSIGNED_BYTE,value:t,size:3,normalized:!0}}return e&&e.length===3*s?{type:nz.UNSIGNED_BYTE,value:e,size:3,normalized:!0}:{type:nz.UNSIGNED_BYTE,value:e,size:4,normalized:!0}}const Lz=new Dc;function Rz(t,e,i){return t.isQuantized?i["3d-tiles"]&&i["3d-tiles"].decodeQuantizedPositions?(t.isQuantized=!1,function(t,e){const i=new Dc,n=new Float32Array(3*t.pointCount);for(let r=0;r<t.pointCount;r++)i.set(e[3*r],e[3*r+1],e[3*r+2]).scale(1/t.quantizedRange).multiply(t.quantizedVolumeScale).add(t.quantizedVolumeOffset).toArray(n,3*r);return n}(t,e)):{type:nz.UNSIGNED_SHORT,value:e,size:3,normalized:!0}:e}async function Bz(t,e,i,n,r){i=Iz(t,e,i=Cz(t,e,i=Sz(t,e,i))),function(t){t.attributes={positions:null,colors:null,normals:null,batchIds:null},t.isQuantized=!1,t.isTranslucent=!1,t.isRGB565=!1,t.isOctEncoded16P=!1}(t);const{featureTable:s,batchTable:o}=function(t){const e=new pz(t.featureTableJson,t.featureTableBinary),i=e.getGlobalProperty("POINTS_LENGTH");if(!Number.isFinite(i))throw new Error("POINTS_LENGTH must be defined");e.featuresLength=i,t.featuresLength=i,t.pointsLength=i,t.pointCount=i,t.rtcCenter=e.getGlobalProperty("RTC_CENTER",nz.FLOAT,3);const n=function(t,e){let i=null;if(!t.batchIds&&e.hasProperty("BATCH_ID")&&(t.batchIds=e.getPropertyArray("BATCH_ID",nz.UNSIGNED_SHORT,1),t.batchIds)){const n=e.getGlobalProperty("BATCH_LENGTH");if(!n)throw new Error("Global property: BATCH_LENGTH must be defined when BATCH_ID is defined.");const{batchTableJson:r,batchTableBinary:s}=t;i=new Tz(r,s,n)}return i}(t,e);return{featureTable:e,batchTable:n}}(t);return await async function(t,e,i,n,r){let s,o,a;const l=t.batchTableJson&&t.batchTableJson.extensions&&t.batchTableJson.extensions["3DTILES_draco_point_compression"];l&&(a=l.properties);const c=e.getExtension("3DTILES_draco_point_compression");if(c){o=c.properties;const e=c.byteOffset,i=c.byteLength;if(!o||!Number.isFinite(e)||!i)throw new Error("Draco properties, byteOffset, and byteLength must be defined");s=t.featureTableBinary.slice(e,e+i),t.hasPositions=Number.isFinite(o.POSITION),t.hasColors=Number.isFinite(o.RGB)||Number.isFinite(o.RGBA),t.hasNormals=Number.isFinite(o.NORMAL),t.hasBatchIds=Number.isFinite(o.BATCH_ID),t.isTranslucent=Number.isFinite(o.RGBA)}if(!s)return!0;const h={buffer:s,properties:{...o,...a},featureTableProperties:o,batchTableProperties:a,dequantizeInShader:!1};return await async function(t,e,i,n){const{parse:r}=n,s={...i,draco:{...i.draco,extraAttributes:e.batchTableProperties||{}}};delete s["3d-tiles"];const o=await r(e.buffer,lO,s),a=o.attributes.POSITION&&o.attributes.POSITION.value,l=o.attributes.COLOR_0&&o.attributes.COLOR_0.value,c=o.attributes.NORMAL&&o.attributes.NORMAL.value,h=o.attributes.BATCH_ID&&o.attributes.BATCH_ID.value,u=c&&o.attributes.NORMAL.value.quantization;if(a&&o.attributes.POSITION.value.quantization){const e=o.POSITION.data.quantization,i=e.range;t.quantizedVolumeScale=new Dc(i,i,i),t.quantizedVolumeOffset=new Dc(e.minValues),t.quantizedRange=(1<<e.quantizationBits)-1,t.isQuantizedDraco=!0}u&&(t.octEncodedRange=(1<<o.NORMAL.data.quantization.quantizationBits)-1,t.isOctEncodedDraco=!0);const d={};if(e.batchTableProperties)for(const t of Object.keys(e.batchTableProperties))o.attributes[t]&&o.attributes[t].value&&(d[t.toLowerCase()]=o.attributes[t].value);t.attributes={positions:a,colors:Pz(t,l,void 0),normals:c,batchIds:h,...d}}(t,h,n,r)}(t,s,0,n,r),function(t,e,i){if(!t.attributes.positions)if(e.hasProperty("POSITION"))t.attributes.positions=e.getPropertyArray("POSITION",nz.FLOAT,3);else if(e.hasProperty("POSITION_QUANTIZED")){const n=e.getPropertyArray("POSITION_QUANTIZED",nz.UNSIGNED_SHORT,3);if(t.isQuantized=!0,t.quantizedRange=65535,t.quantizedVolumeScale=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",nz.FLOAT,3),!t.quantizedVolumeScale)throw new Error("QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");if(t.quantizedVolumeOffset=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",nz.FLOAT,3),!t.quantizedVolumeOffset)throw new Error("QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");t.attributes.positions=Rz(t,n,i)}if(!t.attributes.positions)throw new Error("Either POSITION or POSITION_QUANTIZED must be defined.")}(t,s,n),function(t,e,i){if(!t.attributes.colors){let n=null;e.hasProperty("RGBA")?(n=e.getPropertyArray("RGBA",nz.UNSIGNED_BYTE,4),t.isTranslucent=!0):e.hasProperty("RGB")?n=e.getPropertyArray("RGB",nz.UNSIGNED_BYTE,3):e.hasProperty("RGB565")&&(n=e.getPropertyArray("RGB565",nz.UNSIGNED_SHORT,1),t.isRGB565=!0),t.attributes.colors=Pz(t,n,i)}e.hasProperty("CONSTANT_RGBA")&&(t.constantRGBA=e.getGlobalProperty("CONSTANT_RGBA",nz.UNSIGNED_BYTE,4))}(t,s,o),function(t,e){if(!t.attributes.normals){let i=null;e.hasProperty("NORMAL")?i=e.getPropertyArray("NORMAL",nz.FLOAT,3):e.hasProperty("NORMAL_OCT16P")&&(i=e.getPropertyArray("NORMAL_OCT16P",nz.UNSIGNED_BYTE,2),t.isOctEncoded16P=!0),t.attributes.normals=function(t,e){if(!e)return null;if(t.isOctEncoded16P){const i=new Float32Array(3*t.pointsLength);for(let n=0;n<t.pointsLength;n++)dz(e[2*n],e[2*n+1],Lz),Lz.toArray(i,3*n);return{type:nz.FLOAT,size:2,value:i}}return{type:nz.FLOAT,size:2,value:e}}(t,i)}}(t,s),i}const Dz={URI:0,EMBEDDED:1};function Oz(t,e,i,n){t.rotateYtoZ=!0;const r=t.byteOffset+t.byteLength-i;if(0===r)throw new Error("glTF byte length must be greater than 0.");return t.gltfUpAxis=n["3d-tiles"]&&n["3d-tiles"].assetGltfUpAxis?n["3d-tiles"].assetGltfUpAxis:"Y",t.gltfArrayBuffer=fi(e,i,r),t.gltfByteOffset=0,t.gltfByteLength=r,t.byteOffset+t.byteLength}async function kz(t,e,i,n){const r=i["3d-tiles"]||{};if(function(t,e,i){switch(e){case Dz.URI:const e=new Uint8Array(t.gltfArrayBuffer,t.gltfByteOffset),i=(new TextDecoder).decode(e);t.gltfUrl=i.replace(/[\s\0]+$/,""),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength;break;case Dz.EMBEDDED:break;default:throw new Error("b3dm: Illegal glTF format field")}}(t,e),r.loadGLTF){const{parse:e,fetch:r}=n;t.gltfUrl&&(t.gltfArrayBuffer=await r(t.gltfUrl,i),t.gltfByteOffset=0),t.gltfArrayBuffer&&(t.gltf=await e(t.gltfArrayBuffer,uk,i,n),t.gpuMemoryUsageInBytes=cD(t.gltf),delete t.gltfArrayBuffer,delete t.gltfByteOffset,delete t.gltfByteLength)}}async function Fz(t,e,i,n,r){var s;i=function(t,e,i,n,r){i=Sz(t,e,i),i=Cz(t,e,i),i=Iz(t,e,i),i=Oz(t,e,i,n);const s=new pz(t.featureTableJson,t.featureTableBinary);return t.rtcCenter=s.getGlobalProperty("RTC_CENTER",nz.FLOAT,3),i}(t,e,i,n),await kz(t,Dz.EMBEDDED,n,r);const o=null==t||null===(s=t.gltf)||void 0===s?void 0:s.extensions;return o&&o.CESIUM_RTC&&(t.rtcCenter=o.CESIUM_RTC.center),i}async function zz(t,e,i,n,r){return i=function(t,e,i,n,r){if(i=Sz(t,e,i),1!==t.version)throw new Error("Instanced 3D Model version ".concat(t.version," is not supported"));i=Cz(t,e,i);const s=new DataView(e);if(t.gltfFormat=s.getUint32(i,!0),i+=4,i=Iz(t,e,i),i=Oz(t,e,i,n),0===t.featureTableJsonByteLength)throw new Error("i3dm parser: featureTableJsonByteLength is zero.");const o=new pz(t.featureTableJson,t.featureTableBinary),a=o.getGlobalProperty("INSTANCES_LENGTH");if(o.featuresLength=a,!Number.isFinite(a))throw new Error("i3dm parser: INSTANCES_LENGTH must be defined");t.eastNorthUp=o.getGlobalProperty("EAST_NORTH_UP"),t.rtcCenter=o.getGlobalProperty("RTC_CENTER",nz.FLOAT,3);new Tz(t.batchTableJson,t.batchTableBinary,a);return function(t,e,i,n){const r={instances:new Array(n),batchTable:t._batchTable,cull:!1,url:void 0,gltf:void 0,basePath:void 0,incrementallyLoadTextures:!1,forwardAxis:[1,0,0]},s=r.instances,o=new Dc;new Dc,new Dc,new Dc;const a=new jc,l=new Eh,c=new Dc,h={},u=new lh,d=[],p=[],f=new Dc,m=new Dc;for(let i=0;i<n;i++){let n;if(e.hasProperty("POSITION"))n=e.getProperty("POSITION",nz.FLOAT,3,i,o);else if(e.hasProperty("POSITION_QUANTIZED")){n=e.getProperty("POSITION_QUANTIZED",nz.UNSIGNED_SHORT,3,i,o);const t=e.getGlobalProperty("QUANTIZED_VOLUME_OFFSET",nz.FLOAT,3,f);if(!t)throw new Error("i3dm parser: QUANTIZED_VOLUME_OFFSET must be defined for quantized positions.");const r=e.getGlobalProperty("QUANTIZED_VOLUME_SCALE",nz.FLOAT,3,m);if(!r)throw new Error("i3dm parser: QUANTIZED_VOLUME_SCALE must be defined for quantized positions.");const s=65535;for(let e=0;e<3;e++)n[e]=n[e]/s*r[e]+t[e]}if(!n)throw new Error("i3dm: POSITION or POSITION_QUANTIZED must be defined for each instance.");if(o.copy(n),h.translation=o,t.normalUp=e.getProperty("NORMAL_UP",nz.FLOAT,3,i,d),t.normalRight=e.getProperty("NORMAL_RIGHT",nz.FLOAT,3,i,p),t.normalUp){if(!t.normalRight)throw new Error("i3dm: Custom orientation requires both NORMAL_UP and NORMAL_RIGHT.");t.hasCustomOrientation=!0}else{if(t.octNormalUp=e.getProperty("NORMAL_UP_OCT32P",nz.UNSIGNED_SHORT,2,d),t.octNormalRight=e.getProperty("NORMAL_RIGHT_OCT32P",nz.UNSIGNED_SHORT,2,p),t.octNormalUp){if(!t.octNormalRight)throw new Error("i3dm: oct-encoded orientation requires NORMAL_UP_OCT32P and NORMAL_RIGHT_OCT32P");throw new Error("i3dm: oct-encoded orientation not implemented")}t.eastNorthUp?(Fk.WGS84.eastNorthUpToFixedFrame(o,u),u.getRotationMatrix3(a)):a.identity()}l.fromMatrix3(a),h.rotation=l,c.set(1,1,1);const r=e.getProperty("SCALE",nz.FLOAT,1,i);Number.isFinite(r)&&c.multiplyByScalar(r);const g=e.getProperty("SCALE_NON_UNIFORM",nz.FLOAT,3,i,d);g&&c.scale(g),h.scale=c;let _=e.getProperty("BATCH_ID",nz.UNSIGNED_SHORT,1,i);void 0===_&&(_=i);const y=(new lh).fromQuaternion(h.rotation);u.identity(),u.translate(h.translation),u.multiplyRight(y),u.scale(h.scale);const v=u.clone();s[i]={modelMatrix:v,batchId:_}}t.instances=s}(t,o,0,a),i}(t,e,i,n),await kz(t,t.gltfFormat,n,r),i}async function Nz(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};switch(r.byteOffset=e,r.type=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=new DataView(t);return"".concat(String.fromCharCode(i.getUint8(e+0))).concat(String.fromCharCode(i.getUint8(e+1))).concat(String.fromCharCode(i.getUint8(e+2))).concat(String.fromCharCode(i.getUint8(e+3)))}(t,e),r.type){case tz.COMPOSITE:return await async function(t,e,i,n,r,s){i=Sz(t,e,i);const o=new DataView(e);for(t.tilesLength=o.getUint32(i,!0),i+=4,t.tiles=[];t.tiles.length<t.tilesLength&&t.byteLength-i>12;){const o={};t.tiles.push(o),i=await s(e,i,n,r,o)}return i}(r,t,e,i,n,Nz);case tz.BATCHED_3D_MODEL:return await Fz(r,t,e,i,n);case tz.GLTF:return await async function(t,e,i,n){t.rotateYtoZ=!0,t.gltfUpAxis=i["3d-tiles"]&&i["3d-tiles"].assetGltfUpAxis?i["3d-tiles"].assetGltfUpAxis:"Y";const{parse:r}=n;t.gltf=await r(e,uk,i,n),t.gpuMemoryUsageInBytes=cD(t.gltf)}(r,t,i,n);case tz.INSTANCED_3D_MODEL:return await zz(r,t,e,i,n);case tz.POINT_CLOUD:return await Bz(r,t,e,i,n);default:throw new Error("3DTileLoader: unknown type ".concat(r.type))}}async function Uz(t,e,i,n){const r=t.bufferViews[t[e].bufferView],s=t.buffers[r.buffer];if(null==n||!n.url||!n.fetch)throw new Error("Url is not provided");if(!n.fetch)throw new Error("fetch is not provided");if(s.uri){const t=function(t,e){if(e.startsWith("http")){const i=new URL(t,e);return decodeURI(i.toString())}const i="http://".concat(e),n=new URL(t,i);return"/".concat(n.host).concat(n.pathname)}(s.uri,null==n?void 0:n.url),e=await n.fetch(t),i=await e.arrayBuffer();return new Uint8Array(i,r.byteOffset,r.byteLength)}return new Uint8Array(i,r.byteOffset,r.byteLength)}function Gz(t){const e=new DataView(t);return e.getUint32(0,!0)+2**32*e.getUint32(4,!0)}const Vz={id:"3d-tiles-subtree",name:"3D Tiles Subtree",module:"3d-tiles",version:QF,extensions:["subtree"],mimeTypes:["application/octet-stream"],tests:["subtree"],parse:async function(t,e,i){if(1952609651!==new Uint32Array(t.slice(0,4))[0])throw new Error("Wrong subtree file magic number");if(1!==new Uint32Array(t.slice(4,8))[0])throw new Error("Wrong subtree file verson, must be 1");const n=Gz(t.slice(8,16)),r=new Uint8Array(t,24,n),s=new TextDecoder("utf8").decode(r),o=JSON.parse(s),a=Gz(t.slice(16,24));let l=new ArrayBuffer(0);return a&&(l=t.slice(24+n)),"bufferView"in o.tileAvailability&&(o.tileAvailability.explicitBitstream=await Uz(o,"tileAvailability",l,i)),"bufferView"in o.contentAvailability&&(o.contentAvailability.explicitBitstream=await Uz(o,"contentAvailability",l,i)),"bufferView"in o.childSubtreeAvailability&&(o.childSubtreeAvailability.explicitBitstream=await Uz(o,"childSubtreeAvailability",l,i)),o},options:{}};
/**
 * @license
 * Copyright 2009 The Closure Library Authors
 * Copyright 2020 Daniel Wirtz / The long.js Authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 */var jz=null;try{jz=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(t){}function Hz(t,e,i){this.low=0|t,this.high=0|e,this.unsigned=!!i}function Wz(t){return!0===(t&&t.__isLong__)}function qz(t){var e=Math.clz32(t&-t);return t?31-e:e}Object.defineProperty(Hz.prototype,"__isLong__",{value:!0}),Hz.isLong=Wz;var Xz={},Zz={};function Jz(t,e){var i,n,r;return e?(r=0<=(t>>>=0)&&t<256)&&(n=Zz[t])?n:(i=$z(t,0,!0),r&&(Zz[t]=i),i):(r=-128<=(t|=0)&&t<128)&&(n=Xz[t])?n:(i=$z(t,t<0?-1:0,!1),r&&(Xz[t]=i),i)}function Yz(t,e){if(isNaN(t))return e?oN:sN;if(e){if(t<0)return oN;if(t>=iN)return uN}else{if(t<=-nN)return dN;if(t+1>=nN)return hN}return t<0?Yz(-t,e).neg():$z(t%eN|0,t/eN|0,e)}function $z(t,e,i){return new Hz(t,e,i)}Hz.fromInt=Jz,Hz.fromNumber=Yz,Hz.fromBits=$z;var Kz=Math.pow;function Qz(t,e,i){if(0===t.length)throw Error("empty string");if("number"==typeof e?(i=e,e=!1):e=!!e,"NaN"===t||"Infinity"===t||"+Infinity"===t||"-Infinity"===t)return e?oN:sN;if((i=i||10)<2||36<i)throw RangeError("radix");var n;if((n=t.indexOf("-"))>0)throw Error("interior hyphen");if(0===n)return Qz(t.substring(1),e,i).neg();for(var r=Yz(Kz(i,8)),s=sN,o=0;o<t.length;o+=8){var a=Math.min(8,t.length-o),l=parseInt(t.substring(o,o+a),i);if(a<8){var c=Yz(Kz(i,a));s=s.mul(c).add(Yz(l))}else s=(s=s.mul(r)).add(Yz(l))}return s.unsigned=e,s}function tN(t,e){return"number"==typeof t?Yz(t,e):"string"==typeof t?Qz(t,e):$z(t.low,t.high,"boolean"==typeof e?e:t.unsigned)}Hz.fromString=Qz,Hz.fromValue=tN;var eN=4294967296,iN=eN*eN,nN=iN/2,rN=Jz(1<<24),sN=Jz(0);Hz.ZERO=sN;var oN=Jz(0,!0);Hz.UZERO=oN;var aN=Jz(1);Hz.ONE=aN;var lN=Jz(1,!0);Hz.UONE=lN;var cN=Jz(-1);Hz.NEG_ONE=cN;var hN=$z(-1,2147483647,!1);Hz.MAX_VALUE=hN;var uN=$z(-1,-1,!0);Hz.MAX_UNSIGNED_VALUE=uN;var dN=$z(0,-2147483648,!1);Hz.MIN_VALUE=dN;var pN=Hz.prototype;pN.toInt=function(){return this.unsigned?this.low>>>0:this.low},pN.toNumber=function(){return this.unsigned?(this.high>>>0)*eN+(this.low>>>0):this.high*eN+(this.low>>>0)},pN.toString=function(t){if((t=t||10)<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(dN)){var e=Yz(t),i=this.div(e),n=i.mul(e).sub(this);return i.toString(t)+n.toInt().toString(t)}return"-"+this.neg().toString(t)}for(var r=Yz(Kz(t,6),this.unsigned),s=this,o="";;){var a=s.div(r),l=(s.sub(a.mul(r)).toInt()>>>0).toString(t);if((s=a).isZero())return l+o;for(;l.length<6;)l="0"+l;o=""+l+o}},pN.getHighBits=function(){return this.high},pN.getHighBitsUnsigned=function(){return this.high>>>0},pN.getLowBits=function(){return this.low},pN.getLowBitsUnsigned=function(){return this.low>>>0},pN.getNumBitsAbs=function(){if(this.isNegative())return this.eq(dN)?64:this.neg().getNumBitsAbs();for(var t=0!=this.high?this.high:this.low,e=31;e>0&&0==(t&1<<e);e--);return 0!=this.high?e+33:e+1},pN.isZero=function(){return 0===this.high&&0===this.low},pN.eqz=pN.isZero,pN.isNegative=function(){return!this.unsigned&&this.high<0},pN.isPositive=function(){return this.unsigned||this.high>=0},pN.isOdd=function(){return 1==(1&this.low)},pN.isEven=function(){return 0==(1&this.low)},pN.equals=function(t){return Wz(t)||(t=tN(t)),(this.unsigned===t.unsigned||this.high>>>31!=1||t.high>>>31!=1)&&(this.high===t.high&&this.low===t.low)},pN.eq=pN.equals,pN.notEquals=function(t){return!this.eq(t)},pN.neq=pN.notEquals,pN.ne=pN.notEquals,pN.lessThan=function(t){return this.comp(t)<0},pN.lt=pN.lessThan,pN.lessThanOrEqual=function(t){return this.comp(t)<=0},pN.lte=pN.lessThanOrEqual,pN.le=pN.lessThanOrEqual,pN.greaterThan=function(t){return this.comp(t)>0},pN.gt=pN.greaterThan,pN.greaterThanOrEqual=function(t){return this.comp(t)>=0},pN.gte=pN.greaterThanOrEqual,pN.ge=pN.greaterThanOrEqual,pN.compare=function(t){if(Wz(t)||(t=tN(t)),this.eq(t))return 0;var e=this.isNegative(),i=t.isNegative();return e&&!i?-1:!e&&i?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1},pN.comp=pN.compare,pN.negate=function(){return!this.unsigned&&this.eq(dN)?dN:this.not().add(aN)},pN.neg=pN.negate,pN.add=function(t){Wz(t)||(t=tN(t));var e=0,i=0,n=0,r=0;return n+=(r+=(65535&this.low)+(65535&t.low))>>>16,i+=(n+=(this.low>>>16)+(t.low>>>16))>>>16,e+=(i+=(65535&this.high)+(65535&t.high))>>>16,e+=(this.high>>>16)+(t.high>>>16),$z((n&=65535)<<16|(r&=65535),(e&=65535)<<16|(i&=65535),this.unsigned)},pN.subtract=function(t){return Wz(t)||(t=tN(t)),this.add(t.neg())},pN.sub=pN.subtract,pN.multiply=function(t){if(this.isZero())return this;if(Wz(t)||(t=tN(t)),jz)return $z(jz.mul(this.low,this.high,t.low,t.high),jz.get_high(),this.unsigned);if(t.isZero())return this.unsigned?oN:sN;if(this.eq(dN))return t.isOdd()?dN:sN;if(t.eq(dN))return this.isOdd()?dN:sN;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(rN)&&t.lt(rN))return Yz(this.toNumber()*t.toNumber(),this.unsigned);var e=65535&this.high,i=this.low>>>16,n=65535&this.low,r=65535&t.high,s=t.low>>>16,o=65535&t.low,a=0,l=0,c=0,h=0;return c+=(h+=n*o)>>>16,l+=(c+=i*o)>>>16,c&=65535,l+=(c+=n*s)>>>16,a+=(l+=e*o)>>>16,l&=65535,a+=(l+=i*s)>>>16,l&=65535,a+=(l+=n*r)>>>16,a+=(this.high>>>16)*o+e*s+i*r+n*(t.high>>>16),$z((c&=65535)<<16|(h&=65535),(a&=65535)<<16|(l&=65535),this.unsigned)},pN.mul=pN.multiply,pN.divide=function(t){if(Wz(t)||(t=tN(t)),t.isZero())throw Error("division by zero");var e,i,n;if(jz)return this.unsigned||-2147483648!==this.high||-1!==t.low||-1!==t.high?$z((this.unsigned?jz.div_u:jz.div_s)(this.low,this.high,t.low,t.high),jz.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?oN:sN;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return oN;if(t.gt(this.shru(1)))return lN;n=oN}else{if(this.eq(dN))return t.eq(aN)||t.eq(cN)?dN:t.eq(dN)?aN:(e=this.shr(1).div(t).shl(1)).eq(sN)?t.isNegative()?aN:cN:(i=this.sub(t.mul(e)),n=e.add(i.div(t)));if(t.eq(dN))return this.unsigned?oN:sN;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();n=sN}for(i=this;i.gte(t);){e=Math.max(1,Math.floor(i.toNumber()/t.toNumber()));for(var r=Math.ceil(Math.log(e)/Math.LN2),s=r<=48?1:Kz(2,r-48),o=Yz(e),a=o.mul(t);a.isNegative()||a.gt(i);)a=(o=Yz(e-=s,this.unsigned)).mul(t);o.isZero()&&(o=aN),n=n.add(o),i=i.sub(a)}return n},pN.div=pN.divide,pN.modulo=function(t){return Wz(t)||(t=tN(t)),jz?$z((this.unsigned?jz.rem_u:jz.rem_s)(this.low,this.high,t.low,t.high),jz.get_high(),this.unsigned):this.sub(this.div(t).mul(t))},pN.mod=pN.modulo,pN.rem=pN.modulo,pN.not=function(){return $z(~this.low,~this.high,this.unsigned)},pN.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},pN.clz=pN.countLeadingZeros,pN.countTrailingZeros=function(){return this.low?qz(this.low):qz(this.high)+32},pN.ctz=pN.countTrailingZeros,pN.and=function(t){return Wz(t)||(t=tN(t)),$z(this.low&t.low,this.high&t.high,this.unsigned)},pN.or=function(t){return Wz(t)||(t=tN(t)),$z(this.low|t.low,this.high|t.high,this.unsigned)},pN.xor=function(t){return Wz(t)||(t=tN(t)),$z(this.low^t.low,this.high^t.high,this.unsigned)},pN.shiftLeft=function(t){return Wz(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?$z(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):$z(0,this.low<<t-32,this.unsigned)},pN.shl=pN.shiftLeft,pN.shiftRight=function(t){return Wz(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?$z(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):$z(this.high>>t-32,this.high>=0?0:-1,this.unsigned)},pN.shr=pN.shiftRight,pN.shiftRightUnsigned=function(t){return Wz(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?$z(this.low>>>t|this.high<<32-t,this.high>>>t,this.unsigned):$z(32===t?this.high:this.high>>>t-32,0,this.unsigned)},pN.shru=pN.shiftRightUnsigned,pN.shr_u=pN.shiftRightUnsigned,pN.rotateLeft=function(t){var e;return Wz(t)&&(t=t.toInt()),0==(t&=63)?this:32===t?$z(this.high,this.low,this.unsigned):t<32?$z(this.low<<t|this.high>>>(e=32-t),this.high<<t|this.low>>>e,this.unsigned):$z(this.high<<(t-=32)|this.low>>>(e=32-t),this.low<<t|this.high>>>e,this.unsigned)},pN.rotl=pN.rotateLeft,pN.rotateRight=function(t){var e;return Wz(t)&&(t=t.toInt()),0==(t&=63)?this:32===t?$z(this.high,this.low,this.unsigned):t<32?$z(this.high<<(e=32-t)|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned):$z(this.low<<(e=32-(t-=32))|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned)},pN.rotr=pN.rotateRight,pN.toSigned=function(){return this.unsigned?$z(this.low,this.high,!1):this},pN.toUnsigned=function(){return this.unsigned?this:$z(this.low,this.high,!0)},pN.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()},pN.toBytesLE=function(){var t=this.high,e=this.low;return[255&e,e>>>8&255,e>>>16&255,e>>>24,255&t,t>>>8&255,t>>>16&255,t>>>24]},pN.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,255&t,e>>>24,e>>>16&255,e>>>8&255,255&e]},Hz.fromBytes=function(t,e,i){return i?Hz.fromBytesLE(t,e):Hz.fromBytesBE(t,e)},Hz.fromBytesLE=function(t,e){return new Hz(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)},Hz.fromBytesBE=function(t,e){return new Hz(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)};const fN=16;function mN(t){"X"===t&&(t="");const e=t.padEnd(fN,"0");return Hz.fromString(e,!0,16)}const gN=3,_N=61,yN=180/Math.PI;function vN(t,e,i){const n=1<<e;return[(t[0]+i[0])/n,(t[1]+i[1])/n]}function xN(t){return t>=.5?1/3*(4*t*t-1):1/3*(1-4*(1-t)*(1-t))}function bN(t){return[xN(t[0]),xN(t[1])]}function wN(t,e){let[i,n]=e;switch(t){case 0:return[1,i,n];case 1:return[-i,1,n];case 2:return[-i,-n,1];case 3:return[-1,-n,-i];case 4:return[n,-1,-i];case 5:return[n,i,-1];default:throw new Error("Invalid face")}}function AN(t){let[e,i,n]=t;const r=Math.atan2(n,Math.sqrt(e*e+i*i));return[Math.atan2(i,e)*yN,r*yN]}function TN(t,e,i,n){if(0===n){1===i&&(e[0]=t-1-e[0],e[1]=t-1-e[1]);const n=e[0];e[0]=e[1],e[1]=n}}const MN=100;function SN(t){const{face:e,ij:i,level:n}=t,r=[[0,0],[0,1],[1,1],[1,0],[0,0]],s=Math.max(1,Math.ceil(MN*Math.pow(2,-n))),o=new Float64Array(4*s*2+2);let a=0,l=0;for(let t=0;t<4;t++){const c=r[t].slice(0),h=r[t+1],u=(h[0]-c[0])/s,d=(h[1]-c[1])/s;for(let t=0;t<s;t++){c[0]+=u,c[1]+=d;const t=AN(wN(e,bN(vN(i,n,c))));Math.abs(t[1])>89.999&&(t[0]=l);const r=t[0]-l;t[0]+=r>180?-360:r<-180?360:0,o[a++]=t[0],o[a++]=t[1],l=t[0]}}return o[a++]=o[0],o[a++]=o[1],o}function EN(t){const e=function(t){if(t.indexOf("/")>0)return t;const e=mN(t);return function(t){if(t.isZero())return"";let e=t.toString(2);for(;e.length<gN+_N;)e="0"+e;const i=e.lastIndexOf("1"),n=e.substring(0,3),r=e.substring(3,i),s=r.length/2,o=Hz.fromString(n,!0,2).toString(10);let a="";if(0!==s)for(a=Hz.fromString(r,!0,2).toString(4);a.length<s;)a="0"+a;return"".concat(o,"/").concat(a)}(e)}(t),i=function(t){if(0===t.length)throw new Error("Invalid Hilbert quad key ".concat(t));const e=t.split("/"),i=parseInt(e[0],10),n=e[1],r=n.length;let s=0;const o=[0,0];for(let t=r-1;t>=0;t--){s=r-t;const e=n[t];let i=0,a=0;"1"===e?a=1:"2"===e?(i=1,a=1):"3"===e&&(i=1);const l=Math.pow(2,s-1);TN(l,o,i,a),o[0]+=l*i,o[1]+=l*a}if(i%2==1){const t=o[0];o[0]=o[1],o[1]=t}return{face:i,ij:o,level:s}}(e);return i}function CN(t){return function(t){const e=bN(vN(t.ij,t.level,[.5,.5]));return AN(wN(t.face,e))}(EN(t))}function IN(t){if(t.length%2!=0)throw new Error("Invalid corners");const e=[],i=[];for(let n=0;n<t.length;n+=2)e.push(t[n]),i.push(t[n+1]);return e.sort(((t,e)=>t-e)),i.sort(((t,e)=>t-e)),{west:e[0],east:e[e.length-1],north:i[i.length-1],south:i[0]}}function PN(t,e){const i=(null==e?void 0:e.minimumHeight)||0,n=(null==e?void 0:e.maximumHeight)||0,r=function(t){let e;if(2===t.face||5===t.face){let i=null,n=0;for(let e=0;e<4;e++){const r=SN(EN("".concat(t.face,"/").concat(e)));null==i&&(i=new Float64Array(4*r.length)),i.set(r,n),n+=r.length}e=IN(i)}else e=IN(SN(t));return e}(EN(t)),s=r.west,o=r.south,a=r.east,l=r.north,c=[];return c.push(new Dc(s,l,i)),c.push(new Dc(a,l,i)),c.push(new Dc(a,o,i)),c.push(new Dc(s,o,i)),c.push(new Dc(s,l,n)),c.push(new Dc(a,l,n)),c.push(new Dc(a,o,n)),c.push(new Dc(s,o,n)),c}function LN(t){const e=t.token,i={minimumHeight:t.minimumHeight,maximumHeight:t.maximumHeight},n=PN(e,i),r=CN(e),s=Fk.WGS84.cartographicToCartesian([r[0],r[1],i.maximumHeight]),o=new Dc(s[0],s[1],s[2]);n.push(o);const a=function(t,e=new vR){if(!t||0===t.length)return e.halfAxes=new jc([0,0,0,0,0,0,0,0,0]),e.center=new Dc,e;const i=t.length,n=new Dc(0,0,0);for(const e of t)n.add(e);const r=1/i;n.multiplyByScalar(r);let s=0,o=0,a=0,l=0,c=0,h=0;for(const e of t){const t=FR.copy(e).subtract(n);s+=t.x*t.x,o+=t.x*t.y,a+=t.x*t.z,l+=t.y*t.y,c+=t.y*t.z,h+=t.z*t.z}s*=r,o*=r,a*=r,l*=r,c*=r,h*=r;const u=VR;u[0]=s,u[1]=o,u[2]=a,u[3]=o,u[4]=l,u[5]=c,u[6]=a,u[7]=c,u[8]=h;const{unitary:d}=RR(u,jR),p=e.halfAxes.copy(d);let f=p.getColumn(0,NR),m=p.getColumn(1,UR),g=p.getColumn(2,GR),_=-Number.MAX_VALUE,y=-Number.MAX_VALUE,v=-Number.MAX_VALUE,x=Number.MAX_VALUE,b=Number.MAX_VALUE,w=Number.MAX_VALUE;for(const e of t)FR.copy(e),_=Math.max(FR.dot(f),_),y=Math.max(FR.dot(m),y),v=Math.max(FR.dot(g),v),x=Math.min(FR.dot(f),x),b=Math.min(FR.dot(m),b),w=Math.min(FR.dot(g),w);f=f.multiplyByScalar(.5*(x+_)),m=m.multiplyByScalar(.5*(b+y)),g=g.multiplyByScalar(.5*(w+v)),e.center.copy(f).add(m).add(g);const A=zR.set(_-x,y-b,v-w).multiplyByScalar(.5),T=new jc([A[0],0,0,0,A[1],0,0,0,A[2]]);return e.halfAxes.multiplyRight(T),e}(n);return[...a.center,...a.halfAxes]}const RN={QUADTREE:4,OCTREE:8};function BN(t,e,i){if(null!=t&&t.box){const n=function(t,e){const i=function(t){return t.and(t.not().add(1))}(t).shiftRightUnsigned(2);return t.add(Hz.fromNumber(2*e+1-4).multiply(i))}(mN(t.s2VolumeInfo.token),e),r=function(t){if(t.isZero())return"X";let e=t.countTrailingZeros();e=(e-e%4)/4;const i=e;e*=4;const n=t.shiftRightUnsigned(e).toString(16).replace(/0+$/,"");return Array(17-i-n.length).join("0")+n}(n),s={...t.s2VolumeInfo};if(s.token=r,"OCTREE"===i){const e=t.s2VolumeInfo,i=e.maximumHeight-e.minimumHeight,n=i/2,r=e.minimumHeight+i/2;e.minimumHeight=r-n,e.maximumHeight=r+n}return{box:LN(s),s2VolumeInfo:s}}}async function DN(t){const{options:e,parentData:i={mortonIndex:0,x:0,y:0,z:0},childIndex:n=0,globalData:r={level:0,mortonIndex:0,x:0,y:0,z:0},s2VolumeBox:s}=t;let{subtree:o,level:a=0}=t;const{subdivisionScheme:l,subtreeLevels:c,maximumLevel:h,contentUrlTemplate:u,subtreesUriTemplate:d,basePath:p}=e,f={children:[],lodMetricValue:0,contentUrl:""},m=RN[l],g=1&n,_=n>>1&1,y=n>>2&1,v=(m**a-1)/(m-1);let x=FN(i.mortonIndex,n),b=v+x,w=FN(i.x,g),A=FN(i.y,_),T=FN(i.z,y),M=!1;a+1>c&&(M=ON(o.childSubtreeAvailability,x));const S=FN(r.x,w),E=FN(r.y,A),C=FN(r.z,T),I=a+r.level;if(M){const t=zN("".concat(p,"/").concat(d),I,S,E,C);o=await Wn(t,Vz),r.mortonIndex=x,r.x=w,r.y=A,r.z=T,r.level=a,x=0,b=0,w=0,A=0,T=0,a=0}if(!ON(o.tileAvailability,b)||a>h)return f;ON(o.contentAvailability,b)&&(f.contentUrl=zN(u,I,S,E,C));const P=a+1,L={mortonIndex:x,x:w,y:A,z:T};for(let t=0;t<m;t++){const i=BN(s,t,l),n=await DN({subtree:o,options:e,parentData:L,childIndex:t,level:P,globalData:r,s2VolumeBox:i});if(n.contentUrl||n.children.length){const t=kN(n,I+1,{childTileX:w,childTileY:A,childTileZ:T},e,s);f.children.push(t)}}return f}function ON(t,e){return"constant"in t?Boolean(t.constant):!!t.explicitBitstream&&function(t,e){const i=Math.floor(t/8);return 1==(e[i]>>t%8&1)}(e,t.explicitBitstream)}function kN(t,e,i,n,r){const{basePath:s,refine:o,getRefine:a,lodMetricType:l,getTileType:c,rootLodMetricValue:h,rootBoundingVolume:u}=n,d=t.contentUrl&&t.contentUrl.replace("".concat(s,"/"),""),p=h/2**e,f=function(t,e,i){if(e.region){const{childTileX:n,childTileY:r,childTileZ:s}=i,[o,a,l,c,h,u]=e.region,d=2**t,p=(l-o)/d,f=(c-a)/d,m=(u-h)/d,[g,_]=[o+p*n,o+p*(n+1)],[y,v]=[a+f*r,a+f*(r+1)],[x,b]=[h+m*s,h+m*(s+1)];return{region:[g,y,_,v,x,b]}}if(e.box)return e;throw new Error("Unsupported bounding volume type ".concat(e))}(e,null!=r&&r.box?{box:r.box}:u,i);return{children:t.children,contentUrl:t.contentUrl,content:{uri:d},id:t.contentUrl,refine:a(o),type:c(t),lodMetricType:l,lodMetricValue:p,geometricError:p,transform:t.transform,boundingVolume:f}}function FN(t,e){return parseInt(t.toString(2)+e.toString(2),2)}function zN(t,e,i,n,r){const s=function(t){const e={};for(const i in t)e["{".concat(i,"}")]=t[i];return e}({level:e,x:i,y:n,z:r});return t.replace(/{level}|{x}|{y}|{z}/gi,(t=>s[t]))}function NN(t){if(!t.contentUrl)return oF.EMPTY;const e=t.contentUrl.split("?")[0].split(".").pop();switch(e){case"pnts":return oF.POINTCLOUD;case"i3dm":case"b3dm":case"glb":case"gltf":return oF.SCENEGRAPH;default:return e}}function UN(t){switch(t){case"REPLACE":case"replace":return sF.REPLACE;case"ADD":case"add":return sF.ADD;default:return t}}function GN(t,e){if(/^[a-z][0-9a-z+.-]*:/i.test(e)){const i=new URL(t,"".concat(e,"/"));return decodeURI(i.toString())}return t.startsWith("/")?t:"".concat(e,"/").concat(t)}function VN(t,e){if(!t)return null;if(t.content){t.contentUrl=GN(t.content.uri||t.content.url,e.basePath)}return t.id=t.contentUrl,t.lodMetricType=lF.GEOMETRIC_ERROR,t.lodMetricValue=t.geometricError,t.transformMatrix=t.transform,t.type=NN(t),t.refine=UN(t.refine),t}async function jN(t,e,i,n){var r,s;const o=e.basePath,{subdivisionScheme:a,maximumLevel:l,subtreeLevels:c,subtrees:{uri:h}}=i,u=GN(zN(h,0,0,0,0),o),d=await Wn(u,Vz,n),p=GN(t.content.uri,o),f=null==e||null===(r=e.root)||void 0===r?void 0:r.refine,m=t.geometricError,g=null===(s=t.boundingVolume.extensions)||void 0===s?void 0:s["3DTILES_bounding_volume_S2"];if(g){const e=LN(g);t.boundingVolume={box:e,s2VolumeInfo:g}}const _={contentUrlTemplate:p,subtreesUriTemplate:h,subdivisionScheme:a,subtreeLevels:c,maximumLevel:l,refine:f,basePath:o,lodMetricType:lF.GEOMETRIC_ERROR,rootLodMetricValue:m,rootBoundingVolume:t.boundingVolume,getTileType:NN,getRefine:UN};return await async function(t,e,i){if(!t)return null;t.lodMetricType=lF.GEOMETRIC_ERROR,t.lodMetricValue=t.geometricError,t.transformMatrix=t.transform;const{children:n,contentUrl:r}=await DN({subtree:e,options:i,s2VolumeBox:t});r&&(t.contentUrl=r,t.content={uri:r.replace("".concat(i.basePath,"/"),"")});return t.refine=UN(t.refine),t.type=NN(t),t.children=n,t.id=t.contentUrl,t}(t,d,_)}function HN(t){var e;return(null==t||null===(e=t.extensions)||void 0===e?void 0:e["3DTILES_implicit_tiling"])||(null==t?void 0:t.implicitTiling)}const WN={id:"3d-tiles",name:"3D Tiles",module:"3d-tiles",version:QF,extensions:["cmpt","pnts","b3dm","i3dm"],mimeTypes:["application/octet-stream"],tests:["cmpt","pnts","b3dm","i3dm"],parse:async function(t,e,i){const n=e["3d-tiles"]||{};let r;r="auto"===n.isTileset?i.url&&-1!==i.url.indexOf(".json"):n.isTileset;t=r?await async function(t,e,i){var n;const r=JSON.parse((new TextDecoder).decode(t));return r.loader=e.loader||WN,r.url=i.url,r.queryString=i.queryString,r.basePath=function(t){return Ei(t.url)}(r),r.root=await async function(t,e){const i=t.basePath;let n;const r=HN(null==t?void 0:t.root);n=r&&t.root?await jN(t.root,t,r,e):VN(t.root,t);const s=[];for(s.push(n);s.length>0;){const n=(s.pop()||{}).children||[];for(let r of n){const n=HN(r);n?r=await jN(r,t,n,e):VN(r,{basePath:i}),s.push(r)}}return n}(r,e),r.type=aF.TILES3D,r.lodMetricType=lF.GEOMETRIC_ERROR,r.lodMetricValue=(null===(n=r.root)||void 0===n?void 0:n.lodMetricValue)||0,r}(t,e,i):await async function(t,e,i){const n={content:{featureIds:null}},r=0;return await Nz(t,r,e,i,n.content),n.content}(t,e,i);return t},options:{"3d-tiles":{loadGLTF:!0,decodeQuantizedPositions:!1,isTileset:"auto",assetGltfUpAxis:null}}};const qN=[0],XN={getPointColor:{type:"accessor",value:[0,0,0,255]},pointSize:1,data:"",loader:WN,onTilesetLoad:{type:"function",value:t=>{}},onTileLoad:{type:"function",value:t=>{}},onTileUnload:{type:"function",value:t=>{}},onTileError:{type:"function",value:(t,e,i)=>{}},_getMeshColor:{type:"function",value:t=>[255,255,255]}};let ZN=class extends Ym{constructor(...t){super(...t),He(this,"state",void 0)}initializeState(){"onTileLoadFail"in this.props&&kr.removed("onTileLoadFail","onTileError")(),this.state={layerMap:{},tileset3d:null,activeViewports:{},lastUpdatedViewports:null}}get isLoaded(){var t,e;return Boolean((null===(t=this.state)||void 0===t||null===(e=t.tileset3d)||void 0===e?void 0:e.isLoaded())&&super.isLoaded)}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState({props:t,oldProps:e,changeFlags:i}){if(t.data&&t.data!==e.data&&this._loadTileset(t.data),i.viewportChanged){const{activeViewports:t}=this.state;Object.keys(t).length&&(this._updateTileset(t),this.state.lastUpdatedViewports=t,this.state.activeViewports={})}if(i.propsChanged){const{layerMap:t}=this.state;for(const e in t)t[e].needsUpdate=!0}}activateViewport(t){const{activeViewports:e,lastUpdatedViewports:i}=this.state;this.internalState.viewport=t,e[t.id]=t;const n=null==i?void 0:i[t.id];n&&t.equals(n)||(this.setChangeFlags({viewportChanged:!0}),this.setNeedsUpdate())}getPickingInfo({info:t,sourceLayer:e}){const i=e&&e.props.tile;return t.picked&&(t.object=i),t.sourceTile=i,t}filterSubLayer({layer:t,viewport:e}){const{tile:i}=t.props,{id:n}=e;return i.selected&&i.viewportIds.includes(n)}_updateAutoHighlight(t){const e=t.sourceTile,i=this.state.layerMap[null==e?void 0:e.id];i&&i.layer&&i.layer.updateAutoHighlight(t)}async _loadTileset(t){const{loadOptions:e={}}=this.props;let i=this.props.loader||this.props.loaders;Array.isArray(i)&&(i=i[0]);const n={loadOptions:{...e}};let r=t;if(i.preload){const s=await i.preload(t,e);s.url&&(r=s.url),s.headers&&(n.loadOptions.fetch={...n.loadOptions.fetch,headers:s.headers}),Object.assign(n,s)}const s=await Wn(r,i,n.loadOptions),o=new KF(s,{onTileLoad:this._onTileLoad.bind(this),onTileUnload:this._onTileUnload.bind(this),onTileError:this.props.onTileError,...n});this.setState({tileset3d:o,layerMap:{}}),this._updateTileset(this.state.activeViewports),this.props.onTilesetLoad(o)}_onTileLoad(t){const{lastUpdatedViewports:e}=this.state;this.props.onTileLoad(t),this._updateTileset(e),this.setNeedsUpdate()}_onTileUnload(t){delete this.state.layerMap[t.id],this.props.onTileUnload(t)}_updateTileset(t){if(!t)return;const{tileset3d:e}=this.state,{timeline:i}=this.context,n=Object.keys(t).length;i&&n&&e&&e.selectTiles(Object.values(t)).then((t=>{this.state.frameNumber!==t&&this.setState({frameNumber:t})}))}_getSubLayer(t,e){if(!t.content)return null;switch(t.type){case oF.POINTCLOUD:return this._makePointCloudLayer(t,e);case oF.SCENEGRAPH:return this._make3DModelLayer(t);case oF.MESH:return this._makeSimpleMeshLayer(t,e);default:throw new Error("Tile3DLayer: Failed to render layer of type ".concat(t.content.type))}}_makePointCloudLayer(t,e){const{attributes:i,pointCount:n,constantRGBA:r,cartographicOrigin:s,modelMatrix:o}=t.content,{positions:a,normals:l,colors:c}=i;if(!a)return null;const h=e&&e.props.data||{header:{vertexCount:n},attributes:{POSITION:a,NORMAL:l,COLOR_0:c}},{pointSize:u,getPointColor:d}=this.props;return new(this.getSubLayerClass("pointcloud",dg))({pointSize:u},this.getSubLayerProps({id:"pointcloud"}),{id:"".concat(this.id,"-pointcloud-").concat(t.id),tile:t,data:h,coordinateSystem:Vr.METER_OFFSETS,coordinateOrigin:s,modelMatrix:o,getColor:r||d,_offset:0})}_make3DModelLayer(t){const{gltf:e,instances:i,cartographicOrigin:n,modelMatrix:r}=t.content;return new(this.getSubLayerClass("scenegraph",mk))({_lighting:"pbr"},this.getSubLayerProps({id:"scenegraph"}),{id:"".concat(this.id,"-scenegraph-").concat(t.id),tile:t,data:i||qN,scenegraph:e,coordinateSystem:Vr.METER_OFFSETS,coordinateOrigin:n,modelMatrix:r,getTransformMatrix:t=>t.modelMatrix,getPosition:[0,0,0],_offset:0})}_makeSimpleMeshLayer(t,e){const i=t.content,{attributes:n,indices:r,modelMatrix:s,cartographicOrigin:o,coordinateSystem:a=Vr.METER_OFFSETS,material:l,featureIds:c}=i,{_getMeshColor:h}=this.props,u=e&&e.props.mesh||new ru({drawMode:4,attributes:JN(n),indices:r});return new(this.getSubLayerClass("mesh",gk))(this.getSubLayerProps({id:"mesh"}),{id:"".concat(this.id,"-mesh-").concat(t.id),tile:t,mesh:u,data:qN,getColor:h(t),pbrMaterial:l,modelMatrix:s,coordinateOrigin:o,coordinateSystem:a,featureIds:c,_offset:0})}renderLayers(){const{tileset3d:t,layerMap:e}=this.state;return t?t.tiles.map((t=>{const i=e[t.id]=e[t.id]||{tile:t};let{layer:n}=i;return t.selected&&(n?i.needsUpdate&&(n=this._getSubLayer(t,n),i.needsUpdate=!1):n=this._getSubLayer(t)),i.layer=n,n})).filter(Boolean):null}};function JN(t){const e={};return e.positions={...t.positions,value:new Float32Array(t.positions.value)},t.normals&&(e.normals=t.normals),t.texCoords&&(e.texCoords=t.texCoords),t.colors&&(e.colors=t.colors),t.uvRegions&&(e.uvRegions=t.uvRegions),e}He(ZN,"defaultProps",XN),He(ZN,"layerName","Tile3DLayer");class YN{constructor(t){const e=this;e.implementation=t,e._tick=e._tick.bind(e)}onAdd(t,e){const i=this,n=i.implementation,r=Object.assign({},n,{type:ZN}),s=n.lightColor,o=i.ambientLight=new uu({color:s,intensity:3}),a=i.directionalLight=new gu({color:s,intensity:9,direction:[0,0,-1]}),l=t.map;i.map=t,delete r.lightColor,delete r.minzoom,delete r.maxzoom,l.addLayer(new Ly(r),e||"poi"),l.setLayerZoomRange(n.id,n.minzoom,n.maxzoom),l.__deck.props.effects=[new yd({ambientLight:o,directionalLight:a})],void 0===s&&i._tick()}_tick(){const t=this,{map:e,ambientLight:i,directionalLight:n}=t,r=e.clock.getTime();if(Math.floor(r/6e4)!==Math.floor(t.lastRefresh/6e4)){const{r:s,g:o,b:a}=e.getLightColor(),l=[Math.round(255*s),Math.round(255*o),Math.round(255*a)],c=e.getCenter(),h=Te.getPosition(r,c.lat,c.lng),u=Math.PI+h.azimuth,d=-h.altitude;i.color=l,n.color=l,n.direction=[Math.sin(u)*Math.cos(d),Math.cos(u)*Math.cos(d),-Math.sin(d)],t.lastRefresh=r}e.map.getLayer(t.implementation.id)&&requestAnimationFrame(t._tick)}}class $N{constructor(t){this.uniforms={zoom:{type:"f",value:t.zoom},cameraZ:{type:"f",value:t.cameraZ},modelScale:{type:"f",value:t.modelScale}}}getUniforms(){const t=this.uniforms;return{zoom:t.zoom,cameraZ:t.cameraZ,modelScale:t.modelScale}}getMesh(){return this.mesh}getPickingMesh(){return this.pickingMesh}getOutlineMesh(){return this.outlineMesh}addInstance(t){this.geometry.addInstance(t)}removeInstance(t){this.geometry.removeInstance(t)}setInstanceAttributes(t,e){this.geometry.setInstanceAttributes(t,e)}getInstanceAttributes(t){return this.geometry.getInstanceAttributes(t)}setOpacity(t){this.material.opacity=t}getOpacity(){return this.material.opacity}refreshCameraParams(t){const e=this.uniforms;e.zoom.value=t.zoom,e.cameraZ.value=t.cameraZ}}class KN extends jP{constructor(t,e,i,n){super();const r=this,{attributes:s,index:o}=t,a=r.userData,l=a.attributes={},c=a.buffers=[];r.instanceCount=0;for(const t of Object.keys(s))r.attributes[t]=s[t].clone();o&&(r.index=o.clone());const h=new Uint8Array(3*e),u=new AE(h,3,!0);for(let t=0;t<e;t++)h.set([255&i,t>>8&255,255&t],3*t);r.setAttribute("idColor",u);const d={};for(const t of Object.keys(n)){const e=n[t];if(e instanceof VS)r.setAttribute(t,e);else{const{type:e,itemSize:i,normalized:r}=n[t],s=d[e]=d[e]||{type:e,size:0,keys:[]};l[t]={itemSize:i,offset:s.size,normalized:r},s.size+=i,s.keys.push(t)}}for(const t of Object.keys(d)){const{type:i,size:n,keys:s}=d[t],o=new i(e*n),a=new AL(o,n).setUsage(35048);for(const t of s){const e=l[t],{itemSize:i,offset:n,normalized:s}=e;r.setAttribute(t,new VS(a,i,n,s)),e.buffer=a}c.push(a)}}addInstance(t={}){this.setInstanceAttributes(this.instanceCount++,t)}removeInstance(t){const e=this,i=e.instanceCount;for(const n of e.userData.buffers){const e=n.stride;n.set(n.array.subarray((t+1)*e,i*e),t*e),n.needsUpdate=!0}e.instanceCount--}setInstanceAttributes(t,e){const i=this;for(const n of Object.keys(e)){const{offset:r,buffer:s}=i.userData.attributes[n],o=e[n],a=t*s.stride+r;isNaN(o)?s.set(o,a):s.array[a]=o,s.needsUpdate=!0}}getInstanceAttributes(t){const e=this.userData.attributes,i={};for(const n of Object.keys(e)){const{itemSize:r,offset:s,buffer:o}=e[n],a=o.array,l=t*o.stride+s;i[n]=r>1?a.subarray(l,l+r):a[l]}return i}}function QN(t){let e,i,n,r=-1,s=0;for(let o=0;o<t.length;++o){const a=t[o];if(void 0===e&&(e=a.array.constructor),e!==a.array.constructor)return null;if(void 0===i&&(i=a.itemSize),i!==a.itemSize)return null;if(void 0===n&&(n=a.normalized),n!==a.normalized)return null;if(-1===r&&(r=a.gpuType),r!==a.gpuType)return null;s+=a.count*i}const o=new e(s),a=new Kw(o,i,n);let l=0;for(let e=0;e<t.length;++e){const n=t[e];if(n.isInterleavedBufferAttribute){const t=l/i;for(let e=0,r=n.count;e<r;e++)for(let r=0;r<i;r++){const i=n.getComponent(e,r);a.setComponent(e+t,r,i)}}else o.set(n.array,l);l+=n.count*i}return void 0!==r&&(a.gpuType=r),a}function tU(t,e){if(0===e)return t;if(2===e||1===e){let i=t.getIndex();if(null===i){const e=[],n=t.getAttribute("position");if(void 0===n)return t;for(let t=0;t<n.count;t++)e.push(t);t.setIndex(e),i=t.getIndex()}const n=i.count-2,r=[];if(2===e)for(let t=1;t<=n;t++)r.push(i.getX(0)),r.push(i.getX(t)),r.push(i.getX(t+1));else for(let t=0;t<n;t++)t%2==0?(r.push(i.getX(t)),r.push(i.getX(t+1)),r.push(i.getX(t+2))):(r.push(i.getX(t+2)),r.push(i.getX(t+1)),r.push(i.getX(t)));const s=t.clone();return s.setIndex(r),s.clearGroups(),s}return t}const eU="\nuniform float zoom;\nuniform float modelScale;\nattribute vec3 translation;\n\nfloat getScale( float zoom, float modelScale) {\n\treturn pow( 2.0, 14.0 - clamp( zoom, 13.0, 19.0 ) ) * modelScale * 100.0;\n}\n\n#ifdef TRANSFORM\nuniform float cameraZ;\nattribute float rotationX;\nattribute float rotationZ;\nattribute vec3 idColor;\n\n#ifdef AIRCRAFT\nattribute float groupIndex;\n#endif\n\nmat3 rotateX( float angle ) {\n    float s = sin( angle );\n    float c = cos( angle );\n    return mat3(\n        1.0, 0.0, 0.0,\n        0.0, c, s,\n        0.0, -s, c\n    );\n}\n\nmat3 rotateZ( float angle ) {\n    float s = sin( angle );\n    float c = cos( angle );\n    return mat3(\n        c, s, 0.0,\n        -s, c, 0.0,\n        0.0, 0.0, 1.0\n    );\n}\n#endif\n",iU="\nvarying vec3 vInstanceColor;\n",nU="\nvarying float vIntensity;\n",rU="\nvarying float vInstanceOpacity;\n",sU="\nvarying vec3 vIdColor;\n",oU="\nfloat zoom0 = zoom + log2( cameraZ / abs( cameraZ - translation.z ) );\nfloat scale0 = getScale( zoom0, modelScale );\n\n#ifdef AIRCRAFT\nfloat scale = 0.06 / 0.285 * modelScale * 100.0;\nfloat offsetY = groupIndex == 2.0 ? 0.44 - 1.32 * max( scale / scale0, 1.0 ) : 0.0;\nfloat offsetZ = groupIndex == 2.0 ? 0.88 : 0.0;\nfloat scaleX = groupIndex == 1.0 ? max( scale0, scale ) : scale0;\nfloat scaleY = groupIndex == 0.0 ? max( scale0, scale ) : scale0;\nvec3 position0 = ( position + vec3( 0.0, offsetY, offsetZ ) ) * vec3( scaleX, scaleY, scale0 );\n#else\nvec3 position0 = position * scale0;\n#endif\n\nposition0 = position0 * ( 1.0 + idColor.b * 0.03 );\n\n#ifdef OUTLINE\nposition0 = position0 + 0.1 * scale0 * sign( position );\n#endif\n\nvec3 transformed = rotateZ( rotationZ ) * rotateX( rotationX ) * position0 + translation + vec3( 0.0, 0.0, 0.44 * scale0 );\n",aU=`\n#include <common>\n#define TRANSFORM\n\n${eU}\nattribute vec3 color0;\nattribute vec3 color1;\nattribute float opacity0;\n\n#ifdef CAR\nattribute vec3 color2;\nattribute vec3 color3;\nattribute float groupIndex;\n#endif\n\n${iU}\n${rU}\n`;function lU(t){return t.replace("#include <common>",aU).replace("#include <begin_vertex>",oU).replace("#include <beginnormal_vertex>","\nvec3 objectNormal = rotateZ( rotationZ ) * rotateX( rotationX ) * vec3( normal );\n").replace("#include <color_vertex>","\n#include <color_vertex>\n\n#ifdef CAR\nfloat mod3 = mod( groupIndex, 3.0 );\nvec3 null = vec3( 0.0, 1.0, 0.0 );\nvInstanceColor = mod3 == 1.0 && color1 != null ? color1 : color0;\nvInstanceColor = mod3 == 2.0 && color2 != null ? color2 : vInstanceColor;\nvInstanceColor = groupIndex >= 3.0 && color3 != null ? color3 : vInstanceColor;\n#else\nvInstanceColor = groupIndex < 2.0 ? color0 : color1;\n#endif\n\nvInstanceOpacity = opacity0;\n")}const cU=`\n#include <packing>\n\n${iU}\n${rU}\n`;function hU(t){return t.replace("#include <packing>",cU).replace("vec4 diffuseColor = vec4( diffuse, opacity );","\nvec4 diffuseColor = vec4( diffuse * vInstanceColor, opacity * vInstanceOpacity );\n")}const uU=`\n#define TRANSFORM\n\n${eU}\n${sU}\n\nvoid main() {\n    ${oU}\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( transformed, 1.0 );\n    vIdColor = idColor;\n}\n`,dU=`\n${sU}\n\nvoid main() {\n    gl_FragColor = vec4( vIdColor, 1.0 );\n}\n`,pU=`\n${eU}\nuniform float opacity;\nattribute float opacity0;\nattribute float delay;\n${nU}\n\nvoid main() {\n    float scale = getScale( zoom, modelScale );\n    vec3 transformed = position * scale + translation + vec3( 0.0, 0.0, 0.44 * scale );\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( transformed, delay );\n    vec3 vNormal = normalize( normalMatrix * normal );\n    vec3 vNormel = normalize( vec3( modelViewMatrix * vec4( transformed, 1.0 ) ) );\n    vIntensity = ( 1.0 + dot( vNormal, vNormel ) ) * opacity * opacity0;\n}\n`,fU=`\nuniform float base;\n${nU}\n\nvoid main() {\n    vec3 color = mix( vec3( base ), vec3( 1.0, 0.6, 0.0 ), vIntensity );\n    gl_FragColor = vec4( color, 1.0 );\n}\n`,mU=`\n#define TRANSFORM\n#define OUTLINE\n\n${eU}\nattribute float outline;\n${rU}\n\nvoid main() {\n    ${oU}\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( transformed, outline > 0.0 ? 1.0 : 0.0 );\n    vInstanceOpacity = outline;\n}\n`,gU=`\n${rU}\n\nvoid main() {\n    gl_FragColor = vec4( 1.0, 1.0, 1.0, vInstanceOpacity );\n}\n`;function _U(t,e){return`#define ${t}\n${e}`}const yU=new Float32Array([].concat(...[0,1,2].map((t=>Array(24).fill(t)))));class vU extends $N{constructor(t,e){super(e);const i=this,n=[new IA(.88,2.64,.88),new IA(2.64,.88,.1),new IA(.1,.88,.88)],r=function(t,e=!1){const i=null!==t[0].index,n=new Set(Object.keys(t[0].attributes)),r=new Set(Object.keys(t[0].morphAttributes)),s={},o={},a=t[0].morphTargetsRelative,l=new cA;let c=0;for(let h=0;h<t.length;++h){const u=t[h];let d=0;if(i!==(null!==u.index))return null;for(const t in u.attributes){if(!n.has(t))return null;void 0===s[t]&&(s[t]=[]),s[t].push(u.attributes[t]),d++}if(d!==n.size)return null;if(a!==u.morphTargetsRelative)return null;for(const t in u.morphAttributes){if(!r.has(t))return null;void 0===o[t]&&(o[t]=[]),o[t].push(u.morphAttributes[t])}if(e){let t;if(i)t=u.index.count;else{if(void 0===u.attributes.position)return null;t=u.attributes.position.count}l.addGroup(c,t,h),c+=t}}if(i){let e=0;const i=[];for(let n=0;n<t.length;++n){const r=t[n].index;for(let t=0;t<r.count;++t)i.push(r.getX(t)+e);e+=t[n].attributes.position.count}l.setIndex(i)}for(const t in s){const e=QN(s[t]);if(!e)return null;l.setAttribute(t,e)}for(const t in o){const e=o[t][0].length;if(0===e)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[t]=[];for(let i=0;i<e;++i){const e=[];for(let n=0;n<o[t].length;++n)e.push(o[t][n][i]);const n=QN(e);if(!n)return null;l.morphAttributes[t].push(n)}}return l}(n);r.setAttribute("groupIndex",new Kw(yU,1));const s=i.geometry=new KN(r,t,e.index,{translation:{type:Float32Array,itemSize:3},rotationX:{type:Float32Array,itemSize:1},rotationZ:{type:Float32Array,itemSize:1},opacity0:{type:Float32Array,itemSize:1},outline:{type:Float32Array,itemSize:1},color0:{type:Uint8Array,itemSize:3,normalized:!0},color1:{type:Uint8Array,itemSize:3,normalized:!0}});n.forEach((t=>t.dispose())),r.dispose();const o=i.material=new HI({opacity:e.opacity,transparent:!0});o.onBeforeCompile=t=>{t.uniforms=Object.assign(t.uniforms,i.getUniforms()),t.vertexShader=_U("AIRCRAFT",lU(t.vertexShader)),t.fragmentShader=hU(t.fragmentShader)};const a=i.mesh=new EA(s,o);a.updateMatrix(),a.matrixAutoUpdate=!1,a.frustumCulled=!1;const l=i.pickingMaterial=new DA({uniforms:i.getUniforms(),vertexShader:_U("AIRCRAFT",uU),fragmentShader:dU}),c=i.pickingMesh=new EA(s,l);c.updateMatrix(),c.matrixAutoUpdate=!1,c.frustumCulled=!1;const h=i.outlineMaterial=new DA({uniforms:i.getUniforms(),vertexShader:_U("AIRCRAFT",mU),fragmentShader:gU,transparent:!0,side:Ny}),u=i.outlineMesh=new EA(s,h);u.updateMatrix(),u.matrixAutoUpdate=!1,u.frustumCulled=!1}dispose(){const t=this;t.geometry.dispose(),t.material.dispose(),t.pickingMaterial.dispose(),t.outlineMaterial.dispose()}}const xU=new Float32Array([].concat(...[0,1,2,2,1,0,5,4,3,3,4,5,0,3].map((t=>Array(6).fill(t)))));class bU extends $N{constructor(t,e){super(e);const i=this,{index:n,opacity:r,dark:s}=e,o=new IA(.88,1.76,.88,1,1,3),a=o.toNonIndexed();a.setAttribute("groupIndex",new Kw(xU,1));const l=i.geometry=new KN(a,t,n,{translation:{type:Float32Array,itemSize:3},rotationX:{type:Float32Array,itemSize:1},rotationZ:{type:Float32Array,itemSize:1},opacity0:{type:Float32Array,itemSize:1},delay:{type:Float32Array,itemSize:1},outline:{type:Float32Array,itemSize:1},color0:{type:Uint8Array,itemSize:3,normalized:!0},color1:{type:Uint8Array,itemSize:3,normalized:!0},color2:{type:Uint8Array,itemSize:3,normalized:!0},color3:{type:Uint8Array,itemSize:3,normalized:!0}});o.dispose(),a.dispose(),Object.assign(i.uniforms,{opacity:{type:"f",value:r},base:{type:"f",value:s?0:1}});const c=i.material=new HI({opacity:r,transparent:!0});c.onBeforeCompile=t=>{t.uniforms=Object.assign(t.uniforms,i.getUniforms()),t.vertexShader=_U("CAR",lU(t.vertexShader)),t.fragmentShader=hU(t.fragmentShader)};const h=i.mesh=new EA(l,c);h.updateMatrix(),h.matrixAutoUpdate=!1,h.frustumCulled=!1;const u=i.pickingMaterial=new DA({uniforms:i.getUniforms(),vertexShader:_U("CAR",uU),fragmentShader:dU}),d=i.pickingMesh=new EA(l,u);d.updateMatrix(),d.matrixAutoUpdate=!1,d.frustumCulled=!1;const p=new II(1.8,32,32),f=i.delayMarkerGeometry=new KN(p,t,n,{translation:l.getAttribute("translation"),opacity0:l.getAttribute("opacity0"),delay:l.getAttribute("delay")});p.dispose();const m=i.delayMarkerMaterial=new DA({uniforms:i.getUniforms(!0),vertexShader:_U("CAR",pU),fragmentShader:fU,blending:s?2:4,depthWrite:!1}),g=i.delayMarkerMesh=new EA(f,m);g.updateMatrix(),g.matrixAutoUpdate=!1,g.frustumCulled=!1;const _=i.outlineMaterial=new DA({uniforms:i.getUniforms(),vertexShader:_U("CAR",mU),fragmentShader:gU,transparent:!0,side:Ny}),y=i.outlineMesh=new EA(l,_);y.updateMatrix(),y.matrixAutoUpdate=!1,y.frustumCulled=!1}getUniforms(t){return t?Object.assign({},this.uniforms):super.getUniforms()}getDelayMarkerMesh(){return this.delayMarkerMesh}addInstance(t){super.addInstance(t),this.delayMarkerGeometry.addInstance()}removeInstance(t){super.removeInstance(t),this.delayMarkerGeometry.removeInstance(t)}setOpacity(t){super.setOpacity(t),this.uniforms.opacity.value=this.delayMarkerMaterial.opacity=t}refreshDelayMarkerMesh(t){this.uniforms.base.value=t?0:1,this.delayMarkerMaterial.blending=t?2:4}dispose(){const t=this;t.geometry.dispose(),t.material.dispose(),t.pickingMaterial.dispose(),t.delayMarkerGeometry.dispose(),t.delayMarkerMaterial.dispose(),t.outlineMaterial.dispose()}}class wU{constructor(t){const e=this;e.id=t.id,e.type="three",e.lightColor="white",e.ugObjects=[],e.ogObjects=[],e.aircraftObjects=[]}onAdd(t,e){const i=this,n=e.scene,r=t.getZoom(),s=t.map.getFreeCameraOptions().position.z,o=t.getModelScale();i.map=t,i.context=e;const a=i.ugCarMeshSet=new bU(2e3,{index:0,zoom:r,cameraZ:s,modelScale:o,opacity:.225}),l=i.ogCarMeshSet=new bU(4e3,{index:1,zoom:r,cameraZ:s,modelScale:o,opacity:.9}),c=i.aircraftMeshSet=new vU(200,{index:2,zoom:r,cameraZ:s,modelScale:o,opacity:.9});n.add(a.getMesh()),n.add(l.getMesh()),n.add(c.getMesh()),n.add(a.getDelayMarkerMesh()),n.add(l.getDelayMarkerMesh()),n.add(a.getOutlineMesh()),n.add(l.getOutlineMesh()),n.add(c.getOutlineMesh());const h=i.ugPickingScene=new NS;h.background=new Uw(16777215),h.add(a.getPickingMesh());const u=i.ogPickingScene=new NS;u.background=new Uw(16777215),u.add(l.getPickingMesh()),u.add(c.getPickingMesh()),i.pickingTexture=new vb(1,1),i.pixelBuffer=new Uint8Array(4),t.on("zoom",i.onCameraChanged.bind(i)),t.on("pitch",i.onCameraChanged.bind(i))}onCameraChanged(){const t=this,e=t.map,i={zoom:e.getZoom(),cameraZ:e.map.getFreeCameraOptions().position.z};t.ugCarMeshSet.refreshCameraParams(i),t.ogCarMeshSet.refreshCameraParams(i),t.aircraftMeshSet.refreshCameraParams(i)}setMode(t,e){const i=this,n=i.ugCarMeshSet.getOpacity(),r=i.ogCarMeshSet.getOpacity();let s,o;"none"!==e&&"edit"!==e?s=o=.1:"underground"===t?(s=.9,o=.225):(s=.225,o=.9),pt.start({callback:(t,e)=>{i.ugCarMeshSet.setOpacity(O(n,s,t/e)),i.ogCarMeshSet.setOpacity(O(r,o,t/e)),i.aircraftMeshSet.setOpacity(O(r,o,t/e)),i.refreshDelayMarkers(!0)},duration:gt.transitionDuration})}addObject(t){const e=this,{type:i,altitude:n}=t,r="train"===i?n<0?0:1:2,s=[e.ugCarMeshSet,e.ogCarMeshSet,e.aircraftMeshSet][r],o=[e.ugObjects,e.ogObjects,e.aircraftObjects][r],{x:a,y:l,z:c}=e.map.getModelPosition(t.coord,n),h=Array.isArray(t.color)?t.color:[t.color],u={translation:[a,l,c],rotationX:t.pitch,rotationZ:qx.degToRad(-t.bearing),opacity0:0,outline:t.outline};"train"===i?(u.delay=t.delay,u.color0=H(h[0]),u.color1=H(h[1]||"#00ff00"),u.color2=H(h[2]||"#00ff00"),u.color3=H(h[3]||"#00ff00")):(u.color0=H(h[0]),u.color1=H(h[1])),s.addInstance(u),t.meshIndex=r,t.instanceIndex=o.length,o.push(t),t.animationID=pt.start({callback:(e,i)=>{s.setInstanceAttributes(t.instanceIndex,{opacity0:e/i})},complete:()=>{delete t.animationID},duration:gt.fadeDuration})}updateObject(t){if(!t||void 0===t.instanceIndex)return;const e=this,{meshIndex:i,instanceIndex:n,altitude:r,type:s,animationID:o}=t,a=[e.ugCarMeshSet,e.ogCarMeshSet,e.aircraftMeshSet],l=[e.ugObjects,e.ogObjects,e.aircraftObjects],c=a[i],h=l[i],{x:u,y:d,z:p}=e.map.getModelPosition(t.coord,r),f={translation:[u,d,p],rotationX:t.pitch,rotationZ:qx.degToRad(-t.bearing),outline:t.outline},m=r<0?0:1;if("train"===s&&(f.delay=t.delay),c.setInstanceAttributes(n,f),"train"===s&&m!==i){const e=a[m],i=l[m],r=c.getInstanceAttributes(n).opacity0*c.getOpacity();let s;o&&pt.stop(o),e.addInstance(c.getInstanceAttributes(n)),t.meshIndex=m,t.instanceIndex=s=i.length,i.push(t),c.removeInstance(n),h.splice(n,1);for(let t=n;t<h.length;t++)h[t].instanceIndex--;e.setInstanceAttributes(s,{opacity0:r/e.getOpacity()}),t.animationID=pt.start({callback:(i,n)=>{e.setInstanceAttributes(t.instanceIndex,{opacity0:O(r/e.getOpacity(),1,i/n)})},complete:()=>{delete t.animationID},duration:gt.fadeDuration})}}removeObject(t){if(!t||void 0===t.instanceIndex)return;const e=this,{meshIndex:i,animationID:n}=t,r=[e.ugCarMeshSet,e.ogCarMeshSet,e.aircraftMeshSet][i],s=[e.ugObjects,e.ogObjects,e.aircraftObjects][i];n&&pt.stop(n),t.animationID=pt.start({callback:(e,i)=>{r.setInstanceAttributes(t.instanceIndex,{opacity0:1-e/i})},complete:()=>{const e=t.instanceIndex;r.removeInstance(e),delete t.meshIndex,delete t.instanceIndex,delete t.animationID,s.splice(e,1);for(let t=e;t<s.length;t++)s[t].instanceIndex--},duration:gt.fadeDuration})}pickObject(t,e){const i=this,{pickingTexture:n,pixelBuffer:r}=i,{renderer:s,camera:o}=i.context,a=s.getContext(),l=window.devicePixelRatio,c="underground"===t?i.ugPickingScene:i.ogPickingScene;o.setViewOffset(a.drawingBufferWidth,a.drawingBufferHeight,e.x*l|0,e.y*l|0,1,1),s.setRenderTarget(n),s.render(c,o),s.setRenderTarget(null),s.resetState(),o.clearViewOffset(),s.readRenderTargetPixels(n,0,0,1,1,r);const h=[i.ugObjects,i.ogObjects,i.aircraftObjects][r[0]];if(h)return h[r[1]<<8|r[2]]}refreshDelayMarkers(t){const e=this,i=Le(e.map.map,t);e.ugCarMeshSet.refreshDelayMarkerMesh(i),e.ogCarMeshSet.refreshDelayMarkerMesh(i)}project(t,e){const{map:i,context:n}=this,{width:r,height:s}=i.map.transform,{x:o,y:a,z:l}=i.getModelPosition(t,e),{x:c,y:h}=new Ab(o,a,l).project(n.camera);return new $.Point((c+1)/2*r,(1-h)/2*s)}}const AU={odpt:["Toei"]},TU={odpt:["TWR","TokyoMetro","Toei","YokohamaMunicipal","MIR","TamaMonorail"],challenge2024:["jre-is","Tokyu","Keikyu","Tobu","Seibu"]},MU="JR-East.SobuRapid",SU="JR-East.LimitedExpress";function EU(t){return`timetable-${"Weekday"===t.getCalendar()?"weekday":"holiday"}.json.gz`}function CU(t){const e=t.getCalendar();return"Saturday"===e?["timetable-saturday.json.gz"]:"Holiday"===e?["timetable-sunday-holiday.json.gz"]:[]}function IU(t,e,i){return e===SU&&i[0].match(/NaritaAirportTerminal1|Takao|Ofuna|Omiya|Ikebukuro|Shinjuku/)?t.replace(/JR-East\.(NaritaAirportBranch|Narita|Sobu)/,MU):t}function PU(t,e,i){const n=CU(i);return Promise.all([`${t}/dictionary-${e}.json`,`${t}/railways.json.gz`,`${t}/stations.json.gz`,`${t}/features.json.gz`,`${t}/${EU(i)}`,`${t}/rail-directions.json.gz`,`${t}/train-types.json.gz`,`${t}/train-vehicles.json.gz`,`${t}/operators.json.gz`,`${t}/airports.json.gz`,`${t}/flight-statuses.json.gz`,`${t}/poi.json.gz`,...n.map((e=>`${t}/${e}`))].map(B)).then((t=>({dict:t[0],railwayData:t[1],stationData:t[2],featureCollection:t[3],timetableData:t[4].concat(...t.slice(12)),railDirectionData:t[5],trainTypeData:t[6],trainVehicleData:t[7],operatorData:t[8],airportData:t[9],flightStatusData:t[10],poiData:t[11]})))}const LU=F(navigator.userAgent,"Windows");class RU{constructor(t){this._options=Object.assign({modal:!1},t)}setTitle(t){const e=this,i=e._container;return e._title=t,i&&(i.querySelector("#panel-title").innerHTML=t),e}setHTML(t){const e=this,i=e._container;return e._html=t,i&&(i.querySelector("#panel-content").innerHTML=t),e}setButtons(t){const e=this,i=e._container;if(e._buttons=t,i){const e=i.querySelector("#panel-button-group"),n=e.children;for(let t=n.length-1;t>0;t--)e.removeChild(n[t]);for(const i of t||[])e.appendChild(i)}return e}addTo(t){const e=this,i=e._options;if(e._map=t,i.modal){(e._background=W("div",{className:"modal-panel-background closed"},t.container)).addEventListener("click",(()=>{e.remove()}))}const n=e._container=W("div",{className:`panel closed ${i.className||""}`,innerHTML:['<div id="panel-header">','<div id="panel-title"></div>','<div id="panel-button-group" class="panel-button-group">',`<div id="panel-button" class="${i.modal?"close-button":"slide-button"}"></div>`,"</div>","</div>",`<div id="panel-body"${LU?' class="windows"':""}>`,'<div id="panel-content"></div>',"</div>"].join("")},t.container);return e._title&&e.setTitle(e._title),e._html&&e.setHTML(e._html),e._buttons&&e.setButtons(e._buttons),i.modal?n.querySelector("#panel-button").addEventListener("click",(()=>{e.remove()})):(n.querySelector("#panel-header").addEventListener("click",(()=>{const t=n.classList;t.contains("collapsed")?t.remove("collapsed"):t.add("collapsed")})),n.querySelector("#panel-header").style.cursor="pointer"),requestAnimationFrame((()=>{i.modal&&(e._background.classList.remove("closed"),n.style.height=`min(calc(100% - 10px), ${n.querySelector("#panel-content").offsetHeight+50}px)`),n.classList.remove("closed")})),e}remove(){const t=this,e=t._options,i=t._background,n=t._container;return e.modal&&i.classList.add("closed"),n.style.removeProperty("height"),n.classList.add("closed"),setTimeout((()=>{e.modal&&(i.parentNode.removeChild(i),delete t._background),n.parentNode.removeChild(n),delete t._container,delete t._map}),300),t}isOpen(){return!!this._map}}class BU extends RU{constructor(t){super(Object.assign({className:"about-panel",modal:!0},t))}addTo(t){return super.addTo(t).setTitle(t.dict.about).updateContent()}updateContent(){const t=this;if(t.isOpen()){const{dict:e,lastDynamicUpdate:i}=t._map;t.setHTML([e.description.replace(/<h3>.*<\/h3>/,""),`<p>${gt.copyright}</p>`,`<div class="card-title">${e["static-update"]}</div>`,`<div class="card-body">${gt.lastStaticUpdate}</div>`,`<div class="card-title">${e["dynamic-update"]}</div>`,'<div class="card-body">',i.Toei||"N/A",` (${e.toei})<br>`,i["HND-JAT"]||"N/A",` (${e["hnd-jat"]})<br>`,i["HND-TIAT"]||"N/A",` (${e["hnd-tiat"]})<br>`,i.NAA||"N/A",` (${e.naa})</div>`].join(""))}return t}}class DU extends RU{constructor(t){super(Object.assign({className:"layer-panel",modal:!0},t))}addTo(t){const e=this,i=e._options.layers;super.addTo(t).setTitle(t.dict.layers).setHTML(i.map((e=>[`<div id="${e.getId()}-layer" class="layer-row">`,'<div class="layer-icon"></div>',`<div>${e.getName(t.lang)}</div>`,"</div>"].join(""))).join(""));for(const t of i){const i=e._container.querySelector(`#${t.getId()}-layer .layer-icon`),n=i.classList;Object.assign(i.style,t.getIconStyle()),t.isEnabled()&&n.add("layer-icon-enabled"),i.addEventListener("click",(()=>{t.isEnabled()?(n.remove("layer-icon-enabled"),t.disable()):(n.add("layer-icon-enabled"),t.enable())}))}return e}}function OU(t){return null!==t&&"object"==typeof t&&"constructor"in t&&t.constructor===Object}function kU(t,e){void 0===t&&(t={}),void 0===e&&(e={}),Object.keys(e).forEach((i=>{void 0===t[i]?t[i]=e[i]:OU(e[i])&&OU(t[i])&&Object.keys(e[i]).length>0&&kU(t[i],e[i])}))}const FU={body:{},addEventListener(){},removeEventListener(){},activeElement:{blur(){},nodeName:""},querySelector:()=>null,querySelectorAll:()=>[],getElementById:()=>null,createEvent:()=>({initEvent(){}}),createElement:()=>({children:[],childNodes:[],style:{},setAttribute(){},getElementsByTagName:()=>[]}),createElementNS:()=>({}),importNode:()=>null,location:{hash:"",host:"",hostname:"",href:"",origin:"",pathname:"",protocol:"",search:""}};function zU(){const t="undefined"!=typeof document?document:{};return kU(t,FU),t}const NU={document:FU,navigator:{userAgent:""},location:{hash:"",host:"",hostname:"",href:"",origin:"",pathname:"",protocol:"",search:""},history:{replaceState(){},pushState(){},go(){},back(){}},CustomEvent:function(){return this},addEventListener(){},removeEventListener(){},getComputedStyle:()=>({getPropertyValue:()=>""}),Image(){},Date(){},screen:{},setTimeout(){},clearTimeout(){},matchMedia:()=>({}),requestAnimationFrame:t=>"undefined"==typeof setTimeout?(t(),null):setTimeout(t,0),cancelAnimationFrame(t){"undefined"!=typeof setTimeout&&clearTimeout(t)}};function UU(){const t="undefined"!=typeof window?window:{};return kU(t,NU),t}function GU(t,e){return void 0===e&&(e=0),setTimeout(t,e)}function VU(){return Date.now()}function jU(t,e){void 0===e&&(e="x");const i=UU();let n,r,s;const o=function(t){const e=UU();let i;return e.getComputedStyle&&(i=e.getComputedStyle(t,null)),!i&&t.currentStyle&&(i=t.currentStyle),i||(i=t.style),i}(t);return i.WebKitCSSMatrix?(r=o.transform||o.webkitTransform,r.split(",").length>6&&(r=r.split(", ").map((t=>t.replace(",","."))).join(", ")),s=new i.WebKitCSSMatrix("none"===r?"":r)):(s=o.MozTransform||o.OTransform||o.MsTransform||o.msTransform||o.transform||o.getPropertyValue("transform").replace("translate(","matrix(1, 0, 0, 1,"),n=s.toString().split(",")),"x"===e&&(r=i.WebKitCSSMatrix?s.m41:16===n.length?parseFloat(n[12]):parseFloat(n[4])),"y"===e&&(r=i.WebKitCSSMatrix?s.m42:16===n.length?parseFloat(n[13]):parseFloat(n[5])),r||0}function HU(t){return"object"==typeof t&&null!==t&&t.constructor&&"Object"===Object.prototype.toString.call(t).slice(8,-1)}function WU(t){return"undefined"!=typeof window&&void 0!==window.HTMLElement?t instanceof HTMLElement:t&&(1===t.nodeType||11===t.nodeType)}function qU(){const t=Object(arguments.length<=0?void 0:arguments[0]),e=["__proto__","constructor","prototype"];for(let i=1;i<arguments.length;i+=1){const n=i<0||arguments.length<=i?void 0:arguments[i];if(null!=n&&!WU(n)){const i=Object.keys(Object(n)).filter((t=>e.indexOf(t)<0));for(let e=0,r=i.length;e<r;e+=1){const r=i[e],s=Object.getOwnPropertyDescriptor(n,r);void 0!==s&&s.enumerable&&(HU(t[r])&&HU(n[r])?n[r].__swiper__?t[r]=n[r]:qU(t[r],n[r]):!HU(t[r])&&HU(n[r])?(t[r]={},n[r].__swiper__?t[r]=n[r]:qU(t[r],n[r])):t[r]=n[r])}}}return t}function XU(t,e,i){t.style.setProperty(e,i)}function ZU(t){let{swiper:e,targetPosition:i,side:n}=t;const r=UU(),s=-e.translate;let o,a=null;const l=e.params.speed;e.wrapperEl.style.scrollSnapType="none",r.cancelAnimationFrame(e.cssModeFrameID);const c=i>s?"next":"prev",h=(t,e)=>"next"===c&&t>=e||"prev"===c&&t<=e,u=()=>{o=(new Date).getTime(),null===a&&(a=o);const t=Math.max(Math.min((o-a)/l,1),0),c=.5-Math.cos(t*Math.PI)/2;let d=s+c*(i-s);if(h(d,i)&&(d=i),e.wrapperEl.scrollTo({[n]:d}),h(d,i))return e.wrapperEl.style.overflow="hidden",e.wrapperEl.style.scrollSnapType="",setTimeout((()=>{e.wrapperEl.style.overflow="",e.wrapperEl.scrollTo({[n]:d})})),void r.cancelAnimationFrame(e.cssModeFrameID);e.cssModeFrameID=r.requestAnimationFrame(u)};u()}function JU(t,e){return void 0===e&&(e=""),[...t.children].filter((t=>t.matches(e)))}function YU(t){try{return void console.warn(t)}catch(t){}}function $U(t,e){void 0===e&&(e=[]);const i=document.createElement(t);return i.classList.add(...Array.isArray(e)?e:function(t){return void 0===t&&(t=""),t.trim().split(" ").filter((t=>!!t.trim()))}(e)),i}function KU(t,e){return UU().getComputedStyle(t,null).getPropertyValue(e)}function QU(t){let e,i=t;if(i){for(e=0;null!==(i=i.previousSibling);)1===i.nodeType&&(e+=1);return e}}function tG(t,e){const i=[];let n=t.parentElement;for(;n;)e?n.matches(e)&&i.push(n):i.push(n),n=n.parentElement;return i}function eG(t,e,i){const n=UU();return i?t["width"===e?"offsetWidth":"offsetHeight"]+parseFloat(n.getComputedStyle(t,null).getPropertyValue("width"===e?"margin-right":"margin-top"))+parseFloat(n.getComputedStyle(t,null).getPropertyValue("width"===e?"margin-left":"margin-bottom")):t.offsetWidth}function iG(t){return(Array.isArray(t)?t:[t]).filter((t=>!!t))}let nG,rG,sG;function oG(){return nG||(nG=function(){const t=UU(),e=zU();return{smoothScroll:e.documentElement&&e.documentElement.style&&"scrollBehavior"in e.documentElement.style,touch:!!("ontouchstart"in t||t.DocumentTouch&&e instanceof t.DocumentTouch)}}()),nG}function aG(t){return void 0===t&&(t={}),rG||(rG=function(t){let{userAgent:e}=void 0===t?{}:t;const i=oG(),n=UU(),r=n.navigator.platform,s=e||n.navigator.userAgent,o={ios:!1,android:!1},a=n.screen.width,l=n.screen.height,c=s.match(/(Android);?[\s\/]+([\d.]+)?/);let h=s.match(/(iPad).*OS\s([\d_]+)/);const u=s.match(/(iPod)(.*OS\s([\d_]+))?/),d=!h&&s.match(/(iPhone\sOS|iOS)\s([\d_]+)/),p="Win32"===r;let f="MacIntel"===r;return!h&&f&&i.touch&&["1024x1366","1366x1024","834x1194","1194x834","834x1112","1112x834","768x1024","1024x768","820x1180","1180x820","810x1080","1080x810"].indexOf(`${a}x${l}`)>=0&&(h=s.match(/(Version)\/([\d.]+)/),h||(h=[0,1,"13_0_0"]),f=!1),c&&!p&&(o.os="android",o.android=!0),(h||d||u)&&(o.os="ios",o.ios=!0),o}(t)),rG}function lG(){return sG||(sG=function(){const t=UU(),e=aG();let i=!1;function n(){const e=t.navigator.userAgent.toLowerCase();return e.indexOf("safari")>=0&&e.indexOf("chrome")<0&&e.indexOf("android")<0}if(n()){const e=String(t.navigator.userAgent);if(e.includes("Version/")){const[t,n]=e.split("Version/")[1].split(" ")[0].split(".").map((t=>Number(t)));i=t<16||16===t&&n<2}}const r=/(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(t.navigator.userAgent),s=n();return{isSafari:i||s,needPerspectiveFix:i,need3dFix:s||r&&e.ios,isWebView:r}}()),sG}var cG={on(t,e,i){const n=this;if(!n.eventsListeners||n.destroyed)return n;if("function"!=typeof e)return n;const r=i?"unshift":"push";return t.split(" ").forEach((t=>{n.eventsListeners[t]||(n.eventsListeners[t]=[]),n.eventsListeners[t][r](e)})),n},once(t,e,i){const n=this;if(!n.eventsListeners||n.destroyed)return n;if("function"!=typeof e)return n;function r(){n.off(t,r),r.__emitterProxy&&delete r.__emitterProxy;for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];e.apply(n,s)}return r.__emitterProxy=e,n.on(t,r,i)},onAny(t,e){const i=this;if(!i.eventsListeners||i.destroyed)return i;if("function"!=typeof t)return i;const n=e?"unshift":"push";return i.eventsAnyListeners.indexOf(t)<0&&i.eventsAnyListeners[n](t),i},offAny(t){const e=this;if(!e.eventsListeners||e.destroyed)return e;if(!e.eventsAnyListeners)return e;const i=e.eventsAnyListeners.indexOf(t);return i>=0&&e.eventsAnyListeners.splice(i,1),e},off(t,e){const i=this;return!i.eventsListeners||i.destroyed?i:i.eventsListeners?(t.split(" ").forEach((t=>{void 0===e?i.eventsListeners[t]=[]:i.eventsListeners[t]&&i.eventsListeners[t].forEach(((n,r)=>{(n===e||n.__emitterProxy&&n.__emitterProxy===e)&&i.eventsListeners[t].splice(r,1)}))})),i):i},emit(){const t=this;if(!t.eventsListeners||t.destroyed)return t;if(!t.eventsListeners)return t;let e,i,n;for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];"string"==typeof s[0]||Array.isArray(s[0])?(e=s[0],i=s.slice(1,s.length),n=t):(e=s[0].events,i=s[0].data,n=s[0].context||t),i.unshift(n);return(Array.isArray(e)?e:e.split(" ")).forEach((e=>{t.eventsAnyListeners&&t.eventsAnyListeners.length&&t.eventsAnyListeners.forEach((t=>{t.apply(n,[e,...i])})),t.eventsListeners&&t.eventsListeners[e]&&t.eventsListeners[e].forEach((t=>{t.apply(n,i)}))})),t}};const hG=(t,e)=>{if(!t||t.destroyed||!t.params)return;const i=e.closest(t.isElement?"swiper-slide":`.${t.params.slideClass}`);if(i){let e=i.querySelector(`.${t.params.lazyPreloaderClass}`);!e&&t.isElement&&(i.shadowRoot?e=i.shadowRoot.querySelector(`.${t.params.lazyPreloaderClass}`):requestAnimationFrame((()=>{i.shadowRoot&&(e=i.shadowRoot.querySelector(`.${t.params.lazyPreloaderClass}`),e&&e.remove())}))),e&&e.remove()}},uG=(t,e)=>{if(!t.slides[e])return;const i=t.slides[e].querySelector('[loading="lazy"]');i&&i.removeAttribute("loading")},dG=t=>{if(!t||t.destroyed||!t.params)return;let e=t.params.lazyPreloadPrevNext;const i=t.slides.length;if(!i||!e||e<0)return;e=Math.min(e,i);const n="auto"===t.params.slidesPerView?t.slidesPerViewDynamic():Math.ceil(t.params.slidesPerView),r=t.activeIndex;if(t.params.grid&&t.params.grid.rows>1){const i=r,s=[i-e];return s.push(...Array.from({length:e}).map(((t,e)=>i+n+e))),void t.slides.forEach(((e,i)=>{s.includes(e.column)&&uG(t,i)}))}const s=r+n-1;if(t.params.rewind||t.params.loop)for(let n=r-e;n<=s+e;n+=1){const e=(n%i+i)%i;(e<r||e>s)&&uG(t,e)}else for(let n=Math.max(r-e,0);n<=Math.min(s+e,i-1);n+=1)n!==r&&(n>s||n<r)&&uG(t,n)};var pG={updateSize:function(){const t=this;let e,i;const n=t.el;e=null!=t.params.width?t.params.width:n.clientWidth,i=null!=t.params.height?t.params.height:n.clientHeight,0===e&&t.isHorizontal()||0===i&&t.isVertical()||(e=e-parseInt(KU(n,"padding-left")||0,10)-parseInt(KU(n,"padding-right")||0,10),i=i-parseInt(KU(n,"padding-top")||0,10)-parseInt(KU(n,"padding-bottom")||0,10),Number.isNaN(e)&&(e=0),Number.isNaN(i)&&(i=0),Object.assign(t,{width:e,height:i,size:t.isHorizontal()?e:i}))},updateSlides:function(){const t=this;function e(e,i){return parseFloat(e.getPropertyValue(t.getDirectionLabel(i))||0)}const i=t.params,{wrapperEl:n,slidesEl:r,size:s,rtlTranslate:o,wrongRTL:a}=t,l=t.virtual&&i.virtual.enabled,c=l?t.virtual.slides.length:t.slides.length,h=JU(r,`.${t.params.slideClass}, swiper-slide`),u=l?t.virtual.slides.length:h.length;let d=[];const p=[],f=[];let m=i.slidesOffsetBefore;"function"==typeof m&&(m=i.slidesOffsetBefore.call(t));let g=i.slidesOffsetAfter;"function"==typeof g&&(g=i.slidesOffsetAfter.call(t));const _=t.snapGrid.length,y=t.slidesGrid.length;let v=i.spaceBetween,x=-m,b=0,w=0;if(void 0===s)return;"string"==typeof v&&v.indexOf("%")>=0?v=parseFloat(v.replace("%",""))/100*s:"string"==typeof v&&(v=parseFloat(v)),t.virtualSize=-v,h.forEach((t=>{o?t.style.marginLeft="":t.style.marginRight="",t.style.marginBottom="",t.style.marginTop=""})),i.centeredSlides&&i.cssMode&&(XU(n,"--swiper-centered-offset-before",""),XU(n,"--swiper-centered-offset-after",""));const A=i.grid&&i.grid.rows>1&&t.grid;let T;A?t.grid.initSlides(h):t.grid&&t.grid.unsetSlides();const M="auto"===i.slidesPerView&&i.breakpoints&&Object.keys(i.breakpoints).filter((t=>void 0!==i.breakpoints[t].slidesPerView)).length>0;for(let n=0;n<u;n+=1){let r;if(T=0,h[n]&&(r=h[n]),A&&t.grid.updateSlide(n,r,h),!h[n]||"none"!==KU(r,"display")){if("auto"===i.slidesPerView){M&&(h[n].style[t.getDirectionLabel("width")]="");const s=getComputedStyle(r),o=r.style.transform,a=r.style.webkitTransform;if(o&&(r.style.transform="none"),a&&(r.style.webkitTransform="none"),i.roundLengths)T=t.isHorizontal()?eG(r,"width",!0):eG(r,"height",!0);else{const t=e(s,"width"),i=e(s,"padding-left"),n=e(s,"padding-right"),o=e(s,"margin-left"),a=e(s,"margin-right"),l=s.getPropertyValue("box-sizing");if(l&&"border-box"===l)T=t+o+a;else{const{clientWidth:e,offsetWidth:s}=r;T=t+i+n+o+a+(s-e)}}o&&(r.style.transform=o),a&&(r.style.webkitTransform=a),i.roundLengths&&(T=Math.floor(T))}else T=(s-(i.slidesPerView-1)*v)/i.slidesPerView,i.roundLengths&&(T=Math.floor(T)),h[n]&&(h[n].style[t.getDirectionLabel("width")]=`${T}px`);h[n]&&(h[n].swiperSlideSize=T),f.push(T),i.centeredSlides?(x=x+T/2+b/2+v,0===b&&0!==n&&(x=x-s/2-v),0===n&&(x=x-s/2-v),Math.abs(x)<.001&&(x=0),i.roundLengths&&(x=Math.floor(x)),w%i.slidesPerGroup==0&&d.push(x),p.push(x)):(i.roundLengths&&(x=Math.floor(x)),(w-Math.min(t.params.slidesPerGroupSkip,w))%t.params.slidesPerGroup==0&&d.push(x),p.push(x),x=x+T+v),t.virtualSize+=T+v,b=T,w+=1}}if(t.virtualSize=Math.max(t.virtualSize,s)+g,o&&a&&("slide"===i.effect||"coverflow"===i.effect)&&(n.style.width=`${t.virtualSize+v}px`),i.setWrapperSize&&(n.style[t.getDirectionLabel("width")]=`${t.virtualSize+v}px`),A&&t.grid.updateWrapperSize(T,d),!i.centeredSlides){const e=[];for(let n=0;n<d.length;n+=1){let r=d[n];i.roundLengths&&(r=Math.floor(r)),d[n]<=t.virtualSize-s&&e.push(r)}d=e,Math.floor(t.virtualSize-s)-Math.floor(d[d.length-1])>1&&d.push(t.virtualSize-s)}if(l&&i.loop){const e=f[0]+v;if(i.slidesPerGroup>1){const n=Math.ceil((t.virtual.slidesBefore+t.virtual.slidesAfter)/i.slidesPerGroup),r=e*i.slidesPerGroup;for(let t=0;t<n;t+=1)d.push(d[d.length-1]+r)}for(let n=0;n<t.virtual.slidesBefore+t.virtual.slidesAfter;n+=1)1===i.slidesPerGroup&&d.push(d[d.length-1]+e),p.push(p[p.length-1]+e),t.virtualSize+=e}if(0===d.length&&(d=[0]),0!==v){const e=t.isHorizontal()&&o?"marginLeft":t.getDirectionLabel("marginRight");h.filter(((t,e)=>!(i.cssMode&&!i.loop)||e!==h.length-1)).forEach((t=>{t.style[e]=`${v}px`}))}if(i.centeredSlides&&i.centeredSlidesBounds){let t=0;f.forEach((e=>{t+=e+(v||0)})),t-=v;const e=t-s;d=d.map((t=>t<=0?-m:t>e?e+g:t))}if(i.centerInsufficientSlides){let t=0;if(f.forEach((e=>{t+=e+(v||0)})),t-=v,t<s){const e=(s-t)/2;d.forEach(((t,i)=>{d[i]=t-e})),p.forEach(((t,i)=>{p[i]=t+e}))}}if(Object.assign(t,{slides:h,snapGrid:d,slidesGrid:p,slidesSizesGrid:f}),i.centeredSlides&&i.cssMode&&!i.centeredSlidesBounds){XU(n,"--swiper-centered-offset-before",-d[0]+"px"),XU(n,"--swiper-centered-offset-after",t.size/2-f[f.length-1]/2+"px");const e=-t.snapGrid[0],i=-t.slidesGrid[0];t.snapGrid=t.snapGrid.map((t=>t+e)),t.slidesGrid=t.slidesGrid.map((t=>t+i))}if(u!==c&&t.emit("slidesLengthChange"),d.length!==_&&(t.params.watchOverflow&&t.checkOverflow(),t.emit("snapGridLengthChange")),p.length!==y&&t.emit("slidesGridLengthChange"),i.watchSlidesProgress&&t.updateSlidesOffset(),t.emit("slidesUpdated"),!(l||i.cssMode||"slide"!==i.effect&&"fade"!==i.effect)){const e=`${i.containerModifierClass}backface-hidden`,n=t.el.classList.contains(e);u<=i.maxBackfaceHiddenSlides?n||t.el.classList.add(e):n&&t.el.classList.remove(e)}},updateAutoHeight:function(t){const e=this,i=[],n=e.virtual&&e.params.virtual.enabled;let r,s=0;"number"==typeof t?e.setTransition(t):!0===t&&e.setTransition(e.params.speed);const o=t=>n?e.slides[e.getSlideIndexByData(t)]:e.slides[t];if("auto"!==e.params.slidesPerView&&e.params.slidesPerView>1)if(e.params.centeredSlides)(e.visibleSlides||[]).forEach((t=>{i.push(t)}));else for(r=0;r<Math.ceil(e.params.slidesPerView);r+=1){const t=e.activeIndex+r;if(t>e.slides.length&&!n)break;i.push(o(t))}else i.push(o(e.activeIndex));for(r=0;r<i.length;r+=1)if(void 0!==i[r]){const t=i[r].offsetHeight;s=t>s?t:s}(s||0===s)&&(e.wrapperEl.style.height=`${s}px`)},updateSlidesOffset:function(){const t=this,e=t.slides,i=t.isElement?t.isHorizontal()?t.wrapperEl.offsetLeft:t.wrapperEl.offsetTop:0;for(let n=0;n<e.length;n+=1)e[n].swiperSlideOffset=(t.isHorizontal()?e[n].offsetLeft:e[n].offsetTop)-i-t.cssOverflowAdjustment()},updateSlidesProgress:function(t){void 0===t&&(t=this&&this.translate||0);const e=this,i=e.params,{slides:n,rtlTranslate:r,snapGrid:s}=e;if(0===n.length)return;void 0===n[0].swiperSlideOffset&&e.updateSlidesOffset();let o=-t;r&&(o=t),n.forEach((t=>{t.classList.remove(i.slideVisibleClass,i.slideFullyVisibleClass)})),e.visibleSlidesIndexes=[],e.visibleSlides=[];let a=i.spaceBetween;"string"==typeof a&&a.indexOf("%")>=0?a=parseFloat(a.replace("%",""))/100*e.size:"string"==typeof a&&(a=parseFloat(a));for(let t=0;t<n.length;t+=1){const l=n[t];let c=l.swiperSlideOffset;i.cssMode&&i.centeredSlides&&(c-=n[0].swiperSlideOffset);const h=(o+(i.centeredSlides?e.minTranslate():0)-c)/(l.swiperSlideSize+a),u=(o-s[0]+(i.centeredSlides?e.minTranslate():0)-c)/(l.swiperSlideSize+a),d=-(o-c),p=d+e.slidesSizesGrid[t],f=d>=0&&d<=e.size-e.slidesSizesGrid[t];(d>=0&&d<e.size-1||p>1&&p<=e.size||d<=0&&p>=e.size)&&(e.visibleSlides.push(l),e.visibleSlidesIndexes.push(t),n[t].classList.add(i.slideVisibleClass)),f&&n[t].classList.add(i.slideFullyVisibleClass),l.progress=r?-h:h,l.originalProgress=r?-u:u}},updateProgress:function(t){const e=this;if(void 0===t){t=e&&e.translate&&e.translate*(e.rtlTranslate?-1:1)||0}const i=e.params,n=e.maxTranslate()-e.minTranslate();let{progress:r,isBeginning:s,isEnd:o,progressLoop:a}=e;const l=s,c=o;if(0===n)r=0,s=!0,o=!0;else{r=(t-e.minTranslate())/n;const i=Math.abs(t-e.minTranslate())<1,a=Math.abs(t-e.maxTranslate())<1;s=i||r<=0,o=a||r>=1,i&&(r=0),a&&(r=1)}if(i.loop){const i=e.getSlideIndexByData(0),n=e.getSlideIndexByData(e.slides.length-1),r=e.slidesGrid[i],s=e.slidesGrid[n],o=e.slidesGrid[e.slidesGrid.length-1],l=Math.abs(t);a=l>=r?(l-r)/o:(l+o-s)/o,a>1&&(a-=1)}Object.assign(e,{progress:r,progressLoop:a,isBeginning:s,isEnd:o}),(i.watchSlidesProgress||i.centeredSlides&&i.autoHeight)&&e.updateSlidesProgress(t),s&&!l&&e.emit("reachBeginning toEdge"),o&&!c&&e.emit("reachEnd toEdge"),(l&&!s||c&&!o)&&e.emit("fromEdge"),e.emit("progress",r)},updateSlidesClasses:function(){const t=this,{slides:e,params:i,slidesEl:n,activeIndex:r}=t,s=t.virtual&&i.virtual.enabled,o=t.grid&&i.grid&&i.grid.rows>1,a=t=>JU(n,`.${i.slideClass}${t}, swiper-slide${t}`)[0];let l,c,h;if(e.forEach((t=>{t.classList.remove(i.slideActiveClass,i.slideNextClass,i.slidePrevClass)})),s)if(i.loop){let e=r-t.virtual.slidesBefore;e<0&&(e=t.virtual.slides.length+e),e>=t.virtual.slides.length&&(e-=t.virtual.slides.length),l=a(`[data-swiper-slide-index="${e}"]`)}else l=a(`[data-swiper-slide-index="${r}"]`);else o?(l=e.filter((t=>t.column===r))[0],h=e.filter((t=>t.column===r+1))[0],c=e.filter((t=>t.column===r-1))[0]):l=e[r];l&&(l.classList.add(i.slideActiveClass),o?(h&&h.classList.add(i.slideNextClass),c&&c.classList.add(i.slidePrevClass)):(h=function(t,e){const i=[];for(;t.nextElementSibling;){const n=t.nextElementSibling;e?n.matches(e)&&i.push(n):i.push(n),t=n}return i}(l,`.${i.slideClass}, swiper-slide`)[0],i.loop&&!h&&(h=e[0]),h&&h.classList.add(i.slideNextClass),c=function(t,e){const i=[];for(;t.previousElementSibling;){const n=t.previousElementSibling;e?n.matches(e)&&i.push(n):i.push(n),t=n}return i}(l,`.${i.slideClass}, swiper-slide`)[0],i.loop&&0===!c&&(c=e[e.length-1]),c&&c.classList.add(i.slidePrevClass))),t.emitSlidesClasses()},updateActiveIndex:function(t){const e=this,i=e.rtlTranslate?e.translate:-e.translate,{snapGrid:n,params:r,activeIndex:s,realIndex:o,snapIndex:a}=e;let l,c=t;const h=t=>{let i=t-e.virtual.slidesBefore;return i<0&&(i=e.virtual.slides.length+i),i>=e.virtual.slides.length&&(i-=e.virtual.slides.length),i};if(void 0===c&&(c=function(t){const{slidesGrid:e,params:i}=t,n=t.rtlTranslate?t.translate:-t.translate;let r;for(let t=0;t<e.length;t+=1)void 0!==e[t+1]?n>=e[t]&&n<e[t+1]-(e[t+1]-e[t])/2?r=t:n>=e[t]&&n<e[t+1]&&(r=t+1):n>=e[t]&&(r=t);return i.normalizeSlideIndex&&(r<0||void 0===r)&&(r=0),r}(e)),n.indexOf(i)>=0)l=n.indexOf(i);else{const t=Math.min(r.slidesPerGroupSkip,c);l=t+Math.floor((c-t)/r.slidesPerGroup)}if(l>=n.length&&(l=n.length-1),c===s&&!e.params.loop)return void(l!==a&&(e.snapIndex=l,e.emit("snapIndexChange")));if(c===s&&e.params.loop&&e.virtual&&e.params.virtual.enabled)return void(e.realIndex=h(c));const u=e.grid&&r.grid&&r.grid.rows>1;let d;if(e.virtual&&r.virtual.enabled&&r.loop)d=h(c);else if(u){const t=e.slides.filter((t=>t.column===c))[0];let i=parseInt(t.getAttribute("data-swiper-slide-index"),10);Number.isNaN(i)&&(i=Math.max(e.slides.indexOf(t),0)),d=Math.floor(i/r.grid.rows)}else if(e.slides[c]){const t=e.slides[c].getAttribute("data-swiper-slide-index");d=t?parseInt(t,10):c}else d=c;Object.assign(e,{previousSnapIndex:a,snapIndex:l,previousRealIndex:o,realIndex:d,previousIndex:s,activeIndex:c}),e.initialized&&dG(e),e.emit("activeIndexChange"),e.emit("snapIndexChange"),(e.initialized||e.params.runCallbacksOnInit)&&(o!==d&&e.emit("realIndexChange"),e.emit("slideChange"))},updateClickedSlide:function(t,e){const i=this,n=i.params;let r=t.closest(`.${n.slideClass}, swiper-slide`);!r&&i.isElement&&e&&e.length>1&&e.includes(t)&&[...e.slice(e.indexOf(t)+1,e.length)].forEach((t=>{!r&&t.matches&&t.matches(`.${n.slideClass}, swiper-slide`)&&(r=t)}));let s,o=!1;if(r)for(let t=0;t<i.slides.length;t+=1)if(i.slides[t]===r){o=!0,s=t;break}if(!r||!o)return i.clickedSlide=void 0,void(i.clickedIndex=void 0);i.clickedSlide=r,i.clickedIndex=i.virtual&&i.params.virtual.enabled?parseInt(r.getAttribute("data-swiper-slide-index"),10):s,n.slideToClickedSlide&&void 0!==i.clickedIndex&&i.clickedIndex!==i.activeIndex&&i.slideToClickedSlide()}};var fG={getTranslate:function(t){void 0===t&&(t=this.isHorizontal()?"x":"y");const{params:e,rtlTranslate:i,translate:n,wrapperEl:r}=this;if(e.virtualTranslate)return i?-n:n;if(e.cssMode)return n;let s=jU(r,t);return s+=this.cssOverflowAdjustment(),i&&(s=-s),s||0},setTranslate:function(t,e){const i=this,{rtlTranslate:n,params:r,wrapperEl:s,progress:o}=i;let a,l=0,c=0;i.isHorizontal()?l=n?-t:t:c=t,r.roundLengths&&(l=Math.floor(l),c=Math.floor(c)),i.previousTranslate=i.translate,i.translate=i.isHorizontal()?l:c,r.cssMode?s[i.isHorizontal()?"scrollLeft":"scrollTop"]=i.isHorizontal()?-l:-c:r.virtualTranslate||(i.isHorizontal()?l-=i.cssOverflowAdjustment():c-=i.cssOverflowAdjustment(),s.style.transform=`translate3d(${l}px, ${c}px, 0px)`);const h=i.maxTranslate()-i.minTranslate();a=0===h?0:(t-i.minTranslate())/h,a!==o&&i.updateProgress(t),i.emit("setTranslate",i.translate,e)},minTranslate:function(){return-this.snapGrid[0]},maxTranslate:function(){return-this.snapGrid[this.snapGrid.length-1]},translateTo:function(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=this.params.speed),void 0===i&&(i=!0),void 0===n&&(n=!0);const s=this,{params:o,wrapperEl:a}=s;if(s.animating&&o.preventInteractionOnTransition)return!1;const l=s.minTranslate(),c=s.maxTranslate();let h;if(h=n&&t>l?l:n&&t<c?c:t,s.updateProgress(h),o.cssMode){const t=s.isHorizontal();if(0===e)a[t?"scrollLeft":"scrollTop"]=-h;else{if(!s.support.smoothScroll)return ZU({swiper:s,targetPosition:-h,side:t?"left":"top"}),!0;a.scrollTo({[t?"left":"top"]:-h,behavior:"smooth"})}return!0}return 0===e?(s.setTransition(0),s.setTranslate(h),i&&(s.emit("beforeTransitionStart",e,r),s.emit("transitionEnd"))):(s.setTransition(e),s.setTranslate(h),i&&(s.emit("beforeTransitionStart",e,r),s.emit("transitionStart")),s.animating||(s.animating=!0,s.onTranslateToWrapperTransitionEnd||(s.onTranslateToWrapperTransitionEnd=function(t){s&&!s.destroyed&&t.target===this&&(s.wrapperEl.removeEventListener("transitionend",s.onTranslateToWrapperTransitionEnd),s.onTranslateToWrapperTransitionEnd=null,delete s.onTranslateToWrapperTransitionEnd,i&&s.emit("transitionEnd"))}),s.wrapperEl.addEventListener("transitionend",s.onTranslateToWrapperTransitionEnd))),!0}};function mG(t){let{swiper:e,runCallbacks:i,direction:n,step:r}=t;const{activeIndex:s,previousIndex:o}=e;let a=n;if(a||(a=s>o?"next":s<o?"prev":"reset"),e.emit(`transition${r}`),i&&s!==o){if("reset"===a)return void e.emit(`slideResetTransition${r}`);e.emit(`slideChangeTransition${r}`),e.emit("next"===a?`slideNextTransition${r}`:`slidePrevTransition${r}`)}}var gG={slideTo:function(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=this.params.speed),void 0===i&&(i=!0),"string"==typeof t&&(t=parseInt(t,10));const s=this;let o=t;o<0&&(o=0);const{params:a,snapGrid:l,slidesGrid:c,previousIndex:h,activeIndex:u,rtlTranslate:d,wrapperEl:p,enabled:f}=s;if(s.animating&&a.preventInteractionOnTransition||!f&&!n&&!r||s.destroyed)return!1;const m=Math.min(s.params.slidesPerGroupSkip,o);let g=m+Math.floor((o-m)/s.params.slidesPerGroup);g>=l.length&&(g=l.length-1);const _=-l[g];if(a.normalizeSlideIndex)for(let t=0;t<c.length;t+=1){const e=-Math.floor(100*_),i=Math.floor(100*c[t]),n=Math.floor(100*c[t+1]);void 0!==c[t+1]?e>=i&&e<n-(n-i)/2?o=t:e>=i&&e<n&&(o=t+1):e>=i&&(o=t)}if(s.initialized&&o!==u){if(!s.allowSlideNext&&(d?_>s.translate&&_>s.minTranslate():_<s.translate&&_<s.minTranslate()))return!1;if(!s.allowSlidePrev&&_>s.translate&&_>s.maxTranslate()&&(u||0)!==o)return!1}let y;if(o!==(h||0)&&i&&s.emit("beforeSlideChangeStart"),s.updateProgress(_),y=o>u?"next":o<u?"prev":"reset",d&&-_===s.translate||!d&&_===s.translate)return s.updateActiveIndex(o),a.autoHeight&&s.updateAutoHeight(),s.updateSlidesClasses(),"slide"!==a.effect&&s.setTranslate(_),"reset"!==y&&(s.transitionStart(i,y),s.transitionEnd(i,y)),!1;if(a.cssMode){const t=s.isHorizontal(),i=d?_:-_;if(0===e){const e=s.virtual&&s.params.virtual.enabled;e&&(s.wrapperEl.style.scrollSnapType="none",s._immediateVirtual=!0),e&&!s._cssModeVirtualInitialSet&&s.params.initialSlide>0?(s._cssModeVirtualInitialSet=!0,requestAnimationFrame((()=>{p[t?"scrollLeft":"scrollTop"]=i}))):p[t?"scrollLeft":"scrollTop"]=i,e&&requestAnimationFrame((()=>{s.wrapperEl.style.scrollSnapType="",s._immediateVirtual=!1}))}else{if(!s.support.smoothScroll)return ZU({swiper:s,targetPosition:i,side:t?"left":"top"}),!0;p.scrollTo({[t?"left":"top"]:i,behavior:"smooth"})}return!0}return s.setTransition(e),s.setTranslate(_),s.updateActiveIndex(o),s.updateSlidesClasses(),s.emit("beforeTransitionStart",e,n),s.transitionStart(i,y),0===e?s.transitionEnd(i,y):s.animating||(s.animating=!0,s.onSlideToWrapperTransitionEnd||(s.onSlideToWrapperTransitionEnd=function(t){s&&!s.destroyed&&t.target===this&&(s.wrapperEl.removeEventListener("transitionend",s.onSlideToWrapperTransitionEnd),s.onSlideToWrapperTransitionEnd=null,delete s.onSlideToWrapperTransitionEnd,s.transitionEnd(i,y))}),s.wrapperEl.addEventListener("transitionend",s.onSlideToWrapperTransitionEnd)),!0},slideToLoop:function(t,e,i,n){if(void 0===t&&(t=0),void 0===e&&(e=this.params.speed),void 0===i&&(i=!0),"string"==typeof t){t=parseInt(t,10)}const r=this;if(r.destroyed)return;const s=r.grid&&r.params.grid&&r.params.grid.rows>1;let o=t;if(r.params.loop)if(r.virtual&&r.params.virtual.enabled)o+=r.virtual.slidesBefore;else{let t;if(s){const e=o*r.params.grid.rows;t=r.slides.filter((t=>1*t.getAttribute("data-swiper-slide-index")===e))[0].column}else t=r.getSlideIndexByData(o);const e=s?Math.ceil(r.slides.length/r.params.grid.rows):r.slides.length,{centeredSlides:i}=r.params;let n=r.params.slidesPerView;"auto"===n?n=r.slidesPerViewDynamic():(n=Math.ceil(parseFloat(r.params.slidesPerView,10)),i&&n%2==0&&(n+=1));let a=e-t<n;if(i&&(a=a||t<Math.ceil(n/2)),a){const n=i?t<r.activeIndex?"prev":"next":t-r.activeIndex-1<r.params.slidesPerView?"next":"prev";r.loopFix({direction:n,slideTo:!0,activeSlideIndex:"next"===n?t+1:t-e+1,slideRealIndex:"next"===n?r.realIndex:void 0})}if(s){const t=o*r.params.grid.rows;o=r.slides.filter((e=>1*e.getAttribute("data-swiper-slide-index")===t))[0].column}else o=r.getSlideIndexByData(o)}return requestAnimationFrame((()=>{r.slideTo(o,e,i,n)})),r},slideNext:function(t,e,i){void 0===t&&(t=this.params.speed),void 0===e&&(e=!0);const n=this,{enabled:r,params:s,animating:o}=n;if(!r||n.destroyed)return n;let a=s.slidesPerGroup;"auto"===s.slidesPerView&&1===s.slidesPerGroup&&s.slidesPerGroupAuto&&(a=Math.max(n.slidesPerViewDynamic("current",!0),1));const l=n.activeIndex<s.slidesPerGroupSkip?1:a;if(s.loop){if(o&&!(n.virtual&&s.virtual.enabled)&&s.loopPreventsSliding)return!1;if(n.loopFix({direction:"next"}),n._clientLeft=n.wrapperEl.clientLeft,n.activeIndex===n.slides.length-1&&s.cssMode)return requestAnimationFrame((()=>{n.slideTo(n.activeIndex+l,t,e,i)})),!0}return n.slideTo(s.rewind&&n.isEnd?0:n.activeIndex+l,t,e,i)},slidePrev:function(t,e,i){void 0===t&&(t=this.params.speed),void 0===e&&(e=!0);const n=this,{params:r,snapGrid:s,slidesGrid:o,rtlTranslate:a,enabled:l,animating:c}=n;if(!l||n.destroyed)return n;if(r.loop){if(c&&!(n.virtual&&r.virtual.enabled)&&r.loopPreventsSliding)return!1;n.loopFix({direction:"prev"}),n._clientLeft=n.wrapperEl.clientLeft}function h(t){return t<0?-Math.floor(Math.abs(t)):Math.floor(t)}const u=h(a?n.translate:-n.translate),d=s.map((t=>h(t)));let p=s[d.indexOf(u)-1];if(void 0===p&&r.cssMode){let t;s.forEach(((e,i)=>{u>=e&&(t=i)})),void 0!==t&&(p=s[t>0?t-1:t])}let f=0;if(void 0!==p&&(f=o.indexOf(p),f<0&&(f=n.activeIndex-1),"auto"===r.slidesPerView&&1===r.slidesPerGroup&&r.slidesPerGroupAuto&&(f=f-n.slidesPerViewDynamic("previous",!0)+1,f=Math.max(f,0))),r.rewind&&n.isBeginning){return n.slideTo(n.params.virtual&&n.params.virtual.enabled&&n.virtual?n.virtual.slides.length-1:n.slides.length-1,t,e,i)}return r.loop&&0===n.activeIndex&&r.cssMode?(requestAnimationFrame((()=>{n.slideTo(f,t,e,i)})),!0):n.slideTo(f,t,e,i)},slideReset:function(t,e,i){void 0===t&&(t=this.params.speed),void 0===e&&(e=!0);const n=this;if(!n.destroyed)return n.slideTo(n.activeIndex,t,e,i)},slideToClosest:function(t,e,i,n){void 0===t&&(t=this.params.speed),void 0===e&&(e=!0),void 0===n&&(n=.5);const r=this;if(r.destroyed)return;let s=r.activeIndex;const o=Math.min(r.params.slidesPerGroupSkip,s),a=o+Math.floor((s-o)/r.params.slidesPerGroup),l=r.rtlTranslate?r.translate:-r.translate;if(l>=r.snapGrid[a]){const t=r.snapGrid[a];l-t>(r.snapGrid[a+1]-t)*n&&(s+=r.params.slidesPerGroup)}else{const t=r.snapGrid[a-1];l-t<=(r.snapGrid[a]-t)*n&&(s-=r.params.slidesPerGroup)}return s=Math.max(s,0),s=Math.min(s,r.slidesGrid.length-1),r.slideTo(s,t,e,i)},slideToClickedSlide:function(){const t=this;if(t.destroyed)return;const{params:e,slidesEl:i}=t,n="auto"===e.slidesPerView?t.slidesPerViewDynamic():e.slidesPerView;let r,s=t.clickedIndex;const o=t.isElement?"swiper-slide":`.${e.slideClass}`;if(e.loop){if(t.animating)return;r=parseInt(t.clickedSlide.getAttribute("data-swiper-slide-index"),10),e.centeredSlides?s<t.loopedSlides-n/2||s>t.slides.length-t.loopedSlides+n/2?(t.loopFix(),s=t.getSlideIndex(JU(i,`${o}[data-swiper-slide-index="${r}"]`)[0]),GU((()=>{t.slideTo(s)}))):t.slideTo(s):s>t.slides.length-n?(t.loopFix(),s=t.getSlideIndex(JU(i,`${o}[data-swiper-slide-index="${r}"]`)[0]),GU((()=>{t.slideTo(s)}))):t.slideTo(s)}else t.slideTo(s)}};var _G={loopCreate:function(t){const e=this,{params:i,slidesEl:n}=e;if(!i.loop||e.virtual&&e.params.virtual.enabled)return;const r=()=>{JU(n,`.${i.slideClass}, swiper-slide`).forEach(((t,e)=>{t.setAttribute("data-swiper-slide-index",e)}))},s=e.grid&&i.grid&&i.grid.rows>1,o=i.slidesPerGroup*(s?i.grid.rows:1),a=s&&e.slides.length%i.grid.rows!=0,l=t=>{for(let n=0;n<t;n+=1){const t=e.isElement?$U("swiper-slide",[i.slideBlankClass]):$U("div",[i.slideClass,i.slideBlankClass]);e.slidesEl.append(t)}};if(e.slides.length%o!=0){if(i.loopAddBlankSlides){l(o-e.slides.length%o),e.recalcSlides(),e.updateSlides()}else YU("Swiper Loop Warning: The number of slides is not even to slidesPerGroup, loop mode may not function properly. You need to add more slides (or make duplicates, or empty slides)");r()}else if(a){if(i.loopAddBlankSlides){l(i.grid.rows-e.slides.length%i.grid.rows),e.recalcSlides(),e.updateSlides()}else YU("Swiper Loop Warning: The number of slides is not even to grid.rows, loop mode may not function properly. You need to add more slides (or make duplicates, or empty slides)");r()}else r();e.loopFix({slideRealIndex:t,direction:i.centeredSlides?void 0:"next"})},loopFix:function(t){let{slideRealIndex:e,slideTo:i=!0,direction:n,setTranslate:r,activeSlideIndex:s,byController:o,byMousewheel:a}=void 0===t?{}:t;const l=this;if(!l.params.loop)return;l.emit("beforeLoopFix");const{slides:c,allowSlidePrev:h,allowSlideNext:u,slidesEl:d,params:p}=l,{centeredSlides:f}=p;if(l.allowSlidePrev=!0,l.allowSlideNext=!0,l.virtual&&p.virtual.enabled)return i&&(p.centeredSlides||0!==l.snapIndex?p.centeredSlides&&l.snapIndex<p.slidesPerView?l.slideTo(l.virtual.slides.length+l.snapIndex,0,!1,!0):l.snapIndex===l.snapGrid.length-1&&l.slideTo(l.virtual.slidesBefore,0,!1,!0):l.slideTo(l.virtual.slides.length,0,!1,!0)),l.allowSlidePrev=h,l.allowSlideNext=u,void l.emit("loopFix");let m=p.slidesPerView;"auto"===m?m=l.slidesPerViewDynamic():(m=Math.ceil(parseFloat(p.slidesPerView,10)),f&&m%2==0&&(m+=1));const g=p.slidesPerGroupAuto?m:p.slidesPerGroup;let _=g;_%g!=0&&(_+=g-_%g),_+=p.loopAdditionalSlides,l.loopedSlides=_;const y=l.grid&&p.grid&&p.grid.rows>1;c.length<m+_?YU("Swiper Loop Warning: The number of slides is not enough for loop mode, it will be disabled and not function properly. You need to add more slides (or make duplicates) or lower the values of slidesPerView and slidesPerGroup parameters"):y&&"row"===p.grid.fill&&YU("Swiper Loop Warning: Loop mode is not compatible with grid.fill = `row`");const v=[],x=[];let b=l.activeIndex;void 0===s?s=l.getSlideIndex(c.filter((t=>t.classList.contains(p.slideActiveClass)))[0]):b=s;const w="next"===n||!n,A="prev"===n||!n;let T=0,M=0;const S=y?Math.ceil(c.length/p.grid.rows):c.length,E=(y?c[s].column:s)+(f&&void 0===r?-m/2+.5:0);if(E<_){T=Math.max(_-E,g);for(let t=0;t<_-E;t+=1){const e=t-Math.floor(t/S)*S;if(y){const t=S-e-1;for(let e=c.length-1;e>=0;e-=1)c[e].column===t&&v.push(e)}else v.push(S-e-1)}}else if(E+m>S-_){M=Math.max(E-(S-2*_),g);for(let t=0;t<M;t+=1){const e=t-Math.floor(t/S)*S;y?c.forEach(((t,i)=>{t.column===e&&x.push(i)})):x.push(e)}}if(l.__preventObserver__=!0,requestAnimationFrame((()=>{l.__preventObserver__=!1})),A&&v.forEach((t=>{c[t].swiperLoopMoveDOM=!0,d.prepend(c[t]),c[t].swiperLoopMoveDOM=!1})),w&&x.forEach((t=>{c[t].swiperLoopMoveDOM=!0,d.append(c[t]),c[t].swiperLoopMoveDOM=!1})),l.recalcSlides(),"auto"===p.slidesPerView?l.updateSlides():y&&(v.length>0&&A||x.length>0&&w)&&l.slides.forEach(((t,e)=>{l.grid.updateSlide(e,t,l.slides)})),p.watchSlidesProgress&&l.updateSlidesOffset(),i)if(v.length>0&&A){if(void 0===e){const t=l.slidesGrid[b+T]-l.slidesGrid[b];a?l.setTranslate(l.translate-t):(l.slideTo(b+T,0,!1,!0),r&&(l.touchEventsData.startTranslate=l.touchEventsData.startTranslate-t,l.touchEventsData.currentTranslate=l.touchEventsData.currentTranslate-t))}else if(r){l.slideTo(l.activeIndex+(y?v.length/p.grid.rows:v.length),0,!1,!0),l.touchEventsData.currentTranslate=l.translate}}else if(x.length>0&&w)if(void 0===e){const t=l.slidesGrid[b-M]-l.slidesGrid[b];a?l.setTranslate(l.translate-t):(l.slideTo(b-M,0,!1,!0),r&&(l.touchEventsData.startTranslate=l.touchEventsData.startTranslate-t,l.touchEventsData.currentTranslate=l.touchEventsData.currentTranslate-t))}else{l.slideTo(l.activeIndex-(y?x.length/p.grid.rows:x.length),0,!1,!0)}if(l.allowSlidePrev=h,l.allowSlideNext=u,l.controller&&l.controller.control&&!o){const t={slideRealIndex:e,direction:n,setTranslate:r,activeSlideIndex:s,byController:!0};Array.isArray(l.controller.control)?l.controller.control.forEach((e=>{!e.destroyed&&e.params.loop&&e.loopFix({...t,slideTo:e.params.slidesPerView===p.slidesPerView&&i})})):l.controller.control instanceof l.constructor&&l.controller.control.params.loop&&l.controller.control.loopFix({...t,slideTo:l.controller.control.params.slidesPerView===p.slidesPerView&&i})}l.emit("loopFix")},loopDestroy:function(){const t=this,{params:e,slidesEl:i}=t;if(!e.loop||t.virtual&&t.params.virtual.enabled)return;t.recalcSlides();const n=[];t.slides.forEach((t=>{const e=void 0===t.swiperSlideIndex?1*t.getAttribute("data-swiper-slide-index"):t.swiperSlideIndex;n[e]=t})),t.slides.forEach((t=>{t.removeAttribute("data-swiper-slide-index")})),n.forEach((t=>{i.append(t)})),t.recalcSlides(),t.slideTo(t.realIndex,0)}};function yG(t,e,i){const n=UU(),{params:r}=t,s=r.edgeSwipeDetection,o=r.edgeSwipeThreshold;return!s||!(i<=o||i>=n.innerWidth-o)||"prevent"===s&&(e.preventDefault(),!0)}function vG(t){const e=this,i=zU();let n=t;n.originalEvent&&(n=n.originalEvent);const r=e.touchEventsData;if("pointerdown"===n.type){if(null!==r.pointerId&&r.pointerId!==n.pointerId)return;r.pointerId=n.pointerId}else"touchstart"===n.type&&1===n.targetTouches.length&&(r.touchId=n.targetTouches[0].identifier);if("touchstart"===n.type)return void yG(e,n,n.targetTouches[0].pageX);const{params:s,touches:o,enabled:a}=e;if(!a)return;if(!s.simulateTouch&&"mouse"===n.pointerType)return;if(e.animating&&s.preventInteractionOnTransition)return;!e.animating&&s.cssMode&&s.loop&&e.loopFix();let l=n.target;if("wrapper"===s.touchEventsTarget&&!e.wrapperEl.contains(l))return;if("which"in n&&3===n.which)return;if("button"in n&&n.button>0)return;if(r.isTouched&&r.isMoved)return;const c=!!s.noSwipingClass&&""!==s.noSwipingClass,h=n.composedPath?n.composedPath():n.path;c&&n.target&&n.target.shadowRoot&&h&&(l=h[0]);const u=s.noSwipingSelector?s.noSwipingSelector:`.${s.noSwipingClass}`;if(s.noSwiping&&(!(!n.target||!n.target.shadowRoot)?function(t,e){return void 0===e&&(e=this),function e(i){if(!i||i===zU()||i===UU())return null;i.assignedSlot&&(i=i.assignedSlot);const n=i.closest(t);return n||i.getRootNode?n||e(i.getRootNode().host):null}(e)}(u,l):l.closest(u)))return void(e.allowClick=!0);if(s.swipeHandler&&!l.closest(s.swipeHandler))return;o.currentX=n.pageX,o.currentY=n.pageY;const d=o.currentX,p=o.currentY;if(!yG(e,n,d))return;Object.assign(r,{isTouched:!0,isMoved:!1,allowTouchCallbacks:!0,isScrolling:void 0,startMoving:void 0}),o.startX=d,o.startY=p,r.touchStartTime=VU(),e.allowClick=!0,e.updateSize(),e.swipeDirection=void 0,s.threshold>0&&(r.allowThresholdMove=!1);let f=!0;l.matches(r.focusableElements)&&(f=!1,"SELECT"===l.nodeName&&(r.isTouched=!1)),i.activeElement&&i.activeElement.matches(r.focusableElements)&&i.activeElement!==l&&i.activeElement.blur();!s.touchStartForcePreventDefault&&!(f&&e.allowTouchMove&&s.touchStartPreventDefault)||l.isContentEditable||n.preventDefault(),s.freeMode&&s.freeMode.enabled&&e.freeMode&&e.animating&&!s.cssMode&&e.freeMode.onTouchStart(),e.emit("touchStart",n)}function xG(t){const e=zU(),i=this,n=i.touchEventsData,{params:r,touches:s,rtlTranslate:o,enabled:a}=i;if(!a)return;if(!r.simulateTouch&&"mouse"===t.pointerType)return;let l,c=t;if(c.originalEvent&&(c=c.originalEvent),"pointermove"===c.type){if(null!==n.touchId)return;if(c.pointerId!==n.pointerId)return}if("touchmove"===c.type){if(l=[...c.changedTouches].filter((t=>t.identifier===n.touchId))[0],!l||l.identifier!==n.touchId)return}else l=c;if(!n.isTouched)return void(n.startMoving&&n.isScrolling&&i.emit("touchMoveOpposite",c));const h=l.pageX,u=l.pageY;if(c.preventedByNestedSwiper)return s.startX=h,void(s.startY=u);if(!i.allowTouchMove)return c.target.matches(n.focusableElements)||(i.allowClick=!1),void(n.isTouched&&(Object.assign(s,{startX:h,startY:u,currentX:h,currentY:u}),n.touchStartTime=VU()));if(r.touchReleaseOnEdges&&!r.loop)if(i.isVertical()){if(u<s.startY&&i.translate<=i.maxTranslate()||u>s.startY&&i.translate>=i.minTranslate())return n.isTouched=!1,void(n.isMoved=!1)}else if(h<s.startX&&i.translate<=i.maxTranslate()||h>s.startX&&i.translate>=i.minTranslate())return;if(e.activeElement&&c.target===e.activeElement&&c.target.matches(n.focusableElements))return n.isMoved=!0,void(i.allowClick=!1);n.allowTouchCallbacks&&i.emit("touchMove",c),s.previousX=s.currentX,s.previousY=s.currentY,s.currentX=h,s.currentY=u;const d=s.currentX-s.startX,p=s.currentY-s.startY;if(i.params.threshold&&Math.sqrt(d**2+p**2)<i.params.threshold)return;if(void 0===n.isScrolling){let t;i.isHorizontal()&&s.currentY===s.startY||i.isVertical()&&s.currentX===s.startX?n.isScrolling=!1:d*d+p*p>=25&&(t=180*Math.atan2(Math.abs(p),Math.abs(d))/Math.PI,n.isScrolling=i.isHorizontal()?t>r.touchAngle:90-t>r.touchAngle)}if(n.isScrolling&&i.emit("touchMoveOpposite",c),void 0===n.startMoving&&(s.currentX===s.startX&&s.currentY===s.startY||(n.startMoving=!0)),n.isScrolling)return void(n.isTouched=!1);if(!n.startMoving)return;i.allowClick=!1,!r.cssMode&&c.cancelable&&c.preventDefault(),r.touchMoveStopPropagation&&!r.nested&&c.stopPropagation();let f=i.isHorizontal()?d:p,m=i.isHorizontal()?s.currentX-s.previousX:s.currentY-s.previousY;r.oneWayMovement&&(f=Math.abs(f)*(o?1:-1),m=Math.abs(m)*(o?1:-1)),s.diff=f,f*=r.touchRatio,o&&(f=-f,m=-m);const g=i.touchesDirection;i.swipeDirection=f>0?"prev":"next",i.touchesDirection=m>0?"prev":"next";const _=i.params.loop&&!r.cssMode,y="next"===i.touchesDirection&&i.allowSlideNext||"prev"===i.touchesDirection&&i.allowSlidePrev;if(!n.isMoved){if(_&&y&&i.loopFix({direction:i.swipeDirection}),n.startTranslate=i.getTranslate(),i.setTransition(0),i.animating){const t=new window.CustomEvent("transitionend",{bubbles:!0,cancelable:!0});i.wrapperEl.dispatchEvent(t)}n.allowMomentumBounce=!1,!r.grabCursor||!0!==i.allowSlideNext&&!0!==i.allowSlidePrev||i.setGrabCursor(!0),i.emit("sliderFirstMove",c)}if((new Date).getTime(),n.isMoved&&n.allowThresholdMove&&g!==i.touchesDirection&&_&&y&&Math.abs(f)>=1)return Object.assign(s,{startX:h,startY:u,currentX:h,currentY:u,startTranslate:n.currentTranslate}),n.loopSwapReset=!0,void(n.startTranslate=n.currentTranslate);i.emit("sliderMove",c),n.isMoved=!0,n.currentTranslate=f+n.startTranslate;let v=!0,x=r.resistanceRatio;if(r.touchReleaseOnEdges&&(x=0),f>0?(_&&y&&n.allowThresholdMove&&n.currentTranslate>(r.centeredSlides?i.minTranslate()-i.slidesSizesGrid[i.activeIndex+1]:i.minTranslate())&&i.loopFix({direction:"prev",setTranslate:!0,activeSlideIndex:0}),n.currentTranslate>i.minTranslate()&&(v=!1,r.resistance&&(n.currentTranslate=i.minTranslate()-1+(-i.minTranslate()+n.startTranslate+f)**x))):f<0&&(_&&y&&n.allowThresholdMove&&n.currentTranslate<(r.centeredSlides?i.maxTranslate()+i.slidesSizesGrid[i.slidesSizesGrid.length-1]:i.maxTranslate())&&i.loopFix({direction:"next",setTranslate:!0,activeSlideIndex:i.slides.length-("auto"===r.slidesPerView?i.slidesPerViewDynamic():Math.ceil(parseFloat(r.slidesPerView,10)))}),n.currentTranslate<i.maxTranslate()&&(v=!1,r.resistance&&(n.currentTranslate=i.maxTranslate()+1-(i.maxTranslate()-n.startTranslate-f)**x))),v&&(c.preventedByNestedSwiper=!0),!i.allowSlideNext&&"next"===i.swipeDirection&&n.currentTranslate<n.startTranslate&&(n.currentTranslate=n.startTranslate),!i.allowSlidePrev&&"prev"===i.swipeDirection&&n.currentTranslate>n.startTranslate&&(n.currentTranslate=n.startTranslate),i.allowSlidePrev||i.allowSlideNext||(n.currentTranslate=n.startTranslate),r.threshold>0){if(!(Math.abs(f)>r.threshold||n.allowThresholdMove))return void(n.currentTranslate=n.startTranslate);if(!n.allowThresholdMove)return n.allowThresholdMove=!0,s.startX=s.currentX,s.startY=s.currentY,n.currentTranslate=n.startTranslate,void(s.diff=i.isHorizontal()?s.currentX-s.startX:s.currentY-s.startY)}r.followFinger&&!r.cssMode&&((r.freeMode&&r.freeMode.enabled&&i.freeMode||r.watchSlidesProgress)&&(i.updateActiveIndex(),i.updateSlidesClasses()),r.freeMode&&r.freeMode.enabled&&i.freeMode&&i.freeMode.onTouchMove(),i.updateProgress(n.currentTranslate),i.setTranslate(n.currentTranslate))}function bG(t){const e=this,i=e.touchEventsData;let n,r=t;r.originalEvent&&(r=r.originalEvent);if("touchend"===r.type||"touchcancel"===r.type){if(n=[...r.changedTouches].filter((t=>t.identifier===i.touchId))[0],!n||n.identifier!==i.touchId)return}else{if(null!==i.touchId)return;if(r.pointerId!==i.pointerId)return;n=r}if(["pointercancel","pointerout","pointerleave","contextmenu"].includes(r.type)){if(!(["pointercancel","contextmenu"].includes(r.type)&&(e.browser.isSafari||e.browser.isWebView)))return}i.pointerId=null,i.touchId=null;const{params:s,touches:o,rtlTranslate:a,slidesGrid:l,enabled:c}=e;if(!c)return;if(!s.simulateTouch&&"mouse"===r.pointerType)return;if(i.allowTouchCallbacks&&e.emit("touchEnd",r),i.allowTouchCallbacks=!1,!i.isTouched)return i.isMoved&&s.grabCursor&&e.setGrabCursor(!1),i.isMoved=!1,void(i.startMoving=!1);s.grabCursor&&i.isMoved&&i.isTouched&&(!0===e.allowSlideNext||!0===e.allowSlidePrev)&&e.setGrabCursor(!1);const h=VU(),u=h-i.touchStartTime;if(e.allowClick){const t=r.path||r.composedPath&&r.composedPath();e.updateClickedSlide(t&&t[0]||r.target,t),e.emit("tap click",r),u<300&&h-i.lastClickTime<300&&e.emit("doubleTap doubleClick",r)}if(i.lastClickTime=VU(),GU((()=>{e.destroyed||(e.allowClick=!0)})),!i.isTouched||!i.isMoved||!e.swipeDirection||0===o.diff&&!i.loopSwapReset||i.currentTranslate===i.startTranslate&&!i.loopSwapReset)return i.isTouched=!1,i.isMoved=!1,void(i.startMoving=!1);let d;if(i.isTouched=!1,i.isMoved=!1,i.startMoving=!1,d=s.followFinger?a?e.translate:-e.translate:-i.currentTranslate,s.cssMode)return;if(s.freeMode&&s.freeMode.enabled)return void e.freeMode.onTouchEnd({currentPos:d});const p=d>=-e.maxTranslate()&&!e.params.loop;let f=0,m=e.slidesSizesGrid[0];for(let t=0;t<l.length;t+=t<s.slidesPerGroupSkip?1:s.slidesPerGroup){const e=t<s.slidesPerGroupSkip-1?1:s.slidesPerGroup;void 0!==l[t+e]?(p||d>=l[t]&&d<l[t+e])&&(f=t,m=l[t+e]-l[t]):(p||d>=l[t])&&(f=t,m=l[l.length-1]-l[l.length-2])}let g=null,_=null;s.rewind&&(e.isBeginning?_=s.virtual&&s.virtual.enabled&&e.virtual?e.virtual.slides.length-1:e.slides.length-1:e.isEnd&&(g=0));const y=(d-l[f])/m,v=f<s.slidesPerGroupSkip-1?1:s.slidesPerGroup;if(u>s.longSwipesMs){if(!s.longSwipes)return void e.slideTo(e.activeIndex);"next"===e.swipeDirection&&e.slideTo(y>=s.longSwipesRatio?s.rewind&&e.isEnd?g:f+v:f),"prev"===e.swipeDirection&&(y>1-s.longSwipesRatio?e.slideTo(f+v):null!==_&&y<0&&Math.abs(y)>s.longSwipesRatio?e.slideTo(_):e.slideTo(f))}else{if(!s.shortSwipes)return void e.slideTo(e.activeIndex);e.navigation&&(r.target===e.navigation.nextEl||r.target===e.navigation.prevEl)?e.slideTo(r.target===e.navigation.nextEl?f+v:f):("next"===e.swipeDirection&&e.slideTo(null!==g?g:f+v),"prev"===e.swipeDirection&&e.slideTo(null!==_?_:f))}}function wG(){const t=this,{params:e,el:i}=t;if(i&&0===i.offsetWidth)return;e.breakpoints&&t.setBreakpoint();const{allowSlideNext:n,allowSlidePrev:r,snapGrid:s}=t,o=t.virtual&&t.params.virtual.enabled;t.allowSlideNext=!0,t.allowSlidePrev=!0,t.updateSize(),t.updateSlides(),t.updateSlidesClasses();!("auto"===e.slidesPerView||e.slidesPerView>1)||!t.isEnd||t.isBeginning||t.params.centeredSlides||o&&e.loop?t.params.loop&&!o?t.slideToLoop(t.realIndex,0,!1,!0):t.slideTo(t.activeIndex,0,!1,!0):t.slideTo(t.slides.length-1,0,!1,!0),t.autoplay&&t.autoplay.running&&t.autoplay.paused&&(clearTimeout(t.autoplay.resizeTimeout),t.autoplay.resizeTimeout=setTimeout((()=>{t.autoplay&&t.autoplay.running&&t.autoplay.paused&&t.autoplay.resume()}),500)),t.allowSlidePrev=r,t.allowSlideNext=n,t.params.watchOverflow&&s!==t.snapGrid&&t.checkOverflow()}function AG(t){const e=this;e.enabled&&(e.allowClick||(e.params.preventClicks&&t.preventDefault(),e.params.preventClicksPropagation&&e.animating&&(t.stopPropagation(),t.stopImmediatePropagation())))}function TG(){const t=this,{wrapperEl:e,rtlTranslate:i,enabled:n}=t;if(!n)return;let r;t.previousTranslate=t.translate,t.translate=t.isHorizontal()?-e.scrollLeft:-e.scrollTop,0===t.translate&&(t.translate=0),t.updateActiveIndex(),t.updateSlidesClasses();const s=t.maxTranslate()-t.minTranslate();r=0===s?0:(t.translate-t.minTranslate())/s,r!==t.progress&&t.updateProgress(i?-t.translate:t.translate),t.emit("setTranslate",t.translate,!1)}function MG(t){const e=this;hG(e,t.target),e.params.cssMode||"auto"!==e.params.slidesPerView&&!e.params.autoHeight||e.update()}function SG(){const t=this;t.documentTouchHandlerProceeded||(t.documentTouchHandlerProceeded=!0,t.params.touchReleaseOnEdges&&(t.el.style.touchAction="auto"))}const EG=(t,e)=>{const i=zU(),{params:n,el:r,wrapperEl:s,device:o}=t,a=!!n.nested,l="on"===e?"addEventListener":"removeEventListener",c=e;i[l]("touchstart",t.onDocumentTouchStart,{passive:!1,capture:a}),r[l]("touchstart",t.onTouchStart,{passive:!1}),r[l]("pointerdown",t.onTouchStart,{passive:!1}),i[l]("touchmove",t.onTouchMove,{passive:!1,capture:a}),i[l]("pointermove",t.onTouchMove,{passive:!1,capture:a}),i[l]("touchend",t.onTouchEnd,{passive:!0}),i[l]("pointerup",t.onTouchEnd,{passive:!0}),i[l]("pointercancel",t.onTouchEnd,{passive:!0}),i[l]("touchcancel",t.onTouchEnd,{passive:!0}),i[l]("pointerout",t.onTouchEnd,{passive:!0}),i[l]("pointerleave",t.onTouchEnd,{passive:!0}),i[l]("contextmenu",t.onTouchEnd,{passive:!0}),(n.preventClicks||n.preventClicksPropagation)&&r[l]("click",t.onClick,!0),n.cssMode&&s[l]("scroll",t.onScroll),t[c](n.updateOnWindowResize?o.ios||o.android?"resize orientationchange observerUpdate":"resize observerUpdate":"observerUpdate",wG,!0),r[l]("load",t.onLoad,{capture:!0})};const CG=(t,e)=>t.grid&&e.grid&&e.grid.rows>1;var IG={setBreakpoint:function(){const t=this,{realIndex:e,initialized:i,params:n,el:r}=t,s=n.breakpoints;if(!s||s&&0===Object.keys(s).length)return;const o=t.getBreakpoint(s,t.params.breakpointsBase,t.el);if(!o||t.currentBreakpoint===o)return;const a=(o in s?s[o]:void 0)||t.originalParams,l=CG(t,n),c=CG(t,a),h=n.enabled;l&&!c?(r.classList.remove(`${n.containerModifierClass}grid`,`${n.containerModifierClass}grid-column`),t.emitContainerClasses()):!l&&c&&(r.classList.add(`${n.containerModifierClass}grid`),(a.grid.fill&&"column"===a.grid.fill||!a.grid.fill&&"column"===n.grid.fill)&&r.classList.add(`${n.containerModifierClass}grid-column`),t.emitContainerClasses()),["navigation","pagination","scrollbar"].forEach((e=>{if(void 0===a[e])return;const i=n[e]&&n[e].enabled,r=a[e]&&a[e].enabled;i&&!r&&t[e].disable(),!i&&r&&t[e].enable()}));const u=a.direction&&a.direction!==n.direction,d=n.loop&&(a.slidesPerView!==n.slidesPerView||u),p=n.loop;u&&i&&t.changeDirection(),qU(t.params,a);const f=t.params.enabled,m=t.params.loop;Object.assign(t,{allowTouchMove:t.params.allowTouchMove,allowSlideNext:t.params.allowSlideNext,allowSlidePrev:t.params.allowSlidePrev}),h&&!f?t.disable():!h&&f&&t.enable(),t.currentBreakpoint=o,t.emit("_beforeBreakpoint",a),i&&(d?(t.loopDestroy(),t.loopCreate(e),t.updateSlides()):!p&&m?(t.loopCreate(e),t.updateSlides()):p&&!m&&t.loopDestroy()),t.emit("breakpoint",a)},getBreakpoint:function(t,e,i){if(void 0===e&&(e="window"),!t||"container"===e&&!i)return;let n=!1;const r=UU(),s="window"===e?r.innerHeight:i.clientHeight,o=Object.keys(t).map((t=>{if("string"==typeof t&&0===t.indexOf("@")){const e=parseFloat(t.substr(1));return{value:s*e,point:t}}return{value:t,point:t}}));o.sort(((t,e)=>parseInt(t.value,10)-parseInt(e.value,10)));for(let t=0;t<o.length;t+=1){const{point:s,value:a}=o[t];"window"===e?r.matchMedia(`(min-width: ${a}px)`).matches&&(n=s):a<=i.clientWidth&&(n=s)}return n||"max"}};var PG={init:!0,direction:"horizontal",oneWayMovement:!1,swiperElementNodeName:"SWIPER-CONTAINER",touchEventsTarget:"wrapper",initialSlide:0,speed:300,cssMode:!1,updateOnWindowResize:!0,resizeObserver:!0,nested:!1,createElements:!1,eventsPrefix:"swiper",enabled:!0,focusableElements:"input, select, option, textarea, button, video, label",width:null,height:null,preventInteractionOnTransition:!1,userAgent:null,url:null,edgeSwipeDetection:!1,edgeSwipeThreshold:20,autoHeight:!1,setWrapperSize:!1,virtualTranslate:!1,effect:"slide",breakpoints:void 0,breakpointsBase:"window",spaceBetween:0,slidesPerView:1,slidesPerGroup:1,slidesPerGroupSkip:0,slidesPerGroupAuto:!1,centeredSlides:!1,centeredSlidesBounds:!1,slidesOffsetBefore:0,slidesOffsetAfter:0,normalizeSlideIndex:!0,centerInsufficientSlides:!1,watchOverflow:!0,roundLengths:!1,touchRatio:1,touchAngle:45,simulateTouch:!0,shortSwipes:!0,longSwipes:!0,longSwipesRatio:.5,longSwipesMs:300,followFinger:!0,allowTouchMove:!0,threshold:5,touchMoveStopPropagation:!1,touchStartPreventDefault:!0,touchStartForcePreventDefault:!1,touchReleaseOnEdges:!1,uniqueNavElements:!0,resistance:!0,resistanceRatio:.85,watchSlidesProgress:!1,grabCursor:!1,preventClicks:!0,preventClicksPropagation:!0,slideToClickedSlide:!1,loop:!1,loopAddBlankSlides:!0,loopAdditionalSlides:0,loopPreventsSliding:!0,rewind:!1,allowSlidePrev:!0,allowSlideNext:!0,swipeHandler:null,noSwiping:!0,noSwipingClass:"swiper-no-swiping",noSwipingSelector:null,passiveListeners:!0,maxBackfaceHiddenSlides:10,containerModifierClass:"swiper-",slideClass:"swiper-slide",slideBlankClass:"swiper-slide-blank",slideActiveClass:"swiper-slide-active",slideVisibleClass:"swiper-slide-visible",slideFullyVisibleClass:"swiper-slide-fully-visible",slideNextClass:"swiper-slide-next",slidePrevClass:"swiper-slide-prev",wrapperClass:"swiper-wrapper",lazyPreloaderClass:"swiper-lazy-preloader",lazyPreloadPrevNext:0,runCallbacksOnInit:!0,_emitClasses:!1};function LG(t,e){return function(i){void 0===i&&(i={});const n=Object.keys(i)[0],r=i[n];"object"==typeof r&&null!==r?(!0===t[n]&&(t[n]={enabled:!0}),"navigation"===n&&t[n]&&t[n].enabled&&!t[n].prevEl&&!t[n].nextEl&&(t[n].auto=!0),["pagination","scrollbar"].indexOf(n)>=0&&t[n]&&t[n].enabled&&!t[n].el&&(t[n].auto=!0),n in t&&"enabled"in r?("object"!=typeof t[n]||"enabled"in t[n]||(t[n].enabled=!0),t[n]||(t[n]={enabled:!1}),qU(e,i)):qU(e,i)):qU(e,i)}}const RG={eventsEmitter:cG,update:pG,translate:fG,transition:{setTransition:function(t,e){const i=this;i.params.cssMode||(i.wrapperEl.style.transitionDuration=`${t}ms`,i.wrapperEl.style.transitionDelay=0===t?"0ms":""),i.emit("setTransition",t,e)},transitionStart:function(t,e){void 0===t&&(t=!0);const i=this,{params:n}=i;n.cssMode||(n.autoHeight&&i.updateAutoHeight(),mG({swiper:i,runCallbacks:t,direction:e,step:"Start"}))},transitionEnd:function(t,e){void 0===t&&(t=!0);const i=this,{params:n}=i;i.animating=!1,n.cssMode||(i.setTransition(0),mG({swiper:i,runCallbacks:t,direction:e,step:"End"}))}},slide:gG,loop:_G,grabCursor:{setGrabCursor:function(t){const e=this;if(!e.params.simulateTouch||e.params.watchOverflow&&e.isLocked||e.params.cssMode)return;const i="container"===e.params.touchEventsTarget?e.el:e.wrapperEl;e.isElement&&(e.__preventObserver__=!0),i.style.cursor="move",i.style.cursor=t?"grabbing":"grab",e.isElement&&requestAnimationFrame((()=>{e.__preventObserver__=!1}))},unsetGrabCursor:function(){const t=this;t.params.watchOverflow&&t.isLocked||t.params.cssMode||(t.isElement&&(t.__preventObserver__=!0),t["container"===t.params.touchEventsTarget?"el":"wrapperEl"].style.cursor="",t.isElement&&requestAnimationFrame((()=>{t.__preventObserver__=!1})))}},events:{attachEvents:function(){const t=this,{params:e}=t;t.onTouchStart=vG.bind(t),t.onTouchMove=xG.bind(t),t.onTouchEnd=bG.bind(t),t.onDocumentTouchStart=SG.bind(t),e.cssMode&&(t.onScroll=TG.bind(t)),t.onClick=AG.bind(t),t.onLoad=MG.bind(t),EG(t,"on")},detachEvents:function(){EG(this,"off")}},breakpoints:IG,checkOverflow:{checkOverflow:function(){const t=this,{isLocked:e,params:i}=t,{slidesOffsetBefore:n}=i;if(n){const e=t.slides.length-1;t.isLocked=t.size>t.slidesGrid[e]+t.slidesSizesGrid[e]+2*n}else t.isLocked=1===t.snapGrid.length;!0===i.allowSlideNext&&(t.allowSlideNext=!t.isLocked),!0===i.allowSlidePrev&&(t.allowSlidePrev=!t.isLocked),e&&e!==t.isLocked&&(t.isEnd=!1),e!==t.isLocked&&t.emit(t.isLocked?"lock":"unlock")}},classes:{addClasses:function(){const t=this,{classNames:e,params:i,rtl:n,el:r,device:s}=t,o=function(t,e){const i=[];return t.forEach((t=>{"object"==typeof t?Object.keys(t).forEach((n=>{t[n]&&i.push(e+n)})):"string"==typeof t&&i.push(e+t)})),i}(["initialized",i.direction,{"free-mode":t.params.freeMode&&i.freeMode.enabled},{autoheight:i.autoHeight},{rtl:n},{grid:i.grid&&i.grid.rows>1},{"grid-column":i.grid&&i.grid.rows>1&&"column"===i.grid.fill},{android:s.android},{ios:s.ios},{"css-mode":i.cssMode},{centered:i.cssMode&&i.centeredSlides},{"watch-progress":i.watchSlidesProgress}],i.containerModifierClass);e.push(...o),r.classList.add(...e),t.emitContainerClasses()},removeClasses:function(){const{el:t,classNames:e}=this;t.classList.remove(...e),this.emitContainerClasses()}}},BG={};class DG{constructor(){let t,e;for(var i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];1===n.length&&n[0].constructor&&"Object"===Object.prototype.toString.call(n[0]).slice(8,-1)?e=n[0]:[t,e]=n,e||(e={}),e=qU({},e),t&&!e.el&&(e.el=t);const s=zU();if(e.el&&"string"==typeof e.el&&s.querySelectorAll(e.el).length>1){const t=[];return s.querySelectorAll(e.el).forEach((i=>{const n=qU({},e,{el:i});t.push(new DG(n))})),t}const o=this;o.__swiper__=!0,o.support=oG(),o.device=aG({userAgent:e.userAgent}),o.browser=lG(),o.eventsListeners={},o.eventsAnyListeners=[],o.modules=[...o.__modules__],e.modules&&Array.isArray(e.modules)&&o.modules.push(...e.modules);const a={};o.modules.forEach((t=>{t({params:e,swiper:o,extendParams:LG(e,a),on:o.on.bind(o),once:o.once.bind(o),off:o.off.bind(o),emit:o.emit.bind(o)})}));const l=qU({},PG,a);return o.params=qU({},l,BG,e),o.originalParams=qU({},o.params),o.passedParams=qU({},e),o.params&&o.params.on&&Object.keys(o.params.on).forEach((t=>{o.on(t,o.params.on[t])})),o.params&&o.params.onAny&&o.onAny(o.params.onAny),Object.assign(o,{enabled:o.params.enabled,el:t,classNames:[],slides:[],slidesGrid:[],snapGrid:[],slidesSizesGrid:[],isHorizontal:()=>"horizontal"===o.params.direction,isVertical:()=>"vertical"===o.params.direction,activeIndex:0,realIndex:0,isBeginning:!0,isEnd:!1,translate:0,previousTranslate:0,progress:0,velocity:0,animating:!1,cssOverflowAdjustment(){return Math.trunc(this.translate/2**23)*2**23},allowSlideNext:o.params.allowSlideNext,allowSlidePrev:o.params.allowSlidePrev,touchEventsData:{isTouched:void 0,isMoved:void 0,allowTouchCallbacks:void 0,touchStartTime:void 0,isScrolling:void 0,currentTranslate:void 0,startTranslate:void 0,allowThresholdMove:void 0,focusableElements:o.params.focusableElements,lastClickTime:0,clickTimeout:void 0,velocities:[],allowMomentumBounce:void 0,startMoving:void 0,pointerId:null,touchId:null},allowClick:!0,allowTouchMove:o.params.allowTouchMove,touches:{startX:0,startY:0,currentX:0,currentY:0,diff:0},imagesToLoad:[],imagesLoaded:0}),o.emit("_swiper"),o.params.init&&o.init(),o}getDirectionLabel(t){return this.isHorizontal()?t:{width:"height","margin-top":"margin-left","margin-bottom ":"margin-right","margin-left":"margin-top","margin-right":"margin-bottom","padding-left":"padding-top","padding-right":"padding-bottom",marginRight:"marginBottom"}[t]}getSlideIndex(t){const{slidesEl:e,params:i}=this,n=QU(JU(e,`.${i.slideClass}, swiper-slide`)[0]);return QU(t)-n}getSlideIndexByData(t){return this.getSlideIndex(this.slides.filter((e=>1*e.getAttribute("data-swiper-slide-index")===t))[0])}recalcSlides(){const{slidesEl:t,params:e}=this;this.slides=JU(t,`.${e.slideClass}, swiper-slide`)}enable(){const t=this;t.enabled||(t.enabled=!0,t.params.grabCursor&&t.setGrabCursor(),t.emit("enable"))}disable(){const t=this;t.enabled&&(t.enabled=!1,t.params.grabCursor&&t.unsetGrabCursor(),t.emit("disable"))}setProgress(t,e){const i=this;t=Math.min(Math.max(t,0),1);const n=i.minTranslate(),r=i.maxTranslate();i.translateTo((r-n)*t+n,void 0===e?0:e),i.updateActiveIndex(),i.updateSlidesClasses()}emitContainerClasses(){const t=this;if(!t.params._emitClasses||!t.el)return;const e=t.el.className.split(" ").filter((e=>0===e.indexOf("swiper")||0===e.indexOf(t.params.containerModifierClass)));t.emit("_containerClasses",e.join(" "))}getSlideClasses(t){const e=this;return e.destroyed?"":t.className.split(" ").filter((t=>0===t.indexOf("swiper-slide")||0===t.indexOf(e.params.slideClass))).join(" ")}emitSlidesClasses(){const t=this;if(!t.params._emitClasses||!t.el)return;const e=[];t.slides.forEach((i=>{const n=t.getSlideClasses(i);e.push({slideEl:i,classNames:n}),t.emit("_slideClass",i,n)})),t.emit("_slideClasses",e)}slidesPerViewDynamic(t,e){void 0===t&&(t="current"),void 0===e&&(e=!1);const{params:i,slides:n,slidesGrid:r,slidesSizesGrid:s,size:o,activeIndex:a}=this;let l=1;if("number"==typeof i.slidesPerView)return i.slidesPerView;if(i.centeredSlides){let t,e=n[a]?Math.ceil(n[a].swiperSlideSize):0;for(let i=a+1;i<n.length;i+=1)n[i]&&!t&&(e+=Math.ceil(n[i].swiperSlideSize),l+=1,e>o&&(t=!0));for(let i=a-1;i>=0;i-=1)n[i]&&!t&&(e+=n[i].swiperSlideSize,l+=1,e>o&&(t=!0))}else if("current"===t)for(let t=a+1;t<n.length;t+=1){(e?r[t]+s[t]-r[a]<o:r[t]-r[a]<o)&&(l+=1)}else for(let t=a-1;t>=0;t-=1){r[a]-r[t]<o&&(l+=1)}return l}update(){const t=this;if(!t||t.destroyed)return;const{snapGrid:e,params:i}=t;function n(){const e=Math.min(Math.max(t.rtlTranslate?-1*t.translate:t.translate,t.maxTranslate()),t.minTranslate());t.setTranslate(e),t.updateActiveIndex(),t.updateSlidesClasses()}let r;if(i.breakpoints&&t.setBreakpoint(),[...t.el.querySelectorAll('[loading="lazy"]')].forEach((e=>{e.complete&&hG(t,e)})),t.updateSize(),t.updateSlides(),t.updateProgress(),t.updateSlidesClasses(),i.freeMode&&i.freeMode.enabled&&!i.cssMode)n(),i.autoHeight&&t.updateAutoHeight();else{if(("auto"===i.slidesPerView||i.slidesPerView>1)&&t.isEnd&&!i.centeredSlides){r=t.slideTo((t.virtual&&i.virtual.enabled?t.virtual.slides:t.slides).length-1,0,!1,!0)}else r=t.slideTo(t.activeIndex,0,!1,!0);r||n()}i.watchOverflow&&e!==t.snapGrid&&t.checkOverflow(),t.emit("update")}changeDirection(t,e){void 0===e&&(e=!0);const i=this,n=i.params.direction;return t||(t="horizontal"===n?"vertical":"horizontal"),t===n||"horizontal"!==t&&"vertical"!==t||(i.el.classList.remove(`${i.params.containerModifierClass}${n}`),i.el.classList.add(`${i.params.containerModifierClass}${t}`),i.emitContainerClasses(),i.params.direction=t,i.slides.forEach((e=>{"vertical"===t?e.style.width="":e.style.height=""})),i.emit("changeDirection"),e&&i.update()),i}changeLanguageDirection(t){const e=this;e.rtl&&"rtl"===t||!e.rtl&&"ltr"===t||(e.rtl="rtl"===t,e.rtlTranslate="horizontal"===e.params.direction&&e.rtl,e.rtl?(e.el.classList.add(`${e.params.containerModifierClass}rtl`),e.el.dir="rtl"):(e.el.classList.remove(`${e.params.containerModifierClass}rtl`),e.el.dir="ltr"),e.update())}mount(t){const e=this;if(e.mounted)return!0;let i=t||e.params.el;if("string"==typeof i&&(i=document.querySelector(i)),!i)return!1;i.swiper=e,i.parentNode&&i.parentNode.host&&i.parentNode.host.nodeName===e.params.swiperElementNodeName.toUpperCase()&&(e.isElement=!0);const n=()=>`.${(e.params.wrapperClass||"").trim().split(" ").join(".")}`;let r=(()=>{if(i&&i.shadowRoot&&i.shadowRoot.querySelector){return i.shadowRoot.querySelector(n())}return JU(i,n())[0]})();return!r&&e.params.createElements&&(r=$U("div",e.params.wrapperClass),i.append(r),JU(i,`.${e.params.slideClass}`).forEach((t=>{r.append(t)}))),Object.assign(e,{el:i,wrapperEl:r,slidesEl:e.isElement&&!i.parentNode.host.slideSlots?i.parentNode.host:r,hostEl:e.isElement?i.parentNode.host:i,mounted:!0,rtl:"rtl"===i.dir.toLowerCase()||"rtl"===KU(i,"direction"),rtlTranslate:"horizontal"===e.params.direction&&("rtl"===i.dir.toLowerCase()||"rtl"===KU(i,"direction")),wrongRTL:"-webkit-box"===KU(r,"display")}),!0}init(t){const e=this;if(e.initialized)return e;if(!1===e.mount(t))return e;e.emit("beforeInit"),e.params.breakpoints&&e.setBreakpoint(),e.addClasses(),e.updateSize(),e.updateSlides(),e.params.watchOverflow&&e.checkOverflow(),e.params.grabCursor&&e.enabled&&e.setGrabCursor(),e.slideTo(e.params.loop&&e.virtual&&e.params.virtual.enabled?e.params.initialSlide+e.virtual.slidesBefore:e.params.initialSlide,0,e.params.runCallbacksOnInit,!1,!0),e.params.loop&&e.loopCreate(),e.attachEvents();const i=[...e.el.querySelectorAll('[loading="lazy"]')];return e.isElement&&i.push(...e.hostEl.querySelectorAll('[loading="lazy"]')),i.forEach((t=>{t.complete?hG(e,t):t.addEventListener("load",(t=>{hG(e,t.target)}))})),dG(e),e.initialized=!0,dG(e),e.emit("init"),e.emit("afterInit"),e}destroy(t,e){void 0===t&&(t=!0),void 0===e&&(e=!0);const i=this,{params:n,el:r,wrapperEl:s,slides:o}=i;return void 0===i.params||i.destroyed||(i.emit("beforeDestroy"),i.initialized=!1,i.detachEvents(),n.loop&&i.loopDestroy(),e&&(i.removeClasses(),r.removeAttribute("style"),s.removeAttribute("style"),o&&o.length&&o.forEach((t=>{t.classList.remove(n.slideVisibleClass,n.slideFullyVisibleClass,n.slideActiveClass,n.slideNextClass,n.slidePrevClass),t.removeAttribute("style"),t.removeAttribute("data-swiper-slide-index")}))),i.emit("destroy"),Object.keys(i.eventsListeners).forEach((t=>{i.off(t)})),!1!==t&&(i.el.swiper=null,function(t){const e=t;Object.keys(e).forEach((t=>{try{e[t]=null}catch(t){}try{delete e[t]}catch(t){}}))}(i)),i.destroyed=!0),null}static extendDefaults(t){qU(BG,t)}static get extendedDefaults(){return BG}static get defaults(){return PG}static installModule(t){DG.prototype.__modules__||(DG.prototype.__modules__=[]);const e=DG.prototype.__modules__;"function"==typeof t&&e.indexOf(t)<0&&e.push(t)}static use(t){return Array.isArray(t)?(t.forEach((t=>DG.installModule(t))),DG):(DG.installModule(t),DG)}}function OG(t){return void 0===t&&(t=""),`.${t.trim().replace(/([\.:!+\/])/g,"\\$1").replace(/ /g,".")}`}function kG(t){let{swiper:e,extendParams:i,on:n,emit:r}=t;const s="swiper-pagination";let o;i({pagination:{el:null,bulletElement:"span",clickable:!1,hideOnClick:!1,renderBullet:null,renderProgressbar:null,renderFraction:null,renderCustom:null,progressbarOpposite:!1,type:"bullets",dynamicBullets:!1,dynamicMainBullets:1,formatFractionCurrent:t=>t,formatFractionTotal:t=>t,bulletClass:`${s}-bullet`,bulletActiveClass:`${s}-bullet-active`,modifierClass:`${s}-`,currentClass:`${s}-current`,totalClass:`${s}-total`,hiddenClass:`${s}-hidden`,progressbarFillClass:`${s}-progressbar-fill`,progressbarOppositeClass:`${s}-progressbar-opposite`,clickableClass:`${s}-clickable`,lockClass:`${s}-lock`,horizontalClass:`${s}-horizontal`,verticalClass:`${s}-vertical`,paginationDisabledClass:`${s}-disabled`}}),e.pagination={el:null,bullets:[]};let a=0;function l(){return!e.params.pagination.el||!e.pagination.el||Array.isArray(e.pagination.el)&&0===e.pagination.el.length}function c(t,i){const{bulletActiveClass:n}=e.params.pagination;t&&(t=t[("prev"===i?"previous":"next")+"ElementSibling"])&&(t.classList.add(`${n}-${i}`),(t=t[("prev"===i?"previous":"next")+"ElementSibling"])&&t.classList.add(`${n}-${i}-${i}`))}function h(t){const i=t.target.closest(OG(e.params.pagination.bulletClass));if(!i)return;t.preventDefault();const n=QU(i)*e.params.slidesPerGroup;if(e.params.loop){if(e.realIndex===n)return;e.slideToLoop(n)}else e.slideTo(n)}function u(){const t=e.rtl,i=e.params.pagination;if(l())return;let n,s,h=e.pagination.el;h=iG(h);const u=e.params.loop?Math.ceil((e.virtual&&e.params.virtual.enabled?e.virtual.slides.length:e.slides.length)/e.params.slidesPerGroup):e.snapGrid.length;if(e.params.loop?(s=e.previousRealIndex||0,n=e.params.slidesPerGroup>1?Math.floor(e.realIndex/e.params.slidesPerGroup):e.realIndex):void 0!==e.snapIndex?(n=e.snapIndex,s=e.previousSnapIndex):(s=e.previousIndex||0,n=e.activeIndex||0),"bullets"===i.type&&e.pagination.bullets&&e.pagination.bullets.length>0){const r=e.pagination.bullets;let l,u,d;if(i.dynamicBullets&&(o=eG(r[0],e.isHorizontal()?"width":"height",!0),h.forEach((t=>{t.style[e.isHorizontal()?"width":"height"]=o*(i.dynamicMainBullets+4)+"px"})),i.dynamicMainBullets>1&&void 0!==s&&(a+=n-(s||0),a>i.dynamicMainBullets-1?a=i.dynamicMainBullets-1:a<0&&(a=0)),l=Math.max(n-a,0),u=l+(Math.min(r.length,i.dynamicMainBullets)-1),d=(u+l)/2),r.forEach((t=>{const e=[...["","-next","-next-next","-prev","-prev-prev","-main"].map((t=>`${i.bulletActiveClass}${t}`))].map((t=>"string"==typeof t&&t.includes(" ")?t.split(" "):t)).flat();t.classList.remove(...e)})),h.length>1)r.forEach((t=>{const r=QU(t);r===n?t.classList.add(...i.bulletActiveClass.split(" ")):e.isElement&&t.setAttribute("part","bullet"),i.dynamicBullets&&(r>=l&&r<=u&&t.classList.add(...`${i.bulletActiveClass}-main`.split(" ")),r===l&&c(t,"prev"),r===u&&c(t,"next"))}));else{const t=r[n];if(t&&t.classList.add(...i.bulletActiveClass.split(" ")),e.isElement&&r.forEach(((t,e)=>{t.setAttribute("part",e===n?"bullet-active":"bullet")})),i.dynamicBullets){const t=r[l],e=r[u];for(let t=l;t<=u;t+=1)r[t]&&r[t].classList.add(...`${i.bulletActiveClass}-main`.split(" "));c(t,"prev"),c(e,"next")}}if(i.dynamicBullets){const n=Math.min(r.length,i.dynamicMainBullets+4),s=(o*n-o)/2-d*o,a=t?"right":"left";r.forEach((t=>{t.style[e.isHorizontal()?a:"top"]=`${s}px`}))}}h.forEach(((t,s)=>{if("fraction"===i.type&&(t.querySelectorAll(OG(i.currentClass)).forEach((t=>{t.textContent=i.formatFractionCurrent(n+1)})),t.querySelectorAll(OG(i.totalClass)).forEach((t=>{t.textContent=i.formatFractionTotal(u)}))),"progressbar"===i.type){let r;r=i.progressbarOpposite?e.isHorizontal()?"vertical":"horizontal":e.isHorizontal()?"horizontal":"vertical";const s=(n+1)/u;let o=1,a=1;"horizontal"===r?o=s:a=s,t.querySelectorAll(OG(i.progressbarFillClass)).forEach((t=>{t.style.transform=`translate3d(0,0,0) scaleX(${o}) scaleY(${a})`,t.style.transitionDuration=`${e.params.speed}ms`}))}"custom"===i.type&&i.renderCustom?(t.innerHTML=i.renderCustom(e,n+1,u),0===s&&r("paginationRender",t)):(0===s&&r("paginationRender",t),r("paginationUpdate",t)),e.params.watchOverflow&&e.enabled&&t.classList[e.isLocked?"add":"remove"](i.lockClass)}))}function d(){const t=e.params.pagination;if(l())return;const i=e.virtual&&e.params.virtual.enabled?e.virtual.slides.length:e.grid&&e.params.grid.rows>1?e.slides.length/Math.ceil(e.params.grid.rows):e.slides.length;let n=e.pagination.el;n=iG(n);let s="";if("bullets"===t.type){let n=e.params.loop?Math.ceil(i/e.params.slidesPerGroup):e.snapGrid.length;e.params.freeMode&&e.params.freeMode.enabled&&n>i&&(n=i);for(let i=0;i<n;i+=1)s+=t.renderBullet?t.renderBullet.call(e,i,t.bulletClass):`<${t.bulletElement} ${e.isElement?'part="bullet"':""} class="${t.bulletClass}"></${t.bulletElement}>`}"fraction"===t.type&&(s=t.renderFraction?t.renderFraction.call(e,t.currentClass,t.totalClass):`<span class="${t.currentClass}"></span> / <span class="${t.totalClass}"></span>`),"progressbar"===t.type&&(s=t.renderProgressbar?t.renderProgressbar.call(e,t.progressbarFillClass):`<span class="${t.progressbarFillClass}"></span>`),e.pagination.bullets=[],n.forEach((i=>{"custom"!==t.type&&(i.innerHTML=s||""),"bullets"===t.type&&e.pagination.bullets.push(...i.querySelectorAll(OG(t.bulletClass)))})),"custom"!==t.type&&r("paginationRender",n[0])}function p(){e.params.pagination=function(t,e,i,n){return t.params.createElements&&Object.keys(n).forEach((r=>{if(!i[r]&&!0===i.auto){let s=JU(t.el,`.${n[r]}`)[0];s||(s=$U("div",n[r]),s.className=n[r],t.el.append(s)),i[r]=s,e[r]=s}})),i}(e,e.originalParams.pagination,e.params.pagination,{el:"swiper-pagination"});const t=e.params.pagination;if(!t.el)return;let i;"string"==typeof t.el&&e.isElement&&(i=e.el.querySelector(t.el)),i||"string"!=typeof t.el||(i=[...document.querySelectorAll(t.el)]),i||(i=t.el),i&&0!==i.length&&(e.params.uniqueNavElements&&"string"==typeof t.el&&Array.isArray(i)&&i.length>1&&(i=[...e.el.querySelectorAll(t.el)],i.length>1&&(i=i.filter((t=>tG(t,".swiper")[0]===e.el))[0])),Array.isArray(i)&&1===i.length&&(i=i[0]),Object.assign(e.pagination,{el:i}),i=iG(i),i.forEach((i=>{"bullets"===t.type&&t.clickable&&i.classList.add(...(t.clickableClass||"").split(" ")),i.classList.add(t.modifierClass+t.type),i.classList.add(e.isHorizontal()?t.horizontalClass:t.verticalClass),"bullets"===t.type&&t.dynamicBullets&&(i.classList.add(`${t.modifierClass}${t.type}-dynamic`),a=0,t.dynamicMainBullets<1&&(t.dynamicMainBullets=1)),"progressbar"===t.type&&t.progressbarOpposite&&i.classList.add(t.progressbarOppositeClass),t.clickable&&i.addEventListener("click",h),e.enabled||i.classList.add(t.lockClass)})))}function f(){const t=e.params.pagination;if(l())return;let i=e.pagination.el;i&&(i=iG(i),i.forEach((i=>{i.classList.remove(t.hiddenClass),i.classList.remove(t.modifierClass+t.type),i.classList.remove(e.isHorizontal()?t.horizontalClass:t.verticalClass),t.clickable&&(i.classList.remove(...(t.clickableClass||"").split(" ")),i.removeEventListener("click",h))}))),e.pagination.bullets&&e.pagination.bullets.forEach((e=>e.classList.remove(...t.bulletActiveClass.split(" "))))}n("changeDirection",(()=>{if(!e.pagination||!e.pagination.el)return;const t=e.params.pagination;let{el:i}=e.pagination;i=iG(i),i.forEach((i=>{i.classList.remove(t.horizontalClass,t.verticalClass),i.classList.add(e.isHorizontal()?t.horizontalClass:t.verticalClass)}))})),n("init",(()=>{!1===e.params.pagination.enabled?m():(p(),d(),u())})),n("activeIndexChange",(()=>{void 0===e.snapIndex&&u()})),n("snapIndexChange",(()=>{u()})),n("snapGridLengthChange",(()=>{d(),u()})),n("destroy",(()=>{f()})),n("enable disable",(()=>{let{el:t}=e.pagination;t&&(t=iG(t),t.forEach((t=>t.classList[e.enabled?"remove":"add"](e.params.pagination.lockClass))))})),n("lock unlock",(()=>{u()})),n("click",((t,i)=>{const n=i.target,s=iG(e.pagination.el);if(e.params.pagination.el&&e.params.pagination.hideOnClick&&s&&s.length>0&&!n.classList.contains(e.params.pagination.bulletClass)){if(e.navigation&&(e.navigation.nextEl&&n===e.navigation.nextEl||e.navigation.prevEl&&n===e.navigation.prevEl))return;const t=s[0].classList.contains(e.params.pagination.hiddenClass);r(!0===t?"paginationShow":"paginationHide"),s.forEach((t=>t.classList.toggle(e.params.pagination.hiddenClass)))}}));const m=()=>{e.el.classList.add(e.params.pagination.paginationDisabledClass);let{el:t}=e.pagination;t&&(t=iG(t),t.forEach((t=>t.classList.add(e.params.pagination.paginationDisabledClass)))),f()};Object.assign(e.pagination,{enable:()=>{e.el.classList.remove(e.params.pagination.paginationDisabledClass);let{el:t}=e.pagination;t&&(t=iG(t),t.forEach((t=>t.classList.remove(e.params.pagination.paginationDisabledClass)))),p(),d(),u()},disable:m,render:d,update:u,init:p,destroy:f})}Object.keys(RG).forEach((t=>{Object.keys(RG[t]).forEach((e=>{DG.prototype[e]=RG[t][e]}))})),DG.use([function(t){let{swiper:e,on:i,emit:n}=t;const r=UU();let s=null,o=null;const a=()=>{e&&!e.destroyed&&e.initialized&&(n("beforeResize"),n("resize"))},l=()=>{e&&!e.destroyed&&e.initialized&&n("orientationchange")};i("init",(()=>{e.params.resizeObserver&&void 0!==r.ResizeObserver?e&&!e.destroyed&&e.initialized&&(s=new ResizeObserver((t=>{o=r.requestAnimationFrame((()=>{const{width:i,height:n}=e;let r=i,s=n;t.forEach((t=>{let{contentBoxSize:i,contentRect:n,target:o}=t;o&&o!==e.el||(r=n?n.width:(i[0]||i).inlineSize,s=n?n.height:(i[0]||i).blockSize)})),r===i&&s===n||a()}))})),s.observe(e.el)):(r.addEventListener("resize",a),r.addEventListener("orientationchange",l))})),i("destroy",(()=>{o&&r.cancelAnimationFrame(o),s&&s.unobserve&&e.el&&(s.unobserve(e.el),s=null),r.removeEventListener("resize",a),r.removeEventListener("orientationchange",l)}))},function(t){let{swiper:e,extendParams:i,on:n,emit:r}=t;const s=[],o=UU(),a=function(t,i){void 0===i&&(i={});const n=new(o.MutationObserver||o.WebkitMutationObserver)((t=>{if(e.__preventObserver__)return;if(1===t.length)return void r("observerUpdate",t[0]);const i=function(){r("observerUpdate",t[0])};o.requestAnimationFrame?o.requestAnimationFrame(i):o.setTimeout(i,0)}));n.observe(t,{attributes:void 0===i.attributes||i.attributes,childList:void 0===i.childList||i.childList,characterData:void 0===i.characterData||i.characterData}),s.push(n)};i({observer:!1,observeParents:!1,observeSlideChildren:!1}),n("init",(()=>{if(e.params.observer){if(e.params.observeParents){const t=tG(e.hostEl);for(let e=0;e<t.length;e+=1)a(t[e])}a(e.hostEl,{childList:e.params.observeSlideChildren}),a(e.wrapperEl,{attributes:!1})}})),n("destroy",(()=>{s.forEach((t=>{t.disconnect()})),s.splice(0,s.length)}))}]);class FG extends RU{constructor(t){super(Object.assign({className:"search-panel"},t))}addTo(t){const e=this,{lang:i,dict:n}=t,r=t.clock.getJSTDate(),s=r.getMonth()+1,o=r.getDate(),a=r.getHours(),l=r.getMinutes();t.trackObject(),super.addTo(t).setHTML(['<div id="search-form">',`<div class="search-form-element">${n["from-station"]} <input id="origin" class="search-input" type="text" list="stations"></div>`,`<div class="search-form-element">${n["to-station"]} <input id="destination" class="search-input" type="text" list="stations"></div>`,'<div class="search-form-element">','<select id="type" class="search-select">',`<option value="departure" selected>${n["depart-at"]}</option>`,"</select>",'<select id="month" class="search-select">',`<option value="${s}" selected>${r.toLocaleDateString(i,{month:"short"})}</option>`,"</select>",'<select id="date" class="search-select">',`<option value="${o}" selected>${r.toLocaleDateString(i,{day:"numeric"})}</option>`,"</select>",'<select id="hours" class="search-select"></select>','<select id="minutes" class="search-select"></select>',"</div>",`<div class="search-form-element"><button id="search-button" class="search-button">${n["search-route"]}</button></div>`,"</div>",'<div id="search-load">','<div class="ball-pulse"><div></div><div></div><div></div></div>',"</div>",'<div id="search-result" class="swiper">','<div class="swiper-wrapper"></div>','<div class="swiper-pagination"></div>',"</div>"].join(""));const c=e._container,h=c.querySelector("#origin"),u=c.querySelector("#destination"),d=c.querySelector("#hours"),p=c.querySelector("#minutes"),f=c.querySelector("#search-button"),m=({target:t})=>{t.style.borderColor="#777",t.value?(delete e.focus,t.classList.remove("search-focus")):(e.focus=t.id,t.classList.add("search-focus"))},g=({target:t})=>{h.classList.remove("search-focus"),u.classList.remove("search-focus"),e.focus=t.id,t.classList.add("search-focus")};h.addEventListener("input",m),h.addEventListener("focus",g),u.addEventListener("input",m),u.addEventListener("focus",g),h.placeholder=n["station-name"],u.placeholder=n["station-name"];for(let t=0;t<24;t++)r.setHours(t),W("option",{value:t,text:r.toLocaleTimeString(i,{hour:"numeric"}),selected:t===a},d);for(let t=0;t<60;t++)r.setMinutes(t),W("option",{value:t,text:`${r.toLocaleTimeString(i,{minute:"numeric"})}${n.minute}`,selected:t===l},p);return f.addEventListener("click",(()=>{const i=t.stationTitleLookup,n=i[h.value.toUpperCase()],r=i[u.value.toUpperCase()],s=c.querySelector("#type").value,o=c.querySelector("#month").value,a=c.querySelector("#date").value,l=d.value,f=p.value;if(delete e.focus,h.classList.remove("search-focus"),u.classList.remove("search-focus"),!n||!r||n===r)return h.style.borderColor=n&&n!==r?"#777":"#f90",void(u.style.borderColor=r&&n!==r?"#777":"#f90");h.style.borderColor="#777",u.style.borderColor="#777",c.classList.remove("search-form"),c.classList.add("search-load"),B(`${gt.searchUrl}?origin=${n.id}&destination=${r.id}&type=${s}&month=${o}&date=${a}&hours=${l}&minutes=${f}`).then((t=>{c.classList.remove("search-load"),e.showResult(t)}))})),e.showForm(),t.touchDevice?(e.focus="origin",h.classList.add("search-focus")):c.addEventListener("transitionend",(()=>{h.focus()}),{once:!0}),e.popups=[],e}showForm(){const t=this;t.setTitle(t._map.dict["route-search"]).setButtons(),t._container.classList.add("search-form")}fillStationName(t){const e=this;let i=e.focus;if(i){const n=e._container;let r=n.querySelector(`#${i}`);r.style.borderColor="#777",r.value=t,r.classList.remove("search-focus"),i=e.focus="origin"===i?"destination":"origin",r=n.querySelector(`#${i}`),r.value?delete e.focus:(r.classList.add("search-focus"),e._map.touchDevice||r.focus())}}showResult(t){const e=this,i=e._map,{dict:n,clock:r}=i,s=e._container,o=W("div",{innerHTML:['<button id="back-button" class="back-button">','<span class="back-icon"></span>',"</button>"].join("")}),a=W("div",{className:"page-controller",innerHTML:['<span><button id="previous-button" class="previous-button">','<span class="previous-icon"></span>',"</button></span>",'<span><button id="next-button" class="next-button">','<span class="next-icon"></span>',"</button></span>"].join("")}),l=s.querySelector(".swiper-wrapper"),c=t.routes;if(e._result=t,i._setSearchMode("route"),s.classList.add("search-result"),o.addEventListener("click",(t=>{t.stopPropagation()})),o.querySelector("#back-button").addEventListener("click",(()=>{e._swiper&&(e._swiper.destroy(),delete e._swiper,e.hideRoute()),s.classList.remove("search-result"),e.showForm(),i._setSearchMode("edit"),i.refreshMap()})),a.addEventListener("click",(t=>{t.stopPropagation()})),a.querySelector("#previous-button").addEventListener("click",(()=>{e._swiper.slidePrev()})),a.querySelector("#next-button").addEventListener("click",(()=>{e._swiper.slideNext()})),l.innerHTML="",c){e.setButtons([o,a]);for(const t of c){const e=W("div",{className:"swiper-slide",innerHTML:['<div class="swiper-slide-content">','<div id="search-routes"></div>','<svg id="railway-mark"></svg>',"</div>"].join("")},l),s=e.querySelector("#search-routes"),o=e.querySelector("#railway-mark"),a=[],c=[],h=[];let u;for(const{r:e,y:s,ds:o,d:l,tt:h,nm:d,transfer:p,delay:f}of t.trains){const t=h[0],m=h[h.length-1],g=i.getLocalizedTrainNameOrRailwayTitle(d,e),_=i.getLocalizedTrainTypeTitle(s),y=i.getLocalizedDestinationTitle(o,l),v={};if(v.start=c.length,c.push(['<div class="station-row">',`<div class="station-title-box">${i.getLocalizedStationTitle(t.s)}</div>`,`<div class="station-time-box${f?" desc-caution":""}">`,u?`${r.getTimeString(r.getTime(u)+6e4*f)}<br>`:"",r.getTimeString(r.getTime(t.d)+6e4*f),"</div></div>"].join("")),c.push(['<div class="station-row">',`<div class="train-title-box">${g} <span class="train-type-label">${_}</span> ${y}`,f?` <span class="desc-caution">${n.delay.replace("$1",f)}</span>`:"","</div></div>"].join("")),v.end=c.length,v.color=i.railwayLookup[e].color,a.push(v),0===p)u=m.a;else{if(c.push(['<div class="station-row">',`<div class="station-title-box">${i.getLocalizedStationTitle(m.s)}</div>`,`<div class="station-time-box${f?" desc-caution":""}">`,r.getTimeString(r.getTime(m.a||m.d)+6e4*f),"</div></div>"].join("")),p>0){const t={};t.start=c.length-1,c.push(['<div class="station-row">',`<div class="train-title-box">${n["transfer-and-wait"].replace("$1",p)}</div>`,"</div>"].join("")),t.end=c.length,a.push(t)}u=void 0}}s.innerHTML=c.join("");for(const t of s.children)h.push(t.offsetTop+t.getBoundingClientRect().height/2);o.innerHTML=a.map((({color:t,start:e,end:i})=>t?`<line stroke="${t}" stroke-width="10" x1="12" y1="${h[e]}" x2="12" y2="${h[i]}" stroke-linecap="round" />`:`<line stroke="#7f7f7f" stroke-width="4" x1="12" y1="${h[e]}" x2="12" y2="${h[i]}" stroke-dasharray="4 4" />`)).concat(h.map(((t,e)=>e%2==0?`<circle cx="12" cy="${t}" r="3" fill="#ffffff" />`:""))).join("")}e._swiper=new DG(".swiper",{modules:[kG],pagination:{el:".swiper-pagination",clickable:!0}}),e._swiper.on("slideChange",(()=>{e.hideRoute()})),e._swiper.on("slideChangeTransitionEnd",(()=>{e.switchRoute()})),e.switchRoute()}else e.setButtons([o]),l.innerHTML=['<div class="swiper-slide">','<div class="swiper-slide-content">',n["cannot-find-train"],"</div></div>"].join("")}switchRoute(){const t=this,e=t._map,{dict:i,map:n,featureCollection:r}=e,s=t._container,o=t._swiper,a=o.activeIndex,l=t._result.routes[a],c=l.trains,h=[],u=[],d=[];t.setTitle([`${i.route}${a+1} `,i.transfers.replace("$1",l.numTransfers)].join("")),s.querySelector("#previous-button").disabled=o.isBeginning,s.querySelector("#next-button").disabled=o.isEnd;for(const{r:t,tt:i,d:n}of c){const{stations:r,ascending:s}=e.railwayLookup[t],o=i[0].s,a=i[i.length-1].s;for(const t of i){const i=e.stationLookup[t.s];u.push(i.group),d.push(i.coord)}if(n===s){const e=r.indexOf(o),i=r.indexOf(a,e);for(let n=e;n<i;n++)h.push(`${t}.${n+1}`)}else{const e=r.lastIndexOf(o),i=r.lastIndexOf(a,e);for(let n=e;n>i;n--)h.push(`${t}.${n}`)}}for(const t of[13,14,15,16,17,18])n.getLayer(`railways-routeug-${t}`).implementation.setProps({data:ue(r,(e=>e.zoom===t&&e.altitude<0&&F(h,e.section)))}),n.getLayer(`stations-routeug-${t}`).implementation.setProps({data:ue(r,(e=>e.zoom===t&&e.altitude<0&&F(u,e.group)))}),n.getLayer(`railways-routeog-${t}`).implementation.setProps({data:ue(r,(e=>e.zoom===t&&0===e.altitude&&F(h,e.section)))}),n.getLayer(`stations-routeog-${t}`).implementation.setProps({data:ue(r,(e=>e.zoom===t&&0===e.altitude&&F(u,e.group)))});n.fitBounds(Ce(d),{bearing:n.getBearing(),pitch:n.getPitch(),offset:[0,-n.transform.height/12],padding:{top:20,bottom:20,left:10,right:50},linear:!0,maxZoom:18}),e.refreshMap();const p=[c[0].tt[0].s];for(const t of c)(t.transfer>0||t===c[c.length-1])&&p.push(t.tt[t.tt.length-1].s);t.popups=p.map(((r,s)=>setTimeout((()=>{const o=new dt({className:"popup-route",closeButton:!1,closeOnClick:!1});o.setLngLat(e.stationLookup[r].coord).setHTML(0===s?i["from-station"]:s===p.length-1?i["to-station"]:`${i.transfer}${s}`).addTo(n),t.popups[s]=o}),s/p.length*1e3+500)))}hideRoute(){const t=this,e=t._map.map;for(const t of[13,14,15,16,17,18])for(const i of["routeug","routeog"])for(const n of["railways","stations"])Ie(e,`${n}-${i}-${t}`,{data:me()});for(const e of t.popups)e instanceof dt?e.remove():clearTimeout(e)}remove(){return this.hideRoute(),super.remove()}}class zG{constructor(t){this._object=t.object}addTo(t){const e=this,i=t.dict,n=e._object,r=n.t?"train":"flight",s=n.t||n.id,o=e._container=W("div",{className:"share-panel"},t.container);return(e._button=W("button",{className:"share-button",innerHTML:i["share-this"].replace("$1",i[r])},o)).onclick=()=>{window.navigator.share({title:i.my.replace("$1",i[r]),text:i["on-this"].replace("$1",i[r]),url:`${gt.shareUrl}?selection=${s}`}).then((()=>{q(t.container,i.shared)})).catch((()=>{}))},e._map=t,e}remove(){const t=this,e=t._container;return e.parentNode.removeChild(e),delete t._container,delete t._map,t}}class NG extends RU{constructor(t){super(Object.assign({className:"station-panel"},t))}addTo(t){const e=this,i=[],n=e._options.object,r={},s=[].concat(...n.map((t=>t.exit||[]))),{clock:o,container:a}=t,l=o.getTime();for(const{id:e}of n)r[t.getLocalizedStationTitle(e)]=!0;for(const e of s){const n=t.poiLookup[e],r=o.getCalendar(),s=n.uptime&&n.uptime.reduce(((t,e)=>!e.calendar||F(e.calendar,r)?e:t),{}),a=s&&(l<o.getTime(s.open)||l>=o.getTime(s.close)||s.open===s.close);i.push([`<div class="exit-row${a?" closed":""}">`,'<div class="exit-icon-box"></div>','<div class="exit-title-box">',t.getLocalizedPOIDescription(e),s&&s.open!==s.close?` (${s.open}-${s.close})`:"","</div>",(n.facilities||[]).map((t=>`<div class="exit-${t}-icon"></div>`)).join(""),'<div class="exit-share-button"></div>',"</div>"].join(""))}super.addTo(t).setTitle(Object.keys(r).join(t.dict.and)).setHTML(i.join(""));const c=e._container.querySelector("#panel-content").children;for(let e=0,i=c.length;e<i;e++){const i=c[e];i.addEventListener("click",(()=>{t.map.flyTo({center:t.poiLookup[s[e]].coord,zoom:19,pitch:30})})),i.addEventListener("mouseenter",(()=>{const t=a.querySelector(`#exit-${e}`);t&&t.classList.add("highlighted")})),i.addEventListener("mouseleave",(()=>{const t=a.querySelector(`#exit-${e}`);t&&t.classList.remove("highlighted")}))}return e}}const UG=["position","back","topback","front","topfront","helicopter","drone","bird"];class GG extends RU{constructor(t){super(Object.assign({className:"tracking-mode-panel",modal:!0},t));const e=this;e._onModeChanged=t=>{const i=e._container,n=t.mode.replace("heading","topback");i.querySelector(".tracking-mode-icon-enabled").classList.remove("tracking-mode-icon-enabled"),i.querySelector(`#${n}-tracking-mode .tracking-mode-icon`).classList.add("tracking-mode-icon-enabled")}}addTo(t){const e=this,i=t.dict,n=t.getTrackingMode();super.addTo(t).setTitle(i["tracking-modes"]).setHTML(UG.map((t=>[`<div id="${t}-tracking-mode" class="tracking-mode-row">`,'<div class="tracking-mode-icon"></div>',`<div>${i[t]}</div>`,"</div>"].join(""))).join(""));for(const i of UG){const r=e._container.querySelector(`#${i}-tracking-mode .tracking-mode-icon`);(i===n||"topback"===i&&"heading"===n)&&r.classList.add("tracking-mode-icon-enabled"),r.addEventListener("click",(()=>{t.getTrackingMode()!==i&&t.setTrackingMode(i)}))}return t.on("trackingmode",e._onModeChanged),e}remove(){return this._map.off("trackingmode",this._onModeChanged),super.remove()}}class VG extends RU{constructor(t){super(Object.assign({className:"train-panel"},t))}addTo(t){const e=this,i=t.clock,n=[],r=[],s=[],o=[],a=e._options.object,{r:l,v:c,nextTrains:h}=a,u=t.railwayLookup,d=c?t.trainVehicleLookup[c].color:u[l].color,p=a.delay||0;let f,m;for(let t=a;t;t=t.previousTrains&&t.previousTrains[0])n.unshift(t);for(let t=h&&h[0];t;t=t.nextTrains&&t.nextTrains[0])n.push(t);for(const e of n){const n={};n.start=Math.max(s.length-1,0),e.tt.forEach(((n,r)=>{(r>0||!e.previousTrains)&&s.push(['<div class="station-row">',`<div class="station-title-box">${t.getLocalizedStationTitle(n.s)}</div>`,'<div class="station-time-box',p>=6e4?" desc-caution":"",'">',n.a?i.getTimeString(i.getTime(n.a)+p):"",n.a&&n.d?"<br>":"",n.d?i.getTimeString(i.getTime(n.d)+p):"","</div></div>"].join(""))})),n.end=s.length-1,n.color=u[e.r].color,r.push(n),e===a&&(f=n)}super.addTo(t).setTitle(['<div class="desc-header">',Array.isArray(d)?["<div>",...d.slice(0,3).map((t=>`<div class="line-strip-long" style="background-color: ${t};"></div>`)),"</div>"].join(""):`<div style="background-color: ${d};"></div>`,'<div><div class="desc-first-row">',t.getLocalizedTrainNameOrRailwayTitle(a.nm,l),'</div><div class="desc-second-row">',`<span class="train-type-label">${t.getLocalizedTrainTypeTitle(a.y)}</span> `,t.getLocalizedDestinationTitle(a.ds,a.d),"</div></div></div>"].join("")).setHTML(['<div id="timetable-content">',...s,"</div>",'<svg id="railway-mark"></svg>','<svg id="train-mark"></svg>'].join(""));const g=e._container,_=g.querySelector("#panel-body");for(const t of g.querySelector("#timetable-content").children)o.push(t.offsetTop+t.getBoundingClientRect().height/2);g.querySelector("#railway-mark").innerHTML=r.map((({color:t,start:e,end:i})=>`<line stroke="${t}" stroke-width="10" x1="12" y1="${o[e]}" x2="12" y2="${o[i]}" stroke-linecap="round" />`)).concat(o.map((t=>`<circle cx="12" cy="${t}" r="3" fill="#ffffff" />`))).join("");const y=o.slice(f.start,f.end+1);return function t(){const i=_.getBoundingClientRect().height,n=a.timetableIndex,r=y[n],s=O(r,a.arrivalStation?y[n+1]:r,a._t),o=performance.now()%1500/1500;g.querySelector("#train-mark").innerHTML=`<circle cx="22" cy="${s}" r="${7+15*o}" fill="#ffffff" opacity="${1-o}" /><circle cx="22" cy="${s}" r="7" fill="#ffffff" />`,void 0!==m&&m!==_.scrollTop||(m=_.scrollTop=Math.round(s-i/2+4)),e._container&&requestAnimationFrame(t)}(),e}}class jG{constructor(t){const e=this;e.implementation=t,e.enabled=!1,e.clockModes=t.clockModes||["realtime","playback"],e.viewModes=t.viewModes||["ground","underground"],e.searchModes=t.searchModes||["none"],e._onModeChanged=()=>{e.setVisibility(!0)}}addTo(t){const e=this,i=e.implementation;return e.map=t,i.onAdd&&i.onAdd(t),N(i.enabled,!0)&&e.enable(),e}remove(){const t=this,e=t.implementation;return t.disable(),e.onRemove&&e.onRemove(t.map),delete t.map,t}enable(){const t=this,{map:e,_onModeChanged:i,implementation:n}=t;return t.enabled||(t.enabled=!0,e.on("clockmode",i),e.on("viewmode",i),n.onEnabled&&n.onEnabled(),t.setVisibility(!0)),t}disable(){const t=this,{map:e,_onModeChanged:i,implementation:n}=t;return t.enabled&&(t.enabled=!1,e.off("clockmode",i),e.off("viewmode",i),t.setVisibility(!1),n.onDisabled&&n.onDisabled()),t}setVisibility(t){const e=this,{map:i,implementation:n}=e;n.onVisibilityChanged&&n.onVisibilityChanged(t&&e.enabled&&F(e.clockModes,i.getClockMode())&&F(e.viewModes,i.getViewMode())&&F(e.searchModes,i.searchMode))}getId(){return this.implementation.id}getName(t){const e=this.implementation.name;return e[t]||e.en}getIconStyle(){return this.implementation.iconStyle}isEnabled(){return this.enabled}}const HG="Toei.Mita",WG=["ADO","SFJ","SNJ"],qG=Math.PI/180,XG=$.NavigationControl.prototype._updateZoomButtons;$.NavigationControl.prototype._updateZoomButtons=function(){const{_disabled:t,_zoomInButton:e,_zoomOutButton:i,_compass:n}=this;XG.apply(this),t&&(e.disabled=i.disabled=!0,e.setAttribute("aria-disabled","true"),i.setAttribute("aria-disabled","true")),n.disabled=!!t,n.setAttribute("aria-disabled",(!!t).toString())},$.NavigationControl.prototype.enable=function(){delete this._disabled,this._updateZoomButtons()},$.NavigationControl.prototype.disable=function(){this._disabled=!0,this._updateZoomButtons()};const ZG=$.MercatorCoordinate.fromLngLat(gt.defaultCenter),JG=ZG.meterInMercatorCoordinateUnits();function YG(t){const e=t.querySelector("#loader");e.style.opacity=0,setTimeout((()=>{e.style.display="none"}),1e3)}function $G(t,e){const i=t.length,n=[],r=[];for(let s=0;s<i-1;s++){const i=t[s+1]-t[s],o=e[s+1]-e[s];n.push(i),r.push(o/i)}const s=[r[0]];for(let t=0;t<n.length-1;t++){const e=r[t],i=r[t+1];if(e*i<=0)s.push(0);else{const r=n[t],o=n[t+1],a=r+o;s.push(3*a/((a+o)/e+(a+r)/i))}}s.push(r[r.length-1]);const o=[],a=[];for(let t=0;t<s.length-1;t++){const e=s[t],i=r[t],l=1/n[t],c=e+s[t+1]-i-i;o.push((i-e-c)*l),a.push(c*l*l)}return i=>{let n=t.length-1;if(i===t[n])return e[n];let r,l=0,c=a.length-1;for(;l<=c;){r=Math.floor(.5*(l+c));const n=t[r];if(n<i)l=r+1;else{if(!(n>i))return e[r];c=r-1}}n=Math.max(0,c);const h=i-t[n],u=h*h;return e[n]+s[n]*h+o[n]*u+a[n]*h*u}}function KG(t){return k(Math.floor(t),13,18)}function QG(t,e,i){const{tt:n,os:r,ds:s}=t;let o=!1;if(r&&e&&r[0]!==e[0]){if(t.os=e,n)for(let t=0,i=n.length;t<i;t++){const i=n[t];if(i.s===e[0]){delete i.a,n.splice(0,t);break}}o=!0}if(s&&i&&s[0]!==i[0]){if(t.ds=i,n)for(let t=0,e=n.length;t<e;t++){const e=n[t];if(e.s===i[0]){e.a=e.a||e.d,delete e.d,n.splice(t+1);break}}o=!0}return o}function tV(t){const{nextTrains:e,t:i}=t,n=i?[i]:[];return e?n.concat(...e.map(tV)):n}function eV(t){return t&&F(["train","flight"],t.type)}function iV(t){return function(t){return t&&"Feature"===t.type&&t.geometry}(t)}function nV(t,e){return t===e||!!(t&&t.properties&&e&&e.properties&&t.properties.ids===e.properties.ids)}function rV(){let t={};return{get:function(e){return t[e]},add:function(e,i){t[e]=i},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const sV={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class oV{constructor(t){this.parser=t,this.name=sV.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&t._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(t){const e=this.parser,i="light:"+t;let n=e.cache.get(i);if(n)return n;const r=e.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[t];let o;const a=new Uw(16777215);void 0!==s.color&&a.setRGB(s.color[0],s.color[1],s.color[2],xx);const l=void 0!==s.range?s.range:0;switch(s.type){case"directional":o=new kP(a),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new DP(a),o.distance=l;break;case"spot":o=new IP(a),o.distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,o.angle=s.spot.outerConeAngle,o.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return o.position.set(0,0,0),o.decay=2,qV(o,s),void 0!==s.intensity&&(o.intensity=s.intensity),o.name=e.createUniqueName(s.name||"light_"+t),n=Promise.resolve(o),e.cache.add(i,n),n}getDependency(t,e){if("light"===t)return this._loadLight(e)}createNodeAttachment(t){const e=this,i=this.parser,n=i.json.nodes[t],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(t){return i._getNodeRef(e.cache,r,t)}))}}class aV{constructor(){this.name=sV.KHR_MATERIALS_UNLIT}getMaterialType(){return Hw}extendParams(t,e,i){const n=[];t.color=new Uw(1,1,1),t.opacity=1;const r=e.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const e=r.baseColorFactor;t.color.setRGB(e[0],e[1],e[2],xx),t.opacity=e[3]}void 0!==r.baseColorTexture&&n.push(i.assignTexture(t,"map",r.baseColorTexture,vx))}return Promise.all(n)}}class lV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name].emissiveStrength;return void 0!==n&&(e.emissiveIntensity=n),Promise.resolve()}}class cV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];if(void 0!==s.clearcoatFactor&&(e.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&r.push(i.assignTexture(e,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(e.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&r.push(i.assignTexture(e,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(r.push(i.assignTexture(e,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const t=s.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new Xx(t,t)}return Promise.all(r)}}class hV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];return void 0!==s.iridescenceFactor&&(e.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&r.push(i.assignTexture(e,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(e.iridescenceIOR=s.iridescenceIor),void 0===e.iridescenceThicknessRange&&(e.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(e.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(e.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&r.push(i.assignTexture(e,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(r)}}class uV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];e.sheenColor=new Uw(0,0,0),e.sheenRoughness=0,e.sheen=1;const s=n.extensions[this.name];if(void 0!==s.sheenColorFactor){const t=s.sheenColorFactor;e.sheenColor.setRGB(t[0],t[1],t[2],xx)}return void 0!==s.sheenRoughnessFactor&&(e.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&r.push(i.assignTexture(e,"sheenColorMap",s.sheenColorTexture,vx)),void 0!==s.sheenRoughnessTexture&&r.push(i.assignTexture(e,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(r)}}class dV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];return void 0!==s.transmissionFactor&&(e.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&r.push(i.assignTexture(e,"transmissionMap",s.transmissionTexture)),Promise.all(r)}}class pV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];e.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&r.push(i.assignTexture(e,"thicknessMap",s.thicknessTexture)),e.attenuationDistance=s.attenuationDistance||1/0;const o=s.attenuationColor||[1,1,1];return e.attenuationColor=(new Uw).setRGB(o[0],o[1],o[2],xx),Promise.all(r)}}class fV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser.json.materials[t];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=i.extensions[this.name];return e.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class mV{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];e.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&r.push(i.assignTexture(e,"specularIntensityMap",s.specularTexture));const o=s.specularColorFactor||[1,1,1];return e.specularColor=(new Uw).setRGB(o[0],o[1],o[2],xx),void 0!==s.specularColorTexture&&r.push(i.assignTexture(e,"specularColorMap",s.specularColorTexture,vx)),Promise.all(r)}}class gV{constructor(t){this.parser=t,this.name=sV.EXT_MATERIALS_BUMP}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];return e.bumpScale=void 0!==s.bumpFactor?s.bumpFactor:1,void 0!==s.bumpTexture&&r.push(i.assignTexture(e,"bumpMap",s.bumpTexture)),Promise.all(r)}}class _V{constructor(t){this.parser=t,this.name=sV.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?UI:null}extendMaterialParams(t,e){const i=this.parser,n=i.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];return void 0!==s.anisotropyStrength&&(e.anisotropy=s.anisotropyStrength),void 0!==s.anisotropyRotation&&(e.anisotropyRotation=s.anisotropyRotation),void 0!==s.anisotropyTexture&&r.push(i.assignTexture(e,"anisotropyMap",s.anisotropyTexture)),Promise.all(r)}}class yV{constructor(t){this.parser=t,this.name=sV.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,i=e.json,n=i.textures[t];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],s=e.options.ktx2Loader;if(!s){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,r.source,s)}}class vV{constructor(t){this.parser=t,this.name=sV.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,r=n.textures[t];if(!r.extensions||!r.extensions[e])return null;const s=r.extensions[e],o=n.images[s.source];let a=i.textureLoader;if(o.uri){const t=i.options.manager.getHandler(o.uri);null!==t&&(a=t)}return this.detectSupport().then((function(r){if(r)return i.loadTextureImage(t,s.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class xV{constructor(t){this.parser=t,this.name=sV.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const e=this.name,i=this.parser,n=i.json,r=n.textures[t];if(!r.extensions||!r.extensions[e])return null;const s=r.extensions[e],o=n.images[s.source];let a=i.textureLoader;if(o.uri){const t=i.options.manager.getHandler(o.uri);null!==t&&(a=t)}return this.detectSupport().then((function(r){if(r)return i.loadTextureImage(t,s.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class bV{constructor(t){this.name=sV.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,i=e.bufferViews[t];if(i.extensions&&i.extensions[this.name]){const t=i.extensions[this.name],n=this.parser.getDependency("buffer",t.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then((function(e){const i=t.count,n=t.byteStride,s=new Uint8Array(e,t.byteOffset||0,t.byteLength||0);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(i,n,s,t.mode,t.filter).then((function(t){return t.buffer})):r.ready.then((function(){const e=new ArrayBuffer(i*n);return r.decodeGltfBuffer(new Uint8Array(e),i,n,s,t.mode,t.filter),e}))}))}return null}}class wV{constructor(t){this.name=sV.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const e=this.parser.json,i=e.nodes[t];if(!i.extensions||!i.extensions[this.name]||void 0===i.mesh)return null;const n=e.meshes[i.mesh];for(const t of n.primitives)if(t.mode!==BV.TRIANGLES&&t.mode!==BV.TRIANGLE_STRIP&&t.mode!==BV.TRIANGLE_FAN&&void 0!==t.mode)return null;const r=i.extensions[this.name].attributes,s=[],o={};for(const t in r)s.push(this.parser.getDependency("accessor",r[t]).then((e=>(o[t]=e,o[t]))));return s.length<1?null:(s.push(this.parser.createNodeMesh(t)),Promise.all(s).then((t=>{const e=t.pop(),i=e.isGroup?e.children:[e],n=t[0].count,r=[];for(const t of i){const e=new Qb,i=new Ab,s=new wb,a=new Ab(1,1,1),l=new LE(t.geometry,t.material,n);for(let t=0;t<n;t++)o.TRANSLATION&&i.fromBufferAttribute(o.TRANSLATION,t),o.ROTATION&&s.fromBufferAttribute(o.ROTATION,t),o.SCALE&&a.fromBufferAttribute(o.SCALE,t),l.setMatrixAt(t,e.compose(i,s,a));for(const e in o)if("_COLOR_0"===e){const t=o[e];l.instanceColor=new AE(t.array,t.itemSize,t.normalized)}else"TRANSLATION"!==e&&"ROTATION"!==e&&"SCALE"!==e&&t.geometry.setAttribute(e,o[e]);Tw.prototype.copy.call(l,t),this.parser.assignFinalMaterial(l),r.push(l)}return e.isGroup?(e.clear(),e.add(...r),e):r[0]})))}}const AV="glTF",TV=1313821514,MV=5130562;class SV{constructor(t){this.name=sV.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==AV)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,r=new DataView(t,12);let s=0;for(;s<n;){const e=r.getUint32(s,!0);s+=4;const n=r.getUint32(s,!0);if(s+=4,n===TV){const n=new Uint8Array(t,12+s,e);this.content=i.decode(n)}else if(n===MV){const i=12+s;this.body=t.slice(i,i+e)}s+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class EV{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=sV.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const i=this.json,n=this.dracoLoader,r=t.extensions[this.name].bufferView,s=t.extensions[this.name].attributes,o={},a={},l={};for(const t in s){const e=zV[t]||t.toLowerCase();o[e]=s[t]}for(const e in t.attributes){const n=zV[e]||e.toLowerCase();if(void 0!==s[e]){const r=i.accessors[t.attributes[e]];l[n]=DV[r.componentType].name,a[n]=!0===r.normalized}}return e.getDependency("bufferView",r).then((function(t){return new Promise((function(e,i){n.decodeDracoFile(t,(function(t){for(const e in t.attributes){const i=a[e];void 0!==i&&(t.attributes[e].normalized=i)}e(t)}),o,l,xx,i)}))}))}}class CV{constructor(){this.name=sV.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return void 0!==e.texCoord&&e.texCoord!==t.channel||void 0!==e.offset||void 0!==e.rotation||void 0!==e.scale?(t=t.clone(),void 0!==e.texCoord&&(t.channel=e.texCoord),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0,t):t}}class IV{constructor(){this.name=sV.KHR_MESH_QUANTIZATION}}class PV extends QI{constructor(t,e,i,n){super(t,e,i,n)}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=t*n*3+n;for(let t=0;t!==n;t++)e[t]=i[r+t];return e}interpolate_(t,e,i,n){const r=this.resultBuffer,s=this.sampleValues,o=this.valueSize,a=2*o,l=3*o,c=n-e,h=(i-e)/c,u=h*h,d=u*h,p=t*l,f=p-l,m=-2*d+3*u,g=d-u,_=1-m,y=g-u+h;for(let t=0;t!==o;t++){r[t]=_*s[f+t+o]+y*(s[f+t+a]*c)+m*s[p+t+o]+g*(s[p+t]*c)}return r}}const LV=new wb;class RV extends PV{interpolate_(t,e,i,n){const r=super.interpolate_(t,e,i,n);return LV.fromArray(r).normalize().toArray(r),r}}const BV={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},DV={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},OV={9728:hv,9729:pv,9984:uv,9985:fv,9986:dv,9987:mv},kV={33071:lv,33648:cv,10497:av},FV={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},zV={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},NV={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},UV={CUBICSPLINE:void 0,LINEAR:cx,STEP:lx},GV="OPAQUE",VV="MASK",jV="BLEND";function HV(t){return void 0===t.DefaultMaterial&&(t.DefaultMaterial=new NI({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:zy})),t.DefaultMaterial}function WV(t,e,i){for(const n in i.extensions)void 0===t[n]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[n]=i.extensions[n])}function qV(t,e){void 0!==e.extras&&"object"==typeof e.extras&&Object.assign(t.userData,e.extras)}function XV(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let i=0,n=e.weights.length;i<n;i++)t.morphTargetInfluences[i]=e.weights[i];if(e.extras&&Array.isArray(e.extras.targetNames)){const i=e.extras.targetNames;if(t.morphTargetInfluences.length===i.length){t.morphTargetDictionary={};for(let e=0,n=i.length;e<n;e++)t.morphTargetDictionary[i[e]]=e}}}function ZV(t){let e;const i=t.extensions&&t.extensions[sV.KHR_DRACO_MESH_COMPRESSION];if(e=i?"draco:"+i.bufferView+":"+i.indices+":"+JV(i.attributes):t.indices+":"+JV(t.attributes)+":"+t.mode,void 0!==t.targets)for(let i=0,n=t.targets.length;i<n;i++)e+=":"+JV(t.targets[i]);return e}function JV(t){let e="";const i=Object.keys(t).sort();for(let n=0,r=i.length;n<r;n++)e+=i[n]+":"+t[i[n]]+";";return e}function YV(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const $V=new Qb;class KV{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new rV,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,r=-1;"undefined"!=typeof navigator&&(i=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,r=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),this.textureLoader="undefined"==typeof createImageBitmap||i||n&&r<98?new bP(this.options.manager):new ZP(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new vP(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const i=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(e){const s={scene:e[0][n.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:n.asset,parser:i,userData:{}};return WV(r,s,n),qV(s,n),Promise.all(i._invokeAll((function(t){return t.afterRoot&&t.afterRoot(s)}))).then((function(){t(s)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],i=this.json.meshes||[];for(let i=0,n=e.length;i<n;i++){const n=e[i].joints;for(let e=0,i=n.length;e<i;e++)t[n[e]].isBone=!0}for(let e=0,n=t.length;e<n;e++){const n=t[e];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(i[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,i){if(t.refs[e]<=1)return i;const n=i.clone(),r=(t,e)=>{const i=this.associations.get(t);null!=i&&this.associations.set(e,i);for(const[i,n]of t.children.entries())r(n,e.children[i])};return r(i,n),n.name+="_instance_"+t.uses[e]++,n}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let i=0;i<e.length;i++){const n=t(e[i]);if(n)return n}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const i=[];for(let n=0;n<e.length;n++){const r=t(e[n]);r&&i.push(r)}return i}getDependency(t,e){const i=t+":"+e;let n=this.cache.get(i);if(!n){switch(t){case"scene":n=this.loadScene(e);break;case"node":n=this._invokeOne((function(t){return t.loadNode&&t.loadNode(e)}));break;case"mesh":n=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":n=this.loadAccessor(e);break;case"bufferView":n=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":n=this.loadBuffer(e);break;case"material":n=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":n=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":n=this.loadSkin(e);break;case"animation":n=this._invokeOne((function(t){return t.loadAnimation&&t.loadAnimation(e)}));break;case"camera":n=this.loadCamera(e);break;default:if(n=this._invokeOne((function(i){return i!=this&&i.getDependency&&i.getDependency(t,e)})),!n)throw new Error("Unknown type: "+t)}this.cache.add(i,n)}return n}getDependencies(t){let e=this.cache.get(t);if(!e){const i=this;e=Promise.all((this.json[t+("mesh"===t?"es":"s")]||[]).map((function(e,n){return i.getDependency(t,n)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],i=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[sV.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(t,r){i.load(VP.resolveURL(e.uri,n.path),t,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const i=e.byteOffset||0;return t.slice(i,i+(e.byteLength||0))}))}loadAccessor(t){const e=this,i=this.json,n=this.json.accessors[t];if(void 0===n.bufferView&&void 0===n.sparse){const t=FV[n.type],e=!0===n.normalized,i=new(0,DV[n.componentType])(n.count*t);return Promise.resolve(new Kw(i,t,e))}const r=[];return r.push(void 0!==n.bufferView?this.getDependency("bufferView",n.bufferView):null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then((function(t){const r=t[0],s=FV[n.type],o=DV[n.componentType],a=o.BYTES_PER_ELEMENT,l=n.byteOffset||0,c=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,h=!0===n.normalized;let u,d;if(c&&c!==a*s){const t=Math.floor(l/c),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+t+":"+n.count;let p=e.cache.get(i);p||(u=new o(r,t*c,n.count*c/a),p=new US(u,c/a),e.cache.add(i,p)),d=new VS(p,s,l%c/a,h)}else u=null===r?new o(n.count*s):new o(r,l,n.count*s),d=new Kw(u,s,h);if(void 0!==n.sparse){const e=n.sparse.values.byteOffset||0,i=new(0,DV[n.sparse.indices.componentType])(t[1],n.sparse.indices.byteOffset||0,n.sparse.count*FV.SCALAR),a=new o(t[2],e,n.sparse.count*s);null!==r&&(d=new Kw(d.array.slice(),d.itemSize,d.normalized));for(let t=0,e=i.length;t<e;t++){const e=i[t];if(d.setX(e,a[t*s]),s>=2&&d.setY(e,a[t*s+1]),s>=3&&d.setZ(e,a[t*s+2]),s>=4&&d.setW(e,a[t*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return d}))}loadTexture(t){const e=this.json,i=e.textures[t].source,n=e.images[i];let r=this.textureLoader;if(n.uri){const t=this.options.manager.getHandler(n.uri);null!==t&&(r=t)}return this.loadTextureImage(t,i,r)}loadTextureImage(t,e,i){const n=this,r=this.json,s=r.textures[t],o=r.images[e],a=(o.uri||o.bufferView)+":"+s.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(e,i).then((function(e){e.flipY=!1,e.name=s.name||o.name||"",""===e.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(e.name=o.uri);const i=(r.samplers||{})[s.sampler]||{};return e.magFilter=OV[i.magFilter]||pv,e.minFilter=OV[i.minFilter]||mv,e.wrapS=kV[i.wrapS]||av,e.wrapT=kV[i.wrapT]||av,n.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[a]=l,l}loadImageSource(t,e){const i=this,n=this.json,r=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((t=>t.clone()));const s=n.images[t],o=self.URL||self.webkitURL;let a=s.uri||"",l=!1;if(void 0!==s.bufferView)a=i.getDependency("bufferView",s.bufferView).then((function(t){l=!0;const e=new Blob([t],{type:s.mimeType});return a=o.createObjectURL(e),a}));else if(void 0===s.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const c=Promise.resolve(a).then((function(t){return new Promise((function(i,n){let s=i;!0===e.isImageBitmapLoader&&(s=function(t){const e=new gb(t);e.needsUpdate=!0,i(e)}),e.load(VP.resolveURL(t,r.path),s,void 0,n)}))})).then((function(t){var e;return!0===l&&o.revokeObjectURL(a),t.userData.mimeType=s.mimeType||((e=s.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw t}));return this.sourceCache[t]=c,c}assignTexture(t,e,i,n){const r=this;return this.getDependency("texture",i.index).then((function(s){if(!s)return null;if(void 0!==i.texCoord&&i.texCoord>0&&((s=s.clone()).channel=i.texCoord),r.extensions[sV.KHR_TEXTURE_TRANSFORM]){const t=void 0!==i.extensions?i.extensions[sV.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=r.associations.get(s);s=r.extensions[sV.KHR_TEXTURE_TRANSFORM].extendTexture(s,t),r.associations.set(s,e)}}return void 0!==n&&(s.colorSpace=n),t[e]=s,s}))}assignFinalMaterial(t){const e=t.geometry;let i=t.material;const n=void 0===e.attributes.tangent,r=void 0!==e.attributes.color,s=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new oC,jw.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,e.sizeAttenuation=!1,this.cache.add(t,e)),i=e}else if(t.isLine){const t="LineBasicMaterial:"+i.uuid;let e=this.cache.get(t);e||(e=new JE,jw.prototype.copy.call(e,i),e.color.copy(i.color),e.map=i.map,this.cache.add(t,e)),i=e}if(n||r||s){let t="ClonedMaterial:"+i.uuid+":";n&&(t+="derivative-tangents:"),r&&(t+="vertex-colors:"),s&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=i.clone(),r&&(e.vertexColors=!0),s&&(e.flatShading=!0),n&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(i))),i=e}t.material=i}getMaterialType(){return NI}loadMaterial(t){const e=this,i=this.extensions,n=this.json.materials[t];let r;const s={},o=[];if((n.extensions||{})[sV.KHR_MATERIALS_UNLIT]){const t=i[sV.KHR_MATERIALS_UNLIT];r=t.getMaterialType(),o.push(t.extendParams(s,n,e))}else{const i=n.pbrMetallicRoughness||{};if(s.color=new Uw(1,1,1),s.opacity=1,Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;s.color.setRGB(t[0],t[1],t[2],xx),s.opacity=t[3]}void 0!==i.baseColorTexture&&o.push(e.assignTexture(s,"map",i.baseColorTexture,vx)),s.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,s.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(o.push(e.assignTexture(s,"metalnessMap",i.metallicRoughnessTexture)),o.push(e.assignTexture(s,"roughnessMap",i.metallicRoughnessTexture))),r=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),o.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,s)}))))}!0===n.doubleSided&&(s.side=2);const a=n.alphaMode||GV;if(a===jV?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,a===VV&&(s.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&r!==Hw&&(o.push(e.assignTexture(s,"normalMap",n.normalTexture)),s.normalScale=new Xx(1,1),void 0!==n.normalTexture.scale)){const t=n.normalTexture.scale;s.normalScale.set(t,t)}if(void 0!==n.occlusionTexture&&r!==Hw&&(o.push(e.assignTexture(s,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(s.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&r!==Hw){const t=n.emissiveFactor;s.emissive=(new Uw).setRGB(t[0],t[1],t[2],xx)}return void 0!==n.emissiveTexture&&r!==Hw&&o.push(e.assignTexture(s,"emissiveMap",n.emissiveTexture,vx)),Promise.all(o).then((function(){const o=new r(s);return n.name&&(o.name=n.name),qV(o,n),e.associations.set(o,{materials:t}),n.extensions&&WV(i,o,n),o}))}createUniqueName(t){const e=yL.sanitizeNodeName(t||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(t){const e=this,i=this.extensions,n=this.primitiveCache;function r(t){return i[sV.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,e).then((function(i){return QV(i,t,e)}))}const s=[];for(let i=0,o=t.length;i<o;i++){const o=t[i],a=ZV(o),l=n[a];if(l)s.push(l.promise);else{let t;t=o.extensions&&o.extensions[sV.KHR_DRACO_MESH_COMPRESSION]?r(o):QV(new cA,o,e),n[a]={primitive:o,promise:t},s.push(t)}}return Promise.all(s)}loadMesh(t){const e=this,i=this.extensions,n=this.json.meshes[t],r=n.primitives,s=[];for(let t=0,e=r.length;t<e;t++){const e=void 0===r[t].material?HV(this.cache):this.getDependency("material",r[t].material);s.push(e)}return s.push(e.loadGeometries(r)),Promise.all(s).then((function(s){const o=s.slice(0,s.length-1),a=s[s.length-1],l=[];for(let s=0,c=a.length;s<c;s++){const c=a[s],h=r[s];let u;const d=o[s];if(h.mode===BV.TRIANGLES||h.mode===BV.TRIANGLE_STRIP||h.mode===BV.TRIANGLE_FAN||void 0===h.mode)u=!0===n.isSkinnedMesh?new _E(c,d):new EA(c,d),!0===u.isSkinnedMesh&&u.normalizeSkinWeights(),h.mode===BV.TRIANGLE_STRIP?u.geometry=tU(u.geometry,1):h.mode===BV.TRIANGLE_FAN&&(u.geometry=tU(u.geometry,2));else if(h.mode===BV.LINES)u=new rC(c,d);else if(h.mode===BV.LINE_STRIP)u=new eC(c,d);else if(h.mode===BV.LINE_LOOP)u=new sC(c,d);else{if(h.mode!==BV.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new uC(c,d)}Object.keys(u.geometry.morphAttributes).length>0&&XV(u,n),u.name=e.createUniqueName(n.name||"mesh_"+t),qV(u,n),h.extensions&&WV(i,u,h),e.assignFinalMaterial(u),l.push(u)}for(let i=0,n=l.length;i<n;i++)e.associations.set(l[i],{meshes:t,primitives:i});if(1===l.length)return n.extensions&&WV(i,l[0],n),l[0];const c=new CS;n.extensions&&WV(i,c,n),e.associations.set(c,{meshes:t});for(let t=0,e=l.length;t<e;t++)c.add(l[t]);return c}))}loadCamera(t){let e;const i=this.json.cameras[t],n=i[i.type];if(n)return"perspective"===i.type?e=new NA(qx.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(e=new hT(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(e.name=this.createUniqueName(i.name)),qV(e,i),Promise.resolve(e)}loadSkin(t){const e=this.json.skins[t],i=[];for(let t=0,n=e.joints.length;t<n;t++)i.push(this._loadNodeShallow(e.joints[t]));return i.push(void 0!==e.inverseBindMatrices?this.getDependency("accessor",e.inverseBindMatrices):null),Promise.all(i).then((function(t){const e=t.pop(),i=t,n=[],r=[];for(let t=0,s=i.length;t<s;t++){const s=i[t];if(s){n.push(s);const i=new Qb;null!==e&&i.fromArray(e.array,16*t),r.push(i)}}return new wE(n,r)}))}loadAnimation(t){const e=this,i=this.json.animations[t],n=i.name?i.name:"animation_"+t,r=[],s=[],o=[],a=[],l=[];for(let t=0,e=i.channels.length;t<e;t++){const e=i.channels[t],n=i.samplers[e.sampler],c=e.target,h=void 0!==i.parameters?i.parameters[n.input]:n.input,u=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==c.node&&(r.push(this.getDependency("node",c.node)),s.push(this.getDependency("accessor",h)),o.push(this.getDependency("accessor",u)),a.push(n),l.push(c))}return Promise.all([Promise.all(r),Promise.all(s),Promise.all(o),Promise.all(a),Promise.all(l)]).then((function(t){const i=t[0],r=t[1],s=t[2],o=t[3],a=t[4],l=[];for(let t=0,n=i.length;t<n;t++){const n=i[t],c=r[t],h=s[t],u=o[t],d=a[t];if(void 0===n)continue;n.updateMatrix&&n.updateMatrix();const p=e._createAnimationTracks(n,c,h,u,d);if(p)for(let t=0;t<p.length;t++)l.push(p[t])}return new uP(n,void 0,l)}))}createNodeMesh(t){const e=this,i=this.json.nodes[t];return void 0===i.mesh?null:e.getDependency("mesh",i.mesh).then((function(t){const n=e._getNodeRef(e.meshCache,i.mesh,t);return void 0!==i.weights&&n.traverse((function(t){if(t.isMesh)for(let e=0,n=i.weights.length;e<n;e++)t.morphTargetInfluences[e]=i.weights[e]})),n}))}loadNode(t){const e=this,i=this.json.nodes[t],n=e._loadNodeShallow(t),r=[],s=i.children||[];for(let t=0,i=s.length;t<i;t++)r.push(e.getDependency("node",s[t]));const o=void 0===i.skin?Promise.resolve(null):e.getDependency("skin",i.skin);return Promise.all([n,Promise.all(r),o]).then((function(t){const e=t[0],i=t[1],n=t[2];null!==n&&e.traverse((function(t){t.isSkinnedMesh&&t.bind(n,$V)}));for(let t=0,n=i.length;t<n;t++)e.add(i[t]);return e}))}_loadNodeShallow(t){const e=this.extensions,i=this;if(void 0!==this.nodeCache[t])return this.nodeCache[t];const n=this.json.nodes[t],r=n.name?i.createUniqueName(n.name):"",s=[],o=i._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return o&&s.push(o),void 0!==n.camera&&s.push(i.getDependency("camera",n.camera).then((function(t){return i._getNodeRef(i.cameraCache,n.camera,t)}))),i._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){s.push(t)})),this.nodeCache[t]=Promise.all(s).then((function(s){let o;if(o=!0===n.isBone?new yE:s.length>1?new CS:1===s.length?s[0]:new Tw,o!==s[0])for(let t=0,e=s.length;t<e;t++)o.add(s[t]);if(n.name&&(o.userData.name=n.name,o.name=r),qV(o,n),n.extensions&&WV(e,o,n),void 0!==n.matrix){const t=new Qb;t.fromArray(n.matrix),o.applyMatrix4(t)}else void 0!==n.translation&&o.position.fromArray(n.translation),void 0!==n.rotation&&o.quaternion.fromArray(n.rotation),void 0!==n.scale&&o.scale.fromArray(n.scale);return i.associations.has(o)||i.associations.set(o,{}),i.associations.get(o).nodes=t,o})),this.nodeCache[t]}loadScene(t){const e=this.extensions,i=this.json.scenes[t],n=this,r=new CS;i.name&&(r.name=n.createUniqueName(i.name)),qV(r,i),i.extensions&&WV(e,r,i);const s=i.nodes||[],o=[];for(let t=0,e=s.length;t<e;t++)o.push(n.getDependency("node",s[t]));return Promise.all(o).then((function(t){for(let e=0,i=t.length;e<i;e++)r.add(t[e]);return n.associations=(t=>{const e=new Map;for(const[t,i]of n.associations)(t instanceof jw||t instanceof gb)&&e.set(t,i);return t.traverse((t=>{const i=n.associations.get(t);null!=i&&e.set(t,i)})),e})(r),r}))}_createAnimationTracks(t,e,i,n,r){const s=[],o=t.name?t.name:t.uuid,a=[];let l;switch(NV[r.path]===NV.weights?t.traverse((function(t){t.morphTargetInfluences&&a.push(t.name?t.name:t.uuid)})):a.push(o),NV[r.path]){case NV.weights:l=oP;break;case NV.rotation:l=lP;break;case NV.position:case NV.scale:l=hP;break;default:if(1===i.itemSize)l=oP;else l=hP}const c=void 0!==n.interpolation?UV[n.interpolation]:cx,h=this._getArrayFromAccessor(i);for(let t=0,i=a.length;t<i;t++){const i=new l(a[t]+"."+NV[r.path],e.array,h,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(i),s.push(i)}return s}_getArrayFromAccessor(t){let e=t.array;if(t.normalized){const t=YV(e.constructor),i=new Float32Array(e.length);for(let n=0,r=e.length;n<r;n++)i[n]=e[n]*t;e=i}return e}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(t){return new(this instanceof lP?RV:PV)(this.times,this.values,this.getValueSize()/3,t)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function QV(t,e,i){const n=e.attributes,r=[];function s(e,n){return i.getDependency("accessor",e).then((function(e){t.setAttribute(n,e)}))}for(const e in n){const i=zV[e]||e.toLowerCase();i in t.attributes||r.push(s(n[e],i))}if(void 0!==e.indices&&!t.index){const n=i.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));r.push(n)}return qV(t,e),function(t,e,i){const n=e.attributes,r=new Sb;if(void 0===n.POSITION)return;{const t=i.json.accessors[n.POSITION],e=t.min,s=t.max;if(void 0===e||void 0===s)return;if(r.set(new Ab(e[0],e[1],e[2]),new Ab(s[0],s[1],s[2])),t.normalized){const e=YV(DV[t.componentType]);r.min.multiplyScalar(e),r.max.multiplyScalar(e)}}const s=e.targets;if(void 0!==s){const t=new Ab,e=new Ab;for(let n=0,r=s.length;n<r;n++){const r=s[n];if(void 0!==r.POSITION){const n=i.json.accessors[r.POSITION],s=n.min,o=n.max;if(void 0!==s&&void 0!==o){if(e.setX(Math.max(Math.abs(s[0]),Math.abs(o[0]))),e.setY(Math.max(Math.abs(s[1]),Math.abs(o[1]))),e.setZ(Math.max(Math.abs(s[2]),Math.abs(o[2]))),n.normalized){const t=YV(DV[n.componentType]);e.multiplyScalar(t)}t.max(e)}}}r.expandByVector(t)}t.boundingBox=r;const o=new Hb;r.getCenter(o.center),o.radius=r.min.distanceTo(r.max)/2,t.boundingSphere=o}(t,e,i),Promise.all(r).then((function(){return void 0!==e.targets?function(t,e,i){let n=!1,r=!1,s=!1;for(let t=0,i=e.length;t<i;t++){const i=e[t];if(void 0!==i.POSITION&&(n=!0),void 0!==i.NORMAL&&(r=!0),void 0!==i.COLOR_0&&(s=!0),n&&r&&s)break}if(!n&&!r&&!s)return Promise.resolve(t);const o=[],a=[],l=[];for(let c=0,h=e.length;c<h;c++){const h=e[c];if(n){const e=void 0!==h.POSITION?i.getDependency("accessor",h.POSITION):t.attributes.position;o.push(e)}if(r){const e=void 0!==h.NORMAL?i.getDependency("accessor",h.NORMAL):t.attributes.normal;a.push(e)}if(s){const e=void 0!==h.COLOR_0?i.getDependency("accessor",h.COLOR_0):t.attributes.color;l.push(e)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then((function(e){const i=e[1],o=e[2];return n&&(t.morphAttributes.position=e[0]),r&&(t.morphAttributes.normal=i),s&&(t.morphAttributes.color=o),t.morphTargetsRelative=!0,t}))}(t,e.targets,i):t}))}const tj=Object.assign({GLTFLoader:class extends gP{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new cV(t)})),this.register((function(t){return new yV(t)})),this.register((function(t){return new vV(t)})),this.register((function(t){return new xV(t)})),this.register((function(t){return new uV(t)})),this.register((function(t){return new dV(t)})),this.register((function(t){return new pV(t)})),this.register((function(t){return new fV(t)})),this.register((function(t){return new lV(t)})),this.register((function(t){return new mV(t)})),this.register((function(t){return new hV(t)})),this.register((function(t){return new _V(t)})),this.register((function(t){return new gV(t)})),this.register((function(t){return new oV(t)})),this.register((function(t){return new bV(t)})),this.register((function(t){return new wV(t)}))}load(t,e,i,n){const r=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const e=VP.extractUrlBase(t);s=VP.resolveURL(e,this.path)}else s=VP.extractUrlBase(t);this.manager.itemStart(t);const o=function(e){n&&n(e),r.manager.itemError(t),r.manager.itemEnd(t)},a=new vP(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(t,(function(i){try{r.parse(i,s,(function(i){e(i),r.manager.itemEnd(t)}),o)}catch(t){o(t)}}),i,o)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,i,n){let r;const s={},o={},a=new TextDecoder;if("string"==typeof t)r=JSON.parse(t);else if(t instanceof ArrayBuffer){if(a.decode(new Uint8Array(t,0,4))===AV){try{s[sV.KHR_BINARY_GLTF]=new SV(t)}catch(t){return void(n&&n(t))}r=JSON.parse(s[sV.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(t))}else r=t;if(void 0===r.asset||r.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new KV(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){const e=this.pluginCallbacks[t](l);o[e.name]=e,s[e.name]=!0}if(r.extensionsUsed)for(let t=0;t<r.extensionsUsed.length;++t){const e=r.extensionsUsed[t],i=r.extensionsRequired||[];switch(e){case sV.KHR_MATERIALS_UNLIT:s[e]=new aV;break;case sV.KHR_DRACO_MESH_COMPRESSION:s[e]=new EV(r,this.dracoLoader);break;case sV.KHR_TEXTURE_TRANSFORM:s[e]=new CV;break;case sV.KHR_MESH_QUANTIZATION:s[e]=new IV;break;default:i.indexOf(e)}}l.setExtensions(s),l.setPlugins(o),l.parse(i,n)}parseAsync(t,e){const i=this;return new Promise((function(n,r){i.parse(t,e,n,r)}))}}},ZL);var ej={mapboxgl:K,Marker:class extends $.Evented{constructor(t){super();this._marker=new $.Marker({element:t.element}),function(t,e){for(const i of t)e[i]&&(e[i]=e[i].bind(e))}(["_onClick","_onMouseEnter","_onMouseLeave"],this)}addTo(t){const e=this,i=e._marker,n=i.getElement();return i.addTo(t.map),n.addEventListener("click",e._onClick),n.addEventListener("mouseenter",e._onMouseEnter),n.addEventListener("mouseleave",e._onMouseLeave),n.addEventListener("mousemove",e._onMouseMove),e}remove(){const t=this,e=t._marker,i=e.getElement();return i.removeEventListener("click",t._onClick),i.removeEventListener("mouseenter",t._onMouseEnter),i.removeEventListener("mouseleave",t._onMouseLeave),i.removeEventListener("mousemove",t._onMouseMove),e.remove(),t}setLngLat(t){return this._marker.setLngLat(t),this}setActivity(t){const e=this._marker.getElement().classList;return t?e.add("active"):e.remove("active"),this}setVisibility(t){return this._marker.getElement().style.visibility=t?"visible":"hidden",this}_onClick(t){this.fire({type:"click"}),t.stopPropagation()}_onMouseEnter(){this.fire({type:"mouseenter"})}_onMouseLeave(){this.fire({type:"mouseleave"})}_onMouseMove(t){t.stopPropagation()}},Map:class extends $.Evented{constructor(t){super();const e=this;t=function(t,...e){const i=At,n={};n[i(0,"pe6Y")]=i(1,"!NJq"),n[i(2,"YiUq")]=i(3,"zWjH");const r={};r[i(4,"CZL0")]=i(5,"ZS6]"),r[i(6,"zWjH")]=n;const s=r;for(const i of[s,...e])for(const e in i)t[e]=i[e];return t}({hash:!1,useWebGL2:!0,center:gt.defaultCenter,zoom:gt.defaultZoom,bearing:gt.defaultBearing,pitch:gt.defaultPitch,dataUrl:gt.dataUrl,clockControl:!0,searchControl:!0,navigationControl:!0,fullscreenControl:!0,modeControl:!0,configControl:!0,trackingMode:gt.defaultTrackingMode,ecoMode:gt.defaultEcoMode,ecoFrameRate:gt.defaultEcoFrameRate},t),e.lang=function(t){let e=N(t,"");if(!e.match(/ja|en|fr|es|ko|zh-Han[st]|th|ne|pt-BR/)){const t=window.navigator;e=t.languages&&t.languages[0]||t.language||t.userLanguage||t.browserLanguage||""}return e=e.match(/zh-(Hant|TW|HK|MO)/)?"zh-Hant":e.match(/zh/)?"zh-Hans":e.substring(0,2),e.match(/ja|en|ko|zh-Han[st]|th|fr|es|ne|pt/)?e:"en"}(t.lang),e.dataUrl=t.dataUrl,e.container="string"==typeof t.container?document.getElementById(t.container):t.container,e.secrets=t.secrets,e.exitPopups=[],e.clockControl=t.clockControl,e.searchControl=t.searchControl,e.navigationControl=t.navigationControl,e.fullscreenControl=t.fullscreenControl,e.modeControl=t.modeControl,e.configControl=t.configControl,e.clock=new _t,e.plugins=(t.plugins||[]).map((t=>new jG(t))),e.searchMode="none",e.viewMode=gt.defaultViewMode,e.trackingMode=t.trackingMode,e.trackingParams={zoom:{},bearing:{},pitch:{}},e.lastCameraParams={},e.initialSelection=t.selection,e.clockMode=gt.defaultClockMode,e.isEditingTime=!1,e.ecoMode=t.ecoMode,e.ecoFrameRate=t.ecoFrameRate,e.lastDynamicUpdate={},e.lastRepaint=0,e.frameRateFactor=1,e.container.addEventListener("touchstart",(()=>{e.touchDevice=!0})),t.container=function(t){const e=W("div",{id:"map"},t);return W("div",{id:"loader",className:"loader-inner ball-pulse",innerHTML:"<div></div><div></div><div></div>"},t),W("div",{id:"loading-error"},t),t.classList.add("mini-tokyo-3d"),e}(e.container),t.style=`${t.dataUrl}/osm-liberty.json`,t.configControl||(t.customAttribution=[t.customAttribution,gt.customAttribution].reduce(((t,e)=>t.concat(e)),[])),e.map=new $.Map(t);for(const t of gt.events)e.map.on(t,e.fire.bind(e));e.map.once("idle",(()=>{new Promise((t=>{let e=0;const i=performance.now(),n=()=>{e++<60?requestAnimationFrame(n):t(1e3/((performance.now()-i)/60))};n()})).then((t=>{e.frameRateFactor=Math.min(60/t,2)}))})),Promise.all([PU(e.dataUrl,e.lang,e.clock).then(e.initData.bind(e)).catch((t=>{throw function(t){const e=t.querySelector("#loader"),i=t.querySelector("#loading-error");e.style.display="none",i.innerHTML="Loading failed. Please reload the page.",i.style.display="block"}(e.container),t})),new Promise((t=>{e.map.once("styledata",t)}))]).then(e.initialize.bind(e))}getMapboxMap(){return this.map}getCenter(){return this.map.getCenter()}setCenter(t){const e=this;return e.trackObject(),e.map.setCenter(t),e}getZoom(){return this.map.getZoom()}setZoom(t){return this.map.setZoom(t),this}getBearing(){return this.map.getBearing()}setBearing(t){const e=this;return e.trackObject(),e.map.setBearing(t),e}getPitch(){return this.map.getPitch()}setPitch(t){return this.map.setPitch(t),this}easeTo(t){const e=this;return void 0===t.center&&void 0===t.bearing||e.trackObject(),e.map.easeTo(t),e}flyTo(t){const e=this;return void 0===t.center&&void 0===t.bearing||e.trackObject(),e.map.flyTo(t),e}jumpTo(t){const e=this;return void 0===t.center&&void 0===t.bearing||e.trackObject(),e.map.jumpTo(t),e}getViewMode(){return this.viewMode}setViewMode(t){const e=this;return e.initialized&&e._setViewMode(t),e}getTrackingMode(){return this.trackingMode}setTrackingMode(t){return this._setTrackingMode(t),this}getSelection(){const t=this;if(eV(t.trackedObject)){const e=t.trackedObject.object;return e.t||e.id}}setSelection(t){const e=this,i=U(t);if(i.match(/NRT|HND/))if(e.flightLoaded){const t=e.activeFlightLookup[i];t?t.aircraft?e.trackObject(t.aircraft):e.selection=t.id:q(e.container,e.dict["flight-terminated"]),delete e.initialSelection}else e.initialSelection=i;else if(e.trainLoaded){const t=e.trainLookup[i];let n;if(t)for(const i of tV(t))if(n=e.activeTrainLookup[i])break;n?n.cars[0]?e.trackObject(n.cars[0]):e.selection=n.t:q(e.container,e.dict["train-terminated"]),delete e.initialSelection}else e.initialSelection=i;return e}getClockMode(){return this.clockMode}setClockMode(t){const e=this;return e.initialized&&e._setClockMode(t),e}getEcoMode(){return this.ecoMode}setEcoMode(t){return this._setEcoMode(t),this}addLayer(t,e){const i=this;return"three"===t.type?new YL(t).onAdd(i,e):"geojson"===t.type?new By(t).onAdd(i,e):"tile-3d"===t.type?new YN(t).onAdd(i,e):i.map.addLayer(t,e||"poi"),i}removeLayer(t){return this.map.removeLayer(t),this}setLayerVisibility(t,e){return this.map.setLayoutProperty(t,"visibility",e),this}getModelOrigin(){return ZG}getModelScale(){return JG}getModelPosition(t,e){const i=$.MercatorCoordinate.fromLngLat(t,e);return{x:i.x-ZG.x,y:-(i.y-ZG.y),z:i.z-ZG.z}}hasDarkBackground(){return Le(this.map)}initData(t){const e=this,i=e.featureLookup={};Object.assign(e,t),e.railwayLookup=D(e.railwayData),e.stationLookup=D(e.stationData),ht(e.featureCollection,(t=>{const e=t.properties;1===e.type?i[e.id]=t:e.altitude<=0||(i[e.id]=t,function(t){const e=St(t),i=t.properties.distances=[];let n,r,s,o=0,a=e[0];for(let t=0,l=e.length;t<l-1;t++){const l=a;a=e[t+1];const c=oe(l,a);n=Et(l,a),r=((a[2]||0)-(l[2]||0))/c,s=Math.atan(r/1e3),i.push([o,n,r,s]),o+=c}i.push([o,n,r,s])}(t))})),e.lastTimetableRefresh=e.clock.getTime("03:00"),e.updateTimetableData(e.timetableData),e.trainLookup=D(e.timetableData,"t"),e.railDirectionLookup=D(e.railDirectionData),e.trainTypeLookup=D(e.trainTypeData),e.trainVehicleLookup=D(e.trainVehicleData),e.operatorLookup=D(e.operatorData),e.airportLookup=D(e.airportData),e.flightStatusLookup=D(e.flightStatusData),e.poiLookup=D(e.poiData),e.activeTrainLookup={},e.realtimeTrainLookup={},e.activeFlightLookup={},e.flightLookup={}}initialize(){const t=this,{lang:e,dict:i,clock:n,map:r,container:s,featureCollection:o}=t,a=r.getZoom(),l=t.layerZoom=KG(a);r.loaded()?YG(s):r.once("load",(()=>{YG(s)})),t.trafficLayer=new wU({id:"traffic"}),r.setLight({intensity:.35,anchor:"map"}),r.addLayer({id:"sky",type:"sky",paint:{"sky-opacity":["interpolate",["linear"],["zoom"],0,0,5,.3,8,1],"sky-type":"atmosphere","sky-atmosphere-sun-intensity":20}},"background"),r.addLayer({id:"background-underground",type:"background",paint:{"background-color":"rgba(16,16,16,1)","background-opacity":0},metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":0,"mt3d:opacity-underground":1}},"natural_earth"),r.addLayer({id:"building-underground-underground",type:"fill",source:"mapbox","source-layer":"building",minzoom:14.5,filter:["all",["match",["get","type"],["underground_mall","subway"],!0,!1],["==",["get","underground"],"true"],["==",["geometry-type"],"Polygon"]],layout:{},paint:{"fill-outline-color":"hsl(35, 8%, 80%)","fill-opacity":["interpolate",["linear"],["zoom"],14.5,0,15,0],"fill-color":"hsla(268, 67%, 67%, 0.5)"},metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":0,"mt3d:opacity-underground":1,"mt3d:opacity-underground-route":.1}},"building"),r.setLayoutProperty("poi","text-field",["coalesce",["get",`name_${e}`],["get","name_en"],["get","name"]]);for(const e of[13,14,15,16,17,18]){const i={type:"geojson",lineWidthUnits:"pixels",lineWidthScale:13===e?k(Math.pow(2,a-12),.125,1):18===e?k(Math.pow(2,a-19),1,8):1,parameters:{depthTest:!1},minzoom:e<=13?0:e,maxzoom:e>=18?24:e+1};for(const n of["marked","selected"])t.addLayer(Object.assign({},i,{id:`stations-${n}-${e}`,getLineWidth:12,getLineColor:[255,255,255],getFillColor:[255,255,255],visible:!1}),"building-3d");for(const n of["ug","routeug","routeog"])for(const r of["railways","stations"]){const s="railways"===r?0:1;t.addLayer(Object.assign({},i,{id:`${r}-${n}-${e}`,data:"ug"===n?ue(o,(t=>t.zoom===e&&t.type===s&&t.altitude<0)):me(),transitions:{opacity:gt.transitionDuration}},{railways:{filled:!1,getLineWidth:t=>t.properties.width,getLineColor:t=>H(t.properties.color)},stations:{getLineWidth:4,getFillColor:[255,255,255,179]}}[r],{ug:{opacity:.0625,pickable:"stations"===r,metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":.0625,"mt3d:opacity-route":.005,"mt3d:opacity-underground":1,"mt3d:opacity-underground-route":.005}},routeug:{opacity:.0625,metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":.125,"mt3d:opacity-underground":1}},routeog:{metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-underground":.25}}}[n]),"building-3d")}}r.__deck.props.getCursor=()=>r.getCanvas().style.cursor;for(const t of[13,14,15,16,17,18]){const e=["interpolate",["exponential",2],["zoom"]],i=["get","width"],n=["get","color"],s=13===t?[...e,9,["/",i,8],12,i]:18===t?[...e,19,i,22,["*",i,8]]:i,[a,c]=[0,1].map((e=>ue(o,(i=>i.zoom===t&&i.type===e&&0===i.altitude))));for(const e of["railways","stations","stations-outline"])r.addLayer({id:`${e}-og-${t}`,type:"stations"===e?"fill":"line",source:{type:"geojson",data:"railways"===e?a:c},layout:{visibility:t===l?"visible":"none"},paint:{railways:{"line-color":n,"line-width":s},stations:{"fill-color":n,"fill-opacity":.7},"stations-outline":{"line-color":["get","outlineColor"],"line-width":s}}[e],metadata:{"mt3d:opacity-effect":!0,"mt3d:opacity":1,"mt3d:opacity-route":.1,"mt3d:opacity-underground":.25,"mt3d:opacity-underground-route":.1}},"building-3d")}t.addLayer(t.trafficLayer,"building-3d"),t.styleColors=function(t,e){const i={background:["background-color"],line:["line-color"],fill:["fill-color","fill-outline-color"]},n=[];return t.getStyle().layers.filter((({metadata:t})=>t&&t[e])).forEach((({id:e,type:r})=>{for(const s of i[r]){const i=t.getPaintProperty(e,s);if(!i)return;if("string"==typeof i){const[t,r,o,a]=ge(i);n.push({id:e,key:s,color:{r:t,g:r,b:o,a:a}})}else if(i.stops){const t=[];i.stops.forEach(((e,i)=>{const[n,r,s,o]=ge(e[1]);t.push({index:i,value:{r:n,g:r,b:s,a:o}})})),n.push({id:e,key:s,color:t})}else if("case"===i[0]||"interpolate"===i[0]){const t=[];i.forEach(((e,i)=>{if(i>=1&&"string"==typeof e){const[n,r,s,o]=ge(e);t.push({index:i,value:{r:n,g:r,b:s,a:o}})}})),n.push({id:e,key:s,color:t})}}})),n}(r,"mt3d:color-effect"),t.styleOpacities=function(t,e){const{_layers:i,_order:n}=t.style,r={"background-underground":1,"building-underground-underground":["interpolate",["linear"],["zoom"],14.5,0,15,1]},s=[];return n.map((t=>i[t])).filter((({metadata:t})=>t&&t[e])).forEach((({id:e,type:i,metadata:n})=>{if("custom"===i)return void s.push({id:e,metadata:n});const o=`${i}-opacity`,a=r[e]||N(t.getPaintProperty(e,o),1);if(isNaN(a)){if(a.stops){const t=[];a.stops.forEach(((e,i)=>{t.push({index:i,value:e[1]})})),s.push({id:e,key:o,opacity:t,metadata:n})}else if("case"===a[0]||"interpolate"===a[0]){const t=[];a.forEach(((e,i)=>{i%2!=0||isNaN(e)||t.push({index:i,value:e})})),s.push({id:e,key:o,opacity:t,metadata:n})}}else s.push({id:e,key:o,opacity:a,metadata:n})})),s}(r,"mt3d:opacity-effect");const c=W("datalist",{id:"stations"},document.body);t.stationTitleLookup={};for(const i of[e,"en"])for(const e of t.railwayData)for(const n of e.stations){const e=t.stationLookup[n],r=e.utitle&&e.utitle[i]||z(e.title[i]||e.title.en),s=r.toUpperCase();t.stationTitleLookup[s]||(W("option",{value:r},c),t.stationTitleLookup[s]=e)}if(t.searchControl){const e=new bt([{className:"mapboxgl-ctrl-search",title:i["enter-search"],eventHandler(){t._setSearchMode("none"===t.searchMode?"edit":"none")}}]);r.addControl(e)}if(t.navigationControl){const e=t.navControl=new $.NavigationControl;e._setButtonTitle=function(t){const{_zoomInButton:e,_zoomOutButton:n,_compass:r}=this,s=t===e?i["zoom-in"]:t===n?i["zoom-out"]:t===r?i.compass:"";t.title=s,t.setAttribute("aria-label",s)},r.addControl(e)}if(t.fullscreenControl){const t=new $.FullscreenControl({container:s});t._updateTitle=function(){const t=this._fullscreenButton,e=i[this._isFullscreen()?"exit-fullscreen":"enter-fullscreen"];t.title=e,t.setAttribute("aria-label",e)},r.addControl(t)}if(t.modeControl){const e=new bt([{className:"mapboxgl-ctrl-underground",title:i["enter-underground"],eventHandler(){t._setViewMode("ground"===t.viewMode?"underground":"ground")}},{className:"mapboxgl-ctrl-playback",title:i["enter-playback"],eventHandler(){t._setClockMode("realtime"===t.clockMode?"playback":"realtime")}},{className:"mapboxgl-ctrl-eco",title:i["enter-eco"],eventHandler(){t._setEcoMode("eco"===t.ecoMode?"normal":"eco")}}]);r.addControl(e)}if(t.layerPanel=new DU({layers:t.plugins}),t.trackingModePanel=new GG,t.aboutPanel=new BU,t.configControl&&r.addControl(new bt([{className:"mapboxgl-ctrl-layers",title:i["select-layers"],eventHandler(){t.layerPanel.addTo(t)}},{className:"mapboxgl-ctrl-tracking-mode",title:i["select-tracking-mode"],eventHandler(){t.trackingModePanel.addTo(t)}},{className:"mapboxgl-ctrl-about",title:i.about,eventHandler(){t.aboutPanel.addTo(t)}}])),t.clockControl){const s=t.clockCtrl=new xt({lang:e,dict:i,clock:n});s.on("change",t.onClockChange.bind(t)),r.addControl(s)}for(const e of[13,14,15,16,17,18])r.on("mouseenter",`stations-og-${e}`,(e=>{t.pickedFeature=e.features[0]})),r.on("click",`stations-og-${e}`,(e=>{t.pickedFeature=e.features[0]})),r.on("mouseleave",`stations-og-${e}`,(()=>{delete t.pickedFeature}));r.on("mousemove",(e=>{t.markObject(t.pickObject(e.point))})),r.on("mouseout",(()=>{t.markObject()})),r.on("click",(e=>{const i=t.pickObject(e.point);t.markObject(i),t.trackObject(i)})),r.on("zoom",(e=>{e.tracking||t.updateBaseZoom();const i=r.getZoom(),n=t.layerZoom,s=t.layerZoom=KG(i);if(i<13){const t=k(Math.pow(2,i-12),.125,1);for(const e of["stations-marked-13","stations-selected-13","railways-ug-13","stations-ug-13","railways-routeug-13","stations-routeug-13","railways-routeog-13","stations-routeog-13"])Ie(r,e,{lineWidthScale:t})}else if(i>19){const t=k(Math.pow(2,i-19),1,8);for(const e of["stations-marked-18","stations-selected-18","railways-ug-18","stations-ug-18","railways-routeug-18","stations-routeug-18","railways-routeog-18","stations-routeog-18"])Ie(r,e,{lineWidthScale:t})}if(n!==s){const{activeTrainLookup:i,activeFlightLookup:r}=t;for(const e of["railways","stations","stations-outline"])t.setLayerVisibility(`${e}-og-${n}`,"none"),t.setLayerVisibility(`${e}-og-${s}`,"visible");e.tracking?t.prevLayerZoom=n:delete t.prevLayerZoom;for(const e of Object.keys(i)){const n=i[e];t.updateTrainProps(n),t.updateTrainShape(n)}for(const e of Object.keys(r))t.updateFlightShape(r[e])}})),r.on("render",(()=>{const e=t.markedObject;e&&(eV(e)?t.updatePopup({setHTML:!0}):t.updatePopup())}));for(const e of t.plugins.slice().reverse())e.addTo(t);pt.init(),pt.start({callback:()=>{const e=t.clock,i=e.getTime(),{minDelay:n,trainRefreshInterval:s}=gt;i-t.lastTimetableRefresh>=864e5&&(t.loadTimetableData(),t.lastTimetableRefresh=e.getTime("03:00")),Date.now()-t.lastFrameRefresh>=gt.refreshTimeout&&t.stopAll(),t.lastFrameRefresh=Date.now(),t.updateVisibleArea(),Math.floor((i-n)/s)!==Math.floor(t.lastTrainRefresh/s)&&(!function(t,e,i){let n;for(const{id:r,key:s,color:o}of e){if(Array.isArray(o)){n=t.getPaintProperty(r,s);for(const{index:t,value:e}of o){const r=Re(e,i);n.stops?n.stops[t][1]=r:n[t]=r}}else n=Re(o,i);t.setPaintProperty(r,s,n)}}(r,t.styleColors,t.getLightColor()),function(t,e){const i=t.getCenter(),{azimuth:n,altitude:r}=Te.getPosition(e,i.lat,i.lng),s=180+n*Se,o=90-r*Se,{r:a,g:l,b:c}=Pe(t,e);t.setLight({position:[1.15,s,o],color:`rgb(${255*a},${255*l},${255*c})`})}(r,i),"none"===t.searchMode&&("realtime"===t.clockMode?(t.loadRealtimeTrainData(),t.loadRealtimeFlightData()):(t.refreshTrains(),t.refreshFlights())),t.lastTrainRefresh=i-n),!eV(t.trackedObject)&&("normal"===t.ecoMode&&r._loaded||Date.now()-t.lastRepaint>=1e3/t.ecoFrameRate)&&(t.trackedObject&&t.refreshStationOutline(),r.triggerRepaint(),t.lastRepaint=Date.now())}}),t.initialized=!0}_jumpTo(t){const e=this,{map:i,trackingMode:n,trackingParams:r,frameRateFactor:s}=e,o=performance.now(),a=i.getZoom(),l=i.getBearing(),c=i.getPitch(),h=i.scrollZoom._active;let u,d,{center:p,altitude:f,bearing:m,easeOutFactor:g,easeInFactor:_,bearingFactor:y}=t;"position"===n?(u=e.baseZoom,m=l,d=c):"helicopter"===n?(u=15,m=r.bearing.fn(o),d=60):"drone"===n?(u=17,m=r.bearing.fn(o),d=75):"bird"===n?(e.updateTrackingParams(),u=r.zoom.fn(o),m=r.bearing.fn(o),d=r.pitch.fn(o)):("front"!==n&&"topfront"!==n||(m=(m+360)%360-180),y>=0&&(m=l+((m-l+540)%360-180)*y*s),"back"===n||"front"===n?(u=18.5,d=85):(u=15,d=60));const v=i.getFreeCameraOptions().position.z/Math.cos(c*qG)*Math.pow(2,a-u),x=e.getModelPosition(p,f).z/Math.cos(d*qG);if(u=Math.min(u-Math.log2(Math.max(v+x,0)/v),22),p=e.adjustCoord(p,f,m),g>=0){const t=i.getCenter();p=new $.LngLat(O(t.lng,p.lng,g*s),O(t.lat,p.lat,g*s))}_>=0&&(u=O(a,u,_*s),d=O(c,d,_*s)),Math.floor(u+1)-u<1e-6&&(u=Math.floor(u+1)),e.prevLayerZoom===KG(u)?u=a:delete e.prevLayerZoom,i.jumpTo({center:p,zoom:u,bearing:m,pitch:d},{tracking:!0}),h&&(i.scrollZoom._active=!0)}updateVisibleArea(){const t=this,e=t.map,{width:i,height:n}=e.transform,r=t.getModelPosition(e.unproject([0,0])),s=t.getModelPosition(e.unproject([i,0])),o=t.getModelPosition(e.unproject([0,n])),a=t.getModelPosition(e.unproject([i,n]));t.visibleArea=function(t,e){const[[i,n],[r,s],[o,a],[l,c]]=t,h=r-i,u=o-r,d=l-o,p=i-l,f=s-n,m=a-s,g=c-a,_=n-c,y=e/Math.sqrt(h*h+f*f),v=e/Math.sqrt(u*u+m*m),x=e/Math.sqrt(d*d+g*g),b=e/Math.sqrt(p*p+_*_),w=i-f*y,A=r-m*v,T=o-g*x,M=l-_*b,S=n+h*y,E=s+u*v,C=a+d*x,I=c+p*b,P=h*m,L=u*g,R=d*_,B=p*f,D=f*u,O=m*d,k=g*p,F=_*h,z=P-D,N=L-O,U=R-k,G=B-F;return[[(h*u*(S-E)+P*A-D*w)/z,(P*S-D*E-f*m*(w-A))/z],[(u*d*(E-C)+L*T-O*A)/N,(L*E-O*C-m*g*(A-T))/N],[(d*p*(C-I)+R*M-k*T)/U,(R*C-k*I-g*_*(T-M))/U],[(p*h*(I-S)+B*w-F*M)/G,(B*I-F*S-_*f*(M-w))/G]]}([[r.x,r.y],[s.x,s.y],[a.x,a.y],[o.x,o.y]],Math.max(14e-6,5e-5*Math.sin(e.getPitch()*qG)))}updateTrainProps(t){const e=(t.railwayFeature=this.featureLookup[`${t.r}.${this.layerZoom}`]).properties["station-offsets"],i=t.sectionIndex,n=t.offset=e[i];t.interval=e[i+t.sectionLength]-n}updateTrainShape(t,e){const i=this,{map:n,trafficLayer:r}=i,{railwayFeature:s,offset:o,interval:a,direction:l,cars:c,delay:h}=t,u=c.length;let d,p,f;if(void 0!==e&&(t._t=e),void 0===t._t)return;if(0===u){const e=t.v;c.push({type:"train",object:t,color:e?i.trainVehicleLookup[e].color:i.railwayLookup[t.r].color,delay:0}),i.markedObject&&i.markedObject.object===t&&(d=c[0]),i.trackedObject&&i.trackedObject.object===t&&(p=c[0]),i.selection===t.t&&(p=c[0],delete i.selection)}c[0].delay=h?1:0;const m=de(s,o+t._t*a,1,0);for(let e=0,s=c.length;e<s;e++){const s=c[e],o=m[e];if(s.altitude<0&&o.altitude>=0?f="ground":s.altitude>=0&&o.altitude<0&&(f="underground"),s.coord=o.coord,s.altitude=o.altitude,s.bearing=o.bearing+(l<0?180:0),s.pitch=o.pitch*l,d===s&&i.markObject(s),p===s&&i.trackObject(s),s.outline=i.markedObject===s?1:i.trackedObject===s?G():0,i.trackedObject!==s||i.viewAnimationID||n._zooming||n._rotating||n._pitching||i._jumpTo({center:s.coord,altitude:s.altitude,bearing:s.bearing,bearingFactor:.02}),pt.isActive(t.animationID)){const{x:e,y:r}=i.getModelPosition(s.coord),o=V([e,r],i.visibleArea)?"normal"===i.ecoMode&&n._loaded?0:i.ecoFrameRate:1;pt.setFrameRate(t.animationID,o)}void 0===s.meshIndex?r.addObject(s):r.updateObject(s),f&&i.trackedObject===s&&i._setViewMode(f),i.trackedObject===s&&i.markedObject===s&&i.updatePopup()}}updateFlightShape(t,e){const i=this,{map:n,trafficLayer:r}=i;let s,o=t.aircraft;if(void 0!==e&&(t._t=e),void 0===t._t)return;if(!o){const{color:e,tailcolor:n}=i.operatorLookup[t.a];o=t.aircraft={type:"flight",object:t,color:[e||"#FFFFFF",n||"#FFFFFF"]},i.selection===t.id&&(s=o,delete i.selection)}const a=de(t.feature,t._t*t.feature.properties.length,1,0)[0];if(o.coord=a.coord,o.altitude=a.altitude,o.bearing=a.bearing,o.pitch=a.pitch,s===o&&i.trackObject(o),o.outline=i.markedObject===o?1:i.trackedObject===o?G():0,i.trackedObject!==o||i.viewAnimationID||n._zooming||n._rotating||n._pitching||i._jumpTo({center:o.coord,altitude:o.altitude,bearing:o.bearing,bearingFactor:.02}),pt.isActive(t.animationID)){const{x:e,y:r}=i.getModelPosition(o.coord),s=V([e,r],i.visibleArea)||i.trackedObject===o?"normal"===i.ecoMode&&n._loaded?0:i.ecoFrameRate:1;pt.setFrameRate(t.animationID,s)}void 0===o.meshIndex?r.addObject(o):r.updateObject(o),i.trackedObject===o&&i.markedObject===o&&i.updatePopup()}refreshTrains(){const t=this,e=t.initialSelection,i=t.clock.getTime();for(const e of t.timetableData){const n=e.delay||0,r=t.railwayLookup[e.r];!(e.start+n<=i&&i<=e.end+n)||t.checkActiveTrains(e,!0)||r.dynamic&&r.status&&!t.realtimeTrainLookup[e.t]||r.suspended||t.trainStart(e)}t.trafficLayer.refreshDelayMarkers(),t.trainLoaded=!0,e&&t.setSelection(e)}trainStart(t,e){const i=this,n=i.clock,r=n.getTime();if(!i.setSectionData(t,e))return;i.activeTrainLookup[t.t]=t,t.cars=[],i.updateTrainProps(t);const s=n.getTime(t.departureTime)+(t.delay||0);t.tt||0===t.sectionLength?t.tt&&r>=s?i.trainRepeat(t,r-s):i.trainStand(t):i.trainRepeat(t)}trainStand(t,e){const i=this,n=i.clock,r=n.getTime(t.departureTime)+(t.delay||0),s=gt.minStandingDuration;t.tt||(e=!i.setSectionData(t,void 0,!i.realtimeTrainLookup[t.t])),!e&&t.arrivalStation&&(i.updateTrainProps(t),i.updateTrainShape(t,0)),t.tt||0===t.sectionLength?(i.setTrainStandingStatus(t,!0),t.animationID=pt.start({callback:()=>{i.trackedObject&&i.trackedObject.object===t&&i.updateTrainShape(t)},complete:()=>{e?i.stopTrain(t):t.tt?i.trainRepeat(t,1===i.clock.speed?void 0:i.clock.getTime()-r):i.trainStand(t)},duration:t.tt?Math.max(r-n.getTime(),1===n.speed?s:0):e?s:gt.realtimeTrainCheckInterval,clock:n})):i.trainRepeat(t)}trainRepeat(t,e){const i=this,n=i.clock,r=n.getTime(),s=t.delay||0,o=gt.minDelay,{arrivalTime:a,nextDepartureTime:l}=t;let c,h;l&&(h=n.getTime(l)+s-r+(e||0)-o+6e4-gt.minStandingDuration),a&&(c=n.getTime(a)+s-r+(e||0)-o,h<c+6e4||(h=c+6e4)),i.setTrainStandingStatus(t,!1),t.animationID=function(t,e,i,n,r,s,o){let a,l,{maxSpeed:c,acceleration:h,maxAccelerationTime:u,maxAccDistance:d}=gt;i<=2*d?(a=2*Math.sqrt(i/h),l=a/2):(a=2*u+(i-2*d)/c,r>0&&(a=k(a,n||0,r),d=h*a*a/8,i>=2*d?(c=2*i/a,h=2*c/a):c=h*a/2-Math.sqrt(h*(2*d-i))),l=c/h);return pt.start({callback:e=>{const n=a-e;let r;r=e<=l?h/2*e*e:n<=l?i-h/2*n*n:c*(e-l/2),t(r/i)},complete:e,duration:a,start:s>0?o.getHighResTime()-s:void 0,clock:o})}((e=>{t.cars&&!isNaN(e)?i.updateTrainShape(t,e):i.stopTrain(t)}),(()=>{if(!t.cars||t.tt&&t.timetableIndex+1>=t.tt.length)i.stopTrain(t);else if(i.setSectionData(t,t.timetableIndex+1))i.trainStand(t);else{const e=t.nextTrains;if(e){let n=!1;for(const t of e[0].previousTrains)t.arrivalStation&&(n=!0);if(n)i.trainStand(t);else{let t=-1,n=-1;for(const r of e[0].previousTrains)-1===t&&r.cars&&(t=r.cars.indexOf(i.markedObject)),-1===n&&r.cars&&(n=r.cars.indexOf(i.trackedObject)),i.stopTrain(r);e.forEach(((e,r)=>{i.activeTrainLookup[e.t]||i.trainStart(e,0),0===r&&e.cars&&(i.updateTrainShape(e,0),-1!==t&&i.markObject(e.cars[t]),-1!==n&&i.trackObject(e.cars[n]))}))}return}i.trainStand(t,!0)}}),Math.abs(t.interval),c,h,e,n)}refreshFlights(){const t=this,{clock:e,flightLookup:i,initialSelection:n}=t,r=e.getTime();for(const n of Object.keys(i)){const s=i[n],{id:o,start:a}=s,l=t.activeFlightLookup;s.standing<=r&&r<=s.end&&!l[o]&&(l[o]=s,r>=a?t.flightRepeat(s,r-a):(t.updateFlightShape(s,0),t.setFlightStandingStatus(s,!0),s.animationID=pt.start({callback:()=>{const e=t.trackedObject;e&&e.object===s&&t.updateFlightShape(s)},complete:()=>{t.flightRepeat(s)},duration:a-r,clock:e})))}t.flightLoaded=!0,n&&t.setSelection(n)}flightRepeat(t,e){const i=this,n=i.clock;i.setFlightStandingStatus(t,!1),t.animationID=function(t,e,i,n,r,s,o){const a=n/Math.abs(r),l=a/2+i/n;return pt.start({callback:e=>{const s=l-e;let o;o=r>0?e<=a?r/2*e*e:n*(e-a/2):s<=a?i+r/2*s*s:n*e,t(o/i)},complete:e,duration:l,start:s>0?o.getHighResTime()-s:void 0,clock:o})}((e=>{i.updateFlightShape(t,e)}),(()=>{i.setFlightStandingStatus(t,!0),t.animationID=pt.start({callback:()=>{i.trackedObject&&i.trackedObject.object===t&&i.updateFlightShape(t)},complete:()=>{i.stopFlight(t)},duration:Math.max(t.end-n.getTime(),0),clock:n})}),t.feature.properties.length,t.maxSpeed,t.acceleration,e,n)}updateTrackingParams(t){const e=this,{map:i,trackingMode:n,trackingParams:r}=e,s=performance.now();if("bird"===n){const{zoom:n,bearing:o,pitch:a}=r;if(!n.time||t){const t=n.time=[0,s,0,0],i=n.value=[0,e.baseZoom,0,0];for(const[e,n]of[[0,1],[2,1],[3,2]])t[e]=t[n]+Math.sign(e-n)*(1e4*Math.random()+3e4),i[e]=5*Math.random()+15;n.fn=$G(t,i)}else s>=n.time[2]&&(n.time=n.time.slice(1).concat(n.time[3]+1e4*Math.random()+3e4),n.value=n.value.slice(1).concat(5*Math.random()+15),n.fn=$G(n.time,n.value));if(!o.time||t){const t=o.time=[0,s,0,0],e=o.value=[0,i.getBearing(),0,0];for(const[i,n]of[[0,1],[2,1],[3,2]])t[i]=t[n]+Math.sign(i-n)*(1e4*Math.random()+4e4),e[i]=360*Math.random()-180;o.fn=$G(t,e)}else s>=o.time[2]&&(o.time=o.time.slice(1).concat(o.time[3]+1e4*Math.random()+4e4),o.value=o.value.slice(1).concat(360*Math.random()-180),o.fn=$G(o.time,o.value));if(!a.time||t){const t=a.time=[0,s,0,0],e=a.value=[0,i.getPitch(),0,0];for(const[i,n]of[[0,1],[2,1],[3,2]])t[i]=t[n]+Math.sign(i-n)*(1e4*Math.random()+2e4),e[i]=30*Math.random()+45;a.fn=$G(t,e)}else s>=a.time[2]&&(a.time=a.time.slice(1).concat(a.time[3]+1e4*Math.random()+2e4),a.value=a.value.slice(1).concat(30*Math.random()+45),a.fn=$G(a.time,a.value))}else if(delete r.zoom.time,delete r.bearing.time,delete r.pitch.time,"drone"===n){const t=i.getBearing();r.bearing.fn=e=>(t-(e-s)/200)%360}else if("helicopter"===n){const t=i.getBearing();r.bearing.fn=e=>(t+(e-s)/400)%360}}updateHandlersAndControls(){const t=this,{map:e,trackedObject:i,trackingMode:n}=t,r=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","touchPitch"];if(eV(i)&&"position"!==n){for(const t of r)e[t].disable();t.navControl.disable()}else{for(const t of r)e[t].enable();eV(i)&&"position"===n&&e.dragPan.disable(),t.navControl.enable()}}startViewAnimation(){const t=this;let e=0,i=0;t.viewAnimationID=pt.start({callback:(n,r)=>{const s=t.trackedObject,o=function(t){return-((t-=1)*t*t*t-1)}(n/r),a=1-(1-o)/(1-e),l=function(t){return t*t}(n/r);t._jumpTo({center:s.coord,altitude:s.altitude,bearing:s.bearing,easeOutFactor:a,easeInFactor:1-(1-l)/(1-i),bearingFactor:a}),e=o,i=l},complete:()=>{delete t.viewAnimationID},duration:1e3})}stopViewAnimation(){const t=this;t.viewAnimationID&&(pt.stop(t.viewAnimationID),delete t.viewAnimationID)}adjustCoord(t,e,i){if(!e)return $.LngLat.convert(t);const{map:n,trafficLayer:r}=this;if(!isNaN(i)){const r=$.MercatorCoordinate.fromLngLat(t,e),s=r.z*Math.tan(n.getPitch()*qG),o=r.x+s*Math.sin(i*qG),a=r.y-s*Math.cos(i*qG);return new $.MercatorCoordinate(o,a,0).toLngLat()}return n.unproject(r.project(t,e))}getLocalizedRailwayTitle(t){const e=(this.railwayLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedTrainNameOrRailwayTitle(t,e){const i=this;return t?t.map((t=>t[i.lang]||t.en)).join(i.dict.and):i.getLocalizedRailwayTitle(e)}getLocalizedTrainTypeTitle(t){const e=(this.trainTypeLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedStationTitle(t){const e=this;return(Array.isArray(t)?t:[t]).map((t=>{const i=(e.stationLookup[t]||{}).title||{};return i[e.lang]||i.en})).join(e.dict.and)}getLocalizedDestinationTitle(t,e){const i=this;if(t)return i.dict.for.replace("$1",i.getLocalizedStationTitle(t));const n=(i.railDirectionLookup[e]||{}).title||{};return n[i.lang]||n.en}getLocalizedOperatorTitle(t){const e=(this.operatorLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedAirportTitle(t){const e=(this.airportLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedFlightStatusTitle(t){const e=(this.flightStatusLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedPOITitle(t){const e=(this.poiLookup[t]||{}).title||{};return e[this.lang]||e.en}getLocalizedPOIDescription(t){const e=(this.poiLookup[t]||{}).description||{};return e[this.lang]||e.en}setTrainStandingStatus(t,e){const i=this,{lang:n,dict:r,clock:s}=i,{r:o,v:a,departureTime:l,arrivalStation:c}=t,h=i.railwayLookup[o],u=a?i.trainVehicleLookup[a].color:h.color,d=t.delay||0,p=t.arrivalTime||t.nextDepartureTime,f=h.status;t.standing=e,t.description=['<div class="desc-header">',Array.isArray(u)?["<div>",...u.slice(0,3).map((t=>`<div class="line-strip" style="background-color: ${t};"></div>`)),"</div>"].join(""):`<div style="background-color: ${u};"></div>`,"<div><strong>",i.getLocalizedTrainNameOrRailwayTitle(t.nm,o),"</strong>",`<br> <span class="train-type-label">${i.getLocalizedTrainTypeTitle(t.y)}</span> `,i.getLocalizedDestinationTitle(t.ds,t.d),"</div></div>",`<strong>${r["train-number"]}:</strong> ${t.n}`,t.tt?"":` <span class="desc-caution">${r.special}</span>`,"<br>",d>=6e4?'<span class="desc-caution">':"","<strong>",r[e?"standing-at":"previous-stop"],":</strong> ",i.getLocalizedStationTitle(t.departureStation),l?` ${s.getTimeString(s.getTime(l)+d)}`:"",c?[`<br><strong>${r["next-stop"]}:</strong> `,i.getLocalizedStationTitle(c),p?` ${s.getTimeString(s.getTime(p)+d)}`:""].join(""):"",d>=6e4?`<br>${r.delay.replace("$1",Math.floor(d/6e4))}</span>`:"",f&&"ja"===n?`<br><span class="desc-caution"><strong>${f}:</strong> ${h.text}</span>`:""].join("")}setFlightStandingStatus(t){const e=this,i=e.dict,{a:n,n:r,ds:s}=t,o=t.sdt||t.sat,a=t.edt||t.eat,l=t.adt||t.aat,c=(a||l)&&o!==(a||l);t.description=['<div class="desc-header">',`<div style="background-color: ${e.operatorLookup[n].tailcolor||"#FFFFFF"};"></div>`,`<div><strong>${e.getLocalizedOperatorTitle(n)}</strong>`,`<br>${r[0]} `,i[s?"to":"from"].replace("$1",e.getLocalizedAirportTitle(s||t.or)),"</div></div>",`<strong>${i.status}:</strong> ${e.getLocalizedFlightStatusTitle(t.s)}`,"<br><strong>",i[s?"scheduled-departure-time":"scheduled-arrival-time"],`:</strong> ${o}`,c?'<span class="desc-caution">':"",a?["<br><strong>",i[s?"estimated-departure-time":"estimated-arrival-time"],`:</strong> ${a}`].join(""):l?["<br><strong>",i[s?"actual-departure-time":"actual-arrival-time"],`:</strong> ${l}`].join(""):"",c?"</span>":"",r.length>1?`<br><strong>${i["code-share"]}:</strong> ${r.slice(1).join(" ")}`:""].join("")}checkActiveTrains(t){const e=this;function i(t,n){const r=e.activeTrainLookup[t.t];if(r&&t.id===r.id)return!0;const s=t[n];if(s)for(let t=0,e=s.length;t<e;t++)if(i(s[t],n))return!0;return!1}return i(t,"previousTrains")||i(t,"nextTrains")}stopTrain(t,e){const i=this,n=t.cars;if(pt.stop(t.animationID),n)for(const t of n)i.trafficLayer.removeObject(t),t!==i.markedObject||e||i.markObject(),t!==i.trackedObject||e||i.trackObject();delete t.cars,delete i.activeTrainLookup[t.t],e||delete t.delay,t.tt||i.timetableData.splice(i.timetableData.indexOf(t),1)}stopFlight(t){const e=this,i=t.aircraft;pt.stop(t.animationID),e.trafficLayer.removeObject(i),i===e.markedObject&&e.markObject(),i===e.trackedObject&&e.trackObject(),delete t.aircraft,delete e.activeFlightLookup[t.id]}stopAll(){const t=this,{activeTrainLookup:e,activeFlightLookup:i}=t;for(const i of Object.keys(e))t.stopTrain(e[i]);for(const e of Object.keys(i))t.stopFlight(i[e]);t.realtimeTrainLookup={},delete t.lastTrainRefresh}resetRailwayStatus(){for(const t of this.railwayData)delete t.status,delete t.text,delete t.suspended}loadTimetableData(){const t=this;(function(t,e){const i=CU(e);return Promise.all([`${t}/${EU(e)}`,...i.map((e=>`${t}/${e}`))].map(B)).then((t=>t[0].concat(...t.slice(1))))})(t.dataUrl,t.clock).then((e=>{t.timetableData=e,t.updateTimetableData(e),t.trainLookup=D(e,"t"),delete t.lastTrainRefresh}))}loadRealtimeTrainData(){const t=this;(function(t){const e=[],i=[],n=[];for(const e of Object.keys(AU)){const i=gt.apiUrl[e],r=t[e];if("odpt"===e){const t=AU[e].map((t=>`odpt.Operator:${t}`)).join(",");n.push(`${i}odpt:Train?odpt:operator=${t}&acl:consumerKey=${r}`)}}n.push(gt.tidUrl);for(const e of Object.keys(TU)){const i=gt.apiUrl[e],r=t[e];if("odpt"===e||"challenge2024"===e){const t=TU[e].map((t=>`odpt.Operator:${t}`)).join(",");n.push(`${i}odpt:TrainInformation?odpt:operator=${t}&acl:consumerKey=${r}`)}}return n.push(gt.trainInfoUrl),Promise.all(n.map(B)).then((t=>{for(const i of t.shift()){const t=U(i["odpt:trainType"]),n=U(i["odpt:destinationStation"]);e.push({id:IU(U(i["owl:sameAs"]),t,n),o:U(i["odpt:operator"]),r:U(i["odpt:railway"]),y:t,n:i["odpt:trainNumber"],os:U(i["odpt:originStation"]),d:U(i["odpt:railDirection"]),ds:n,ts:U(i["odpt:toStation"]),fs:U(i["odpt:fromStation"]),delay:1e3*(i["odpt:delay"]||0),carComposition:i["odpt:carComposition"],date:i["dc:date"].replace(/([\d\-])T([\d:]+).*/,"$1 $2")})}for(const i of t.shift())e.push(i);for(const e of[...t.shift(),...t.shift()])i.push({operator:U(e["odpt:operator"]),railway:U(e["odpt:railway"]),status:e["odpt:trainInformationStatus"],text:e["odpt:trainInformationText"]});for(const e of t.shift())i.push(e);return{trainData:e,trainInfoData:i}}))})(t.secrets).then((({trainData:e,trainInfoData:i})=>{const{trainLookup:n,activeTrainLookup:r,railwayLookup:s}=t,o=t.realtimeTrainLookup={};for(const i of e){const{id:e,r:a,y:l,os:c,d:h,ds:u,ts:d,fs:p,v:f,delay:m,carComposition:g}=i;let _=n[e]||n[e.replace(".Marunouchi.",".MarunouchiBranch.")],y=!1;if(_)o[e]=_,isNaN(m)||_.delay===m||(_.delay=m,y=!0),g&&_.carComposition!==g&&(_.carComposition=g,y=!0),l&&_.y!==l&&(_.y=l,y=!0),QG(_,c,u)&&(y=!0),_.tt||(_.ts=d,_.fs=p),f&&(_.v=f),y&&r[e]&&t.stopTrain(_,!0);else if(a){if("TokyoMetro.Namboku"===a&&(c[0].startsWith(HG)||u[0].startsWith(HG)))continue;if("Toei.Arakawa"===a)continue;const r=s[a];r&&(_={t:e,id:`${e}.Today`,r:a,y:l,n:i.n,os:c,d:h,ds:u,ts:d,fs:p,start:Date.now(),end:Date.now()+864e5,delay:m,direction:h===r.ascending?1:-1,altitude:r.altitude,carComposition:g||r.carComposition},t.timetableData.push(_),o[e]=n[e]=_)}t.lastDynamicUpdate[i.o]=i.date}t.resetRailwayStatus();for(const e of i){const i=s[e.railway],n=e.status;if(i&&n&&n.ja&&(i.status=n.ja,i.text=e.text.ja,i.dynamic))for(const e of Object.keys(r)){const n=r[e];n.r!==i.id||o[n.t]||t.stopTrain(n)}if(e.suspended){i.suspended=!0;for(const e of Object.keys(r)){const n=r[e];n.r===i.id&&t.stopTrain(n)}}}t.refreshTrains(),t.aboutPanel.updateContent()})).catch((e=>{t.refreshTrains()}))}loadRealtimeFlightData(){const t=this;Promise.all([gt.atisUrl,gt.flightUrl].map(B)).then((t=>({atisData:t[0],flightData:t[1]}))).then((({atisData:e,flightData:i})=>{const{flightLookup:n,activeFlightLookup:r}=t,{landing:s,departure:o}=e,a=[s.join("/"),o.join("/")].join(" "),l={},c={};let h={},u={},d=!0;if(t.flightPattern!==a){t.flightPattern=a,t.lastFlightPatternChanged=Date.now();for(const e of Object.keys(r))t.stopFlight(r[e])}F(s,["R16L","R16R"])?(h={S:"R16L",N:"R16R"},u={S:"22",N:"16R"},d=!1):F(s,["L22","L23"])?(h={S:"L23",N:"L22"},u={S:"O16R",N:"16L"},d=!1):F(s,["I16L","I16R"])?(h={S:"I16L",N:"I16R"},u={S:"22",N:"16R"},d=!1):F(s,["I22","I23"])?(h={S:"I23",N:"I22"},u={S:"16R",N:"16L"},d=!1):F(s,["I34L","H34R"])?(h={S:"IX34L",N:"H34R"},u={S:"05",N:"34R"},d=!0):F(s,["I34L","I34R"])?(h={S:"IZ34L",N:"H34R"},u={S:"05",N:"34R"},d=!0):1!==s.length||(F(s,"I23")?(h={S:"IY23",N:"IY23"},d=!1):F(s,"L23")?(h={S:"LY23",N:"LY23"},d=!1):F(s,"I34L")?(h={S:"IX34L",N:"IX34L"},d=!0):F(s,"I34R")?(h={S:"IY34R",N:"IY34R"},d=!0):F(s,"L22")&&(h={S:"L22",N:"L22"},d=!1),F(o,"16L")?u={S:"N16L",N:"N16L"}:F(o,"05")?u={S:"N05",N:"N05"}:F(o,"16R")&&(u={S:"16R",N:"16R"}));for(const t of i)if(F(WG,t.a)){const{dp:e,ds:i,sdt:n,or:r,ar:s,sat:o}=t;l[`${e||r}.${i||s}.${n||o}`]=t}for(const e of i){const{id:i,n:r,dp:s,ds:o,sdt:a,or:p,ar:f,sat:m}=e;let g=n[i],_=e.s,{maxFlightSpeed:y,flightAcceleration:v}=gt;if(i.match(/NH\d{4}$/)){const t=l[`${s||p}.${o||f}.${a||m}`];if(t){t.n.push(...r);continue}}if(!g){if(F(["Cancelled","PostponedTomorrow"],_))continue;const a=t.airportLookup[o||p],l=a?a.direction:"S",c="NRT"===s?`NRT.${d?"34L":"16R"}.Dep`:"NRT"===f?`NRT.${d?"34R":"16L"}.Arr`:"HND"===s?`HND.${u[l]}.Dep`:"HND"===f?`HND.${h[l]}.Arr`:void 0,m=t.featureLookup[c];if(!m)continue;g=n[i]={id:i,n:r,a:e.a,dp:s,ar:f,ds:o,or:p,runway:c.replace(/^([^.]+\.)[A-Z]*([^.]+).+/,"$1$2"),feature:m}}Object.assign(g,{edt:e.edt,adt:e.adt,sdt:a,eat:e.eat,aat:e.aat,sat:m});const x=g.edt||g.adt||g.sdt,b=g.eat||g.aat||g.sat;b&&!_?b<g.sat?_="NewTime":b>g.sat?_="Delayed":b===g.sat&&(_="OnTime"):!x||_&&"CheckIn"!==_&&"NowBoarding"!==_&&"FinalCall"!==_&&"BoardingComplete"!==_&&"Departed"!==_||(x<g.sdt?_="NewTime":x>g.sdt?_="Delayed":x===g.sdt&&(_="OnTime")),g.s=_,b&&(y/=2,v/=-2);const w=y/Math.abs(v)/2+g.feature.properties.length/y,A=gt.standingDuration;x?(g.start=g.base=t.clock.getTime(x),g.standing=g.start-A,g.end=g.start+w):(g.start=g.standing=t.clock.getTime(b)-w,g.base=g.start+w-A,g.end=g.start+w+A),g.maxSpeed=y,g.acceleration=v;(c[g.runway]=c[g.runway]||[]).push(g),t.lastDynamicUpdate[e.o]=e.date}for(const t of Object.keys(c)){const e=c[t];let i=0;e.sort(((t,e)=>t.base-e.base));for(const t of e){const e=t.base,n=Math.max(e,i+gt.minFlightInterval)-e;n&&(t.start+=n,t.base+=n,t.standing+=n,t.end+=n),i=t.base}}t.refreshFlights(),t.aboutPanel.updateContent()})).catch((e=>{t.refreshFlights()}))}updateSearchButton(t){const{container:e,dict:i}=this,n=e.querySelector(".mapboxgl-ctrl-search");if(n){const e=n.classList;"edit"===t||"route"===t||"playback"===t?(n.title=i["exit-search"],e.add("mapboxgl-ctrl-search-active")):(n.title=i["enter-search"],e.remove("mapboxgl-ctrl-search-active"))}}updateUndergroundButton(t){const{container:e,dict:i}=this,n=e.querySelector(".mapboxgl-ctrl-underground");if(n){const e=n.classList;"underground"===t?(n.title=i["exit-underground"],e.add("mapboxgl-ctrl-underground-visible")):(n.title=i["enter-underground"],e.remove("mapboxgl-ctrl-underground-visible"))}}updatePlaybackButton(t){const{container:e,dict:i}=this,n=e.querySelector(".mapboxgl-ctrl-playback");if(n){const e=n.classList;"playback"===t?(n.title=i["exit-playback"],e.add("mapboxgl-ctrl-playback-active")):(n.title=i["enter-playback"],e.remove("mapboxgl-ctrl-playback-active"))}}updateEcoButton(t){const{container:e,dict:i}=this,n=e.querySelector(".mapboxgl-ctrl-eco");if(n){const e=n.classList;"eco"===t?(n.title=i["exit-eco"],e.add("mapboxgl-ctrl-eco-active")):(n.title=i["enter-eco"],e.remove("mapboxgl-ctrl-eco-active"))}}refreshMap(){const t=this,{viewMode:e,searchMode:i}=t,n="mt3d:opacity"+("underground"===e?"-underground":"");!function(t,e,i){let n,r;for(const{id:s,key:o,opacity:a,metadata:l}of e)if(n=Array.isArray(i)?i.reduce(((t,e)=>N(t,l[e])),void 0):l[i],o){if(Array.isArray(a)){r=t.getPaintProperty(s,o);for(const{index:t,value:e}of a){const i=e*n;r.stops?r.stops[t][1]=i:r[t]=i}}else r=a*n;t.setPaintProperty(s,o,r)}else Ie(t,s,{opacity:n})}(t.map,t.styleOpacities,"none"===i||"edit"===i?n:[`${n}-route`,n]),t.trafficLayer.setMode(e,i)}_setSearchMode(t){const e=this;let i=e.searchPanel;e.updateSearchButton(t),"none"===t?i&&(i.remove(),delete e.searchPanel):i||(i=e.searchPanel=new FG,i.addTo(e)),e.searchMode=t,e.stopAll();for(const i of e.plugins)i.setVisibility("none"===t);e.refreshMap()}_setViewMode(t){const e=this;e.viewMode!==t&&(e.updateUndergroundButton(t),e.viewMode=t,e.refreshMap(),e.fire({type:"viewmode",mode:t}))}_setTrackingMode(t){const e=this;e.trackingMode!==t&&(e.trackingMode=t,eV(e.trackedObject)&&(e.updateBaseZoom(),e.updateTrackingParams(!0),e.updateHandlersAndControls(),e.startViewAnimation()),e.fire({type:"trackingmode",mode:t}))}_setClockMode(t){const e=this;e.clockMode!==t&&(e.updatePlaybackButton(t),e.clockMode=t,e.clock.reset(),e.onClockChange(),e.clockControl&&e.clockCtrl.setMode(t),"playback"===t&&e.resetRailwayStatus(),e.fire({type:"clockmode",mode:t}))}_setEcoMode(t){const e=this;e.ecoMode!==t&&(e.updateEcoButton(t),e.ecoMode=t,e.fire({type:"ecomode",mode:t}))}onClockChange(){const t=this,e=t.clock.getTime("03:00");t.stopAll(),t.markObject(),t.trackObject(),t.lastTimetableRefresh!==e&&(t.loadTimetableData(),t.lastTimetableRefresh=e)}getLightColor(){return Pe(this.map,this.clock.getTime())}pickObject(t){const e=this,i=["ground","underground"];let n;"underground"===e.viewMode&&i.reverse();for(const r of i){if(n=e.trafficLayer.pickObject(r,t),n)return n;if(n="ground"===r?e.pickedFeature:Tt(e.map,`stations-ug-${e.layerZoom}`,t),n)return n}}markObject(t){const e=this,{markedObject:i,trafficLayer:n,map:r,popup:s}=e;i&&!nV(i,t)&&(eV(i)?(i.outline=0,n.updateObject(i)):e.removeStationOutline("stations-marked"),delete e.markedObject,s&&s.isOpen()&&(r.getCanvas().style.cursor="",s.remove())),t&&!nV(t,e.markedObject)&&(e.markedObject=t,r.getCanvas().style.cursor="pointer",e.popup=new dt({className:"popup-object",closeButton:!1,closeOnClick:!1,maxWidth:"300px",offset:{top:[0,10],bottom:[0,-30]},openingAnimation:{duration:300,easing:"easeOutBack"}}),e.updatePopup({setHTML:!0,addToMap:!0}),eV(t)?(t.outline=1,n.updateObject(t)):e.addStationOutline(t,"stations-marked"))}trackObject(t){const e=this,{searchMode:i,searchPanel:n,lang:r,map:s,trackedObject:o,lastCameraParams:a,sharePanel:l,detailPanel:c}=e;if("none"===i){if(!o&&t?(a.viewMode=e.getViewMode(),a.zoom=s.getZoom(),a.bearing=s.getBearing(),a.pitch=s.getPitch()):o&&!t&&(e._setViewMode(a.viewMode),s.flyTo({zoom:a.zoom,bearing:a.bearing,pitch:a.pitch})),eV(o)||iV(o)||o&&!nV(o,t)){if(eV(o)){const t=o.object;o.outline=0,e.trafficLayer.updateObject(o),e.fire({type:"deselection",deselection:t.t||t.id})}else iV(o)?(e.removeStationOutline("stations-selected"),e.fire({type:"deselection"})):e.fire(Object.assign({type:"deselection"},o));delete e.trackedObject,e.updateHandlersAndControls(),e.stopViewAnimation(),l&&(l.remove(),delete e.sharePanel),c&&(c.remove(),delete e.detailPanel);for(const t of e.exitPopups)t instanceof dt?t.remove():"function"==typeof t?s.off("moveend",t):clearTimeout(t)}if(eV(t)||iV(t)||t&&!nV(t,e.trackedObject))if(e.trackedObject=t,eV(t)){const i=t.object;e.updateBaseZoom(),e.updateTrackingParams(!0),e.updateHandlersAndControls(),e.startViewAnimation(),e._setViewMode(t.altitude<0?"underground":"ground"),"realtime"===e.clockMode&&navigator.share&&(e.sharePanel=new zG({object:i}),e.sharePanel.addTo(e)),i.tt&&(e.detailPanel=new VG({object:i}),e.detailPanel.addTo(e)),t.outline=1,e.trafficLayer.updateObject(t),e.fire({type:"selection",selection:i.t||i.id})}else if(iV(t)){const i=fe(t),n=pe(t).map((t=>e.stationLookup[t])),r=[].concat(...n.map((t=>t.exit||[])));if(r.length>0){const o=[];e.exitPopups=r.map(((t,i)=>{const{coord:n,facilities:a}=e.poiLookup[t],l=(a||[]).map((t=>`<span class="exit-${t}-small-icon"></span>`)).join(""),c=()=>{e.exitPopups[i]=setTimeout((()=>{const r=new dt({className:"popup-station",closeButton:!1,closeOnClick:!1});r.setLngLat(n).setHTML(l+e.getLocalizedPOITitle(t)).addTo(s).getElement().id=`exit-${i}`,e.exitPopups[i]=r}),i/r.length*1e3)};return s.once("moveend",c),o.push(n),c})),e._setViewMode(i<0?"underground":"ground"),s.fitBounds(Ce(o),{bearing:s.getBearing(),pitch:s.getPitch(),offset:[0,-s.transform.height/12],padding:{top:20,bottom:20,left:10,right:50},maxZoom:18}),e.detailPanel=new NG({object:n}),e.detailPanel.addTo(e),e.addStationOutline(t,"stations-selected"),e.fire({type:"selection"})}else delete e.trackedObject}else e.fire(Object.assign({type:"selection"},t))}else if("edit"===i&&n&&iV(t)){const i=pe(t),s=e.stationLookup[i[0]],o=s.utitle&&s.utitle[r]||z(s.title[r]||s.title.en);n.fillStationName(o)}}updateBaseZoom(){const t=this,{map:e,trackedObject:i}=t;if(eV(i)){const n=t.getModelPosition(i.coord,i.altitude).z,r=e.getFreeCameraOptions().position.z;t.baseZoom=e.getZoom()+Math.log2(r/Math.abs(r-n))}}updatePopup(t){const e=this,{markedObject:i,map:n,stationLookup:r,popup:s}=e,{setHTML:o,addToMap:a}=t||{};if(eV(i)){const t=i===e.trackedObject?n.getBearing():void 0;s.setLngLat(e.adjustCoord(i.coord,i.altitude,t)),o&&s.setHTML(i.object.description)}else{const t=e.featureLookup[i.properties.id.replace(/\d+$/,e.layerZoom)],n=Mt(se(t)),a=fe(t);if(s.setLngLat(e.adjustCoord(n,a)),o){const t=pe(i),n={};for(const i of t){const t=e.getLocalizedStationTitle(i),s=r[i].railway;(n[t]=n[t]||{})[e.getLocalizedRailwayTitle(s)]=e.railwayLookup[s].color}s.setHTML(['<div class="thumbnail-image-container">','<div class="ball-pulse"><div></div><div></div><div></div></div>',`<div class="thumbnail-image" style="background-image: url('${r[t[0]].thumbnail}');"></div>`,"</div>",'<div class="railway-list">',Object.keys(n).map((t=>{const e=Object.keys(n[t]).map((e=>`<div class="line-strip" style="background-color: ${n[t][e]};"></div><span>${e}</span>`)).join("<br>");return`<strong>${t}</strong><br>${e}`})).join("<br>"),"</div>"].join(""))}}a&&s.addTo(n)}updateTimetableData(t){const e=this,i=e.clock,n=D(t);for(const r of t){const t=e.railwayLookup[r.r],s=r.d===t.ascending?1:-1,{tt:o,pt:a,nt:l}=r,c=o.length;let h,u,d=1/0;if(a)for(const t of a){const e=n[t];if(e){const t=e.tt;d=Math.min(d,i.getTime(t[t.length-1].a||t[t.length-1].d||o[0].d)-gt.standingDuration),h=h||[],h.push(e)}}if(l){for(const t of l){const e=n[t];e&&(u=u||[],u.push(e))}u&&(o[c-1].d=u[0].tt[0].d)}r.start=Math.min(d,i.getTime(o[0].d)-gt.standingDuration),r.end=i.getTime(o[c-1].a||o[c-1].d||o[Math.max(c-2,0)].d),r.direction=s,r.altitude=t.altitude,r.carComposition=t.carComposition,r.previousTrains=h,r.nextTrains=u}}addStationOutline(t,e){const i=this,n=pe(t);for(const t of[13,14,15,16,17,18])Ie(i.map,`${e}-${t}`,{data:ue(i.featureCollection,(e=>e.zoom===t&&e.ids&&e.ids[0]===n[0])),opacity:1,visible:!0})}removeStationOutline(t){for(const e of[13,14,15,16,17,18])Ie(this.map,`${t}-${e}`,{visible:!1})}refreshStationOutline(){const t=performance.now()%1500/1500*2;for(const e of[13,14,15,16,17,18])Ie(this.map,`stations-selected-${e}`,{opacity:t<1?t:2-t,visible:!0})}setSectionData(t,e,i){const n=this.clock,r=this.railwayLookup[t.r].stations,{direction:s,tt:o}=t,a=(t.ds||[])[0],l=t.delay||0,c=n.getTime();let h,u,d,p,f,m,g,_;if(o?(h=N(e,o.reduce(((t,e,i)=>e.d&&n.getTime(e.d)+l<=c?i:t),0)),u=o[h],d=o[h+1],p=u.s,f=d&&d.s):(p=t.fs||t.ts,f=t.ts||t.fs),s>0?(m=r.indexOf(p),g=r.indexOf(f,m),_=r.indexOf(a,m),-1===_&&(_=r.length-1)):(m=r.lastIndexOf(p),g=r.lastIndexOf(f,m),_=r.lastIndexOf(a,m),-1===_&&(_=0)),o){if(t.timetableIndex=h,t.departureStation=p,t.departureTime=u.d||u.a,m>=0&&g>=0)return t.sectionIndex=m,t.sectionLength=g-m,t.arrivalStation=f,t.arrivalTime=d.a,t.nextDepartureTime=d.d,!0}else{const e=function(t,e){return isNaN(t)?e:t}(t.sectionIndex+t.sectionLength,m);if(t.departureStation=p,e>=0&&e!==_&&(!i&&g>=0||i&&_>=0))return t.sectionIndex=e,t.sectionLength=(i?_:g)-e,t.arrivalStation=f===p?r[e+s]:f,!0}t.arrivalStation=t.arrivalTime=t.nextDepartureTime=void 0}},Panel:RU,Popup:class{constructor(){this._popup=new dt({className:"popup-object",closeButton:!1,closeOnClick:!1,maxWidth:"300px",offset:{top:[0,10],bottom:[0,-30]},openingAnimation:{duration:300,easing:"easeOutBack"}})}addTo(t){return this._popup.addTo(t.map),this}remove(){return this._popup.remove(),this}setLngLat(t){return this._popup.setLngLat(t),this}setHTML(t){return this._popup.setHTML(t),this}},THREE:tj};return ej}));
//# sourceMappingURL=mini-tokyo-3d.min.js.map
