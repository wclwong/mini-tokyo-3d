{"version":3,"file":"mt3d-plugin-plateau.min.js","sources":["../src/index.js"],"sourcesContent":["import plateauSVG from './plateau.svg';\n\nconst models = [\n    '13101_chiyoda-ku/low_resolution',\n    '13102_chuo-ku/low_resolution',\n    '13103_minato-ku/low_resolution',\n    '13104_shinjuku-ku/low_resolution',\n    '13109_shinagawa-ku/low_resolution',\n    '13113_shibuya-ku/low_resolution',\n    '13116_toshima-ku/low_resolution'\n];\n\nclass PlateauPlugin {\n\n    constructor(options) {\n        const me = this;\n\n        me.id = 'plateau';\n        me.name = {\n            en: 'PLATEAU',\n            fr: 'PLATEAU',\n            ja: 'PLATEAU',\n            ko: 'PLATEAU',\n            ne: 'PLATEAU',\n            pt: 'PLATEAU',\n            th: 'PLATEAU',\n            'zh-Hans': 'PLATEAU',\n            'zh-Hant': 'PLATEAU'\n        };\n        me.iconStyle = {\n            backgroundSize: '32px',\n            backgroundImage: `url(\"${plateauSVG}\")`\n        };\n        me.viewModes = ['ground'];\n        me.enabled = options && options.enabled;\n        me._tick = me._tick.bind(me);\n    }\n\n    onAdd(map) {\n        const me = this;\n\n        me.map = map;\n    }\n\n    onRemove(map) {\n        map.removeLayer('plateau-ortho');\n        for (const model of models) {\n            map.removeLayer(`tile-3d-${model}`);\n        }\n        map.map.removeSource('plateau-ortho');\n    }\n\n    onEnabled() {\n        const me = this,\n            {map} = me;\n\n        map.setLayerVisibility('building-3d', 'none');\n\n        if (map.map.getLayer('plateau-ortho')) {\n            return;\n        }\n\n        map.map.addSource('plateau-ortho', {\n            type: 'raster',\n            tiles: [\n                'https://gic-plateau.s3.ap-northeast-1.amazonaws.com/2020/ortho/tiles/{z}/{x}/{y}.png'\n            ],\n            maxzoom: 19,\n            minzoom: 10,\n            attribution: '<a href=\"https://www.mlit.go.jp/plateau/\">国土交通省Project PLATEAU</a>'\n        });\n        map.addLayer({\n            id: 'plateau-ortho',\n            type: 'raster',\n            source: 'plateau-ortho'\n        }, 'stations-marked-13');\n\n        for (const model of models) {\n            map.addLayer({\n                id: `tile-3d-${model}`,\n                type: 'tile-3d',\n                data: `https://plateau.geospatial.jp/main/data/3d-tiles/bldg/13100_tokyo/${model}/tileset.json`,\n                opacity: 0.8,\n                onTileLoad: d => {\n                    const {content} = d,\n                        buffer = content.batchTableBinary.buffer,\n                        key = content.batchTableJson,\n                        len = key._gml_id.length,\n                        zMinView = new DataView(buffer, key._zmin.byteOffset, len * 8),\n                        zMins = [];\n\n                    for (let i = 0; i < len; i++) {\n                        zMins.push(zMinView.getFloat64(i * 8, true));\n                    }\n                    zMins.sort((a, b) => a - b);\n                    content.cartographicOrigin.z -= 36.6641 + zMins[Math.floor(len / 2)];\n                }\n            });\n        }\n\n        me._tick();\n    }\n\n    _tick() {\n        const me = this,\n            {map, lastRefresh, _tick} = me,\n            now = map.clock.getTime();\n\n        if (map.map.getLayer('plateau-ortho')) {\n            if (Math.floor(now / 60000) !== Math.floor(lastRefresh / 60000)) {\n                const {r, g, b} = map.getLightColor(),\n                    luminance = .2126 * r + .7152 * g + .0722 * b;\n\n                map.map.setPaintProperty('plateau-ortho', 'raster-brightness-max', luminance);\n                me.lastRefresh = now;\n            }\n            requestAnimationFrame(_tick);\n        }\n    }\n\n    onDisabled() {\n        this.map.setLayerVisibility('building-3d', 'visible');\n    }\n\n    onVisibilityChanged(visible) {\n        const me = this,\n            {map} = me;\n\n        if (map.map.getLayer('plateau-ortho')) {\n            map.setLayerVisibility('plateau-ortho', visible ? 'visible' : 'none');\n            for (const model of models) {\n                map.setLayerVisibility(`tile-3d-${model}`, visible ? 'visible' : 'none');\n            }\n        }\n    }\n\n}\n\nexport default function(options) {\n    return new PlateauPlugin(options);\n}\n"],"names":["models","PlateauPlugin","constructor","options","me","this","id","name","en","fr","ja","ko","ne","pt","th","iconStyle","backgroundSize","backgroundImage","viewModes","enabled","_tick","bind","onAdd","map","onRemove","removeLayer","model","removeSource","onEnabled","setLayerVisibility","getLayer","addSource","type","tiles","maxzoom","minzoom","attribution","addLayer","source","data","opacity","onTileLoad","d","content","key","batchTableJson","len","_gml_id","length","zMinView","DataView","batchTableBinary","buffer","_zmin","byteOffset","zMins","i","push","getFloat64","sort","a","b","cartographicOrigin","z","Math","floor","lastRefresh","now","clock","getTime","r","g","getLightColor","setPaintProperty","requestAnimationFrame","onDisabled","onVisibilityChanged","visible"],"mappings":";;;;;;4OAEA,MAAMA,EAAS,CACX,kCACA,+BACA,iCACA,mCACA,oCACA,kCACA,mCAGJ,MAAMC,EAEFC,YAAYC,GACR,MAAMC,EAAKC,KAEXD,EAAGE,GAAK,UACRF,EAAGG,KAAO,CACNC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJC,GAAI,UACJ,UAAW,UACX,UAAW,WAEfV,EAAGW,UAAY,CACXC,eAAgB,OAChBC,gBAAiB,ybAErBb,EAAGc,UAAY,CAAC,UAChBd,EAAGe,QAAUhB,GAAWA,EAAQgB,QAChCf,EAAGgB,MAAQhB,EAAGgB,MAAMC,KAAKjB,EAC5B,CAEDkB,MAAMC,GACSlB,KAERkB,IAAMA,CACZ,CAEDC,SAASD,GACLA,EAAIE,YAAY,iBAChB,IAAK,MAAMC,KAAS1B,EAChBuB,EAAIE,YAAY,WAAWC,KAE/BH,EAAIA,IAAII,aAAa,gBACxB,CAEDC,YACI,MACIL,IAACA,GADMlB,KAKX,GAFAkB,EAAIM,mBAAmB,cAAe,SAElCN,EAAIA,IAAIO,SAAS,iBAArB,CAIAP,EAAIA,IAAIQ,UAAU,gBAAiB,CAC/BC,KAAM,SACNC,MAAO,CACH,wFAEJC,QAAS,GACTC,QAAS,GACTC,YAAa,uEAEjBb,EAAIc,SAAS,CACT/B,GAAI,gBACJ0B,KAAM,SACNM,OAAQ,iBACT,sBAEH,IAAK,MAAMZ,KAAS1B,EAChBuB,EAAIc,SAAS,CACT/B,GAAI,WAAWoB,IACfM,KAAM,UACNO,KAAM,qEAAqEb,iBAC3Ec,QAAS,GACTC,WAAYC,IACR,MAAMC,QAACA,GAAWD,EAEdE,EAAMD,EAAQE,eACdC,EAAMF,EAAIG,QAAQC,OAClBC,EAAW,IAAIC,SAHNP,EAAQQ,iBAAiBC,OAGFR,EAAIS,MAAMC,WAAkB,EAANR,GACtDS,EAAQ,GAEZ,IAAK,IAAIC,EAAI,EAAGA,EAAIV,EAAKU,IACrBD,EAAME,KAAKR,EAASS,WAAe,EAAJF,GAAO,IAE1CD,EAAMI,MAAK,CAACC,EAAGC,IAAMD,EAAIC,IACzBlB,EAAQmB,mBAAmBC,GAAK,QAAUR,EAAMS,KAAKC,MAAMnB,EAAM,GAAG,IA1CrEzC,KA+CRe,OAxCF,CAyCJ,CAEDA,QACI,MAAMhB,EAAKC,MACPkB,IAACA,EAAG2C,YAAEA,EAAW9C,MAAEA,GAAShB,EAC5B+D,EAAM5C,EAAI6C,MAAMC,UAEpB,GAAI9C,EAAIA,IAAIO,SAAS,iBAAkB,CACnC,GAAIkC,KAAKC,MAAME,EAAM,OAAWH,KAAKC,MAAMC,EAAc,KAAQ,CAC7D,MAAMI,EAACA,EAACC,EAAEA,EAACV,EAAEA,GAAKtC,EAAIiD,gBAGtBjD,EAAIA,IAAIkD,iBAAiB,gBAAiB,wBAF1B,MAAQH,EAAI,MAAQC,EAAI,MAAQV,GAGhDzD,EAAG8D,YAAcC,CACpB,CACDO,sBAAsBtD,EACzB,CACJ,CAEDuD,aACItE,KAAKkB,IAAIM,mBAAmB,cAAe,UAC9C,CAED+C,oBAAoBC,GAChB,MACItD,IAACA,GADMlB,KAGX,GAAIkB,EAAIA,IAAIO,SAAS,iBAAkB,CACnCP,EAAIM,mBAAmB,gBAAiBgD,EAAU,UAAY,QAC9D,IAAK,MAAMnD,KAAS1B,EAChBuB,EAAIM,mBAAmB,WAAWH,IAASmD,EAAU,UAAY,OAExE,CACJ,SAIU,SAAS1E,GACpB,OAAO,IAAIF,EAAcE,EAC7B"}